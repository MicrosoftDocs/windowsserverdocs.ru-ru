---
ms.assetid: 61ed00fd-51c7-4728-91fa-8501de9d8f28
title: Публикация приложений с помощью SharePoint, Exchange и RDG
description: ''
author: billmath
manager: mtillman
ms.author: billmath
ms.date: 04/30/2018
ms.topic: article
ms.prod: windows-server
ms.technology: web-app-proxy
ms.openlocfilehash: 3852baf866dae20d1d1d08219841295aa976c626
ms.sourcegitcommit: 0a0a45bec6583162ba5e4b17979f0b5a0c179ab2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/13/2020
ms.locfileid: "79319938"
---
# <a name="publishing-applications-with-sharepoint-exchange-and-rdg"></a>Публикация приложений с помощью SharePoint, Exchange и RDG

> Область применения: Windows Server 2016

**Это содержимое относится к локальной версии прокси веб-приложения. Чтобы обеспечить безопасный доступ к локальным приложениям в облаке, ознакомьтесь с [содержимым AD application proxy Azure](https://azure.microsoft.com/documentation/articles/active-directory-application-proxy-get-started/).**

В этом разделе описываются задачи, необходимые для публикации SharePoint Server, Exchange Server или шлюза удаленный рабочий стол (RDP) с помощью прокси-службы приложения.

> [!NOTE]
> Эта информация предоставляется "как есть".  Службы удаленных рабочих столов поддерживает и рекомендует использовать [прокси приложения Azure для обеспечения безопасного удаленного доступа к локальным приложениям](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-get-started).

## <a name="BKMK_6.1"></a>Публикация SharePoint Server
Сайт SharePoint можно опубликовать с помощью прокси веб-приложения, если на сайте SharePoint настроена проверка подлинности на основе утверждений или встроенная проверка подлинности Windows. Если вы хотите использовать службы федерации Active Directory (AD FS) (AD FS) для предварительной проверки подлинности, необходимо настроить проверяющую сторону с помощью одного из мастеров.

-   Если на сайте SharePoint используется аутентификация на основе утверждений, воспользуйтесь мастером добавления отношения доверия с проверяющей стороной, чтобы настроить для приложения отношения доверия с проверяющей стороной.

-   Если на сайте SharePoint используется встроенная аутентификация Windows, воспользуйтесь мастером добавления отношений доверия с проверяющей стороной, не поддерживающей утверждения, чтобы настроить для приложения отношения доверия с проверяющей стороной. Если настроен центр KDC, с веб-приложением, поддерживающим утверждения, можно использовать аутентификацию IWA.

    Чтобы разрешить пользователям проходить аутентификацию с помощью встроенной проверки подлинности Windows, прокси-сервер веб приложения должен быть присоединен к домену.

    Необходимо настроить приложение для поддержки ограниченного делегирования Kerberos. Эту настройку можно выполнить на контроллере домена для любого приложения. Кроме того, можно настроить приложение непосредственно на внутреннем сервере, если он работает под Windows Server 2012 R2 или Windows Server 2012. Дополнительные сведения см. в разделе [Новые возможности аутентификации Kerberos](https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/hh831747(v=ws.11)). Кроме того, необходимо убедиться, что прокси-серверы веб приложения настроены для делегирования именам участников службы внутренних серверов. Пошаговое руководство по настройке прокси веб-приложения для публикации приложения с использованием встроенной проверки подлинности Windows см. в разделе [Настройка сайта для использования встроенной проверки подлинности Windows](https://docs.microsoft.com/previous-versions/orphan-topics/ws.11/dn308246(v=ws.11)).

Если сайт SharePoint настроен с помощью альтернативных сопоставлений доступа (AAM) или коллекций сайтов с именем узла, для публикации приложения можно использовать различные URL-адреса внешних и внутренних серверов. Однако если настройка сайта SharePoint с использованием альтернативных сопоставлений доступа или коллекций сайтов с именем узла не выполнена, необходимо использовать те же URL-адреса внешних и внутренних серверов.

## <a name="BKMK_6.2"></a>Публикация сервера Exchange Server
В следующей таблице описаны службы Exchange, которые можно опубликовать с помощью прокси веб-приложения, а также поддерживаемые предварительные проверки подлинности для этих служб.


|    Служба Exchange    |                                                                            Предварительная проверка подлинности                                                                            |                                                                                                                                       Примечания                                                                                                                                        |
|------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
|    Outlook Web App     | -AD FS с использованием проверки подлинности, отличной от утверждений<br />-Сквозная передача<br />-AD FS использование проверки подлинности на основе утверждений для локальной службы Exchange 2013 Service PAK 1 (SP1) |                                                                  Дополнительные сведения см. в статье [Использование проверки подлинности, основанной на утверждениях AD FS с Outlook Web App и EAC](https://go.microsoft.com/fwlink/?LinkId=393723)                                                                  |
| управления Exchange |                                                                               Пропускная аутентификация                                                                               |                                                                                                                                                                                                                                                                                    |
|    Мобильный Outlook    |                                                                               Пропускная аутентификация                                                                               | Для того чтобы мобильный Outlook работал корректно, необходимо опубликовать три URL-адреса.<br /><br />— URL-адрес автообнаружения.<br />— Имя внешнего узла сервера Exchange; Это значит, что URL-адрес, который настроен для подключения клиентов к.<br />— Внутреннее полное доменное имя сервера Exchange. |
|  Exchange ActiveSync   |                                                     Пропускная аутентификация<br/> AD FS по протоколу HTTP Basic Authorization                                                      |                                                                                                                                                                                                                                                                                    |

Чтобы опубликовать приложение Outlook Web App, используя интегрированную аутентификацию Windows, воспользуйтесь мастером добавления отношений доверия с проверяющей стороной, не поддерживающей утверждения, и настройте для приложения отношения доверия с проверяющей стороной.

Чтобы разрешить пользователям проходить проверку подлинности с помощью ограниченного делегирования Kerberos, необходимо присоединить сервер прокси веб-приложения к домену.

Необходимо настроить приложение для поддержки проверки подлинности Kerberos. Кроме того, необходимо зарегистрировать имя субъекта-службы (SPN) для учетной записи, от имени которой запущена эта служба. Это можно сделать на контроллере домена или на внутренних серверах. В среде с балансировкой нагрузки Exchange это потребует использования альтернативной учетной записи службы. см. раздел [Настройка проверки подлинности Kerberos для серверов клиентского доступа с балансировкой нагрузки](https://docs.microsoft.com/exchange/configuring-kerberos-authentication-for-load-balanced-client-access-servers-exchange-2013-help) .

Кроме того, можно настроить приложение непосредственно на внутреннем сервере, если он работает под Windows Server 2012 R2 или Windows Server 2012. Дополнительные сведения см. в разделе [Новые возможности аутентификации Kerberos](https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/hh831747(v=ws.11)). Кроме того, необходимо убедиться, что прокси-серверы веб приложения настроены для делегирования именам участников службы внутренних серверов.

## <a name="publishing-remote-desktop-gateway-through-web-application-proxy"></a>Публикация удаленный рабочий стол шлюза с помощью прокси веб-приложения
Если вы хотите ограничить доступ к шлюзу удаленного доступа и добавить предварительную проверку подлинности для удаленного доступа, можно сделать это с помощью прокси веб-приложения. Это действительно хороший способ обеспечить расширенную предварительную проверку подлинности для RDG, включая MFA. Публикация без предварительной проверки подлинности также является вариантом и обеспечивает единую точку входа в системы.

#### <a name="how-to-publish-an-application-in-rdg-using-web-application-proxy-pass-through-authentication"></a>Как опубликовать приложение в RDG с помощью сквозной проверки подлинности прокси веб-приложения

1. Установка будет отличаться в зависимости от того, находятся ли роли Веб-доступ удаленных рабочих столов (/рдвеб) и шлюз удаленных рабочих столов (RPC) на одном сервере или на разных серверах.

2. Если роли Веб-доступ удаленных рабочих столов и шлюза удаленных рабочих столов размещаются на одном сервере RDG, можно просто опубликовать корневое ДОМЕНное имя в прокси веб-приложения, например, https://rdg.contoso.com/.

   Можно также опубликовать два виртуальных каталога по отдельности, например<https://rdg.contoso.com/rdweb/> и https://rdg.contoso.com/rpc/.

3. Если Веб-доступ удаленных рабочих столов и шлюз удаленных рабочих столов размещаются на разных серверах RDG, необходимо опубликовать два виртуальных каталога по отдельности. Можно использовать то же или другое внешнее полное доменное имя, например https://rdweb.contoso.com/rdweb/ и https://gateway.contoso.com/rpc/.

4. Если внешнее и внутреннее полное доменное имя различаются, не следует отключать преобразование заголовка запроса в правиле публикации RDWeb. Это можно сделать, выполнив следующий сценарий PowerShell на сервере прокси веб-приложения, но он должен быть включен по умолчанию.

   ```PowerShell
   Get-WebApplicationProxyApplication applicationname | Set-WebApplicationProxyApplication -DisableTranslateUrlInRequestHeaders:$false
   ```

   > [!NOTE]
   > Если вам требуется поддержка многофункциональных клиентов, таких как подключения к удаленным рабочим столам и приложениям RemoteApp, или iOS удаленный рабочий стол, они не поддерживают предварительную проверку подлинности, поэтому необходимо опубликовать RDG с использованием сквозной проверки подлинности.

#### <a name="how-to-publish-an-application-in-rdg-using-web-application-proxy-with-pre-authentication"></a>Как опубликовать приложение в RDG с помощью прокси веб-приложения с предварительной проверкой подлинности

1.  Предварительная проверка подлинности прокси веб-приложения с помощью RDG выполняется путем передачи файла cookie предварительной проверки подлинности, полученного Internet Explorer, передаваемого в клиент подключение к удаленному рабочему столу (mstsc. exe). Затем он используется клиентом подключение к удаленному рабочему столу (mstsc. exe). Затем он используется клиентом подключение к удаленному рабочему столу в качестве подтверждения проверки подлинности.

    Следующая процедура сообщает серверу сбора о необходимости включить необходимые настраиваемые свойства RDP в удаленные RDP-файлы удаленного приложения, отправляемые клиентам. Они указывают клиенту, что требуется предварительная проверка подлинности, и передачи файлов cookie для адреса сервера предварительной проверки подлинности в подключение к удаленному рабочему столу клиент (mstsc. exe). В сочетании с отключением функции HttpOnly в приложении прокси веб-приложения это позволяет клиенту подключение к удаленному рабочему столу (mstsc. exe) использовать файл cookie прокси-службы веб приложения, полученный через браузер.

    Проверка подлинности на сервере Веб-доступ удаленных рабочих столов будет по-прежнему использовать для входа в форму Веб-доступ удаленных рабочих столов. Это минимальное количество запросов проверки подлинности пользователя, так как форма входа Веб-доступ удаленных рабочих столов создает хранилище учетных данных на стороне клиента, которое затем может использоваться клиентом подключение к удаленному рабочему столу (mstsc. exe) для любого последующего запуска удаленного приложения.

2.  Сначала создайте отношение доверия с проверяющей стороной вручную в AD FS, как при публикации приложения с поддержкой утверждений. Это означает, что необходимо создать фиктивное отношение доверия с проверяющей стороной, которое обеспечивает предварительную проверку подлинности, чтобы вы могли выполнить предварительную проверку подлинности без ограниченного делегирования Kerberos на опубликованный сервер. После проверки подлинности пользователя все остальное передается через.

    > [!WARNING]
    > Может показаться, что использование делегирования предпочтительнее, но оно не полностью решает требования к SSO, и при делегировании в каталог/РПК возникают проблемы, так как клиент предполагает обработку проверки подлинности шлюза удаленных рабочих столов.

3.  Чтобы создать отношение доверия с проверяющей стороной вручную, выполните действия, описанные в консоли управления AD FS.

    1.  Использование мастера **добавления отношений доверия с проверяющей стороной**

    2.  Выберите **ввести данные о проверяющей стороне вручную**.

    3.  Примите все параметры по умолчанию.

    4.  Для идентификатора отношения доверия с проверяющей стороной введите внешнее полное доменное имя, которое будет использоваться для доступа к RDG, например https://rdg.contoso.com/.

        Это отношение доверия проверяющей стороны, которое будет использоваться при публикации приложения в прокси веб-приложения.

4.  Опубликуйте корневой узел сайта (например, https://rdg.contoso.com/) в прокси веб-приложения. Задайте предварительную проверку подлинности AD FS и используйте созданное ранее отношение доверия с проверяющей стороной. Это позволит/рдвеб и/РПК использовать один и тот же файл cookie проверки подлинности прокси-приложения.

    /Рдвеб и/РПК можно опубликовать как отдельные приложения и даже использовать разные опубликованные серверы. Необходимо только убедиться, что публикация выполняется с использованием того же отношения доверия с проверяющей стороной, так как для отношения доверия с проверяющей стороной выдается токен прокси-сервера, и поэтому он действителен в приложениях, опубликованных с тем же отношением доверия с проверяющей стороной.

5.  Если внешнее и внутреннее полное доменное имя различаются, не следует отключать преобразование заголовка запроса в правиле публикации RDWeb. Это можно сделать, выполнив следующий сценарий PowerShell на сервере прокси веб-приложения, но он должен быть включен по умолчанию:

    ```PowerShell
    Get-WebApplicationProxyApplication applicationname | Set-WebApplicationProxyApplication -DisableTranslateUrlInRequestHeaders:$false
    ```

6.  Отключите свойство cookie HttpOnly в прокси веб-приложения для опубликованного приложения RDG. Чтобы разрешить элементу управления ActiveX RDG доступ к файлу cookie проверки подлинности прокси веб-приложения, необходимо отключить свойство HttpOnly в файле cookie прокси веб-приложения.

    Для этого необходимо установить [накопительный пакет обновления за ноябрь 2014 для Windows RT 8,1, Windows 8.1 и Windows Server 2012 R2 (KB3000850)](https://support.microsoft.com/kb/3000850).

    После установки исправления выполните следующий сценарий PowerShell на сервере прокси веб-приложения, указав соответствующее имя приложения:

    ```PowerShell
    Get-WebApplicationProxyApplication applicationname | Set-WebApplicationProxyApplication -DisableHttpOnlyCookieProtection:$true
    ```

    Отключение HttpOnly позволяет элементу управления ActiveX RDG доступ к файлу cookie проверки подлинности прокси веб-приложения.

7.  Настройте соответствующую коллекцию RDG на сервере сбора, чтобы позволить клиенту подключение к удаленному рабочему столу (mstsc. exe) быть уверенным в том, что в RDP-файле требуется предварительная проверка подлинности.

    -   В Windows Server 2012 и Windows Server 2012 R2 это можно сделать, выполнив следующий командлет PowerShell на сервере сбора RDG:

        ```PowerShell
        Set-RDSessionCollectionConfiguration -CollectionName "<yourcollectionname>" -CustomRdpProperty "pre-authentication server address:s: <https://externalfqdn/rdweb/>`nrequire pre-authentication:i:1"
        ```

        Убедитесь, что вы удалили < и > скобки при замене собственными значениями, например:

        ```PowerShell
        Set-RDSessionCollectionConfiguration -CollectionName "MyAppCollection" -CustomRdpProperty "pre-authentication server address:s: https://rdg.contoso.com/rdweb/`nrequire pre-authentication:i:1"
        ```

    -   В Windows Server 2008 R2:

        1.  Войдите на сервер терминалов с учетной записью, обладающей правами администратора.

        2.  Последовательно выберите **пуск** >**Администрирование** > **службы терминалов** > **TS Диспетчер удаленных приложений RemoteApp.**

        3.  В области **Обзор** служб терминалов Диспетчер удаленных приложений RemoteApp, рядом с параметрами RDP, нажмите кнопку **изменить**.

        4.  На вкладке **Custom RDP Settings** (настраиваемые параметры протокола удаленного рабочего стола) введите следующие параметры RDP в поле Custom RDP Settings (настраиваемые параметры удаленного рабочего стола):

            `pre-authentication server address: s: https://externalfqdn/rdweb/`

            `require pre-authentication:i:1`

        5.  По завершении нажмите кнопку **Применить**.

            Это предписывает серверу сбора данных о необходимости включения настраиваемых свойств RDP в RDP-файлы, отправляемые клиентам. Они сообщают клиенту, что требуется предварительная проверка подлинности, и передать файлы cookie для адреса сервера предварительной проверки подлинности клиенту подключение к удаленному рабочему столу (mstsc. exe). Это, в сочетании с отключением HttpOnly в приложении прокси веб-приложения, позволяет клиенту подключение к удаленному рабочему столу (mstsc. exe) использовать файл cookie проверки подлинности прокси веб-приложения, полученный через браузер.

            Дополнительные сведения о RDP см. в разделе [Настройка сценария OTP шлюза служб терминалов](https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/cc731249(v=ws.10)).

## <a name="BKMK_Links"></a> См. также

- [Планирование публикации приложений с помощью прокси веб-приложения](https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/dn383650(v=ws.11))

- [Диагностика прокси-службы веб-приложения](https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/dn770156(v=ws.11))

- [Пошаговое руководство по прокси веб-приложения](https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/dn280944(v=ws.11))
