---
title: Диагностика прокси-службы веб-приложения
ms.author: kgremban
author: eross-msft
ms.date: 07/13/2016
ms.topic: article
ms.prod: windows-server
ms.assetid: a2fef55d-747b-4e20-8f21-5f8807e7ef87
ms.technology: web-app-proxy
ms.openlocfilehash: e0907f2b096301418b5a65b87a06f97af683d4e4
ms.sourcegitcommit: b00d7c8968c4adc8f699dbee694afe6ed36bc9de
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/08/2020
ms.locfileid: "80818647"
---
# <a name="troubleshooting-web-application-proxy"></a>Диагностика прокси-службы веб-приложения

>Область применения: Windows Server 2016

**Это содержимое относится к локальной версии прокси веб-приложения. Чтобы обеспечить безопасный доступ к локальным приложениям в облаке, ознакомьтесь с [содержимым AD application proxy Azure](https://azure.microsoft.com/documentation/articles/active-directory-application-proxy-get-started/).**  
  
В этом разделе приводятся процедуры устранения неполадок для прокси веб-приложения, включая объяснения событий и решения. Есть три места, где отображаются ошибки:  
  
-   В консоли администратора веб-приложения прокси  
  
    Каждый идентификатор события, указанный в консоли администрирования, можно просмотреть в Просмотр событий Windows, а соответствующие описания и решения приведены ниже.  
  
    Откройте Просмотр событий и найдите события, связанные с прокси веб-приложения, в разделе **журналы приложений и служб** > **Microsoft** > **Windows** > **прокси веб-приложения** > **Администратор**  
  
    ![](media/Troubleshooting-Web-Application-Proxy/WebApplicationProxyTroubleshooting.png)  
  
    При необходимости можно получить подробные журналы, включив журналы аналитики и отладки и включив журнал сеанса прокси-службы веб приложения, который находится в Просмотр событий Windows в разделе \ Microsoft \ Windows \ прокси-сервер приложений \ администратор.  
  
-   Ошибки PowerShell  
  
    В PowerShell отображаются события, возникающие во время настройки.  
  
    Все ошибки предоставляются пользователю PowerShell с помощью стандартных запросов на выявление ошибок PowerShell. Все команды PowerShell регистрируются как события. Все события, происходящие в PowerShell, перечислены в Просмотр событий Windows с ИДЕНТИФИКАТОРом 12016 и определены ниже в разделе PowerShell.  
  
-   В анализатор соответствия рекомендациям  
  
    Эти события описаны в [анализатор соответствия рекомендациям для прокси-службы Web Application](assetId:///995f5cea-e334-4ce6-a14c-6a2d03c0c79a) .  
  
## <a name="powershell-messages"></a>Сообщения PowerShell  
  
|Событие или симптом|Возможная причина|Разрешение|  
|--------------------|------------------|--------------|  
|Недопустимый сертификат доверия ("ADFS Прокситруст-<WAP machine name>")|Это может быть вызвано следующим:<p>-Прокси приложения слишком долго не работает.<br />— Отсоединение между прокси-приложением и AD FS<br />— Проблемы с инфраструктурой сертификатов<br />-Изменения на AD FS компьютере или процесс продления между прокси-сервером и AD FS не выполнялись как запланированные каждые 8 часов, необходимо продлить доверие<br />— Часы прокси-компьютера и AD FS не синхронизированы.|Убедитесь, что часы синхронизированы. Выполните командлет Install-Вебаппликатионпрокси.|  
|Данные конфигурации не найдены в AD FS|Это может быть вызвано тем, что прокси веб-приложения еще не был полностью установлен или из-за изменений в AD FS базе данных или повреждении базы данных.|Выполните командлет Install-Вебаппликатионпрокси.|  
|Произошла ошибка при попытке прокси веб-приложения прочитать конфигурацию из AD FS.|Это может означать, что AD FS недоступен или AD FS обнаружил внутреннюю проблему при попытке чтения конфигурации из базы данных AD FS.|Убедитесь, что AD FS доступен и работает правильно.|  
|Данные конфигурации, хранящиеся в AD FS, повреждены, или прокси-серверу не удалось его проанализировать.<p>ИЛИ<p>Проксивас веб-приложения не удалось получить список проверяющих сторон из AD FS.|Это может произойти, если данные конфигурации были изменены в AD FS.|Перезапустите веб-приложение Проксисервице. Если проблема не исчезнет, выполните командлет Install-Вебаппликатионпрокси.|  
  
## <a name="administrator-console-events"></a>События консоль администратора  
Следующие события консоли администрирования обычно свидетельствуют об ошибках проверки подлинности, недопустимых Токес или файлах cookie с истекшим сроком действия.  
  
|Событие или симптом|Возможная причина|Разрешение|  
|--------------------|------------------|--------------|  
|11005<p>Прокси веб-приложения не удалось создать ключ шифрования файлов cookie, используя секрет из конфигурации.|Параметр глобальной конфигурации "Акцесскукиесенкриптионкэй" был изменен командой PowerShell: Set-Вебаппликатионпроксиконфигуратион-Реженератеакцесскукиесенкриптионкэй|Никаких действий не требуется. Неисправный файл cookie был удален, и пользователь был перенаправлен в службу STS для проверки подлинности.|  
|12000<p>Прокси веб-приложения не удалось проверить изменения конфигурации по крайней мере 60 минут.|Прокси веб-приложения не может получить доступ к конфигурации прокси веб-приложения с помощью команды Get-Вебаппликатионпроксиконфигуратион/Application. Обычно причиной этого является отсутствие подключения к AD FS или необходимость продления уровня доверия с AD FS.|Проверьте подключение с AD FS. Это можно сделать с помощью ссылки HTTPS://< FQDN_AD_FS_Proxy >/FederationMetadata/2007-06/FederationMetadata.xmlMake убедитесь, что между AD FS и прокси веб-приложения установлено отношение доверия. Если эти решения не работают, выполните командлет Install-Вебаппликатионпрокси.|  
|12003<p>Прокси веб-приложения не удалось проанализировать файл cookie доступа.|Это может означать, что прокси веб-приложения и AD FS не подключены или не получают одинаковую конфигурацию.|Проверьте подключение с AD FS. Это можно сделать с помощью ссылки HTTPS://< FQDN_AD_FS_Proxy >/FederationMetadata/2007-06/FederationMetadata.xmlMake убедитесь, что между AD FS и прокси веб-приложения установлено отношение доверия. Если эти решения не работают, выполните командлет Install-Вебаппликатионпрокси.|  
|12004<p>Прокси веб-приложения получил запрос с недопустимым файлом cookie для доступа.|Это событие может указывать на то, что прокси веб-приложения и AD FS не подключены или не получают одинаковую конфигурацию.<p>Если вы запустили параметр "Акцесскукиесенкриптионкэй", чажед командой PowerShell Set-Вебаппликатионпроксиконфигуратион-Реженератеакцесскукиесенкриптионкэй, это событие является нормальным и не требует действий по его устранению.|Проверьте подключение с AD FS. Это можно сделать с помощью ссылки HTTPS://< FQDN_AD_FS_Proxy >/FederationMetadata/2007-06/FederationMetadata.xmlMake убедитесь, что между AD FS и прокси веб-приложения установлено отношение доверия. Если эти решения не работают, выполните командлет Install-Вебаппликатионпрокси.|  
|12008<p>Прокси веб-приложения превысил максимальное число попыток проверки подлинности Kerberos для внутреннего сервера.|Это событие может означать неправильную конфигурацию между прокси веб-приложения и сервером серверных приложений, а также проблему в конфигурации времени и даты на обоих компьютерах.|Внутренний сервер отклонил билет Kerberos, созданный прокси веб-приложением. Убедитесь, что конфигурация прокси веб-приложения и сервера серверных приложений настроены правильно.<p>Убедитесь, что конфигурация времени и даты в прокси веб-приложения и сервере серверных приложений синхронизирована.|  
|12011<p>Прокси веб-приложения получил запрос с недействительной сигнатурой cookie для доступа.|Это событие может указывать на то, что прокси веб-приложения и AD FS не подключены или не получают одинаковую конфигурацию. Если вы запустили параметр "Акцесскукиесенкриптионкэй", чажед командой PowerShell Set-Вебаппликатионпроксиконфигуратион-Реженератеакцесскукиесенкриптионкэй, это событие является нормальным и не требует действий по его устранению.|Проверьте подключение с AD FS. Это можно сделать с помощью ссылки HTTPS://< FQDN_AD_FS_Proxy >/FederationMetadata/2007-06/FederationMetadata.xmlMake убедитесь, что между AD FS и прокси веб-приложения установлено отношение доверия. Если эти решения не работают, выполните командлет Install-Вебаппликатионпрокси.|  
|12027<p>В прокси-сервере произошла непредвиденная ошибка при обработке запроса. Указанное имя не является правильно сформированным именем учетной записи.|Это событие может указывать на неправильную конфигурацию между прокси веб-приложения и сервером контроллера домена, а также на проблемы в конфигурации времени и даты на обоих компьютерах.|Контроллер домена отклонил билет Kerberos, созданный прокси веб-приложением. Убедитесь, что конфигурация прокси веб-приложения и сервера серверных приложений настроена правильно, особенно в конфигурации имени субъекта-службы. Убедитесь, что прокси веб-приложения является доменом, присоединенным к тому же домену, что и контроллер домена, чтобы контроллер домена установил отношение доверия с прокси веб-приложения. Убедитесь, что конфигурация времени и даты в прокси веб-приложения и на контроллере домена синхронизирована.|  
|13012<p>Прокси веб-приложения получил недействительную сигнатуру токена ребра||Убедитесь, что вы обновили прокси веб-приложения с [KB 2955164](https://go.microsoft.com/fwlink/?LinkId=400701).|  
|13013<p>Прокси веб-приложения получил запрос, содержащий токен с истекшим сроком действия.|Для прокси-службы и AD FS не синхронизированы часы.|Синхронизируйте часы между прокси веб-приложения и AD FS.|  
|13014<p>Прокси веб-приложения получил запрос с недопустимым маркером ребра. Токен является недопустимым, так как его не удалось проанализировать.|Это может свидетельствовать о проблемах с конфигурацией AD FS.|Проверьте конфигурацию AD FS и при необходимости восстановите конфигурацию по умолчанию.|  
|13015<p>Прокси веб-приложения получил запрос с просроченным файлом cookie с истекшим доступом.|Это может означать, что часы не синхронизированы.|При работе с кластером виртуальных машин прокси-приложений убедитесь, что время и дата синхронизации компьютеров синхронизированы.|  
|13016<p>Прокси веб-приложения не может получить билет Kerberos от имени пользователя, так как в пограничном маркере или файле cookie доступа отсутствует UPN.|Возникла проблема с конфигурацией STS.|Исправьте конфигурацию утверждения имени участника-пользователя в STS.|  
|13019<p>Прокси веб-приложения не может получить билет Kerberos от имени пользователя из-за следующей общей ошибки API|Это событие может указывать на неправильную конфигурацию между прокси веб-приложения и сервером контроллера домена, а также на проблемы в конфигурации времени и даты на обоих компьютерах.|Контроллер домена отклонил билет Kerberos, созданный прокси веб-приложением. Убедитесь, что конфигурация прокси веб-приложения и сервера серверных приложений настроена правильно, особенно в конфигурации имени субъекта-службы. Убедитесь, что прокси веб-приложения является доменом, присоединенным к тому же домену, что и контроллер домена, чтобы контроллер домена установил отношение доверия с прокси веб-приложения. Убедитесь, что конфигурация времени и даты в прокси веб-приложения и на контроллере домена синхронизирована.|  
|13020<p>Прокси веб-приложения не может получить билет Kerberos от имени пользователя, так как имя участника внутреннего сервера не определено.|Это событие может указывать на неправильную конфигурацию между прокси веб-приложения и сервером контроллера домена, а также на проблемы в конфигурации времени и даты на обоих компьютерах.|Контроллер домена отклонил билет Kerberos, созданный прокси веб-приложением. Убедитесь, что конфигурация прокси веб-приложения и сервера серверных приложений настроена правильно, особенно в конфигурации имени субъекта-службы. Убедитесь, что прокси веб-приложения является доменом, присоединенным к тому же домену, что и контроллер домена, чтобы контроллер домена установил отношение доверия с прокси веб-приложения. Убедитесь, что конфигурация времени и даты в прокси веб-приложения и на контроллере домена синхронизирована.|  
|13022<p>Прокси веб-приложения не может проверить подлинность пользователя, так как внутренний сервер отвечает на попытки проверки подлинности Kerberos с ошибкой HTTP 401.|Это событие может означать неправильную конфигурацию между прокси веб-приложения и сервером серверных приложений, а также проблему в конфигурации времени и даты на обоих компьютерах.|Внутренний сервер отклонил билет Kerberos, созданный прокси веб-приложением. Убедитесь, что конфигурация прокси веб-приложения и сервера серверных приложений настроены правильно. Убедитесь, что конфигурация времени и даты в прокси веб-приложения и сервере серверных приложений синхронизирована.|  
|13025<p>Клиент не представил сертификат SSL для прокси веб-приложения.|Это событие может указывать на проблему в конфигурации времени и даты.|Убедитесь, что инфраструктура сертификатов действительна, и что время и Дата прокси веб-приложения и AD FS синхронизированы. Убедитесь, что в качестве отпечатка, настроенного для прокси веб-приложения, выбран правильный.|  
|13026<p>Клиент представил сертификат SSL для прокси веб-приложения, но сертификат недействителен: сертификат не соответствует отпечатку.|Это событие может указывать на проблему в конфигурации времени и даты.|Убедитесь, что инфраструктура сертификатов действительна, и что время и Дата прокси веб-приложения и AD FS синхронизированы. Убедитесь, что в качестве отпечатка, настроенного для прокси веб-приложения, выбран правильный.|  
|13028<p>Прокси веб-приложения получил запрос, содержащий крайний маркер, который еще не является допустимым.|Это событие может указывать на проблему в конфигурации времени и даты.|Убедитесь, что инфраструктура сертификатов действительна, и что время и Дата прокси веб-приложения и AD FS синхронизированы.|  
|13030<p>Клиент представил сертификат SSL для прокси веб-приложения, но поставщик доверия не доверяет центру сертификации, выдавшей сертификат клиента.|Это событие может указывать на проблему в конфигурации времени и даты.|Убедитесь, что инфраструктура сертификатов действительна, и что время и Дата прокси веб-приложения и AD FS синхронизированы. Убедитесь, что в качестве отпечатка, настроенного для прокси веб-приложения, выбран правильный.|  
|13031<p>Клиент представил сертификат SSL для прокси веб-приложения, но цепочка сертификатов была прервана в корневом сертификате, который не является доверенным для поставщика доверия.|Это событие может указывать на проблему в конфигурации времени и даты.|Убедитесь, что инфраструктура сертификатов действительна, и что время и Дата прокси веб-приложения и AD FS синхронизированы. Убедитесь, что в качестве отпечатка, настроенного для прокси веб-приложения, выбран правильный.|  
|13032<p>Клиент представил сертификат SSL для прокси веб-приложения, но сертификат был недействителен для запрошенного использования.|Это событие может указывать на проблему в конфигурации времени и даты.|Убедитесь, что инфраструктура сертификатов действительна, и что время и Дата прокси веб-приложения и AD FS синхронизированы. Убедитесь, что в качестве отпечатка, настроенного для прокси веб-приложения, выбран правильный.|  
|13033<p>Клиент представил сертификат SSL для прокси веб-приложения, но сертификат не был в течение срока действия при проверке относительно текущих системных часов или метки времени в подписанном файле.|Это событие может указывать на проблему в конфигурации времени и даты.|Убедитесь, что инфраструктура сертификатов действительна, и что время и Дата прокси веб-приложения и AD FS синхронизированы. Убедитесь, что в качестве отпечатка, настроенного для прокси веб-приложения, выбран правильный.|  
|13034<p>Клиент представил сертификат SSL для прокси веб-приложения, но сертификат был недействителен.|Это событие может указывать на проблему в конфигурации времени и даты.|Убедитесь, что инфраструктура сертификатов действительна, и что время и Дата прокси веб-приложения и AD FS синхронизированы. Убедитесь, что в качестве отпечатка, настроенного для прокси веб-приложения, выбран правильный.|  
  
Следующие события консоли администрирования обычно свидетельствуют о проблемах с такими настройками, как подготовка, неуспешное выполнение запроса, недоступность внутренних серверов и переполнение буфера.  
  
|Событие или симптом|Возможная причина|Разрешение|  
|--------------------|------------------|--------------|  
|12019<p>Прокси веб-приложения не удалось создать прослушиватель для следующего URL-адреса.|Возможной причиной этого события является то, что другая служба прослушивает тот же URL-адрес.|Администратор должен убедиться, что ни один из них не прослушивает одни и те же URL-адреса. Чтобы проверить это, выполните команду: netsh http urlacl. Если этот URL-адрес используется другим компонентом, выполняемым на компьютере прокси-службы, удалите его или используйте другой URL-адрес для публикации приложений с помощью прокси веб-приложения.|  
|12020<p>Прокси веб-приложения не удалось создать резервирование для следующего URL-адреса.|Возможной причиной этого события является то, что другая служба имеет резервирование на том же URL-адресе.|Администратор должен убедиться, что ни одна привязка к одним и тем же URL-адресам не выполняется. Чтобы проверить это, выполните команду: netsh http urlacl. Если этот URL-адрес используется другим компонентом, выполняемым на компьютере прокси-службы, удалите его или используйте другой URL-адрес для публикации приложений с помощью прокси веб-приложения.|  
|12021<p>Прокси-службе веб приложения не удалось привязать сертификат сервера SSL. Были применены все остальные параметры конфигурации.|Не удалось создать и задать запись конфигурации для данных сертификата SSL.|Убедитесь, что отпечатки сертификатов, настроенные для Проксяппликатионс веб-приложений, установлены на всех виртуальных машинах прокси-приложений с закрытым ключом в хранилище локального компьютера.|  
|13001<p>Недопустимый сертификат сервера SSL, представленный для прокси-сервера приложения внутренним сервером. сертификат не является доверенным.|В сертификате SSL (SSL), отправленном сервером, обнаружена одна или несколько ошибок. Это может означать, что внутренний сервер предоставил недопустимый SSL или что между прокси веб-приложения и внутренним сервером нет отношения доверия.|Проверка SSL-сертификата внутреннего сервера. Убедитесь, что на компьютере прокси-приложения настроен правильный корневой ЦС, чтобы доверять сертификату внутреннего сервера.|  
|13006|Если код ошибки — 0x80072EE7, фаилуррре вызывается невозможностью разрешить URL-адрес внутреннего сервера. Другие коды ошибок описаны в [https://msdn.microsoft.com/library/windows/desktop/aa384110(v=vs.85)](https://msdn.microsoft.com/library/windows/desktop/aa384110(v=vs.85))|Убедитесь, что URL-адрес внутреннего сервера указан правильно и что его имя можно правильно разрешить на компьютере прокси-сервера.|  
|13007<p>HTTP-ответ от внутреннего сервера не был получен в течение ожидаемого интервала.|Истекло время ожидания запроса к серверу, или он не отвечает.|Проверьте конфигурацию внутреннего сервера. Если это происходит очень быстро, проверьте подключение к внутреннему серверу, а также измените командлет параметра глобальной конфигурации прокси-сервера для Инактиветрансактионстимеаутсек.|  
  
## <a name="see-also"></a>См. также  
[Новые возможности прокси веб-приложений в Windows Server 2016](web-application-proxy-windows-server.md)  
[Работа с прокси веб-приложения](assetId:///b607b717-2172-4271-98d1-fa8162e0bb2e)  
  


