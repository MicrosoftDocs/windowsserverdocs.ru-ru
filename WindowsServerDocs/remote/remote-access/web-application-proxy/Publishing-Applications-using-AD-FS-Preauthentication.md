---
ms.assetid: 5f733510-c96e-4d3a-85d2-4407de95926e
title: Публикация приложений с использованием предварительной проверки подлинности AD FS
description: ''
author: kgremban
manager: femila
ms.date: 07/13/2016
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: web-app-proxy
ms.openlocfilehash: c7dab1dbf97d2dcbda1fe0375e61300f2a1cc373
ms.sourcegitcommit: 0d0b32c8986ba7db9536e0b8648d4ddf9b03e452
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2019
ms.locfileid: "59862245"
---
# <a name="publishing-applications-using-ad-fs-preauthentication"></a>Публикация приложений с использованием предварительной проверки подлинности AD FS

>Область применения. Windows Server 2016

**Это содержимое относится к локальной версии прокси веб-приложения. Чтобы включить безопасный доступ к локальным приложениям через облако, см. в разделе [содержимое прокси приложения Azure AD](https://azure.microsoft.com/documentation/articles/active-directory-application-proxy-get-started/).**  
  
В этом разделе описывается публикация приложений через прокси веб-приложения с помощью Active Directory служб федерации (AD FS) предварительной проверки подлинности.  
  
Для всех типов приложений, которые можно публиковать с помощью предварительной проверки подлинности AD FS необходимо добавить службу федерации отношение доверия с проверяющей стороной AD FS.  
  
Общий порядок предварительной проверки подлинности AD FS выглядит следующим образом:  
  
> [!NOTE]  
> Этот поток проверки подлинности неприменим для клиентов, использующих приложения Microsoft Store.  
  
1.  Клиентское устройство пытается получить доступ к опубликованному веб-приложению на URL-адрес определенного ресурса; например https://app1.contoso.com/.  
  
    URL-адрес ресурса — это общедоступный адрес, прослушиваемый прокси веб-приложения на предмет входящих HTTPS-запросов.  
  
    При включении HTTPS перенаправление с HTTP на прокси веб-приложения также будет прослушивать входящие HTTP-запросы.  
  
2.  Веб-прокси приложения перенаправляет HTTPS-запрос к серверу AD FS с параметрами в кодировке URL-адрес, включая URL-адрес ресурса и appRealm (идентификатор проверяющей стороны).  
  
    Пользователь проходит проверку подлинности с помощью метода проверки подлинности, требуемого сервером AD FS; например имя пользователя и пароля, двухфакторной проверки подлинности с помощью одноразового пароля и т. д.  
  
3.  После проверки подлинности пользователя, сервер AD FS выдает безопасности маркера, «граничный токен», содержащий следующие сведения и перенаправляет HTTPS-запрос обратно серверу прокси веб-приложения:  
  
    -   Идентификатор ресурса, к которому пытался обратиться пользователь.  
  
    -   Удостоверение пользователя в качестве имени участника-пользователя (UPN).  
  
    -   Срок действия утверждения предоставления доступа — то есть пользователю предоставляется доступ на ограниченный период, по истечении которого необходимо снова пройти проверку подлинности.  
  
    -   Подпись информации в граничном токене.  
  
4.  Прокси веб-приложения получает перенаправленный HTTPS-запрос от сервера AD FS с граничным токеном и проверяет и использует токен следующим образом:  
  
    -   Проверяет подпись маркера edge из службы федерации, который настроен в конфигурации прокси веб-приложения.  
  
    -   Проверяет, выдан ли токен для правильного приложения.  
  
    -   Проверяет, не истек ли срок действия токена.  
  
    -   При необходимости использует удостоверение пользователя, например для получения билета Kerberos, если внутренний сервер настроен для использования встроенной проверки подлинности Windows.  
  
5.  Если граничный токен действителен, веб-прокси приложения перенаправляет HTTPS-запрос опубликованному веб-приложению, с помощью HTTP или HTTPS.  
  
6.  Клиент получает доступ к опубликованному веб-приложению, однако опубликованное приложение может потребовать от пользователя пройти дополнительную проверку подлинности. Например, если опубликованное веб-приложение представляет собой сайт SharePoint и для него не требуется дополнительная проверка подлинности, то в браузере пользователя откроется сайт SharePoint.  
  
7.  Прокси веб-приложения сохраняет файл cookie на клиентском устройстве. Файл cookie, используемые прокси веб-приложения для идентификации этого сеанса уже была проведена и не дополнительная предварительная проверка подлинности не нужна.  
  
> [!IMPORTANT]  
> Во время настройки внешнего URL-адреса и URL-адреса внутреннего сервера необходимо указывать полное доменное имя, а не IP-адрес.  
  
> [!NOTE]  
> В этом разделе приводятся примеры командлетов Windows PowerShell, которые можно использовать для автоматизации некоторых описанных процедур. Дополнительные сведения см. в разделе [Командлеты](https://go.microsoft.com/fwlink/p/?linkid=230693).  
  
## <a name="BKMK_1.1"></a>Публикация приложения на основе утверждений для клиентов веб-браузера  
Чтобы опубликовать приложение, использующее утверждения для проверки подлинности, необходимо добавить в службу федерации отношение доверия с проверяющей стороной для приложения.  
  
При публикации приложений, основанных на утверждениях, и обращении к приложению из браузера общий порядок проверки подлинности состоит в следующем.  
  
1.  Клиент пытается получить доступ к приложению на основе утверждений в веб-браузере; например https://appserver.contoso.com/claimapp/.  
  
2.  Веб-браузер отправляет HTTPS-запрос к серверу прокси веб-приложения, который перенаправляет запрос на сервер AD FS.  
  
3.  Сервер AD FS выполняет проверку подлинности пользователей и устройств и перенаправляет запрос прокси веб-приложения. Теперь запрос содержит граничный токен. Сервер AD FS добавляет единый вход (SSO) файл cookie для запроса, так как пользователь уже прошел проверку подлинности на сервере AD FS.  
  
4.  Веб-прокси приложения проверяет токен, добавляет собственный файл cookie и переадресует запрос внутреннему серверу.  
  
5.  Внутренний сервер перенаправляет запрос к серверу AD FS, чтобы получить маркер безопасности для приложения.  
  
6.  Запрос перенаправляется внутреннему серверу на сервере AD FS. Теперь запрос содержит токен приложения и файл cookie для единого входа. Пользователю предоставляется доступ к приложению без необходимости вводить имя пользователя или пароль.  
  
В этой процедуре описывается публикация приложения на основе утверждений, например сайта SharePoint, к которому будут обращаться клиенты с веб-браузерами. Перед началом работы убедитесь, что выполнены следующие действия.  
  
-   Созданные доверия с проверяющей стороной для приложения в консоли управления AD FS.  
  
-   Проверить, что сертификат на сервере прокси веб-приложения подходит для приложений, которые вы хотите опубликовать.  
  

  
#### <a name="to-publish-a-claims-based-application"></a>Публикация приложения на основе утверждений  
  
1.  На сервере прокси веб-приложения в консоли управления удаленным доступом в **навигации** области щелкните **прокси веб-приложения**, а затем в **задачи** области нажмите кнопку **Публикации**.  
  
2.  В окне **мастера публикации нового приложения** на **странице приветствия** нажмите кнопку **Далее**.  
  
3.  На **предварительной проверки подлинности** щелкните **служб федерации Active Directory (AD FS)**, а затем нажмите кнопку **Далее**.  
  
4.  На странице **Поддерживаемые клиенты** выберите **Веб и MSOFBA**, а затем нажмите кнопку **Далее**.  
  
5.  На странице **Проверяющая сторона** выберите из списка проверяющую сторону для публикуемого приложения и нажмите кнопку **Далее**.  
  
6.  На странице **Параметры публикации** выполните указанные ниже действия и нажмите кнопку **Далее**.  
  
    -   В поле **Имя** введите понятное имя для приложения.  
  
        Это имя используется только в списке опубликованных приложений на консоли управления удаленным доступом.  
  
    -   В поле **Внешний URL-адрес** введите внешний URL-адрес для этого приложения, например https://sp.contoso.com/app1/.  
  
    -   В списке **Внешние сертификаты** выберите сертификат, субъект которого содержит внешний URL-адрес.  
  
    -   В поле **URL-адрес внутреннего сервера** введите URL-адрес внутреннего сервера. Обратите внимание, что это значение автоматически вводится при введите внешний URL-адрес, и его следует менять только в том случае, если URL-адрес внутреннего сервера другой; например https://sp/app1/.  
  
        > [!NOTE]  
        > Прокси веб-приложения может транслировать имена узлов в URL-адреса, но не может транслировать пути. Следовательно, можно указывать другие имена узлов, но путь должен оставаться тем же. Например, можно ввести внешний URL-адрес из https://apps.contoso.com/app1/ и URL-адрес внутреннего сервера из https://app-server/app1/. Тем не менее, нельзя вводить внешний URL-адрес из https://apps.contoso.com/app1/ и URL-адрес внутреннего сервера из https://apps.contoso.com/internal-app1/.  
  
7.  Просмотрите настройки на странице **Подтверждение** , а затем нажмите кнопку **Опубликовать**. Можно скопировать команду PowerShell для настройки дополнительных опубликованных приложений.  
  
8.  На странице **Результаты** убедитесь в успешной публикации приложения, а затем нажмите кнопку **Закрыть**.  
  
![](../../media/Publishing-Applications-using-AD-FS-Preauthentication/PowerShellLogoSmall.gif)Windows PowerShell эквивалентные команды ***  
  
Следующие командлеты Windows PowerShell выполняют ту же функцию, что и предыдущая процедура. Вводите каждый командлет в одной строке, несмотря на то, что здесь они могут отображаться разбитыми на несколько строк из-за ограничений форматирования.  
  
```  
Add-WebApplicationProxyApplication  
    -BackendServerURL 'https://sp.contoso.com/app1/'  
    -ExternalCertificateThumbprint '1a2b3c4d5e6f1a2b3c4d5e6f1a2b3c4d5e6f1a2b'  
    -ExternalURL 'https://sp.contoso.com/app1/'  
    -Name 'SP'  
    -ExternalPreAuthentication ADFS  
    -ADFSRelyingPartyName 'SP_Relying_Party'  
```  
  
## <a name="BKMK_1.2"></a>Опубликовать приложение проверку подлинности на основе интеграции Windows для клиентов веб-браузера  
Прокси веб-приложения можно использовать для публикации приложений, использующие проверку подлинности Windows для интеграции. то есть прокси веб-приложения проводит предварительную проверку подлинности, при необходимости и затем может выполнить единый вход в опубликованное приложение, использующее проверку подлинности Windows для интеграции. Чтобы опубликовать приложение, использующее встроенную проверку подлинности Windows, необходимо добавить в службу федерации отношение доверия с проверяющей стороной, не поддерживающей утверждения, для приложения.  
  
Чтобы разрешить прокси веб-приложения для выполнения единого входа (SSO) и делегировать учетные данные с использованием Kerberos ограниченного делегирования, прокси веб-приложения, сервер должен быть присоединен к домену. См. в разделе [планирование Active Directory](https://technet.microsoft.com/library/dn383648.aspx#BKMK_AD).  
  
Чтобы разрешить пользователям доступ к приложениям, использующим проверку подлинности Windows, интегрированных, server прокси веб-приложения должны иметь возможность делегирование для пользователей к опубликованному приложению. Эту настройку можно выполнить на контроллере домена для любого приложения. Это можно также сделать на внутреннем сервере если он работает под управлением Windows Server 2012 R2 или Windows Server 2012. Дополнительные сведения см. в разделе [Новые возможности аутентификации Kerberos](https://technet.microsoft.com/library/hh831747.aspx).  
  
Пошаговое руководство по настройке прокси веб-приложения для публикации приложения с помощью проверки подлинности встроенная Windows, см. в разделе [настроить сайт для использования проверки подлинности Windows, интегрированный](https://technet.microsoft.com/library/dn280943.aspx#BKMK_3).  
  
При использовании проверки подлинности встроенная Windows на внутренних серверах, для проверки подлинности между прокси веб-приложения и опубликованное приложение не на основе утверждений, вместо этого использует ограниченное делегирование Kerberos для проверки подлинности конечных пользователей к приложению. Общий процесс описан ниже.  
  
1.  Клиент пытается получить доступ к приложению не основанных на утверждениях, в веб-браузере; например https://appserver.contoso.com/nonclaimapp/.  
  
2.  Веб-браузер отправляет HTTPS-запрос к серверу прокси веб-приложения, который перенаправляет запрос на сервер AD FS.  
  
3.  Сервер AD FS проверяет подлинность пользователя и перенаправляет запрос прокси веб-приложения. Теперь запрос содержит граничный токен.  
  
4.  Веб-прокси приложения проверяет токен.  
  
5.  Если маркер является допустимым, прокси веб-приложения получает билет Kerberos с контроллера домена от имени пользователя.  
  
6.  Прокси веб-приложения как часть токена механизм согласования с Protected GSS-API (SPNEGO) добавляет в запрос билет Kerberos и переадресует запрос внутреннему серверу. Запрос содержит билет Kerberos, поэтому пользователю предоставляется доступ к приложению без необходимости дополнительной проверки подлинности.  
  
В этой процедуре описывается публикация приложения, использующего встроенную проверку подлинности Windows, например Outlook Web App, к которому будут обращаться клиенты с веб-браузерами. Перед началом работы убедитесь, что выполнены следующие действия.  
  
-   Создан не поддерживающей утверждения доверия с проверяющей стороной для приложения в консоли управления AD FS.  
  
-   Настройте внутренний сервер для поддержки ограниченного делегирования Kerberos на контроллере домена или используйте командлет Set-ADUser с параметром -PrincipalsAllowedToDelegateToAccount. Обратите внимание, что если внутренний сервер работает под управлением Windows Server 2012 R2 или Windows Server 2012, можно также выполнить эту команду PowerShell на внутреннем сервере.  
  
-   Убедитесь, что серверы прокси веб-приложения настроены для делегирования именам субъекта-службы внутренних серверов.  
  
-   Проверить, что сертификат на сервере прокси веб-приложения подходит для приложений, которые вы хотите опубликовать.  
  
 
  
#### <a name="to-publish-a-non-claims-based-application"></a>Публикация приложения, не использующего утверждения  
  
1.  На сервере прокси веб-приложения в консоли управления удаленным доступом в **навигации** области щелкните **прокси веб-приложения**, а затем в **задачи** области нажмите кнопку **Публикации**.  
  
2.  В окне **мастера публикации нового приложения** на **странице приветствия** нажмите кнопку **Далее**.  
  
3.  На **предварительной проверки подлинности** щелкните **служб федерации Active Directory (AD FS)**, а затем нажмите кнопку **Далее**.  
  
4.  На странице **Поддерживаемые клиенты** выберите **Веб и MSOFBA**, а затем нажмите кнопку **Далее**.  
  
5.  На странице **Проверяющая сторона** выберите из списка проверяющую сторону для публикуемого приложения и нажмите кнопку **Далее**.  
  
6.  На странице **Параметры публикации** выполните указанные ниже действия и нажмите кнопку **Далее**.  
  
    -   В поле **Имя** введите понятное имя для приложения.  
  
        Это имя используется только в списке опубликованных приложений на консоли управления удаленным доступом.  
  
    -   В поле **Внешний URL-адрес** введите внешний URL-адрес для этого приложения, например https://owa.contoso.com/.  
  
    -   В списке **Внешние сертификаты** выберите сертификат, субъект которого содержит внешний URL-адрес.  
  
    -   В поле **URL-адрес внутреннего сервера** введите URL-адрес внутреннего сервера. Обратите внимание, что это значение автоматически вводится при введите внешний URL-адрес, и его следует менять только в том случае, если URL-адрес внутреннего сервера другой; например https://owa/.  
  
        > [!NOTE]  
        > Прокси веб-приложения может транслировать имена узлов в URL-адреса, но не может транслировать пути. Следовательно, можно указывать другие имена узлов, но путь должен оставаться тем же. Например, можно ввести внешний URL-адрес из https://apps.contoso.com/app1/ и URL-адрес внутреннего сервера из https://app-server/app1/. Тем не менее, нельзя вводить внешний URL-адрес из https://apps.contoso.com/app1/ и URL-адрес внутреннего сервера из https://apps.contoso.com/internal-app1/.  
  
    -   В поле **Имя субъекта-службы внутреннего сервера** введите имя субъекта-службы для внутреннего сервера, например HTTP/owa.contoso.com.  
  
7.  Просмотрите настройки на странице **Подтверждение** , а затем нажмите кнопку **Опубликовать**. Можно скопировать команду PowerShell для настройки дополнительных опубликованных приложений.  
  
8.  На странице **Результаты** убедитесь в успешной публикации приложения, а затем нажмите кнопку **Закрыть**.  
  
![](../../media/Publishing-Applications-using-AD-FS-Preauthentication/PowerShellLogoSmall.gif)Windows PowerShell эквивалентные команды ***  
  
Следующие командлеты Windows PowerShell выполняют ту же функцию, что и предыдущая процедура. Вводите каждый командлет в одной строке, несмотря на то, что здесь они могут отображаться разбитыми на несколько строк из-за ограничений форматирования.  
  
```  
Add-WebApplicationProxyApplication  
    -BackendServerAuthenticationSpn 'HTTP/owa.contoso.com'  
    -BackendServerURL 'https://owa.contoso.com/'  
    -ExternalCertificateThumbprint '1a2b3c4d5e6f1a2b3c4d5e6f1a2b3c4d5e6f1a2b'  
    -ExternalURL 'https://owa.contoso.com/'  
    -Name 'OWA'  
    -ExternalPreAuthentication ADFS  
    -ADFSRelyingPartyName 'Non-Claims_Relying_Party'  
```  
  
## <a name="BKMK_1.3"></a>Публикация приложения, использующего MS OFBA  
Прокси веб-приложения поддерживает доступ с клиентов Microsoft Office, таких как Microsoft Word, которые обращаются к документам и данным на внутренних серверах. Единственное различие между этими приложениями и стандартным браузером является, что перенаправление службе маркеров безопасности выполняется не с помощью обычного перенаправления HTTP, а также с использованием особых заголовков MS-OFBA согласно: [ https://msdn.microsoft.com/library/dd773463(v=office.12).aspx ](https://msdn.microsoft.com/library/dd773463(v=office.12).aspx). Внутреннее приложение может быть основано на утверждениях или на встроенной проверке подлинности Windows.   
Чтобы опубликовать приложение для клиентов, использующих MS-OFBA, необходимо добавить доверия с проверяющей стороной для приложения в службе федерации. В зависимости от приложения можно использовать проверку подлинности на основе утверждений или встроенную проверку подлинности Windows. Таким образом, необходимо добавить отношение доверия с проверяющей стороной, соответствующее приложению.  
  
Чтобы разрешить прокси веб-приложения для выполнения единого входа (SSO) и делегировать учетные данные с использованием Kerberos ограниченного делегирования, прокси веб-приложения, сервер должен быть присоединен к домену. См. в разделе [планирование Active Directory](https://technet.microsoft.com/library/dn383648.aspx#BKMK_AD).  
  
Если приложение использует проверку подлинности на основе утверждений, дополнительные шаги планирования не требуются. Если в приложении используется Windows интегрированной проверки подлинности, см. в разделе [опубликовать приложение проверку подлинности на основе интеграции Windows для клиентов веб-браузера](../web-application-proxy/../web-application-proxy/Publishing-Applications-using-AD-FS-Preauthentication.md#BKMK_1.2).  
  
Ниже описан процесс проверки подлинности для клиентов, использующих протокол MS-OFBA, с использованием проверки подлинности на основе утверждений. В данном сценарии проверки подлинности может использоваться токен приложения либо в URL-адресе, либо в основной части.  
  
1.  Пользователь работает в программе Office и в списке **Недавние документы** открывает файл на сайте SharePoint.  
  
2.  Программа Office отображает окно с элементом управления браузера, требующим от пользователя ввести учетные данные.  
  
    > [!NOTE]  
    > В некоторых случаях окно может не отображаться, если клиент уже прошел проверку подлинности.  
  
3.  Веб-прокси приложения перенаправляет запрос на сервер AD FS, который выполняет проверку подлинности.  
  
4.  Сервер AD FS перенаправляет запрос прокси веб-приложения. Теперь запрос содержит граничный токен.  
  
5.  Сервер AD FS добавляет единый вход (SSO) файл cookie для запроса, так как пользователь уже прошел проверку подлинности на сервере AD FS.  
  
6.  Прокси веб-приложения проверяет токен и переадресует запрос внутреннему серверу.  
  
7.  Внутренний сервер перенаправляет запрос к серверу AD FS, чтобы получить маркер безопасности для приложения.  
  
8.  Запрос перенаправляется внутреннему серверу. Теперь запрос содержит токен приложения и файл cookie для единого входа. Пользователю предоставляется доступ к сайту SharePoint без необходимости вводить имя пользователя или пароль для просмотра файла.  
  
Действия по публикации приложения, использующего MS-OFBA идентичны действиям для приложения на основе утверждений или приложения, не основанных на утверждениях. Для приложений на основе утверждений см. в разделе [публикация приложения на основе утверждений для клиентов веб-браузера](../web-application-proxy/../web-application-proxy/Publishing-Applications-using-AD-FS-Preauthentication.md#BKMK_1.1), для приложений, не основанных на утверждениях, см. в разделе [публикации для веб-приложения проверку подлинности на основе интеграции Windows Клиенты браузера](../web-application-proxy/../web-application-proxy/Publishing-Applications-using-AD-FS-Preauthentication.md#BKMK_1.2). Прокси веб-приложения автоматически обнаруживает клиента и выполнит проверку подлинности пользователя.  
  
## <a name="publish-an-application-that-uses-http-basic"></a>Публикация приложения, использующего HTTP Basic  

Обычная HTTP — протокол авторизации, используемый многих протоколов, для подключения клиентов с расширенными возможностями, включая смартфоны с почтовым ящиком Exchange. Дополнительные сведения о HTTP Basic, см. в разделе [RFC 2617](https://www.ietf.org/rfc/rfc2617.txt). Прокси веб-приложения обычно взаимодействует с AD FS с помощью перенаправления; Большинство клиентов с расширенными возможностями не поддерживают файлы cookie или управление состоянием. В этом случае прокси веб-приложения позволяет приложению HTTP для получения не основанного на утверждениях доверия с проверяющей стороной для приложения в службе федерации. См. в разделе [планирование Active Directory](https://technet.microsoft.com/library/dn383648.aspx#BKMK_AD).  
  
Поток проверки подлинности для клиентов, использующих HTTP Basic ниже описан на этой схеме:  
  
![](../../media/Publishing-Applications-using-AD-FS-Preauthentication/WebApplicationProxy_httpBasicflow.png)  
  
1.  Пользователь пытается получить доступ к опубликованному веб-приложению телефона клиента.  
  
2.  Приложение отправляет HTTPS-запрос на URL-адрес, опубликованный прокси веб-приложения.  
  
3.  Если запрос не содержит учетные данные, веб-прокси приложения возвращает ответ HTTP 401 в приложение, содержащее URL-адрес сервера проверки подлинности AD FS.  
  
4.  Пользователь отправляет HTTPS-запрос к приложению еще раз с авторизацией, Basic и имя пользователя и Base 64 зашифрованный пароль пользователя в веб-проверки подлинности заголовка запроса.  
  
5.  Так как устройство не может быть перенаправлено к AD FS, прокси веб-приложения отправляет запрос на проверку подлинности AD FS с учетными данными, он имеет, включая имя пользователя и пароль. Маркер можно получить от имени устройства.  
  
6.  Чтобы свести к минимуму число запросов, отправленных в AD FS, прокси веб-приложения, проверяет до тех пор, пока маркер действителен, с помощью кэшированных маркеров для последующих клиентских запросов. Прокси веб-приложения периодически очищает кэш. Можно просмотреть объем кэш-памяти с помощью счетчика производительности.  
  
7.  Если маркер является допустимым, веб-прокси приложения перенаправляет запрос внутреннему серверу, и пользователю предоставляется доступ к опубликованному веб-приложению.  
  
Следующая процедура объясняет, как для публикации основных приложений HTTP.  
  
#### <a name="to-publish-an-http-basic-application"></a>Чтобы опубликовать приложение HTTP Basic  
  
1.  На сервере прокси веб-приложения в консоли управления удаленным доступом в **навигации** области щелкните **прокси веб-приложения**, а затем в **задачи** области нажмите кнопку **Публикации**.  
  
2.  В окне **мастера публикации нового приложения** на **странице приветствия** нажмите кнопку **Далее**.  
  
3.  На **предварительной проверки подлинности** щелкните **служб федерации Active Directory (AD FS)**, а затем нажмите кнопку **Далее**.  
  
4.  На **поддерживаемые клиенты** выберите **HTTP Basic** и нажмите кнопку **Далее**.  
  
    Если вы хотите разрешить доступ к Exchange только с устройств, присоединенных к рабочей области, выберите **устройства, присоединенные к Настройка доступа только для workplace** поле. Дополнительные сведения см. в разделе [присоединение к рабочему месту с любого устройства для единого входа и эффективная двухфакторная проверка подлинности между компании приложениях](https://technet.microsoft.com/library/dn280945.aspx).  
  
5.  На странице **Проверяющая сторона** выберите из списка проверяющую сторону для публикуемого приложения и нажмите кнопку **Далее**. Обратите внимание, что этот список содержит только на утверждения, проверяющие стороны.  
  
6.  На странице **Параметры публикации** выполните указанные ниже действия и нажмите кнопку **Далее**.  
  
    -   В поле **Имя** введите понятное имя для приложения.  
  
        Это имя используется только в списке опубликованных приложений на консоли управления удаленным доступом.  
  
    -   В **внешний URL-адрес** введите внешний URL-адрес для этого приложения, например mail.contoso.com.  
  
    -   В списке **Внешние сертификаты** выберите сертификат, субъект которого содержит внешний URL-адрес.  
  
    -   В поле **URL-адрес внутреннего сервера** введите URL-адрес внутреннего сервера. Обратите внимание, что это значение автоматически вводится при введите внешний URL-адрес, и его следует менять только в том случае, если URL-адрес внутреннего сервера другой; например mail.contoso.com.  
  
7.  Просмотрите настройки на странице **Подтверждение** , а затем нажмите кнопку **Опубликовать**. Можно скопировать команду PowerShell для настройки дополнительных опубликованных приложений.  
  
8.  На странице **Результаты** убедитесь в успешной публикации приложения, а затем нажмите кнопку **Закрыть**.  
  
![](../../media/Publishing-Applications-using-AD-FS-Preauthentication/PowerShellLogoSmall.gif)Windows PowerShell эквивалентные команды ***  
  
Следующие командлеты Windows PowerShell выполняют ту же функцию, что и предыдущая процедура. Вводите каждый командлет в одной строке, несмотря на то, что здесь они могут отображаться разбитыми на несколько строк из-за ограничений форматирования.  
  
Этот сценарий Windows PowerShell позволяет предварительной проверки подлинности для всех устройств, не только к рабочему месту устройства.  
  
```  
Add-WebApplicationProxyApplication  
     -BackendServerUrl 'https://mail.contoso.com'   
     -ExternalCertificateThumbprint '697F4FF0B9947BB8203A96ED05A3021830638E50'   
     -ExternalUrl 'https://mail.contoso.com'   
     -Name 'Exchange'   
     -ExternalPreAuthentication ADFSforRichClients  
     -ADFSRelyingPartyName 'EAS_Relying_Party'  
```  
  
Следующие выполняет предварительную проверку подлинности только для устройств, присоединенных к рабочему месту:  
  
```  
Add-WebApplicationProxyApplication  
     -BackendServerUrl 'https://mail.contoso.com'   
     -ExternalCertificateThumbprint '697F4FF0B9947BB8203A96ED05A3021830638E50'   
     -EnableHTTPRedirect:$true   
     -ExternalUrl 'https://mail.contoso.com'   
     -Name 'Exchange'   
     -ExternalPreAuthentication ADFSforRichClients  
     -ADFSRelyingPartyName 'EAS_Relying_Party'  
```  
  
## <a name="BKMK_1.4"></a>Публикация приложения, использующего OAuth2, например приложения Microsoft Store  
Чтобы опубликовать приложение для приложений Microsoft Store, необходимо добавить доверия с проверяющей стороной для приложения в службе федерации.  
  
Чтобы разрешить прокси веб-приложения для выполнения единого входа (SSO) и делегировать учетные данные с использованием Kerberos ограниченного делегирования, прокси веб-приложения, сервер должен быть присоединен к домену. См. в разделе [планирование Active Directory](https://technet.microsoft.com/library/dn383648.aspx#BKMK_AD).  
  
> [!NOTE]  
> Прокси веб-приложения поддерживает публикацию только для приложений Microsoft Store, использующих протокол OAuth 2.0.  
  
В консоли управления AD FS необходимо убедиться в том, что конечная точка OAuth настроена с включенным прокси. Для этого откройте консоль управления AD FS, разверните раздел **Служба**, щелкните пункт **Конечные точки**, в списке **Конечные точки** найдите конечную точку OAuth и убедитесь, что в столбце **С включенным прокси** указано значение **Да**.  
  
Поток проверки подлинности для клиентов, использующих приложения Microsoft Store описан ниже.  
  
> [!NOTE]  
> Веб-прокси приложения перенаправляет запрос на сервер AD FS для проверки подлинности. Так как приложения Microsoft Store не поддерживают перенаправление, если вы используете приложения Microsoft Store, бывает необходимо задать URL-адрес сервера AD FS, с помощью командлета Set-WebApplicationProxyConfiguration и параметром OAuthAuthenticationURL.  
>   
> Microsoft Store приложения можно публиковать только с помощью Windows PowerShell.  
  
1.  Клиент пытается получить доступ к опубликованному веб-приложению, с помощью приложения Microsoft Store.  
  
2.  Приложение отправляет HTTPS-запрос на URL-адрес, опубликованный прокси веб-приложения.  
  
3.  Прокси веб-приложения возвращает ответ HTTP 401 в приложение, содержащее URL-адрес сервера проверки подлинности AD FS. Этот процесс называется «обнаружение».  
  
    > [!NOTE]  
    > Если приложение знает URL-адрес сервера проверки подлинности AD FS и уже есть комбинированный токен, содержащий токен OAuth и Граничный токен, шаги 2 и 3 пропускаются в этом потоке проверки подлинности.  
  
4.  Приложение отправляет HTTPS-запрос к серверу AD FS.  
  
5.  Приложение использует веб-брокер проверки подлинности для создает диалоговое окно, в котором пользователь вводит учетные данные для проверки подлинности на сервере AD FS. Сведения о брокере веб-проверки подлинности см. в статье [Брокер веб-проверки подлинности](https://msdn.microsoft.com/library/windows/apps/hh750287.aspx).  
  
6.  После успешной проверки подлинности сервера AD FS создает комбинированный токен, содержащий токен OAuth и Граничный токен и отправляет этот токен в приложение.  
  
7.  Приложение отправляет HTTPS-запрос, содержащий комбинированный токен на URL-адрес, опубликованный прокси веб-приложения.  
  
8.  Прокси веб-приложения разделяет комбинированный токен на две части и проверяет Граничный токен.  
  
9. Если граничный токен действителен, веб-прокси приложения перенаправляет запрос внутреннему серверу с него только токен OAuth. Пользователю предоставляется доступ к опубликованному веб-приложению.  
  
В этой процедуре описывается публикация приложения для OAuth2. Приложения такого типа можно опубликовать только с помощью Windows PowerShell. Перед началом работы убедитесь, что выполнены следующие действия.  
  
-   Созданные доверия с проверяющей стороной для приложения в консоли управления AD FS.  
  
-   Убедитесь, что конечных точек OAuth включен прокси в консоли управления AD FS и запомните или запишите URL-пути.  
  
-   Проверить, что сертификат на сервере прокси веб-приложения подходит для приложений, которые вы хотите опубликовать.  
  
#### <a name="to-publish-an-oauth2-app"></a>Публикация приложения OAuth2  
  
1.  На сервере прокси веб-приложения в консоли управления удаленным доступом в **навигации** области щелкните **прокси веб-приложения**, а затем в **задачи** области нажмите кнопку **Публикации**.  
  
2.  В окне **мастера публикации нового приложения** на **странице приветствия** нажмите кнопку **Далее**.  
  
3.  На **предварительной проверки подлинности** щелкните **служб федерации Active Directory (AD FS)**, а затем нажмите кнопку **Далее**.  
  
4.  На **поддерживаемые клиенты** выберите **OAuth2** и нажмите кнопку **Далее**.  
  
5.  На странице **Проверяющая сторона** выберите из списка проверяющую сторону для публикуемого приложения и нажмите кнопку **Далее**.  
  
6.  На странице **Параметры публикации** выполните указанные ниже действия и нажмите кнопку **Далее**.  
  
    -   В поле **Имя** введите понятное имя для приложения.  
  
        Это имя используется только в списке опубликованных приложений на консоли управления удаленным доступом.  
  
    -   В поле **Внешний URL-адрес** введите внешний URL-адрес для этого приложения, например https://server1.contoso.com/app1/.  
  
    -   В списке **Внешние сертификаты** выберите сертификат, субъект которого содержит внешний URL-адрес.  
  
        Чтобы проверить, пользователи могут обращаться к приложению, даже если они забывают вводить URL-адрес HTTPS, выберите **включить перенаправление с HTTP на HTTPS** поле.  
  
    -   В поле **URL-адрес внутреннего сервера** введите URL-адрес внутреннего сервера. Обратите внимание, что это значение автоматически вводится при введите внешний URL-адрес, и его следует менять только в том случае, если URL-адрес внутреннего сервера другой; например https://sp/app1/.  
  
        > [!NOTE]  
        > Прокси веб-приложения может транслировать имена узлов в URL-адреса, но не может транслировать пути. Следовательно, можно указывать другие имена узлов, но путь должен оставаться тем же. Например, можно ввести внешний URL-адрес из https://apps.contoso.com/app1/ и URL-адрес внутреннего сервера из https://app-server/app1/. Тем не менее, нельзя вводить внешний URL-адрес из https://apps.contoso.com/app1/ и URL-адрес внутреннего сервера из https://apps.contoso.com/internal-app1/.  
  
7.  Просмотрите настройки на странице **Подтверждение** , а затем нажмите кнопку **Опубликовать**. Можно скопировать команду PowerShell для настройки дополнительных опубликованных приложений.  
  
8.  На странице **Результаты** убедитесь в успешной публикации приложения, а затем нажмите кнопку **Закрыть**.  
  
Вводите каждый командлет в одной строке, несмотря на то, что здесь они могут отображаться разбитыми на несколько строк из-за ограничений форматирования.  
  
Чтобы задать URL-адрес проверки подлинности OAuth для сервера федерации, адрес fs.contoso.com и URL-адрес ADFS/oauth2 /:  
  
```  
Set-WebApplicationProxyConfiguration -OAuthAuthenticationURL 'https://fs.contoso.com/adfs/oauth2/'  
```  
  
Чтобы опубликовать приложение:  
  
```  
Add-WebApplicationProxyApplication  
    -BackendServerURL 'https://storeapp.contoso.com/'  
    -ExternalCertificateThumbprint '1a2b3c4d5e6f1a2b3c4d5e6f1a2b3c4d5e6f1a2b'  
    -ExternalURL 'https://storeapp.contoso.com/'  
    -Name 'Microsoft Store app Server'  
    -ExternalPreAuthentication ADFS  
    -ADFSRelyingPartyName 'Store_app_Relying_Party'  
    -UseOAuthAuthentication  
```  
  
## <a name="BKMK_Links"></a>См. также  
  
-   [Устранение неполадок прокси веб-приложения](https://technet.microsoft.com/library/dn770156.aspx)  
  
-   [Публикация приложений через прокси веб-приложения](https://technet.microsoft.com/library/dn383659.aspx)  
  
-   [Планирование публикации приложений с использованием прокси веб-приложения](https://technet.microsoft.com/library/dn383650.aspx)  
  
-   [Web Application Proxy Пошаговое руководство](https://technet.microsoft.com/library/dn280944.aspx)  
  
-   [Командлеты прокси-сервера веб-приложения в Windows PowerShell](https://technet.microsoft.com/library/dn283404.aspx)  
  
-   [Добавить WebApplicationProxyApplication](https://technet.microsoft.com/library/dn283409.aspx)  
  
-   [SET-WebApplicationProxyConfiguration](https://technet.microsoft.com/library/dn283406.aspx)  
  


