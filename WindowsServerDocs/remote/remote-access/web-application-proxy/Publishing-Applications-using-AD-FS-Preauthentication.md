---
description: Дополнительные сведения о публикации приложений с помощью предварительной проверки подлинности AD FS
ms.assetid: 5f733510-c96e-4d3a-85d2-4407de95926e
title: Публикация приложений с использованием предварительной проверки подлинности AD FS
ms.author: kgremban
author: JasonGerend
ms.date: 07/13/2016
ms.topic: article
ms.openlocfilehash: 0902a1713b5e87f1327f6b41bd12326774fa1a72
ms.sourcegitcommit: db4c35ebe56d561768d2a657da9e6d6a791457bd
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/04/2021
ms.locfileid: "101824628"
---
# <a name="publishing-applications-using-ad-fs-preauthentication"></a>Публикация приложений с использованием предварительной проверки подлинности AD FS

>Область применения. Windows Server 2016

**Это содержимое относится к локальной версии прокси веб-приложения. Чтобы обеспечить безопасный доступ к локальным приложениям в облаке, ознакомьтесь с [содержимым AD application proxy Azure](/azure/active-directory/manage-apps/application-proxy).**

В этом разделе описывается публикация приложений с помощью прокси веб-приложения с использованием предварительной проверки подлинности службы федерации Active Directory (AD FS) (AD FS).

Для всех типов приложений, которые можно опубликовать с помощью AD FS предварительной проверки подлинности, необходимо добавить AD FS отношения доверия с проверяющей стороной в служба федерации.

Общий поток предварительной проверки подлинности AD FS выглядит следующим образом:

> [!NOTE]
> Этот поток проверки подлинности неприменим для клиентов, использующих Microsoft Store приложения.

1.  Клиентское устройство пытается получить доступ к опубликованному веб-приложению по определенному URL-адресу ресурса; например https://app1.contoso.com/ ,.

    URL-адрес ресурса — это общедоступный адрес, на котором прокси-служба веб – приложения прослушивает входящие запросы HTTPS.

    Если включено перенаправление HTTP в HTTPS, прокси веб-приложения также будет прослушивать входящие запросы HTTP.

2.  Прокси веб-приложения перенаправляет запрос HTTPS на сервер AD FS с параметрами в формате URL-адреса, включая URL-адрес ресурса и Аппреалм (идентификатор проверяющей стороны).

    Пользователь проверяет подлинность с помощью метода проверки подлинности, необходимого серверу AD FS; Например, имя пользователя и пароль, двухфакторная проверка подлинности с одноразовым паролем и т. д.

3.  После проверки подлинности пользователя сервер AD FS выдает маркер безопасности, маркер пограничной лексемы, содержащий приведенные ниже сведения, и перенаправляет HTTPS-запрос на сервер прокси приложения.

    -   Идентификатор ресурса, к которому пытался обратиться пользователь.

    -   Удостоверение пользователя в качестве имени участника-пользователя (UPN).

    -   Срок действия утверждения предоставления доступа — то есть пользователю предоставляется доступ на ограниченный период, по истечении которого необходимо снова пройти проверку подлинности.

    -   Подпись информации в граничном токене.

4.  Прокси веб-приложения получает перенаправленный запрос HTTPS от AD FS сервера с маркером ребра и проверяет и использует токен следующим образом:

    -   Проверяет, что подпись маркера пограничной стороны относится к службе Федерации, настроенной в конфигурации прокси-сервера веб приложения.

    -   Проверяет, выдан ли токен для правильного приложения.

    -   Проверяет, не истек ли срок действия токена.

    -   При необходимости использует удостоверение пользователя, например для получения билета Kerberos, если внутренний сервер настроен для использования встроенной проверки подлинности Windows.

5.  Если маркер является допустимым, прокси веб-приложения перенаправляет запрос HTTPS в опубликованное веб-приложение с помощью протокола HTTP или HTTPS.

6.  Клиент получает доступ к опубликованному веб-приложению, однако опубликованное приложение может потребовать от пользователя пройти дополнительную проверку подлинности. Например, если опубликованное веб-приложение представляет собой сайт SharePoint и для него не требуется дополнительная проверка подлинности, то в браузере пользователя откроется сайт SharePoint.

7.  Прокси веб-приложения сохраняет файл cookie на клиентском устройстве. Файл cookie используется прокси веб-приложения для идентификации того, что этот сеанс уже прошел предварительную проверку подлинности и не требует дальнейшей предварительной проверки подлинности.

> [!IMPORTANT]
> Во время настройки внешнего URL-адреса и URL-адреса внутреннего сервера необходимо указывать полное доменное имя, а не IP-адрес.

> [!NOTE]
> В этом разделе приводятся примеры командлетов Windows PowerShell, которые можно использовать для автоматизации некоторых описанных процедур. Дополнительные сведения см. в разделе [Использование командлетов](https://go.microsoft.com/fwlink/p/?linkid=230693).

## <a name="publish-a-claims-based-application-for-web-browser-clients"></a><a name="BKMK_1.1"></a>Публикация приложения на основе утверждений для клиентов с веб-браузерами
Чтобы опубликовать приложение, использующее утверждения для проверки подлинности, необходимо добавить в службу федерации отношение доверия с проверяющей стороной для приложения.

При публикации приложений, основанных на утверждениях, и обращении к приложению из браузера общий поток операций проверки подлинности выглядит следующим образом:

1.  Клиент пытается получить доступ к приложению, основанному на заявках, с помощью веб-браузера. Например, https://appserver.contoso.com/claimapp/ .

2.  Веб-браузер отправляет HTTPS-запрос серверу прокси приложения, который перенаправляет запрос на сервер AD FS.

3.  Сервер AD FS проверяет подлинность пользователя и устройства и перенаправляет запрос в прокси веб-приложения. Теперь запрос содержит граничный токен. AD FS сервер добавляет в запрос файл cookie единого входа (SSO), так как пользователь уже выполнил проверку подлинности на сервере AD FS.

4.  Прокси веб-приложения проверяет маркер, добавляет собственный файл cookie и перенаправляет запрос на внутренний сервер.

5.  Внутренний сервер перенаправляет запрос на сервер AD FS, чтобы получить маркер безопасности приложения.

6.  Запрос перенаправляется на внутренний сервер сервером AD FS. Теперь запрос содержит токен приложения и файл cookie для единого входа. Пользователю предоставляется доступ к приложению без необходимости вводить имя пользователя или пароль.

В этой процедуре описывается публикация приложения на основе утверждений, например сайта SharePoint, к которому будут обращаться клиенты с веб-браузерами. Перед началом работы убедитесь, что выполнены следующие действия.

-   Создано отношение доверия с проверяющей стороной для приложения в консоли управления AD FS.

-   Проверено, что сертификат на прокси-сервере веб – приложения подходит для приложения, которое необходимо опубликовать.



### <a name="to-publish-a-claims-based-application"></a>Публикация приложения на основе утверждений

1.  В консоли управления удаленным доступом на сервере прокси веб-приложения в области **навигации** щелкните **прокси веб-приложения**, а затем в области **задачи** щелкните **опубликовать**.

2.  В окне **мастера публикации нового приложения** на **странице приветствия** нажмите кнопку **Далее**.

3.  На странице **Предварительная проверка подлинности** щелкните **службы федерации Active Directory (AD FS) (AD FS)**, а затем нажмите кнопку **Далее**.

4.  На странице **Поддерживаемые клиенты** выберите **Веб и MSOFBA**, а затем нажмите кнопку **Далее**.

5.  На странице **Проверяющая сторона** выберите из списка проверяющую сторону для публикуемого приложения и нажмите кнопку **Далее**.

6.  На странице **Параметры публикации** выполните указанные ниже действия и нажмите кнопку **Далее**.

    -   В поле **Имя** введите понятное имя для приложения.

        Это имя используется только в списке опубликованных приложений на консоли управления удаленным доступом.

    -   В поле **Внешний URL-адрес** введите внешний URL-адрес для этого приложения, например https://sp.contoso.com/app1/.

    -   В списке **Внешние сертификаты** выберите сертификат, субъект которого содержит внешний URL-адрес.

    -   В поле **URL-адрес внутреннего сервера** введите URL-адрес внутреннего сервера. Обратите внимание, что это значение автоматически вводится при вводе внешнего URL-адреса, и его следует изменить, только если URL-адрес внутреннего сервера отличается. Например, https://sp/app1/ .

        > [!NOTE]
        > Прокси веб-приложения может преобразовывать имена узлов в URL-адресах, но не может преобразовывать имена путей. Следовательно, можно указывать другие имена узлов, но путь должен оставаться тем же. Например, можно ввести внешний URL-адрес https://apps.contoso.com/app1/ и URL-адрес внутреннего сервера https://app-server/app1/ . Однако нельзя ввести внешний URL-адрес https://apps.contoso.com/app1/ и URL-адрес внутреннего сервера https://apps.contoso.com/internal-app1/ .

7.  Просмотрите настройки на странице **Подтверждение**, а затем нажмите кнопку **Опубликовать**. Можно скопировать команду PowerShell для настройки дополнительных опубликованных приложений.

8.  На странице **Результаты** убедитесь в успешной публикации приложения, а затем нажмите кнопку **Закрыть**.

#### <a name="windows-powershell-equivalent-commands"></a>Эквивалентные команды Windows PowerShell

Следующие командлеты Windows PowerShell выполняют ту же функцию, что и предыдущая процедура. Вводите каждый командлет в одной строке, несмотря на то, что здесь они могут отображаться разбитыми на несколько строк из-за ограничений форматирования.

```
Add-WebApplicationProxyApplication
    -BackendServerURL 'https://sp.contoso.com/app1/'
    -ExternalCertificateThumbprint '1a2b3c4d5e6f1a2b3c4d5e6f1a2b3c4d5e6f1a2b'
    -ExternalURL 'https://sp.contoso.com/app1/'
    -Name 'SP'
    -ExternalPreAuthentication ADFS
    -ADFSRelyingPartyName 'SP_Relying_Party'
```

## <a name="publish-an-integrated-windows-authenticated-based-application-for-web-browser-clients"></a><a name="BKMK_1.2"></a>Публикация приложения со встроенной проверкой подлинности Windows для клиентов с веб-браузерами
Прокси веб-приложения можно использовать для публикации приложений, использующих встроенную проверку подлинности Windows. Это значит, что прокси веб-приложения при необходимости выполняет предварительную проверку подлинности и может выполнять единый вход для опубликованного приложения, использующего встроенную проверку подлинности Windows. Чтобы опубликовать приложение, использующее встроенную проверку подлинности Windows, необходимо добавить в службу федерации отношение доверия с проверяющей стороной, не поддерживающей утверждения, для приложения.

Чтобы разрешить службе прокси веб-приложения выполнять единый вход (SSO) и выполнять делегирование учетных данных с помощью ограниченного делегирования Kerberos, сервер прокси веб-приложения должен быть присоединен к домену. См. раздел [Plan Active Directory](/previous-versions/orphan-topics/ws.11/dn383648(v=ws.11)#BKMK_AD).

Чтобы разрешить пользователям доступ к приложениям, использующим встроенную проверку подлинности Windows, прокси-сервер веб приложения должен предоставить возможность делегирования пользователям опубликованного приложения. Эту настройку можно выполнить на контроллере домена для любого приложения. Это также можно сделать на внутреннем сервере, если он работает под Windows Server 2012 R2 или Windows Server 2012. Дополнительные сведения см. [в разделе новые возможности проверки подлинности Kerberos](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/hh831747(v=ws.11)).

Пошаговое руководство по настройке прокси веб-приложения для публикации приложения с использованием встроенной проверки подлинности Windows см. в разделе [Настройка сайта для использования встроенной проверки подлинности Windows](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/dn280943(v=ws.11)#BKMK_3).

При использовании встроенной проверки подлинности Windows для внутренних серверов проверка подлинности между прокси веб-приложения и опубликованным приложением на основе заявок не выполняется, вместо этого для проверки подлинности конечных пользователей в приложении используется ограниченное делегирование Kerberos. Общий поток работы описан ниже:

1.  Клиент пытается получить доступ к приложению, не основанному на заявках, с помощью веб-браузера; Например, https://appserver.contoso.com/nonclaimapp/ .

2.  Веб-браузер отправляет HTTPS-запрос серверу прокси приложения, который перенаправляет запрос на сервер AD FS.

3.  Сервер AD FS выполняет проверку подлинности пользователя и перенаправляет запрос в прокси-сервер приложения. Теперь запрос содержит граничный токен.

4.  Прокси веб-приложения проверяет маркер.

5.  Если токен является допустимым, прокси-сервер приложения получает билет Kerberos от имени пользователя в контроллере домена.

6.  Прокси веб-приложения добавляет билет Kerberos в запрос в составе простого и защищенного маркера механизма согласования GSS-API (SPNEGO) и перенаправляет запрос на внутренний сервер. Запрос содержит билет Kerberos, поэтому пользователю предоставляется доступ к приложению без необходимости дополнительной проверки подлинности.

В этой процедуре описывается публикация приложения, использующего встроенную проверку подлинности Windows, например Outlook Web App, к которому будут обращаться клиенты с веб-браузерами. Перед началом работы убедитесь, что выполнены следующие действия.

-   Создано отношение доверия с проверяющей стороной, не поддерживающей утверждения, для приложения в консоли управления AD FS.

-   Настройте внутренний сервер для поддержки ограниченного делегирования Kerberos на контроллере домена или используйте командлет Set-ADUser с параметром -PrincipalsAllowedToDelegateToAccount. Обратите внимание, что если внутренний сервер работает под управлением Windows Server 2012 R2 или Windows Server 2012, эту команду PowerShell также можно выполнить на внутреннем сервере.

-   Убедитесь, что серверы прокси веб-приложений настроены для делегирования именам участников службы внутренних серверов.

-   Проверено, что сертификат на прокси-сервере веб – приложения подходит для приложения, которое необходимо опубликовать.



#### <a name="to-publish-a-non-claims-based-application"></a>Публикация приложения, не использующего утверждения

1.  В консоли управления удаленным доступом на сервере прокси веб-приложения в области **навигации** щелкните **прокси веб-приложения**, а затем в области **задачи** щелкните **опубликовать**.

2.  В окне **мастера публикации нового приложения** на **странице приветствия** нажмите кнопку **Далее**.

3.  На странице **Предварительная проверка подлинности** щелкните **службы федерации Active Directory (AD FS) (AD FS)**, а затем нажмите кнопку **Далее**.

4.  На странице **Поддерживаемые клиенты** выберите **Веб и MSOFBA**, а затем нажмите кнопку **Далее**.

5.  На странице **Проверяющая сторона** выберите из списка проверяющую сторону для публикуемого приложения и нажмите кнопку **Далее**.

6.  На странице **Параметры публикации** выполните указанные ниже действия и нажмите кнопку **Далее**.

    -   В поле **Имя** введите понятное имя для приложения.

        Это имя используется только в списке опубликованных приложений на консоли управления удаленным доступом.

    -   В поле **Внешний URL-адрес** введите внешний URL-адрес для этого приложения, например https://owa.contoso.com/.

    -   В списке **Внешние сертификаты** выберите сертификат, субъект которого содержит внешний URL-адрес.

    -   В поле **URL-адрес внутреннего сервера** введите URL-адрес внутреннего сервера. Обратите внимание, что это значение автоматически вводится при вводе внешнего URL-адреса, и его следует изменить, только если URL-адрес внутреннего сервера отличается. Например, https://owa/ .

        > [!NOTE]
        > Прокси веб-приложения может преобразовывать имена узлов в URL-адресах, но не может преобразовывать имена путей. Следовательно, можно указывать другие имена узлов, но путь должен оставаться тем же. Например, можно ввести внешний URL-адрес https://apps.contoso.com/app1/ и URL-адрес внутреннего сервера https://app-server/app1/ . Однако нельзя ввести внешний URL-адрес https://apps.contoso.com/app1/ и URL-адрес внутреннего сервера https://apps.contoso.com/internal-app1/ .

    -   В поле **Имя субъекта-службы внутреннего сервера** введите имя субъекта-службы для внутреннего сервера, например HTTP/owa.contoso.com.

7.  Просмотрите настройки на странице **Подтверждение**, а затем нажмите кнопку **Опубликовать**. Можно скопировать команду PowerShell для настройки дополнительных опубликованных приложений.

8.  На странице **Результаты** убедитесь в успешной публикации приложения, а затем нажмите кнопку **Закрыть**.

#### <a name="windows-powershell-equivalent-commands"></a>Эквивалентные команды Windows PowerShell

Следующие командлеты Windows PowerShell выполняют ту же функцию, что и предыдущая процедура. Вводите каждый командлет в одной строке, несмотря на то, что здесь они могут отображаться разбитыми на несколько строк из-за ограничений форматирования.

```
Add-WebApplicationProxyApplication
    -BackendServerAuthenticationSpn 'HTTP/owa.contoso.com'
    -BackendServerURL 'https://owa.contoso.com/'
    -ExternalCertificateThumbprint '1a2b3c4d5e6f1a2b3c4d5e6f1a2b3c4d5e6f1a2b'
    -ExternalURL 'https://owa.contoso.com/'
    -Name 'OWA'
    -ExternalPreAuthentication ADFS
    -ADFSRelyingPartyName 'Non-Claims_Relying_Party'
```

## <a name="publish-an-application-that-uses-ms-ofba"></a><a name="BKMK_1.3"></a>Публикация приложения, использующего MS-ОФБА
Прокси веб-приложения поддерживает доступ от Microsoft Office клиентов, таких как Microsoft Word, которые обращаются к документам и данным на внутренних серверах. Единственное различие между этими приложениями и стандартным браузером заключается в том, что перенаправление в STS выполняется не через регулярное перенаправление HTTP, а с специальными заголовками MS-ОФБА, как указано в: [https://msdn.microsoft.com/library/dd773463(v=office.12).aspx](/openspecs/sharepoint_protocols/ms-ofba/868d129f-f1b5-46bc-9385-4af58610dbbe) . Внутреннее приложение может быть основано на утверждениях или на встроенной проверке подлинности Windows.
Чтобы опубликовать приложение для клиентов, использующих MS-ОФБА, необходимо добавить отношение доверия с проверяющей стороной для приложения в служба федерации. В зависимости от приложения можно использовать проверку подлинности на основе утверждений или встроенную проверку подлинности Windows. Таким образом, необходимо добавить отношение доверия с проверяющей стороной, соответствующее приложению.

Чтобы разрешить службе прокси веб-приложения выполнять единый вход (SSO) и выполнять делегирование учетных данных с помощью ограниченного делегирования Kerberos, сервер прокси веб-приложения должен быть присоединен к домену. См. раздел [Plan Active Directory](/previous-versions/orphan-topics/ws.11/dn383648(v=ws.11)#BKMK_AD).

Если приложение использует проверку подлинности на основе утверждений, дополнительные шаги планирования не требуются. Если приложение использовало встроенную проверку подлинности Windows, см. статью [Публикация интегрированного приложения, использующего проверку подлинности Windows, для клиентов веб-браузера](../web-application-proxy/../web-application-proxy/Publishing-Applications-using-AD-FS-Preauthentication.md#BKMK_1.2).

Ниже описан процесс проверки подлинности для клиентов, использующих протокол MS-ОФБА с проверкой подлинности на основе утверждений. В данном сценарии проверки подлинности может использоваться токен приложения либо в URL-адресе, либо в основной части.

1.  Пользователь работает в программе Office и в списке **Недавние документы** открывает файл на сайте SharePoint.

2.  Программа Office отображает окно с элементом управления браузера, требующим от пользователя ввести учетные данные.

    > [!NOTE]
    > В некоторых случаях окно может не отображаться, если клиент уже прошел проверку подлинности.

3.  Прокси веб-приложения перенаправляет запрос на сервер AD FS, который выполняет проверку подлинности.

4.  Сервер AD FS перенаправляет запрос в прокси веб-приложения. Теперь запрос содержит граничный токен.

5.  AD FS сервер добавляет в запрос файл cookie единого входа (SSO), так как пользователь уже выполнил проверку подлинности на сервере AD FS.

6.  Прокси веб-приложения проверяет маркер и перенаправляет запрос на внутренний сервер.

7.  Внутренний сервер перенаправляет запрос на сервер AD FS, чтобы получить маркер безопасности приложения.

8.  Запрос перенаправляется внутреннему серверу. Теперь запрос содержит токен приложения и файл cookie для единого входа. Пользователю предоставляется доступ к сайту SharePoint без необходимости вводить имя пользователя или пароль для просмотра файла.

Действия по публикации приложения, использующего MS-ОФБА, идентичны шагам для приложения на основе утверждений или приложения, не основанного на заявках. Сведения о приложениях на основе утверждений см. [в разделе Публикация приложения на основе утверждений для клиентов веб-браузеров](../web-application-proxy/../web-application-proxy/Publishing-Applications-using-AD-FS-Preauthentication.md#BKMK_1.1)для приложений, не основанных на заявках, см. в статье [Публикация интегрированного приложения с проверкой подлинности Windows для клиентов веб-браузера](../web-application-proxy/../web-application-proxy/Publishing-Applications-using-AD-FS-Preauthentication.md#BKMK_1.2). Прокси веб-приложения автоматически обнаруживает клиент и выполняет проверку подлинности пользователя при необходимости.

## <a name="publish-an-application-that-uses-http-basic"></a>Публикация приложения, использующего HTTP Basic

HTTP Basic — это протокол авторизации, используемый многими протоколами для подключения полнофункциональных клиентов, включая смартфоны, с почтовым ящиком Exchange. Дополнительные сведения об HTTP Basic см. в [документе RFC 2617](https://www.ietf.org/rfc/rfc2617.txt). Прокси веб-приложения обычно взаимодействует с AD FS с помощью перенаправлений; Большинство полнофункциональных клиентов не поддерживают файлы cookie и управление состоянием. Таким образом, прокси веб-приложения позволяет приложению HTTP получить отношение доверия с проверяющей стороной, не относящейся к утверждениям, для приложения служба федерации. См. раздел [Plan Active Directory](/previous-versions/orphan-topics/ws.11/dn383648(v=ws.11)#BKMK_AD).

Последовательность проверки подлинности для клиентов, использующих HTTP Basic, описана ниже и на этой схеме.

![Схема проверки подлинности для HTTP Basic](../../media/Publishing-Applications-using-AD-FS-Preauthentication/WebApplicationProxy_httpBasicflow.png)

1.  Пользователь пытается получить доступ к опубликованному веб-приложению с помощью телефонного клиента.

2.  Приложение отправляет HTTPS-запрос URL-адресу, опубликованному прокси приложения.

3.  Если запрос не содержит учетных данных, прокси веб-приложения возвращает ответ HTTP 401 на приложение, содержащее URL-адрес сервера проверки подлинности AD FS.

4.  Пользователь снова отправляет запрос HTTPS в приложение с параметром авторизации, имеющим значение Basic, а имя пользователя и зашифрованный пароль Base 64 — в заголовке запроса WWW-Authenticate.

5.  Так как устройство не может быть перенаправлено на AD FS, прокси-приложение отправляет запрос на проверку подлинности AD FS с учетными данными, включая имя пользователя и пароль. Маркер получен от имени устройства.

6.  Чтобы свести к минимальному числу запросов, отправленных в AD FS, прокси веб-приложения проверяет последующие запросы клиентов с помощью кэшированных маркеров до тех пор, пока маркер является допустимым. Прокси веб-приложения периодически очищает кэш. Размер кэша можно просмотреть с помощью счетчика производительности.

7.  Если маркер допустим, прокси веб-приложения перенаправляет запрос на внутренний сервер, и пользователю предоставляется доступ к опубликованному веб-приложению.

В следующей процедуре объясняется, как опубликовать базовые приложения HTTP.

#### <a name="to-publish-an-http-basic-application"></a>Публикация базового приложения HTTP

1.  В консоли управления удаленным доступом на сервере прокси веб-приложения в области **навигации** щелкните **прокси веб-приложения**, а затем в области **задачи** щелкните **опубликовать**.

2.  В окне **мастера публикации нового приложения** на **странице приветствия** нажмите кнопку **Далее**.

3.  На странице **Предварительная проверка подлинности** щелкните **службы федерации Active Directory (AD FS) (AD FS)**, а затем нажмите кнопку **Далее**.

4.  На странице **Поддерживаемые клиенты** выберите **HTTP Basic** и нажмите кнопку **Далее**.

    Если вы хотите разрешить доступ к Exchange только с устройств, присоединенных к рабочей области, установите флажок **включить доступ только для присоединенных к рабочей области устройств** . Дополнительные сведения см. в разделе [Присоединение к рабочему месту с любого устройства для единого входа и Однофакторная проверка подлинности в приложениях компании](../../../identity/ad-fs/operations/join-to-workplace-from-any-device-for-sso-and-seamless-second-factor-authentication-across-company-applications.md).

5.  На странице **Проверяющая сторона** выберите из списка проверяющую сторону для публикуемого приложения и нажмите кнопку **Далее**. Обратите внимание, что этот список содержит только проверяющие стороны с утверждениями.

6.  На странице **Параметры публикации** выполните указанные ниже действия и нажмите кнопку **Далее**.

    -   В поле **Имя** введите понятное имя для приложения.

        Это имя используется только в списке опубликованных приложений на консоли управления удаленным доступом.

    -   В поле **внешний URL-адрес** введите внешний URL-адрес для этого приложения. Например, mail.contoso.com

    -   В списке **Внешние сертификаты** выберите сертификат, субъект которого содержит внешний URL-адрес.

    -   В поле **URL-адрес внутреннего сервера** введите URL-адрес внутреннего сервера. Обратите внимание, что это значение автоматически вводится при вводе внешнего URL-адреса, и его следует изменить, только если URL-адрес внутреннего сервера отличается. Например, mail.contoso.com.

7.  Просмотрите настройки на странице **Подтверждение**, а затем нажмите кнопку **Опубликовать**. Можно скопировать команду PowerShell для настройки дополнительных опубликованных приложений.

8.  На странице **Результаты** убедитесь в успешной публикации приложения, а затем нажмите кнопку **Закрыть**.

#### <a name="windows-powershell-equivalent-commands"></a>Эквивалентные команды Windows PowerShell

Следующие командлеты Windows PowerShell выполняют ту же функцию, что и предыдущая процедура. Вводите каждый командлет в одной строке, несмотря на то, что здесь они могут отображаться разбитыми на несколько строк из-за ограничений форматирования.

Этот сценарий Windows PowerShell включает предварительную проверку подлинности для всех устройств, а не только присоединенные к рабочей области устройства.

```
Add-WebApplicationProxyApplication
     -BackendServerUrl 'https://mail.contoso.com'
     -ExternalCertificateThumbprint '697F4FF0B9947BB8203A96ED05A3021830638E50'
     -ExternalUrl 'https://mail.contoso.com'
     -Name 'Exchange'
     -ExternalPreAuthentication ADFSforRichClients
     -ADFSRelyingPartyName 'EAS_Relying_Party'
```

Следующие предварительные проверки подлинности только присоединенные к рабочему месту устройства:

```
Add-WebApplicationProxyApplication
     -BackendServerUrl 'https://mail.contoso.com'
     -ExternalCertificateThumbprint '697F4FF0B9947BB8203A96ED05A3021830638E50'
     -EnableHTTPRedirect:$true
     -ExternalUrl 'https://mail.contoso.com'
     -Name 'Exchange'
     -ExternalPreAuthentication ADFSforRichClients
     -ADFSRelyingPartyName 'EAS_Relying_Party'
```

## <a name="publish-an-application-that-uses-oauth2-such-as-a-microsoft-store-app"></a><a name="BKMK_1.4"></a>Публикация приложения, использующего OAuth2, например приложение Microsoft Store
Чтобы опубликовать приложение для Microsoft Store приложений, необходимо добавить отношение доверия с проверяющей стороной для приложения в служба федерации.

Чтобы разрешить службе прокси веб-приложения выполнять единый вход (SSO) и выполнять делегирование учетных данных с помощью ограниченного делегирования Kerberos, сервер прокси веб-приложения должен быть присоединен к домену. См. раздел [Plan Active Directory](/previous-versions/orphan-topics/ws.11/dn383648(v=ws.11)#BKMK_AD).

> [!NOTE]
> Прокси веб-приложения поддерживает публикацию только для Microsoft Store приложений, использующих протокол OAuth 2,0.

В консоли управления AD FS необходимо убедиться в том, что конечная точка OAuth включена прокси. Для этого откройте консоль управления AD FS, разверните раздел **Служба**, щелкните пункт **Конечные точки**, в списке **Конечные точки** найдите конечную точку OAuth и убедитесь, что в столбце **С включенным прокси** указано значение **Да**.

Последовательность проверки подлинности для клиентов, использующих Microsoft Store приложений, описана ниже.

> [!NOTE]
> Прокси веб-приложения перенаправляется на сервер AD FS для проверки подлинности. Поскольку Microsoft Store приложения не поддерживают перенаправления, при использовании Microsoft Store приложений необходимо задать URL-адрес AD FS сервера с помощью командлета Set-WebApplicationProxyConfiguration и параметра Оаусаусентикатионурл.
>
> Microsoft Store приложения можно публиковать только с помощью Windows PowerShell.

1.  Клиент пытается получить доступ к опубликованному веб-приложению с помощью Microsoft Store приложения.

2.  Приложение отправляет HTTPS-запрос URL-адресу, опубликованному прокси приложения.

3.  Прокси веб-приложения возвращает ответ HTTP 401 на приложение, содержащее URL-адрес сервера, выполняющего проверку подлинности AD FS. Этот процесс называется "обнаружением".

    > [!NOTE]
    > Если приложение знает URL-адрес проверки подлинности AD FS сервера и уже имеет маркер со списком, содержащий маркер OAuth и маркер ребра, шаги 2 и 3 пропускаются в этом потоке проверки подлинности.

4.  Приложение отправляет запрос HTTPS на сервер AD FS.

5.  Приложение использует брокер веб-проверки подлинности для создания диалогового окна, в котором пользователь вводит учетные данные для проверки подлинности на сервере AD FS. Сведения о брокере веб-проверки подлинности см. в статье [Брокер веб-проверки подлинности](/previous-versions/orphan-topics/ws.11/dn383648(v=ws.11)).

6.  После успешной проверки подлинности сервер AD FS создает маркер комбинирования, содержащий маркер OAuth и маркер ребра, и отправляет маркер приложению.

7.  Приложение отправляет запрос HTTPS, содержащий маркер комбинирования, в URL-адрес, опубликованный прокси веб-приложения.

8.  Прокси веб-приложения разделяет маркер комбинирования на две части и проверяет пограничные маркеры.

9. Если маркер является допустимым, прокси веб-приложения перенаправляет запрос на внутренний сервер, используя только маркер OAuth. Пользователю предоставляется доступ к опубликованному веб-приложению.

В этой процедуре описывается публикация приложения для OAuth2. Этот тип приложения можно опубликовать только с помощью Windows PowerShell. Перед началом работы убедитесь, что выполнены следующие действия.

-   Создано отношение доверия с проверяющей стороной для приложения в консоли управления AD FS.

-   Убедитесь, что конечная точка OAuth включена в консоли управления AD FS, и запишите путь URL-адреса.

-   Проверено, что сертификат на прокси-сервере веб – приложения подходит для приложения, которое необходимо опубликовать.

#### <a name="to-publish-an-oauth2-app"></a>Публикация приложения OAuth2

1.  В консоли управления удаленным доступом на сервере прокси веб-приложения в области **навигации** щелкните **прокси веб-приложения**, а затем в области **задачи** щелкните **опубликовать**.

2.  В окне **мастера публикации нового приложения** на **странице приветствия** нажмите кнопку **Далее**.

3.  На странице **Предварительная проверка подлинности** щелкните **службы федерации Active Directory (AD FS) (AD FS)**, а затем нажмите кнопку **Далее**.

4.  На странице **Поддерживаемые клиенты** выберите **OAuth2** и нажмите кнопку **Далее**.

5.  На странице **Проверяющая сторона** выберите из списка проверяющую сторону для публикуемого приложения и нажмите кнопку **Далее**.

6.  На странице **Параметры публикации** выполните указанные ниже действия и нажмите кнопку **Далее**.

    -   В поле **Имя** введите понятное имя для приложения.

        Это имя используется только в списке опубликованных приложений на консоли управления удаленным доступом.

    -   В поле **Внешний URL-адрес** введите внешний URL-адрес для этого приложения, например https://server1.contoso.com/app1/.

    -   В списке **Внешние сертификаты** выберите сертификат, субъект которого содержит внешний URL-адрес.

        Чтобы пользователи могли получить доступ к приложению, даже если в URL-адресе не введено значение HTTPS, установите флажок **включить перенаправление HTTP в HTTPS** .

    -   В поле **URL-адрес внутреннего сервера** введите URL-адрес внутреннего сервера. Обратите внимание, что это значение автоматически вводится при вводе внешнего URL-адреса, и его следует изменить, только если URL-адрес внутреннего сервера отличается. Например, https://sp/app1/ .

        > [!NOTE]
        > Прокси веб-приложения может преобразовывать имена узлов в URL-адресах, но не может преобразовывать имена путей. Следовательно, можно указывать другие имена узлов, но путь должен оставаться тем же. Например, можно ввести внешний URL-адрес https://apps.contoso.com/app1/ и URL-адрес внутреннего сервера https://app-server/app1/ . Однако нельзя ввести внешний URL-адрес https://apps.contoso.com/app1/ и URL-адрес внутреннего сервера https://apps.contoso.com/internal-app1/ .

7.  Просмотрите настройки на странице **Подтверждение**, а затем нажмите кнопку **Опубликовать**. Можно скопировать команду PowerShell для настройки дополнительных опубликованных приложений.

8.  На странице **Результаты** убедитесь в успешной публикации приложения, а затем нажмите кнопку **Закрыть**.

Вводите каждый командлет в одной строке, несмотря на то, что здесь они могут отображаться разбитыми на несколько строк из-за ограничений форматирования.

Чтобы задать URL-адрес проверки подлинности OAuth для адреса сервера федерации fs.contoso.com и URL-пути/ADFS/OAuth2/, сделайте следующее:

```
Set-WebApplicationProxyConfiguration -OAuthAuthenticationURL 'https://fs.contoso.com/adfs/oauth2/'
```

Чтобы опубликовать приложение:

```
Add-WebApplicationProxyApplication
    -BackendServerURL 'https://storeapp.contoso.com/'
    -ExternalCertificateThumbprint '1a2b3c4d5e6f1a2b3c4d5e6f1a2b3c4d5e6f1a2b'
    -ExternalURL 'https://storeapp.contoso.com/'
    -Name 'Microsoft Store app Server'
    -ExternalPreAuthentication ADFS
    -ADFSRelyingPartyName 'Store_app_Relying_Party'
    -UseOAuthAuthentication
```

## <a name="see-also"></a><a name="BKMK_Links"></a> См. также

-   [Диагностика прокси-службы веб-приложения](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/dn770156(v=ws.11))

-   [Публикация приложений с помощью прокси веб-приложения](/previous-versions/orphan-topics/ws.11/dn383659(v=ws.11))

-   [Планирование публикации приложений с помощью прокси-службы веб-приложения](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/dn383650(v=ws.11))

-   [Пошаговое руководство по работе с прокси-службой веб-приложения](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/dn280944(v=ws.11))

-   [Командлеты прокси-сервера веб-приложений в Windows PowerShell](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/dn280944(v=ws.11))

-   [Add-WebApplicationProxyApplication](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/dn280944(v=ws.11))

-   [Set-WebApplicationProxyConfiguration](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/dn280944(v=ws.11))

