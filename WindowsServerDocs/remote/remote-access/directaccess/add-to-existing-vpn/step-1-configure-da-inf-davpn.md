---
title: Шаг 1. Настройка инфраструктуры DirectAccess
description: Эта статья является частью инструкции по добавлению DirectAccess в существующее развертывание удаленного доступа (VPN) для Windows Server 2016.
manager: brianlic
ms.topic: article
ms.assetid: 5dc529f7-7bc3-48dd-b83d-92a09e4055c4
ms.author: lizross
author: eross-msft
ms.openlocfilehash: c52c26d44e50075f9c28dfdec7c2ab4fc420e163
ms.sourcegitcommit: dfa48f77b751dbc34409aced628eb2f17c912f08
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/07/2020
ms.locfileid: "87948957"
---
# <a name="step-1-configure-the-directaccess-infrastructure"></a>Шаг 1. Настройка инфраструктуры DirectAccess

>Область применения. Windows Server (Semi-Annual Channel), Windows Server 2016

В этом разделе описывается настройка необходимой инфраструктуры для создания DirectAccess в уже развернутой сети VPN. Перед началом развертывания убедитесь, что выполнены шаги по планированию, описанные в разделе [Шаг 1. Планирование инфраструктуры DirectAccess](Step-1-Plan-DirectAccess-Infrastructure.md).

|Задача|Описание|
|----|--------|
|Настройка сетевых параметров сервера|Настройте сетевые параметры на сервере удаленного доступа.|
|Настройте маршрутизацию в корпоративной сети|Для правильного направления трафика следует настроить маршрутизацию в корпоративной сети.|
|Настройка брандмауэров|При необходимости настройте дополнительные брандмауэры.|
|Настройка центров сертификации и сертификатов|Мастер включения DirectAccess настраивает встроенный прокси-сервер Kerberos, который выполняет проверку подлинности с использованием имен пользователей и паролей. а также настраивает сертификат IP-HTTPS на сервере удаленного доступа.|
|Настройка DNS-сервера|Настройте параметры DNS для сервера удаленного доступа.|
|Настройка Active Directory|Включите клиентские компьютеры в домен Active Directory.|
|Настройка объектов групповой политики|Если необходимо, настройте объекты групповой политики для развертывания.|
|Настройка групп безопасности|Настройте группы безопасности, включающие компьютеры клиентов DirectAccess, а также любые другие группы безопасности, необходимые для развертывания.|
|Настройка сервера сетевых расположений|Мастер установки DirectAccess позволяет настроить сервер сетевых расположений на сервере DirectAccess.|

## <a name="configure-server-network-settings"></a><a name="ConfigNetworkSettings"></a>Настройка сетевых параметров сервера
Для развертывания одиночного сервера в среде, работающей на основе IPv4 и IPv6, необходимо выполнить следующие настройки сетевого интерфейса: Для настройки всех IP-адресов используется пункт **Изменение параметров адаптера** в разделе **Центр управления сетями и общим доступом Windows**.

-   Пограничная топология

    -   Один направленный в Интернет IPv4- или IPv6-адрес.

    -   Один внутренний статический IPv4- или IPv6-адрес.

-   За устройством NAT (два сетевых адаптера)

    -   Один внутренний IPv4- или IPv6-адрес, направленный в Интернет.

-   За устройством NAT (один сетевой адаптер)

    -   Один статический IPv4- или IPv6-адрес.

> [!NOTE]
> Если сервер удаленного доступа оснащен двумя сетевыми адаптерами (один указан в доменном профиле, а другой — в публичном или частном), но планируется использование топологии с одной сетевой картой, следует выполнить следующие действия:
>
> 1.  Рекомендуется убедиться, что вторая сетевая карта также указана в доменном профиле.
> 2.  Если вторая сетевая карта по какой-либо причине не может быть настроена для доменного профиля, следует вручную установить область действия политик IPsec DirectAccess для всех профилей с помощью следующих команд Windows PowerShell:
>
>     ```
>     $gposession = Open-NetGPO -PolicyStore <Name of the server GPO>
>     Set-NetIPsecRule -DisplayName <Name of the IPsec policy> -GPOSession $gposession -Profile Any
>     Save-NetGPO -GPOSession $gposession
>     ```

## <a name="configure-routing-in-the-corporate-network"></a><a name="ConfigRouting"></a>Настройте маршрутизацию в корпоративной сети
Настройте маршрутизацию в корпоративной сети следующим образом.

-   Если в организации развернута собственная инфраструктура на основе IPv6, следует добавить маршрут, позволяющий маршрутизаторам, расположенным во внутренней сети, возвращать трафик IPv6 через сервер удаленного доступа.

-   Вручную настройте маршруты IPv4 и IPv6 на серверах удаленного доступа. Добавьте опубликованный маршрут, чтобы весь трафик с префиксом IPv6 организации (/48) пересылался во внутреннюю сеть Кроме того, следует добавить подробные маршруты для направления IPv4-трафика во внутреннюю сеть.

## <a name="configure-firewalls"></a><a name="ConfigFirewalls"></a>Настройка брандмауэров
Если вы используете при развертывании дополнительные брандмауэры, примените следующие исключения для трафика удаленного доступа при выходе в Интернет, когда сервер удаленного доступа находится в сети IPv4:

-   трафик 6to4 — IP-протокол 41, входящий и исходящий.

-   Протокол IP-HTTPS — порт назначения TCP 443 и порт источника TCP 443 исходящие. Когда сервер удаленного доступа имеет один сетевой адаптер, а сервер сетевых расположений находится на сервере удаленного доступа, тогда также требуется TCP-порт 62000.

Если вы используете дополнительные брандмауэры, примените следующие исключения брандмауэра для трафика удаленного доступа при выходе в Интернет, когда сервер удаленного доступа находится в сети IPv6:

-   Протокол IP 50

-   UDP-порт назначения 500 для входящих подключений и UDP-порт источника 500 для исходящих подключений.

При использовании дополнительных брандмауэров применяйте следующие исключения внутреннего сетевого брандмауэра для трафика удаленного доступа:

-   ISATAP — протокол 41, входящий и исходящий

-   Протоколы TCP/UDP для всех типов трафика IPv4/IPv6

## <a name="configure-cas-and-certificates"></a><a name="ConfigCAs"></a>Настройка центров сертификации и сертификатов
Мастер включения DirectAccess настраивает встроенный прокси-сервер Kerberos, который выполняет проверку подлинности с использованием имен пользователей и паролей. а также настраивает сертификат IP-HTTPS на сервере удаленного доступа.

### <a name="configure-certificate-templates"></a><a name="ConfigCertTemp"></a>Настройка шаблонов сертификатов
Если для выдачи сертификатов используется внутренний ЦС, необходимо настроить шаблон для сертификата IP-HTTPS и сертификата веб-сайта сервера сетевых расположений.

##### <a name="to-configure-a-certificate-template"></a>Настройка шаблона сертификата

1.  Во внутреннем центре сертификации создайте шаблон сертификата, как описано в разделе [Создание шаблонов сертификатов](/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/cc731705(v=ws.10)).

2.  Разверните шаблон сертификата, как описано в разделе [Развертывание шаблонов сертификатов](/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/cc770794(v=ws.10)).

### <a name="configure-the-ip-https-certificate"></a>Настройка сертификата IP-HTTPS
Для проверки подлинности подключений IP-HTTPS к серверу удаленного доступа необходим сертификат IP-HTTPS. Возможны три варианта сертификата IP-HTTPS:

-   **Общедоступная**, предоставляемая сторонней стороной.

    Сертификат используется для проверки подлинности IP-HTTPS. Если имя субъекта для сертификата не является подстановочным, это должен быть URL-адрес с полным доменным именем и возможностью внешнего разрешения, используемый только для подключений IP-HTTPS сервера удаленного доступа.

-   **Частный**. следующие обязательные условия, если они еще не существуют:

    -   Сертификат веб-сайта для проверки подлинности IP-HTTPS. Субъектом сертификата должно быть полное доменное имя с возможностью внешнего разрешения, доступное из Интернета.

    -   Точка распространения списка отзыва сертификатов (CRL), доступная через Интернет.

-   **Самозаверяющий**— следующие обязательные требования, если они еще не существуют:

    > [!NOTE]
    > Самозаверяющие сертификаты не могут использоваться в развертываниях на нескольких сайтах.

    -   Сертификат веб-сайта для проверки подлинности IP-HTTPS. Субъектом сертификата должно быть полное доменное имя с возможностью внешнего разрешения, доступное из Интернета.

    -   Точка распространения списка отзыва сертификатов (CRL), доступная через Интернет.

Убедитесь, что сертификат веб-сайта, используемый для проверки подлинности IP-HTTPS, отвечает следующим требованиям:

-   Общее имя сертификата должно совпадать с именем узла IP-HTTPS.

-   В соответствующем поле укажите IPv4-адрес интернет-адаптера сервера удаленного доступа или полное доменное имя для URL IP-HTTPS.

-   В поле "Улучшенное использование ключа" используйте идентификатор объекта проверки подлинности сервера.

-   В поле "Точки распространения списков отзыва (CRL)" укажите точку распространения списков отзыва сертификатов, доступную клиентам удаленного доступа, подключенным к Интернету.

-   У сертификата IP-HTTPS должен быть закрытый ключ.

-   Сертификат IP-HTTPS необходимо импортировать непосредственно в личное хранилище сертификатов.

-   В именах сертификатов IP-HTTPS может содержаться подстановочный знак.

##### <a name="to-install-the-ip-https-certificate-from-an-internal-ca"></a>Установка сертификата IP-HTTPS из внутреннего ЦС

1.  На сервере удаленного доступа: на **начальном** экране введите**mmc.exe**и нажмите клавишу ВВОД.

2.  В консоли MMC в меню **Файл** выберите **Добавить или удалить оснастку**.

3.  В диалоговом окне **Добавить или удалить оснастку** щелкните **Сертификаты**, после чего нажмите **Добавить**, выберите **Учетная запись компьютера**, щелкните **Далее**, нажмите **Локальный компьютер**, щелкните **Готово**, а затем — **OK**.

4.  В дереве консоли оснастки "Сертификаты" откройте раздел **Сертификаты (локальный компьютер)\Личные\Сертификаты**.

5.  Щелкните правой кнопкой **Сертификаты**, наведите указатель на элемент **Все задачи**, а затем щелкните **Запрос нового сертификата**.

6.  Щелкните дважды **Далее**.

7.  На странице **запрос сертификатов** установите флажок для шаблона сертификата и при необходимости щелкните **Дополнительные сведения для регистрации этого сертификата**.

8.  В диалоговом окне **Свойства сертификата** на вкладке **Субъект** выберите для параметра **Имя субъекта** в списке **Тип** значение**Обычное имя**.

9. В поле **Значение** укажите IPv4-адрес интернет-адаптера сервера удаленного доступа или полное доменное имя для URL IP-HTTPS, после чего щелкните **Добавить**.

10. В области **Альтернативное имя** в поле **Тип** выберите **DNS**.

11. В поле **Значение** укажите IPv4-адрес интернет-адаптера сервера удаленного доступа или полное доменное имя для URL IP-HTTPS, после чего щелкните **Добавить**.

12. На вкладке **Общие** в поле **Понятное имя** можно ввести имя, которое упростит идентификацию сертификатов.

13. Во вкладке **Расширения** щелкните стрелку рядом со строкой **Расширенное использование ключа** и убедитесь, что проверка подлинности сервера занесена в список **Выбранные параметры**.

14. Нажмите кнопку **OK**, щелкните **Зарегистрировать** и нажмите кнопку **Готово**.

15. В области сведений оснастки "Сертификаты" убедитесь, что новый сертификат был зарегистрирован с целью проверки подлинности сервера.

## <a name="configure-the-dns-server"></a><a name="ConfigDNS"></a>Настройка DNS-сервера
Необходимо вручную настроить запись DNS для веб-сайта сервера сетевых расположений внутренней сети в вашем развертывании.

### <a name="to-create-the-network-location-server-and-web-probe-dns-records"></a><a name="NLS_DNS"></a>Создание сервера сетевых расположений DNS-записей веб-пробы

1.  На DNS-сервере внутренней сети: на **начальном** экране введите * * днсмгмт. msc * * и нажмите клавишу ВВОД.

2.  В левой области консоли **Диспетчер DNS** разверните зону прямого просмотра для вашего домена. Щелкните правой кнопкой мыши по домену и выберите **Новый узел (A или AAAA)**.

3.  В диалоговом окне **Новый узел** в поле **Имя (если не указано, используется родительский домен)** укажите имя DNS для веб-сайта сервера сетевых расположений (это имя используется клиентами DirectAccess для подключения к серверу сетевых расположений). В поле **IP-адрес** укажите IPv4-адрес сервера сетевых расположений и нажмите **Добавить узел**. В диалоговом окне **DNS** щелкните **OK**.

4.  В диалоговом окне **Новый узел** в поле **Имя (если не указано, используется родительский домен)** укажите имя DNS для веб-пробы (имя веб-пробы по умолчанию: directaccess-webprobehost). В поле **IP-адрес** укажите IPv4-адрес веб-пробы и щелкните **Добавить узел**. Повторите этот процесс для имени directaccess-corpconnectivityhost и любых средств проверки подключения, созданных вручную. В диалоговом окне **DNS** щелкните **OK**.

5.  Нажмите кнопку **Готово**.

![](../../../media/Step-1-Configure-the-DirectAccess-Infrastructure_3/PowerShellLogoSmall.gif)***<em>Эквивалентные команды</em> в Windows PowerShell Windows PowerShell***

Следующие командлеты Windows PowerShell выполняют ту же функцию, что и предыдущая процедура. Вводите каждый командлет в одной строке, несмотря на то, что здесь они могут отображаться разбитыми на несколько строк из-за ограничений форматирования.

```
Add-DnsServerResourceRecordA -Name <network_location_server_name> -ZoneName <DNS_zone_name> -IPv4Address <network_location_server_IPv4_address>
Add-DnsServerResourceRecordAAAA -Name <network_location_server_name> -ZoneName <DNS_zone_name> -IPv6Address <network_location_server_IPv6_address>
```

Также следует настроить записи DNS для следующих компонентов:

-   **Сервер IP-HTTPS**— клиенты DirectAccess должны иметь возможность разрешить DNS-имя сервера удаленного доступа из Интернета.

-   **Проверка отзыва списка отзыва сертификатов**. DirectAccess использует проверку отзыва сертификатов для подключения IP-HTTPS между клиентами DirectAccess и сервером удаленного доступа, а также для подключения на основе протокола HTTPS между клиентом DirectAccess и сервером сетевого расположения. В обоих случаях у клиентов DirectAccess должна быть возможность разрешения расположения точки распространения CRL и доступа к ней.

## <a name="configure-active-directory"></a><a name="ConfigAD"></a>Настройка Active Directory
Сервер удаленного доступа и клиентские компьютеры DirectAccess должны принадлежать домену Active Directory. Клиентские компьютеры DirectAccess должны быть членом домена одного из следующих типов:

-   Домены, принадлежащие к одному лесу с сервером удаленного доступа.

-   Домены, принадлежащие к лесам, имеющим двустороннее доверие с лесом сервера удаленного доступа.

-   Домены, имеющие двустороннее доверие с доменом сервера удаленного доступа.

#### <a name="to-join-client-computers-to-the-domain"></a>Присоединение клиентских компьютеров к домену

1.  На **начальном** экране введите **explorer.exe**и нажмите клавишу ВВОД.

2.  Щелкните правой кнопкой значок компьютера и выберите **Свойства**.

3.  На странице **Система** щелкните **Дополнительные параметры системы**.

4.  В диалоговом окне **Свойства системы** на вкладке ** Имя компьютера** щелкните **Изменить**.

5.  В поле **Имя компьютера** введите имя компьютера, если вы меняете имя компьютера при присоединении сервера к домену. В разделе **Член групп** выберите **Домен** и введите имя домена, к которому нужно присоединить сервер, например corp.contoso.com, а затем нажмите **ОК**.

6.  При появлении предложения ввести имя пользователя и пароль введите имя и пароль пользователя с правами присоединения компьютеров к домену, а затем нажмите **ОК**.

7.  При появлении диалогового окна с приветствием домена нажмите кнопку **"OK"**.

8.  При появлении запроса на перезагрузку компьютера нажмите кнопку **ОК**.

9. В диалоговом окне **Свойства системы** нажмите кнопку "Закрыть". Щелкните **Перезагрузить сейчас**, когда появится сообщение о необходимости перезагрузки.

![](../../../media/Step-1-Configure-the-DirectAccess-Infrastructure_3/PowerShellLogoSmall.gif)***<em>Эквивалентные команды</em> в Windows PowerShell Windows PowerShell***

Следующие командлеты Windows PowerShell выполняют ту же функцию, что и предыдущая процедура. Вводите каждый командлет в одной строке, несмотря на то, что здесь они могут отображаться разбитыми на несколько строк из-за ограничений форматирования.

Обратите внимание, что после введения команды "Добавить компьютер" необходимо ввести учетные данные домена.

```
Add-Computer -DomainName <domain_name>
Restart-Computer
```

## <a name="configure-gpos"></a><a name="ConfigGPOs"></a>Настройка объектов групповой политики
Для развертывания удаленного доступа требуется как минимум два объекта групповая политика: один объект групповая политика содержит параметры для сервера удаленного доступа, а второй — параметры для клиентских компьютеров DirectAccess. При настройке удаленного доступа мастер автоматически создает необходимые групповая политика объекты. Однако если ваша организация применяет Соглашение об именовании или у вас нет необходимых разрешений для создания или изменения объектов групповая политика, они должны быть созданы перед настройкой удаленного доступа.

Сведения о создании групповая политика объектов см. в разделе [Создание и изменение объекта Групповая политика](/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/cc754740(v=ws.11)).

> [!IMPORTANT]
> Администратор может вручную связать объекты групповая политика DirectAccess с подразделением, выполнив следующие действия:
>
> 1.  Перед настройкой DirectAccess свяжите созданные объекты групповой политики с соответствующими подразделениями.
> 2.  Настройте DirectAccess, укажите группу безопасности для клиентских компьютеров.
> 3.  Возможно, администратор удаленного доступа не имеет разрешений на связывание объектов групповая политика с доменом. В любом из этих случаев объекты групповой политики будут настроены автоматически. Если объекты групповой политики уже привязаны к подразделению, связи не будут удалены и эти GPO не будут привязаны к домену. Для объекта групповой политики сервера подразделение должно включать объект-компьютер сервера. В противном случае объект групповой политики будет связан с корневым каналом домена.
> 4.  Если связывание с подразделением не было выполнено до запуска мастера DirectAccess, то после завершения настройки администратор домена может связать объекты групповая политика DirectAccess с требуемыми подразделениями. Связь с доменом можно удалить. Действия по связыванию объекта групповая политика с подразделением можно найти [здесь](/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/cc732979(v=ws.11)).

> [!NOTE]
> Если групповая политика объект был создан вручную, то во время настройки DirectAccess возможно, что объект групповая политика будет недоступен. Возможно, объект групповая политика не был реплицирован на ближайший контроллер домена на компьютер управления. В этом случае администратор может дождаться завершения репликации или выполнить принудительную репликацию.

## <a name="configure-security-groups"></a><a name="ConfigSGs"></a>Настройка групп безопасности
Параметры DirectAccess, содержащиеся в объекте групповая политика клиентского компьютера, применяются только к компьютерам, входящим в группы безопасности, указанные при настройке удаленного доступа. Кроме того, если вы используете группы безопасности для управления серверами приложений, необходимо создать группу безопасности для этих серверов.

### <a name="to-create-a-security-group-for-directaccess-clients"></a><a name="Sec_Group"></a>Создание группы безопасности для клиентов DirectAccess

1.  На **начальном** экране введите**DSA. msc**и нажмите клавишу ВВОД. В консоли **Active Directory — пользователи и компьютеры** разверните в левой области домен, к которому будет принадлежать группа безопасности, щелкните правой кнопкой мыши **Пользователи**, выберите **Новые**, после чего щелкните **Группа**.

2.  В диалоговом окне **Создать объект — Группа** в поле **Имя группы** укажите имя группы безопасности.

3.  Параметру **Область действия группы** присвойте значение **Глобальная**, параметру **Тип группы** — значение **Безопасность**, после чего нажмите **OK**.

4.  Дважды щелкните по группе безопасности, в которую входят компьютеры клиентов DirectAccess, и в диалоговом окне со свойствами откройте вкладку **Члены**.

5.  На вкладке **Члены группы** щелкните **Добавить**.

6.  В диалоговом окне **Выбор пользователей, контактов, компьютеров, учетных записей служб или групп** выберите клиентские компьютеры, для которых хотите установить DirectAccess, после чего щелкните **OK**.

![](../../../media/Step-1-Configure-the-DirectAccess-Infrastructure_3/PowerShellLogoSmall.gif)**Эквивалентные команды** в Windows PowerShell Windows PowerShell

Следующие командлеты Windows PowerShell выполняют ту же функцию, что и предыдущая процедура. Вводите каждый командлет в одной строке, несмотря на то, что здесь они могут отображаться разбитыми на несколько строк из-за ограничений форматирования.

```
New-ADGroup -GroupScope global -Name <DirectAccess_clients_group_name>
Add-ADGroupMember -Identity DirectAccess_clients_group_name -Members <computer_name>
```

## <a name="configure-the-network-location-server"></a><a name="ConfigNLS"></a>Настройка сервера сетевых расположений
В качестве сервера сетевых расположений должен использоваться сервер с высокой доступностью и действительным сертификатом SSL, доверенным для клиентов DirectAccess. Для сервера сетевых расположений можно использовать один из следующих типов сертификатов:

-   **Частный**. следующие обязательные условия, если они еще не существуют:

    -   Сертификат веб-сайта, используемый для сервера сетевых расположений. Субъектом этого сертификата должен быть URL-адрес сервера сетевых расположений.

    -   Точка распределения списка отзыва сертификатов полностью доступна из внутренней сети.

-   **Самозаверяющий**— следующие обязательные требования, если они еще не существуют:

    > [!NOTE]
    > Самозаверяющие сертификаты не могут использоваться в развертываниях на нескольких сайтах.

    -   Сертификат веб-сайта, используемый для сервера сетевых расположений. Субъектом этого сертификата должен быть URL-адрес сервера сетевых расположений.

> [!NOTE]
> Если в качестве сервера сетевых расположений назначен сервер удаленного доступа, веб-сайт будет создан автоматически при настройке удаленного доступа, связанного с предоставляемым вами сертификатом сервера.

#### <a name="to-install-the-network-location-server-certificate-from-an-internal-ca"></a>Установка сертификата сервера сетевых расположений из внутреннего ЦС

1.  На сервере, где будет размещаться веб-сайт сервера сетевого расположения: на **начальном** экране введите**mmc.exe**и нажмите клавишу ВВОД.

2.  В консоли MMC в меню **Файл** выберите **Добавить или удалить оснастку**.

3.  В диалоговом окне **Добавить или удалить оснастку** щелкните **Сертификаты**, после чего нажмите **Добавить**, выберите **Учетная запись компьютера**, щелкните **Далее**, нажмите **Локальный компьютер**, щелкните **Готово**, а затем — **OK**.

4.  В дереве консоли оснастки "Сертификаты" откройте раздел **Сертификаты (локальный компьютер)\Личные\Сертификаты**.

5.  Щелкните правой кнопкой **Сертификаты**, наведите указатель на элемент **Все задачи**, а затем щелкните **Запрос нового сертификата**.

6.  Щелкните дважды **Далее**.

7.  На странице **запрос сертификатов** установите флажок для шаблона сертификата и при необходимости щелкните **Дополнительные сведения для регистрации этого сертификата**.

8.  В диалоговом окне **Свойства сертификата** на вкладке **Субъект** выберите для параметра **Имя субъекта** в списке **Тип** значение**Обычное имя**.

9. В поле **Значение** укажите полное доменное имя для веб-сайта сервера сетевых расположений и щелкните **Добавить**.

10. В области **Альтернативное имя** в поле **Тип** выберите **DNS**.

11. В поле **Значение** укажите полное доменное имя для веб-сайта сервера сетевых расположений и щелкните **Добавить**.

12. На вкладке **Общие** в поле **Понятное имя** можно ввести имя, которое упростит идентификацию сертификатов.

13. Нажмите кнопку **OK**, щелкните **Зарегистрировать** и нажмите кнопку **Готово**.

14. В области сведений оснастки "Сертификаты" убедитесь, что новый сертификат был зарегистрирован с целью проверки подлинности сервера.



