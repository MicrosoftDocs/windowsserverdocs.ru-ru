---
title: Шаг 1. Настройка расширенной инфраструктуры DirectAccess
description: Эта статья является частью руководств по развертыванию одного сервера DirectAccess с дополнительными параметрами для Windows Server 2016.
manager: brianlic
ms.custom: na
ms.prod: windows-server
ms.reviewer: na
ms.suite: na
ms.technology: networking-da
ms.tgt_pltfrm: na
ms.topic: article
ms.assetid: 43abc30a-300d-4752-b845-10a6b9f32244
ms.author: pashort
author: shortpatti
ms.openlocfilehash: 30705a9aa55cdc652280c27c327cf865a47c5a11
ms.sourcegitcommit: 6aff3d88ff22ea141a6ea6572a5ad8dd6321f199
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/27/2019
ms.locfileid: "71404935"
---
# <a name="step-1-configure-advanced-directaccess-infrastructure"></a>Шаг 1. Настройка расширенной инфраструктуры DirectAccess

>Область применения: Windows Server 2012 R2, Windows Server 2012

В этом разделе описывается, как настроить инфраструктуру, необходимую для расширенного развертывания службы удаленного доступа, в котором используется один сервер DirectAccess в смешанной среде с поддержкой IPv4 и IPv6. Прежде чем приступать к развертыванию, убедитесь, что выполнены шаги по планированию, описанные в статье [планирование расширенного развертывания DirectAccess](../../../remote-access/directaccess/single-server-advanced/Plan-an-Advanced-DirectAccess-Deployment.md).  
  
|Задача|Описание|  
|----|--------|  
|1.1. Настройка сетевых параметров сервера|Настройте сетевые параметры на сервере DirectAccess.|  
|1.2. Настройка принудительного туннелирования|Настройте принудительное туннелирование.|  
|1.3. Настройка маршрутизации в корпоративной сети|Настройте маршрутизацию в корпоративной сети.|  
|1.4. Настройка брандмауэров|При необходимости настройте дополнительные брандмауэры.|  
|1.5. Настройка центров сертификации и сертификатов|Настройте центр сертификации (ЦС), если необходимо, и другие шаблоны сертификатов, требуемые для развертывания.|  
|1.6. Настройка DNS-сервера|Настройте параметры системы DNS для сервера DirectAccess.|  
|1.7. Настройка Active Directory|Присоедините клиентские компьютеры и сервер DirectAccess к домену Active Directory.|  
|1.8. Настройка объектов групповой политики|Если необходимо, настройте объекты групповой политики для развертывания.|  
|1.9. Настройка групп безопасности|Настройте группы безопасности, которые будут содержать клиентские компьютеры DirectAccess, и другие группы безопасности, необходимые для развертывания.|  
|1.10. Настройка сервера сетевых расположений|Настройте сервер сетевых расположений, в том числе установите сертификат веб-сайта сервера сетевых расположений.|  
  
> [!NOTE]  
> В этом разделе приводятся примеры командлетов Windows PowerShell, которые можно использовать для автоматизации некоторых описанных процедур. Дополнительные сведения см. в разделе [Командлеты](https://go.microsoft.com/fwlink/p/?linkid=230693).  
  
## <a name="ConfigNetworkSettings"></a>1,1. Настройка параметров сети сервера  
Для развертывания с одним сервером в среде, использующей IPv4 и IPv6, необходимо настроить следующие параметры сетевого интерфейса. Для настройки всех IP-адресов используется пункт **Изменение параметров адаптера** в разделе **Центр управления сетями и общим доступом Windows**.  
  
**Топология пограничных устройств**  
  
-   Два последовательных общедоступных статичных IPv4- или IPv6-адреса, доступных из Интернета  
  
    > [!NOTE]  
    > Для Teredo необходимы два общедоступных адреса. Если вы не используете Teredo, вы можете настроить один общедоступный статичный IPv4-адрес.  
  
-   Один внутренний статичный IPv4- или IPv6-адрес  
  
**За устройством NAT (с двумя сетевыми адаптерами)**  
  
-   Один статичный IPv4- или IPv6-адрес, доступный из интернета  
  
-   Один внутренний статичный IPv4- или IPv6-адрес, доступный из внутренней сети  
  
**За устройством NAT (с одним сетевым адаптером)**  
  
-   Один внутренний статичный IPv4- или IPv6-адрес, доступный из внутренней сети  
  
> [!NOTE]  
> Если сервер DirectAccess с двумя или несколькими сетевыми адаптерами (один определен в профиле домена, а другой — в общедоступном или частном профиле) настроен с топологией с одним сетевым адаптером, мы рекомендуем выполнить следующие действия.  
>   
> -   Убедитесь, что второй сетевой адаптер и все дополнительные адаптеры определены в профиле домена.  
> -   Если второй сетевой адаптер не может быть настроен для профиля домена, политика IPsec DirectAccess должна быть задана вручную для всех профилей с помощью следующей команды Windows PowerShell после настройки DirectAccess:  
>   
>     ```  
>     $gposession = Open-NetGPO "PolicyStore <Name of the server GPO>  
>     Set-NetIPsecRule "DisplayName <Name of the IPsec policy> "GPOSession $gposession "Profile Any  
>     Save-NetGPO "GPOSession $gposession  
>     ```  
  
## <a name="BKMK_forcetunnel"></a>1,2. Настройка принудительного туннелирования  
Принудительное туннелирование можно настроить с помощью мастера настройки удаленного доступа. Соответствующий параметр доступен в виде флажка в мастере настройки удаленных клиентов. Данный параметр влияет только на клиенты DirectAccess. Если VPN включено, VPN-клиенты будут по умолчанию использовать принудительное туннелирование. Администраторы могут изменить этот параметр для VPN-клиентов из профиля клиента.  
  
Если установить флажок принудительного туннелирования, происходит следующее:  
  
-   Включается принудительное туннелирование для клиентов DirectAccess.  
  
-   Запись **Any** добавляется в таблицу политик разрешения имен (NRPT) для клиентов DirectAccess, т. е. весь трафик DNS будет попадать на DNS-серверы внутренней сети.  
  
-   Клиенты DirectAccess настраиваются для постоянного использования технологии туннелирования IP-HTTPS.  
  
Чтобы интернет-ресурсы были доступными для клиентов DirectAccess, которые используют принудительное туннелирование, можно воспользоваться прокси-сервером, который может принимать IPv6-запросы для интернет-ресурсов и преобразовывать их в запросы для интернет-ресурсов с IPv4-адресацией. Чтобы настроить прокси-сервер для интернет-ресурсов, следует изменить запись по умолчанию в таблице NRPT и добавить прокси-сервер. Это можно сделать с помощью командлетов удаленного доступа или DNS модуля PowerShell. Например, используйте командлет удаленного доступа PowerShell следующим образом:  
  
```  
Set-DAClientDNSConfiguration "DNSSuffix "." "ProxyServer <Name of the proxy server:port>  
```  
  
> [!NOTE]  
> Если DirectAccess и VPN включены на одном сервере и VPN находится в режиме принудительного туннелирования, а сервер развернут в пограничной топологии или за устройством NAT (с двумя сетевыми адаптерами, один из которых подключен к домену, а другой — к частной сети), интернет-трафик VPN не может пересылаться через внешний интерфейс сервера DirectAccess. Для реализации такого сценария организациям следует развернуть службу удаленного доступа на сервере за брандмауэром в топологии с одним сетевым адаптером. Или же организации могут использовать отдельный прокси-сервер во внутренней сети, чтобы пересылать интернет-трафик от VPN-клиентов.  
  
> [!NOTE]  
> Если организация использует веб-прокси для клиентов DirectAccess, чтобы получать доступ к интернет-ресурсам, а корпоративный прокси-сервер не может обрабатывать ресурсы внутренней сети, клиенты DirectAccess не смогут получить доступ к внутренним ресурсам, если они находятся за пределами интрасети. Чтобы позволить клиентам DirectAccess получать доступ к внутренним ресурсам в таком сценарии, вручную создайте записи NRPT для суффиксов внутренней сети, используя страницу "DNS" мастера настройки инфраструктуры. Не применяйте параметры прокси-сервера для этих суффиксов NRPT. Суффиксы следует заполнить записями DNS-сервера по умолчанию.  
  
## <a name="ConfigRouting"></a>1,3. Настройка маршрутизации в корпоративной сети  
Настройте маршрутизацию в корпоративной сети следующим образом.  
  
-   Если в организации используется сеть со встроенной поддержкой IPv6, добавьте маршрут, чтобы маршрутизаторы во внутренней сети направляли IPv6-трафик через сервер DirectAccess.  
  
-   Вручную настройте маршруты IPv4 и IPv6 организации на серверах DirectAccess. Добавьте опубликованный маршрут, чтобы весь трафик с префиксом IPv6 организации (/48) пересылался во внутреннюю сеть Для IPv4-трафика добавьте явные маршруты, чтобы пересылать его во внутреннюю сеть.  
  
## <a name="ConfigFirewalls"></a>1,4. Настройка брандмауэров  
Если вы используете при развертывании дополнительные брандмауэры, примените следующие исключения брандмауэра для трафика удаленного доступа при выходе в Интернет, когда сервер DirectAccess находится в сети IPv4:  
  
-   Исходящий трафик Teredo-порта назначения UDP-порт 3544 для входящего трафика и исходный UDP-порт 3544.  
  
-   трафик 6to4 "IP-протокол 41, входящий и исходящий.  
  
-   IP-HTTPS — порт назначения протокола TCP 443 и исходный порт TCP 443 исходящие. Если на сервере DirectAccess один сетевой адаптер, а сервер сетевых расположений находится на сервере DirectAccess, также требуется TCP-порт 62000.  
  
    > [!NOTE]  
    > Это исключение должно быть настроено на сервере DirectAccess, в то время как настройка всех остальных исключений осуществляется на пограничном брандмауэре.  
  
> [!NOTE]  
> В отношении трафика Teredo и 6to4 эти исключения должны применяться для обоих последовательных общедоступных IPv4-адресов для выхода в Интернет на сервере DirectAccess. Для IP-HTTPS исключения необходимо применять только к тому адресу, которому соответствует общедоступное имя сервера.  
  
Если вы используете дополнительные брандмауэры, примените следующие исключения брандмауэра для трафика удаленного доступа при выходе в Интернет, когда сервер DirectAccess находится в сети IPv6:  
  
-   Протокол IP 50  
  
-   UDP-порт назначения 500 для входящих подключений и UDP-порт источника 500 для исходящих подключений.  
  
-   Протокол обмена сообщениями Интернета для входящего и исходящего трафика IPv6 (ICMPv6) — только для реализаций Teredo.  
  
При использовании дополнительных брандмауэров применяйте следующие исключения внутреннего сетевого брандмауэра для трафика удаленного доступа:  
  
-   ISATAP "протокол 41, входящий и исходящий  
  
-   Протоколы TCP/UDP для всех типов трафика IPv4/IPv6  
  
-   Протокол ICMP для всех типов трафика IPv4/IPv6  
  
## <a name="ConfigCAs"></a>1,5. Настройка центров сертификации и сертификатов  
Удаленный доступ в Windows Server 2012 позволяет выбрать использование сертификатов для проверки подлинности компьютера или использовать встроенный прокси-сервер Kerberos, который выполняет проверку подлинности с помощью имен пользователей и паролей. Также необходимо настроить сертификат IP-HTTPS на сервере DirectAccess.  
  
Дополнительные сведения см. в статье [Active Directory Certificate Services](https://technet.microsoft.com/library/cc770357.aspx).  
  
### <a name="151-configure-ipsec-authentication"></a>1.5.1. Настройка проверки подлинности IPsec  
Для использования проверки подлинности IPsec необходимо установить сертификат компьютера на сервере DirectAccess и на всех клиентах DirectAccess. Сертификат должен быть выдан внутренним центром сертификации (ЦС), а серверы и клиенты DirectAccess должны доверять цепочке ЦС, который выдает корневой и промежуточные сертификаты.  
  
##### <a name="to-configure-ipsec-authentication"></a>Настройка проверки подлинности IPsec  
  
1.  Во внутреннем ЦС решите, будет ли использоваться шаблон сертификата **компьютера** , или, если вы создадите новый шаблон сертификата, как описано в разделе [Создание шаблонов сертификатов](https://technet.microsoft.com/library/cc731705.aspx).  
  
    > [!NOTE]  
    > Если вы создаете новый шаблон, для него необходимо настроить клиентскую проверку подлинности.  
  
2.  Если необходимо, разверните шаблон сертификата. Дополнительные сведения см. в разделе [Развертывание шаблонов сертификатов](https://technet.microsoft.com/library/cc770794.aspx).  
  
3.  Если необходимо, настройте для шаблона сертификата автоматическую регистрацию. Дополнительные сведения см. в статье [Настройка автоматической регистрации сертификатов](https://technet.microsoft.com/library/cc731522.aspx).  
  
### <a name="ConfigCertTemp"></a>1.5.2. Настройка шаблонов сертификатов  
Если для выдачи сертификатов используется внутренний ЦС, необходимо настроить шаблон для сертификата IP-HTTPS и сертификата веб-сайта сервера сетевых расположений.  
  
##### <a name="to-configure-a-certificate-template"></a>Настройка шаблона сертификата  
  
1.  В внутреннем ЦС создайте шаблон сертификата, как описано в разделе [Создание шаблонов сертификатов](https://technet.microsoft.com/library/cc731705.aspx).  
  
2.  Разверните шаблон сертификата, как описано в разделе [Развертывание шаблонов сертификатов](https://technet.microsoft.com/library/cc770794.aspx).  
  
### <a name="153-configure-the-ip-https-certificate"></a>1.5.3. Настройка сертификата IP-HTTPS  
Для проверки подлинности подключений IP-HTTPS на сервере DirectAccess службе удаленного доступа требуется сертификат IP-HTTPS. Для проверки подлинности IP-HTTPS доступно три вида сертификатов.  
  
**Общедоступный сертификат**  
  
Общедоступный сертификат предоставляется сторонним поставщиком. Если имя субъекта сертификата не содержит подстановочные знаки, это должен быть URL-адрес с полным доменным именем и возможностью внешнего разрешения, используемый только для подключений IP-HTTPS сервера DirectAccess.  
  
**Частный сертификат**  
  
Если вы используете частный сертификат, необходимы следующие компоненты (если они не существуют):  
  
-   Сертификат веб-сайта, используемый для проверки подлинности IP-HTTPS. Субъектом сертификата должно быть полное доменное имя с возможностью внешнего разрешения, доступное из Интернета. Сертификат основан на созданном вами шаблоне сертификата, следуя инструкциям в разделе 1.5.2 configure Certificate Templates.  
  
-   Точка распространения списка отзыва сертификатов (CRL), доступная через Интернет.  
  
**Самозаверяющий сертификат**  
  
Если вы используете самозаверяющий сертификат, необходимы следующие компоненты (если они не существуют):  
  
-   Сертификат веб-сайта, используемый для проверки подлинности IP-HTTPS. Субъектом сертификата должно быть полное доменное имя с возможностью внешнего разрешения, доступное из Интернета.  
  
-   Точка распространения списка отзыва сертификатов (CRL), доступная через Интернет.  
  
> [!NOTE]  
> Самозаверяющие сертификаты не могут использоваться в развертываниях на нескольких сайтах.  
  
Убедитесь, что сертификат веб-сайта, используемый для проверки подлинности IP-HTTPS, отвечает следующим требованиям.  
  
-   Общее имя сертификата должно совпадать с именем узла IP-HTTPS.  
  
-   В поле **Тема** укажите полное доменное имя URL-адреса IP-HTTPS.  
  
-   В поле **Улучшенное использование ключа** введите идентификатор объекта проверки подлинности сервера (OID).  
  
-   В поле **Точки распространения CRL** укажите точку распространения CRL, доступную клиентам DirectAccess, подключенным к Интернету.  
  
-   У сертификата IP-HTTPS должен быть закрытый ключ.  
  
-   Сертификат IP-HTTPS необходимо импортировать непосредственно в личное хранилище сертификатов.  
  
-   В имени сертификатов IP-HTTPS может быть постановочный знак.  
  
##### <a name="to-install-the-ip-https-certificate-from-an-internal-ca"></a>Установка сертификата IP-HTTPS из внутреннего ЦС  
  
1.  На сервере DirectAccess: на **начальном** экране введите**MMC. exe**и нажмите клавишу ВВОД.  
  
2.  В консоли MMC в меню **Файл** выберите пункт **Добавить или удалить оснастку**.  
  
3.  В диалоговом окне **Добавление или удаление оснасток** щелкните **Сертификаты**, нажмите кнопку **Добавить**, выберите **Учетная запись компьютера**, нажмите кнопку **Далее**, щелкните **Локальный компьютер** и последовательно нажмите кнопки **Готово** и **ОК**.  
  
4.  В дереве консоли оснастки "Сертификаты" откройте раздел **Сертификаты (локальный компьютер)\Личные\Сертификаты**.  
  
5.  Щелкните правой кнопкой **Сертификаты**, наведите указатель на элемент **Все задачи**, а затем щелкните **Запрос нового сертификата**.  
  
6.  Щелкните дважды **Далее** .  
  
7.  На странице **запрос сертификатов** установите флажок для созданного ранее шаблона сертификата (Дополнительные сведения см. в разделе 1.5.2 configure Certificate Templates). При необходимости щелкните **Требуется больше данных для регистрации этого сертификата**.  
  
8.  В диалоговом окне **Свойства сертификата** на вкладке **Субъект** в области **Имя субъекта** в поле **Тип** выберите **Общее имя**.  
  
9. В поле **Значение** укажите IPv4-адрес внешнего сетевого адаптера сервера DirectAccess или полное доменное имя URL-адреса IP-HTTPS, а затем нажмите кнопку **Добавить**.  
  
10. В области **Альтернативное имя** в поле **Тип** выберите **DNS**.  
  
11. В поле **Значение** укажите IPv4-адрес внешнего сетевого адаптера сервера DirectAccess или полное доменное имя URL-адреса IP-HTTPS, а затем нажмите кнопку **Добавить**.  
  
12. На вкладке **Общие** в поле **Понятное имя** можно ввести имя, которое упростит идентификацию сертификатов.  
  
13. На вкладке **Расширения** щелкните стрелку рядом с элементом **Расширенное использование ключа** и убедитесь, что элемент **Проверка подлинности сервера** есть в списке **Выбранные параметры**.  
  
14. Нажмите кнопку **OK**, щелкните **Зарегистрировать** и нажмите кнопку **Готово**.  
  
15. В области сведений оснастки "Сертификаты" убедитесь, что новый сертификат был зарегистрирован с целью проверки подлинности сервера.  
  
## <a name="ConfigDNS"></a>1,6. Настройка DNS-сервера  
Необходимо вручную настроить запись DNS для веб-сайта сервера сетевых расположений внутренней сети в вашем развертывании.  
  
### <a name="NLS_DNS"></a>Создание сервера сетевого расположения  
  
1.  На DNS-сервере внутренней сети: на **начальном** экране введите**днсмгмт. msc**и нажмите клавишу ВВОД.  
  
2.  В левой области консоли **Диспетчер DNS** разверните зону прямого просмотра для вашего домена. Щелкните домен правой кнопкой и выберите **Новый узел (A или AAAA)** .  
  
3.  В диалоговом окне **Новый узел** в поле **IP-адрес**:  
  
    -   В поле **Имя (если оставить пустым, будет использован родительский домен)** введите DNS-имя для веб-сайта сервера сетевых расположений (это имя клиенты DirectAccess могут использовать для подключения к серверу сетевых расположений).  
  
    -   Введите IPv4- или IPv6-адрес сервера сетевых расположений, нажмите кнопку **Добавить узел** и нажмите **ОК**.  
  
4.  В диалоговом окне **Новый узел**:  
  
    -   В поле **Имя (если оставить пустым, будет использован родительский домен)** введите DNS-имя для веб-пробы (имя веб-пробы по умолчанию — **directaccess-webprobehost**).  
  
    -   В поле **IP-адрес** введите IPv4- или IPv6-адрес веб-пробы и нажмите кнопку **Добавить узел**.  
  
    -   Повторите этот процесс для **directaccess-corpconnectivityhost** и вручную созданных средств проверки.  
  
5.  В диалоговом окне **DNS** нажмите кнопку **ОК**, а затем — **Готово**.  
  
![](../../../media/Step-1-Configuring-DirectAccess-Infrastructure/PowerShellLogoSmall.gif)***<em>эквивалентных команд Windows PowerShell Windows PowerShell</em>***  
  
Следующие командлеты Windows PowerShell выполняют ту же функцию, что и предыдущая процедура. Вводите каждый командлет в одной строке, несмотря на то, что здесь они могут отображаться разбитыми на несколько строк из-за ограничений форматирования.  
  
```  
Add-DnsServerResourceRecordA -Name <network_location_server_name> -ZoneName <DNS_zone_name> -IPv4Address <network_location_server_IPv4_address>  
Add-DnsServerResourceRecordAAAA -Name <network_location_server_name> -ZoneName <DNS_zone_name> -IPv6Address <network_location_server_IPv6_address>  
```  
  
Также следует настроить записи DNS для следующих компонентов:  
  
-   **Сервер IP-HTTPS**  
  
    У клиентов DirectAccess должна быть возможность разрешения DNS-имени сервера DirectAccess из Интернета.  
  
-   **Проверка отзыва CRL**  
  
    DirectAccess использует проверку отзыва сертификатов для подключения IP-HTTPS между клиентами DirectAccess и сервером DirectAccess, а также для HTTPS-подключений между клиентом DirectAccess и сервером сетевых расположений. В обоих случаях у клиентов DirectAccess должна быть возможность разрешения расположения точки распространения CRL и доступа к ней.  
  
-   **СВЯЗИ**  
  
    Протокол ISATAP использует туннелирование, чтобы позволить клиентам DirectAccess подключаться к серверу DirectAccess по IPv4-интернету, инкапсулируя пакеты IPv6 в заголовке IPv4. Служба удаленного доступа использует ISATAP для установки IPv6-подключений к узлам ISATAP в интрасети. В сетевой среде без встроенной поддержки IPv6 сервер DirectAccess автоматически настраивается как маршрутизатор ISATAP. Требуется поддержка разрешения имени ISATAP.  
  
## <a name="ConfigAD"></a>1,7. Настройка Active Directory  
Сервер DirectAccess и все клиентские компьютеры DirectAccess должны быть присоединены к домену Active Directory. Клиентские компьютеры DirectAccess должны быть членом домена одного из следующих типов:  
  
-   домена в том же лесу, что и сервер DirectAccess;  
  
-   домены в лесах с двусторонним отношением доверия с лесом сервера DirectAccess;  
  
-   домену с двусторонним отношением доверия с доменом сервера DirectAccess.  
  
#### <a name="to-join-the-directaccess-server-to-a-domain"></a>Присоединение сервера DirectAccess к домену  
  
1.  В диспетчере серверов щелкните **Локальный сервер**. В области сведений перейдите по ссылке **Имя компьютера**.  
  
2.  В диалоговом окне **Свойства системы** щелкните **Имя компьютера** , а затем **Изменить**.  
  
3.  В поле **Имя компьютера**введите имя компьютера, если вы меняете имя компьютера при присоединении сервера к домену. В разделе **Член групп** выберите **Домен** и введите имя домена, к которому нужно присоединить сервер, например corp.contoso.com, а затем нажмите **ОК**.  
  
4.  При появлении предложения ввести имя пользователя и пароль введите имя и пароль пользователя с правами присоединения компьютеров к домену, а затем нажмите **ОК**.  
  
5.  При появлении диалогового окна с приветствием домена нажмите кнопку **ОК**.  
  
6.  При появлении запроса на перезагрузку компьютера нажмите кнопку **ОК**.  
  
7.  В диалоговом окне **Свойства системы** нажмите кнопку **Закрыть**.  
  
8.  При появлении запроса на перезагрузку компьютера нажмите кнопку **Перезагрузить сейчас**.  
  
#### <a name="to-join-client-computers-to-the-domain"></a>Присоединение клиентских компьютеров к домену  
  
1.  На **начальном** экране введите**Explorer. exe**и нажмите клавишу ВВОД.  
  
2.  Щелкните правой кнопкой значок компьютера и выберите **Свойства**.  
  
3.  На странице **Система** щелкните **Дополнительные параметры системы**.  
  
4.  В диалоговом окне **Свойства системы** на вкладке **Имя компьютера** щелкните **Изменить**.  
  
5.  В поле **Имя компьютера** введите имя компьютера, если вы меняете имя компьютера при присоединении сервера к домену. В разделе **Член групп** выберите **Домен** и введите имя домена, к которому нужно присоединить сервер, например corp.contoso.com, а затем нажмите **ОК**.  
  
6.  При появлении предложения ввести имя пользователя и пароль введите имя и пароль пользователя с правами присоединения компьютеров к домену, а затем нажмите **ОК**.  
  
7.  При появлении диалогового окна с приветствием домена нажмите кнопку **ОК**.  
  
8.  При появлении запроса на перезагрузку компьютера нажмите кнопку **ОК**.  
  
9. В диалоговом окне **Свойства системы** нажмите кнопку **Закрыть**.  
  
10. При появлении запроса на перезагрузку компьютера нажмите кнопку **Перезагрузить сейчас**.  
  
![](../../../media/Step-1-Configuring-DirectAccess-Infrastructure/PowerShellLogoSmall.gif)***<em>эквивалентных команд Windows PowerShell Windows PowerShell</em>***  
  
Следующие командлеты Windows PowerShell выполняют ту же функцию, что и предыдущая процедура. Вводите каждый командлет в одной строке, несмотря на то, что здесь они могут отображаться разбитыми на несколько строк из-за ограничений форматирования.  
  
> [!NOTE]  
> При вводе следующей команды **Add-Computer** следует указать учетные данные домена.  
  
```  
Add-Computer -DomainName <domain_name>  
Restart-Computer  
```  
  
## <a name="ConfigGPOs"></a>1,8. Настройка объектов групповой политики  
Для развертывания удаленного доступа требуется не менее двух групповая политика объектов:  
  
-   один содержит параметры для сервера DirectAccess;  
  
-   другой содержит параметры для клиентских компьютеров DirectAccess.  
  
При настройке удаленного доступа мастер автоматически создает необходимые групповая политика объекты. Но если организация принудительно применяет соглашение об именовании, вы можете ввести имя в диалоговом окне "Объект групповой политики" в консоли управления удаленным доступом. Дополнительные сведения см. в статье 2,7. Сводка по конфигурации и альтернативные объекты GPO. Если у вас есть разрешения на создание, будет создан GPO. Если у вас нет требуемых разрешений для создания GPO, их необходимо настроить до настройки службы удаленного доступа.  
  
Сведения о создании групповая политика объектов см. в разделе [Создание и изменение объекта Групповая политика](https://technet.microsoft.com/library/cc754740.aspx).  
  
> [!IMPORTANT]  
> Администраторы могут вручную связать объекты групповая политика DirectAccess с подразделением (OU), выполнив следующие действия.  
>   
> 1.  Перед настройкой DirectAccess свяжите созданные GPO с соответствующими подразделениями.  
> 2.  Во время настройки DirectAccess укажите группу безопасности для клиентских компьютеров.  
> 3.  Возможно, администратор удаленного доступа не имеет разрешений на связывание объектов групповая политика с доменом. В любом из этих случаев объекты групповой политики будут настроены автоматически. Если объекты групповой политики уже привязаны к подразделению, связи не будут удалены и эти GPO не будут привязаны к домену. Для объекта групповой политики сервера подразделение должно включать объект-компьютер сервера. В противном случае объект групповой политики будет связан с корневым каналом домена.  
> 4.  Если вы не создали связь с подразделением до запуска мастера DirectAccess, то после завершения настройки администратор домена сможет связать объекты групповая политика DirectAccess с требуемыми подразделениями. Связь с доменом можно удалить. Дополнительные сведения см. [в разделе Связывание объекта Групповая политика](https://technet.microsoft.com/library/cc732979.aspx).  
  
> [!NOTE]  
> Если групповая политика объект был создан вручную, возможно, групповая политика объект будет недоступен во время настройки DirectAccess. Возможно, объект групповая политика не был реплицирован на ближайший контроллер домена на компьютер управления. В этом случае администратор может дождаться завершения репликации или выполнить принудительную репликацию.  
  
### <a name="181-configure-remote-access-gpos-with-limited-permissions"></a>1.8.1. Настройка объектов групповой политики удаленного доступа с ограниченными разрешениями  
В развертывании с использованием промежуточных и производственных объектов групповой политики администратор домена должен выполнить следующие действия.  
  
1.  Получить список GPO, необходимых для развертывания службы удаленного доступа, у администратора удаленного доступа. Дополнительные сведения см. в разделе 1,8 Plan групповая политика Objects.  
  
2.  Для каждого GPO, запрошенного администратором удаленного доступа, создайте пару GPO с разными именами. Первый из них будет использовать как промежуточный GPO, а второй — как производственный.  
  
    Сведения о создании групповая политика объектов см. в разделе [Создание и изменение объекта Групповая политика](https://technet.microsoft.com/library/cc754740.aspx).  
  
3.  Сведения о связывании производственных объектов групповой политики см. в разделе [связывание объекта Групповая политика](https://technet.microsoft.com/library/cc732979).  
  
4.  Предоставьте администратору удаленного доступа разрешение **Изменение параметров, удаление и изменение разрешений безопасности** для всех промежуточных GPO. Дополнительные информантион см. в разделе [Делегирование разрешений для группы или пользователя на объекте Групповая политика](https://technet.microsoft.com/library/cc754542).  
  
5.  Запретите администратору удаленного доступа связывание объектов групповой политики во всех доменах (или убедитесь, что администратор удаленного доступа не имеет таких разрешений). Дополнительные сведения см. [в разделе Делегирование разрешений для связывания объектов Групповая политика](https://technet.microsoft.com/library/cc755086).  
  
Когда администраторы удаленного доступа настраивают службу удаленного доступа, они всегда должны указывать только промежуточные GPO (а не производственные). Это справедливо для начальной настройки удаленного доступа и для выполнения дополнительных операций настройки, для которых требуются дополнительные GPO, например при добавлении точек входа в развертывание на нескольких сайтах или активации клиентских компьютеров в дополнительных доменах.  
  
После внесения изменений в конфигурацию удаленного доступа администратором удаленного доступа администратор домена должен проверить настройки в промежуточных GPO и скопировать их в производственные GPO с помощью следующей процедуры.  
  
> [!TIP]  
> Выполните следующую процедуру после каждого изменения конфигурации удаленного доступа.  
  
##### <a name="to-copy-settings-to-the-production-gpos"></a>Копирование параметров в производственные объекты групповой политики  
  
1.  Убедитесь, что все промежуточные GPO в развертывании службы удаленного доступа были реплицированы во все контроллеры домена в используемом домене. Это необходимо для импорта последней конфигурации в производственные GPO. Дополнительные сведения см. в разделе Проверка состояния инфраструктуры групповая политика.  
  
2.  Экспортируйте параметры, создав резервную копию всех промежуточных GPO в развертывании удаленного доступа. Дополнительные сведения см. в разделе Создание резервной копии объекта групповая политика.  
  
3.  Для каждого производственного GPO измените фильтры безопасности в соответствии с фильтрами соответствующего промежуточного GPO. Дополнительные сведения см. в разделе Фильтрация с использованием групп безопасности.  
  
    > [!NOTE]  
    > Это необходимо, потому что команда **Импорт параметров** не копирует фильтр безопасности исходного GPO.  
  
4.  Для каждого производственного GPO импортируйте параметры из резервной копии соответствующего промежуточного GPO следующим образом:  
  
    1.  В консоль управления групповыми политиками (GPMC) разверните узел объекты групповая политика в лесу и домене, который содержит объект рабочего групповая политика, в который будут импортированы параметры.  
  
    2.  Щелкните правой кнопкой GPO и выберите команду **Импорт параметров**.  
  
    3.  В **мастере импорта параметров** на странице **приветствия** нажмите кнопку **Далее**.  
  
    4.  На странице **Архивирование объекта групповой политики** нажмите кнопку **Резервное копирование**.  
  
    5.  В диалоговом окне **Архивация объекта групповой политики** в поле **Расположение** введите путь расположения, где будут сохранены резервные копии GPO, или нажмите кнопку **Обзор**, чтобы выбрать папку.  
  
    6.  В поле **Описание** введите описание производственного GPO и нажмите кнопку **Резервное копирование**.  
  
    7.  После завершения резервного копирования нажмите кнопку **ОК**, а затем на странице **Архивирование объекта групповой политики** нажмите **Далее**.  
  
    8.  На странице **Расположение архива** в поле **Папка архива** введите путь, в которой была сохранена резервная копия соответствующего промежуточного GPO на шаге 2, или нажмите кнопку **Обзор**, выберите папку и нажмите **Далее**.  
  
    9. На странице **Исходный объект GPO** установите флажок **Показывать только последние версии объекта групповой политики**, чтобы скрыть старые резервные копии, и выберите соответствующий промежуточный GPO. Нажмите кнопку **Просмотр параметров**, чтобы просмотреть параметры удаленного доступа перед их применением к производственному GPO, а затем нажмите кнопку **Далее**.  
  
    10. На странице **Проверка архива** нажмите кнопку **Далее**, а затем кнопку **Готово**.  
  
![](../../../media/Step-1-Configuring-DirectAccess-Infrastructure/PowerShellLogoSmall.gif)***<em>эквивалентных команд Windows PowerShell Windows PowerShell</em>***  
  
Следующие командлеты Windows PowerShell выполняют ту же функцию, что и предыдущая процедура. Вводите каждый командлет в одной строке, несмотря на то, что здесь они могут отображаться разбитыми на несколько строк из-за ограничений форматирования.  
  
-   Чтобы создать резервную копию GPO промежуточного клиента "Параметры клиента DirectAccess — промежуточное хранение" в домене "corp.contoso.com" в папку резервного копирования "К:\баккупс\":  
  
    ```  
    $backup = Backup-GPO "Name 'DirectAccess Client Settings - Staging' "Domain 'corp.contoso.com' "Path 'C:\Backups\'  
    ```  
  
-   Чтобы просмотреть фильтр безопасности объекта групповой политики промежуточного клиента "Параметры клиента DirectAccess — промежуточное хранение" в домене "corp.contoso.com":  
  
    ```  
    Get-GPPermission "Name 'DirectAccess Client Settings - Staging' "Domain 'corp.contoso.com' "All | ?{ $_.Permission "eq 'GpoApply'}  
    ```  
  
-   Добавление группы безопасности "Corp. contoso. Ком\директакцесс Clients" в фильтр безопасности объекта групповой политики "Параметры клиента DirectAccess" Production "в домене" corp.contoso.com ":  
  
    ```  
    Set-GPPermission "Name 'DirectAccess Client Settings - Production' "Domain 'corp.contoso.com' "PermissionLevel GpoApply "TargetName 'corp.contoso.com\DirectAccess clients' "TargetType Group  
    ```  
  
-   Импорт параметров из резервной копии в объект групповой политики "Параметры клиента DirectAccess" рабочей среды в домене "corp.contoso.com":  
  
    ```  
    Import-GPO "BackupId $backup.Id "Path $backup.BackupDirectory "TargetName 'DirectAccess Client Settings - Production' "Domain 'corp.contoso.com'  
    ```  
  
## <a name="ConfigSGs"></a>1,9. Настройка групп безопасности  
Параметры DirectAccess, содержащиеся в объекте групповая политика клиентского компьютера, применяются только к компьютерам, входящим в группы безопасности, указанные при настройке удаленного доступа. Кроме того, если вы используете группы безопасности для управления серверами приложений, необходимо создать группу безопасности для этих серверов.  
  
### <a name="Sec_Group"></a>Создание группы безопасности для клиентов DirectAccess  
  
1.  На **начальном** экране введите**DSA. msc**и нажмите клавишу ВВОД. В консоли **Active Directory — пользователи и компьютеры** разверните в левой области домен, к которому будет принадлежать группа безопасности, щелкните правой кнопкой мыши **Пользователи**, выберите **Новые**, после чего щелкните **Группа**.  
  
2.  В диалоговом окне **Создание объекта — группа** в поле **Имя группы** введите имя группы безопасности.  
  
3.  В разделе **Область группы** щелкните **Глобальная**, а в разделе **Тип группы** щелкните **Безопасность** и нажмите кнопку **ОК**.  
  
4.  Дважды щелкните группу безопасности клиентских компьютеров DirectAccess и в диалоговом окне свойств откройте вкладку **Члены**.  
  
5.  На вкладке **Члены группы** щелкните **Добавить**.  
  
6.  В диалоговом окне **Выбор пользователей, контактов, компьютеров или учетных записей служб** выберите клиентские компьютеры, которые необходимо активировать для DirectAccess, а затем нажмите кнопку **ОК**.  
  
![](../../../media/Step-1-Configuring-DirectAccess-Infrastructure/PowerShellLogoSmall.gif)**эквивалентных команд Windows PowerShell Windows PowerShell**  
  
Следующие командлеты Windows PowerShell выполняют ту же функцию, что и предыдущая процедура. Вводите каждый командлет в одной строке, несмотря на то, что здесь они могут отображаться разбитыми на несколько строк из-за ограничений форматирования.  
  
```  
New-ADGroup -GroupScope global -Name <DirectAccess_clients_group_name>  
Add-ADGroupMember -Identity DirectAccess_clients_group_name -Members <computer_name>  
```  
  
## <a name="ConfigNLS"></a>1,10. Настройка сервера сетевых расположений  
Сервер сетевых расположений должен обладать высоким уровнем доступности и действительным SSL-сертификатом, которому доверяют клиенты DirectAccess. Для сервера сетевых расположений можно использовать один из следующих типов сертификатов:  
  
-   **Частный сертификат**  
  
    Этот сертификат основан на созданном вами шаблоне сертификата. для этого следуйте инструкциям в разделе [1.5.2 Настройка шаблонов сертификатов](#ConfigCertTemp).  
  
-   **Самозаверяющий сертификат**  
  
    > [!NOTE]  
    > Самозаверяющие сертификаты не могут использоваться в развертываниях на нескольких сайтах.  
  
Для каждого типа сертификата требуется создать следующие элементы, если они еще не существуют:  
  
-   Сертификат веб-сайта, используемый для сервера сетевых расположений. Субъектом этого сертификата должен быть URL-адрес сервера сетевых расположений.  
  
-   Точка распространения CRL с высоким уровнем доступности из внутренней сети.  
  
> [!NOTE]  
> Если веб-сайт сервера сетевых расположений находится на сервере DirectAccess, веб-сайт создается автоматически при настройке удаленного доступа. Сайт привязан к указанному сертификату сервера.  
  
#### <a name="to-install-the-network-location-server-certificate-from-an-internal-ca"></a>Установка сертификата сервера сетевых расположений из внутреннего ЦС  
  
1.  На сервере, где будет размещаться веб-сайт сервера сетевого расположения: на **начальном** экране введите**MMC. exe**и нажмите клавишу ВВОД.  
  
2.  В консоли MMC в меню **Файл** выберите пункт **Добавить или удалить оснастку**.  
  
3.  В диалоговом окне **Добавление или удаление оснасток** щелкните **Сертификаты**, нажмите кнопку **Добавить**, выберите **Учетная запись компьютера**, нажмите кнопку **Далее**, щелкните **Локальный компьютер** и последовательно нажмите кнопки **Готово** и **ОК**.  
  
4.  В дереве консоли оснастки "Сертификаты" откройте раздел **Сертификаты (локальный компьютер)\Личные\Сертификаты**.  
  
5.  Щелкните правой кнопкой **Сертификаты**, наведите указатель на элемент **Все задачи**, а затем щелкните **Запрос нового сертификата**.  
  
6.  Щелкните дважды **Далее** .  
  
7.  На странице **запрос сертификатов** установите флажок для созданного шаблона сертификата, выполнив инструкции в разделе Настройка шаблонов сертификатов 1.5.2. При необходимости щелкните **Требуется больше данных для регистрации этого сертификата**.  
  
8.  В диалоговом окне **Свойства сертификата** на вкладке **Субъект** в области **Имя субъекта** в поле **Тип** выберите **Общее имя**.  
  
9. В поле **Значение** укажите полное доменное имя для веб-сайта сервера сетевых расположений и щелкните **Добавить**.  
  
10. В области **Альтернативное имя** в поле **Тип** выберите **DNS**.  
  
11. В поле **Значение** укажите полное доменное имя для веб-сайта сервера сетевых расположений и щелкните **Добавить**.  
  
12. На вкладке **Общие** в поле **Понятное имя** можно ввести имя, которое упростит идентификацию сертификатов.  
  
13. Нажмите кнопку **OK**, щелкните **Зарегистрировать** и нажмите кнопку **Готово**.  
  
14. В области сведений оснастки "Сертификаты" убедитесь, что новый сертификат был зарегистрирован с целью проверки подлинности сервера.  
  
#### <a name="to-configure-the-network-location-server"></a>Настройка сервера сетевых расположений  
  
1.  Настройте веб-сайт на сервере с высоким уровнем доступности. Для него контент не требуется, но для проверки вы можете определить страницу по умолчанию, с сообщением, которое видят клиенты при подключении.  
  
    > [!NOTE]  
    > Это действие не требуется, если веб-сайт сервера сетевых расположений размещен на сервере DirectAccess.  
  
2.  Привяжите сертификат HTTPS-сервера к веб-сайту. Общее имя сертификата должно совпадать с именем сайта сервера сетевых расположений. Убедитесь, что клиенты DirectAccess доверяют ЦС, выдающему сертификат.  
  
    > [!NOTE]  
    > Это действие не требуется, если веб-сайт сервера сетевых расположений размещен на сервере DirectAccess.  
  
3.  Настройте сайт CRL с высоким уровнем доступности из внутренней сети.  
  
    Точки распространения CRL можно получить с помощью:  
  
    -   Веб-серверы с использованием URL-адреса на основе HTTP, например: https://crl.corp.contoso.com/crld/corp-APP1-CA.crl  
  
    -   Файловые серверы, доступ к которым осуществляется по UNC-пути, например \\\crl.corp.contoso.com\crld\corp-APP1-CA.crl  
  
    Если внутренняя точка распространения CRL доступна только по IPv6, необходимо настроить правило безопасности брандмауэра Windows в режиме повышенной безопасности, чтобы исключить защиту IPsec IPv6-адреса интрасети для IPv6-адресов точек распространения CRL.  
  
4.  Убедитесь, что клиенты DirectAccess во внутренней сети могут разрешить имя сервера сетевых расположений. Убедитесь, что это имя не разрешается клиентами DirectAccess в Интернете.  
  
## <a name="BKMK_Links"></a>Следующий шаг  
  
-   [Шаг 2. Настройка расширенных серверов DirectAccess](da-adv-configure-s2-servers.md)  
  


