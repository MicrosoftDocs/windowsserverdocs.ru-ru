---
title: Configure a Multi-Forest Deployment
description: Этот раздел является частью руководств по развертыванию удаленного доступа в среде с несколькими лесами в Windows Server 2016.
manager: brianlic
ms.custom: na
ms.prod: windows-server
ms.reviewer: na
ms.suite: na
ms.technology: networking-ras
ms.tgt_pltfrm: na
ms.topic: article
ms.assetid: 3c8feff2-cae1-4376-9dfa-21ad3e4d5d99
ms.author: pashort
author: shortpatti
ms.openlocfilehash: 08bd945bf808843286d390a089d9ac070b9a8813
ms.sourcegitcommit: 07c9d4ea72528401314e2789e3bc2e688fc96001
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/29/2020
ms.locfileid: "76822687"
---
# <a name="configure-a-multi-forest-deployment"></a>Configure a Multi-Forest Deployment

>Область применения: Windows Server (Semi-Annual Channel), Windows Server 2016

Данный раздел содержит описание возможных сценариев настройки развертывания удаленного доступа в конфигурации с несколькими лесами. Во всех сценариях предполагается, что DirectAccess развернут в единственном лесу Forest1 и что планируется настроить DirectAccess для работы в новом лесу Forest2.  
  
## <a name="AccessForest2"></a>Доступ к ресурсам из Forest2  
В данном сценарии DirectAccess уже развернут в лесу Forest1 и настроен таким образом, чтобы предоставлять клиентам из леса Forest1 доступ к корпоративной сети. По умолчанию клиентам, подключенным через DirectAccess, доступны только ресурсы в лесу Forest1 и недоступны никакие серверы в лесу Forest2.  
  
#### <a name="to-enable-directaccess-clients-to-access-resources-from-forest2"></a>Предоставление клиентам DirectAccess доступа к ресурсам из леса Forest2  
  
1.  Если DNS-суффикс леса Forest2 не является частью DNS-суффикса леса Forest1, добавьте правила таблицы политики разрешения имен (NRPT) с суффиксами доменов в лесу Forest2 и при желании добавьте суффиксы доменов в лесу Forest2 в список DNS-суффиксов.  
  
2.  Добавьте соответствующие внутренние префиксы IPv6 в лесу Forest2, если IPv6 развертывается во внутренней сети.  
  
## <a name="EnableForest2DA"></a>Разрешить клиентам подключаться через DirectAccess с помощью Forest2  
В этом сценарии выполняется настройка развертывания удаленного доступа для предоставления клиентам из леса Forest2 доступа к корпоративной сети. Предполагается, что уже созданы необходимые группы безопасности для клиентских компьютеров в лесу Forest2.   
  
#### <a name="to-allow-clients-from-forest2-to-access-the-corporate-network"></a>Предоставление клиентам из леса Forest2 доступа к корпоративной сети  
  
1.  Добавьте группу безопасности клиентов из леса Forest2.  
  
2.  Если DNS-суффикс Forest2 не является частью DNS-суффикса Forest1, добавьте правила NRPT с суффиксами домена клиентов в Forest2, чтобы разрешить доступ к контроллерам домена для проверки подлинности, а также добавьте суффиксы доменов в Forest2 к DNS-СУФ. Исправление списка поиска. 
  
3.  Добавьте внутренние префиксы IPv6 в лесу Forest2, чтобы DirectAccess мог создать туннель IPsec к контроллерам домена для проверки подлинности.  
  
4.  Обновите список серверов управления.  
  
## <a name="AddEPForest2"></a>Добавление точек входа из Forest2  
В этом сценарии DirectAccess развертывается в многосайтовой конфигурации в лесу Forest1 и планируется добавить сервер удаленного доступа с именем DA2 из леса Forest2 в качестве точки входа для существующего многосайтового развертывания DirectAccess.  
  
#### <a name="to-add-a-remote-access-server-from-forest2-as-an-entry-point"></a>Добавление сервера удаленного доступа из леса Forest2 в качестве точки доступа  
  
1.  Убедитесь в том, что администратор удаленного доступа обладает достаточными правами для записи объектов групповой политики в домене DA2 и что администратор удаленного доступа является локальным администратором домена DA2.  
  
2.  Добавьте DA2 в качестве точки входа.   
  
3.  Добавьте правила таблицы политики разрешения имен (NRPT) с суффиксами доменов в лесу Forest2, чтобы предоставить доступ к контроллерам домена для проверки подлинности, и при желании добавьте суффиксы доменов в лесу Forest2 в список DNS-суффиксов.  
  
4.  При необходимости добавьте соответствующие внутренние префиксы IPv6 в лесу Forest2, чтобы сервер удаленного доступа мог создать туннель IPsec к корпоративным ресурсам и убедиться в правильности работы проверок NCSI.  
  
5.  Обновите список серверов управления.  
  
## <a name="OTPMultiForest"></a>Настройка OTP в развертывании с несколькими лесами  
При настройке OTP в развертывании с несколькими лесами используются следующие термины:  
  
-   Корневой ЦС — основной центр сертификации PKI (леса).  
  
-   ЦС предприятия — все остальные ЦС.  
  
-   Лес ресурсов — лес, содержащий корневой ЦС, который считается "управлением форест\домаин".  
  
-   Лес учетных записей — все остальные леса в топологии.  
  
Для этой процедуры требуется сценарий PowerShell, PKISync.ps1. См. раздел [AD CS: сценарий PKISync.ps1 для регистрации сертификатов между лесами](https://technet.microsoft.com/library/ff961506.aspx).  
  
> [!NOTE]  
> В этом разделе приводятся примеры командлетов Windows PowerShell, которые можно использовать для автоматизации некоторых описанных процедур. Дополнительные сведения см. в разделе [Командлеты](https://go.microsoft.com/fwlink/p/?linkid=230693).  
  
### <a name="BKMK_CertPub"></a>Настройка центров сертификации в качестве издателей сертификатов  
  
1.  Для обеспечения поддержки ссылок LDAP во всех ЦС предприятия во всех лесах выполните следующую команду из командной строки с повышенными привилегиями:  
  
    ```  
    certutil -setreg Policy\EditFlags +EDITF_ENABLELDAPREFERRALS  
    ```  
  
2.  Добавьте все учетные записи компьютера ЦС предприятия в группы безопасности издателей сертификатов Active Directory в каждом лесу учетных записей.  
  
3.  Перезапустите все службы certsvc на всех компьютерах ЦС во всех лесах, выполнив следующую команду из командной строки с повышенными привилегиями:  
  
    ```  
    net stop certsvc && net start certsvc  
    ```  
  
4.  Извлеките сертификат корневого ЦС, выполнив следующую команду из командной строки с повышенными привилегиями:  
  
    ```  
    certutil -config <Computer-Name>\<Root-CA-Name> -ca.cert <root-ca-cert-filename.cer>  
    ```  
  
    (Если выполнить команду в корневом ЦС, можно опустить сведения о подключении,-config < Computer-name >\\< Root-CA-name >)  
  
    1.  Импортируйте сертификат корневого ЦС из предыдущего шага в ЦС леса учетных записей, выполнив следующую команду из командной строки с повышенными привилегиями:  
  
        ```  
        certutil -dspublish -f <root-ca-cert-filename.cer> RootCA  
        ```  
  
    2.  Предоставьте шаблонам сертификатов леса ресурсов разрешения на чтение и запись в лесу учетной записи \<\>\\< учетной записи администратора\>.  
  
    3.  Извлеките все сертификаты ЦС предприятия в лесу ресурсов, выполнив следующую команду из командной строки с повышенными привилегиями:  
  
        ```  
        certutil -config <Computer-Name>\<Enterprise-CA-Name> -ca.cert <enterprise-ca-cert-filename.cer>  
        ```  
  
        (Если выполнить команду в корневом ЦС, можно опустить сведения о подключении,-config < Computer-name >\\< Root-CA-name >)  
  
    4.  Импортируйте сертификаты ЦС предприятия из предыдущего шага в ЦС леса учетных записей, выполнив следующие команды из командной строки с повышенными привилегиями:  
  
        ```  
        certutil -dspublish -f <enterprise-ca-cert-filename.cer> NTAuthCA  
        certutil -dspublish -f <enterprise-ca-cert-filename.cer> SubCA  
        ```  
  
    5.  Удалите шаблоны сертификатов для OTP леса учетных записей из списка выданных шаблонов сертификатов.  
  
### <a name="BKMK_DelImp"></a>Удаление и импорт шаблонов сертификатов OTP  
  
1.  Удалите шаблоны сертификатов для OTP из леса учетных записей, то есть Forest2.  
  
2.  Скопируйте шаблоны сертификатов и объекты с идентификаторами из леса ресурсов в каждый лес учетных записей с помощью следующих команд PowerShell:  
  
    ```  
    .\PKISync.ps1 -sourceforest <resource forest DNS> -targetforest <account forest DNS> -type Template -cn <DA OTP registration authority template common name>.  
    .\PKISync.ps1 -sourceforest <resource forest DNS> -targetforest <account forest DNS> -type Template -cn <Secure DA OTP logon certificate template common name>.  
    .\PKISync.ps1 -sourceforest <resource forest DNS> -targetforest <account forest DNS> -type Oid -f  
    ```  
  
### <a name="BKMK_Publish"></a>Публикация шаблонов сертификатов OTP  
  
-   Выдайте импортированные шаблоны сертификатов всем ЦС лесов учетных записей.  
  
### <a name="BKMK_Extract"></a>Извлечение и синхронизация ЦС  
  
1.  Извлеките все сертификаты ЦС предприятия из лесов учетных записей, выполнив следующие команды из командной строки с повышенными привилегиями:  
  
    ```  
    certutil -config <Computer-Name>\<Enterprise-CA-Name> -ca.cert <enterprise-ca-cert-filename.cer>  
    ```  
  
2.  Синхронизируйте ЦС между лесами от лесов учетных записей до леса ресурсов с помощью следующей команды PowerShell:  
  
    ```  
    .\PKISync.ps1 -sourceforest <account forest DNS> -targetforest <resource forest DNS> -type CA -cn <enterprise CA sanitized name> -f  
    ```  
  
3.  Синхронизируйте ЦС между лесами от леса ресурсов до лесов учетных записей с помощью следующей команды PowerShell:  
  
    ```  
    .\PKISync.ps1 -sourceforest <resource forest DNS> -targetforest <account forest DNS> -type CA -cn <enterprise CA sanitized name> -f  
    ```  
  
## <a name="configuration-procedures"></a>Процедуры настройки  
В следующих разделах приведены процедуры настройки для развертываний по описанному выше сценарию. По завершении процедуры вернитесь к сценарию.  
  
### <a name="NRPT_DNSSearchSuffix"></a>Добавление правил NRPT и DNS-суффиксов  
Клиенты, которые подключаются к корпоративной сети через DirectAccess, на основе таблицы политики разрешения имен (NRPT) определяют, какой DNS-сервер нужно использовать для разрешения адресов различных ресурсов. Это позволяет клиенту разрешать адреса корпоративных ресурсов и помогает ему правильно классифицировать внутренние и внешние ресурсы, что необходимо для работы DirectAccess. Средства настройки DirectAccess автоматически определяют корневой DNS-суффикс леса Forest1 и добавляют его в таблицу NRPT. Однако суффиксы полных доменных имен леса Forest2 не добавляются автоматически в таблицу NRPT, и администратор удаленного доступа должен добавить их вручную.  
  
Список DNS-суффиксов позволяет клиентам использовать краткие имена-метки вместо полных доменных имен. Средства настройки удаленного доступа автоматически добавляют все домены в лесу Forest1 в список DNS-суффиксов. Если вы хотите, чтобы клиенты смогли использовать краткие имена-метки для ресурсов в лесу Forest2, вам придется добавить эти имена вручную.  
  
##### <a name="to-add-a-dns-suffix-to-the-nrpt-table-and-domain-suffixes-to-the-dns-suffix-search-list"></a>Добавление DNS-суффикса в таблицу NRPT и суффиксов доменов в список DNS-суффиксов  
  
1.  В средней области консоли управления удаленным доступом в разделе **Шаг 3. Серверы инфраструктуры** щелкните **Изменить**.  
  
2.  На странице **Сервер сетевых расположений** нажмите кнопку **Далее**.  
  
3.  На странице **DNS** в таблице введите любые дополнительные суффиксы имен, которые являются частью корпоративной сети в лесу Forest2. В поле **Адрес DNS-сервера**введите адрес DNS-сервера вручную, либо щелкнув **Обнаружить**. Если не ввести адрес, новые записи будут применяться как исключения NRPT. Затем нажмите кнопку **Next**.  
  
4.  Дополнительно Добавьте любые суффиксы DNS на странице **Порядок просмотра DNS-суффиксов** . Для этого введите суффикс в поле **Новый суффикс** и нажмите кнопку **Добавить**. Затем нажмите кнопку **Next**.  
  
5.  На странице **Управление** нажмите кнопку **Готово**.  
  
6.  В средней области консоли управления удаленным доступом нажмите кнопку **Готово**.  
  
7.  В диалоговом окне **Сведения об удаленном доступе** нажмите кнопку **Применить**.  
  
8.  В диалоговом окне **Применение параметров мастера настройки удаленного доступа** нажмите кнопку **Закрыть**.  
  
### <a name="IPv6Prefix"></a>Добавить внутренний префикс IPv6  
  
> [!NOTE]  
> Добавление внутреннего префикса IPv6 имеет смысл только при развертывании IPv6 во внутренней сети.  
  
Сервер удаленного доступа ведет список префиксов IPv6 для корпоративных ресурсов. Клиентам, подключенным через DirectAccess, доступны только ресурсы с этими префиксами IPv6. Так как консоль управления удаленным доступом и команды Windows PowerShell автоматически добавляют префиксы IPv6 Forest1 и могут не добавлять префиксы других лесов, необходимо добавить любые отсутствующие префиксы Forest2 вручную.  
  
##### <a name="to-add-an-ipv6-prefix"></a>Добавление префикса IPv6  
  
1.  В средней области консоли управления удаленным доступом в разделе **Шаг 2. Сервер удаленного доступа** щелкните **Изменить**.  
  
2.  В окне мастера установки сервера удаленного доступа щелкните **Конфигурация префикса**.  
  
3.  На странице **Конфигурация префикса** в разделе **Префиксы IPv6 внутренней сети**добавьте любые дополнительные префиксы IPv6, разделенные точками с запятой, например 2001:db8:1::/64;2001:db8:2::/64. Затем нажмите кнопку **Next**.  
  
4.  На странице **Проверка подлинности** нажмите кнопку **Готово**.  
  
5.  В средней области консоли управления удаленным доступом нажмите кнопку **Готово**.  
  
6.  В диалоговом окне **Сведения об удаленном доступе** нажмите кнопку **Применить**.  
  
7.  В диалоговом окне **Применение параметров мастера настройки удаленного доступа** нажмите кнопку **Закрыть**.  
  
### <a name="SGs"></a>Добавление групп безопасности клиента  
Чтобы разрешить клиентским компьютерам под управлением Windows 8 Forest2 доступ к ресурсам через DirectAccess, необходимо добавить группу безопасности из Forest2 в развертывание удаленного доступа.  
  
##### <a name="to-add-windows-8-client-security-groups"></a>Добавление клиентских групп безопасности Windows 8  
  
1.  В средней области консоли управления удаленным доступом в разделе **Шаг 1. Удаленные клиенты** щелкните **Изменить**.  
  
2.  В окне мастера установки клиента DirectAccess щелкните **Выбор групп**, а затем на странице **Выбор групп** нажмите кнопку **Добавить**.  
  
3.  В диалоговом окне **Выбор групп** выберите группы безопасности, в которые входят компьютеры клиентов DirectAccess. Затем нажмите кнопку **Next**.  
  
4.  На странице **Помощник по подключению к сети** нажмите кнопку **Готово**.  
  
5.  В средней области консоли управления удаленным доступом нажмите кнопку **Готово**.  
  
6.  В диалоговом окне **Сведения об удаленном доступе** нажмите кнопку **Применить**.  
  
7.  В диалоговом окне **Применение параметров мастера настройки удаленного доступа** нажмите кнопку **Закрыть**.  
  
Чтобы разрешить клиентским компьютерам Windows 7 доступ к ресурсам через DirectAccess при включенном многосайтовом развертывании, необходимо добавить группу безопасности из Forest2 в развертывание удаленного доступа для каждой точки входа. Сведения о добавлении групп безопасности Windows 7 см. в описании страницы **поддержки клиентов** в 3,6. Включение многосайтового развертывания.  
  
### <a name="RefreshMgmtServers"></a>Обновление списка серверов управления  
Сервер удаленного доступа автоматически обнаруживает серверы инфраструктуры во всех лесах, содержащих объекты групповой политики конфигурации DirectAccess. Если DirectAccess развернут на сервере из леса Forest1, то объект групповой политики этого сервера будет записан в его домен в лесу Forest1. Если включен доступ к DirectAccess для клиентов из леса Forest2, то объект групповой политики клиента будет записан в домен в лесу Forest2.  
  
Процесс автоматического обнаружения серверов инфраструктуры необходим для предоставления доступа через DirectAccess к контроллерам домена и Configuration Manager конечных точек Майкрософт. Вы должны запустить процесс обнаружения вручную.  
  
##### <a name="to-refresh-the-management-servers-list"></a>Обновление списка серверов управления  
  
1.  На консоли управления удаленным доступом щелкните **Конфигурация**, а затем в области **Задачи** щелкните **Обновление серверов управления**.  
  
2.  В диалоговом окне **Обновление серверов управления** нажмите кнопку **Закрыть**.  
  


