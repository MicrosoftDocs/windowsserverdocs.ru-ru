---
title: Диагностика подключения многосайтового развертывания
description: Этот раздел является частью руководства развертывание несколькими серверами удаленного доступа в многосайтового развертывания в Windows Server 2016.
manager: brianlic
ms.custom: na
ms.prod: windows-server-threshold
ms.reviewer: na
ms.suite: na
ms.technology:
- networking-ras
ms.tgt_pltfrm: na
ms.topic: article
ms.assetid: 570c81d6-c4f4-464c-bee9-0acbd4993584
ms.author: pashort
author: shortpatti
ms.openlocfilehash: 35b008b12cde28391876f914f25002ce8cb8d56c
ms.sourcegitcommit: 0d0b32c8986ba7db9536e0b8648d4ddf9b03e452
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2019
ms.locfileid: "59822655"
---
# <a name="troubleshooting-enabling-multisite"></a>Диагностика подключения многосайтового развертывания

>Область применения. Windows Server (полугодовой канал), Windows Server 2016

Этот раздел содержит информацию по устранению проблем, связанных с командой `Enable-DAMultisite`. Чтобы подтвердить, что ваша проблема связана с подключением многосайтового развертывания, проверьте журнал событий Windows на наличие кода события 10051.  
  
## <a name="user-connectivity-issues"></a>Проблемы, связанные с подключением пользователей  
Когда включено многосайтовое развертывание, у пользователей могут возникнуть проблемы с подключением, если конфигурация не верна.  
  
**Причина**  
  
При многосайтовом развертывании клиентские компьютеры Windows 10 и Windows 8 могут перемещаться между разными точками входа.  Клиентские компьютеры Windows 7 должен ассоциироваться с конкретной точкой входа многосайтового развертывания. Если клиентские компьютеры находятся в неверной группе безопасности, они могут получать неправильные параметры групповой политики.  
  
**Решение**  
  
DirectAccess требует по крайней мере одной группы безопасности для всех Windows 10 и Windows 8 клиентских компьютеров; Мы рекомендуем использовать одну группу безопасности для всех компьютеров Windows 10 и Windows 8 в домене. DirectAccess также требует наличия группы безопасности для клиентских компьютеров Windows 7 для каждой точки входа. Клиентский компьютер должен входить только в одну группу безопасности. Таким образом, следует убедиться в том, что группы безопасности для Windows 10 и Windows 8 клиенты содержат только компьютеры под управлением Windows 10 или Windows 8, и что каждый клиентский компьютер Windows 7 принадлежит к одной выделенной группе безопасности для соответствующей точки входа и ни один клиент Windows 10 или Windows 8 принадлежности к группам безопасности Windows 7.  
  
Настройте группы безопасности Windows 8 на **Выбор групп** странице **установки клиента DirectAccess** мастера. Настройте группы безопасности Windows 7 на **поддержка клиента** странице **включения многосайтового развертывания** мастера или на **поддержка клиента** странице  **Добавьте точку входа** мастера.  
  
## <a name="kerberos-proxy-authentication"></a>Проверка подлинности прокси Kerberos  
**Сообщение об ошибке**. Проверка подлинности прокси Kerberos не поддерживается в многосайтовом развертывании. Для проверки подлинности пользователя IPsec необходимо включить использование сертификатов компьютера.  
  
**Причина**  
  
Проверка подлинности сертификата компьютера должна быть включена перед включением многосайтового развертывания.  
  
**Решение**  
  
Включение проверки подлинности сертификата компьютера  
  
1.  В области сведений консоли управления удаленным доступом нажмите кнопку **Редактировать**, расположенную в рубрике **Шаг 2. Сервер удаленного доступа**.  
  
2.  На странице **Проверки подлинности** мастера **Установки сервера удаленного доступа** отметьте флажком **Использовать сертификаты компьютеров** и выберите корневой или промежуточный центр сертификации, который выдает сертификаты в вашем развертывании.  
  
Чтобы включить проверку подлинности сертификата компьютера, с помощью Windows PowerShell, используйте `Set-DAServer` командлет и укажите *IPsecRootCertificate* параметра.  
  
## <a name="ip-https-certificates"></a>Сертификаты IP-HTTPS  
**Сообщение об ошибке**. Сервер DirectAccess использует самозаверяющий сертификат IP-HTTPS. Настройте IP-HTTPS на использование подписанного сертификата из известного ЦС.  
  
**Причина**  
  
Сертификат IP-HTTPS является самозаверяющим. Самозаверяющие сертификаты нельзя использовать при многосайтовом развертывании.  
  
**Решение**  
  
Выбор сертификата IP-HTTPS  
  
1.  В области сведений консоли управления удаленным доступом нажмите кнопку **Редактировать**, расположенную в рубрике **Шаг 2. Сервер удаленного доступа**.  
  
2.  На странице **Сетевых адаптеров** мастера **Установки сервера удаленного доступа** под рубрикой **Выбрать сертификат, используемый для проверки подлинности соединений IP-HTTPS** убедитесь, что рубрика **Использовать самозаверяющий сертификат, автоматически созданный DirectAccess** не отмечена флажком, и нажмите кнопку **Просмотреть**, чтобы выбрать сертификат, выпущенный доверенным ЦС.  
  
## <a name="network-location-server"></a>Сервер сетевого размещения  
  
-   **Причина 1**  
  
    **Сообщение об ошибке**. DirectAccess настроен на использование самозаверяющего сертификата для сервера сетевых расположений. Настройте сервер сетевых расположений на использование подписанного сертификата из ЦС.  
  
    **Причина**  
  
    Сервер сетевых расположений развертывается на сервере удаленного доступа и использует самозаверяющий сертификат. Самозаверяющие сертификаты нельзя использовать при многосайтовом развертывании.  
  
    **Решение**  
  
    Выбор сертификата сервера сетевых расположений  
  
    1.  В области сведений консоли управления удаленным доступом нажмите кнопку **Редактировать**, расположенную в рубрике **Шаг 3. Серверы инфраструктуры**.  
  
    2.  В **установки сервера инфраструктуры** мастера **сервера сетевых расположений** раздела **сервера сетевых расположений развертывается на сервере удаленного доступа**, сделать что **использовать самозаверяющий сертификат** флажок снят и нажмите кнопку **Обзор** для выбора сертификата, выданного ЦС предприятия.  
  
-   **Причина 2**  
  
    **Сообщение об ошибке**. Чтобы развернуть сетевой нагрузки для балансировки нагрузки кластера многосайтового развертывания, получить сертификат для сервера сетевых расположений с именем субъекта, который отличается от внутреннего имени сервера удаленного доступа.  
  
    **Причина**  
  
    Имя субъекта сертификата для веб-сайта сервера сетевых расположений совпадает с внутренним именем сервера удаленного доступа. Это вызывает проблему разрешения имен.  
  
    **Решение**  
  
    Получите сертификат с именем субъекта, отличным от внутреннего имени сервера удаленного доступа.  
  
    Настройка сервера сетевых расположений  
  
    1.  В области сведений консоли управления удаленным доступом нажмите кнопку **Редактировать**, расположенную в рубрике **Шаг 3. Серверы инфраструктуры**.  
  
    2.  На странице **Сервера сетевых расположений** мастера **Установки сервера инфраструктуры** под рубрикой **Сервер сетевых расположений развертывается на сервере удаленного доступа** нажмите **Просмотреть**, чтобы выбрать полученный вами ранее сертификат. Данный сертификат должен иметь имя субъекта, отличное от внутреннего имени сервера удаленного доступа.  
  
## <a name="windows-7-client-computers"></a>Клиентские компьютеры под управлением Windows 7  
**Предупреждение**. При включении многосайтового развертывания группы безопасности, настроенные для клиентов DirectAccess не может содержать компьютеры под управлением Windows 7. Для поддержки клиентских компьютеров под управлением Windows 7 при многосайтовом развертывании, выберите группу безопасности, включающую клиентов для каждой точки входа.  
  
**Причина**  
  
В существующем развертывании DirectAccess была включена поддержка клиентов Windows 7.  
  
**Решение**  
  
DirectAccess требует по крайней мере одну группу безопасности для всех клиентских компьютеров Windows 8 и группу безопасности для клиентских компьютеров Windows 7 для каждой точки входа. Клиентский компьютер должен входить только в одну группу безопасности. Таким образом, следует убедиться, что группа безопасности для клиентов Windows 8 содержит только компьютеры под управлением Windows 8, и что каждый клиентский компьютер Windows 7 принадлежит к одной выделенной группе безопасности для соответствующей точки входа и что ни один клиент Windows 8 входить в группы безопасности Windows 7.  
  
## <a name="active-directory-site"></a>Узел Active Directory  
**Сообщение об ошибке**. Сервер < имя_сервера > не связан с сайтом Active Directory.  
  
**Причина**  
  
DirectAccess не смог определить сайт Active Directory. На консоли сайтов и служб Active Directory можно настроить различные подсети вашей сети и связать каждую подсеть с соответствующим сайтом Active Directory. Эта ошибка может произойти, если IP-адрес сервера удаленного доступа не принадлежит ни к одной подсети или если подсеть, к которой принадлежит данный IP-адрес, не определяется сайтом Active Directory.  
  
**Решение**  
  
Убедитесь, что проблема заключается именно в этом, выполнив команду `nltest /dsgetsite` на вашем сервере удаленного доступа. Если это так, команда вернет ERROR_NO_SITENAME. Чтобы решить эту проблему, убедитесь, что подсеть, содержащая IP-адрес внутреннего сервера, существует на вашем контроллере домена и определена сайтом Active Directory.  
  
## <a name="SaveGPOSettings"></a>Идет сохранение параметров объекта групповой Политики сервера  
**Сообщение об ошибке**. Произошла ошибка при сохранении параметров удаленного доступа к объекту групповой Политики < имя_объекта_групповой_политики >.  
  
**Причина**  
  
Изменения групповой Политики сервера не удалось сохранить из-за проблем с подключением или если нарушение совместного доступа для файла registry.pol, например, другой пользователь заблокировал файл.  
  
**Решение**  
  
Убедитесь, что сервер удаленного доступа подключен к контроллеру домена. Если подключение существует, проверьте, заблокирован ли файл registry.pol для других пользователей на контроллере домена. При необходимости завершите этот сеанс пользователя, чтобы разблокировать файл.  
  
## <a name="InternalServerError"></a>Произошла внутренняя ошибка  
**Сообщение об ошибке**. Обнаружена внутренняя ошибка.  
  
**Причина**  
  
Это может быть вызвано непредусмотренной конфигурацией таблицы точек входа в объекте групповой политики клиента. Такое может произойти, если администратор использует командлеты клиента DirectAccess, чтобы отредактировать таблицу точек входа в объекте групповой политики клиента.  
  
**Решение**  
  
Просмотрите конфигурацию таблицы точек входа во всех объектах групповой политики клиентов и исправьте несоответствия в конфигурации многосайтового развертывания между различными экземплярами клиентских объектов групповой политики и конфигурацией DirectAccess. Используйте командлет `Get-DaEntryPointTableItem` с именем клиентского объекта групповой политики, чтобы получить таблицу точек входа для клиента. Используйте командлет `Get-NetIPHttpsConfiguration`, чтобы получить все профили IP-HTTPS для всех точек входа.  
  
Для получения дополнительных сведений см. в разделе [командлеты клиента DirectAccess в Windows PowerShell](https://technet.microsoft.com/library/hh848426).  
  


