---
title: Шаг 2. Планирование многосайтовой инфраструктуры
description: Узнайте, как выполнить планирование межсайтовой инфраструктуры. включая, Active Directory, группы безопасности и групповая политика объекты.
manager: brianlic
ms.topic: article
ms.assetid: 64c10107-cb03-41f3-92c6-ac249966f574
ms.author: lizross
author: eross-msft
ms.date: 08/07/2020
ms.openlocfilehash: 460cf6c921e50ae0026f742fa92ed252f9eb773b
ms.sourcegitcommit: 40905b1f9d68f1b7d821e05cab2d35e9b425e38d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/06/2021
ms.locfileid: "97941710"
---
# <a name="step-2-plan-the-multisite-infrastructure"></a>Шаг 2. Планирование многосайтовой инфраструктуры

>Область применения. Windows Server (Semi-Annual Channel), Windows Server 2016

Следующим шагом при развертывании удаленного доступа в многосайтовой топологии является завершение планирования многосайтовой инфраструктуры. включая, Active Directory, группы безопасности и групповая политика объекты.
## <a name="21-plan-active-directory"></a><a name="bkmk_2_1_AD"></a>Active Directory плана 2,1
Многосайтовое развертывание с удаленным доступом можно настроить в нескольких топологиях.

-   **ОдноActive Directoryный сайт, несколько точек входа**. в этой топологии у вас есть один Active Directoryный сайт для всей Организации с быстрыми связями в интрасети на всем сайте, но у вас есть несколько серверов удаленного доступа, развернутых в Организации, каждая из которых действует как точка входа. Географическое примером этой топологии является наличие одного Active Directory сайта для США с точками входа в Восточной и Западной регионах.

    ![Многосайтовая инфраструктура](../../../../media/Step-2-Plan-the-Multisite-Infrastructure/RAMultisiteTopo1.png)

-   **Несколько Active Directory сайтов, несколько точек входа**— в этой топологии имеется два или более Active Directory сайтов с сервером удаленного доступа, развернутым в качестве точки входа для каждого сайта. Каждый сервер удаленного доступа связан с Active Directory контроллером домена для сайта. Географическое примером этой топологии является наличие Active Directory сайта для США и одного для Европы с одной точкой входа для каждого сайта. Обратите внимание, что при наличии нескольких Active Directory сайтов не требуется наличие точки входа, связанной с каждым сайтом. Кроме того, некоторым сайтам Active Directory может быть назначено несколько точек входа.

    ![Многосайтовая топология](../../../../media/Step-2-Plan-the-Multisite-Infrastructure/RAMultisiteTopo2.png)

В точке входа с несколькими сайтами можно настроить один сервер удаленного доступа, несколько серверов удаленного доступа или кластеры серверов удаленного доступа.

### <a name="active-directory-best-practices-and-recommendations"></a>Active Directory рекомендации и рекомендации
Обратите внимание на следующие рекомендации и ограничения для развертывания Active Directory в многосайтовых сценариях.

1.  Каждый Active Directory сайт может содержать один или несколько серверов удаленного доступа или кластер серверов, который работает как многосайтовые точки входа для клиентских компьютеров. Однако Active Directory сайт не обязательно должен иметь точку входа.

2.  Многосайтовая точка входа может быть связана только с одним Active Directory сайтом. Когда клиентские компьютеры под управлением Windows 8 подключаются к определенной точке входа, они считаются принадлежащими сайту Active Directory, связанному с этой точкой входа.

3.  Рекомендуется, чтобы каждый Active Directory сайт был контроллером домена. Контроллер домена может быть доступен только для чтения.

4.  Если каждый Active Directory сайт содержит контроллер домена, то объект групповой политики для сервера в точке входа управляется одним из контроллеров домена на сайте Active Directory, связанном с конечной точкой. Если на этом сайте нет контроллеров домена с поддержкой записи, то объект групповой политики для сервера управляется на контроллере домена с поддержкой записи, который находится ближе всего к первому серверу удаленного доступа, настроенному в точке входа. Ближайшее зависит от вычисления стоимости связи. Обратите внимание, что в этом сценарии после внесения изменений в конфигурацию может возникнуть задержка при репликации между контроллером домена, управляющим объектом групповой политики, и контроллером домена только для чтения на Active Directory сайте сервера.

5.  Объекты групповой политики клиента и дополнительные объекты групповой политики сервера приложений управляются на контроллере домена, работающем в качестве эмулятора основного контроллера домена (PDC). Это означает, что объекты групповой политики клиента не обязательно управляются на Active Directory сайте, содержащем точку входа, к которой подключаются клиенты.

6.  Если контроллер домена для Active Directory сайта недоступен, сервер удаленного доступа будет подключаться к дополнительному контроллеру домена на сайте (если он доступен). В противном случае он подключается к контроллеру домена для другого сайта, чтобы получить обновленный объект групповой политики и проверить подлинность клиентов. В обоих случаях консоль управления удаленным доступом и командлеты PowerShell нельзя использовать для получения или изменения параметров конфигурации до тех пор, пока контроллер домена не станет доступен. Следует отметить следующее.

    1.  Если сервер, работающий в качестве эмулятора PDC, недоступен, необходимо назначить доступный контроллер домена с обновленными объектами групповой политики в качестве эмулятора PDC.

    2.  Если контроллер домена, управляющий объектом групповой политики сервера, недоступен, используйте командлет PowerShell Set-DAEntryPointDC, чтобы связать новый контроллер домена с точкой входа. Перед запуском командлета новый контроллер домена должен иметь актуальные объекты GPO.

## <a name="22-plan-security-groups"></a><a name="bkmk_2_2_SG"></a>2,2. Планирование групп безопасности
Во время развертывания одного сервера с дополнительными параметрами все клиентские компьютеры, обращающиеся к внутренней сети через DirectAccess, были собраны в группу безопасности. В многосайтовом развертывании эта группа безопасности используется только для клиентских компьютеров Windows 8. Для многосайтового развертывания клиентские компьютеры Windows 7 будут собраны в отдельные группы безопасности для каждой точки входа в многосайтовом развертывании. Например, если в группе DA_Clients все клиентские компьютеры были сгруппированы, необходимо удалить все компьютеры с Windows 7 из этой группы и разместить их в другой группе безопасности. Например, на нескольких сайтах Active Directory несколько точек входа можно создать группу безопасности для США точки входа (DA_Clients_US) и одну для точки входа в Европе (DA_Clients_Europe). Поместите все клиентские компьютеры под управлением Windows 7, расположенные в США, в группу DA_Clients_US и все, которые находятся в Европе в группе DA_Clients_Europe. Если у вас нет клиентских компьютеров Windows 7, вам не нужно планировать группы безопасности для компьютеров Windows 7.

Ниже приведены необходимые группы безопасности.

-   Одна группа безопасности для всех клиентских компьютеров с Windows 8. Рекомендуется создать уникальную группу безопасности для этих клиентов для каждого домена.

-   Уникальная группа безопасности, содержащая клиентские компьютеры Windows 7 для каждой точки входа. Рекомендуется создать уникальную группу для каждого домена. Например: domain1 \ DA_Clients_Europe; Домен2 \ DA_Clients_Europe; Domain1 \ DA_Clients_US; Домен2 \ DA_Clients_US.

## <a name="23-plan-group-policy-objects"></a><a name="bkmk_2_3_GPO"></a>2,3. планирование объектов групповая политика
Параметры DirectAccess, настроенные во время развертывания удаленного доступа, собираются в объекты групповой политики. В развертывании с одним сервером для клиентов DirectAccess, сервера удаленного доступа и при необходимости для серверов приложений уже используются объекты групповой политики. Для многосайтового развертывания требуются следующие объекты групповой политики:

-   Объект групповой политики сервера для каждой точки входа.

-   Объект групповой политики для каждого домена, содержащего клиентские компьютеры под управлением Windows 8.

-   Объект групповой политики для каждой точки входа и каждого домена, содержащего клиентские компьютеры Windows 7.

Объекты групповой политики можно настроить следующим образом:

-   **Автоматически**— можно указать, что объекты групповой политики создаются автоматически при удаленном доступе. Имя по умолчанию указывается для каждого объекта групповой политики и может быть изменено.

-   **Вручную**— можно использовать объекты групповой политики, созданные вручную администратором Active Directory.

> [!NOTE]
> После того как DirectAccess настроен для использования конкретных объектов групповой политики, он не может быть настроен на использование различных объектов групповой политики.

### <a name="231-automatically-created-gpos"></a>2.3.1 автоматически созданные объекты групповой политики
При автоматическом создании объектов групповой политики учитывайте следующее:

-   Автоматически созданные GPO применяются в соответствии с расположением и целевым параметром связи следующим образом:

    -   Для объекта групповой политики сервера расположение и параметры ссылки указывают на домен, содержащий сервер удаленного доступа.

    -   Для объектов групповой политики клиента целевой объект ссылки устанавливается на корень домена, в котором был создан объект групповой политики. Объект групповой политики создается для каждого домена, содержащего клиентские компьютеры, и объект групповой политики будет связан с корнем каждого домена. .

-   Для автоматически создаваемых объектов групповой политики для применения параметров DirectAccess администратор сервера удаленного доступа должен иметь следующие разрешения.

    -   Объект групповой политики создает разрешения для требуемых доменов.

    -   Разрешение на привязывание к корневым каталогам всех выбранных клиентских доменов.

    -   Разрешение на создание фильтра WMI для объектов групповой политики требуется, если DirectAccess настроен для работы только на мобильных компьютерах.

    -   Связывание разрешений для корней доменов, связанных с точками входа (домены объекта групповой политики сервера)

    -   Администратору удаленного доступа рекомендуется иметь разрешение на чтение GPO для каждого необходимого домена. Это позволяет удаленному доступу проверить, не существуют ли объекты групповой политики с повторяющимися именами при создании объектов групповой политики для многосайтового развертывания.

    -   Active Directory разрешения репликации в доменах, связанных с точками входа. Это связано с тем, что при первоначальном добавлении точек входа объект групповой политики сервера для точки входа создается на контроллере домена, ближайшем к этой точке входа. Однако, так как создание ссылок поддерживается только в эмуляторе PDC, перед созданием связи объект групповой политики должен быть реплицирован с контроллера домена, на котором он был создан, на контроллер домена, запущенный в качестве эмулятора PDC.

Обратите внимание, что если соответствующие разрешения для репликации и связывания объектов GPO не существуют, выдается предупреждение. Операция удаленного доступа будет продолжена, но репликация и компоновка не будут выполняться. Если предупреждение ссылки выдается автоматически, даже после того, как были созданы разрешения. Вместо этого администратору придется создавать связи вручную.

### <a name="232-manually-created-gpos"></a>Объекты групповой политики, созданные вручную 2.3.2
При создании объектов групповой политики вручную учитывайте следующее:

-   Следующие объекты групповой политики должны создаваться вручную для многосайтового развертывания:

    -   **Объект групповой политики сервера**— объект групповой политики сервера для каждой точки входа (в домене, в котором находится точка входа). Этот объект GPO будет применен на каждом сервере удаленного доступа в точке входа.

    -   **Объект групповой политики клиента (Windows 7)**— объект групповой политики для каждой точки входа и каждого домена, содержащего клиентские компьютеры Windows 7, которые будут подключаться к точкам входа в многосайтовом развертывании. Например, domain1 \ DA_W7_Clients_GPO_Europe; Домен2 \ DA_W7_Clients_GPO_Europe; Domain1 \ DA_W7_Clients_GPO_US; Домен2 \ DA_W7_Clients_GPO_US. Если ни один клиентский компьютер Windows 7 не будет подключаться к точкам входа, объекты групповой политики не требуются.

-   Создавать дополнительные объекты групповой политики для клиентских компьютеров под управлением Windows 8 не требуется. Объект групповой политики для каждого домена, содержащего клиентские компьютеры, уже был создан при развертывании одного сервера удаленного доступа. В многосайтовом развертывании эти клиентские объекты групповой политики будут работать как объекты групповой политики для клиентов Windows 8.

-   Объекты групповой политики должны существовать до нажатия кнопки фиксации в мастерах многосайтового развертывания.

-   При использовании объектов групповой политики, созданных вручную, выполняется поиск связи объекта по всему домену. Если объект групповой политики не связан с доменом, он автоматически привязывается к корневому каталогу. При отсутствии разрешения на создание связей выносится предупреждение.

-   При использовании объектов групповой политики, созданных вручную, для применения параметров DirectAccess администратор сервера удаленного доступа требует наличия полных разрешений GPO (изменение, удаление, изменение параметров безопасности) для объектов групповой политики, созданных вручную.

Обратите внимание, что если соответствующие разрешения для репликации и связывания объектов GPO не существуют, выдается предупреждение. Операция удаленного доступа будет продолжена, но репликация и компоновка не будут выполняться. Если предупреждение ссылки выдается автоматически, даже после того, как были созданы разрешения. Вместо этого администратору придется создавать связи вручную.

### <a name="233-managing-gpos-in-a-multi-domain-controller-environment"></a>2.3.3 Управление объектами групповой политики в среде с несколькими доменами
Каждый объект групповой политики будет управляться конкретным контроллером домена следующим образом:

-   Объект групповой политики сервера управляется одним из контроллеров домена Active Directory сайте, связанным с сервером, или, если контроллеры домена на этом сайте доступны только для чтения, на контроллере домена с поддержкой записи, ближайшем к первому серверу в точке входа.

-   Объекты групповой политики клиента будут управляться контроллером домена, работающим в качестве эмулятора PDC.

Если вы хотите вручную изменить параметры GPO, обратите внимание на следующее:

-   Для объектов групповой политики сервера, чтобы указать, какой контроллер домена связан с определенной точкой входа, выполните командлет PowerShell `Get-DAEntryPointDC -EntryPointName <name of entry point>` .

-   По умолчанию при внесении изменений с помощью сетевых командлетов PowerShell или консоли управления групповая политика используется контроллер домена, действующий в качестве эмулятора PDC.

-   При изменении параметров на контроллере домена, который не является контроллером домена, связанным с точкой входа (для объектов групповой политики сервера) или эмулятором основного контроллера домена (для объектов групповой политики клиента), обратите внимание на следующее:

    1.  Перед изменением параметров убедитесь, что контроллер домена реплицируется с помощью актуального объекта групповой политики, и перед внесением изменений [выполните резервное копирование параметров объекта групповой политики](https://go.microsoft.com/fwlink/?LinkID=257928). Если объект групповой политики не обновляется, может произойти конфликт слияния во время репликации, что приведет к повреждению конфигурации удаленного доступа.

    2.  После изменения параметров необходимо дождаться репликации изменений на контроллер домена, связанный с объектами групповой политики. Не вносите дополнительные изменения с помощью консоли управления удаленным доступом или командлетов удаленного доступа PowerShell до завершения репликации. Если объект групповой политики редактируется на двух разных контроллерах домена до завершения репликации, могут возникать конфликты слияния, что приводит к повреждению конфигурации.

-   Кроме того, можно изменить значение по умолчанию с помощью диалогового окна **Изменение контроллера домена** в консоли управления групповая политика или с помощью командлета PowerShell **Open-нетгпо** , чтобы изменения, внесенные с помощью консоли или командлетов для работы с сетью, использовали указанный контроллер домена.

    1.  Для этого в консоли управления групповая политика щелкните правой кнопкой мыши контейнер домен или сайты и выберите пункт **изменить контроллер домена**.

    2.  Для этого в PowerShell укажите параметр DomainController для командлета Open-NetGPO. Например, чтобы включить закрытые и открытые профили в брандмауэре Windows на объекте групповой политики с именем Domain1 \ DA_Server_GPO _Europe с помощью контроллера домена с именем europe-dc.corp.contoso.com, выполните следующие действия.

        ```
        $gpoSession = Open-NetGPO -PolicyStore "domain1\DA_Server_GPO _Europe" -DomainController "europe-dc.corp.contoso.com"
        Set-NetFirewallProfile -GpoSession $gpoSession -Name @("Private","Public") -Enabled True
        Save-NetGPO -GpoSession $gpoSession
        ```

#### <a name="modifying-domain-controller-association"></a>Изменение сопоставления контроллера домена
Для поддержания согласованности конфигурации в многосайтовом развертывании важно, чтобы каждым объектом групповой политики управлял один контроллер домена. В некоторых сценариях для объекта групповой политики может потребоваться назначить другой контроллер домена:

-   **Обслуживание и простой контроллер** домена. Если контроллер домена, управляющий объектом групповой политики, недоступен, может потребоваться управление объектом групповой политики на другом контроллере домена.

-   **Оптимизация распределения конфигурации**. После изменения сетевой инфраструктуры может потребоваться управление объектом групповой политики сервера точки входа на контроллере домена, расположенном на том же Active Directory сайте, что и точка входа.

## <a name="24-plan-dns"></a><a name="bkmk_2_4_DNS"></a>2,4. Планирование DNS
При планировании DNS для многосайтового развертывания обратите внимание на следующее:

1.  Клиентские компьютеры используют адрес ssASnoversion для подключения к серверу удаленного доступа. Каждой точке входа в развертывании требуется другой адрес ssASnoversion. Каждая точка входа ssASnoversion address должна быть доступна в общедоступной службе DNS, а выбранный адрес должен соответствовать имени субъекта сертификата IP-HTTPS, развертываемого для подключения IP-HTTPS.

2.  Кроме того, удаленный доступ обеспечивает симметричную маршрутизацию; Таким образом, при включении многосайтового развертывания могут подключаться только клиенты Teredo и IP-HTTPS. Чтобы разрешить локальным клиентам IPv6 подключаться, адрес ssASnoversion (URL-адрес IP-HTTPS) должен разрешаться как на внешний (с выходом в Интернет) IPv6-и IPv4-адреса на сервере удаленного доступа.

3.  Служба удаленного доступа создает веб-проба по умолчанию, которая используется клиентскими компьютерами DirectAccess для проверки подключения к внутренней сети. Во время настройки одного сервера в DNS должны быть зарегистрированы следующие имена:

    1.  DirectAccess — Вебпробехост — разрешение на внутренний IPv4-адрес сервера удаленного доступа или IPv6-адрес в среде только для IPv6.

    2.  DirectAccess — Корпконнективитихост — должен разрешаться в адрес localhost (петлевой) (:: 1 или 127.0.0.1 в зависимости от того, развернут ли IPv6 в корпоративной сети).

    В многосайтовом развертывании для каждой точки входа необходимо создать дополнительную запись DNS для DirectAccess-Вебпробехост. При добавлении точки входа удаленный доступ пытается автоматически создать эту дополнительную запись DirectAccess-Вебпробехост. Однако если это не удается, отобразится предупреждение и необходимо создать запись вручную.

    > [!NOTE]
    > При включении очистки DNS в инфраструктуре DNS рекомендуется отключить очистку записей DNS, создаваемых автоматически при удаленном доступе.






