---
title: Шаг 3 Настройка сервера удаленного доступа для OTP
description: Этот раздел является частью руководства развертывание удаленного доступа с проверкой подлинности OTP в Windows Server 2016.
manager: brianlic
ms.custom: na
ms.prod: windows-server-threshold
ms.reviewer: na
ms.suite: na
ms.technology: networking-ras
ms.tgt_pltfrm: na
ms.topic: article
ms.assetid: df1e87f2-6a0f-433b-8e42-816ae75395f9
ms.author: pashort
author: shortpatti
ms.openlocfilehash: 093877657f19006bba2b80c10b92db1fb3b40fde
ms.sourcegitcommit: afb0602767de64a76aaf9ce6a60d2f0e78efb78b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/20/2019
ms.locfileid: "67280866"
---
# <a name="step-3-configure-the-remote-access-server-for-otp"></a>Шаг 3 Настройка сервера удаленного доступа для OTP

>Область применения. Windows Server (полугодовой канал), Windows Server 2016

После настройки сервера RADIUS с маркерами распространения программного обеспечения, порты открыты, будет создан общий секрет, на сервере RADIUS будут созданы учетные записи пользователей, соответствующие Active Directory и на сервере удаленного доступа был настроен как агент проверки подлинности RADIUS, а затем сервер удаленного доступа должен быть настроен для поддержки OTP.  
  
|Задача|Описание|  
|----|--------|  
|[3.1 исключить пользователей из проверки подлинности OTP (необязательно)](#BKMK_Exempt)|Если конкретным пользователям, будут исключены DirectAccess с проверкой подлинности OTP, выполните следующие подготовительные действия.|  
|[3.2 настройки сервера удаленного доступа для поддержки OTP](#BKMK_Config)|На сервере удаленного доступа обновите конфигурацию удаленного доступа для поддержки двухфакторной проверки подлинности OTP.|  
|[3.3 смарт-карт для дополнительной авторизации](#BKMK_Smartcard)|Дополнительные сведения об использовании смарт-карт.|  
  
> [!NOTE]  
> В этом разделе приводятся примеры командлетов Windows PowerShell, которые можно использовать для автоматизации некоторых описанных процедур. Дополнительные сведения см. в разделе [Командлеты](https://go.microsoft.com/fwlink/p/?linkid=230693).  
  
## <a name="BKMK_Exempt"></a>3.1 исключить пользователей из проверки подлинности OTP (необязательно)  
При определенных пользователей требуется исключить из проверки подлинности OTP, эти действия необходимо выполнить до настройки удаленного доступа.  
  
> [!NOTE]  
> Необходимо дождаться репликации между доменами для завершения при настройке группы исключений OTP.  
  
#### <a name="create-user-exemption-security-group"></a>Создание группы безопасности для исключения пользователей  
  
1.  Создайте группу безопасности в Active Directory с целью освобождения OTP.  
  
2.  Добавьте всех пользователей, которые требуется исключить из проверки подлинности OTP в группу безопасности.  
  
    > [!NOTE]  
    > Убедитесь в том, что для включения только учетные записи пользователей и не учетные записи компьютеров, в группа безопасности исключений OTP.  
  
## <a name="BKMK_Config"></a>3.2 настройки сервера удаленного доступа для поддержки OTP  
Чтобы настроить удаленный доступ, использовать двухфакторную проверку подлинности и OTP с сервером RADIUS и развертывание сертификата из предыдущих разделов, следуйте инструкциям ниже:  
  
#### <a name="configure-remote-access-for-otp"></a>Настройка удаленного доступа для OTP  
  
1.  Откройте **управления удаленным доступом** и нажмите кнопку **конфигурации**.  
  
2.  В **установки DirectAccess** окна в разделе **шаг 2 - сервер удаленного доступа**, нажмите кнопку **изменить**.  
  
3.  Нажмите кнопку **Далее** три раза и в **проверки подлинности** разделе выберите оба **двухфакторной проверки подлинности** и **использовать OTP**и убедитесь, **использовать сертификаты компьютеров** проверяется.  
  
    > [!NOTE]  
    > После OTP включения на сервере удаленного доступа, если вы отключаете OTP, отменив выделение **использовать OTP**, расширения ISAPI и CGI будет удален на сервере.  
  
4.  Если требуется поддержка Windows 7, выберите **Разрешить Windows клиентским компьютерам 7 подключаться с помощью DirectAccess** "флажок". Примечание. Как уже обсуждалось в разделе планирования, клиенты Windows 7 должны иметь DCA 2.0 для поддержки функции DirectAccess с помощью OTP.  
  
5.  Нажмите кнопку **Далее**.  
  
6.  В **сервер RADIUS OTP** дважды щелкните пустую **имя_сервера** поля.  
  
7.  В **Добавление RADIUS-сервера** диалоговое окно, введите имя сервера RADIUS в **имя_сервера** поля. Нажмите кнопку **изменение** рядом с полем **общий секрет** поле и введите тот же пароль, который использовался при настройке сервера RADIUS в **новый секрет** и  **Подтверждение** поля. Нажмите кнопку **ОК** дважды и нажмите кнопку **Далее**.  
  
    > [!NOTE]  
    > Если сервер RADIUS находится в домене, который отличается от сервера удаленного доступа, а затем **имя_сервера** поле необходимо указать полное ДОМЕННОЕ имя сервера RADIUS.  
  
8.  В **серверы ЦС OTP** разделе Выберите серверы ЦС, использоваться для регистрации сертификатов проверки подлинности OTP клиента, а затем нажмите кнопку **добавить**. Нажмите кнопку **Далее**.  
  
9. В **шаблонов сертификатов для OTP** щелкните **Обзор** для выбора шаблона сертификата, используемого для подачи заявок на сертификаты, выданные для проверки подлинности OTP.  
  
    > [!NOTE]  
    > Без параметра «Не включают сведения отзыва в выданных сертификатов» должен быть настроен шаблон сертификата для OTP сертификаты, выпущенные корпоративным центром сертификации. Если этот параметр выбран при создании шаблона сертификата, OTP клиентских компьютеров удастся войти должным образом.  
  
    Нажмите кнопку **Обзор** для выбора шаблона сертификата, используемого для регистрации сертификата, используемый сервером удаленного доступа для входа запросы регистрации сертификата OTP. Нажмите кнопку **ОК**. Нажмите кнопку **Далее**.  
  
10. Если исключение отдельных пользователей из функции DirectAccess с помощью OTP является обязательным, а затем в **исключений OTP** разделе выберите **не требовать от пользователей в группе безопасности для проверки подлинности с помощью двухфакторной проверки подлинности** . Нажмите кнопку **группы безопасности** и выберите группу безопасности, который был создан для исключений OTP.  
  
11. На **установки сервера удаленного доступа** странице щелкните **Готово**.  
  
12. В **установки DirectAccess** окна в разделе **шаг 3 - серверы инфраструктуры**, нажмите кнопку **изменить**.  
  
13. Нажмите кнопку **Далее** два раза и в **управления** дважды щелкните раздел **серверы управления** поля.  
  
14. Введите **имя_компьютера** или **адрес** сервера ЦС, настроенный для выдачи сертификатов для OTP и щелкните **ОК**.  
  
15. В **Установка удаленного доступа** windows щелкните **Готово**.  
  
16. Нажмите кнопку **Готово** на **мастер DirectAccess Expert**.  
  
17. На **удаленном доступе** диалоговом окне **применить**, подождите для политики DirectAccess, чтобы обновить и нажмите кнопку **закрыть**.  
  
18. На **запустить** введите**powershell.exe**, щелкните правой кнопкой мыши **powershell**, нажмите кнопку **Дополнительно**и нажмите кнопку **Запуск от имени Администратор**. Если появится диалоговое окно **контроля учетных записей**, подтвердите, что отображаемое в нем действие именно то, которое требуется, и нажмите кнопку **Да**.  
  
19. В окне Windows PowerShell введите **gpupdate/force** и нажмите клавишу ВВОД.  
  
Чтобы настроить удаленный доступ для OTP, с помощью команд PowerShell:  
  
![Windows PowerShell](../../../../media/Step-3-Configure-the-Remote-Access-Server-for-OTP/PowerShellLogoSmall.gif)**эквивалентные команды Windows PowerShell**  
  
Следующие командлеты Windows PowerShell выполняют ту же функцию, что и предыдущая процедура. Вводите каждый командлет в одной строке, несмотря на то, что здесь они могут отображаться разбитыми на несколько строк из-за ограничений форматирования.  
  
Настройка удаленного доступа выполнять двухфакторную проверку подлинности для развертывания, в котором в настоящее время используется проверка подлинности сертификата компьютера.  
  
```  
Set-DAServer -UserAuthentication TwoFactor  
```  
  
Чтобы настроить удаленный доступ для использования проверки подлинности OTP, используя следующие параметры:  
  
-   OTP-сервер с именем OTP.corp.contoso.com.  
  
-   A CA server named APP1.corp.contoso.com\corp-APP1-CA1.  
  
-   Шаблон сертификата с именем DAOTPLogon, используемый для регистрации сертификатов, выданных для проверки подлинности OTP.  
  
-   Шаблон сертификата с именем DAOTPRA используется для регистрации сертификата центра регистрации, используемый сервером удаленного доступа для входа запросы регистрации сертификата OTP.  
  
```  
Enable-DAOtpAuthentication -CertificateTemplateName 'DAOTPLogon' -SigningCertificateTemplateName 'DAOTPRA' -CAServer @('APP1.corp.contoso.com\corp-APP1-CA1') -RadiusServer OTP.corp.contoso.com -SharedSecret Abcd123$  
```  
  
После выполнения команд PowerShell выполните шаги 12-19 из предыдущей процедуры для настройки сервера удаленного доступа для поддержки OTP.  
  
> [!NOTE]  
> Убедитесь в том, чтобы убедиться, что вы были применены параметры OTP на сервере удаленного доступа, прежде чем добавлять точку входа.  
  
## <a name="BKMK_Smartcard"></a>3.3 смарт-карт для дополнительной авторизации  
На странице "Проверка подлинности" шаг 2. Мастер настройки удаленного доступа может потребоваться использование смарт-карт для доступа к внутренней сети. Если этот параметр выбран, мастер настройки удаленного доступа настраивает правила безопасности подключения IPsec для туннеля интрасети на сервере DirectAccess требуется туннель режим авторизации с помощью смарт-карты. Туннельный режим авторизации позволяет возможность указать, что только авторизованные компьютеры или пользователи могут устанавливать туннель входящего трафика.  
  
Чтобы использовать смарт-карты с авторизацией режим туннелирования IPsec для туннеля интрасети, необходимо развернуть инфраструктуры открытых ключей (PKI) с помощью инфраструктуры смарт-карты.  
  
Так как клиенты DirectAccess при использовании смарт-карты для доступа к интрасети, контроль механизма проверки подлинности, в состав Windows Server 2008 R2, можно использовать для управления доступом к ресурсам, таким как файлы, папки и принтеры, в зависимости от пользователь вошел с помощью сертификата смарт карт. Контроль механизма проверки подлинности требует режима работы домена Windows Server 2008 R2.  
  
### <a name="allowing-access-for-users-with-unusable-smart-cards"></a>Разрешение доступа для пользователей с непригодным для использования смарт-карт  
Чтобы разрешить временный доступ для пользователей с помощью смарт-карт, которые были непригодны к использованию, сделайте следующее:  
  
1.  Создание группы безопасности Active Directory для учетных записей пользователей, которые временно не могут использовать свои смарт-карты.  
  
2.  Для объекта групповой политики сервера DirectAccess Настройка глобальных параметров IPsec для авторизации туннеля IPsec, и добавьте группу безопасности Active Directory в список авторизованных пользователей.  
  
Чтобы предоставить доступ для пользователей, которые нельзя использовать смарт-карте, временно добавляет их учетную запись пользователя в группу безопасности Active Directory. Удалите учетную запись из группы, когда можно использовать смарт-карты.  
  
### <a name="under-the-covers-smart-card-authorization"></a>На самом деле: Авторизация смарт-карты  
Действия авторизации смарт-карты, включив режим авторизации туннеля правила безопасности подключения туннель интрасети сервера DirectAccess для идентификатора на основе Kerberos безопасности (SID). Для авторизации смарт-карты это хорошо известного SID (S-1-5-65-1), которой сопоставляется входы на основе смарт-карты. Этот идентификатор присутствует в маркере Kerberos клиента DirectAccess и на него ссылается как «This организации Certificate» при настройке в глобальных IPsec туннель параметры авторизации режима.  
  
Когда вы включаете авторизации смарт-карты на шаге 2 мастера установки DirectAccess, мастер установки DirectAccess Настраивает глобальные настройки авторизации режим туннелирования IPsec с этот идентификатор безопасности для объекта групповой политики сервера DirectAccess. Чтобы просмотреть эту конфигурацию в брандмауэре Windows с оснасткой повышенной безопасности для объекта групповой политики сервера DirectAccess, сделайте следующее:  
  
1.  Брандмауэр Windows в режиме повышенной безопасности щелкните правой кнопкой мыши и выберите пункт Свойства.  
  
2.  На вкладке Параметры IPsec для проверки подлинности IPsec туннель нажмите кнопку "настроить".  
  
3.  Щелкните вкладку "пользователи". Вы должны увидеть «NT AUTHORITY\This организации Certificate» как авторизованного пользователя.  
  


