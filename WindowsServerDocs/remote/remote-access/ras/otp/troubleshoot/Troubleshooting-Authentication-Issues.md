---
title: Диагностика проблем с проверкой подлинности
description: Эта статья является частью руководств по развертыванию удаленного доступа с помощью проверки подлинности OTP в Windows Server 2016.
manager: brianlic
ms.topic: article
ms.assetid: 71307757-f8f4-4f82-b8b3-ffd4fd8c5d6d
ms.author: lizross
author: eross-msft
ms.openlocfilehash: 0cd438e26b014db9d051cd78e91f1a0a4bdf0a31
ms.sourcegitcommit: dfa48f77b751dbc34409aced628eb2f17c912f08
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/07/2020
ms.locfileid: "87958312"
---
# <a name="troubleshooting-authentication-issues"></a>Диагностика проблем с проверкой подлинности

>Область применения. Windows Server (Semi-Annual Channel), Windows Server 2016

В этом разделе содержатся сведения об устранении неполадок, связанных с проблемами, которые могут возникнуть у пользователей при попытке подключения к DirectAccess с помощью проверки подлинности OTP. События Директакцерсс, связанные с OTP, регистрируются на клиентском компьютере в Просмотр событий в разделе **журналы приложений и служб/Microsoft/Windows/отпкредентиалпровидер**. Убедитесь, что этот журнал включен при устранении проблем с OTP DirectAccess.

## <a name="failed-to-access-the-ca-that-issues-otp-certificates"></a>Не удалось получить доступ к центру сертификации, который выдает сертификаты OTP
**Сценарий**. Пользователю не удается проверить подлинность с помощью OTP с ошибкой: "сбой проверки подлинности из-за внутренней ошибки"

**Получено сообщение об ошибке** (журнал событий клиента). Не удалось зарегистрировать сертификат OTP для пользователя <username> на сервере цс <CA_name>, сбой запроса, возможные причины сбоя: не удается разрешить имя сервера ЦС, не удается получить доступ к серверу ЦС по первому туннелю DirectAccess, или не удается установить подключение к серверу ЦС.

**Причина**

Пользователь предоставил действительный одноразовый пароль и сервер DirectAccess подписан запрос на сертификат; Однако клиентский компьютер не может связаться с центром сертификации, который выдает сертификаты OTP, чтобы завершить процесс регистрации.

**Решение**

На сервере DirectAccess выполните следующие команды Windows PowerShell:

1.  Получите список настроенных центров сертификации для выдачи OTP и проверьте значение "Касервер":`Get-DAOtpAuthentication`

2.  Убедитесь, что центры сертификации настроены как серверы управления:`Get-DAMgmtServer -Type All`

3.  Убедитесь, что клиентский компьютер установил туннель инфраструктуры: в консоли Брандмауэр Windows в режиме повышенной безопасности разверните узел **мониторинг и безопасность**, щелкните **основной режим**и убедитесь, что сопоставления безопасности IPSec отображаются с правильными удаленными адресами для конфигурации DirectAccess.

## <a name="directaccess-server-connectivity-issues"></a>Проблемы с подключением к серверу DirectAccess
**Сценарий**. Пользователю не удается проверить подлинность с помощью OTP с ошибкой: "сбой проверки подлинности из-за внутренней ошибки"

**Получена ошибка** (журнал событий клиента)

Одна из следующих ошибок:

-   Не удается установить подключение к серверу удаленного доступа <DirectAccess_server_hostname> с использованием базового пути <OTP_authentication_path> и порта <OTP_authentication_port>. Код ошибки: <internal_error_code>.

-   Не удается отправить учетные данные пользователя на сервер удаленного доступа <DirectAccess_server_hostname> используя базовый путь <OTP_authentication_path> и Port <OTP_authentication_port>. Код ошибки: <internal_error_code>.

-   Не получен ответ от сервера удаленного доступа <DirectAccess_server_hostname> с использованием базового пути <OTP_authentication_path> и порта <OTP_authentication_port>. Код ошибки: <internal_error_code>.

**Причина**

Клиентский компьютер не может получить доступ к серверу DirectAccess через Интернет из-за проблем с сетью или неправильно настроенного сервера IIS на сервере DirectAccess.

**Решение**

Убедитесь, что подключение к Интернету на клиентском компьютере работает, и убедитесь, что служба DirectAccess запущена и доступна через Интернет.

## <a name="failed-to-enroll-for-the-directaccess-otp-logon-certificate"></a>Не удалось выполнить регистрацию для сертификата входа DirectAccess OTP
**Сценарий**. Пользователю не удается проверить подлинность с помощью OTP с ошибкой: "сбой проверки подлинности из-за внутренней ошибки"

**Получено сообщение об ошибке** (журнал событий клиента). Сбой при регистрации сертификата из центра сертификации <CA_name>. Запрос не подписан так, как ожидался сертификатом подписывания OTP, или у пользователя нет разрешения на регистрацию.

**Причина**

Одноразовый пароль, предоставленный пользователем, был правильным, но выдающий центр сертификации (CA) отклонил сертификат входа OTP. Возможно, запрос сертификата неправильно подписан с использованием правильного EKU (политика приложения центра регистрации OTP), или у пользователя нет разрешения "регистрация" в шаблоне OTP для DA.

**Решение**

Убедитесь, что у пользователей OTP DirectAccess есть разрешение на регистрацию сертификата входа DirectAccess и соответствующая политика приложения включена в шаблон подписи центра регистрации OTP для DA. Также убедитесь, что сертификат центра регистрации DirectAccess на сервере удаленного доступа является допустимым. См. статью 3,2. Планирование шаблона сертификата OTP и 3,3 Планирование сертификата центра регистрации.

## <a name="missing-or-invalid-computer-account-certificate"></a>Сертификат учетной записи компьютера отсутствует или недопустим
**Сценарий**. Пользователю не удается проверить подлинность с помощью OTP с ошибкой: "сбой проверки подлинности из-за внутренней ошибки"

**Получено сообщение об ошибке** (журнал событий клиента).  Не удается выполнить проверку подлинности OTP, так как сертификат компьютера, необходимый для OTP, не найден в хранилище сертификатов локального компьютера.

**Причина**

Для проверки подлинности DirectAccess методом OTP требуется сертификат клиентского компьютера, чтобы установить SSL-соединение с сервером DirectAccess. Однако сертификат клиентского компьютера не найден или является недопустимым, например, если срок действия сертификата истек.

**Решение**

Убедитесь, что сертификат компьютера существует и является допустимым:

1.  На клиентском компьютере в консоли сертификатов MMC для учетной записи локального компьютера откройте **Личные/сертификаты**.

2.  Убедитесь, что выдан сертификат, соответствующий имени компьютера, и дважды щелкните сертификат.

3.  В диалоговом окне **сертификат** на вкладке **путь к сертификату** в разделе **состояние сертификата**убедитесь, что указано "Этот сертификат хорошо".

Если действительный сертификат не найден, Удалите недопустимый сертификат (если он существует) и повторно выполните регистрацию для сертификата компьютера, либо запустив `gpupdate /Force` из командной строки с повышенными привилегиями, либо перезапустив клиентский компьютер.

## <a name="missing-ca-that-issues-otp-certificates"></a>Отсутствует ЦС, который выдает сертификаты OTP
**Сценарий**. Пользователю не удается проверить подлинность с помощью OTP с ошибкой: "сбой проверки подлинности из-за внутренней ошибки"

**Получено сообщение об ошибке** (журнал событий клиента). Не удается выполнить проверку подлинности OTP, так как сервер DA не вернул адрес выдающего ЦС.

**Причина**

Либо нет ЦС, которые выдают сертификаты OTP, либо все настроенные ЦС, которые выдают сертификаты OTP, не отвечают.

**Решение**

1.  Используйте следующую команду, чтобы получить список центров сертификации, выдающий сертификаты OTP (имя ЦС отображается в Касервер): `Get-DAOtpAuthentication` .

2.  Если ЦС не настроен:

    1.  Используйте команду `Set-DAOtpAuthentication` или консоль управления удаленным доступом для настройки центров сертификации, которые выдают сертификат входа DirectAccess.

    2.  Примените новую конфигурацию и принудительно обновите параметры объекта групповой политики DirectAccess, запустив `gpupdate /Force` из командной строки с повышенными привилегиями или перезапустив клиентский компьютер.

3.  Если настроены центры сертификации, убедитесь, что они находятся в сети и отвечают на запросы на регистрацию.

## <a name="misconfigured-directaccess-server-address"></a>Неправильно настроенный адрес сервера DirectAccess
**Сценарий**. Пользователю не удается проверить подлинность с помощью OTP с ошибкой: "сбой проверки подлинности из-за внутренней ошибки"

**Получено сообщение об ошибке** (журнал событий клиента). Проверка подлинности OTP не может быть выполнена должным образом. Невозможно определить имя или адрес сервера удаленного доступа.  Код ошибки: <error_code>. Параметры DirectAccess должны проверяться администратором сервера.

**Причина**

Неверно настроен адрес сервера DirectAccess.

**Решение**

Проверьте настроенный адрес сервера DirectAccess с помощью `Get-DirectAccess` и исправьте адрес, если он неправильно настроен.

Убедитесь, что на клиентском компьютере развернуты последние параметры, выполнив `gpupdate /force` команду из командной строки с повышенными привилегиями или перезапустите клиентский компьютер.

## <a name="failed-to-generate-the-otp-logon-certificate-request"></a>Не удалось создать запрос на сертификат входа OTP
**Сценарий**. Пользователю не удается проверить подлинность с помощью OTP с ошибкой: "сбой проверки подлинности из-за внутренней ошибки"

**Получено сообщение об ошибке** (журнал событий клиента). Не удается инициализировать запрос на сертификат для проверки подлинности OTP. Либо закрытый ключ не может быть создан, либо пользователь <username> не может получить доступ к шаблону сертификата <OTP_template_name> на контроллере домена.

**Причина**

Эта ошибка может быть вызвана двумя причинами.

-   У пользователя нет разрешения на чтение шаблона входа OTP.

-   Компьютер пользователя не может получить доступ к контроллеру домена из-за проблем с сетью.

**Решение**

-   Проверьте параметр разрешения в шаблоне входа OTP и убедитесь, что все пользователи, подготовленные для OTP DirectAccess, имеют разрешение "чтение".

-   Убедитесь, что контроллер домена настроен в качестве сервера управления и что клиентский компьютер может подключиться к контроллеру домена через туннель инфраструктуры. См. раздел 3,2. Планирование шаблона сертификата OTP.

## <a name="no-connection-to-the-domain-controller"></a>Нет подключения к контроллеру домена
**Сценарий**. Пользователю не удается проверить подлинность с помощью OTP с ошибкой: "сбой проверки подлинности из-за внутренней ошибки"

**Получено сообщение об ошибке** (журнал событий клиента). Не удается установить подключение к контроллеру домена с целью проверки подлинности OTP. Код ошибки: <error_code>.

**Причина**

Эта ошибка может быть вызвана двумя причинами.

-   Компьютер пользователя не подключен к сети.

-   Контроллер домена недоступен через туннель инфраструктуры.

**Решение**

-   Убедитесь, что контроллер домена настроен в качестве сервера управления, выполнив следующую команду в командной строке PowerShell: `Get-DAMgmtServer -Type All` .

-   Убедитесь, что клиентский компьютер может подключиться к контроллеру домена через туннель инфраструктуры.

## <a name="otp-provider-requires-challengeresponse"></a>Для поставщика OTP требуется запрос/ответ
**Сценарий**. Пользователю не удается проверить подлинность с помощью OTP с ошибкой: "сбой проверки подлинности из-за внутренней ошибки"

**Получено сообщение об ошибке** (журнал событий клиента). Проверка подлинности OTP с помощью сервера удаленного доступа (<DirectAccess_server_name>) для пользователя ( <username> ) требует от пользователя запроса.

**Причина**

Используемый поставщик OTP требует, чтобы пользователь предоставил дополнительные учетные данные в виде обмена запросами/ответами RADIUS, который не поддерживается OTP в Windows Server 2012 DirectAccess.

**Решение**

Настройте поставщик OTP, чтобы не требовать вызова или ответа в любом сценарии.

## <a name="incorrect-otp-logon-template-used"></a>Использован неправильный шаблон входа OTP
**Сценарий**. Пользователю не удается проверить подлинность с помощью OTP с ошибкой: "сбой проверки подлинности из-за внутренней ошибки"

**Получено сообщение об ошибке** (журнал событий клиента). Шаблон ЦС, из которого пользователь <username> запросил сертификат, не настроен на выдачу сертификатов OTP.

**Причина**

Шаблон входа DirectAccess с методом OTP был заменен, и клиентский компьютер пытается пройти проверку подлинности с помощью старого шаблона.

**Решение**

Убедитесь, что клиентский компьютер использует последнюю конфигурацию OTP, выполнив одно из следующих действий.

-   Выполните принудительное обновление групповая политика, выполнив следующую команду в командной строке с повышенными привилегиями: `gpupdate /Force` .

-   Перезапустите клиентский компьютер.

## <a name="missing-otp-signing-certificate"></a>Отсутствует сертификат для подписи OTP
**Сценарий**. Пользователю не удается проверить подлинность с помощью OTP с ошибкой: "сбой проверки подлинности из-за внутренней ошибки"

**Получено сообщение об ошибке** (журнал событий клиента). Не удается найти сертификат для подписи OTP. Запрос на регистрацию сертификата OTP не может быть подписан.

**Причина**

Не удается найти сертификат подписи OTP DirectAccess на сервере удаленного доступа; Поэтому сервер удаленного доступа не может подписать запрос на сертификат пользователя. Сертификат для подписи отсутствует, или истек срок действия сертификата для подписи, и он не был продлен.

**Решение**

Выполните эти действия на сервере удаленного доступа.

1.  Проверьте настроенное имя шаблона сертификата для подписи OTP, выполнив командлет PowerShell и изменив `Get-DAOtpAuthentication` значение `SigningCertificateTemplateName` .

2.  Используйте оснастку MMC "сертификаты", чтобы убедиться, что на компьютере существует действительный сертификат, зарегистрированный на этом шаблоне.

3.  Если такого сертификата не существует, удалите сертификат с истекшим сроком действия (если он существует) и зарегистрируйте новый сертификат на основе этого шаблона.

Чтобы создать шаблон сертификата для подписи OTP, см. 3,3. Планирование сертификата центра регистрации.

## <a name="missing-or-incorrect-upndn-for-the-user"></a>Отсутствует или имеет неверный UPN/DN для пользователя
**Сценарий**. Пользователю не удается проверить подлинность с помощью OTP с ошибкой: "сбой проверки подлинности из-за внутренней ошибки"

**Получена ошибка** (журнал событий клиента)

Одна из следующих ошибок:

-   <username>Проверка подлинности пользователя с помощью OTP невозможна. Убедитесь, что имя участника-пользователя определено в Active Directory. Код ошибки: <error_code>.

-   <username>Проверка подлинности пользователя с помощью OTP невозможна. Убедитесь, что для имени пользователя в Active Directory определено РАЗЛИЧАЮЩЕеся имя. Код ошибки: <error_code>.

**Получена ошибка** (журнал событий сервера)

Имя пользователя, <username> указанное для проверки подлинности OTP, не существует.

**Причина**

Пользователь не имеет правильно заданных атрибутов имени участника-пользователя (UPN) или различающегося имени (DN) в учетной записи пользователя. Эти свойства необходимы для правильной работы OTP DirectAccess.

**Решение**

Используйте консоль Active Directory пользователи и компьютеры на контроллере домена, чтобы убедиться, что оба этих атрибута правильно установлены для пользователя, выполняющего проверку подлинности.

## <a name="otp-certificate-is-not-trusted-for-login"></a>Сертификат OTP не является доверенным для входа
**Сценарий**. Пользователю не удается проверить подлинность с помощью OTP с ошибкой: "сбой проверки подлинности из-за внутренней ошибки"

**Причина**

Центр сертификации, который выдает сертификаты OTP, отсутствует в корпоративном хранилище NTAuth; Поэтому зарегистрированные сертификаты нельзя использовать для входа в систему. Это может произойти в средах с несколькими доменами и в нескольких лесах, если доверие между доменами ЦС не установлено.

**Решение**

Убедитесь, что сертификат корня иерархии ЦС, который выдает сертификаты OTP, установлен в хранилище сертификатов Enterprise NTAuth домена, в который пользователь пытается пройти проверку подлинности.

## <a name="windows-could-not-verify-user-credentials"></a>Windows не удалось проверить учетные данные пользователя
**Сценарий**. Пользователю не удается проверить подлинность с помощью OTP с ошибкой: "сбой проверки подлинности из-за внутренней ошибки"

**Получено сообщение об ошибке** (клиентский компьютер). Что-то пошло не так, когда Windows проверит ваши учетные данные. Повторите попытку или обратитесь за помощью к администратору.

**Причина**

Протокол проверки подлинности Kerberos не работает, если сертификат входа DirectAccess OTP не включает список отзыва сертификатов. Сертификат входа DirectAccess OTP не включает список отзыва сертификатов, так как:

-   Шаблон входа DirectAccess с методом OTP настроен с параметром **не включать сведения об отзыве в выданные сертификаты**.

-   ЦС настроен не для публикации списков отзыва сертификатов.

**Решение**

1.  Чтобы проверить причину этой ошибки, в консоли управления удаленным доступом на **шаге 2 сервера удаленного доступа**нажмите кнопку **изменить**, а затем в мастере **установки сервера удаленного доступа** щелкните **шаблоны сертификатов OTP**. Запишите шаблон сертификата, используемый для регистрации сертификатов, выданных для проверки подлинности OTP. Откройте консоль центра сертификации, в левой области щелкните **шаблоны сертификатов**, дважды щелкните сертификат входа OTP, чтобы просмотреть свойства шаблона сертификата.

    Чтобы устранить эту проблему, настройте сертификат для сертификата входа OTP и не выбирайте флажок не **включать сведения об отзыве в выданные сертификаты** на вкладке **сервер** диалогового окна Свойства шаблона.

2.  На сервере ЦС откройте MMC центра сертификации, щелкните правой кнопкой мыши выдающий ЦС и выберите пункт **Свойства**. На вкладке **расширения** убедитесь, что публикация списков отзыва сертификатов настроена правильно.



