---
title: Развертывание удаленного доступа с проверкой подлинности методом OTP
description: Эта статья является частью руководств по развертыванию удаленного доступа с помощью проверки подлинности OTP в Windows Server 2016.
manager: brianlic
ms.custom: na
ms.prod: windows-server
ms.reviewer: na
ms.suite: na
ms.technology: networking-ras
ms.tgt_pltfrm: na
ms.topic: article
ms.assetid: b1b2fe70-7956-46e8-a3e3-43848868df09
ms.author: pashort
author: shortpatti
ms.openlocfilehash: d0de5f459e31e1dfac40e49cd6cc83de8722df4d
ms.sourcegitcommit: 6aff3d88ff22ea141a6ea6572a5ad8dd6321f199
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/27/2019
ms.locfileid: "71404427"
---
# <a name="deploy-remote-access-with-otp-authentication"></a>Развертывание удаленного доступа с проверкой подлинности методом OTP

>Область применения: Windows Server (Semi-Annual Channel), Windows Server 2016

 Windows Server 2016 и Windows Server 2012 объединяют службы DirectAccess и маршрутизации и удаленного доступа \(RRAS\) VPN в одну роль удаленного доступа.   

## <a name="BKMK_OVER"></a>Описание сценария  
В этом сценарии сервер удаленного доступа с включенной DirectAccess настроен для проверки подлинности пользователей клиента DirectAccess с двумя\-одноразовым паролем \(OTP\) проверки подлинности в дополнение к стандартным учетным данным Active Directory.  
  
## <a name="prerequisites"></a>Предварительные условия  
Перед началом развертывания этого сценария ознакомьтесь со списком важных требований.  
  
-   Перед развертыванием OTP необходимо [развернуть один сервер DirectAccess с дополнительными параметрами](../../directaccess/single-server-advanced/Deploy-a-Single-DirectAccess-Server-with-Advanced-Settings.md) .  
  
-   Клиенты Windows 7 должны использовать DCA 2,0 для поддержки OTP.  
  
-   OTP не поддерживает изменение ПИН-кода.  
  
-   Должна быть развернута инфраструктура открытого ключа.  
  
    Дополнительная информация: [Мини-модуль руководства по лаборатории тестирования: Базовая PKI для Windows Server 2012.](https://social.technet.microsoft.com/wiki/contents/articles/7862.test-lab-guide-mini-module-basic-pki-for-windows-server-2012.aspx)  
  
-   Изменение политик за пределами консоли управления DirectAccess или командлетов Windows PowerShell не поддерживается.  
  
## <a name="in-this-scenario"></a>Содержание сценария  
Сценарий проверки подлинности с помощью OTP включает несколько этапов.  
  
1.  [Разверните один сервер DirectAccess с дополнительными параметрами](../../directaccess/single-server-advanced/Deploy-a-Single-DirectAccess-Server-with-Advanced-Settings.md). Перед настройкой OTP необходимо развернуть один сервер удаленного доступа. На этапе планирования и развертывания на одном сервере выполняется проектирование и настройка топологии сети, планирование и развертывание сертификатов, установка DNS и Active Directory, настройка параметров сервера удаленного доступа, развертывание клиентов DirectAccess и подготовка серверов интрасети.  
  
2.  [Планирование удаленного доступа с помощью проверки подлинности OTP](https://docs.microsoft.com/windows-server/remote/remote-access/ras/otp/plan/plan-remote-access-with-otp-authentication). Помимо планирования, необходимого для отдельного сервера, для OTP требуется планирование центра сертификации Майкрософт \(\) ЦС и шаблонов сертификатов для OTP; и RADIUS-сервер\-с поддержкой OTP. Кроме того, планирование может включать в себя требование для групп безопасности, чтобы исключить определенных пользователей из надежных \(OTP или смарт-карт\) проверки подлинности. Сведения о конфигурации OTP в среде с несколькими\-ными лесами см. в разделе [Настройка развертывания с несколькими лесами](../../ras/multi-forest/Configure-a-Multi-Forest-Deployment.md).  
  
3.  [Настройка DirectAccess с проверкой подлинности OTP](/configure/Configure-RA-with-OTP-Authentication.md). Развертывание OTP состоит из нескольких этапов настройки, включая подготовку инфраструктуры для проверки подлинности OTP, настройку сервера OTP, настройку параметров OTP на сервере удаленного доступа и обновление параметров клиента DirectAccess.  
  
4.  [Устранение неполадок при развертывании OTP] ((/Траублешут/траублешут-ан-ОТП-деплоймент.МД). В этом разделе по устранению неполадок описываются наиболее распространенные ошибки, которые могут возникнуть при развертывании удаленного доступа с помощью проверки подлинности OTP.  
  
## <a name="BKMK_APP"></a>Практические приложения  
Повышение безопасности. Использование OTP повышает безопасность развертывания DirectAccess. Чтобы получить доступ к внутренней сети, пользователь должен предоставить учетные данные OTP. Пользователь предоставляет учетные данные OTP через подключения на рабочем месте, доступные в сетевых подключениях на клиентском компьютере Windows 10 или Windows 8, или с помощью помощника по подключению DirectAccess \(DCA\) на клиентских компьютерах под управлением Windows 7. Процесс проверки подлинности с помощью OTP происходит следующим образом.  
  
1.  Клиент DirectAccess вводит учетные данные домена для доступа к серверам инфраструктуры DirectAccess \(через\)туннеля инфраструктуры.  Если в результате сбоя IKE отсутствуют доступные подключения к внутренней сети, компонент подключения к рабочему месту на клиентском компьютере уведомляет пользователя о необходимости предоставить учетные данные. На клиентских компьютерах, работающих под управлением Windows 7, появится POP\-попросите учетные данные смарт-карты.  
  
2.  После ввода учетных данных OTP они отправляются по протоколу SSL на сервер удаленного доступа вместе с запросом короткого\-ного сертификата входа с использованием смарт-карты.  
  
3.  Сервер удаленного доступа инициирует проверку учетных данных OTP с помощью сервера OTP на основе RADIUS\-.  
  
4.  В случае успешной проверки сервер удаленного доступа подписывает запрос на сертификат с использованием своего сертификата центра регистрации и отправляет его обратно на компьютер клиента DirectAccess  
  
5.  Клиентский компьютер DirectAccess перенаправляет подписанный сертификат в ЦС и сохраняет зарегистрированный сертификат для использования поставщиком общих служб Kerberos\/AP.  
  
6.  С помощью этого сертификата клиентский компьютер выполняет проверку подлинности Kerberos с использованием смарт-карты прозрачно для пользователя.  
  
## <a name="BKMK_NEW"></a>Роли и компоненты, входящие в этот сценарий  
В следующей таблице перечислены роли и компоненты, необходимые для сценария.  
  
|Функция\/ролей|Способ поддержки сценария|  
|---------|-----------------|  
|*Роль управления удаленным доступом*|Эта роль устанавливается и удаляется с помощью консоли Диспетчера серверов. Эта роль охватывает DirectAccess, который ранее был компонентом в Windows Server 2008 R2, а также службами маршрутизации и удаленного доступа, которые ранее были службой роли в службах политики сети и доступа \(NPAS\) Server Role. Роль удаленного доступа включает два компонента.<br /><br />1. службы DirectAccess и маршрутизации и удаленного доступа \(RRAS\) VPN. Управление DirectAccess и VPN осуществляется вместе в консоли управления удаленным доступом.<br />2. Маршрутизация RRAS. Управление функциями маршрутизации RRAS осуществляется с помощью устаревшей консоли маршрутизации и удаленного доступа.<br /><br />Роль удаленного доступа зависит от следующих компонентов сервера:<br /><br />-Службы IIS \(IIS\) веб-сервер. Эта функция необходима для настройки сервера сетевых расположений, использования проверки подлинности OTP и настройки веб-пробы по умолчанию.<br />— Внутренняя база данных Windows — используется для локального учета на сервере удаленного доступа.|  
|Средства управления удаленным доступом|Этот компонент устанавливается описанным ниже образом.<br /><br />— Он устанавливается по умолчанию на сервере удаленного доступа при установке роли удаленного доступа и поддерживает пользовательский интерфейс консоли удаленного управления.<br />— Его можно дополнительно установить на сервере, на котором не запущена роль сервера удаленного доступа. В этом случае компонент используется для удаленного управления компьютером с возможностью удаленного доступа, на котором установлены DirectAccess и VPN.<br /><br />Средства управления удаленным доступом включают следующие элементы:<br /><br />— Графический интерфейс удаленного доступа и средства командной строки<br />— Модуль удаленного доступа для Windows PowerShell<br /><br />Зависимости включают следующее:<br /><br />— Консоль управления групповыми политиками<br />— Пакет администрирования диспетчера подключений RAS \(CMAK\)<br />— Windows PowerShell 3,0<br />-Графические средства управления и инфраструктура|  
  
## <a name="BKMK_HARD"></a>Требования к оборудованию  
Для этого сценария действуют следующие требования к оборудованию.  
  
-   Компьютер, отвечающий требованиям к оборудованию для Windows Server 2016 или Windows Server 2012.  
  
-   Чтобы протестировать сценарий, требуется по крайней мере один компьютер под управлением Windows 10, Windows 8 или Windows 7, настроенный в качестве клиента DirectAccess.  
  
-   OTP-сервер с поддержкой протокола PAP через RADIUS.  
  
-   Аппаратный или программный OTP-токен.  
  
## <a name="BKMK_SOFT"></a>Требования к программному обеспечению  
Для этого сценария действуют следующие требования.  
  
1.  Требования к программному обеспечению для развертывания на одном сервере. Дополнительные сведения см. в статье [развертывание одного сервера DirectAccess с дополнительными параметрами](../../directaccess/single-server-advanced/Deploy-a-Single-DirectAccess-Server-with-Advanced-Settings.md).  
  
2.  Помимо требований к программному обеспечению для одного сервера, существует ряд специальных требований OTP\-.  
  
    1.  Центр сертификации для проверки подлинности по протоколу IPsec. для развертывания OTP необходимо развернуть DirectAccess с помощью сертификатов компьютеров IPsec, выданных центром сертификации. Проверка подлинности методом IPsec с использованием сервера удаленного доступа в качестве прокси-сервера Kerberos в сценарии развертывания с OTP не поддерживается. Необходим внутренний центр сертификации.  
  
    2.  ЦС для проверки подлинности OTP. центр сертификации Microsoft Enterprise \(работает на Windows 2003 Server или более поздней версии\) требуется для выдаче сертификата клиента OTP. Можно использовать тот же ЦС, который используется для выдачи сертификатов для проверки подлинности методом IPsec. Сервер ЦС должен быть доступен по первому туннелю инфраструктуры.  
  
    3.  Группа безопасности. чтобы исключить пользователей из надежной проверки подлинности, требуется группа безопасности Active Directory, содержащая этих пользователей.  
  
    4.  Клиентские\-требования для клиентских компьютеров Windows 10 и Windows 8. Помощник по подключению к сети \(служба\) NCA используется для определения необходимости использования учетных данных OTP. Если это так, диспетчер носителей DirectAccess запрашивает учетные данные.  NCA включен в операционную систему, и установка или развертывание не требуются. Для клиентских компьютеров Windows 7 требуется помощник по подключению DirectAccess \(DCA\) 2,0. Этот компонент можно загрузить в [Центре загрузки Майкрософт](https://www.microsoft.com/download/details.aspx?id=29039).  
  
    5.  Примите к сведению следующее.  
  
        1.  Проверку подлинности OTP можно использовать параллельно со смарт-картой и доверенный платформенный модуль (TPM) \(доверенного платформенного модуля\)\-на основе проверки подлинности. Включение проверки подлинности методом OTP в консоли управления удаленным доступом также позволяет использовать проверку подлинности с помощью смарт-карты.  
  
        2.  Во время настройки удаленного доступа пользователи в указанной группе безопасности могут быть исключены из двух\-факторной проверки подлинности и, таким же, проходят проверку подлинности только с именем пользователя\/пароля.  
  
        3.  Такие режимы OTP, как "новый пин-код" и "следующий код токена", не поддерживаются.  
  
        4.  В мультисайтовом сценарии развертывания удаленного доступа параметры OTP являются глобальными и определяются для всех точек входа. Если для OTP настроены несколько RADIUS-серверов или ЦС, то они сортируются каждым сервером удаленного доступа по степени доступности и близости.  
  
        5.  При настройке OTP в среде удаленного доступа с несколькими\-ами ЦС OTP должны быть только из леса ресурсов, а регистрация сертификатов должна быть настроена в отношениях доверия лесов. Дополнительные сведения см. в разделе [Служба сертификации Active Directory: регистрация сертификатов при переходе между лесами в Windows Server 2008 R2](https://technet.microsoft.com/library/ff955842.aspx).  
  
        6.  Пользователи, которые используют маркер ключа ФОБ OTP, должны вставить ПИН-код, за которым следует токенкоде \(без разделителей\) в диалоговом окне OTP DirectAccess. Пользователи, использующие OTP-токен PIN PAD, должны вставить в это диалоговое окно только код токена.  
  
        7.  Если включен протокол WEBDAV, не следует включать OTP.  
  
## <a name="KnownIssues"></a>Известные проблемы  
Ниже приводятся известные проблемы, возникающие при настройке сценария OTP.  
  
-   Удаленный доступ использует механизм пробы для проверки подключения к серверам OTP на основе RADIUS\-. В некоторых случаях это может привести к возникновению ошибки на сервере OTP. Чтобы избежать этой проблемы, выполните на сервере OTP следующие действия.  
  
    -   Создайте для механизма пробы учетную запись пользователя, соответствующую имени пользователя и пароля, настроенным на сервере удаленного доступа. Имя пользователя не должно определять пользователя Active Directory.  
  
        По умолчанию имя пользователя на сервере удаленного доступа — DAProbeUser, а пароль — DAProbePass. Эти параметры по умолчанию можно изменить, используя следующие значения в реестре на сервере удаленного доступа:  
  
        -   HKEY\_локальный\_компьютер\\программное обеспечение\\Microsoft\\DirectAccess\\OTP\\Радиуспробеусер  
  
        -   HKEY\_локальный\_компьютер\\программное обеспечение\\Microsoft\\DirectAccess\\OTP\\ Радиуспробепасс  
  
-   Если изменить корневой сертификат IPsec в настроенном и работающем развертывании DirectAccess, OTP перестает работать. Чтобы устранить эту проблему, на каждом сервере DirectAccess в командной строке Windows PowerShell выполните команду: `iisreset`  
  
