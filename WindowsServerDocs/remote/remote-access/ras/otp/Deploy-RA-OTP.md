---
title: Развертывание удаленного доступа с проверкой подлинности методом OTP
description: Этот раздел является частью руководства развертывание удаленного доступа с проверкой подлинности OTP в Windows Server 2016.
manager: brianlic
ms.custom: na
ms.prod: windows-server-threshold
ms.reviewer: na
ms.suite: na
ms.technology: networking-ras
ms.tgt_pltfrm: na
ms.topic: article
ms.assetid: b1b2fe70-7956-46e8-a3e3-43848868df09
ms.author: pashort
author: shortpatti
ms.openlocfilehash: ecb4503c6f8cbc08f2175a33a41929491e4a2b7f
ms.sourcegitcommit: 0d0b32c8986ba7db9536e0b8648d4ddf9b03e452
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2019
ms.locfileid: "59811995"
---
# <a name="deploy-remote-access-with-otp-authentication"></a>Развертывание удаленного доступа с проверкой подлинности методом OTP

>Область применения. Windows Server (полугодовой канал), Windows Server 2016

 Windows Server 2016 и Windows Server 2012 объединить DirectAccess и службы маршрутизации и удаленного доступа \(RRAS\) VPN в единую роль удаленного доступа.   

## <a name="BKMK_OVER"></a>Описание сценария  
В этом сценарии удаленного доступа сервер с включенным компонентом DirectAccess настроен для проверки подлинности пользователей клиента DirectAccess с двумя\-одноразового пароля коэффициент \(OTP\) проверки подлинности, помимо стандартных активный Учетные данные каталога.  
  
## <a name="prerequisites"></a>Предварительные требования  
Перед началом развертывания этого сценария ознакомьтесь со списком важных требований.  
  
-   [Развертывание одиночного сервера DirectAccess с расширенными параметрами](../../directaccess/single-server-advanced/Deploy-a-Single-DirectAccess-Server-with-Advanced-Settings.md) должны быть развернуты перед развертыванием OTP.  
  
-   Для поддержки OTP клиенты Windows 7 необходимо использовать DCA 2.0.  
  
-   OTP не поддерживает изменение ПИН-кода.  
  
-   Должна быть развернута инфраструктура открытого ключа.  
  
    Подробную информацию см. в следующих разделах: [Проверьте мини-модуль руководства по лаборатории: Базовая PKI для Windows Server 2012.](https://social.technet.microsoft.com/wiki/contents/articles/7862.test-lab-guide-mini-module-basic-pki-for-windows-server-2012.aspx)  
  
-   Изменение политик вне консоли управления DirectAccess или командлетов Windows PowerShell не поддерживается.  
  
## <a name="in-this-scenario"></a>Содержание сценария  
Сценарий проверки подлинности с помощью OTP включает несколько этапов.  
  
1.  [Развертывание одиночного сервера DirectAccess с расширенными параметрами](../../directaccess/single-server-advanced/Deploy-a-Single-DirectAccess-Server-with-Advanced-Settings.md). До настройки OTP необходимо выполнить развертывание одного сервера удаленного доступа. На этапе планирования и развертывания на одном сервере выполняется проектирование и настройка топологии сети, планирование и развертывание сертификатов, установка DNS и Active Directory, настройка параметров сервера удаленного доступа, развертывание клиентов DirectAccess и подготовка серверов интрасети.  
  
2.  [Планирование удаленного доступа с проверкой подлинности OTP](https://docs.microsoft.com/windows-server/remote/remote-access/ras/otp/plan/plan-remote-access-with-otp-authentication). Вдобавок к планированию, необходимые для одного сервера, необходимо Включить в планирование центр сертификации Майкрософт \(ЦС\) и шаблонов сертификатов для OTP; и РАДИУС\-сервер OTP с поддержкой. Планирование также может включать требования для групп безопасности, чтобы исключить определенных пользователей из строгой \(OTP или смарт-карты\) проверки подлинности. Сведения о конфигурации OTP в с несколькими\-леса среды, см. в разделе [Настройка Многолесового развертывания](../../ras/multi-forest/Configure-a-Multi-Forest-Deployment.md).  
  
3.  [Настройка DirectAccess с проверкой подлинности OTP](/configure/Configure-RA-with-OTP-Authentication.md). Развертывание OTP состоит из нескольких этапов настройки, включая подготовку инфраструктуры для проверки подлинности OTP, настройку сервера OTP, настройку параметров OTP на сервере удаленного доступа и обновление параметров клиента DirectAccess.  
  
4.  [Устранение неполадок развертывания с OTP] ((/troubleshoot/Troubleshoot-an-OTP-Deployment.md). Этот раздел по устранению неполадок описываются некоторые наиболее распространенные ошибки, которые могут возникнуть при развертывании удаленного доступа с проверкой подлинности OTP.  
  
## <a name="BKMK_APP"></a>Практическое применение  
Повышение безопасности с помощью OTP повышает безопасность развертывания DirectAccess. Чтобы получить доступ к внутренней сети, пользователь должен предоставить учетные данные OTP. Пользователь предоставляет учетные данные OTP через подключения к рабочему месту, доступных в сетевых подключениях на клиентском компьютере Windows 10 или Windows 8 или с помощью помощника по подключению к DirectAccess \(DCA\) на клиентских компьютерах под управлением Windows 7. Процесс проверки подлинности с помощью OTP происходит следующим образом.  
  
1.  Клиент DirectAccess предоставляет учетные данные домена для доступа к серверам инфраструктуры DirectAccess \(через туннель инфраструктуры\).  Если в результате сбоя IKE отсутствуют доступные подключения к внутренней сети, компонент подключения к рабочему месту на клиентском компьютере уведомляет пользователя о необходимости предоставить учетные данные. На клиентских компьютерах под управлением Windows 7, pop\-вверх запрашивает учетные данные смарт-карты отображается.  
  
2.  После ввода учетных данных OTP, они отправляются по протоколу SSL для сервера удаленного доступа, вместе с запросом short\-сертификат входа термин смарт-карты.  
  
3.  Сервер удаленного доступа инициирует проверку учетных данных OTP радиуса\-на основе сервера OTP.  
  
4.  В случае успешной проверки сервер удаленного доступа подписывает запрос на сертификат с использованием своего сертификата центра регистрации и отправляет его обратно на компьютер клиента DirectAccess  
  
5.  Клиент DirectAccess отправляет запрос на сертификат в ЦС и сохраняет зарегистрированный сертификат для использования в Kerberos SSP\/AP.  
  
6.  С помощью этого сертификата клиентский компьютер выполняет проверку подлинности Kerberos с использованием смарт-карты прозрачно для пользователя.  
  
## <a name="BKMK_NEW"></a>Роли и компоненты, используемые в данном сценарии  
В следующей таблице перечислены роли и компоненты, необходимые для сценария.  
  
|Роль\/функция|Способ поддержки сценария|  
|---------|-----------------|  
|*Роль управления удаленным доступом*|Эта роль устанавливается и удаляется с помощью консоли Диспетчера серверов. Эта роль включает как DirectAccess, который раньше был компонентом Windows Server 2008 R2 и службы маршрутизации и служб удаленного доступа, который ранее был служба роли в сетевой политики и доступа к службам \(NPAS\) сервера роль. Роль удаленного доступа включает два компонента.<br /><br />1.  DirectAccess и службы маршрутизации и удаленного доступа службы \(RRAS\) VPN DirectAccess и VPN осуществляется через одну консоль управления удаленным доступом.<br />2.  Управление компонентами маршрутизации RRAS маршрутизации-RRAS осуществляется с устаревших консоль маршрутизации и удаленного доступа.<br /><br />Роль удаленного доступа зависит от следующих компонентов сервера:<br /><br />-Службы IIS \(IIS\) веб-сервер — данный компонент необходим для настройки сервера сетевых расположений, использования проверки подлинности OTP и настройки веб-пробы по умолчанию.<br />-Внутренняя Database-Used Windows для локального учета на сервере удаленного доступа.|  
|Средства управления удаленным доступом|Этот компонент устанавливается описанным ниже образом.<br /><br />— Он устанавливается по умолчанию на сервере удаленного доступа при установке роли удаленного доступа, а также поддерживает пользовательский интерфейс консоли удаленного управления.<br />— Его можно при необходимости установить на сервере, не использующем роль сервера удаленного доступа. В этом случае компонент используется для удаленного управления компьютером с возможностью удаленного доступа, на котором установлены DirectAccess и VPN.<br /><br />Средства управления удаленным доступом включают следующие элементы:<br /><br />-Графический интерфейс пользователя удаленного доступа и программы командной строки<br />-Модуль удаленного доступа для Windows PowerShell<br /><br />Зависимости включают следующее:<br /><br />-Консоль управления групповыми политиками<br />-Пакет администрирования диспетчера подключений RAS \(пакета администрирования диспетчера Подключений\)<br />— Windows PowerShell 3.0<br />-Графические средства управления и инфраструктуры|  
  
## <a name="BKMK_HARD"></a>Требования к оборудованию  
Для этого сценария действуют следующие требования к оборудованию.  
  
-   Компьютер, который соответствует требованиям к оборудованию для Windows Server 2016 или Windows Server 2012.  
  
-   Для проверки данного сценария, необходим по крайней мере один компьютер под управлением Windows 10, Windows 8 или Windows 7, настроенный в качестве клиента DirectAccess.  
  
-   OTP-сервер с поддержкой протокола PAP через RADIUS.  
  
-   Аппаратный или программный OTP-токен.  
  
## <a name="BKMK_SOFT"></a>Требования к программному обеспечению  
Для этого сценария действуют следующие требования.  
  
1.  Требования к программному обеспечению для развертывания на одном сервере. Дополнительные сведения см. в разделе [развертывание одиночного сервера DirectAccess с расширенными параметрами](../../directaccess/single-server-advanced/Deploy-a-Single-DirectAccess-Server-with-Advanced-Settings.md).  
  
2.  Требования к программному обеспечению для одного сервера дополняются ряд OTP\-конкретных требований:  
  
    1.  ЦС для IPsec проверки подлинности в сценарии развертывания с OTP, DirectAccess должны быть развернуты с помощью IPsec машинами сертификаты, выданные ЦС; Проверка подлинности методом IPsec с использованием сервера удаленного доступа в качестве прокси-сервера Kerberos в сценарии развертывания с OTP не поддерживается. Необходим внутренний центр сертификации.  
  
    2.  ЦС для OTP типа проверки подлинности Майкрософт ЦС предприятия \(на Windows 2003 Server или более поздней версии\) необходим для выдачи сертификата клиента OTP. Можно использовать тот же ЦС, который используется для выдачи сертификатов для проверки подлинности методом IPsec. Сервер ЦС должен быть доступен по первому туннелю инфраструктуры.  
  
    3.  Безопасность группы, чтобы исключить пользователей из строгой проверки подлинности, группу безопасности Active Directory, содержащую этих пользователей является обязательным.  
  
    4.  Клиент\-требования — для Windows 10 и Windows 8 клиентских компьютеров, помощник по подключению к сети \(NCA\) службы используется для обнаружения, требуются ли учетные данные OTP. Если они являются DirectAccess, Media Manager запрашивает учетные данные.  NCA включается в операционной системе, и установка или развертывание является обязательным. Для компьютеров клиентов Windows 7, помощник по подключению к DirectAccess \(DCA\) 2.0 является обязательным. Этот компонент можно загрузить в [Центре загрузки Майкрософт](https://www.microsoft.com/download/details.aspx?id=29039).  
  
    5.  Обратите внимание на следующее условия:  
  
        1.  Проверка подлинности OTP может использоваться параллельно с помощью смарт-карт и доверенного платформенного модуля \(доверенного платформенного МОДУЛЯ\)\-проверки подлинности на основе. Включение проверки подлинности методом OTP в консоли управления удаленным доступом также позволяет использовать проверку подлинности с помощью смарт-карты.  
  
        2.  Во время настройки пользователей удаленного доступа в заданной безопасностью группа может быть исключен из двух\-двухфакторная проверка подлинности и таким образом проверка подлинности с помощью имени пользователя\/только пароль.  
  
        3.  Такие режимы OTP, как "новый пин-код" и "следующий код токена", не поддерживаются.  
  
        4.  В мультисайтовом сценарии развертывания удаленного доступа параметры OTP являются глобальными и определяются для всех точек входа. Если для OTP настроены несколько RADIUS-серверов или ЦС, то они сортируются каждым сервером удаленного доступа по степени доступности и близости.  
  
        5.  При настройке OTP в удаленного доступа с несколькими\-среде лесами ЦС OTP должны принадлежать только к лесу ресурсов и сертификатов необходимо также настроить регистрацию отношений доверия между лесами. Дополнительные сведения см. в разделе [AD CS: Регистрация сертификатов между лесами в Windows Server 2008 R2](https://technet.microsoft.com/library/ff955842.aspx).  
  
        6.  Пользователи, использующие токен KEY FOB OTP, должны вставить последовательно PIN-код \(без любых разделителей\) в диалоговом окне OTP для DirectAccess. Пользователи, использующие OTP-токен PIN PAD, должны вставить в это диалоговое окно только код токена.  
  
        7.  Если включен протокол WEBDAV, не следует включать OTP.  
  
## <a name="KnownIssues"></a>Известные проблемы  
Ниже приводятся известные проблемы, возникающие при настройке сценария OTP.  
  
-   Удаленный доступ использует механизм пробы для проверки подключения к RADIUS\-OTP-серверы на основе. В некоторых случаях это может привести к возникновению ошибки на сервере OTP. Чтобы избежать этой проблемы, выполните на сервере OTP следующие действия.  
  
    -   Создайте для механизма пробы учетную запись пользователя, соответствующую имени пользователя и пароля, настроенным на сервере удаленного доступа. Имя пользователя не должно определять пользователя Active Directory.  
  
        По умолчанию имя пользователя на сервере удаленного доступа — DAProbeUser, а пароль — DAProbePass. Эти параметры по умолчанию можно изменить, используя следующие значения в реестре на сервере удаленного доступа:  
  
        -   Открываемый раздел HKEY\_ЛОКАЛЬНОГО\_МАШИНЫ\\программного обеспечения\\Microsoft\\DirectAccess\\OTP\\RadiusProbeUser  
  
        -   Открываемый раздел HKEY\_ЛОКАЛЬНОГО\_МАШИНЫ\\программного обеспечения\\Microsoft\\DirectAccess\\OTP\\ RadiusProbePass  
  
-   Если изменить корневой сертификат IPsec в настроенном и работающем развертывании DirectAccess, OTP перестает работать. Чтобы устранить эту проблему, на каждом сервере DirectAccess, в командной строке Windows PowerShell, выполните команду: `iisreset`  
  
