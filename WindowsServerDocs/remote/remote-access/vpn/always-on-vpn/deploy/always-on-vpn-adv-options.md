---
title: Расширенные функции постоянно подключенного VPN-профиля
description: Помимо сценария развертывания, предоставляемого в этом развертывании, можно добавить другие дополнительные функции VPN, чтобы повысить безопасность и доступность VPN-подключения.
ms.assetid: 51a1ee61-3ffe-4f65-b8de-ff21903e1e74
ms.prod: windows-server-threshold
ms.technology: networking-ras
ms.topic: article
ms.date: 07/24/19
ms.author: pashort, v-tea
author: shortpatti
ms.localizationpriority: medium
ms.reviewer: deverette
ms.openlocfilehash: e09a23b6f1c14c4c14b00fd19d84d0abb71d0163
ms.sourcegitcommit: e40fce7b8b4bc0bef278e676435306f14078cf00
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/05/2019
ms.locfileid: "68787208"
---
# <a name="advanced-features-of-always-on-vpn"></a>Дополнительные возможности Always On VPN

>Относится к: Windows Server (половина ежегодного канала), Windows Server 2016, Windows Server 2012 R2, Windows 10

- [**Прошлом** Дополнительные сведения о технологии VPN Always On](../always-on-vpn-technology-overview.md)
- [**Очеред** Начало планирования развертывания Always On VPN](always-on-vpn-deploy-planning.md)

Помимо предоставленных сценариев развертывания можно добавить другие дополнительные функции VPN, чтобы повысить безопасность и доступность VPN-подключения. Например, VPN-сервер может использовать эти функции, чтобы убедиться, что подключающийся клиент исправен, прежде чем разрешить подключение.

## <a name="high-availability"></a>Высокая доступность

Ниже приведены дополнительные параметры для обеспечения высокого уровня доступности.

|Параметр  |Описание  |
|---------|---------|
|Устойчивость сервера и балансировка нагрузки     |В средах, требующих высокой доступности или поддерживающих большое количество запросов, можно повысить производительность и устойчивость удаленного доступа, используя балансировку нагрузки между несколькими серверами, на которых выполняется сервер политики сети (NPS), и включить Кластеризация сервера удаленного доступа.<p>Связанные документы:<ul><li>[Балансировка нагрузки прокси-сервера NPS](../../../../../networking/technologies/nps/nps-manage-proxy-lb.md)</li><li>[Развертывание удаленного доступа в кластере](https://docs.microsoft.com/windows-server/remote/remote-access/ras/cluster/deploy-remote-access-in-cluster)</li></ul>        |
|Устойчивость географических сайтов     |Для географического расположения на основе IP-адреса можно использовать глобальный диспетчер трафика с DNS в Windows Server 2016. Для более надежной географической балансировки нагрузки можно использовать решения для глобальной серверной балансировки нагрузки, например диспетчер трафика Microsoft Azure.<p>Связанные документы:<ul><li>[Общие сведения о диспетчере трафика](https://docs.microsoft.com/azure/traffic-manager/traffic-manager-overview)</li><li>[диспетчер трафика Microsoft Azure](https://azure.microsoft.com/services/traffic-manager)</li></ul>         |

## <a name="advanced-authentication"></a>Расширенная проверка подлинности

Ниже приведены дополнительные параметры проверки подлинности.

|Параметр  |Описание  |
|---------|---------|
|Windows Hello для бизнеса;     |В Windows 10 пароли в Windows Hello для бизнеса заменяются, предоставляя надежную двухфакторную проверку подлинности на ПК и мобильных устройствах. Эта проверка подлинности состоит из нового типа учетных данных пользователя, привязанного к устройству и использующего биометрический или персональный идентификационный номер (ПИН-код).<p>VPN-клиент Windows 10 совместим с Windows Hello для бизнеса. После входа пользователя с помощью жеста VPN-подключение использует сертификат Windows Hello для бизнеса для проверки подлинности на основе сертификатов.<p>Связанные документы:<ul><li>[Windows Hello для бизнеса](https://docs.microsoft.com/windows/access-protection/hello-for-business/hello-identity-verification)</li><li>Технический пример: [Включение удаленного доступа с помощью Windows Hello для бизнеса в Windows 10](https://msdn.microsoft.com/library/mt728163.aspx)</li></ul>         |
|Многофакторная проверка подлинности Azure (MFA)     |В Azure MFA есть облачные и локальные версии, которые можно интегрировать с механизмом проверки подлинности VPN Windows.<p>Дополнительные сведения о том, как работает этот механизм, см. [в статье интеграция аутентификации RADIUS с сервером многофакторной идентификации Azure](https://docs.microsoft.com/azure/multi-factor-authentication/multi-factor-authentication-get-started-server-radius).         |

## <a name="advanced-vpn-features"></a>Дополнительные функции VPN

Ниже приведены дополнительные параметры для дополнительных функций.

|Параметр  |Описание  |
|---------|---------|
|Фильтрация трафика     |Если необходимо обеспечить выбор приложений, к которым могут получать доступ VPN-клиенты, можно включить фильтры трафика VPN.<p>Дополнительные сведения см. в разделе [функции безопасности VPN](https://docs.microsoft.com/windows/access-protection/vpn/vpn-security-features).         |
|VPN-подключение, инициированное приложением     |Можно настроить профили VPN для автоматического подключения при запуске определенных приложений или типов приложений.<p>Дополнительные сведения об этом и других возможностях активации см. в разделе [Параметры профиля с автоматической активацией VPN](https://docs.microsoft.com/windows/access-protection/vpn/vpn-auto-trigger-profile).         |
|Условный доступ VPN   |Условный доступ и соответствие устройств требованиям могут потребовать, чтобы управляемые устройства соответствовали стандартам, прежде чем они смогут подключиться к VPN. Одна из дополнительных функций для условного доступа VPN позволяет ограничить VPN-подключения только теми, в которых сертификат проверки подлинности клиента содержит идентификатор объекта "условный доступ AAD" **1.3.6.1.4.1.311.87**.<p>Чтобы ограничить VPN-подключения, необходимо выполнить следующие действия.<ol><li>На сервере NPS откройте оснастку " **сервер политики сети** ".</li><li>Разверните **политики** > политики**сети**.</li><li>Щелкните правой кнопкой мыши сетевую политику **подключения к виртуальной частной сети (VPN)** и выберите пункт **свойства**.</li><li>Перейдите на вкладку **Параметры** .</li><li>Выберите **только**для вендора и нажмите кнопку **Добавить**.</li><li>Выберите параметр **Allowed-Certificate-OID** , а затем нажмите кнопку **Добавить**.</li><li>Вставьте идентификатор объекта условного доступа AAD **1.3.6.1.4.1.311.87** в качестве значения атрибута, а затем нажмите кнопку **ОК** два раза.</li><li>Нажмите кнопку **Закрыть**, а затем кнопку **Применить**.<p>После выполнения этих действий при попытке VPN-клиентов подключиться с помощью любого сертификата, отличного от краткосрочного облачного сертификата, происходит сбой подключения.</li></ol>Дополнительные сведения об условном доступе см. в разделе [VPN и условный доступ](https://docs.microsoft.com/windows/access-protection/vpn/vpn-conditional-access).   |


---
## <a name="blocking-vpn-clients-that-use-revoked-certificates"></a>Блокирование VPN-клиентов, использующих отозванные сертификаты
  
После установки обновлений сервер RRAS может принудительно применить отзыв сертификатов для VPN, использующих IKEv2 и сертификаты компьютера для проверки подлинности, например VPN устройства с Always On-On. Это означает, что для таких VPN-серверов сервер RRAS может запретить подключения VPN к клиентам, которые пытаются использовать отозванный сертификат.

**Доступность**

В следующей таблице перечислены выпуски, содержащие исправления для каждой версии Windows.

|Версия операционной системы |Выпуск  |
|---------|---------|
|Windows Server версии 1903  |[KB4501375](https://support.microsoft.com/help/4501375/windows-10-update-kb4501375) |
|Windows Server 2019<br />Windows Server, версия 1809  |[KB4505658](https://support.microsoft.com/help/4505658/windows-10-update-kb4505658)  |
|Windows Server версии 1803  |[KB4507466](https://support.microsoft.com/help/4507466/windows-10-update-kb4507466)  |
|Windows Server версии 1709  |[KB4507465](https://support.microsoft.com/help/4507465/windows-10-update-kb4507465)  |
|Windows Server 2016, версия 1607  |[KB4503294](https://support.microsoft.com/help/4503294/windows-10-update-kb4503294) |

**Настройка необходимых компонентов** 

1. Установите обновления Windows по мере их появления.
1. Убедитесь, что все используемые сертификаты VPN-клиента и сервера RRAS имеют записи CDP и что сервер RRAS может связаться с соответствующими списками отзыва сертификатов.
1. На сервере RRAS используйте командлет PowerShell **Set-впнауспротокол** , чтобы настроить параметр **рутцертификатенаметоакцепт** .<br /><br />
   В следующем примере перечисляются команды для этого. В примере **CN = корневой центр сертификации Contoso** представляет различающееся имя корневого центра сертификации. 
   ``` powershell
   $cert1 = ( Get-ChildItem -Path cert:LocalMachine\root | Where-Object -FilterScript { $_.Subject -Like "*CN=Contoso Root Certification Authority*" } )
   Set-VpnAuthProtocol -RootCertificateNameToAccept $cert1 -PassThru
   ```
**Настройка сервера RRAS для принудительного отзыва сертификатов для VPN-подключений, основанных на сертификатах компьютеров IKEv2**

1. В окне командной строки выполните следующую команду: 
   ```
   reg add HKLM\SYSTEM\CurrentControlSet\Services\RemoteAccess\Parameters\Ikev2 /f /v CertAuthFlags /t REG_DWORD /d "4"
   ```

1. Перезапустите службу **маршрутизации и удаленного доступа** .
  
Чтобы отключить отзыв сертификатов для этих VPN-подключений, задайте **цертаусфлагс = 2** или удалите значение **цертаусфлагс** , а затем перезапустите службу **маршрутизации и удаленного доступа** . 

**Как отозвать сертификат VPN-клиента для VPN-подключения, основанного на сертификате компьютера IKEv2**
1. Отозвать сертификат VPN-клиента из центра сертификации.
1. Опубликуйте новый список отзыва сертификатов из центра сертификации.
1. На сервере RRAS откройте окно командной строки с правами администратора и выполните следующие команды:
   ```
   certutil -urlcache * delete
   certutil -setreg chain\ChainCacheResyncFiletime @now
   ```

**Как проверить, работает ли отзыв сертификатов для VPN-подключений на основе сертификата компьютера IKEv2**  
>[!Note]  
> Перед использованием этой процедуры убедитесь, что включен журнал рабочих событий CAPI2.
1. Выполните описанные выше действия, чтобы отозвать сертификат VPN-клиента.
1. Попробуйте подключиться к VPN с помощью клиента с отозванным сертификатом. Сервер RRAS должен отклонять подключение и отображать сообщение, например "учетные данные проверки подлинности IKE недопустимы".
1. На RRAS-сервере откройте Просмотр событий и перейдите к журналам **приложений и служб/Microsoft/Windows/CAPI2**. 
1. Найдите событие со следующими сведениями:
   * Имя журнала: **Microsoft-Windows-CAPI2/операционная система Microsoft-Windows-CAPI2/эксплуатация**
   * ИД события: **41** 
   * Событие содержит следующий текст: **subject = "*полное доменное имя клиента*"** (*FQDN* клиента — полное доменное имени клиента с отозванным сертификатом). 

   Поле данных события должно включать **сертификат отзыва.** **<Result>** Например, см. следующие фрагменты события:
   ```xml
   Log Name:      Microsoft-Windows-CAPI2/Operational Microsoft-Windows-CAPI2/Operational  
   Source:        Microsoft-Windows-CAPI2  
   Date:          5/20/2019 1:33:24 PM  
   Event ID:      41  
   ...  
   Event Xml:
   <Event xmlns="http://schemas.microsoft.com/win/2004/08/events/event">
    <UserData>  
     <CertVerifyRevocation>  
      <Certificate fileRef="C97AE73E9823E8179903E81107E089497C77A720.cer" subjectName="client01.corp.contoso.com" />  
      <IssuerCertificate fileRef="34B1AE2BD868FE4F8BFDCA96E47C87C12BC01E3A.cer" subjectName="Contoso Root Certification Authority" />
      ...
      <Result value="80092010">The certificate is revoked.</Result>
     </CertVerifyRevocation>
    </UserData>
   </Event>
   ```

---
## <a name="additional-protection"></a>Дополнительная защита

### <a name="trusted-platform-module-tpm-key-attestation"></a>Аттестация ключа доверенный платформенный модуль (TPM) (TPM)

Сертификат пользователя с ключом аттестации доверенного платформенного модуля обеспечивает более высокий уровень безопасности, резервное копирование, защиту от повторного использования, а также изоляцию ключей, предоставляемых доверенным платформенным модулем.

Дополнительные сведения о аттестации ключей TPM в Windows 10 см. в разделе [аттестация ключей TPM](https://docs.microsoft.com/windows-server/identity/ad-ds/manage/component-updates/tpm-key-attestation).

## <a name="next-step"></a>Дальнейшие действия

[Начните планирование развертывания Always on VPN](always-on-vpn-deploy-planning.md): Перед установкой роли сервера удаленного доступа на компьютере, который планируется использовать в качестве VPN-сервера, выполните следующие действия. После соответствующего планирования можно развернуть VPN Always On и при необходимости настроить условный доступ для VPN-подключения с помощью Azure AD.  

## <a name="related-topics"></a>См. также
- [Балансировка нагрузки прокси-сервера NPS](../../../../../networking/technologies/nps/nps-manage-proxy-lb.md): Клиенты RADIUS, которые представляют собой серверы сетевого доступа, такие как серверы виртуальной частной сети (VPN) и точки беспроводного доступа, создают запросы на подключение и отправляют их на серверы RADIUS, такие как NPS. В некоторых случаях сервер политики сети может одновременно получить слишком много запросов на подключение, что приведет к снижению производительности или перегрузке.

- [Обзор диспетчера трафика](https://docs.microsoft.com/azure/traffic-manager/traffic-manager-overview): В этом разделе содержится обзор диспетчера трафика Azure, который позволяет управлять распределением пользовательского трафика для конечных точек служб. Диспетчер трафика использует систему доменных имен (DNS) для направления клиентских запросов к наиболее подходящей конечной точке на основе метода маршрутизации трафика и работоспособности конечных точек. 

- [Windows Hello для бизнеса](https://docs.microsoft.com/windows/access-protection/hello-for-business/hello-identity-verification): В этом разделе приводятся предварительные требования, такие как облачные развертывания и гибридные развертывания.  В этом разделе также перечислены часто задаваемые вопросы о Windows Hello для бизнеса.

- [Технический пример: Включение удаленного доступа с помощью Windows Hello для бизнеса в Windows](https://msdn.microsoft.com/library/mt728163.aspx)10: В этом техническом примере вы узнаете, как Майкрософт реализует удаленный доступ с помощью Windows Hello для бизнеса.  Windows Hello для бизнеса — это закрытый, Открытый ключ или подход с проверкой подлинности на основе сертификатов для организаций и потребителей, которые выходят за пределы паролей. Такая форма проверки подлинности основывается на учетных данных пары ключей, которые могут заменять пароли и устойчивы к нарушениям, кражам и фишингу. 

- [Интеграция аутентификации RADIUS с сервером многофакторной идентификации Azure](https://docs.microsoft.com/azure/multi-factor-authentication/multi-factor-authentication-get-started-server-radius): В этом разделе описывается добавление и Настройка проверки подлинности клиента RADIUS с помощью сервера многофакторной идентификации Azure. RADIUS является стандартным протоколом получения запросов проверки подлинности и обработки этих запросов. Сервер многофакторной идентификации Azure может действовать как сервер RADIUS. 

- [Функции безопасности VPN](https://docs.microsoft.com/windows/access-protection/vpn/vpn-security-features): В этом разделе приводятся рекомендации по безопасности VPN для блокировки VPN, интеграции Windows Information Protection (WIP) с VPN и фильтров трафика. 

- [Параметры профиля с автоматической активацией VPN](https://docs.microsoft.com/windows/access-protection/vpn/vpn-auto-trigger-profile): В этом разделе приведены параметры профиля с автоматической активацией VPN, такие как триггеры приложений, триггеры на основе имен и Always On.

- [VPN и условный доступ](https://docs.microsoft.com/windows/access-protection/vpn/vpn-conditional-access): В этом разделе содержится обзор облачной платформы условного доступа, которая обеспечивает возможность соответствия устройства для удаленных клиентов. Условный доступ — это модуль оценки на основе политик, который позволяет создавать правила доступа для любого приложения, подключенного к Azure Active Directory (Azure AD). 

- [Аттестация ключа TPM](https://docs.microsoft.com/windows-server/identity/ad-ds/manage/component-updates/tpm-key-attestation): В этом разделе содержатся общие сведения о доверенный платформенный модуль (TPM) (TPM) и действиях по развертыванию аттестации ключей доверенного платформенного модуля. Можно также найти сведения об устранении неполадок и инструкции по устранению проблем.
