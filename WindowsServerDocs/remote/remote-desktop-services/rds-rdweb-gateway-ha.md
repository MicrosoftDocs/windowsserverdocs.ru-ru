---
title: Реализация высокой доступности в веб-интерфейсе шлюза и веб-доступа к удаленным рабочим столам
description: Содержит пошаговые инструкции по установке серверов веб-доступа к удаленным рабочим столам и шлюза в развертывании служб удаленных рабочих столов (RDS).
ms.prod: windows-server
ms.technology: remote-desktop-services
ms.topic: article
author: lizap
ms.author: elizapo
ms.date: 11/08/2016
manager: dongill
ms.openlocfilehash: c34d0bd2654d36e447053348392b4b9a6957e60f
ms.sourcegitcommit: d5e27c1f2f168a71ae272bebf8f50e1b3ccbcca3
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/23/2020
ms.locfileid: "86960196"
---
# <a name="add-high-availability-to-the-rd-web-and-gateway-web-front"></a>Реализация высокой доступности в веб-интерфейсе шлюза и веб-доступа к удаленным рабочим столам

>Применяется к: Windows Server (Semi-Annual Channel), Windows Server 2019, Windows Server 2016


Можно развернуть ферму с веб-доступом к удаленным рабочим столам и шлюзом удаленных рабочих столов, чтобы повысить доступность и масштаб развертывания служб удаленных рабочих столов (RDS) под управлением Windows Server. 

Следуя инструкциям ниже, добавьте сервер веб-доступа к удаленным рабочим столам и сервер шлюза в существующее базовое развертывание RDS.  

## <a name="pre-requisites"></a>Предварительные требования

Настройте сервер в качестве дополнительного сервера веб-доступа к удаленным рабочим столам и сервера шлюза удаленных рабочих столов. Это может быть физический сервер или виртуальная машина. Необходимо также присоединить этот сервер к домену и включить удаленное управление.

## <a name="step-1-configure-the-new-server-to-be-part-of-the-rds-environment"></a>Шаг 1. Настройка нового сервера для добавления в среду RDS

1. Подключитесь к серверу RDMS на портале Azure с помощью клиента подключения к удаленному рабочему столу.
2. Добавьте новый сервер RDSH в диспетчер серверов.
    1. Запустите диспетчер серверов, щелкните **Управление > Добавление серверов**.   
    2. В диалоговом окне "Добавление серверов", нажмите кнопку **Найти**.   
    3. Выберите только что созданный сервер веб-доступа к удаленным рабочим столам и шлюза (например, Contoso-WebGw2) и нажмите кнопку **ОК**.
3. Добавление сервера веб-доступа к удаленным рабочим столам и шлюза в развертывание  
    1. Запустите диспетчер серверов.  
    2. Щелкните **Службы удаленных рабочих столов > Обзор > Серверы развертывания > Задачи > Add RD Web Access Servers** (Добавить серверы веб-доступа к удаленным рабочим столам).   
    3. Выберите недавно созданный сервер (например, Contoso-WebGw2), а затем нажмите кнопку **Далее**.  
    4. На странице подтверждения выберите **Перезапустить удаленные компьютеры при необходимости**, а затем нажмите кнопку **Добавить**.  
    5. Повторите эти шаги, чтобы добавить сервер шлюза удаленных рабочих столов, но выберите **Серверы шлюза удаленных рабочих столов** на шаге b.
4. Повторно установите сертификаты для серверов шлюза удаленных рабочих столов.
   1. В диспетчере серверов на серверк RDMS щелкните **Службы удаленных рабочих столов > Задачи > Изменить свойства развертывания**.  
   2. Разверните элемент **Сертификаты**.  
   3. Прокрутите его вниз до таблицы. Щелкните **Gateway Role Service (Служба роли шлюза) > Выбрать существующий сертификат**.  
   4. Щелкните **Выбрать другой сертификат** и найдите нужный сертификат. Например, \Contoso-CB1\Certificates. Выберите файл сертификата для сервера веб-доступа к удаленным рабочим столам и сервера шлюза, созданный при выполнении предварительных требований (например, ContosoRdGwCert), и нажмите кнопку **Открыть**.  
   5. Введите пароль для сертификата, установите флажок **Разрешить добавление сертификата в хранилище "Доверенные корневые центры сертификации" на конечных компьютерах**, а затем нажмите кнопку **ОК**.  
   6. Щелкните **Применить**.
      > [!NOTE] 
      > Возможно, потребуется вручную перезапустить службу TSGateway, выполняемую на каждом сервере шлюза удаленных рабочих столов, воспользовавшись диспетчером серверов или диспетчером задач.
   7. Повторите шаги a–f для службы роли веб-доступа к удаленным рабочим столам.

## <a name="step-2-configure-rd-web-and-rd-gateway-properties-on-the-new-server"></a>Шаг 2. Настройка свойств веб-доступа к удаленным рабочим столам и шлюза удаленных рабочих столов на новом сервере
1. Настройте сервер для добавления в ферму шлюза удаленных рабочих столов.
    1.  В диспетчере серверов на сервере RDMS и щелкните **Все серверы**. Щелкните правой кнопкой мыши один из серверов шлюза удаленных рабочих столов, а затем выберите **Подключение к удаленному рабочему столу**.
    2.  Войдите на сервер шлюза удаленных рабочих столов, используя учетную запись администратора домена.  
    3.  В диспетчере серверов на сервере шлюза удаленных рабочих столов щелкните **Средства > Службы удаленных рабочих столов > Диспетчер шлюза удаленных рабочих столов**.  
    4.  В области навигации выберите локальный компьютер (например, Contoso-WebGw1).  
    5.  Щелкните **Добавление членов фермы серверов шлюзов удаленных рабочих столов**.  
    6.  На вкладке **Ферма серверов** введите имя каждого сервера шлюза удаленных рабочих столов, а затем нажмите кнопки **Добавить** и **Применить**.  
    7.  Повторите шаги a–f на каждом сервере шлюза удаленных рабочих столов, чтобы они распознавали друг друга в качестве серверов шлюза удаленных рабочих столов в ферме. Не волнуйтесь, если появились предупреждения, так как для распространения параметров DNS может потребоваться время.
2. Настройте сервер для добавления в ферму веб-доступа к удаленным рабочим столам. Выполнив приведенные ниже действия, вы сможете настроить одинаковые ключи проверки и ключи расшифровки на компьютерах на обоих сайтах RDWeb.
    1.  В диспетчере серверов на сервере RDMS и щелкните **Все серверы**. Щелкните правой кнопкой мыши первый сервер веб-доступа к удаленным рабочим столам (например, Contoso-WebGw1) и выберите **Подключение к удаленному рабочему столу**.  
    2.  Войдите на сервер веб-доступа к удаленным рабочим столам, используя учетную запись администратора домена.  
    3.  В диспетчере серверов на сервере веб-доступа к удаленным рабочим столам щелкните **Средства > Диспетчер Internet Information Services (IIS)** .  
    4.  В левой области диспетчера служб IIS разверните **сервер (например, Contoso-WebGw1) > Сайты > Веб-сайт по умолчанию**, а затем щелкните **RDWeb**.  
    5.  Щелкните правой кнопкой мыши **Ключ машины**, а затем выберите **Открытие функции**.
    6.  На странице "Ключ машины" в области **Действия** выберите **Создание ключей**, а затем нажмите кнопку **Применить**.
    7.  Скопируйте ключ проверки (можно щелкнуть его правой кнопкой мыши и выбрать **Копировать**).
    8.  В диспетчере служб IIS в разделе **Веб-сайт по умолчанию** по очереди выберите **Feed**, **FeedLogon** и **Pages**.
    9. Для каждой страницы сделайте следующее.
        1.  Щелкните правой кнопкой мыши **Ключ машины**, а затем выберите **Открытие функции**.
        2.  Для ключа проверки: снимите флажок **Автоматически формировать во время выполнения**, а затем вставьте ключ, скопированный на шаге g.
    10.  Сверните окно подключения к удаленному рабочему столу этого сервера веб-доступа к удаленным рабочим столам.  
    11.  Повторите шаги b–e для второго сервера веб-доступа к удаленным рабочим столам, завершая просмотром функции **Ключ машины**.
    12. Для ключа проверки: снимите флажок **Автоматически формировать во время выполнения**, а затем вставьте ключ, скопированный на шаге g.
    13. Щелкните **Применить**.
    14. Выполните этот процесс для страниц **RDWeb**, **Feed**, **FeedLogon** и **Pages**.
    15. Сверните окно подключения к удаленному рабочему столу второго сервера веб-доступа к удаленным рабочим столам, а затем разверните окно подключения к удаленному рабочему столу первого сервера веб-доступа к удаленным рабочим столам.  
    16. Повторите шаги g–n, чтобы скопировать ключ расшифровки.
    17. Когда ключи проверки и ключи расшифровки будут идентичны на обоих серверах веб-доступа к удаленным рабочим столам для страниц **RDWeb**, **Feed**, **FeedLogon** и **Pages**, выполните выход из всех окон подключения к удаленному рабочему столу.

## <a name="step-3-configure-load-balancing-for-the-rd-web-and-rd-gateway-servers"></a>Шаг 3. Настройка балансировки нагрузки для сервера веб-доступа к удаленным рабочим столам и сервера шлюза удаленных рабочих столов

Если вы используете инфраструктуру Azure, то можете создать внешний Azure Load Balancer. Если нет, то вы можете настроить отдельную аппаратную или программную подсистему балансировки. Балансировка нагрузки имеет решающее значение, так как трафик долговременных подключений клиентов удаленного рабочего стола будет равномерно распределяться и передаваться через шлюз удаленных рабочих столов на серверы, на которых пользователи будут выполнять свои рабочие нагрузки.

> [!NOTE] 
> Если ваш предыдущий сервер, используемый для веб-доступа к удаленным рабочим столам и шлюза удаленных рабочих столов, уже был установлен под управлением внешней подсистемы балансировки нагрузки, перейдите к шагу 4, выберите существующий внутренний пул и добавьте в него новый сервер.

1.  Создайте Azure Load Balancer.  
    1.  На портале Azure выберите **Обзор > Балансировщики нагрузки > Добавить**.  
    2.  Введите имя, например **WebGwLB**.  
    3.  Для параметра **Схема** выберите **Общедоступный**.
    4.  В разделе **Общедоступный IP -адрес** щелкните **Выберите общедоступный IP-адрес**, а затем выберите существующий общедоступный IP-адрес или создайте новый.
    5.  Выберите соответствующие **подписку**, **группу ресурсов** и **расположение**.
    6.  Нажмите кнопку **Create** (Создать).  
2. Создайте [пробу](/azure/load-balancer/load-balancer-custom-probe-overview) для отслеживания активности серверов.  
    1.  На портале Azure выберите **Обзор** > **Подсистемы балансировки нагрузки**, а затем выберите подсистему балансировки нагрузки, созданную на предыдущем шаге.
    2.  Выберите **Все параметры** > **Пробы** > **Добавить**.  
    3.  Введите имя пробы, например **HTTPS**. Выберите **протокол** **TCP** и введите номер **порта** **443**, затем нажмите кнопку **ОК**.   
3.  Создайте правила балансировки нагрузки HTTPS и UDP.  
    1.  В разделе **Параметры** щелкните **Правила балансировки нагрузки**.  
    2.  Щелкните **Добавить** для **правила HTPPS**.  
    3.  Введите имя для правила (например, HTTPS) и выберите **протокол** **TCP**. Введите номер **443** для **порта** и **внутреннего порта**, затем нажмите кнопку **ОК**.  
    4.  В разделе **Правила балансировки нагрузки** щелкните **Добавить** для **правила UDP**.  
    5.  Введите имя для правила (например, **UDP**) и выберите **протокол** **UDP**. Введите номер **3391** для **порта** и **внутреннего порта**, затем нажмите кнопку **ОК**.  
4. Создайте внутренний пул для сервера веб-доступа к удаленным рабочим столам и сервера шлюза удаленных рабочих столов.
      1. В разделе **Параметры** щелкните **Серверные пулы адресов > Добавить**.   
      2. Введите имя (например, **WebGwBackendPool**), а затем щелкните **Добавить виртуальную машину**.  
      3. Выберите группу доступности (например, WebGwAvSet), а затем нажмите кнопку **ОК**.   
      4. Щелкните **Выберите виртуальные машины**, выберите все виртуальные машины и щелкните **Выбрать > ОК > ОК**.
