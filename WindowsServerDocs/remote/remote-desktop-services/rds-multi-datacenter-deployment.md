---
title: Географически избыточное центров обработки данных служб удаленных рабочих СТОЛОВ в Azure
description: Узнайте, как создать развертывание служб удаленных рабочих СТОЛОВ, использует несколько центров обработки данных для обеспечения высокой доступности в разных географических расположениях.
ms.custom: na
ms.prod: windows-server-threshold
ms.reviewer: na
ms.suite: na
ms.technology: remote-desktop-services
ms.tgt_pltfrm: na
ms.topic: article
ms.assetid: 61c36528-cf47-4af0-83c1-a883f79a73a5
author: haley-rowland
ms.author: elizapo
ms.date: 06/14/2017
manager: dongill
ms.openlocfilehash: 7d895b1098c4d8cdf162c77f35209b7308872d60
ms.sourcegitcommit: 0d0b32c8986ba7db9536e0b8648d4ddf9b03e452
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2019
ms.locfileid: "59849965"
---
# <a name="create-a-geo-redundant-multi-data-center-rds-deployment-for-disaster-recovery"></a>Создание геоизбыточное, несколькими данные центра развертывания служб удаленных рабочих СТОЛОВ для аварийного восстановления

>Область применения. Windows Server (полугодовой канал), Windows Server 2016

Вы можете включить аварийное восстановление для развертывания служб удаленных рабочих столов, за счет использования нескольких центрах обработки данных в Azure. В отличие от стандартное развертывание высокодоступных служб удаленных рабочих СТОЛОВ (как описано в [архитектуры служб удаленных рабочих столов](desktop-hosting-logical-architecture.md)), использующий центров обработки данных в одном регионе Azure (например, Западная Европа), при развертывании нескольких центрах обработки данных используются данные центры в разных географических расположениях, Повышение доступности развертывания — центр обработки данных одну Azure могут быть недоступны, но маловероятно, что несколько регионов будет из строя в то же время. Развертывая географически избыточная архитектура служб удаленных рабочих СТОЛОВ, вы можете включить отработки отказа в случае разрушительного сбоя всего региона.

Можно использовать приведенные ниже инструкции для использования служб инфраструктуры Microsoft Azure и служб удаленных рабочих СТОЛОВ для предоставления службы размещения и лицензии подписчика (SAL у) геоизбыточное рабочего стола к нескольким клиентам через [поставщика услуг Майкрософт Программа License Agreement (SPLA)](https://www.microsoft.com/hosting/licensing/splabenefits.aspx). Также можно использовать указанные ниже действия для создания геоизбыточных службой размещения для сотрудников с помощью [расширенные права в рамках программы Software Assurance пользовательские лицензии CAL RDS](https://download.microsoft.com/download/6/B/A/6BA3215A-C8B5-4AD1-AA8E-6C93606A4CFB/Windows_Server_2012_R2_Remote_Desktop_Services_Licensing_Datasheet.pdf).

## <a name="logical-architecture-for-high-availability---single-and-multiple-regions"></a>Логическая архитектура для обеспечения высокой доступности - одного и нескольких регионах
Ниже показана архитектура для развертывания высокой доступности в одном регионе Azure.

![Высокодоступное развертывание в одном регионе Azure](media/rds-ha-single-region.png)

Развертывание состоит из трех уровней:

- Службы Azure - интерфейсы управления Azure, включая портал Azure и API-интерфейсы и общих сетевых служб, таких как DNS и общедоступного IP-адреса.
- Служба — виртуальные машины, сети, хранилища, служб Azure и служб ролей Windows Server по размещению рабочих столов
- Azure Fabric - операционных систем Windows Server под управлением роли Hyper-V, используемый для виртуализации физических серверов, единицы хранения, сетевых коммутаторов и маршрутизаторов. С помощью Azure Fabric позволяет создавать виртуальные машины, сети, хранилища и приложений независимых от базового оборудования.


В отличие от этого здесь — это архитектура для развертывания, в котором используется несколько центров обработки данных Azure:

![При развертывании служб удаленных рабочих СТОЛОВ, который использует несколько регионов Azure](media/rds-ha-multi-region.png)

Всего развертывания служб удаленных рабочих СТОЛОВ реплицируется во втором регионе Azure для создания геоизбыточных развертывания. Эта архитектура использует модель "активный / пассивный", где выполняется только одно развертывание служб удаленных рабочих СТОЛОВ за раз. Подключение к сети позволяет взаимодействовать друг с другом двух сред. Развертывания служб удаленных рабочих СТОЛОВ зависит от одного леса Active Directory или домена и серверы AD репликацией между двумя развертываниями, значение пользователи могут входить в любом развертывания, используя те же учетные данные. Пользовательские настройки и данные, хранящиеся в диски профилей пользователей (UPD), хранятся на двухузлового кластера дисковых пространств (S2D) масштабируемого файлового сервера (SOFS). Второй кластер идентичные S2D развертывается второго региона (пассивный), и реплика хранилища используется для репликации профилей пользователей из активного на пассивный развертывания. Диспетчер трафика Azure позволяет автоматически перенаправлять конечным пользователям независимо от развертывания в данный момент активна - с точки зрения конечного пользователя, они получить доступ к развертыванию, используя единый URL-адрес и не поддерживают какие области в конечном счете их с помощью.


Вы *удалось* создания без высокой доступности развертывания служб удаленных рабочих СТОЛОВ в каждом регионе, но если даже одна виртуальная машина перезапускается в одном регионе, возникала отработки отказа, увеличить вероятность того, что переход на другой ресурс происходит с помощью связанных влияние на производительность.

## <a name="deployment-steps"></a>Шаги развертывания
Создайте следующие ресурсы в Azure для создания развертывания служб удаленных рабочих СТОЛОВ — геоизбыточное хранилище с несколькими центрами обработки данных:

1. Две группы ресурсов в двух отдельных регионах Azure. К примеру A RG (активное развертывание RG означает «группа ресурсов») и B RG (пассивный развертывания).
2. Развертывания высокой доступности Active Directory в RG A. Можно использовать [нового домена AD с помощью шаблона 2 контроллеров домена](https://azure.microsoft.com/resources/templates/active-directory-new-domain-ha-2-dc/) создать развертывание.
3. Развертывания служб удаленных рабочих СТОЛОВ высокой доступности в RG а с помощью [RDS фермы развертывания с помощью существующей среды active directory](https://azure.microsoft.com/resources/templates/rds-deployment-existing-ad/) шаблон создания базового развертывания служб удаленных рабочих СТОЛОВ, а затем следуйте указаниям в [служб удаленных рабочих столов - высокий доступность](rds-plan-high-availability.md) настройке других компонентов служб удаленных рабочих СТОЛОВ для обеспечения высокой доступности.
4. Виртуальную сеть в RG B - обязательно требуется использовать адресное пространство, которое не пересекается с развертывания в RG A.
5. Объект [подключения VNet-to-VNet](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-vnet-vnet-rm-ps) между двумя группами.
6. Две виртуальные машины AD в группу доступности в RG Б - убедитесь, что имена виртуальных Машин отличаются от виртуальных машин AD в RG A. развернуть две виртуальные машины 2016 Windows Server в одном доступности задать, Установка роли доменных служб Active Directory и затем продвинуть их в продолжение домена валика в домене, созданный на шаге 1.
7. Второе развертывание высокодоступных служб удаленных рабочих СТОЛОВ в RG B. 
   1. Используйте [RDS фермы развертывания с помощью существующей среды active directory](https://azure.microsoft.com/resources/templates/rds-deployment-existing-ad/) шаблон еще раз, но на этот раз внести следующие изменения. (Чтобы настроить шаблон, выберите его в коллекции, выберите **развертывание в Azure** и затем **изменить шаблон**.)
      1. Настройте адресное пространство DNS server частного IP-адреса в соответствии с виртуальной сети в RG B. 
      
         Поиск «dnsServerPrivateIp» в переменных. Изменение IP-адрес по умолчанию (10.0.0.4) в соответствии с пространства адресов, заданных в виртуальной сети в RG B.
   
      2. Измените имена компьютеров, таким образом, чтобы они не конфликтуют с в развертывания в RG A.
      
         Найдите виртуальные машины в **ресурсы** раздел шаблона. Изменение **computerName** под **osProfile**. Например, может стать «шлюз» «шлюз **-b**«; «[concat ("rdsh-", copyIndex())]» может стать «[concat ('rdsh - b-", copyIndex())]» и «брокере» может стать «broker **-b**«.
      
         (Можно также изменить имена виртуальных машин вручную после выполнения шаблона.)
   2. Как и в шаге 3 выше, используйте сведения в [служб удаленных рабочих столов — высокий уровень доступности](rds-plan-high-availability.md) настройке других компонентов служб удаленных рабочих СТОЛОВ для обеспечения высокой доступности.
8. Дисковыми пространствами масштабируемый файловый сервер с репликой хранилища в двух развертываниях. Используйте [сценарий PowerShell](https://github.com/robotechredmond/301-s2d-sr-dr-md/tree/master/scripts) развертывание [шаблона](https://github.com/robotechredmond/301-s2d-sr-dr-md) между группами ресурсов.

   > [!NOTE]
   > Вы можете подготовить хранилище вручную (вместо использования сценария PowerShell и шаблона): 
   >1. Развертывание [2 узлов S2D SOFS](rds-storage-spaces-direct-deployment.md) in RG объект для хранения на диски профилей пользователей (UPD).
   >2. Развертывание во-вторых, идентичные S2D SOFS в RG B – необходимо использовать одинаковый объем хранилища в каждом кластере.
   >3. Настройка [реплики хранилища с помощью асинхронной репликации](../../storage/storage-replica/cluster-to-cluster-storage-replication.md) между ними.

### <a name="enable-upds"></a>Включить диски UPD
Реплика хранилища реплицирует данные из исходного тома (связанную с развертыванием основного/активный) для конечного тома (связанную с развертыванием получателя — пассивный). По своей структуре целевого кластера отображается как **Online (нет доступа)** -реплика хранилища отключает конечные тома и их дисков буквы или точки подключения. Это означает, что включение диски UPD для вторичного развертывания, указав путь к общей папке завершится ошибкой, так как том не подключен. 

Хотите узнать больше об управлении репликации? Ознакомьтесь с [Межкластерная репликация хранилища](../../storage/storage-replica/cluster-to-cluster-storage-replication.md).

Чтобы включить диски UPD в обоих развертываниях, сделайте следующее:

1. Запустите [командлет Set-RDSessionCollectionConfiguration](https://technet.microsoft.com/itpro/powershell/windows/remote-desktop/set-rdsessioncollectionconfiguration) включить диски профилей пользователей для развертывания основной (активный) — укажите путь к общей папке на исходном томе (которая была создана на шаге 7 на этапах развертывания).
2. Изменить направление реплики хранилища, чтобы конечный том стал исходного тома (это подключает тома и делает его доступным, дополнительное развертывание). Можно запустить **Set-SRPartnership** командлет, чтобы сделать это. Пример:

   ```powershell
   Set-SRPartnership -NewSourceComputerName "cluster-b-s2d-c" -SourceRGName "cluster-b-s2d-c" -DestinationComputerName "cluster-a-s2d-c" -DestinationRGName "cluster-a-s2d-c"
   ```
3. Включите диски профилей пользователей в дополнительное развертывание (пассивный). Используйте те же действия, как это делалось для основного развертывания, на шаге 1.
4. Изменить направление реплики хранилища еще раз, поэтому исходный том источника снова станет исходного тома в партнерстве SR и основного развертывания можно получить доступ к общей папке. Пример:

   ```powershell
   Set-SRPartnership -NewSourceComputerName "cluster-a-s2d-c" -SourceRGName "cluster-a-s2d-c" -DestinationComputerName "cluster-b-s2d-c" -DestinationRGName "cluster-b-s2d-c"
   ```


### <a name="azure-traffic-manager"></a>Диспетчер трафика Azure 

Создание [диспетчера трафика Azure](/azure/traffic-manager/traffic-manager-overview) профилировать, а также не забудьте выбрать **приоритет** метода маршрутизации. Задайте две конечные точки на общедоступный IP-адреса каждого развертывания. В разделе **конфигурации**, измените протокол HTTPS (а не HTTP) и порт 443 (вместо 80). Запишите **времени существования DNS**и настроить ее соответствующим образом для отработки отказа. 

Обратите внимание, что диспетчер трафика конечные точки, чтобы возвращать ответ 200 ОК в ответ на запрос GET, чтобы быть помечен как «исправен». Общедоступный IP-адрес объекта, созданного на основе шаблонов служб удаленных рабочих СТОЛОВ будет работать, но не добавляйте дополнение путь. Вместо этого можно предоставить пользователям URL-адрес диспетчера трафика с «/ RDWeb» например: ```http://deployment.trafficmanager.net/RDWeb```

Развертывая диспетчера трафика Azure с помощью метода маршрутизации по приоритету, можно запретить пользователям доступ к пассивный развертывания, пока работает активное развертывание. Если конечным пользователям доступ к пассивный развертывания и направление реплики хранилища не была переключена для отработки отказа, вход пользователя зависает, как развертывание, а затем не сможет получить доступ к общей папки на пассивном кластере. S2D со временем развертывания будет сдаться и предоставить временный профиль пользователя.  

### <a name="deallocate-vms-to-save-resources"></a>Освободить виртуальные машины, чтобы сохранить ресурсы 
После настройки обоих развертываний, можно завершить работу и освободить вторичной реплике инфраструктуры служб удаленных рабочих СТОЛОВ и виртуальные машины RDSH для экономии затрат на этих виртуальных машинах. Сервер AD S2D SOFS виртуальные машины всегда должно находиться в развертывании получателя — пассивный, чтобы включить синхронизацию учетной записи и профиля пользователя.  

При отработке отказа, необходимо запустить освобожденные виртуальные машины. Эта конфигурация развертывания имеет преимущество, снизить стоимость, однако при этом время отработки отказа. В случае катастрофического сбоя в активное развертывание необходимо будет вручную запустить пассивный развертывание или вам сценарий автоматизации для обнаружения сбоя и автоматический запуск пассивной развертывания. В любом случае она может занять несколько минут для получения пассивный развертывания, работают и доступны для пользователей, входа в систему, приводит к некоторое время простоя для службы. Этого простоя зависит от количество времени, он принимает для запуска инфраструктуры служб удаленных рабочих СТОЛОВ и виртуальные машины RDSH (обычно 2 – 4 минут, если виртуальные машины запускаются в параллельном режиме, а не последовательно) и время для перевода на пассивный кластер, (который зависит от размера кластера Обычно 2 – 4 минут двухузловой кластер с 2 диска на каждом узле). 

### <a name="active-directory"></a>Active Directory 
Серверы Active Directory в каждом развертывании являются репликами в том же лесу или домене. Active Directory имеет протокол встроенные синхронизации для синхронизации контроллеров четыре домена. Тем не менее могут существовать некоторые lag таким образом, если новый пользователь добавляется к одному серверу AD, может занять некоторое время для репликации на всех серверах AD в два развертывания. Следовательно не забудьте предупредить пользователей, не пытайтесь войти немедленно после добавления к домену. 

### <a name="rd-license-server"></a>Сервер лицензирования удаленных рабочих Столов 
Укажите [CAL на пользователя к удаленному рабочему Столу](rds-client-access-license.md) для каждого именованного пользователя, которому разрешен доступ к географически избыточное развертывание. Распространять пользовательские лицензии CAL равномерно между двумя серверами лицензии удаленных рабочих Столов в активное развертывание. Затем дублирование лицензий CAL на двух серверах лицензии удаленных рабочих Столов в пассивном развертывания. Так как между развертываниями в активной и пассивной дублируются клиентских лицензий, в любой момент времени только одно развертывание может быть active с пользователей, подключающихся; в противном случае Вы нарушите условия лицензионного соглашения.  

### <a name="image-management"></a>Управление образами 
При обновлении образы RDSH для предоставления обновлений программного обеспечения или новые приложения, необходимо отдельно обновить коллекции RDSH в каждом развертывании для поддержания распространенных взаимодействие с пользователем в обоих развертываниях. Можно использовать [шаблона коллекции RDSH обновления](https://azure.microsoft.com/resources/templates/rds-update-rdsh-collection/), но Обратите внимание на то, что пассивный развертывания инфраструктуры служб удаленных рабочих СТОЛОВ и виртуальные машины RDSH, должна быть установлена для запуска шаблона. 

## <a name="failover"></a>Переход на другой ресурс

В случае активное — пассивное развертывание отработки отказа необходимо запустить виртуальные машины дополнительного развертывания. Это можно сделать вручную или с помощью сценарий автоматизации. В случае катастрофической отработку отказа S2D SOFS измените направление партнерство реплики хранилища, таким образом, чтобы конечный том становится исходного тома. Пример:

   ```powershell
   Set-SRPartnership -NewSourceComputerName "cluster-b-s2d-c" -SourceRGName "cluster-b-s2d-c" -DestinationComputerName "cluster-a-s2d-c" -DestinationRGName "cluster-a-s2d-c"
   ```

Дополнительные сведения в [Межкластерная репликация хранилища](../../storage/storage-replica/cluster-to-cluster-storage-replication.md).

Диспетчер трафика Azure автоматически распознает, что сбой основного развертывания и что дополнительное развертывание находится в работоспособном (на виртуальных машинах шлюза удаленных рабочих Столов были запущены в RG B) и направляет трафик пользователя дополнительное развертывание. Пользователи могут использовать же URL-адрес диспетчера трафика, чтобы продолжить работу с их удаленным ресурсам, вам нравится согласованную работу. Обратите внимание на то, что кэша DNS на стороне клиента не обновить ее до конца TTL, заданного в конфигурации диспетчера трафика Azure.

### <a name="test-failover"></a>Тестовая отработка отказа
В партнерство реплики хранилища только один том (источник) может быть active за раз. Это означает, что при переключении направление связи SR, том в основного развертывания (RG объект) становится назначения репликации и таким образом скрыта. Таким образом все пользователи, подключающиеся к RG объект больше не будут иметь доступ к их дисках UPD, сохраненных на масштабируемом файловом СЕРВЕРЕ в RG A. 

Чтобы проверить отработку отказа дает возможность пользователям продолжить вход:
1. Запуск виртуальных машин инфраструктуры и виртуальные машины RDSH в RG B.
2. Переключить направление связи SR (кластера b-s2d-c становится исходного тома).
3. [Отключить конечную точку](/azure/traffic-manager/traffic-manager-manage-endpoints#to-disable-an-endpoint) RG a в профиле диспетчера трафика Azure для принудительного ATM направлять трафик в RG б. Кроме того, с помощью скрипта PowerShell:

   ```powershell
   Disable-AzureRmTrafficManagerEndpoint -Name publicIpA -Type AzureEndpoints -ProfileName MyTrafficManagerProfile -ResourceGroupName RGA -Force
   ```

RG B станет активной основного развертывания. Для переключения обратно в объект RG как основного развертывания:

1. Переключить направление связи SR (кластера с s2d c становится исходного тома):

   ```powershell
   Set-SRPartnership -NewSourceComputerName "cluster-a-s2d-c" -SourceRGName "cluster-a-s2d-c" -DestinationComputerName "cluster-b-s2d-c" -DestinationRGName "cluster-b-s2d-c"
   ```
2. Повторно включите конечную точку RG A в профиле диспетчера трафика Azure:

   ```powershell
   Enable-AzureRmTrafficManagerEndpoint -Name publicIpA -Type AzureEndpoints -ProfileName MyTrafficManagerProfile -ResourceGroupName RGA 
   ```

## <a name="considerations-for-on-premises-deployments"></a>Рекомендации для локальных развертываний

Хотя локальное развертывание не удалось использовать шаблоны быстрого запуска Azure, в этой статье, вы можете реализовать все инфраструктурные роли вручную. В локальное развертывание, где стоимость не зависит от использования Azure следует использовать активно активную модель для быстрой отработки отказа.

Диспетчер трафика можно использовать с или локальных конечных точек, но он требует подписки Azure. Кроме того для DNS, поставляемых конечным пользователям, дать им записи CNAME, просто направляет пользователей к основного развертывания. В случае отработки отказа измените запись CNAME в DNS для перенаправления на дополнительное развертывание. Таким образом конечный пользователь использует один URL-адрес, так же, как с диспетчером трафика Azure, направляющее пользователя в соответствующее развертывание. 

Если вы заинтересованы в создании модели в локальной среде Azure сайтами, рассмотрите возможность использования [Azure Site Recovery](https://docs.microsoft.com/azure/site-recovery/site-recovery-overview).
