---
title: Геоизбыточные центры обработки данных RDS в Azure
description: Узнайте, как создать развертывание RDS, которое использует несколько центров обработки данных для обеспечения высокой доступности в разных географических расположениях.
ms.custom: na
ms.prod: windows-server-threshold
ms.reviewer: na
ms.suite: na
ms.technology: remote-desktop-services
ms.tgt_pltfrm: na
ms.topic: article
ms.assetid: 61c36528-cf47-4af0-83c1-a883f79a73a5
author: haley-rowland
ms.author: elizapo
ms.date: 06/14/2017
manager: dongill
ms.openlocfilehash: 39a0d00e64ecab93fe1826726b14969e5e034738
ms.sourcegitcommit: f6490192d686f0a1e0c2ebe471f98e30105c0844
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/10/2019
ms.locfileid: "70871037"
---
# <a name="create-a-geo-redundant-multi-data-center-rds-deployment-for-disaster-recovery"></a>Создание геоизбыточного развертывания RDS с несколькими центрами обработки данных для аварийного восстановления

>Относится к: Windows Server (Semi-Annual Channel), Windows Server 2019, Windows Server 2016

Вы можете обеспечить аварийное восстановление развертывания служб удаленных рабочих столов, используя несколько центров обработки данных в Azure. В отличие от стандартного высокодоступного развертывания RDS (как описано в разделе [Архитектура служб удаленных рабочих столов](desktop-hosting-logical-architecture.md)), использующего центры обработки данных в одном регионе Azure (например, в Западной Европе), развертывание с несколькими центрами обработки данных использует центры обработки данных в разных географических расположениях. Это повышает доступность развертывания: один центр обработки данных Azure может стать недоступным, но маловероятно, что сразу несколько регионов одновременно выйдет из строя. Развертывая геоизбыточную архитектуру RDS, вы можете обеспечить отработку отказа в случае неустранимого сбоя всего региона.

Выполнив инструкции ниже, вы сможете использовать службы инфраструктуры Microsoft Azure для предоставления услуг размещения геоизбыточных рабочих столов и лицензий на доступ подписчиков (SAL) для множества клиентов по программе [Microsoft SPLA (лицензионное соглашение с поставщиком услуг)](https://www.microsoft.com/hosting/licensing/splabenefits.aspx). Можно также выполнить указанные ниже действия, чтобы создать геоизбыточную службу размещения для своих сотрудников, используя [расширенные права клиентских лицензий пользователей RDS в рамках программы Software Assurance](https://download.microsoft.com/download/6/B/A/6BA3215A-C8B5-4AD1-AA8E-6C93606A4CFB/Windows_Server_2012_R2_Remote_Desktop_Services_Licensing_Datasheet.pdf).

## <a name="logical-architecture-for-high-availability---single-and-multiple-regions"></a>Логическая архитектура для обеспечения высокой доступности: один и несколько регионов
На рисунке ниже показана архитектура высокодоступного развертывания в одном регионе Azure.

![Высокодоступное развертывание в одном регионе Azure](media/rds-ha-single-region.png)

Развертывание состоит из трех уровней:

- Службы Azure: интерфейсы управления Azure, включая портал Azure и интерфейсы API, а также общедоступные сетевые службы, такие как DNS и служба общедоступных IP-адресов.
- Служба размещения рабочих столов: виртуальные машины, сети, хранилище, службы Azure и службы ролей Windows Server.
- Azure Fabric: операционные системы Windows Server под управлением роли Hyper-V, используемый для виртуализации физических серверов, единиц хранения, сетевых коммутаторов и маршрутизаторов. С помощью Azure Fabric можно создавать виртуальные машины, сети, хранилища и приложения независимо от базового оборудования.


Существует и другая архитектура развертывания, в которой используется несколько центров обработки данных Azure.

![Развертывание RDS в нескольких регионах Azure](media/rds-ha-multi-region.png)

Все развертывание RDS реплицируется во второй регион Azure для обеспечения геоизбыточности. Эта архитектура использует модель "активный — пассивный", в которой одновременно выполняется только одно развертывание RDS. Подключение между виртуальными сетями позволяет средам взаимодействовать друг с другом. Развертывания RDS основываются на отдельном лесе или домене Active Directory, и серверы AD реплицируются между двумя развертываниями. Это значит, что пользователи могут входить на любое развертывание, используя одни и те же учетные данные. Пользовательские настройки и данные, хранящиеся на дисках профилей пользователей (UPD), хранятся на двухузловом кластеризованном масштабируемом файловом сервере (SOFS) Локальных дисковых пространств. Второй идентичный кластер Локальных дисковых пространств развертывается во втором регионе (пассивное развертывание), и реплика хранилища используется для репликации профилей пользователей из активного развертывания в пассивное. Диспетчер трафика Azure используется для автоматического перенаправления пользователей к развертыванию, которое активно в данный момент. С точки зрения пользователя, он получает доступ к развертыванию, используя один URL-адрес, и не знает, с каким именно регионом он в конечном счете работает.


*Можно* создать развертывание RDS без возможностей обеспечения высокой доступности в каждом регионе, но если даже одна виртуальная машина перезапустится в одном из регионов, произойдет отработки отказа. Это увеличит вероятность отработки отказа и связанного с ней снижения производительности.

## <a name="deployment-steps"></a>Шаги развертывания
Создайте следующие ресурсы в Azure, чтобы создать геоизбыточное развертывание RDS с несколькими центрами обработки данных.

1. Две группы ресурсов в разных регионах Azure. Например, RG A (активное развертывание, RG означает "resource group", то есть группа ресурсов) и RG B (пассивное развертывание).
2. Высокодоступное развертывание Active Directory в RG A. Можно использовать [новый шаблон домена AD с 2 контроллерами домена](https://azure.microsoft.com/resources/templates/active-directory-new-domain-ha-2-dc/), чтобы создать это развертывание.
3. Высокодоступное развертывание RDS в RG А. Используйте шаблон [развертывания фермы RDS с существующей средой Active Directory](https://azure.microsoft.com/resources/templates/rds-deployment-existing-ad/), чтобы создать базовое развертывание каталог. Затем следуйте указаниям в разделе [Высокая доступность служб удаленных рабочих столов](rds-plan-high-availability.md), чтобы настроить другие компоненты RDS для обеспечения высокой доступности.
4. Виртуальная сеть в RG B. Обязательно используйте диапазон адресов, который не перекрывает адреса развертывания в RG A.
5. [Подключение между виртуальными сетями](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-vnet-vnet-rm-ps), установленное между двумя группами ресурсов.
6. Две виртуальные машины AD в группе доступности в RG B. Убедитесь, что имена этих виртуальных машин отличаются от виртуальных машин AD в RG A. Разверните две виртуальные машины 2016 Windows Server в одной группе доступности, установите роль доменных служб Active Directory и затем повысьте их уровень до контроллера домена в домене, созданном на шаге 1.
7. Второе высокодоступное развертывание RDS в RG B. 
   1. Еще раз используйте шаблон [развертывания фермы RDS с существующей средой Active Directory](https://azure.microsoft.com/resources/templates/rds-deployment-existing-ad/), но на этот раз внесите в него следующие изменения. (Чтобы настроить шаблон, выберите его в коллекции, выберите **Развертывание в Azure** и затем — **Изменить шаблон**.)
      1. Настройте диапазон адресов для частного IP-адреса DNS-сервера в соответствии с виртуальной сетью в RG B. 
      
         Найдите dnsServerPrivateIp среди переменных. Измените IP-адрес по умолчанию (10.0.0.4) в соответствии с диапазоном адресов, заданным в виртуальной сети в RG B.
   
      2. Измените имена компьютеров таким образом, чтобы они не конфликтовали с компьютерами, размещенными в развертывании в RG A.
      
         Найдите виртуальные машины в разделе **Resources** шаблона. Измените **computerName** в разделе **osProfile**. Например, вместо "gateway" можно указать "gateway **-b**"; "[concat('rdsh-', copyIndex())]" может превратиться в "[concat('rdsh-b-', copyIndex())]", а "broker" можно заменить на "broker **-b**".
      
         (Можно также изменить имена виртуальных машин вручную после выполнения шаблона.)
   2. Как и на шаге 3 выше, используйте сведения из раздела [Высокая доступность служб удаленных рабочих столов](rds-plan-high-availability.md), чтобы настроить другие компоненты RDS для обеспечения высокой доступности.
8. Масштабируемый файловый сервер Локальных дисковых пространств с репликой хранилища в двух развертываниях. Используйте [сценарий PowerShell](https://github.com/robotechredmond/301-s2d-sr-dr-md/tree/master/scripts), чтобы развернуть [шаблон](https://github.com/robotechredmond/301-s2d-sr-dr-md) в группах ресурсов.

   > [!NOTE]
   > Вы можете подготовить хранилище вручную (вместо использования сценария PowerShell и шаблона). 
   >1. Разверните [двухузловой сервер SOFS Локальных дисковых пространств](rds-storage-spaces-direct-deployment.md) в RG A, чтобы хранить на нем диски профилей пользователей (UPD).
   >2. Разверните второй, идентичный сервер SOFS Локальных дисковых пространств в RG B. Обязательно используйте одинаковый объем хранилища в каждом кластере.
   >3. Настройте [реплику хранилища с асинхронной репликацией](../../storage/storage-replica/cluster-to-cluster-storage-replication.md) между ними.

### <a name="enable-upds"></a>Включение дисков UPD
Реплика хранилища реплицирует данные из исходного тома (связанного с основным (активным) развертыванием) на целевой том (связанный с дополнительным (пассивным) развертыванием). Изначально целевой кластер отображается в состоянии **Online (No Access)** (В сети (нет доступа)). Реплика хранилища отключает целевые тома и их буквы дисков или точки подключения. Это означает, что включить диски UPD для дополнительного развертывания, указав путь к общедоступному файловому ресурсу, не удастся, так как том не подключен. 

Хотите узнать больше об управлении репликацией? Ознакомьтесь с разделом [Межкластерная репликация хранилища](../../storage/storage-replica/cluster-to-cluster-storage-replication.md).

Чтобы включить диски UPD в обоих развертываниях, сделайте следующее.

1. Выполните командлет [Set-RDSessionCollectionConfiguration](https://docs.microsoft.com/powershell/module/remotedesktop/set-rdsessioncollectionconfiguration), чтобы включить диски профилей пользователей для основного развертывания (активного). Укажите путь к общедоступному файловому ресурсу на исходном томе (который был создана на шаге 7 развертывания).
2. Измените направление партнерства реплики хранилища, чтобы целевой том стал исходным томом (том будет подключен и станет доступным дополнительному развертыванию). Для этого можно выполнить командлет **Set-SRPartnership**. Например:

   ```powershell
   Set-SRPartnership -NewSourceComputerName "cluster-b-s2d-c" -SourceRGName "cluster-b-s2d-c" -DestinationComputerName "cluster-a-s2d-c" -DestinationRGName "cluster-a-s2d-c"
   ```
3. Включите диски профилей пользователей в дополнительном развертывании (пассивном). Используйте те же действия, что и для основного развертывания на шаге 1.
4. Измените направление партнерства реплики хранилища еще раз, чтобы первоначальный исходный том снова стал исходным томом в партнерстве реплики хранилища и основное развертывание получило доступ к общедоступному файловому ресурсу. Например:

   ```powershell
   Set-SRPartnership -NewSourceComputerName "cluster-a-s2d-c" -SourceRGName "cluster-a-s2d-c" -DestinationComputerName "cluster-b-s2d-c" -DestinationRGName "cluster-b-s2d-c"
   ```


### <a name="azure-traffic-manager"></a>Диспетчер трафика Azure 

Создайте профиль [диспетчера трафика Azure](/azure/traffic-manager/traffic-manager-overview), а также не забудьте выбрать метод маршрутизации по **приоритету**. Задайте для двух конечных точек общедоступные IP-адреса каждого из развертываний. В разделе **Конфигурация** укажите протокол HTTPS (вместо HTTP) и порт 443 (вместо 80). Запишите **срок жизни DNS** и настройте его соответствующим образом для требований отработки отказа. 

Обратите внимание на то, что конечные точки диспетчера трафика должны возвращать ответ "200 ОК" на запрос GET, чтобы они считались работоспособными. Объект publicIP, созданный на основе шаблонов RDS, будет работать, но не добавляйте приложение пути. Вместо этого можно предоставить пользователям URL-адрес диспетчера трафика с добавлением "/RDWeb", например: ```http://deployment.trafficmanager.net/RDWeb```

Развернув диспетчер трафика Azure с методом маршрутизации по приоритету, можно запретить пользователям доступ к пассивному развертыванию, пока работает активное развертывание. Если пользователи обращаются к пассивному развертыванию и направление реплики хранилища не было переключено для отработки отказа, пользователь не сможет завершить вход, так как развертывание будет безуспешно пытаться получить доступ к общедоступному файловому ресурсу в кластере Локальных дисковых пространств. В конечном итоге развертывание прекратит попытки и предоставит пользователю временный профиль.  

### <a name="deallocate-vms-to-save-resources"></a>Отмена выделения виртуальных машин для экономии ресурсов 
После настройки обоих развертываний можно завершить работу и отменить выделение дополнительной инфраструктуры RDS и виртуальных машин RDSH, чтобы уменьшить затраты на эти виртуальные машины. Виртуальные машины сервера SOFS Локальных дисковых пространств и сервера AD должны постоянно работать в дополнительном (пассивном) развертывании, чтобы обеспечить синхронизацию учетной записи и профиля пользователя.  

При отработке отказа необходимо будет запустить виртуальные машины, выделение которых было отменено. Такая конфигурация развертывания имеет преимущество с точки зрения экономии затрат, но это достигнуто в ущерб времени отработки отказа. В случае неустранимого сбоя в активном развертывании необходимо будет вручную запустить пассивное развертывание. Или потребуется сценарий автоматизации для обнаружения сбоя и автоматического запуска пассивного развертывания. В любом случае на запуск пассивного развертывания потребуется несколько минут, после чего она станет доступно для входа пользователей. Из-за этого служба будет некоторое время простаивать. Этого время простоя зависит от времени, необходимого для запуска инфраструктуры RDS и виртуальных машин RDSH (обычно это 2–4 минуты, если виртуальные машины запускаются параллельно, а не последовательно), и времени включения пассивного кластера (которое зависит от размера кластера; обычно это 2–4 минуты для двухузлового кластера с двумя дисками на каждом узле). 

### <a name="active-directory"></a>Active Directory 
Серверы Active Directory в каждом развертывании являются репликами в том же лесу или домене. В Active Directory есть встроенный протокол синхронизации для синхронизации четырех контроллеров домена. Тем не менее возможна некоторая задержка. Если новый пользователь добавляется на один сервер AD, его репликация на все серверы AD в двух развертываниях может потребовать некоторого времени. Следовательно, не забудьте предупредить пользователей не пытаться входить сразу же после добавления в домен. 

### <a name="rd-license-server"></a>Сервер лицензий удаленных рабочих столов 
Укажите [клиентскую лицензию удаленных рабочих столов "на пользователя"](rds-client-access-license.md) для каждого именованного пользователя, которому разрешен доступ к геоизбыточному развертыванию. Распределите клиентские лицензии "на пользователя" равномерно между двумя серверами лицензий удаленных рабочих столов в активном развертывании. Затем продублируйте эти клиентские лицензии на двух серверах лицензий удаленных рабочих столов в пассивном развертывании. Так как клиентские лицензии дублируются между активным и пассивным развертываниями, одновременно активным может быть только одно развертывание, доступное для подключения пользователей. В противном случае будут нарушены условия лицензионного соглашения.  

### <a name="image-management"></a>Управление образами 
При обновлении образов RDSH для установки обновлений программного обеспечения или новых приложений необходимо отдельно обновить коллекции RDSH в каждом развертывании, чтобы согласовать взаимодействие с пользователями в обоих развертываниях. Можно использовать [шаблон обновления коллекции RDSH](https://azure.microsoft.com/resources/templates/rds-update-rdsh-collection/), но обратите внимание на то, что для его выполнения инфраструктура RDS пассивного развертывания и виртуальные машины RDSH должны быть запущены. 

## <a name="failover"></a>Переход на другой ресурс

В случае развертывания по схеме "активный — пассивный" для отработки отказа необходимо запустить виртуальные машины в дополнительном развертывании. Это можно сделать вручную или с помощью сценария автоматизации. В случае неустранимого сбоя и выполнения отработки отказа сервера SOFS Локальных дисковых пространств измените направление партнерства реплики хранилища таким образом, чтобы целевой том стал исходным томом. Например:

   ```powershell
   Set-SRPartnership -NewSourceComputerName "cluster-b-s2d-c" -SourceRGName "cluster-b-s2d-c" -DestinationComputerName "cluster-a-s2d-c" -DestinationRGName "cluster-a-s2d-c"
   ```

Вы можете узнать больше из раздела [Межкластерная репликация хранилища](../../storage/storage-replica/cluster-to-cluster-storage-replication.md).

Диспетчер трафика Azure автоматически распознает сбой основного развертывания и определяет, что дополнительное развертывание находится в работоспособном состоянии (на виртуальных машинах шлюза удаленных рабочих столов, запущенных в RG B). Поэтому он направляет трафик пользователя в дополнительное развертывание. Пользователи могут использовать тот же URL-адрес диспетчера трафика, чтобы продолжить работу со своими удаленными ресурсами, наслаждаясь согласованным взаимодействием. Обратите внимание на то, что кэш DNS на стороне клиента не обновит запись до конца срока жизни, заданного в конфигурации диспетчера трафика Azure.

### <a name="test-failover"></a>Тестовая отработка отказа
В партнерстве реплики хранилища только один том (источник) может быть активным. Это означает, что при переключении направления партнерства реплики хранилища том в основном развертывании (RG A) становится назначением репликации и поэтому скрывается. Таким образом все пользователи, подключающиеся к RG A, больше не будут иметь доступ к своим дискам UPD, хранящимся на сервере SOFS в RG A. 

Вот как можно проверить отработку отказа, не лишая пользователей возможности войти в систему.
1. Запустите виртуальные машины инфраструктуры и виртуальные машины RDSH в RG B.
2. Переключите направление партнерства реплики хранилища (cluster-b-s2d-c становится исходным томом).
3. [Отключите конечную точку](/azure/traffic-manager/traffic-manager-manage-endpoints#to-disable-an-endpoint) RG A в профиле диспетчера трафика Azure, чтобы вынудить ATM направлять трафик в RG B. Для этого можно также использовать сценарий PowerShell.

   ```powershell
   Disable-AzureRmTrafficManagerEndpoint -Name publicIpA -Type AzureEndpoints -ProfileName MyTrafficManagerProfile -ResourceGroupName RGA -Force
   ```

RG B станет активным основным развертыванием. Вот как можно снова сделать RG A основным развертыванием.

1. Переключите направление партнерства реплики хранилища (cluster-a-s2d-c становится исходным томом).

   ```powershell
   Set-SRPartnership -NewSourceComputerName "cluster-a-s2d-c" -SourceRGName "cluster-a-s2d-c" -DestinationComputerName "cluster-b-s2d-c" -DestinationRGName "cluster-b-s2d-c"
   ```
2. Повторно включите конечную точку RG A в профиле диспетчера трафика Azure.

   ```powershell
   Enable-AzureRmTrafficManagerEndpoint -Name publicIpA -Type AzureEndpoints -ProfileName MyTrafficManagerProfile -ResourceGroupName RGA 
   ```

## <a name="considerations-for-on-premises-deployments"></a>Рекомендации для локальных развертываний

Хотя локальное развертывание не может использовать шаблоны быстрого запуска Azure, приведенные в этой статье, вы можете реализовать все роли инфраструктуры вручную. В локальном развертывании, где затраты не зависят от использования Azure, следует использовать модель "активный — активный" для ускорения отработки отказа.

Диспетчер трафика можно использовать для локальных конечных точек, но для его использования требуется подписка Azure. Кроме того, служба DNS, предоставляемая пользователям, обеспечивает им запись CNAME, которая просто направляет пользователей в основное развертывание. В случае отработки отказа измените запись CNAME в DNS для перенаправления на дополнительное развертывание. Таким образом пользователь использует один URL-адрес, как и в случае с диспетчером трафика Azure, который направляет пользователя в соответствующее развертывание. 

Если вы заинтересованы в создании модели "локальная среда — сайт Azure", рассмотрите возможность использования [Azure Site Recovery](https://docs.microsoft.com/azure/site-recovery/site-recovery-overview).
