---
title: Устранение неполадок подключения удаленного рабочего стола
description: Рекомендации по устранению неполадок, упорядоченных по Признак
ms.custom: na
ms.reviewer: rklemen;josh.bender
ms.suite: na
ms.tgt_pltfrm: na
ms.topic: troubleshooting
ms.assetid: ''
author: jobende
manager: ''
ms.author: v-tea;kaushika;rklemen;josh.bender
ms.date: 02/22/2019
ms.localizationpriority: medium
ms.openlocfilehash: 8965df09fd57decf7f4a1b6b89861e5a67034a0a
ms.sourcegitcommit: d3f73936160505a40633ad8dd5931ac5fe3eccdb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/12/2019
ms.locfileid: "9297403"
---
# Устранение неполадок подключения удаленного рабочего стола
Краткое описание некоторых из наиболее распространенных проблем служб удаленных рабочих столов (RDS) см. в разделе [часто задаваемые вопросы о клиентов удаленного рабочего стола](https://review.docs.microsoft.com/en-us/windows-server/remote/remote-desktop-services/clients/remote-desktop-client-faq). В этой статье описывается несколько более сложные подходов Устранение проблем подключения. Многие из этих процедур применяются ли вы устраняете простой конфигурации, такие как одном физическом компьютере, подключение к другому физический компьютер или более сложный процесс конфигурации. Некоторые процедуры решения проблем, которые присутствуют только в более сложных сценариев нескольких пользователей. Дополнительные сведения о удаленного рабочего стола компоненты и как они работают друг с другом см. в разделе [Архитектура служб удаленных рабочих столов](https://docs.microsoft.com/en-us/windows-server/remote/remote-desktop-services/desktop-hosting-logical-architecture).

> [!NOTE]  
> Многие из процедур, описанных в этой статье требуется доступ к несколько компьютеров, некоторые из которых может потребоваться удаленного доступа к. Дополнительные сведения о средства удаленного администрирования и о способах их настройки см. в разделе [Удаленного администрирования сервера средства (RSAT) для операционных систем Windows](https://support.microsoft.com/en-us/help/2693643/remote-server-administration-tools-rsat-for-windows-operating-systems).

В следующем списке идентифицируют тип проблемы, возникают вас (или пользователей).

- [Клиент удаленного рабочего стола не удается подключиться к удаленного рабочего стола, но не определенные проблемы или сообщений (общие шаги по устранению неполадок)](#no-specific-symptoms-or-messages-general-troubleshooting-steps)
- [Не удается подключиться к удаленному рабочему клиента удаленного рабочего стола и получает сообщение «Класс не зарегистрирован»](#client-cannot-connect-class-not-registered)
- [Не удается подключиться к удаленному рабочему клиента удаленного рабочего стола и получает «нет лицензии, доступные» или появляется сообщение «Ошибка безопасности»](#client-cannot-connect-no-licenses-available)
- [Пользователь получает сообщение «Доступ запрещен» или дважды потребуется предоставить учетные данные](#user-cannot-authenticate-or-must-authenticate-twice)
- [О подключении, получает сообщение «Службы удаленных рабочих столов в данный момент занят»](#on-connecting-user-receives-remote-desktop-service-is-currently-busy-message)
- [Отключает клиента удаленного рабочего стола и не может подключиться к того же сеанса](#rd-client-disconnects-and-cannot-reconnect-to-the-same-session)
- [Пользователь подключается к удаленной ноутбука по беспроводной сети, и затем ноутбук отключился от сети](#remote-laptop-disconnects-from-wireless-network).
- [Интерфейсом проблемы с удаленными приложениями или низкой производительности](#user-experiences-poor-performance-or-application-problems)

> [!NOTE]  
> Текущий список кодов отключения протокола удаленного рабочего СТОЛА см. в разделе [ExtendedDisconnectReasonCode перечисления](https://docs.microsoft.com/en-us/windows/desktop/TermServ/extendeddisconnectreasoncode). 

## Нет определенных проблем или сообщений (общие шаги по устранению неполадок)

Используйте эту процедуру, если не удается подключиться к удаленному рабочему столу клиентом удаленного рабочего стола, но не предоставляет сообщения или другие проблемы, которые помогут определить причину. Чтобы устранить многие из наиболее распространенных причины этих проблем, используйте следующие методы:

- [Проверьте состояние протокола RDP](#check-the-status-of-the-rdp-protocol)
- [Проверьте состояние службы протокола удаленного рабочего СТОЛА](#check-the-status-of-the-rdp-services)
- [Проверьте работоспособность прослушиватель протокола удаленного рабочего СТОЛА](#check-that-the-rdp-listener-is-functioning)
- [Проверьте порт прослушиватель протокола удаленного рабочего СТОЛА](#check-the-rdp-listener-port)

### Проверьте состояние протокола RDP

#### Проверьте состояние протокола RDP на локальном компьютере

Проверка и изменение состояния протокола RDP на локальном компьютере, см. в разделе [Включение удаленного рабочего стола](https://docs.microsoft.com/en-us/windows-server/remote/remote-desktop-services/clients/remote-desktop-allow-access#how-to-enable-remote-desktop).

> [!NOTE]  
> Если параметры удаленного рабочего стола недоступны, см. в разделе, [Проверьте, блокирует ли объекта групповой политики протокола удаленного рабочего СТОЛА](#check-whether-a-group-policy-object-gpo-is-blocking-rdp-on-a-local-computer).

#### Проверьте состояние протокола RDP на удаленном компьютере

> [!IMPORTANT]  
> Тщательно следуйте инструкциям в этом разделе. Неправильное изменение реестра может привести к серьезным проблемам. Раньше вы измените его [резервную копию реестра для восстановления](https://support.microsoft.com/en-us/help/322756%22%20target=%22_self%22) на случай, если возникают проблемы.

Чтобы проверить и изменить состояние протокола RDP на удаленном компьютере, используйте сетевого подключения реестра:

1. Выберите **Начать**, выберите **запускать**, а затем введите **regedt32**.
2. Откройте редактор реестра, выберите **файл**, а затем выберите **Подключить сетевой реестр**.
3. В диалоговом окне **Выбор компьютера** введите имя удаленного компьютера, выберите **Проверить имена**и затем нажмите кнопку **ОК**.
4. Перейдите к **HKEY\_LOCAL\_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Terminal сервера**.  
   ![Редактор реестра, с fDenyTSConnections входа](..\media\troubleshoot-remote-desktop-connections\RegEntry_fDenyTSConnections.png)
   - Если значение ключа **fDenyTSConnections** равно **0**, протокола удаленного рабочего СТОЛА включено
   - Если значение ключа **fDenyTSConnections** равно **1**, протокола удаленного рабочего СТОЛА будет отключен.
5. Для включения протокола удаленного рабочего СТОЛА, измените значение **fDenyTSConnections** с **1** на **0**.

#### Проверьте, блокирует ли объект групповой политики (GPO) протокола удаленного рабочего СТОЛА на локальном компьютере

Если нельзя включить протокола удаленного рабочего СТОЛА в пользовательском интерфейсе или если значение **fDenyTSConnections** возвращает значение **1** , после изменения ее, объект групповой Политики могут переопределить параметры уровня компьютера.

Для проверки конфигурации групповой политики на локальном компьютере, откройте окно командной строки от имени администратора и введите следующую команду:
```
gpresult /H c:\gpresult.html
```
После завершения этой команды, откройте gpresult.html. В **Конфигурация компьютера\\административные шаблоны\\компоненты Components\\Remote рабочего стола Services\\Remote рабочий стол сеанса Host\\Connections**найти политику **Разрешить пользователям подключаться удаленно с помощью служб удаленных рабочих столов** .

- Если **включен**параметр для этой политики, Групповая политика не блокирует RDP-подключений.
- Если **отключен**параметр для этой политики, проверьте **Результирующий объект групповой Политики**. Это объект групповой Политики, блокировать подключения протокола удаленного рабочего СТОЛА.
![Пример сегмент gpresult.html, в котором объект групповой Политики уровня домена ** блокировка протокола удаленного рабочего СТОЛА ** отключение протокола удаленного рабочего СТОЛА.](..\media\troubleshoot-remote-desktop-connections\GPResult_RDSH_Connections_GP.png)
   
  ![Пример сегмент gpresult.html, в котором ** локальной групповой политики ** Отключение протокола удаленного рабочего СТОЛА.](..\media\troubleshoot-remote-desktop-connections\GPResult_RDSH_Connections_LGP.png)

#### Проверьте, блокирует ли объект групповой Политики протокола удаленного рабочего СТОЛА на удаленном компьютере

Проверьте конфигурацию групповой политики на удаленном компьютере, команда выглядит почти так же, как и в случае локального компьютера:
```
gpresult /S <computer name> /H c:\gpresult-<computer name>.html
```
Эта команда создает файла (**gpresult-\<computer name\>.html**) использует тот же формат сведения в используется версия локального компьютера (**gpresult.html**).

#### Изменение объекта групповой Политики блокировки

Вы можете изменить эти параметры в редакторе объекта групповой политики (GPE) и групповой политики управления консоли (коэффициент валовой прибыли). Дополнительные сведения о том, как с помощью групповой политики, см. в разделе [Расширенного управления групповыми политиками](https://docs.microsoft.com/en-us/microsoft-desktop-optimization-pack/agpm/).

Чтобы изменить политика, используйте один из следующих методов:

- В GPE, доступ к соответствующий уровень объекта групповой политики (например, локальный или доменный) и перейдите к **Конфигурация компьютера\\административные шаблоны\\компоненты Components\\Remote рабочего стола Services\\Remote рабочий стол сеанса Host\\Connections**\\**Разрешить пользователям удаленное подключение с помощью служб удаленных рабочих столов**.  
   1. Сделайте политику **включено** или **Не настроено**.
   2. На затронутых компьютеров откройте окно командной строки от имени администратора и выполните команду **gpupdate/force** .
- В коэффициент валовой прибыли перейдите к Подразделение, в котором применяется политика на уязвимые компьютеры и удалить политику из Подразделения.

### Проверьте состояние службы протокола удаленного рабочего СТОЛА

На компьютере локально (клиент) и компьютера удаленного (цель) должны выполняться следующие службы:

- Службы удаленных рабочих столов (служб терминалов)
- Перенаправитель портов пользовательского режима службы удаленного рабочего стола (UmRdpService)

Можно использовать оснастку MMC служб для управления службами локально или удаленно. Вы также можете использовать PowerShell локально или удаленно (если удаленный компьютер настроен для приема удаленных команды PowerShell).

![Службы удаленных рабочих столов в оснастке MMC служб. Не изменяйте параметры службы по умолчанию.](..\media\troubleshoot-remote-desktop-connections\RDSServiceStatus.png)

На любом компьютере если один или оба они не работают, их запуска.

> [!NOTE]  
> При запуске службы удаленных рабочих столов, нажмите кнопку **Да** автоматически перезапустить службу удаленного рабочего стола служб предоставление порт перенаправитель.

### Проверьте работоспособность прослушиватель протокола удаленного рабочего СТОЛА

> [!IMPORTANT]  
> Тщательно следуйте инструкциям в этом разделе. Неправильное изменение реестра может привести к серьезным проблемам. Раньше вы измените его [резервную копию реестра для восстановления](https://support.microsoft.com/en-us/help/322756%22%20target=%22_self%22) на случай, если возникают проблемы.

#### Проверьте состояние прослушиватель протокола удаленного рабочего СТОЛА

В ходе данной процедуры используйте экземпляр PowerShell с правами администратора. Для локального компьютера можно также использовать командную строку с правами администратора. Тем не менее в этой процедуре используется PowerShell, так как команды же работают оба локально и удаленно.

1. Откройте окно PowerShell. Чтобы подключиться к удаленному компьютеру, введите **\<computer name\> Enter-PSSession-ComputerName**.
2. Введите **qwinsta**. 
    ![Команда qwinsta список процессов, прослушивает порт компьютера.](..\media\troubleshoot-remote-desktop-connections\WPS_qwinsta.png)
3. Если список содержит **rdp-tcp** со статусом **ожидать**, работает RDP-прослушиватель. Перейдите к [Проверьте порт прослушиватель протокола удаленного рабочего СТОЛА](#check-the-rdp-listener-port). В противном случае выполните на шаге 4.
4. Экспорт конфигурации прослушиватель протокола удаленного рабочего СТОЛА на работе компьютера.
    1. Вход на компьютере с той же версии операционной системы, как компьютер и получить доступ к реестру компьютера (например, с помощью редактора реестра).
    2. Перейдите на следующую запись реестра:  
        **HKEY\_LOCAL\_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Terminal Server\\WinStations\\RDP-Tcp**
    3. Экспортируйте операция REG-файл. Например в редактор реестра, щелкните правой кнопкой мыши запись, выберите **экспортировать**, а затем введите имя файла для сохранения экспортируемых параметров.
    4. Скопируйте экспортированные REG-файл на компьютер.
5. Чтобы импортировать конфигурацию прослушиватель протокола удаленного рабочего СТОЛА, откройте окно PowerShell с правами администратора на этот компьютер (или открыть окно PowerShell и подключитесь к компьютер удаленно).
   1. Выполнить резервное копирование существующих записей, введите следующую команду:  
   
      ```powershell  
      cmd /c 'reg export "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-tcp" C:\Rdp-tcp-backup.reg'   
      ```  
   

   2. Чтобы удалить существующую запись реестра, введите следующие команды:  
   
      ```powershell  
      Remove-Item -path 'HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-tcp' -Recurse -Force  
      ```
   
   3. Чтобы импортировать нового раздела реестра и перезапустите службу, введите следующие команды:  
   
      ```powershell  
      cmd /c 'regedit /s c:\<filename>.reg'  
      Restart-Service TermService -Force  
      ```   
      где \<filename\> — это имя файла экспортированные.
6. Проверьте конфигурацию, пытаясь удаленный рабочий стол еще раз. Если вы по-прежнему не удается подключиться, перезагрузите компьютер.
7. Если вы по-прежнему не удается подключиться, [Проверьте состояние самозаверяющий сертификат протокола удаленного рабочего СТОЛА](#check-the-status-of-the-rdp-self-signed-certificate).

#### Проверьте состояние самозаверяющий сертификат протокола удаленного рабочего СТОЛА

1. Если вы по-прежнему не удается подключиться, откройте оснастку MMC Сертификаты. Когда вам будет предложено выбрать хранилище для управления, выберите **учетную запись компьютера**, а затем выберите компьютер.
2. В папку « **сертификаты** » в разделе **Удаленного рабочего стола**удалите самозаверяющий сертификат протокола удаленного рабочего СТОЛА. 
    ![Удаленного рабочего стола сертификаты в оснастке MMC Сертификаты.](..\media\troubleshoot-remote-desktop-connections\MMCCert_Delete.png)
3. На этот компьютер перезапустите службу удаленных рабочих столов.
4. Обновите оснастки сертификатов.
5. Если самозаверяющий сертификат протокола удаленного рабочего СТОЛА не был создан повторно, [Проверьте разрешения папки MachineKeys](#check-the-permissions-of-the-machinekeys-folder).

#### Проверьте разрешения папки MachineKeys

1. На компьютер откройте проводник и перейдите к **C:\\ProgramData\\Microsoft\\Crypto\\RSA\\**.
2. Щелкните правой кнопкой мыши **MachineKeys**, выбор **свойств**, выберите « **Безопасность**» и выберите **Дополнительно**.
3. Убедитесь, что настроены следующие разрешения:
      - Builtin\\Administrators: Полный контроль
      - Все: Чтение, запись

### Проверьте порт прослушиватель протокола удаленного рабочего СТОЛА

На компьютере локально (клиент) и компьютера удаленного (цель) RDP-прослушиватель должна прослушивать порт 3389. Остальные приложения должны необходимо использовать этот порт.

> [!IMPORTANT]  
> Тщательно следуйте инструкциям в этом разделе. Неправильное изменение реестра может привести к серьезным проблемам. Раньше вы измените его [резервную копию реестра для восстановления](https://support.microsoft.com/en-us/help/322756%22%20target=%22_self%22) на случай, если возникают проблемы.

Чтобы проверить или изменить порт протокола удаленного рабочего СТОЛА, с помощью редактора реестра:

1. Выберите меню "Пуск", выберите **запускать**, а затем введите **regedt32**.
      - Чтобы подключиться к удаленному компьютеру, выберите **файл**, а затем выберите **Подключить сетевой реестр**.
      - В диалоговом окне **Выбор компьютера** введите имя удаленного компьютера, выберите **Проверить имена**и затем нажмите кнопку **ОК**.
2. Откройте реестр и перейдите к **HKEY\_LOCAL\_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Terminal Server\\WinStations\\\<listener\>**. 
    ![Подраздел номер_порта для протокола RDP.](..\media\troubleshoot-remote-desktop-connections\RegEntry_PortNumber.png)
3. Если **номер_порта** имеет значение, отличное от **3389**, замените его на **3389**. 
   > [!IMPORTANT]  
    > Можно работать служб удаленных рабочих столов с помощью другой порт. Однако делать это не рекомендуется. Устранение неполадок такую конфигурацию выходит за рамки этой статьи.
4. После изменения номер порта, перезапустите службу удаленных рабочих столов.

#### Убедитесь, что другое приложение не пытается использовать тот же порт

В ходе данной процедуры используйте экземпляр PowerShell с правами администратора. Для локального компьютера можно также использовать командную строку с правами администратора. Тем не менее в этой процедуре используется PowerShell, так как команды же работают локально и удаленно.

1. Откройте окно PowerShell. Чтобы подключиться к удаленному компьютеру, введите **\<computer name\> Enter-PSSession-ComputerName**.
2. Введите следующую команду:  
   
     ```powershell  
    cmd /c 'netstat -ano | find "3389"'  
    ```
  
    ![Команда netstat выводит список портов и служб, прослушивание на них.](..\media\troubleshoot-remote-desktop-connections\WPS_netstat.png)
1. Найдите запись TCP-порт 3389 (или назначенного порта протокола удаленного рабочего СТОЛА) со статусом **слушаю**. 
    > [!NOTE]  
   > ИД процесса (PID) процесса или службы с помощью этого порта отображается в столбце PID.
1. Чтобы определить, какое приложение использует порт 3389 (или назначенного порта протокола удаленного рабочего СТОЛА), введите следующую команду:  
   
     ```powershell  
    cmd /c 'tasklist /svc | find "<pid listening on 3389>"'  
    ```  
  
    ![Команды tasklist сообщает сведения о определенным процессом.](..\media\troubleshoot-remote-desktop-connections\WPS_tasklist.png)
1. Найдите запись код продукта, связанного с портом (отображаемого **netstat** ). Службы или процессы, которые связаны с этой PID отображаться справа.
1. Если приложения или службы, отличной от службы удаленных рабочих столов (TermServ.exe) использует порт, конфликт можно устранить с помощью одного из следующих методов:
      - Настройте другие приложения или службы использовать другой порт (рекомендуется).
      - Удалите другие приложения или службы.
      - Настройка протокола удаленного рабочего СТОЛА, использовать другой порт и перезапустите службу удаленных рабочих столов (не рекомендуется).

#### Проверьте, блокирует ли брандмауэр порт протокола удаленного рабочего СТОЛА

Используйте средство **psping** проверять ли компьютер может связаться с помощью порт 3389.

1. На компьютере, который отличается от компьютер, загрузите **psping** из <https://live.sysinternals.com/psping.exe>.
2. Откройте окно командной строки от имени администратора, перейдите в каталог, в котором установлен **psping**, а затем введите следующую команду:  
   
   ```  
   psping -accepteula <computer IP>:3389  
   ```
   
3. Проверьте результат выполнения команды **psping** для результатов, например следующие:  
      - **Подключение к \<computer IP\>**: достижима удаленный компьютер.
      - **(0% потерь)**: все попытки подключиться был выполнен успешно.
      - **Удаленный компьютер отклонен сетевое подключение**: удаленный компьютер недоступен.
      - **(100% убытки)**: не удалось выполнить все попытки подключиться.
1. Запуск **psping** на нескольких компьютерах для проверки того, чтобы подключиться к серверу уязвимой.
1. Обратите внимание на то, является ли компьютер блокирует подключения от всех других компьютеров, некоторые другие компьютеры или только для одного компьютера.
1. Рекомендуется дальнейшие действия:
      - Привлечение вашего администраторам, чтобы убедиться, что сеть разрешает трафик протокола удаленного рабочего СТОЛА на компьютере.
      - Исследуйте конфигурации все брандмауэры между компьютерами источника и компьютер (в том числе брандмауэр Windows на соответствующем компьютере) для определения ли брандмауэр блокируют порт протокола удаленного рабочего СТОЛА.

## Клиент не может подключиться, «Класс не зарегистрирован»

При попытке подключения к удаленному компьютеру с помощью клиентского компьютера под управлением Windows 10 версии 1709 или более поздней версии, клиент не может подключиться во время сервера узла сеансов удаленных рабочих столов сообщает сообщение, содержащий код ошибки «Класс не зарегистрирован (0x80040154)».

Эта проблема возникает, если у пользователя, который пытается подключиться обязательного профиля пользователя. Чтобы решить эту проблему, установите [24 июля 2018 г. — KB4338817 (16299.579 сборка ОС)](https://support.microsoft.com/en-us/help/4338817/windows-10-update-kb4338817) обновления Windows 10.

## Клиент не может подключиться, без доступных лицензий

Такая ситуация для развертываний, которые включают на сервере RDSH и сервером Лицензирование удаленных рабочих столов.

Определение типа поведение сталкиваются пользователи:

- Сеанс был отключен, поскольку доступны без лицензии или нет сервера лицензирования не доступен
- Было отказано в доступе из-за ошибки безопасности

Войдите в узлов сеансов удаленных рабочих Столов от имени администратора домена и откройте Diagnoser лицензии удаленных рабочих Столов. Проверьте наличие следующих сообщений:

  - Период отсрочки для удаленного рабочего стола сервера узла сеансов истек, но сервера узла сеансов удаленных рабочих Столов не был настроен с серверами лицензий. Если сервер лицензий не настроено для сервера узла сеансов удаленных рабочих Столов будут отклонены подключения на сервере узла сеансов удаленных рабочих Столов.
  - \_LT_computer name\> сервер лицензий недоступен. Это может быть вызвано проблемами подключения к сети и остановке службы Лицензирование удаленных рабочих столов на сервере лицензирования лицензирования удаленных рабочих Столов больше не устанавливается на компьютере.

Эти проблемы, как правило, связанные с помощью следующих сообщений пользователя:

  - Удаленный сеанс был отключен, поскольку для этого компьютера недоступны клиентских лицензий удаленного рабочего стола.
  - Удаленный сеанс был отключен, так как нет удаленного рабочего стола лицензии серверов может предоставить лицензию.

В данном случае [настроить службу лицензирования удаленных рабочих Столов](#configure-the-rd-licensing-service).

Если Diagnoser лицензии удаленных рабочих Столов перечислены других проблем, таких как «компонент X.224 RDP-протокола обнаружил ошибку в потоке протокола и отключил этого клиента», но могут быть проблема, которая влияет на сертификаты лицензий. Такие проблемы, как правило, связанные с сообщения для пользователей, например следующие:

Из-за ошибки безопасности клиент не может подключиться к серверу терминалов. После убедитесь, что вы вошли в сеть, повторите попытку подключения к серверу.

В данном случае [разделы реестра обновления X509 сертификата](#refresh-the-x509-certificate-registry-keys).

### Настройка службы лицензирования удаленных рабочих Столов

В следующей процедуре используется диспетчер серверов для изменения конфигурации. Сведения о том, как настроить и использовать диспетчер серверов см. в разделе [Диспетчера серверов](https://docs.microsoft.com/en-us/windows-server/administration/server-manager/server-manager).

1. Откройте диспетчер сервера и перейдите к **Служб удаленных рабочих столов**.
2. **Общие сведения о развертывании**выберите **задачи**, а затем выберите **Изменение свойств развертывания**.
3. Выберите **Лицензирования удаленных рабочих Столов**, а затем выберите соответствующий режим лицензирования для развертывания (**На устройство** или **На пользователя**).
4. Введите полное доменное имя (FQDN) сервера лицензий к удаленному рабочему Столу, а затем выберите **Добавить**.
5. При наличии более одного сервера лицензирования удаленных рабочих Столов, повторите шаг 4 для каждого сервера. 
    ![Параметры конфигурации сервера лицензий к удаленному рабочему Столу в диспетчере серверов.](..\media\troubleshoot-remote-desktop-connections\RDLicensing_Configure.png)

### Разделы реестра сертификат восстановления X509

> [!IMPORTANT]  
> Тщательно следуйте инструкциям в этом разделе. Неправильное изменение реестра может привести к серьезным проблемам. Раньше вы измените его [резервную копию реестра для восстановления](https://support.microsoft.com/en-us/help/322756%22%20target=%22_self%22) на случай, если возникают проблемы.

Чтобы устранить эту проблему, резервное копирование и перезапустите разделы реестра remove X509 сертификат, компьютер, а затем повторно сделать активным удаленных рабочих Столов сервера лицензирования. Чтобы сделать это, выполните следующие действия.

> [!NOTE]  
> На каждом сервере RDSH, выполните следующие действия.

1. Откройте редактор реестра и перейдите к **HKEY\_LOCAL\_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Terminal Server\\RCM**.
2. В меню Реестр выберите **Экспорт файла реестра**.
3. Введите **Экспортировать сертификат** в поле **имени файла** , а затем выберите **Сохранить**.
4. Щелкните правой кнопкой мыши каждый из следующих значений, выберите **Удалить**, а затем выберите **Да** для проверки удаления:  
      - **Сертификат**
      - **X509 сертификатов**
      - **X509 сертификатов идентификатор**
      - **X509 Certificate2**
5. Закройте редактор реестра, а затем перезапустите сервера RDSH.

## Пользователь не может пройти проверку подлинности или необходимо выполнить проверку подлинности дважды

Существует ряд проблем, которые могут вызвать проблемы, влияющие на проверку подлинности пользователя. В этом разделе рассматриваются в следующих случаях:

  - [Пользователь не имеет доступа с сообщением «ограниченные тип входа в систему»](#access-denied-restricted-type-of-logon)
  - [Пользователь или приложение отказано в доступе с событием 16965, «удаленных вызовов к базе данных SAM запрещен»](#access-denied-a-remote-call-to-the-sam-database-has-been-denied)
  - [Пользователь не могут выполнить вход с помощью смарт-карты](#a-user-cannot-sign-in-by-using-a-smart-card)
  - [Если удаленный компьютер заблокирован, пользователь должен ввести пароль дважды](#if-the-remote-pc-is-locked-a-user-needs-to-enter-a-password-twice)
  - [Пользователь не могут выполнить вход и получает сообщения «Исправления oracle CredSSP шифрования» и «ошибка проверки подлинности»](#user-cannot-sign-in-and-receives-authentication-error-and-credssp-encryption-oracle-remediation-messages)
  - [После обновления клиентских компьютеров, некоторые пользователи должен войти в два раза](#after-you-update-client-computers-some-users-need-to-sign-in-twice).
  - [Доступ на развертывание, которое использует RemoteGuard с несколькими брокеров подключений к удаленному рабочему Столу](#users-are-denied-access-on-a-deployment-that-uses-remote-credential-guard-with-multiple-rd-connection-brokers)

### Отказано в доступе, ограниченного типа входа в систему

В этом случае пользователь Windows 10 пытается подключиться к компьютерам Windows 10 или Windows Server 2016 отказано в доступе со следующим сообщением:

> Удаленный рабочий стол:  
> Системный администратор запретил тип входа в систему (сетевой или интерактивный), вы имеете право использовать. Обратитесь к системному администратору или технической поддержки.

Эта проблема возникает, когда уровень проверки подлинности сети (NLA) является обязательным для подключений протокола удаленного рабочего СТОЛА, а пользователь не является членом группы " **Пользователи удаленного рабочего стола** ". Это также может произойти, если доступ к **этому компьютеру из сети** не была назначена группе **Пользователей удаленного рабочего стола** .

Чтобы решить эту проблему, выполните одно из следующих действий.

  - [Изменить членство в группе пользователей или назначение прав пользователя](#modify-the-users-group-membership-or-user-rights-assignment).
  - Отключите NLA (не рекомендуется).
  - Используйте клиенты удаленного рабочего стола, отличных от Windows 10. Например в клиентах Windows 7 нет эту проблему.

#### Изменить членство в группе пользователей или назначение прав пользователя

Если эта проблема влияет на одного пользователя, наиболее простым решением этой проблемы является добавить пользователя в группу **Пользователей удаленного рабочего стола** .

Если пользователь уже является членом этой группы (или если несколько члены группы имеют та же проблема), проверьте конфигурацию права пользователя на удаленном компьютере Windows 10 или Windows Server 2016.

1. Откройте редактор объекта групповой политики (GPE) и подключитесь к локальной политики удаленного компьютера.
2. Перейдите к **Компьютеру Configuration\\Windows Settings\\Security Settings\\Local Policies\\User назначение прав**, щелкните правой кнопкой мыши **доступ к этому компьютеру из сети**и выберите **Свойства**.
3. Проверьте список пользователей и групп для **Пользователей удаленного рабочего стола** (или родительской группы).
4. Если список не включает **Пользователи удаленного рабочего стола** (или родительский группы, например **всем**) необходимо добавить его в список (при наличии более чем одной или двух компьютерах в вашей среде, используйте объект групповой политики).  
    Например членство по умолчанию для **доступа к этому компьютеру из сети** включает в себя **всех пользователей**. Если в развертывании применяется объект групповой политики для удаления **всех пользователей**, может потребоваться восстановление доступа, обновляя объект групповой политики для добавления **Пользователей удаленного рабочего стола**.

### Отказано в доступе, удаленных вызовов к базе данных SAM был отклонен

Это поведение, скорее всего, в случае, если контроллеров домена под управлением Windows Server 2016 или более поздней версии, и пользователь выполняет попытку подключения с помощью настроенного подключения приложения. В частности приложения, доступ к информации о профиле пользователя в Active Directory будет отказано в доступе.

Это поведение возникает в результате изменения в Windows. В Windows Server 2012 R2 и более ранних версий, когда пользователь входит в систему удаленного рабочего стола, контакты удаленного подключения диспетчера (RCM) (Восстановленное контроллера домена (DC) для запроса конфигураций, которые относятся к удаленному рабочему столу в объекте пользователя в домене Active Directory Службы (AD DS). Эта информация отображается на вкладке "Профиль служб удаленных рабочих столов" Свойства объекта пользователя в Active Directory — пользователи и компьютеры оснастки.

Начиная с Windows Server 2016, RCM больше не запрашивает объект пользователей в AD DS. Если вам требуется RCM запросить AD DS, так как вы используете атрибуты служб удаленных рабочих столов, необходимо вручную включить предыдущего поведения RCM.

> [!IMPORTANT]  
> Тщательно следуйте инструкциям в этом разделе. Неправильное изменение реестра может привести к серьезным проблемам. Раньше вы измените его [резервную копию реестра для восстановления](https://support.microsoft.com/en-us/help/322756%22%20target=%22_self%22) на случай, если возникают проблемы.

Чтобы включить устаревшие поведение RCM на сервере узла сеансов удаленных рабочих Столов, настройте следующие параметры реестра и перезапустите службу **Удаленных рабочих столов** :  
  - **Службы NT\\Terminal HKEY\_LOCAL\_MACHINE\\SOFTWARE\\Policies\\Microsoft\\Windows**
  - **Name\>\\ HKEY\_LOCAL\_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Terminal Server\\WinStations\\\<Winstation**  
      - Имя: **fQueryUserConfigFromDC**
      - Тип: **Reg\_DWORD**
      - Значение: **1** (десятичное)

Чтобы включить устаревшие поведение RCM на сервере, отличном от сервера узла сеансов удаленных рабочих Столов, настройки этих параметров реестра и следующий дополнительный параметр реестра (и перезапустите службу):
  - **HKEY\_LOCAL\_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Terminal сервера**

Дополнительные сведения об этом см. в статье базы Знаний 3200967 [изменения удаленным диспетчером подключений в Windows Server](https://support.microsoft.com/en-us/help/3200967/changes-to-remote-connection-manager-in-windows-server).

### Пользователь не могут выполнить вход с помощью смарт-карты

В этой статье рассматриваются три распространенных условиях, в которых пользователь не может выполнить вход к удаленному рабочему столу с помощью смарт-карты:  
  - [Пользователь не могут выполнить вход в филиале, который использует только для чтения домена для Контроллера](#cannot-sign-in-with-a-smart-card-in-a-branch-office-with-a-rodc)
  - [Пользователь не могут выполнить вход на компьютер Windows Server 2008 с пакетом обновления 2, недавно была обновлена](#cannot-sign-in-with-a-smart-card-to-a-windows-server-2008-sp2-computer)
  - [Пользователь не может оставаться в системе на компьютере с Windows, который был обновлен недавно и службы удаленных рабочих столов становится не отвечает (зависает)](#cannot-stay-signed-in-with-a-smart-card-and-remote-desktop-services-service-hangs)

#### Не удается войти в систему с помощью смарт-карты в филиале с RODC

Эта проблема возникает в развертываниях, которые включают на сервере RDSH на сайте ветвь, который использует RODC. Сервера RDSH размещается в корневом домене. Пользователи на сайте филиала принадлежат к домену дочерний и использовать смарт-карты для проверки подлинности. RODC настроен для кэша паролей (RODC, принадлежит **Разрешено группу репликации паролей RODC**). Когда пользователь пытается войти в сеансов на сервере RDSH, они получают сообщения, такие как «попытка входа в систему является недопустимой. Это может быть из-за поврежденных сведения имени пользователя или аутентификация.»

Это известная проблема так, корневого контроллера домена и RODC управления шифрованием учетные данные пользователя. Корневой контроллер домена использует ключ шифрования для шифрует учетные данные, а RODC предоставляет ключ расшифровки клиенту. Тем не менее эти два ключа не совпадают.

Чтобы обойти эту проблему, попробуйте изменить топологии контроллеров домена, либо путем отключения кэширования пароля на RODC или на сайте ветвь развертывания для записи контроллера домена. Альтернативный метод является перемещение сервера RDSH к одному домену дочерний как пользователей. Другой вариант — Разрешить пользователям выполнять вход без смарт-карт. Какие-либо из этих решений может потребоваться компромиссов производительность или уровень безопасности.

#### Не удается войти в систему с помощью смарт-карты на компьютер Windows Server 2008 с пакетом обновления 2

Эта проблема возникает, когда пользователи вход на компьютер Windows Server 2008 с пакетом обновления 2, который был обновлен с KB4093227 (2018.4B). Когда пользователь выполняет попытку выполнить вход с помощью смарт-карты, они запрещен доступ с сообщениями, например «действительные сертификаты не найдены. Убедитесь, что карта будет вставлена правильно и плотно.» В то же время удаленного сервера Windows записывает событие приложения «Ошибка при получении цифрового сертификата вставленную смарт-карты. Неверная подпись.»

Чтобы решить эту проблему, обновите компьютер Windows Server с 2018.06Bre-выпуска 4093227 КБ [Описание обновления безопасности для протокола удаленного рабочего стола Windows (RDP) к отказу в обслуживании в Windows Server 2008: 10 апреля 2018 г.](https://support.microsoft.com/en-us/help/4093227/security-update-for-vulnerabilities-in-windows-server-2008).

#### Не выполнять выход вход с помощью смарт-карты и зависаний службы удаленных рабочих столов

Эта проблема возникает, когда пользователи вход на компьютер Windows или Windows Server, которое было обновлено с 4056446 КБ. В первую очередь пользователь может войти в систему с помощью смарт-карты, но затем получает сообщение об ошибке «SCARD\_E\_NO\_SERVICE». Удаленный может перестать отвечать на запросы.

Чтобы обойти эту проблему, перезагрузите компьютер.

Чтобы решить эту проблему, обновите удаленный компьютер соответствующего исправления:

  - Windows Server 2008 с пакетом обновления 2: КБ 4090928, [Windows обрабатывает в процессе lsm.exe к утечке приложений смарт-карты могут отображаться ошибки «SCARD\_E\_NO\_SERVICE»](https://support.microsoft.com/en-us/help/4090928/scard-e-no-service-errors-when-windows-leaks-handles-in-the-lsm-exe)
  - Windows Server 2012 R2: КБ 4103724, [17 мая 2018 г. — KB4103724 (ознакомительная версия накопительного пакета ежемесячные)](https://support.microsoft.com/en-us/help/4103724/windows-81-update-kb4103724)
  - Windows Server 2016 и Windows 10 версии 1607: 4103720 КБ [17 мая 2018 г. — KB4103720 (14393.2273 сборка ОС)](https://support.microsoft.com/en-us/help/4103720/windows-10-update-kb4103720)

### Если удаленный компьютер заблокирован, пользователь должен ввести пароль дважды

Эта проблема может возникнуть, когда пользователь пытается подключиться к удаленному рабочему столу под управлением Windows 10 версии 1709 в развертывании, в котором RDP-подключений не требуют NLA. При следующих условиях Если удаленный рабочий стол заблокирован, пользователь должен ввести свои учетные данные дважды при подключении.

Чтобы решить эту проблему, обновите компьютер Windows 10 версии 1709 с 4343893 КБ [30 августа 2018 г. — KB4343893 (16299.637 сборка ОС)](https://support.microsoft.com/en-us/help/4343893/windows-10-update-kb4343893).

### Пользователь не могут выполнить вход и получает сообщения «Исправления oracle CredSSP шифрования» и «ошибка проверки подлинности»

Когда пользователь пытается войти с помощью любой версии Windows в Windows Vista с пакетом обновления 2 и более поздних версий или Windows Server 2008 с пакетом обновления 2 и более поздних версий, они запрещен доступ и получать сообщения примерно следующего:

  - Ошибка проверки подлинности. Указанная функция не поддерживается.
  - Это может быть вызвано CredSSP шифрования oracle исправления

«Исправления oracle CredSSP шифрования» относится к набору обновлений безопасности, выпущенных в марте апреля и мая 2018 г. CredSSP — это поставщик проверки подлинности, который обрабатывает запросы на проверку подлинности для других приложений. 13 март 2018 г. «3B» и последующих обновлений обращение к эксплойта, в котором злоумышленник может передавать учетные данные пользователя для выполнения кода в целевой системе.

Начальный обновлениями добавлена поддержка нового объекта групповой политики, **Исправления Oracle шифрования**, который имеет следующие возможные значения:

  - **Уязвимым**. Клиентских приложений, использующих CredSSP могут вернуться к незащищенной версии, но это поведение предоставляет удаленным рабочим столам для атак. Службы, использующие CredSSP принять клиентов, которые не были обновлены.
  - **Устранить**. Клиентских приложений, использующих CredSSP не могут выполнить откат до небезопасных версии, но службы, использующие CredSSP принять клиентов, которые не были обновлены.
  - **Принудительное обновление клиентов**. Клиентских приложений, использующих CredSSP не могут выполнить откат до небезопасных версий и службы, использующие CredSSP не будут принимать необновленные клиентов. 
    Примечание: Этот параметр следует развертывать до всех узлов удаленного поддерживают самая новая версия.

Обновление 8 мая 2018 г. изменено **Исправления Oracle шифрования** по умолчанию с **дефект** на **устраненный**. После этого изменения в месте клиенты удаленного рабочего стола, которые установлены обновления не удается подключиться к серверам, которые не имеют их (или обновлены серверами, на которых не был перезагружен). Дополнительные сведения о влиянии обновлений и виды взаимодействия, что они см. в статье базы Знаний 4093492, [CredSSP обновления для защиты от CVE-2018 г. — 0886](https://support.microsoft.com/en-us/help/4093492/credssp-updates-for-cve-2018-0886-march-13-2018).

Чтобы решить эту проблему, убедитесь, что все системы полностью обновлены и перезапуска. Полный список обновлений и другую информацию об уязвимости, см. в разделе [CVE-2018 г. — 0886 | Уязвимость удаленного CredSSP](https://portal.msrc.microsoft.com/en-us/security-guidance/advisory/CVE-2018-0886).

Чтобы обойти эту проблему, до завершения обновления, проверьте 4093492 КБ для допустимых типах подключений. Если нет не зайти альтернативы можно использовать один из следующих методов:

  - Затронутые клиентских компьютеров политики **Шифрования Oracle исправления** снова установите **дефект**.
  - Измените следующие политики в папке **Конфигурация компьютера\\административные шаблоны\\компоненты Components\\Remote рабочего стола Services\\Remote рабочий стол сеанса Host\\Security** групповой политики:  
      - **Требовать специального уровня безопасности для удаленных подключений (RDP)**: **включена** и выберите **протокола удаленного рабочего СТОЛА**.
      - **Требовать проверку подлинности для удаленных подключений с помощью проверки подлинности на уровне сети**: значение **отключен**.
      > [!IMPORTANT]  
      > Эти изменения снизить уровень безопасности развертывания. Они только должны быть временными, если вы используете вообще.

Дополнительные сведения о работе с помощью групповой политики см. в разделе [Изменение объекта групповой Политики блокировки](#modifying-a-blocking-gpo).

### После обновления клиентских компьютеров, некоторые пользователи должен войти в два раза

Пользователи на некоторых Windows 7 или Windows 10 версии 1709 вход для сеансов удаленных рабочих столов и немедленно см. в разделе второй экран входа в систему. Эта проблема возникает, если на клиентских компьютерах получили следующие обновления:

  - Windows 7: КБ 4103718, [8 мая 2018 г. — KB4103718 (ежемесячной накопительного пакета обновлений)](https://support.microsoft.com/en-us/help/4103718/windows-7-update-kb4103718)
  - Windows 10 версии 1709: КБ 4103727, [8 мая 2018 г. — KB4103727 (сборка ОС 16299.431)](https://support.microsoft.com/en-us/help/4103727/windows-10-update-kb4103727)

Чтобы решить эту проблему, убедитесь, что компьютеры, которые пользователи хотят для подключения к (а также RDSH или RDVI серверов) полностью обновляются через июня 2018 г.. Это включает в себя следующие обновления:

  - Windows Server 2016: КБ 4284880, [12 июня 2018 г. — KB4284880 (сборка ОС 14393.2312)](https://support.microsoft.com/en-us/help/4284880/windows-10-update-kb4284880)
  - Windows Server 2012 R2: КБ 4284815, [12 июня 2018 г. — KB4284815 (ежемесячной накопительного пакета обновлений)](https://support.microsoft.com/en-us/help/4284815/windows-81-update-kb4284815)
  - Windows Server 2012: КБ 4284855, [12 июня 2018 г. — KB4284855 (ежемесячной накопительного пакета обновлений)](https://support.microsoft.com/en-us/help/4284855/windows-server-2012-update-kb4284855)
  - Windows Server 2008 R2: КБ 4284826, [12 июня 2018 г. — KB4284826 (ежемесячной накопительного пакета обновлений)](https://support.microsoft.com/en-us/help/4284826/windows-7-update-kb4284826)
  - Windows Server 2008 с пакетом обновления 2: KB4056564, [Описание обновления безопасности для CredSSP уязвимость в Windows Server 2008, Windows Embedded POSReady 2009 и Windows Embedded стандартные 2009 г.: 13 марта 2018 г.](https://support.microsoft.com/en-us/help/4056564/security-update-for-vulnerabilities-in-windows-server-2008)

### Доступ на развертывание, которое использует удаленный Credential Guard с несколькими брокеров подключений к удаленному рабочему Столу

Эта проблема возникает при развертывании высокого уровня доступности, использующие две или несколько удаленного рабочего стола подключения брокеров, если удаленный Credential Guard — это используется. Пользователи не могут входить в удаленных рабочих столов.

Эта проблема возникает из-за удаленный Credential Guard использует для проверки подлинности Kerberos и NTLM ограничивает. Тем не менее в конфигурации с высоким уровнем доступности с балансировкой нагрузки, брокеров подключений к удаленному рабочему Столу не может поддерживать операции Kerberos.

Если вам необходимо использовать конфигурации с высоким уровнем доступности с балансировкой нагрузки брокеров подключений к удаленному рабочему Столу, можно обойти эту проблему, отключив удаленный Credential Guard. Дополнительные сведения об управлении Windows удаленного Credential Guard в Защитнике см. в разделе [учетных данных защиты удаленного рабочего стола с помощью удаленного Credential Guard](https://docs.microsoft.com/en-us/windows/security/identity-protection/remote-credential-guard#enable-windows-defender-remote-credential-guard).

## О подключении, пользователь получит сообщение «Службы удаленных рабочих столов в данный момент занят»

Чтобы определить, соответствующий ответ на эту проблему, выполните следующие действия:

1. Службы удаленных рабочих столов перестает отвечать на запросы (например, клиент удаленного рабочего стола появится «зависает» на экране приветствия).  
      - Если служба перестает отвечать на запросы, см. в разделе [памяти сервера RDSH проблему](#rdsh-server-memory-issue).
      - Если клиент представляется обычным образом взаимодействовать со службой, перейдите к следующему шагу.
2. Один или несколько пользователей отключить их сеансов удаленного рабочего стола, пользователи подключение снова?  
   - Если служба продолжает запрещают подключения независимо от того, сколько пользователей отключить их сеансы, см. в разделе [проблема прослушиватель удаленных рабочих Столов](#rd-listener-issue).
   - Если служба начинает принимать подключения снова в течение количества пользователей завершат сеансы, [проверить политику ограничения подключения](#check-the-connection-limit-policy).

### Проблема памяти сервера RDSH

На некоторых серверах Windows Server 2012 R2 RDSH было обнаружено утечку памяти. Со временем эти серверы сначала на отказ от подключения удаленного рабочего стола и локальной консоли войти в систему с сообщениями примерно следующего:

> Задачи, которую вы пытаетесь не может быть завершена из-за службы удаленного рабочего стола в данный момент занят. Повторите попытку через несколько минут. Другие пользователи по-прежнему сможете выполнить вход.

Клиенты удаленного рабочего стола, пытается подключиться также отвечать на запросы.

Чтобы обойти эту проблему, перезапустите сервера RDSH.

Чтобы решить эту проблему, примените 4093114 КБ [10 апреля 2018 г. — KB4093114 (ежемесячной накопительного пакета обновлений)] (file:///C:\\Users\\v-jesits\\AppData\\Local\\Microsoft\\Windows\\INetCache\\Content.Outlook\\FUB8OO45\\April%2010,%202018—KB4093114%20\(Monthly% [[[20Rollup\)), к серверам RDSH.

### Проблема прослушиватель удаленных рабочих Столов

Проблема уже было отмечено на некоторых серверах RDSH, которые были обновлены непосредственно из Windows Server 2008 R2 на Windows Server 2012 R2 или Windows Server 2016. Когда клиент удаленного рабочего стола подключается к серверу RDSH, сервера RDSH создает прослушивателя удаленных рабочих Столов для сеанса пользователя. Затронутые серверы хранят число прослушивателей к удаленному рабочему Столу, увеличивается при подключении, но никогда не уменьшается.

Чтобы обойти эту проблему, можно использовать следующие методы:

  - Перезапустите сервер RDSH, чтобы сбросить счетчик прослушивателей удаленных рабочих Столов
  - Изменение политики ограничения подключения, установив его очень большое значение. Дополнительные сведения об управлении политики ограничения подключения см. в разделе [проверить политику ограничения подключения](#check-the-connection-limit-policy).

Чтобы решить эту проблему, применяются перечисленные ниже обновления к серверам RDSH:

  - Windows Server 2012 R2: КБ 4343891, [30 августа 2018 г. — KB4343891 (ознакомительная версия накопительного пакета ежемесячные)](https://support.microsoft.com/en-us/help/4343891/windows-81-update-kb4343891)
  - Windows Server 2016: КБ 4343884, [30 августа 2018 г. — KB4343884 (сборка ОС 14393.2457)](https://support.microsoft.com/en-us/help/4343884/windows-10-update-kb4343884)

### Проверить политику ограничения подключения

Можно задать ограничение на количество одновременных подключения удаленного рабочего стола на уровне отдельных компьютеров или путем настройки объекта групповой политики (GPO). Ограничение по умолчанию не установлен.

Чтобы проверить текущие параметры и определите все существующие объекты групповой политики на сервере RDSH, откройте окно командной строки от имени администратора и введите следующую команду:
  
```
gpresult /H c:\gpresult.html
```
   
После завершения этой команды, откройте gpresult.html и в **Конфигурация компьютера\\административные шаблоны\\компоненты Components\\Remote рабочего стола Services\\Remote рабочий стол сеанса Host\\Connections**, **Максимальное число подключений** с помощью политики.

  - Если **отключен**параметр для этой политики, Групповая политика не ограничивается RDP-подключений.
  - Если **включен**параметр для этой политики, затем проверьте **Результирующий объект групповой Политики**. Если вам необходимо удалить или изменить предел подключения, измените этого объекта групповой Политики.

Чтобы применить изменения политики, откройте окно командной строки на соответствующем компьютере и введите следующую команду:
  
```
gpupdate /force
```
  
## Отключает и не может подключиться к того же сеанса клиента удаленных рабочих Столов

После клиента удаленного рабочего стола не удается установить подключение к удаленному рабочему, клиент не может подключиться немедленно. Пользователь получает сообщения об ошибках, например следующие:

  - Из-за ошибки безопасности клиент не может подключиться к серверу терминалов. После убедитесь, что вы вошли в сеть, повторите попытку подключения к серверу.
  - Удаленный рабочий стол отключен. Из-за ошибки безопасности клиент не может подключиться к удаленному компьютеру. Убедитесь, что вы вошли сети и повторите попытку подключения.

Позднее клиент удаленного рабочего стола подключается удаленного рабочего стола. Тем не менее вместо подключения клиента к исходному, сервера RDSH подключается клиент для нового сеанса. Проверка сервера RDSH просвечивает фон, исходного сеанса не был введен отключенном состоянии, но вместо этого остается активным.

Чтобы обойти эту проблему, можно включить политику **настроить интервал проверки активности подключения** в **Конфигурация компьютера\\административные шаблоны\\компоненты Components\\Remote рабочего стола Services\\Remote рабочего стола сеанс Host\\Connections **папка групповой политики. Если вы включите эту политику, необходимо ввести интервал проверки активности. Интервал определяет, как часто, в минутах, сервер проверяет состояние сеанса.

Эта проблема может быть вызвана неправильная настройка параметров проверки подлинности и конфигурации. Эти параметры можно настроить на уровне сервера, или с помощью объектов групповой политики. Параметры групповой политики доступны в папке **Конфигурация компьютера\\административные шаблоны\\компоненты Components\\Remote рабочего стола Services\\Remote рабочий стол сеанса Host\\Security** групповой политики.

1. Откройте конфигурация узла сеансов удаленных рабочих столов на сервере узла сеансов удаленных рабочих Столов.
2. В разделе **подключения**щелкните правой кнопкой мыши имя подключения и нажмите кнопку **Свойства**.
3. В диалоговом окне **свойств** для подключения на вкладке " **Общие** " на уровне **безопасности** выберите метод безопасности.
4. **Уровень шифрования**выберите нужный уровень. Можно выбрать **низкий**, **Совместимый с клиентом**, **высокий**или **С FIPS**.

> [!NOTE]  
>  - При взаимодействии клиентов и серверов узлов сеансов удаленных рабочих Столов требуют самый высокий уровень шифрования, шифрование с FIPS.
>  - Все параметры уровня шифрования, которые можно настроить в групповой политике переопределить конфигурацию, задаются с помощью средства настройки служб удаленных рабочих столов. Кроме того Если вы включите [Системная криптография: использовать FIPS-совместимые алгоритмы для шифрования, хэширования и подписывания](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/cc780081\(v=ws.10\)) политики, этот параметр переопределяет политики **установить уровень шифрования для клиентских подключений** . Системная политика шифрования находится в папке **Компьютера Configuration\\Windows Settings\\Security Settings\\Local Policies\\Security параметры** .
>  - При изменении уровня шифрования, новый уровень шифрования вступает в силу очередного входа в систему. Если вам требуется несколько уровней шифрования на одном сервере, установить несколько сетевых адаптеров и настроить каждый адаптер отдельно.
>  - Чтобы убедиться, что сертификат имеет соответствующий закрытый ключ в настройки служб удаленных рабочих столов, щелкните правой кнопкой мыши подключение, для которого требуется для просмотра сертификата, выберите **Общие**, выберите **Правка**, выберите сертификат, который вы хотите Просмотр, а затем выберите **Просмотр сертификата**. Оператор «у вас есть закрытый ключ, соответствующий этому сертификату» должно появиться в нижней части вкладки **Общие** . Можно также просмотреть эти данные с помощью оснастки сертификатов.
>  - Соответствие требованиям FIPS шифрования ( **Системная криптография: использовать FIPS-совместимые алгоритмы для шифрования, хэширования и подписывания** политики или **С FIPS** параметра в конфигурации сервера удаленного рабочего стола) шифрования и расшифровки данных, отправленных из клиент на сервер и с сервера клиенту, с помощью алгоритмов шифрования 140-1 федерального стандарта обработки информации (FIPS), с помощью Microsoft криптографических модулей. Дополнительные сведения см. в разделе [FIPS 140 проверки](https://docs.microsoft.com/en-us/windows/security/threat-protection/fips-140-validation).
>  - **Высокий** уровень шифрует данные, передаваемые от клиента на сервер и с сервера клиенту с помощью 128-битное шифрование.
>  - **Совместимый с клиентом** параметра шифрует данные, передаваемые между клиентом и сервером в ключа максимальной стойкости, поддерживаемой клиентом.
>  - Параметр **Low** шифрует данные, отправленные из клиента на сервере с помощью 56-разрядное шифрование.

## Удаленный ноутбука отключился от беспроводной сети

Эта проблема может возникнуть при подключении клиента удаленного рабочего стола для ноутбука с помощью к беспроводной сети 802. 1 x. Периодически ноутбук отключился от сети и не подключаются автоматически.

Это известная проблема, которая происходит, когда параметр проверки подлинности сетевого подключения к беспроводной сети **проверки подлинности пользователей**.

Чтобы обойти эту проблему, установите для параметра проверки подлинности сети на **компьютере**или **проверки подлинности пользователя или компьютера** .

 > [!NOTE]  
> Чтобы изменить параметры проверки подлинности сети на одном компьютере, может потребоваться использовать панель управления сетями и общим доступом для создания нового беспроводного подключения с новыми параметрами.

Полное описание того, как настроить параметры беспроводной сети, с помощью объектов групповой политики см. в разделе [политик Настройка беспроводной сети (IEEE 802.11)](https://docs.microsoft.com/en-us/windows-server/networking/core-network-guide/cncg/wireless/e-wireless-access-deployment#bkmk_policies).

## Взаимодействия пользователя с низкой производительности или ошибки в приложении

В этом разделе рассматриваются некоторые распространенные проблемы, которые пользователи могут возникнуть при использовании функцию удаленного рабочего стола:

  - [Пользователи, которым подключиться к новых виртуальных машин Microsoft Azure периодически возникают проблемы](#intermittent-problems-with-new-microsoft-azure-virtual-machines).
  - [Пользователи, которым подключения к удаленным рабочим столам 1709 версии Windows 10 могут возникнуть проблемы, воспроизведение видео](#video-playback-issues-on-windows-10-version-1709).
  - [Пользователи с профилями пользователей только для чтения, которые подключаются к удаленным рабочим столам Windows 10 не делиться своими рабочими столами.](#desktop-sharing-issues-on-windows-10)
  - [Подключение к удаленным рабочим столам Windows 10 с помощью клиентов, которые работают в старых версиях Windows 10 пользователей низкой производительности при отключении NLA](#performance-issues-when-mixing-versions-of-windows-10-if-nla-is-disabled)
  - [Когда пользователи запускать несколько приложений в сеансов удаленного рабочего стола и отключить и подключить часто, они могут возникать черный экран на подключение.](#black-screen-issue)

### Периодические проблемы с помощью новых виртуальных машин Microsoft Azure

Эта проблема затрагивает виртуальных машин, которые были выделены недавно. После пользователь подключается к виртуальной машине, сеансов удаленных рабочих столов не может загрузить всех пользовательских параметров правильно.

Чтобы обойти эту проблему, отключитесь от виртуальной машины, подождите, пока по крайней мере 20 минут и повторите попытку подключения.

Чтобы решить эту проблему, применяются перечисленные ниже обновления для виртуальных машин, соответствующим образом:

  - Windows 10 и Windows Server 2016: КБ 4343884, [30 августа 2018 г. — KB4343884 (сборка ОС 14393.2457)](https://support.microsoft.com/en-us/help/4343884/windows-10-update-kb4343884)
  - Windows Server 2012 R2: КБ 4343891, [30 августа 2018 г. — KB4343891 (ознакомительная версия накопительного пакета ежемесячные)](https://support.microsoft.com/en-us/help/4343891/windows-81-update-kb4343891)

### Воспроизведение видео проблемы в Windows 10 версии 1709

Эта проблема возникает при подключении пользователя к удаленных компьютеров под управлением Windows 10 версии 1709. Когда эти пользователи воспроизведение видео с помощью VMR9 кодек (видео MixingRenderer9), игрок отображается только черного окна.

Это известная проблема в Windows 10 версии 1709. Проблема возникает в Windows 10 версии 1703.

### Рабочий стол, общий доступ к проблемы в Windows 10

Эта проблема возникает, когда пользователь профиля пользователя только для чтения (и связанные реестра), например в сценарии терминала. При такой пользователь подключается к удаленному компьютеру под управлением Windows 10 версии 1803, они не могут совместно использовать свой рабочий стол.

Чтобы устранить эту проблему, применить обновление Windows 10 4340917, [24 июля 2018 г. — KB4340917 (17134.191 сборка ОС)](https://support.microsoft.com/en-us/help/4340917/windows-10-update-kb4340917).

### Проблем с производительностью при совместном использовании версий Windows 10, если отключена служба NLA

Эта проблема возникает, когда NLA отключена, и клиент удаленного рабочего стола под управлением Windows 10 подключения к удаленным рабочим столам под управлением различных версий Windows 10. Пользователи клиенты удаленного рабочего стола на компьютерах под управлением Windows 10 версии 1709 или более ранних версий наблюдаться низкая производительность при подключении к удаленным рабочим столам под управлением Windows 10 версии 1803 или более поздней версии.

Это происходит потому, что при отключении NLA старых клиентских компьютеров протоколу с более медленными при подключении к Windows 10 версии 1803 или более поздней версии.

Чтобы решить эту проблему, примените 4340917 КБ [24 июля 2018 г. — KB4340917 (17134.191 сборка ОС)](https://support.microsoft.com/en-us/help/4340917/windows-10-update-kb4340917).

### Черный экран

Эта проблема возникает в Windows 8.0, Windows 8.1, Windows 10 RTM и Windows Server 2012 R2. Пользователь запускает нескольких приложений в удаленного рабочего стола, а затем отключился от сеанса. Периодически повторном подключении удаленного рабочего стола для взаимодействия с приложениями, а затем отключить еще раз. В определенный момент при повторном подключении пользователя сеансов удаленных рабочих столов просто отображается черный экран. Пользователю необходимо завершить сеансов удаленных рабочих столов из консоли удаленного компьютера (или консоли сервера RDSH). Это действие останавливает приложения.

Чтобы решить эту проблему, применяются перечисленные ниже обновления соответствующим образом.

  - Windows 8 и Windows Server 2012: KB4103719, [17 мая 2018 г. — KB4103719 (ознакомительная версия накопительного пакета ежемесячные)](https://support.microsoft.com/en-us/help/4103719/windows-server-2012-update-kb4103719)
  - Windows 8.1 и Windows Server 2012 R2: KB4103724, [17 мая 2018 г. — KB4103724 (ознакомительная версия накопительного пакета ежемесячные)](https://support.microsoft.com/en-us/help/4103724/windows-81-update-kb4103724) и КБ 4284863, [21 июня 2018 г. — KB4284863 (ознакомительная версия накопительного пакета ежемесячные)](https://support.microsoft.com/en-us/help/4284863/windows-81-update-kb4284863)
  - Windows 10: Исправлена в KB4284860, [12 июня 2018 г. — KB4284860 (сборка ОС 10240.17889)](https://support.microsoft.com/en-us/help/4284860/windows-10-update-kb4284860)
