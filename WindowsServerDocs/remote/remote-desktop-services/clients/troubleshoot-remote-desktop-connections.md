---
title: Устранение неполадок с подключениями к удаленному рабочему столу
description: Процедуры устранения неполадок, упорядоченные по признакам
ms.custom: na
ms.reviewer: rklemen; josh.bender
ms.suite: na
ms.tgt_pltfrm: na
ms.topic: troubleshooting
ms.assetid: ''
author: RobVyK
manager: ''
ms.author: kaushika; rklemen; josh.bender; v-tea
ms.date: 02/22/2019
ms.localizationpriority: medium
ms.openlocfilehash: c6ce719ffa24cfc6704348c17548fe5cf33d9271
ms.sourcegitcommit: afb0602767de64a76aaf9ce6a60d2f0e78efb78b
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/20/2019
ms.locfileid: "67284139"
---
# <a name="troubleshooting-remote-desktop-connections"></a>Устранение неполадок с подключениями к удаленному рабочему столу
Краткое описание некоторых наиболее распространенных проблем со службами удаленных рабочих столов (RDS) см. в разделе с [часто задаваемыми вопросами о клиентах удаленного рабочего стола](https://review.docs.microsoft.com/en-us/windows-server/remote/remote-desktop-services/clients/remote-desktop-client-faq). В этой статье описаны современные подходы к устранению неполадок с подключением. Многие из этих процедур применяются для устранения неполадок как в простых конфигурациях (например, один физический компьютер подключен к другому физическому компьютеру), так и более сложных. Некоторые процедуры предназначены для решения проблем, возникающих только в сложных многопользовательских сценариях. Дополнительные сведения о компонентах удаленного рабочего стола и их взаимодействии см. в статье [Архитектура служб удаленных рабочих столов](https://docs.microsoft.com/windows-server/remote/remote-desktop-services/desktop-hosting-logical-architecture).

> [!NOTE]  
> Для выполнения многих процедур, описанных в этой статье, требуется доступ к нескольким компьютерам, к некоторым из них может потребоваться удаленный доступ. Дополнительные сведения о средствах удаленного администрирования и их настройке см. в статье [Remote Server Administration Tools (RSAT) for Windows operating systems](https://support.microsoft.com/en-us/help/2693643/remote-server-administration-tools-rsat-for-windows-operating-systems) (Средства удаленного администрирования сервера для операционных систем Windows).

В следующем списке выберите тип проблемы, с которой столкнулись вы или ваши пользователи.

- [Клиенту удаленного рабочего стола не удается подключиться к удаленному рабочему столу, но конкретные признаки или сообщения отсутствуют (общие действия по устранению неполадок)](#no-specific-symptoms-or-messages-general-troubleshooting-steps).
- [Клиенту удаленного рабочего стола не удается подключиться к удаленному рабочему столу, и он получает сообщение "Класс не зарегистрирован"](#client-cannot-connect-class-not-registered).
- [Клиенту удаленного рабочего стола не удается подключиться к удаленному рабочему столу, и он получает сообщение "Нет доступных лицензий" или "Ошибка безопасности"](#client-cannot-connect-no-licenses-available).
- [Пользователь получает сообщение "Доступ запрещен" или он должен указать учетные данные дважды](#user-cannot-authenticate-or-must-authenticate-twice).
- [При подключении пользователь получает сообщение о том, что служба удаленных рабочих столов сейчас занята](#on-connecting-user-receives-remote-desktop-service-is-currently-busy-message).
- [Клиент удаленного рабочего стола отключается и не может повторно подключиться к тому же сеансу](#rd-client-disconnects-and-cannot-reconnect-to-the-same-session).
- [Пользователь подключается к удаленному ноутбуку по беспроводной сети, после чего ноутбук отключается от сети](#remote-laptop-disconnects-from-wireless-network).
- [Пользователь столкнулся с низкой производительностью или проблемами с удаленными приложениями](#user-experiences-poor-performance-or-application-problems).

> [!NOTE]  
> Актуальный список кодов ошибок потери подключения по протоколу RDP см. в [перечислении ExtendedDisconnectReasonCode](https://docs.microsoft.com/windows/desktop/TermServ/extendeddisconnectreasoncode). 

## <a name="no-specific-symptoms-or-messages-general-troubleshooting-steps"></a>Признаки или сообщения отсутствуют (общие действия по устранению неполадок)

Выполните приведенные ниже действия, когда клиенту удаленного рабочего стола не удается подключиться к удаленному рабочему столу, но отсутствуют сообщения или другие признаки, по которым можно определить причину. Для устранения причин этой проблемы используйте следующие методы:

- [Проверьте состояние протокола RDP](#check-the-status-of-the-rdp-protocol).
- [Проверьте состояние служб RDP](#check-the-status-of-the-rdp-services).
- [Проверьте, работает ли прослушиватель протокола RDP](#check-that-the-rdp-listener-is-functioning).
- [Проверьте порт прослушивателя протокола RDP](#check-the-rdp-listener-port).

### <a name="check-the-status-of-the-rdp-protocol"></a>Проверка состояния протокола RDP

#### <a name="check-the-status-of-the-rdp-protocol-on-a-local-computer"></a>Проверка состояния протокола RDP на локальном компьютере

Сведения о том, как проверить и изменить состояние протокола RDP на локальном компьютере, см. в разделе [How to enable Remote Desktop](https://docs.microsoft.com/windows-server/remote/remote-desktop-services/clients/remote-desktop-allow-access#how-to-enable-remote-desktop) (Как включить удаленный рабочий стол).

> [!NOTE]  
> Если параметры удаленного рабочего стола недоступны, см. раздел [Проверка блокировки объектом групповой политики протокола RDP на локальном компьютере](#check-whether-a-group-policy-object-gpo-is-blocking-rdp-on-a-local-computer).

#### <a name="check-the-status-of-the-rdp-protocol-on-a-remote-computer"></a>Проверка состояния протокола RDP на удаленном компьютере

> [!IMPORTANT]  
> Внимательно выполните действия, описанные в этом разделе. Неправильное изменение реестра может привести к серьезным проблемам. Перед внесением изменений [создайте резервную копию реестра для его восстановления](https://support.microsoft.com/en-us/help/322756%22%20target=%22_self%22) в случае возникновения проблем.

Чтобы проверить и изменить состояние протокола удаленного рабочего стола на удаленном компьютере, используйте подключение сетевого реестра:

1. Щелкните **Пуск**, выберите **Выполнить**, а затем введите **regedt32**.
2. В редакторе реестра щелкните **Файл** и выберите пункт **Подключить сетевой реестр**.
3. В диалоговом окне **Выбор: "Компьютер"** введите имя удаленного компьютера, выберите **Проверить имена** и нажмите кнопку **ОК**.
4. Перейдите к записи **HKEY\_LOCAL\_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Terminal Server**.  
   ![Редактор реестра, в котором отображается запись fDenyTSConnections](../media/troubleshoot-remote-desktop-connections/RegEntry_fDenyTSConnections.png)
   - Если разделу **fDenyTSConnections** задано значение **0**, значит протокол RDP включен.
   - Если разделу **fDenyTSConnections** задано значение **1**, значит протокол RDP отключен.
5. Чтобы включить протокол RDP, для **fDenyTSConnections** замените значение **1** на **0**.

#### <a name="check-whether-a-group-policy-object-gpo-is-blocking-rdp-on-a-local-computer"></a>Проверка блокировки объектом групповой политики протокола RDP на локальном компьютере

Если не удается включить протокол RDP в пользовательском интерфейсе или для **fDenyTSConnections** возвращается значение **1** после его изменения, возможно, объект групповой политики переопределяет параметры на уровне компьютера.

Чтобы проверить конфигурацию групповой политики на локальном компьютере, откройте окно командной строки с правами администратора и введите следующую команду:
```
gpresult /H c:\gpresult.html
```
Когда команда будет выполнена, откройте файл gpresult.html. Выберите **Конфигурация компьютера\\Административные шаблоны\\Компоненты Windows\\Службы удаленных рабочих столов\\Узел сеансов удаленных рабочих столов\\Подключения** и найдите политику **Разрешить пользователям удаленное подключение с использованием служб удаленных рабочих столов**.

- Если для параметра этой политики задано значение **Включено**, групповая политика не блокирует подключения по протоколу RDP.
- Если же для параметра этой политики задано значение **Отключено**, проверьте **результирующий объект групповой политики**. Ниже показано, какой объект групповой политики блокирует подключения по протоколу RDP.
  ![Пример сегмента gpresult.html, в котором показано, что объект групповой политики на уровне домена **Block RDP** блокирует протокол RDP.](../media/troubleshoot-remote-desktop-connections/GPResult_RDSH_Connections_GP.png)
   
  ![Пример сегмента gpresult.html, в котором объект групповой политики уровня домена **Local Group Policy** блокирует протокол RDP.](../media/troubleshoot-remote-desktop-connections/GPResult_RDSH_Connections_LGP.png)

#### <a name="check-whether-a-gpo-is-blocking-rdp-on-a-remote-computer"></a>Проверка блокировки объектом групповой политики протокола RDP на удаленном компьютере

Чтобы проверить конфигурацию групповой политики на удаленном компьютере, нужно выполнить почти такую же команду, что и для локального компьютера.
```
gpresult /S <computer name> /H c:\gpresult-<computer name>.html
```
В файле (**gpresult-\<computer name\>.html**), который создается после выполнения этой команды, используется такой же формат данных, как в версии файла для локального компьютера (**gpresult.html**).

#### <a name="modifying-a-blocking-gpo"></a>Изменение блокирующего объекта групповой политики

Эти параметры можно изменить в редакторе объектов групповой политики (GPE) и консоли управления групповыми политиками (GPM). Дополнительные сведения об использовании групповой политики см. в статье [Advanced Group Policy Management](https://docs.microsoft.com/microsoft-desktop-optimization-pack/agpm/) (Расширенное управление групповыми политиками).

Чтобы изменить блокирующую политику, используйте один из следующих методов.

- В GPE выберите определенный уровень для объекта групповой политики (локальный или доменный) и щелкните **Конфигурация компьютера\\Административные шаблоны\\Компоненты Windows\\Службы удаленных рабочих столов\\Узел сеансов удаленных рабочих столов\\Подключения**\\**Разрешить пользователям удаленное подключение с использованием служб удаленных рабочих столов**.  
   1. Для политики задайте значение **Включена** или **Не задана**.
   2. На затронутых компьютерах откройте окно командной строки с правами администратора и выполните команду **gpupdate/force**.
- В GPM перейдите к подразделению, в котором блокирующая политика применяется к соответствующим компьютерам, и удалите эту политику.

### <a name="check-the-status-of-the-rdp-services"></a>Проверка состояния служб RDP

На локальном компьютере (клиентском) и удаленном компьютере (целевом) должны быть запущены следующие службы:

- службы удаленных рабочих столов (TermService);
- перенаправитель портов пользовательского режима служб удаленного рабочего стола (UmRdpService).

Для локального или удаленного управления службами можно использовать оснастку MMC. Можно также использовать PowerShell в локальном или удаленном расположении (если удаленный компьютер настроен для приема удаленных команд PowerShell).

![Службы удаленных рабочих столов в оснастке MMC "Службы" Не изменяйте параметры служб, заданные по умолчанию.](../media/troubleshoot-remote-desktop-connections/RDSServiceStatus.png)

На любом компьютере запустите одну или обе службы, если они запущены.

> [!NOTE]  
> Если вы запускаете службу удаленных рабочих столов, нажмите кнопку **Да**, чтобы служба перенаправителя портов пользовательского режима служб удаленного рабочего стола перезапустилась автоматически.

### <a name="check-that-the-rdp-listener-is-functioning"></a>Проверка состояния прослушивателя протокола RDP

> [!IMPORTANT]  
> Внимательно выполните действия, описанные в этом разделе. Неправильное изменение реестра может привести к серьезным проблемам. Перед внесением изменений [создайте резервную копию реестра для его восстановления](https://support.microsoft.com/en-us/help/322756%22%20target=%22_self%22) в случае возникновения проблем.

#### <a name="check-the-status-of-the-rdp-listener"></a>Проверка состояния прослушивателя RDP

Для выполнения этой процедуры используйте экземпляр PowerShell с разрешениями администратора. На локальном компьютере также можно использовать командную строку с разрешениями администратора. Но для этой процедуры используется PowerShell, так как одни и те же команды выполняются локально и удаленно.

1. Откройте окно PowerShell. Чтобы подключиться к удаленному компьютеру, введите **Enter-PSSession -ComputerName \<имя_компьютера\>** .
2. Введите **qwinsta**. 
    ![Команда qwinsta выводит список процессов, которые прослушиваются на порту компьютера.](../media/troubleshoot-remote-desktop-connections/WPS_qwinsta.png)
3. Если в списке содержится **rdp-tcp** с состоянием **Listen**, прослушиватель протокола удаленного рабочего стола работает. Перейдите к разделу [Проверка порта прослушивателя протокола RDP](#check-the-rdp-listener-port). В противном случае перейдите к шагу 4.
4. Экспортируйте конфигурацию прослушивателя RDP с рабочего компьютера.
    1. Войдите на компьютер с той же версией операционной системы, что и у затронутого компьютера, и получите доступ к реестру компьютера (например, с помощью редактора реестра).
    2. Перейдите к следующей записи реестра:  
        **HKEY\_LOCAL\_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Terminal Server\\WinStations\\RDP-Tcp**
    3. Экспортируйте запись в REG-файл. Например, в редакторе реестра щелкните запись правой кнопкой мыши, выберите пункт **Экспортировать**, а затем введите имя файла для экспортируемых параметров.
    4. Скопируйте экспортированный REG-файл на затронутый компьютер.
5. Чтобы импортировать конфигурацию прослушивателя протокола RDP, откройте окно PowerShell с разрешениями администратора на затронутом компьютере (или откройте окно PowerShell и подключитесь к этому компьютеру из удаленного расположения).
   1. Чтобы создать резервную копию для существующей записи реестра, введите следующую команду:  
   
      ```powershell  
      cmd /c 'reg export "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-tcp" C:\Rdp-tcp-backup.reg'   
      ```  
   

   2. Чтобы удалить резервную копию для существующей записи реестра, введите следующую команду:  
   
      ```powershell  
      Remove-Item -path 'HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-tcp' -Recurse -Force  
      ```
   
   3. Чтобы импортировать новую запись реестра и перезапустить службу, введите следующие команды:  
   
      ```powershell  
      cmd /c 'regedit /s c:\<filename>.reg'  
      Restart-Service TermService -Force  
      ```   
      Здесь \<filename\> — имя экспортированного REG-файла.
6. Проверьте конфигурацию, попытавшись еще раз подключиться к удаленному рабочему столу. Если подключиться все равно не удается, перезагрузите затронутый компьютер.
7. Если вы не смогли подключиться, [проверьте состояние самозаверяющего сертификата протокола RDP](#check-the-status-of-the-rdp-self-signed-certificate).

#### <a name="check-the-status-of-the-rdp-self-signed-certificate"></a>Проверка состояния самозаверяющего сертификата протокола RDP

1. Если подключиться так и не удалось, откройте оснастку MMC "Сертификаты". Когда будет предложено выбрать хранилище сертификатов для управления, выберите **Учетная запись компьютера** и затронутый компьютер.
2. В папке **Сертификаты** в разделе **Удаленный рабочий стол** удалите самозаверяющий сертификат протокола RDP. 
    ![Сертификаты удаленного рабочего стола в оснастке MMC "Сертификаты".](../media/troubleshoot-remote-desktop-connections/MMCCert_Delete.png)
3. На затронутом компьютере выполните следующие действия, чтобы перезапустить службу удаленных рабочих столов.
4. Обновите оснастку диспетчера сертификатов.
5. Если самозаверяющий сертификат протокола RDP не был создан повторно, [проверьте разрешения для папки MachineKeys](#check-the-permissions-of-the-machinekeys-folder).

#### <a name="check-the-permissions-of-the-machinekeys-folder"></a>Проверка разрешений для папки MachineKeys

1. На затронутом компьютере откройте проводник и перейдите к папке **C:\\ProgramData\\Microsoft\\Crypto\\RSA\\** .
2. Щелкните правой кнопкой мыши папку **MachineKeys**, а затем выберите **Свойства**, **Безопасность** и **Дополнительно**.
3. Убедитесь, что настроены следующие разрешения:
      - Builtin\\Администраторы: Полный доступ
      - Все: чтение и запись.

### <a name="check-the-rdp-listener-port"></a>Проверка порта прослушивателя протокола RDP

На локальном компьютере (клиентском) и удаленном компьютере (целевом) прослушиватель протокола RDP должен ожидать передачи данных через порт 3389. Другие приложения не должны использовать этот порт.

> [!IMPORTANT]  
> Внимательно выполните действия, описанные в этом разделе. Неправильное изменение реестра может привести к серьезным проблемам. Перед внесением изменений [создайте резервную копию реестра для его восстановления](https://support.microsoft.com/en-us/help/322756%22%20target=%22_self%22) в случае возникновения проблем.

Чтобы проверить или изменить порт протокола RDP, используйте редактор реестра:

1. Щелкните "Пуск", выберите **Выполнить**, а затем введите **regedt32**.
      - Чтобы подключиться к удаленному компьютеру, в редакторе реестра щелкните **Файл** и выберите пункт **Подключить сетевой реестр**.
      - В диалоговом окне **Выбор: "Компьютер"** введите имя удаленного компьютера, выберите **Проверить имена** и нажмите кнопку **ОК**.
2. Откройте реестр и перейдите к записи **HKEY\_LOCAL\_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Terminal Server\\WinStations\\\<listener\>** . 
    ![Подраздел PortNumber для протокола RDP.](../media/troubleshoot-remote-desktop-connections/RegEntry_PortNumber.png)
3. Если **PortNumber** имеет значение, отличное от **3389**, укажите значение **3389**. 
   > [!IMPORTANT]  
    > Для управления службами удаленного рабочего стола можно использовать другой порт. Но мы не рекомендуем это делать. Устранение неполадок, связанных с этой конфигурацией, не рассматривается в этой статье.
4. Изменив номер порта, перезапустите службу удаленных рабочих столов.

#### <a name="check-that-another-application-is-not-trying-to-use-the-same-port"></a>Убедитесь, что другое приложение не пытается использовать тот же порт.

Для выполнения этой процедуры используйте экземпляр PowerShell с разрешениями администратора. На локальном компьютере также можно использовать командную строку с разрешениями администратора. Но для этой процедуры используется PowerShell, так как одни и те же команды выполняются локально и удаленно.

1. Откройте окно PowerShell. Чтобы подключиться к удаленному компьютеру, введите **Enter-PSSession -ComputerName \<имя_компьютера\>** .
2. Введите следующую команду:  
   
     ```powershell  
    cmd /c 'netstat -ano | find "3389"'  
    ```
  
    ![Команда netstat выводит список портов, которые должны прослушивать службы.](../media/troubleshoot-remote-desktop-connections/WPS_netstat.png)
3. Найдите запись для TCP-порта 3389 (или назначенного RDP-порта) с состоянием **Ожидает вызова**. 
    > [!NOTE]  
   > Идентификатор процесса службы или процесса, использующих данный порт, отобразится в столбце "Идентификатор процесса".
4. Чтобы определить, какое приложение использует порт 3389 (или назначенный порт протокола RDP), введите следующую команду:  
   
     ```powershell  
    cmd /c 'tasklist /svc | find "<pid listening on 3389>"'  
    ```  
  
    ![Команда tasklist выводит данные об определенном процессе.](../media/troubleshoot-remote-desktop-connections/WPS_tasklist.png)
5. Найдите запись для номера процесса, связанного с портом (в выходных данных **netstat**). Службы или процессы, связанные с этим идентификатором процесса, отобразятся справа.
6. Если порт используется приложением или службой, отличающейся от служб удаленных рабочих столов (TermServ.exe), устранить конфликт можно с помощью одного из следующих методов:
      - В настройках такого приложения или службы укажите другой порт (рекомендуется).
      - Удалите другое приложение или службу.
      - В настройках протокола RDP укажите другой порт, а затем перезапустите службы удаленных рабочих столов (не рекомендуется).

#### <a name="check-whether-a-firewall-is-blocking-the-rdp-port"></a>Проверка блокировки порта протокола RDP брандмауэром

С помощью средства **psping** проверьте, доступен ли затронутый компьютер через порт 3389.

1. На компьютере, отличающемся от затронутого компьютера, скачайте **psping** из <https://live.sysinternals.com/psping.exe>.
2. Откройте окно командной строки с правами администратора, перейдите в каталог, где установлено средство **psping**, и введите следующую команду:  
   
   ```  
   psping -accepteula <computer IP>:3389  
   ```
   
3. Проверьте выходные данные команды **psping** на наличие таких результатов:  
      - **Connecting to \<computer IP\>** (Подключение к <IP-адрес_компьютера>): удаленный компьютер доступен.
      - **(0% loss)** (0 % потерь): все попытки подключения выполнены успешно.
      - **The remote computer refused the network connection** (Удаленный компьютер отклонил сетевое подключение): удаленный компьютер недоступен.
      - **(100% loss)** (100 % потерь): не удалось выполнить подключение.
1. Запустите **psping** на нескольких компьютерах, чтобы проверить возможность подключения к затронутому компьютеру.
1. Проверьте, блокирует ли этот компьютер подключения от всех остальных компьютеров, некоторых других компьютеров или только одного компьютера.
1. Рекомендуемые дальнейшие действия:
      - Попросите сетевых администраторов проверить, пропускает ли сеть трафик RDP к затронутому компьютеру.
      - Проверьте конфигурации всех брандмауэров между исходными компьютерами и затронутым компьютером (включая брандмауэр Windows на затронутом компьютере). Так вы определите, блокирует ли брандмауэр порт протокола RDP.

## <a name="client-cannot-connect-class-not-registered"></a>Клиенту не удается подключиться (код ошибки Class not registered (Класс не зарегистрирован))

Когда вы пытаетесь подключиться к удаленному компьютеру с помощью клиента под управлением Windows 10 версии 1709 и выше, клиент не сможет подключиться. Сервер узла сеансов удаленных рабочих столов (RDSH) выдаст сообщение, содержащее код ошибки Class not registered (0x80040154) (Класс не зарегистрирован).

Такая проблема возникает, если пользователь, который пытается подключиться, использует обязательный профиль пользователя. Чтобы устранить эту проблему, установите обновление Windows 10 [за 24 июля 2018 г. — KB4338817 (ОС сборки 16299.579)](https://support.microsoft.com/en-us/help/4338817/windows-10-update-kb4338817).

## <a name="client-cannot-connect-no-licenses-available"></a>Клиенту не удалось подключиться (нет доступных лицензий)

Такая ситуация наблюдается в развертываниях, в которых задействован сервер RDSH и сервер лицензирования удаленных рабочих столов.

Определите, какой тип поведения видят пользователи:

- Сеанс был отключен из-за отсутствия лицензий или сервера лицензирования.
- Доступ запрещен из-за ошибки безопасности.

Войдите на узел сеансов удаленных рабочих столов как администратор домена и откройте средство диагностики лицензирования удаленных рабочих столов. Найдите следующие сообщения:

  - Льготный период для сервера узла сеансов удаленных рабочих столов истек, но на этом сервере не были настроены серверы лицензирования. Подключение к этому серверу будет невозможно, пока для него не будет настроен сервер лицензирования.
  - Сервер лицензирования \<имя_компьютера\> недоступен. Это может быть вызвано проблемами в сети, прекращением работы службы лицензирования удаленных рабочих столов на сервере лицензирования или отсутствием на компьютере этих служб.

Как правило, эти проблемы связаны со следующими сообщениями для пользователя:

  - Удаленный сеанс отключен, так как для этого компьютера отсутствуют клиентские лицензии удаленного рабочего стола.
  - Удаленный сеанс отключен, так как отсутствуют доступные серверы лицензирования удаленных рабочих столов, которые могли бы обеспечить лицензирование.

В таком случае [настройте службу лицензирования удаленных рабочих столов](#configure-the-rd-licensing-service).

Если в средстве диагностики лицензий удаленных рабочих столов перечислены другие проблемы, например "Компонент X.224 RDP-протокола обнаружил ошибку в потоке протокола и отключил этот клиент", вероятно, возникла проблема, которая влияет на сертификаты лицензий. Как правило, такие проблемы связаны со следующими сообщениями для пользователя:

Из-за ошибки безопасности клиент не смог подключиться к серверу терминалов. Убедитесь, что вы вошли в сеть, и повторите попытку подключения к серверу.

В этом случае [обновите разделы реестра для сертификата X509](#refresh-the-x509-certificate-registry-keys).

### <a name="configure-the-rd-licensing-service"></a>Настройка службы лицензирования удаленных рабочих столов

В следующей процедуре используется диспетчер серверов для изменения конфигурации. Сведения о том, как настроить и использовать диспетчер серверов, см. в [этом разделе](https://docs.microsoft.com/windows-server/administration/server-manager/server-manager).

1. Откройте диспетчер серверов и перейдите в раздел **Службы удаленных рабочих столов**.
2. На вкладке **Обзор развертывания** выберите **Задачи**, а затем выберите **Изменить свойства развертывания**.
3. Выберите **Лицензирование удаленных рабочих столов** и подходящий режим лицензирования для развертывания (**На устройство** или **На пользователя**).
4. Укажите полное доменное имя (FQDN) сервера лицензирования удаленных рабочих столов, а затем выберите **Добавить**.
5. Если у вас несколько серверов лицензирования удаленных рабочих столов, повторите шаг 4 для каждого сервера. 
    ![Параметры конфигурации сервера лицензирования удаленных рабочих столов в диспетчере серверов.](../media/troubleshoot-remote-desktop-connections/RDLicensing_Configure.png)

### <a name="refresh-the-x509-certificate-registry-keys"></a>Обновление разделов реестра для сертификата X509

> [!IMPORTANT]  
> Внимательно выполните действия, описанные в этом разделе. Неправильное изменение реестра может привести к серьезным проблемам. Перед внесением изменений [создайте резервную копию реестра для его восстановления](https://support.microsoft.com/en-us/help/322756%22%20target=%22_self%22) в случае возникновения проблем.

Чтобы устранить эту проблему, создайте резервные копии для разделов реестра сертификата X509 и удалите эти разделы, а затем перезагрузите компьютер и повторно активируйте сервер лицензирования удаленных рабочих столов. Для этого выполните следующие действия.

> [!NOTE]  
> Выполните следующую процедуру на каждом сервере RDSH.

1. Откройте редактор реестр и перейдите к записи **HKEY\_LOCAL\_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Terminal Server\\RCM**.
2. В меню "Реестр" выберите команду **Экспорт файла реестра**.
3. В поле **Имя файла** введите **Экспортированный сертификат**, а затем выберите **Сохранить**.
4. Правой кнопкой мыши щелкните каждое из следующих значений, выберите **Удалить**, а затем нажмите кнопку **Да** для подтверждения удаления.  
      - **Сертификат**
      - **Сертификат X509**
      - **Идентификатор сертификата X509**
      - **X509 Certificate2**
5. Закройте редактор реестра и перезапустите сервер RDSH.

## <a name="user-cannot-authenticate-or-must-authenticate-twice"></a>Пользователю не удается пройти проверку подлинности или приходится проходить ее дважды

Проблемы, влияющие на проверку подлинности пользователя, могут возникать по нескольким причинам. В этом разделе рассматриваются следующие случаи:

  - [Пользователь получает отказ в доступе с сообщением "Ограничение по типу входа в систему"](#access-denied-restricted-type-of-logon).
  - [Пользователь или приложение получает отказ в доступе с событием 16965 и сообщением "Удаленный вызов к базе данных SAM отклонен"](#access-denied-a-remote-call-to-the-sam-database-has-been-denied).
  - [Пользователю не удается выполнить вход с помощью смарт-карты](#a-user-cannot-sign-in-by-using-a-smart-card).
  - [Если удаленный компьютер заблокирован, пользователю нужно дважды ввести пароль](#if-the-remote-pc-is-locked-a-user-needs-to-enter-a-password-twice).
  - [Пользователю не удается выполнить вход и он получает сообщения "Ошибка проверки подлинности" и "Защита CredSSP от атак с использованием криптографического оракула"](#user-cannot-sign-in-and-receives-authentication-error-and-credssp-encryption-oracle-remediation-messages).
  - [После обновления клиентских компьютеров некоторым пользователям приходится выполнять вход дважды](#after-you-update-client-computers-some-users-need-to-sign-in-twice).
  - [Пользователи получают отказ в доступе к развертыванию, использующему RemoteGuard с несколькими брокерами подключений к удаленному рабочему столу](#users-are-denied-access-on-a-deployment-that-uses-remote-credential-guard-with-multiple-rd-connection-brokers).

### <a name="access-denied-restricted-type-of-logon"></a>Отказано в доступе (ограничение по типу входа в систему)

В этом случае пользователь Windows 10, который пытается подключиться к компьютерам с Windows 10 или Windows Server 2016, получит отказ в доступе со следующим сообщением:

> Подключение к удаленному рабочему столу  
> Системный администратор ограничил типы входа в систему (сетевой или интерактивный), которые можно использовать. Обратитесь за помощью к системному администратору или в службу технической поддержки.

Эта проблема возникает, если для подключения к удаленному рабочему столу требуется пройти проверку подлинности на уровне сети (NLA), но пользователь не является членом группы **Пользователи удаленного рабочего стола**. Она также может возникать, если группе **Пользователи удаленного рабочего стола** не назначено право пользователя **Доступ к компьютеру из сети**.

Чтобы устранить эту проблему, выполните одно из следующих действий:

  - [Измените членство пользователя в группе или назначение прав пользователя](#modify-the-users-group-membership-or-user-rights-assignment).
  - Отключите NLA (не рекомендуется).
  - Используйте клиенты удаленного рабочего стола, отличающиеся от Windows 10. Например, в клиентах Windows 7 нет такой проблемы.

#### <a name="modify-the-users-group-membership-or-user-rights-assignment"></a>Изменение членства пользователя в группе или назначение прав пользователя

Если эта проблема затрагивает одного пользователя, наиболее простым решением будет добавить этого пользователя в группу **Пользователи удаленного рабочего стола**.

Если пользователь уже является членом этой группы (или если проблема возникает у нескольких членов группы), проверьте конфигурацию прав пользователей на удаленном компьютере Windows 10 или Windows Server 2016.

1. Откройте редактор объектов групповой политики (GPE) и подключитесь к локальной политике удаленного компьютера.
2. Выберите **Конфигурация компьютера\\Конфигурация Windows\\Параметры безопасности\\Локальные политики\\Назначение прав пользователя**, щелкните правой кнопкой мыши элемент **Доступ к компьютеру из сети** и выберите **Свойства**.
3. Просмотрите список пользователей и групп для группы **Пользователи удаленного рабочего стола** (или родительской группы).
4. Если в списке нет группы **Пользователи удаленного рабочего стола** (или родительской группы, например **Все**) необходимо добавить ее в список (если в развертывании несколько компьютеров, используйте объект групповой политики).  
    Например, членством по умолчанию для политики **Доступ к компьютеру из сети** будет **Все**. Если в развертывании используется объект групповой политики для удаления **Все**, может потребоваться восстановить доступ, обновив объект групповой политики, чтобы добавить группу **Пользователи удаленного рабочего стола**.

### <a name="access-denied-a-remote-call-to-the-sam-database-has-been-denied"></a>Отказано в доступе (удаленный вызов к базе данных SAM отклонен)

Такое поведение обычно возникает, если контроллеры домена работают под управлением Windows Server 2016 или более поздней версии, а пользователи пытаются подключиться с помощью настраиваемого приложения для подключения. В частности, отказ в доступе получат приложения, которым требуется доступ к сведениям профиля пользователя в Active Directory.

Такое поведение обусловлено изменением в Windows. В Windows Server 2012 R2 и более ранних версиях, когда пользователь выполняет вход на удаленный рабочий стол, диспетчер удаленных подключений (RCM) обращается к контроллеру домена (DC) для запроса конфигурации, относящейся к удаленному рабочему столу, в объекте пользователя в доменных службах Active Directory (AD DS). Эта информация отображается на вкладке "Профиль служб удаленных рабочих столов" в окне свойств объекта пользователя в оснастке MMC "Пользователи и компьютеры Active Directory".

Начиная с Windows Server 2016, RCM больше не запрашивает объект пользователя в AD DS. Если требуется, чтобы RCM обращался к AD DS из-за того, что вы используете атрибуты служб удаленных рабочих столов, потребуется вручную разрешить прежнее поведение RCM.

> [!IMPORTANT]  
> Внимательно выполните действия, описанные в этом разделе. Неправильное изменение реестра может привести к серьезным проблемам. Перед внесением изменений [создайте резервную копию реестра для его восстановления](https://support.microsoft.com/en-us/help/322756%22%20target=%22_self%22) в случае возникновения проблем.

Чтобы разрешить прежнее поведение RCM на сервере узла сеансов удаленных рабочих столов, настройте следующие записи реестра и перезапустите службу **Службы удаленных рабочих столов**:  
  - **HKEY\_LOCAL\_MACHINE\\SOFTWARE\\Policies\\Microsoft\\Windows NT\\Terminal Services**.
  - **HKEY\_LOCAL\_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Terminal Server\\WinStations\\\<Winstation name\>\\** .  
      - Имя: **fQueryUserConfigFromDC**.
      - Введите команду: **Reg\_DWORD**.
      - Значение: **1** (десятичное число).

Чтобы разрешить устаревшее поведение RCM на сервере, отличающемся от сервера RDSH, настройте эти записи реестра и следующую дополнительную запись (затем перезапустите службу).
  - **HKEY\_LOCAL\_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Terminal Server**

Дополнительные сведения об этом поведении см. в статье базы знаний № 3200967 [Changes to Remote Connection Manager in Windows Server](https://support.microsoft.com/en-us/help/3200967/changes-to-remote-connection-manager-in-windows-server) (Внесение изменений в диспетчер удаленных подключений в Windows Server).

### <a name="a-user-cannot-sign-in-by-using-a-smart-card"></a>Пользователю не удается выполнить вход с помощью смарт-карты

В этой статье рассматриваются три распространенные ситуации, когда пользователь не может войти на удаленный рабочий стол с помощью смарт-карты:  
  - [Пользователю не удается войти на сайт филиала, который использует контроллер домена (RODC) с доступом только на чтение](#cannot-sign-in-with-a-smart-card-in-a-branch-office-with-a-rodc).
  - [Пользователю не удается войти на компьютер Windows Server 2008 с пакетом обновления 2 (SP2), который был недавно изменен](#cannot-sign-in-with-a-smart-card-to-a-windows-server-2008-sp2-computer).
  - [Пользователь не остается в системе на компьютере Windows, который был недавно обновлен, и служба удаленных рабочих столов перестает отвечать на запросы (зависает)](#cannot-stay-signed-in-with-a-smart-card-and-remote-desktop-services-service-hangs).

#### <a name="cannot-sign-in-with-a-smart-card-in-a-branch-office-with-a-rodc"></a>Не удается выполнить вход в систему с помощью смарт-карты на сайт филиала с использованием RODC

Эта проблема возникает в развертываниях, в которых задействован сервер RDSH на сайте филиала, где используется RODC. Сервер RDSH размещен в корневом домене. Пользователи на сайте филиала относятся к дочернему домену и используют смарт-карты для проверки подлинности. Контроллер домена RODC настроен на кэширование паролей и принадлежит к **группе с разрешением реплицировать пароли RODC**. Когда пользователи пытаются выполнить вход в сеанс на сервере RDSH, они получают сообщение, например: "Неудачная попытка входа в систему. Указано неверное имя пользователя или другие неверные личные данные."

Это известная проблема заключается в том, что корневой контроллер домена и RODC управляют шифрованием учетных данных пользователя. Корневой контроллер домена использует ключ шифрования, чтобы зашифровать учетные данные, а RODC предоставляет ключ расшифровки клиенту. Но, эти два ключа не совпадают.

Чтобы решить эту проблему, попробуйте изменить топологию контроллера домена, отключив кэширование пароля на RODC или развернув на сайте филиала контроллер домена с доступом на запись. В качестве альтернативы можно переместить сервер RDSH в тот же дочерний домен, где находятся пользователи. Еще один вариант — разрешить пользователям выполнять вход без смарт-карты. Для любого из этих решений, возможно, потребуется пойти на компромисс в отношении производительности или уровня защиты.

#### <a name="cannot-sign-in-with-a-smart-card-to-a-windows-server-2008-sp2-computer"></a>Не удается выполнить вход в систему компьютера Windows Server 2008 с пакетом обновления 2 (SP2) с помощью смарт-карты

Эта проблема возникает, когда пользователи выполняют вход в систему компьютера Windows Server 2008 с пакетом обновления 2 (SP2), на котором установлено обновление KB4093227 (2018.4B). Когда пользователи пытаются выполнить вход с помощью смарт-карты, они получают отказ в доступе с сообщениями, например: "Действительные сертификаты не найдены. Убедитесь, что эта карта вставлена правильно и плотно сидит в разъеме". В то же время на компьютере Windows Server регистрируется событие приложения с сообщением "При получении цифрового сертификата с вставленной смарт-карты произошла ошибка: неправильная подпись."

Чтобы устранить эту проблему, обновите систему на компьютере Windows Server до повторного выпуска 2018.06 B (обновление KB4093227) [Description of the security update for the Windows Remote Desktop Protocol (RDP) denial of service vulnerability in Windows Server 2008: April 10, 2018](https://support.microsoft.com/en-us/help/4093227/security-update-for-vulnerabilities-in-windows-server-2008) (Описание обновления системы безопасности для защиты протокола RDP в Windows от уязвимости службы в Windows Server 2008 (10 апреля 2018 г.).

#### <a name="cannot-stay-signed-in-with-a-smart-card-and-remote-desktop-services-service-hangs"></a>Не удается оставаться в системе, вход в которую выполнен с помощью смарт-карты, и служба удаленных рабочих столов зависает

Эта проблема возникает, когда пользователи входят в систему компьютера Windows или Windows Server с обновлением KB4056446. Возможно, сначала пользователю удается войти в систему с помощью смарт-карты, но потом он получает сообщение об ошибке SCARD\_E\_NO\_SERVICE. Удаленный компьютер может перестать отвечать.

Чтобы устранить эту проблему, перезапустите удаленный компьютер.

Чтобы устранить эту проблему, обновите систему на удаленном компьютере, установив соответствующее исправление:

  - Windows Server 2008 с пакетом обновления 2 (SP2): KB4090928 [Windows leaks handles in the lsm.exe process and smart card applications may display SCARD\_E\_NO\_SERVICE errors](https://support.microsoft.com/en-us/help/4090928/scard-e-no-service-errors-when-windows-leaks-handles-in-the-lsm-exe) (Windows зависает на процессе lsm.exe, а в приложениях, для которых используются смарт-карты, может отображаться сообщение SCARD_E_NO_SERVICE).
  - Windows Server 2012 R2: [17 мая 2018 г. — KB4103724 (ознакомительная версия ежемесячного накопительного пакета)](https://support.microsoft.com/en-us/help/4103724/windows-81-update-kb4103724).
  - Windows Server 2016 и Windows 10 версии 1607: [17 мая 2018 г. — KB4103720 (сборка ОС 14393.2273)](https://support.microsoft.com/en-us/help/4103720/windows-10-update-kb4103720).

### <a name="if-the-remote-pc-is-locked-a-user-needs-to-enter-a-password-twice"></a>Если удаленный компьютер заблокирован, пользователю нужно дважды ввести пароль.

Эта проблема может возникать, когда пользователь пытается подключиться к удаленному рабочему столу под управлением Windows 10 версии 1709 в развертывании, где для подключений по протоколу RDP не требуется NLA. Если в таком случае удаленный рабочий стол оказался заблокированным, пользователь должен ввести свои учетные данные дважды при подключении.

Чтобы устранить эту проблему, обновите Windows 10 версии 1709 на соответствующем компьютере с использованием обновления за [30 августа 2018 г. — KB4343893 (ОС сборки 16299.637)](https://support.microsoft.com/en-us/help/4343893/windows-10-update-kb4343893).

### <a name="user-cannot-sign-in-and-receives-authentication-error-and-credssp-encryption-oracle-remediation-messages"></a>Пользователю не удается выполнить вход и он получает сообщения "Ошибка проверки подлинности" и "Защита CredSSP от атак с использованием криптографического оракула"

Когда пользователи пытаются выполнить вход с использованием любой версии Windows, начиная с Windows Vista с пакетом обновления 2 (SP2) или Windows Server 2008 с пакетом обновления 2 (SP2), они получают отказ в доступе и такие сообщения:

  - Произошла ошибка при проверке подлинности. Указанная функция не поддерживается.
  - Причиной ошибки может быть исправление шифрования CredSSP.

Ошибка "Исправление шифрования CredSSP" ссылается на набор обновлений системы безопасности, выпущенный в марте, апреле и мае 2018 г. CredSSP — это поставщик проверки подлинности, который обрабатывает запросы проверки подлинности для других приложений. Обновление за 13 марта 2018 г., 3B и все последующие обновления подверглись эксплойту, когда злоумышленник мог передать учетные данные пользователя для выполнения кода в целевой системе.

В исходные обновления была добавлена поддержка нового объекта групповой политики **Защита от атак с использованием криптографического оракула**, который может имеет следующие настройки:

  - **Vulnerable** (Уязвимо). Клиентские приложения, использующие CredSSP, могли переключиться на небезопасные версии, но из-за этого удаленные рабочие столы могли подвергаться атакам. Службы, использующие CredSSP, принимали клиенты, которые не были обновлены.
  - **Mitigated** (Устранено). Клиентские приложения, использующие CredSSP, не могут переключиться на небезопасные версии, но службы, использующие CredSSP, принимают клиенты, которые не были обновлены.
  - **Принудительно обновленные клиенты**. Клиентские приложения, использующие CredSSP, не могут переключиться на небезопасные версии, и службы, использующие CredSSP, не принимают клиентов без установленных обновлений. 
    Примечание. Этот параметр не следует развертывать, пока все узлы поддержки в удаленном расположении не будут поддерживать последнюю версию.

В обновлении за 8 мая 2018 г. значение для параметра по умолчанию **Защита от атак с использованием криптографического оракула** изменилось с **Уязвимость** для **Устранено**. После реализации этого изменения клиенты удаленного рабочего стола, на которых были установлены обновления, не могли подключиться к серверам без этого обновления (или к обновленным серверам, которые еще не были перезапущены). Дополнительные сведения о влиянии обновления и типах связи, которые они позволяют блокировать, см. в разделе [CredSSP updates for CVE-2018-0886](https://support.microsoft.com/en-us/help/4093492/credssp-updates-for-cve-2018-0886-march-13-2018) (Обновления CredSSP для CVE-2018-0886).

Для устранения этой проблемы убедитесь, что все системы полностью обновлены и перезапущены. Полный список обновлений и дополнительные сведения об уязвимостях см. в разделе [CVE-2018-0886 | CredSSP Remote Code Execution Vulnerability](https://portal.msrc.microsoft.com/en-us/security-guidance/advisory/CVE-2018-0886) (CVE-2018-0886 | Уязвимость CredSSP, допускающая удаленное выполнение кода).

Чтобы устранить эту проблему до завершения обновления, просмотрите список допустимых типов подключений в обновлении KB4093492. Если нет других осуществимых альтернатив, можете попробовать один из следующих методов:

- На затронутых клиентских компьютерах верните для политики **Защита от атак с использованием криптографического оракула** значение **Vulnerable** (Уязвимо).
- Измените следующие политики в папке групповой политики, выбрав **Конфигурация компьютера\\Административные шаблоны\\Компоненты Windows\\Службы удаленных рабочих столов\\Узел сеансов удаленных рабочих столов\\Безопасность**:  
  - для политики **Требовать использования специального уровня безопасности для удаленных подключений по протоколу RDP** задайте значение **Включено** и выберите **RDP**.
  - для политики **Требовать проверку подлинности пользователя для удаленных подключений путем проверки подлинности на уровне сети** задайте значение **Отключено**.
    > [!IMPORTANT]  
    > Эти изменения приведут к снижению уровня безопасности для развертывания. Такие изменения должны быть временными, если вы вообще будете их применять.

Дополнительные сведения о работе с групповой политикой см. в разделе [Изменение блокирующего объекта групповой политики](#modifying-a-blocking-gpo).

### <a name="after-you-update-client-computers-some-users-need-to-sign-in-twice"></a>После обновления клиентских компьютеров некоторым пользователям приходится выполнять вход дважды

Когда в некоторых версиях Windows 7 или Windows 10 версии 1709 пользователи выполняют вход в сеанс удаленного рабочего стола, сразу появляется второй экран входа в систему. Эта проблема возникает, если клиентские компьютеры получили следующие обновления:

  - Windows 7: [8 мая 2018 г. — KB4103718 (ежемесячный накопительный пакет)](https://support.microsoft.com/en-us/help/4103718/windows-7-update-kb4103718);
  - Windows 10 версии 1709: [8 мая 2018 г. — KB4103727 (сборка ОС 16299.431)](https://support.microsoft.com/en-us/help/4103727/windows-10-update-kb4103727).

Чтобы устранить эту проблему, убедитесь, что на компьютерах, к которым подключаются пользователи, (а также серверы RDSH или RDVI) установлены все обновления в том числе за июнь 2018 г. К ним относятся следующие обновления:

  - Windows Server 2016: [12 июня 2018 г. — KB4284880 (сборка ОС 14393.2312)](https://support.microsoft.com/en-us/help/4284880/windows-10-update-kb4284880);
  - Windows Server 2012 R2: [12 июня 2018 г. — KB4284815 (ежемесячный накопительный пакет)](https://support.microsoft.com/en-us/help/4284815/windows-81-update-kb4284815);
  - Windows Server 2012: [12 июня 2018 г. — KB4284855 (ежемесячный накопительный пакет)](https://support.microsoft.com/en-us/help/4284855/windows-server-2012-update-kb4284855);
  - Windows Server 2008 R2: [12 июня 2018 г. — KB4284826 (ежемесячный накопительный пакет)](https://support.microsoft.com/en-us/help/4284826/windows-7-update-kb4284826);
  - Windows Server 2008 с пакетом обновления 2 (SP2): обновление KB4056564, [Description of the security update for the CredSSP remote code execution vulnerability in Windows Server 2008, Windows Embedded POSReady 2009, and Windows Embedded Standard 2009: March 13, 2018](https://support.microsoft.com/en-us/help/4056564/security-update-for-vulnerabilities-in-windows-server-2008) (Описание обновления системы безопасности для устранения уязвимости CredSSP, допускающей удаленное выполнение кода, в Windows Server 2008, Windows Embedded POSReady 2009 и Windows Embedded Standard 2009: 13 марта 2018 г.).

### <a name="users-are-denied-access-on-a-deployment-that-uses-remote-credential-guard-with-multiple-rd-connection-brokers"></a>Пользователям запрещается доступ к развертыванию, которое использует Remote Credential Guard с несколькими брокерами подключений к удаленному рабочему столу

Эта проблема возникает в развертываниях с высоким уровнем доступности, в которых используются не менее двух брокеров подключений к удаленному рабочему столу и Remote Credential Guard в Защитнике Windows. Пользователям не удается войти на удаленные рабочие столы.

Эта проблема связана с тем, что Remote Credential Guard использует Kerberos для проверки подлинности, а также запрещает использовать NTLM. Но в конфигурации с высоким уровнем доступности и балансировкой нагрузки брокеры подключений к удаленному рабочему столу не могут поддерживать операции Kerberos.

Если нужно использовать конфигурации с высоким уровнем доступности и балансировкой нагрузки брокеров подключений к удаленному рабочему столу, эту проблему можно устранить, отключив Remote Credential Guard. Дополнительные сведения об управлении Remote Credential Guard в Защитнике Windows см. в статье [Protect Remote Desktop credentials with Windows Defender Remote Credential Guard](https://docs.microsoft.com/windows/security/identity-protection/remote-credential-guard#enable-windows-defender-remote-credential-guard) (Защита учетных данных удаленного рабочего стола с помощью Remote Credential Guard в Защитнике Windows).

## <a name="on-connecting-user-receives-remote-desktop-service-is-currently-busy-message"></a>При подключении пользователь получает сообщение "Служба удаленных рабочих столов сейчас занята"

Чтобы определить соответствующее решение этой проблемы, выполните следующие действия:

1. Перестает ли служба удаленных рабочих столов отвечать на запросы (например, клиент удаленного рабочего стола зависает на экране приветствия)?  
      - Если служба перестает отвечать, см. раздел [Проблемы с памятью на сервере RDSH](#rdsh-server-memory-issue).
      - Если клиент взаимодействует со службой без проблем, перейдите к следующему шагу.
2. Могут ли пользователи отключиться от сеансов удаленного рабочего стола и снова подключиться к ним?  
   - Если служба по-прежнему отклоняет подключения независимо от того, сколько пользователей отключили сеансы, см. раздел [Проблема с прослушивателем удаленных рабочих столов](#rd-listener-issue).
   - Если служба принимает подключения только после того, как несколько пользователей отключили сеансы, [проверьте политику ограничения числа подключений](#check-the-connection-limit-policy).

### <a name="rdsh-server-memory-issue"></a>Проблемы с памятью на сервере RDSH

На некоторых серверах RDSH с Windows Server 2012 R2 обнаружена утечка памяти. Со временем эти серверы начинают отклонять подключения к удаленному рабочему столу и входы в локальную консоль, и появляются такие сообщения:

> Не удается завершить требуемую операцию, так как службы удаленных рабочих столов сейчас заняты. Повторите попытку через несколько минут. Другие пользователи должны по-прежнему иметь возможность входа.

При попытке подключения клиенты удаленного рабочего стола также перестают отвечать на запросы.

Чтобы устранить эту проблему, перезапустите сервер RDSH.

Чтобы устранить эту проблему, примените к серверам RDSH обновление [10 апреля 2018 г. — KB4093114 (ежемесячный накопительный пакет)](file:///C:/Users/v-jesits/AppData/Local/Microsoft/Windows/INetCache/Content.Outlook/FUB8OO45/April%2010,%202018—KB4093114%20(Monthly%20Rollup).

### <a name="rd-listener-issue"></a>Проблема с прослушивателем удаленных рабочих столов

Проблема обнаружена на тех же серверах RDSH, которые были обновлены с Windows Server 2008 R2 непосредственно до Windows Server 2012 R2 или Windows Server 2016. Когда клиент удаленного рабочего стола подключается к серверу RDSH, этот сервер создает прослушиватель удаленных рабочих столов для сеанса пользователя. На затронутых серверах ведется подсчет числа прослушивателей к удаленному рабочему столу, которое увеличивается по мере подключения пользователей, но никогда не уменьшается.

Чтобы устранить эту проблему, можете воспользоваться одним из следующих методов:

  - Перезапустите сервер RDSH, чтобы сбросить счетчик прослушивателей удаленного рабочего стола.
  - Измените политику ограничения числа подключений, задав очень большое значение. Дополнительные сведения об управлении политикой ограничения числа подключения см. в разделе [Проверка политики ограничения числа подключений](#check-the-connection-limit-policy).

Чтобы устранить эту проблему, установите следующие обновления на серверы RDSH:

  - Windows Server 2012 R2: [30 августа 2018 г. — KB4343891 (ознакомительная версия ежемесячного накопительного пакета)](https://support.microsoft.com/en-us/help/4343891/windows-81-update-kb4343891);
  - Windows Server 2016: [30 августа 2018 г. — KB4343884 (сборка ОС 14393.2457)](https://support.microsoft.com/en-us/help/4343884/windows-10-update-kb4343884).

### <a name="check-the-connection-limit-policy"></a>Проверка политики ограничения числа подключений

Вы можете задать ограничение на число одновременных подключений к удаленному рабочему столу на уровне отдельного компьютера или путем настройки объекта групповой политики. По умолчанию ограничение не задано.

Чтобы проверить текущие параметры и определить существующие объекты групповой политики на сервере RDSH, откройте окно командной строки как администратор и введите следующую команду:
  
```
gpresult /H c:\gpresult.html
```
   
После выполнения команды откройте gpresult.html выберите **Конфигурация компьютера\\Административные шаблоны\\Компоненты Windows\\Службы удаленных рабочих столов\\Узел сеансов удаленных рабочих столов\\Подключения** и найдите политику **Ограничить количество подключений**.

  - Если для параметра этой политики задано значение **Отключено**, групповая политика не ограничивает подключения по протоколу RDP.
  - Если же для параметра этой политики задано значение **Включено**, проверьте **результирующий объект групповой политики**. Если нужно удалить или изменить ограничение числа подключений, измените этот объект групповой политики.

Чтобы применить изменения политики, откройте окно командной строки на соответствующем компьютере и введите следующую команду:
  
```
gpupdate /force
```
  
## <a name="rd-client-disconnects-and-cannot-reconnect-to-the-same-session"></a>Клиент удаленного рабочего стола отключается и не может повторно подключиться к тому же сеансу

Когда клиент удаленного рабочего стола теряет подключение к удаленному рабочему столу, ему не удается сразу же повторно подключиться. Пользователь получает такие сообщения об ошибках:

  - Из-за ошибки безопасности клиент не смог подключиться к серверу терминалов. Убедитесь, что вы вошли в сеть, и повторите попытку подключения к серверу.
  - Удаленный рабочий стол отключен. Из-за ошибки безопасности клиент не смог подключиться к удаленному компьютеру. Убедитесь в том, что вы вошли в сеть, и повторите попытку подключения к серверу.

Через некоторое время клиент удаленного рабочего стола выполняет повторное подключение к удаленному рабочему столу. Но вместо подключения к исходному сеансу на сервере RDSH клиент подключается к новому сеансу. При проверке сервера RDSH обнаруживается, что исходный сеанс не переходил в отключенное состояние, а оставался активным.

Чтобы устранить эту проблему, можете включить политику **Настроить интервал проверяемых на активность подключений** в папке групповой политики, выбрав **Конфигурация компьютера\\Административные шаблоны\\Компоненты Windows\\Службы удаленных рабочих столов\\Узел сеансов удаленных рабочих столов\\Подключения**. Если вы включите эту политику, нужно будет задать интервал проверки активности. Интервал проверки активности позволяет определить, как часто (в минутах) сервер проверяет состояние сеанса.

Эта проблема может возникнуть из-за неправильной настройки параметров проверки подлинности и конфигурации. Эти параметры можно настроить на уровне сервера или с помощью объектов групповой политики. Параметры групповой политики доступны в соответствующей папке. Чтобы перейти к ней, выберите **Конфигурация компьютера\\Административные шаблоны\\Компоненты Windows\\Службы удаленных рабочих столов\\Узел сеансов удаленных рабочих столов\\Безопасность**.

1. Откройте на сервере узла сеансов удаленных рабочих столов средство настройка узла сеансов удаленных рабочих столов.
2. В области **Подключения** щелкните правой кнопкой мыши имя подключения и выберите **Свойства**.
3. В диалоговом окне **Свойства** для этого подключения на вкладке **Общие** в разделе **Безопасность** выберите метод защиты.
4. В разделе **Уровень шифрования** выберите нужный уровень. Можно выбрать значение **Низкий уровень**, **Совместимый с клиентом**, **Высокий уровень** или **FIPS-совместимый**.

> [!NOTE]  
>  - Если для обмена данными между клиентами и серверами RDSH требуется самый высокий уровень шифрования, используйте FIPS-совместимое шифрование.
>  - Любые параметры уровня шифрования, настроенные в групповой политике, переопределяют конфигурацию, заданную с помощью средства настройки служб удаленных рабочих столов. Кроме того, если включить политику [Системная криптография: использовать FIPS-совместимые алгоритмы для шифрования, хэширования и подписывания](https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2003/cc780081\(v=ws.10\)), она переопределит политику **Установить уровень шифрования для клиентских подключений**. Чтобы перейти к папке с системными средствами шифрования, выберите **Конфигурация компьютера\\Конфигурация Windows\\Параметры безопасности\\Локальные политики\\Параметры безопасности**.
>  - После изменения уровня шифрования новый уровень шифрования вступает в действие при следующем входе пользователя. Если требуется несколько уровней шифрования на сервере, установите несколько сетевых адаптеров и настройте каждый из них в отдельности.
>  - Чтобы убедиться в наличии соответствующего закрытого ключа для сертификата, в средстве настройки служб удаленного рабочего стола щелкните правой кнопкой мыши имя подключения, для которого нужно проверить сертификат, выберите **Общие**, **Изменить** и нужный сертификат, а затем щелкните **Просмотреть сертификат**. В нижней части вкладки **Общие** должно отображаться сообщение "Есть закрытый ключ для этого сертификата". Эти сведения также можно просмотреть, используя оснастку диспетчера сертификатов.
>  - FIPS-совместимое шифрование (политика **Системная криптография: использовать FIPS-совместимые алгоритмы для шифрования, хэширования и подписывания** или параметр **FIPS-совместимый** в оснастке конфигурации сервера удаленных рабочих столов) предусматривает шифрование и расшифровку данных, передаваемых между клиентом и сервером, с использованием алгоритмов шифрования федерального стандарта обработки информации (FIPS) 140-1 и криптографических модулей от Майкрософт. Дополнительные сведения см. в статье [Проверка FIPS 140](https://docs.microsoft.com/windows/security/threat-protection/fips-140-validation).
>  - Если выбрать параметр **Высокий уровень**, для шифрования данных, передаваемых между клиентом и сервером, будет использоваться 128-битное шифрование.
>  - Если выбрать параметр **Совместимый с клиентом**, для шифрования данных, передаваемых между клиентом и сервером, будет использоваться ключ максимальной силы, поддерживаемой клиентом.
>  - Если же выбрать параметр **Низкий уровень**, для шифрования данных, передаваемых между клиентом и сервером, будет использоваться 56-битное шифрование.

## <a name="remote-laptop-disconnects-from-wireless-network"></a>Удаленный ноутбук отключается от беспроводной сети

Эта проблема может возникать, когда клиент удаленного рабочего стола подключается к ноутбуку по беспроводной сети 802.1 x. Периодически ноутбук отключается от беспроводной сети и не переподключается автоматически.

Это известная проблема возникает, если параметру проверки подлинности сети для беспроводного сетевого подключения задано значение **Проверка подлинности пользователя**.

Чтобы устранить эту проблему, установите для параметра проверки подлинности сети значение **Проверка подлинности пользователя или компьютера** или **Проверка подлинности компьютера**.

 > [!NOTE]  
> Чтобы изменить параметры проверки подлинности сети на одном компьютере, возможно, потребуется с помощью панели Центра управления сетями и общим доступом создать беспроводное подключение с новыми параметрами.

Полное описание того, как настроить параметры беспроводной сети с помощью объектов групповой политики, см. в разделе [Configure Wireless Network (IEEE 802.11) Policies](https://docs.microsoft.com/windows-server/networking/core-network-guide/cncg/wireless/e-wireless-access-deployment#bkmk_policies) (Настройка политик для беспроводной сети (IEEE 802.11)).

## <a name="user-experiences-poor-performance-or-application-problems"></a>Низкая производительность или проблемы с удаленными приложениями

В этом разделе рассматривается несколько распространенных проблем, с которыми пользователи могут столкнуться при использовании возможностей удаленного рабочего стола:

  - [Пользователи, подключающиеся к новым виртуальным машинам Microsoft Azure, периодически сталкиваются с проблемами](#intermittent-problems-with-new-microsoft-azure-virtual-machines).
  - [У пользователей, подключающихся к удаленным рабочим столам с Windows 10 версии 1709, могут возникнуть проблемы при воспроизведении видео](#video-playback-issues-on-windows-10-version-1709).
  - [Пользователи, которые используют профили с доступом на чтение и подключаются к удаленным рабочим столам с Windows 10, не могут предоставлять общий доступ к своим рабочим столам.](#desktop-sharing-issues-on-windows-10)
  - [Пользователи, которые подключаются к удаленным рабочих столам Windows 10 с помощью клиентов под управлением более ранних версий Windows 10, столкнутся с низкой производительностью, если NLA отключена](#performance-issues-when-mixing-versions-of-windows-10-if-nla-is-disabled).
  - [Когда пользователи запускают несколько приложений в сеансах удаленного рабочего стола, а также часто отключаются и повторно подключаются, может появиться черный экран при таком повторном подключении.](#black-screen-issue)

### <a name="intermittent-problems-with-new-microsoft-azure-virtual-machines"></a>Временные проблемы с новыми виртуальными машинами Microsoft Azure

Эта проблема затрагивает виртуальные машины, которые были недавно подготовлены. Когда пользователь подключится к виртуальной машине, сеанс удаленного рабочего стола может загрузить некоторые параметры пользователя неправильно.

Чтобы устранить эту проблему, отключитесь от виртуальной машины, подождите хотя бы 20 минут и подключитесь еще раз.

Чтобы устранить эту проблему, установите следующие обновления на виртуальные машины:

  - Windows 10 и Windows Server 2016: [30 августа 2018 г. — KB4343884 (сборка ОС 14393.2457)](https://support.microsoft.com/en-us/help/4343884/windows-10-update-kb4343884).
  - Windows Server 2012 R2: [30 августа 2018 г. — KB4343891 (ознакомительная версия ежемесячного накопительного пакета)](https://support.microsoft.com/en-us/help/4343891/windows-81-update-kb4343891);

### <a name="video-playback-issues-on-windows-10-version-1709"></a>Проблемы с воспроизведением видео в Windows 10 версии 1709

Эта проблема возникает, когда пользователи подключаются к удаленным компьютерам под управлением Windows 10 версии 1709. Когда эти пользователи воспроизводят видео с помощью кодека VMR9 (видео Video Mixing Renderer 9), в проигрывателе отображается только черное окно.

Это известная проблема в Windows 10 версии 1709. В Windows 10 версии 1703 такой проблемы нет.

### <a name="desktop-sharing-issues-on-windows-10"></a>Проблемы с совместным доступом к рабочему столу в Windows 10

Эта проблема возникает, когда у пользователя есть профиль с доступом только на чтение (и соответствующий куст реестра), например в сценарии киоска. Если такой пользователь подключается к удаленному компьютеру под управлением Windows 10 версии 1803, он не сможет совместно использовать рабочий стол.

Чтобы устранить эту проблему, примените обновление для Windows 10 за [24 июля 2018 г. — KB4340917 (сборка ОС 17134.191)](https://support.microsoft.com/en-us/help/4340917/windows-10-update-kb4340917).

### <a name="performance-issues-when-mixing-versions-of-windows-10-if-nla-is-disabled"></a>Проблемы с производительностью при одновременном использовании разных версий Windows 10 и отключении NLA

Эта проблема возникает при отключении NLA, когда клиентские компьютеры удаленного рабочего стола под управлением Windows 10 подключаются к удаленным рабочим столам под управлением других версий Windows 10. При работе с клиентами удаленных рабочих столов на компьютерах под управлением Windows 10 версии 1709 и выше пользователи могут столкнуться с низкой производительностью, когда попытаются подключиться к удаленным рабочим столам под управлением Windows 10 версии 1803 и выше.

Так происходит потому, что, если отключить NLA, клиентские компьютеры с более ранними версиями используют более медленный протокол при подключении к Windows 10 версии 1803 и выше.

Чтобы устранить эту проблему, примените обновление за [24 июля 2018 г. — KB4340917 (сборка ОС 17134.191)](https://support.microsoft.com/en-us/help/4340917/windows-10-update-kb4340917).

### <a name="black-screen-issue"></a>Ошибка, из-за которой появляется черный экран

Эта проблема возникает в Windows 8.0, Windows 8.1, Windows 10 RTM и Windows Server 2012 R2. Пользователь запускает несколько приложений на удаленном рабочем столе, а затем отключает сеанс. Периодически пользователь повторно подключается к удаленному рабочему столу для взаимодействия с приложениями, а затем снова отключает сеанс. В какой-то момент при повторном подключении пользователя к сеансу удаленного рабочего стола появляется черный экран. Пользователь должен завершить сеанс удаленного рабочего стола из консоли удаленного компьютера (или консоли сервера RDSH). Это позволит остановить работу приложений.

Чтобы устранить эту проблему, установите следующие обновления:

  - Windows 8 и Windows Server 2012: [17 мая 2018 г. — KB4103719 (ознакомительная версия ежемесячного накопительного пакета)](https://support.microsoft.com/en-us/help/4103719/windows-server-2012-update-kb4103719);
  - Windows 8.1 и Windows Server 2012 R2: [17 мая 2018 г. — KB4103724 (ознакомительная версия ежемесячного накопительного пакета)](https://support.microsoft.com/en-us/help/4103724/windows-81-update-kb4103724) и [21 июня 2018 г. — KB4284863 (ознакомительная версия ежемесячного накопительного пакета)](https://support.microsoft.com/en-us/help/4284863/windows-81-update-kb4284863).
  - Windows 10: [12 июня 2018 г. — KB4284860 (сборка ОС 10240.17889)](https://support.microsoft.com/en-us/help/4284860/windows-10-update-kb4284860).
