---
title: Устранение неполадок подключений удаленного рабочего стола
description: Устранение неполадок в процедурах, упорядоченных по степени Симптом
ms.custom: na
ms.reviewer: rklemen; josh.bender
ms.suite: na
ms.tgt_pltfrm: na
ms.topic: troubleshooting
ms.assetid: ''
author: RobVyK
manager: ''
ms.author: kaushika; rklemen; josh.bender; v-tea
ms.date: 02/22/2019
ms.localizationpriority: medium
ms.openlocfilehash: 4bbdd17f5e6e2b161e0dda0e172ea862a9107841
ms.sourcegitcommit: 564158d760f902ced7f18e6d63a9daafa2a92bd4
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/01/2019
ms.locfileid: "64988338"
---
# <a name="troubleshooting-remote-desktop-connections"></a>Устранение неполадок подключений удаленного рабочего стола
Краткое описание некоторых наиболее распространенных проблем службы удаленных рабочих столов (RDS), см. в разделе [часто задаваемые вопросы о клиентах удаленного рабочего стола](https://review.docs.microsoft.com/en-us/windows-server/remote/remote-desktop-services/clients/remote-desktop-client-faq). В этой статье описывается несколько более современные подходы для устранения проблем с соединением. Многие из этих процедур применяются ли вы устраняете простую конфигурацию, такие как один физический компьютер, подключения к другой физический компьютер или более сложные конфигурации. Некоторые процедуры решения проблем, возникающих только в более сложных сценариях несколькими пользователями. Дополнительные сведения о удаленного рабочего стола компоненты и их совместной работы, см. в разделе [архитектуры служб удаленных рабочих столов](https://docs.microsoft.com/en-us/windows-server/remote/remote-desktop-services/desktop-hosting-logical-architecture).

> [!NOTE]  
> Многие из процедур, описанных в этой статье требуется доступ к нескольким компьютерам, некоторые из которых может потребоваться получить удаленный доступ к. Дополнительные сведения о средствах удаленного администрирования и их настройке см. в разделе [удаленного администрирования сервера средства (RSAT) для операционных систем Windows](https://support.microsoft.com/en-us/help/2693643/remote-server-administration-tools-rsat-for-windows-operating-systems).

В следующем списке Определите тип признаком того, что при возникновении вы (или ваши пользователи).

- [Клиент удаленного рабочего стола не удается подключиться к удаленному рабочему столу, но нет конкретных проблем или сообщений (Общие действия по устранению неполадок)](#no-specific-symptoms-or-messages-general-troubleshooting-steps)
- [Клиент удаленного рабочего стола не удается подключиться к удаленному рабочему столу и получает сообщение «Класс не зарегистрирован»](#client-cannot-connect-class-not-registered)
- [Клиент удаленного рабочего стола не удается подключиться к удаленному рабочему столу и получает «нет доступных лицензий» или сообщение «Ошибка безопасности»](#client-cannot-connect-no-licenses-available)
- [Пользователь получает сообщение «Отказано в доступе», или необходимо предоставить учетные данные дважды](#user-cannot-authenticate-or-must-authenticate-twice)
- [О подключении, получает сообщение «Службы удаленных рабочих столов в настоящее время занято»](#on-connecting-user-receives-remote-desktop-service-is-currently-busy-message)
- [Клиент удаленного рабочего стола, отключается и сможет повторно подключиться к тому же сеансу](#rd-client-disconnects-and-cannot-reconnect-to-the-same-session)
- [Пользователь подключается к удаленной ноутбука по беспроводной сети, а затем переносной компьютер отключается от сети](#remote-laptop-disconnects-from-wireless-network).
- [Работа пользователя к снижению производительности или проблемы с удаленными приложениями](#user-experiences-poor-performance-or-application-problems)

> [!NOTE]  
> Текущий список кодов disconnect RDP, см. в разделе [ExtendedDisconnectReasonCode перечисления](https://docs.microsoft.com/en-us/windows/desktop/TermServ/extendeddisconnectreasoncode). 

## <a name="no-specific-symptoms-or-messages-general-troubleshooting-steps"></a>Нет конкретных проблем или сообщений (Общие действия по устранению неполадок)

Когда клиент удаленного рабочего стола не удается подключиться к удаленному рабочему столу, но не содержат сообщения или другие симптомы, которые могли бы помочь определить причину, выполните следующие действия. Чтобы устранить многие из наиболее распространенных причин такого рода проблему, используйте следующие методы:

- [Проверьте состояние протокола RDP](#check-the-status-of-the-rdp-protocol)
- [Проверьте состояние службы удаленного рабочего СТОЛА](#check-the-status-of-the-rdp-services)
- [Проверьте, работает прослушиватель протокола удаленного рабочего СТОЛА](#check-that-the-rdp-listener-is-functioning)
- [Проверьте порт прослушивателя протокола удаленного рабочего СТОЛА](#check-the-rdp-listener-port)

### <a name="check-the-status-of-the-rdp-protocol"></a>Проверьте состояние протокола RDP

#### <a name="check-the-status-of-the-rdp-protocol-on-a-local-computer"></a>Проверьте состояние протокола RDP на локальном компьютере

Чтобы проверить и изменить состояние протокола RDP на локальном компьютере, см. в разделе [Включение удаленного рабочего стола](https://docs.microsoft.com/en-us/windows-server/remote/remote-desktop-services/clients/remote-desktop-allow-access#how-to-enable-remote-desktop).

> [!NOTE]  
> Если параметры удаленного рабочего стола недоступны, см. в разделе [проверьте, ли объект групповой политики блокирует RDP](#check-whether-a-group-policy-object-gpo-is-blocking-rdp-on-a-local-computer).

#### <a name="check-the-status-of-the-rdp-protocol-on-a-remote-computer"></a>Проверьте состояние протокола удаленного рабочего СТОЛА на удаленном компьютере

> [!IMPORTANT]  
> Внимательно выполните действия, описанные в этом разделе. Неправильное изменение реестра может привести к серьезным проблемам. Перед внесением изменений [создать резервную копию реестра для последующего восстановления](https://support.microsoft.com/en-us/help/322756%22%20target=%22_self%22) в случае возникновения проблем.

Чтобы проверить и изменить состояние протокола удаленного рабочего СТОЛА на удаленном компьютере, используйте сетевое подключение реестра:

1. Выберите **запустить**выберите **запуска**, а затем введите **regedt32**.
2. В редакторе реестра выберите **файл**, а затем выберите **подключить сетевой реестр**.
3. В **Выбор компьютера** диалогового окна введите имя удаленного компьютера, выберите **проверить имена**, а затем выберите **ОК**.
4. Перейдите к **HKEY\_ЛОКАЛЬНОГО\_МАШИНЫ\\системы\\CurrentControlSet\\управления\\сервера терминалов**.  
   ![Редактор реестра, показывающий fDenyTSConnections запись](..\media\troubleshoot-remote-desktop-connections\RegEntry_fDenyTSConnections.png)
   - Если значение **fDenyTSConnections** ключ является **0**, а затем включите RDP
   - Если значение **fDenyTSConnections** ключ является **1**, отключается протокола удаленного рабочего СТОЛА
5. Чтобы включить RDP, измените значение **fDenyTSConnections** из **1** для **0**.

#### <a name="check-whether-a-group-policy-object-gpo-is-blocking-rdp-on-a-local-computer"></a>Проверьте, ли объект групповой политики (GPO) блокирует RDP на локальном компьютере

Если вы не можете включить RDP в пользовательском интерфейсе или значение **fDenyTSConnections** возвращается к **1** после изменения его, объект групповой Политики может переопределения параметров уровня компьютера.

Чтобы проверить конфигурацию групповой политики на локальном компьютере, откройте окно командной строки с правами администратора и введите следующую команду:
```
gpresult /H c:\gpresult.html
```
После завершения выполнения этой команды, откройте gpresult.html. В **Конфигурация компьютера\\административные шаблоны\\компоненты Windows\\служб удаленных рабочих столов\\узла сеансов удаленных рабочих столов\\подключений**, найти **разрешить пользователям подключаться удаленно с помощью служб удаленных рабочих столов** политики.

- Если соответствующий параметр для этой политики не **включено**, Групповая политика не блокирует подключения удаленного рабочего СТОЛА.
- Если соответствующий параметр для этой политики не **отключено**, проверьте **результирующего объекта групповой Политики**. Это групповой Политики, который блокирует подключения удаленного рабочего СТОЛА.
![Пример сегмент gpresult.html, в котором объект групповой Политики доменного уровня ** блок RDP ** отключение протокола удаленного рабочего СТОЛА.](..\media\troubleshoot-remote-desktop-connections\GPResult_RDSH_Connections_GP.png)
   
  ![Пример сегмент gpresult.html, в котором ** локальной групповой политики ** Отключение протокола удаленного рабочего СТОЛА.](..\media\troubleshoot-remote-desktop-connections\GPResult_RDSH_Connections_LGP.png)

#### <a name="check-whether-a-gpo-is-blocking-rdp-on-a-remote-computer"></a>Проверьте, ли объект групповой Политики блокирует протокола удаленного рабочего СТОЛА на удаленном компьютере

Чтобы проверить конфигурацию групповой политики на удаленном компьютере, команда является практически так же, как и для локального компьютера:
```
gpresult /S <computer name> /H c:\gpresult-<computer name>.html
```
Файл, который создает эта команда (**gpresult -\<имя_компьютера\>.html**) используется один и тот же формат сведения в качестве версии локального компьютера (**gpresult.html**) использует.

#### <a name="modifying-a-blocking-gpo"></a>Изменение объекта групповой Политики блокировки

Вы можете изменить эти параметры в редактор объектов групповой политики (GPE) и групповой политики управления консоли (коэффициент валовой прибыли). Дополнительные сведения об использовании групповой политики см. в разделе [расширенного управления групповыми политиками](https://docs.microsoft.com/en-us/microsoft-desktop-optimization-pack/agpm/).

Чтобы изменить политика блокировки, используйте один из следующих методов:

- В GPE, доступ к соответствующего уровня объекта групповой Политики (например, локальные или доменные) и перейдите к **Конфигурация компьютера\\административные шаблоны\\компоненты Windows\\служб удаленных рабочих столов\\ Узел сеансов удаленных рабочих столов\\подключений**\\**разрешить пользователям подключаться удаленно с помощью служб удаленных рабочих столов**.  
   1. Установите для политики **включено** или **не настроен**.
   2. На этих компьютерах, откройте окно командной строки с правами администратора и выполните **gpupdate/force** команды.
- В коэффициент валовой прибыли перейдите к Подразделению, в котором применяется политика блокировки к затронутым компьютерам и удалить политику из Подразделения.

### <a name="check-the-status-of-the-rdp-services"></a>Проверьте состояние службы удаленного рабочего СТОЛА

На компьютере локальную (клиентскую) и (целевой) удаленного компьютера должны выполняться следующие службы:

- Службы удаленных рабочих столов (TermService)
- Перенаправления портов режима пользователя служб удаленного рабочего стола (UmRdpService)

С помощью оснастки MMC служб можно использовать для управления службами, локально или удаленно. Можно также использовать PowerShell локально или удаленно (если удаленный компьютер настроен для приема удаленных команд PowerShell).

![Службы удаленных рабочих столов в оснастке MMC службы. Не изменяйте параметры служб по умолчанию.](..\media\troubleshoot-remote-desktop-connections\RDSServiceStatus.png)

На любой компьютер Если одну или обе службы не запущены, запустите их.

> [!NOTE]  
> Если запустить службу служб удаленных рабочих столов, нажмите кнопку **Да** для автоматического перезапуска службы удаленного рабочего стола служб UserMode порт перенаправителя.

### <a name="check-that-the-rdp-listener-is-functioning"></a>Проверьте, работает прослушиватель протокола удаленного рабочего СТОЛА

> [!IMPORTANT]  
> Внимательно выполните действия, описанные в этом разделе. Неправильное изменение реестра может привести к серьезным проблемам. Перед внесением изменений [создать резервную копию реестра для последующего восстановления](https://support.microsoft.com/en-us/help/322756%22%20target=%22_self%22) в случае возникновения проблем.

#### <a name="check-the-status-of-the-rdp-listener"></a>Проверьте состояние прослушивателя протокола удаленного рабочего СТОЛА

Для выполнения этой процедуры используйте экземпляр PowerShell с правами администратора. Для локального компьютера также можно использовать в командной строке, имеет права администратора. Тем не менее эта процедура использует PowerShell, так как те же команды работают локально и удаленно.

1. Откройте окно PowerShell. Чтобы подключиться к удаленному компьютеру, введите **Enter-PSSession - ComputerName \<имя_компьютера\>** .
2. Введите **qwinsta**. 
    ![Команда qwinsta список процессов, прослушивающего порт компьютера.](..\media\troubleshoot-remote-desktop-connections\WPS_qwinsta.png)
3. Если этот список включает **rdp-tcp** с состоянием **прослушивания**, работает прослушиватель протокола удаленного рабочего СТОЛА. Перейти к [проверить порт прослушивателя протокола удаленного рабочего СТОЛА](#check-the-rdp-listener-port). В противном случае перейдите на шаге 4.
4. Экспорт конфигурации прослушивателя RDP с рабочего компьютера.
    1. Войдите в компьютер с той же версии операционной системы, как компьютер и получить доступ к реестру компьютера (например, с помощью редактора реестра).
    2. Перейдите в реестр следующую запись:  
        **Открываемый раздел HKEY\_ЛОКАЛЬНОГО\_МАШИНЫ\\системы\\CurrentControlSet\\управления\\сервера терминалов\\WinStations\\RDP-Tcp**
    3. Экспортируйте записи REG-файл. Например, в редакторе реестра щелкните запись правой кнопкой мыши **Экспорт**, а затем введите имя файла для экспортируемых параметрах.
    4. Скопируйте экспортированный REG-файл на соответствующем компьютере.
5. Для импорта конфигурации прослушивателя протокола удаленного рабочего СТОЛА, откройте окно PowerShell с правами администратора на соответствующем компьютере (или откройте окно PowerShell и удаленно подключаться к зараженному компьютеру).
   1. Чтобы создать резервную копию существующих записей, введите следующую команду:  
   
      ```powershell  
      cmd /c 'reg export "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-tcp" C:\Rdp-tcp-backup.reg'   
      ```  
   

   2. Чтобы удалить существующую запись реестра, введите следующие команды:  
   
      ```powershell  
      Remove-Item -path 'HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-tcp' -Recurse -Force  
      ```
   
   3. Чтобы импортировать новую запись реестра и перезапустите службу, введите следующие команды:  
   
      ```powershell  
      cmd /c 'regedit /s c:\<filename>.reg'  
      Restart-Service TermService -Force  
      ```   
      где \<filename\> имя экспортированный REG-файл.
6. Проверьте конфигурацию, попытки удаленного рабочего стола еще раз. Если вы по-прежнему не удается подключиться, перезагрузите компьютер.
7. Если вы по-прежнему не удается подключиться, [проверить состояние самозаверяющий сертификат протокола удаленного рабочего СТОЛА](#check-the-status-of-the-rdp-self-signed-certificate).

#### <a name="check-the-status-of-the-rdp-self-signed-certificate"></a>Проверьте состояние самозаверяющий сертификат протокола удаленного рабочего СТОЛА

1. Если вы по-прежнему не удается подключиться, откройте оснастку MMC для сертификатов. Когда будет предложено выбрать хранилище для управления, выберите **учетная запись компьютера**, а затем выберите нужный компьютер.
2. В **сертификаты** папке **удаленного рабочего стола**, удалите самозаверяющий сертификат протокола удаленного рабочего СТОЛА. 
    ![Сертификаты удаленного рабочего стола в оснастке MMC Сертификаты.](..\media\troubleshoot-remote-desktop-connections\MMCCert_Delete.png)
3. На соответствующем компьютере перезапустите службу служб удаленных рабочих столов.
4. Обновите оснастку «Сертификаты».
5. Если самозаверяющий сертификат протокола удаленного рабочего СТОЛА не был создан повторно, [проверьте разрешения для папки MachineKeys](#check-the-permissions-of-the-machinekeys-folder).

#### <a name="check-the-permissions-of-the-machinekeys-folder"></a>Проверьте разрешения для папки MachineKeys

1. На соответствующем компьютере, откройте проводник и перейдите к **C:\\ProgramData\\Microsoft\\Crypto\\RSA\\** .
2. Щелкните правой кнопкой мыши **MachineKeys**выберите **свойства**выберите **безопасности**, а затем выберите **Дополнительно**.
3. Убедитесь, что настроены следующие разрешения:
      - Builtin\\администраторов: Полный доступ
      - Все: Чтение, запись

### <a name="check-the-rdp-listener-port"></a>Проверьте порт прослушивателя протокола удаленного рабочего СТОЛА

На компьютере локальную (клиентскую) и (целевой) удаленного компьютера прослушивателю RDP должно ожидать передачи данных через порт 3389. Другие приложения не должны использовать этот порт.

> [!IMPORTANT]  
> Внимательно выполните действия, описанные в этом разделе. Неправильное изменение реестра может привести к серьезным проблемам. Перед внесением изменений [создать резервную копию реестра для последующего восстановления](https://support.microsoft.com/en-us/help/322756%22%20target=%22_self%22) в случае возникновения проблем.

Чтобы проверить или изменить порт протокола удаленного рабочего СТОЛА, используйте редактор реестра:

1. Выберите Пуск, выберите **запуска**, а затем введите **regedt32**.
      - Чтобы подключиться к удаленному компьютеру, выберите **файл**, а затем выберите **подключить сетевой реестр**.
      - В **Выбор компьютера** диалогового окна введите имя удаленного компьютера, выберите **проверить имена**, а затем выберите **ОК**.
2. Откройте реестр и перейдите к **HKEY\_ЛОКАЛЬНОГО\_МАШИНЫ\\системы\\CurrentControlSet\\управления\\сервера терминалов\\WinStations\\ \<прослушивателя\>** . 
    ![Подраздел номер_порта для протокола удаленного рабочего СТОЛА.](..\media\troubleshoot-remote-desktop-connections\RegEntry_PortNumber.png)
3. Если **Номер_порта** имеет значение, отличное от **3389**, измените его на **3389**. 
   > [!IMPORTANT]  
    > Можно управлять с помощью другой порт службы удаленного рабочего стола. Тем не менее это делать не рекомендуется. Устранение неполадок такая конфигурация выходит за рамки этой статьи.
4. Если изменить номер порта, перезапустите службу служб удаленных рабочих столов.

#### <a name="check-that-another-application-is-not-trying-to-use-the-same-port"></a>Убедитесь, что другое приложение не пытается использовать тот же порт

Для выполнения этой процедуры используйте экземпляр PowerShell с правами администратора. Для локального компьютера также можно использовать в командной строке, имеет права администратора. Тем не менее эта процедура использует PowerShell, так как же команды работать локально и удаленно.

1. Откройте окно PowerShell. Чтобы подключиться к удаленному компьютеру, введите **Enter-PSSession - ComputerName \<имя_компьютера\>** .
2. Введите следующую команду:  
   
     ```powershell  
    cmd /c 'netstat -ano | find "3389"'  
    ```
  
    ![С помощью этой команды создает список портов и службам, выполняющим прослушивание на них.](..\media\troubleshoot-remote-desktop-connections\WPS_netstat.png)
1. Найдите запись для TCP-порта 3389 (или назначенного RDP-порта) с состоянием **Ожидает вызова**. 
    > [!NOTE]  
   > Идентификатор процесса службы или процесса, использующих данный порт, отобразится в столбце "Идентификатор процесса".
1. Чтобы определить, какое приложение использует порт 3389 (или назначенный порт протокола удаленного рабочего СТОЛА), введите следующую команду:  
   
     ```powershell  
    cmd /c 'tasklist /svc | find "<pid listening on 3389>"'  
    ```  
  
    ![Команда tasklist сообщает сведения об определенном процессе.](..\media\troubleshoot-remote-desktop-connections\WPS_tasklist.png)
1. Найдите запись для номера Процесса, который связан с портом (из **netstat** выходных данных). Службы или процессы, которые связаны с этим идентификатором Процесса отображаются в правой части.
1. Если порт используется приложением или службой, отличных от служб удаленных рабочих столов (TermServ.exe), может разрешить конфликт, с помощью одного из следующих методов:
      - Настройте другие приложения или службы для использования другого порта (рекомендуется).
      - Удалите другие приложения или службы.
      - Настройка удаленного рабочего СТОЛА, чтобы использовать другой порт и затем перезапустите службу служб удаленных рабочих столов (не рекомендуется).

#### <a name="check-whether-a-firewall-is-blocking-the-rdp-port"></a>Проверьте, блокирует ли брандмауэр порт протокола удаленного рабочего СТОЛА

Используйте **psping** средство для тестирования, можно ли достичь зараженному компьютеру через порт 3389.

1. На компьютере, отличном от компьютера, затронутых, загрузите **psping** из <https://live.sysinternals.com/psping.exe>.
2. Откройте окно командной строки с правами администратора, перейдите в каталог, в которой установлен **psping**, а затем введите следующую команду:  
   
   ```  
   psping -accepteula <computer IP>:3389  
   ```
   
3. Проверьте выходные данные **psping** команду для результатов следующего вида:  
      - **Подключение к \<компьютера IP-адреса\>** : Удаленный компьютер доступен.
      - **(0% потерь)** : Все попытки подключения выполнена успешно.
      - **Удаленный компьютер отклонил сетевое подключение**: Удаленный компьютер недоступен.
      - **(100% потерь)** : Не удалось выполнить подключение.
1. Запустите **psping** на нескольких компьютерах, для проверки возможности подключения к зараженному компьютеру.
1. Обратите внимание на то, блокирует ли компьютер подключения от всех остальных компьютерах, некоторые другие компьютеры или только для одного компьютера.
1. Рекомендуемых дальнейших действий:
      - Привлекайте сетевых администраторов, чтобы убедиться, что сеть разрешает трафик RDP к зараженному компьютеру.
      - Проверьте конфигурации все брандмауэры между исходных компьютеров и компьютер (включая брандмауэр Windows на соответствующем компьютере) для определения, является ли брандмауэр блокирует порт протокола удаленного рабочего СТОЛА.

## <a name="client-cannot-connect-class-not-registered"></a>Клиенту не удается подключиться, «Класс не зарегистрирован»

При попытке подключения к удаленному компьютеру с помощью клиента под управлением Windows 10 версии 1709 или более поздней версии, клиент не может подключиться хотя сервер узла сеансов удаленных рабочих столов выдает сообщение, содержащий код ошибки «Класс не зарегистрирован (0x80040154)».

Эта проблема возникает, если пользователь, пытающийся подключиться имеет обязательный профиль пользователя. Чтобы устранить эту проблему, установите [24 июля 2018 г. — KB4338817 (ОС сборки 16299.579)](https://support.microsoft.com/en-us/help/4338817/windows-10-update-kb4338817) обновлений Windows 10.

## <a name="client-cannot-connect-no-licenses-available"></a>Клиенту не удается подключиться, нет доступных лицензий

Это относится к развертываниям, которые включают RDSH-сервере и сервере лицензирование удаленных рабочих столов.

Определите, какой тип поведения, пользователи видят:

- Сеанс был отключен из-за лицензии недоступны или отсутствия серверов лицензий
- Доступ запрещен из-за ошибки безопасности

Войдите в узла сеансов удаленных рабочих Столов с правами администратора домена и откройте средство диагностики лицензии удаленных рабочих Столов. Найдите следующие сообщения:

  - Истек льготный период для удаленного рабочего стола сервера узла сеансов, но сервер узла сеансов удаленных рабочих Столов не настроен с серверами лицензий. подключения к серверу узла сеансов удаленных рабочих Столов будут отклонены, если сервер лицензий не настроен для сервера узла сеансов удаленных рабочих Столов.
  - Сервер лицензирования \<имя_компьютера\> недоступна. Это может быть вызвано проблемами с сетевым подключением, Лицензирование удаленных рабочих столов служба остановлена на сервере лицензирования или лицензирования удаленных рабочих Столов не установлена на компьютере.

Эти проблемы, как правило, связанные со следующими сообщениями пользователя:

  - Удаленный сеанс отключен из-за отсутствия клиентских лицензий удаленного рабочего стола для этого компьютера.
  - Удаленный сеанс отключен из-за нет удаленного рабочего стола лицензии серверов можно получить лицензию.

В этом случае [настройки службы лицензирования удаленных рабочих Столов](#configure-the-rd-licensing-service).

Если средство диагностики лицензии удаленных рабочих Столов перечислены другие проблемы, такие как «компонент X.224 протокола RDP обнаружил ошибку в потоке протокола и отключил клиент,» может быть проблема, которая влияет на сертификаты лицензий. Такие проблемы, как правило, должны быть сопоставлены сообщения пользователя, например следующие:

Из-за ошибки безопасности клиент не удалось подключиться к серверу терминалов. Убедитесь, что вы вошли в сеть, повторите попытку подключения к серверу.

В этом случае [разделов реестра обновления X509 сертификата](#refresh-the-x509-certificate-registry-keys).

### <a name="configure-the-rd-licensing-service"></a>Настройка службы лицензирования удаленных рабочих Столов

В следующей процедуре используется диспетчер серверов для изменения конфигурации. Сведения о том, как настроить и использовать диспетчер серверов, см. в разделе [диспетчера серверов](https://docs.microsoft.com/en-us/windows-server/administration/server-manager/server-manager).

1. Откройте диспетчер серверов, а затем перейдите к **служб удаленных рабочих столов**.
2. На **Общие сведения о развертывании**выберите **задачи**, а затем выберите **изменение свойств развертывания**.
3. Выберите **лицензирования удаленных рабочих Столов**, а затем выберите подходящий режим лицензирования для развертывания (**ףסענמיסעגמ** или **на пользователя**).
4. Введите полное доменное имя (FQDN) сервер лицензирования удаленных рабочих Столов, а затем выберите **добавить**.
5. Если у вас есть более чем один сервер лицензирования удаленных рабочих Столов, повторите шаг 4 для каждого сервера. 
    ![Параметры конфигурации сервера лицензию удаленных рабочих Столов в диспетчере сервера.](..\media\troubleshoot-remote-desktop-connections\RDLicensing_Configure.png)

### <a name="refresh-the-x509-certificate-registry-keys"></a>Разделы реестра X509 обновления сертификата

> [!IMPORTANT]  
> Внимательно выполните действия, описанные в этом разделе. Неправильное изменение реестра может привести к серьезным проблемам. Перед внесением изменений [создать резервную копию реестра для последующего восстановления](https://support.microsoft.com/en-us/help/322756%22%20target=%22_self%22) в случае возникновения проблем.

Чтобы устранить эту проблему, резервное копирование, и перезапустите реестра remove X509 сертификат компьютера, а затем сервер лицензирования удаленных рабочих Столов повторной активации. Для этого выполните следующие действия.

> [!NOTE]  
> Выполните следующую процедуру на каждом сервере RDSH.

1. Откройте редактор реестра и перейдите к **HKEY\_ЛОКАЛЬНОГО\_МАШИНЫ\\системы\\CurrentControlSet\\управления\\сервера терминалов\\RCM**.
2. В меню редактора реестра выберите **Экспорт файла реестра**.
3. Тип **экспортированный сертификат** в **имя файла** поле, а затем выберите **Сохранить**.
4. Правой кнопкой мыши каждое из следующих значений, выберите **удалить**, а затем выберите **Да** для проверки удаления:  
      - **Сертификат**
      - **Сертификат X509**
      - **Идентификатор сертификата X509**
      - **X509 Certificate2**
5. Закройте редактор реестра и перезапустите сервер RDSH.

## <a name="user-cannot-authenticate-or-must-authenticate-twice"></a>Не удается проверить подлинность пользователя, или должен пройти проверку подлинности дважды

Существует несколько проблем, которые может вызвать проблемы, влияющие на проверку подлинности пользователя. В этом разделе рассматриваются в следующих случаях:

  - [Пользователь получает отказ в доступе с сообщением «ограничено тип входа в систему»](#access-denied-restricted-type-of-logon)
  - [Пользователю или приложению отказано в доступе с событием 16965, «удаленный вызов к базе данных SAM отклонен»](#access-denied-a-remote-call-to-the-sam-database-has-been-denied)
  - [Пользователь не сможет войти с помощью смарт-карты](#a-user-cannot-sign-in-by-using-a-smart-card)
  - [Если удаленный компьютер заблокирован, пользователю нужно дважды введите пароль](#if-the-remote-pc-is-locked-a-user-needs-to-enter-a-password-twice)
  - [Пользователь, не удается выполнить вход и получает «ошибка проверки подлинности» и «Исправления oracle CredSSP шифрования» сообщения](#user-cannot-sign-in-and-receives-authentication-error-and-credssp-encryption-oracle-remediation-messages)
  - [После обновления клиентских компьютеров, некоторые пользователи должны входить два раза](#after-you-update-client-computers-some-users-need-to-sign-in-twice).
  - [Пользователям будет запрещен доступ на развертывание, использующее RemoteGuard с несколько посредников подключений к удаленному рабочему Столу](#users-are-denied-access-on-a-deployment-that-uses-remote-credential-guard-with-multiple-rd-connection-brokers)

### <a name="access-denied-restricted-type-of-logon"></a>Отказано в доступе, ограниченный тип входа в систему

В этом случае пользователь Windows 10, попытка подключения к компьютерам с Windows 10 или Windows Server 2016 отказано в доступе со следующим сообщением:

> Удаленный рабочий стол:  
> Системный администратор ограничил тип входа в систему (сети или интерактивной), которую можно использовать. Получить помощь обратитесь к системному администратору или технической поддержки.

Эта проблема возникает, когда уровень проверки подлинности сети (NLA) необходима для подключения удаленного рабочего СТОЛА, и пользователь не является членом **пользователи удаленного рабочего стола** группы. Она также может возникать, если **пользователи удаленного рабочего стола** группы не был назначен **доступ к этому компьютеру из сети** право пользователя.

Чтобы устранить эту проблему, выполните одно из следующих действий.

  - [Изменить членство в группе пользователей или назначение прав пользователя](#modify-the-users-group-membership-or-user-rights-assignment).
  - Отключите NLA (не рекомендуется).
  - Используйте клиенты удаленного рабочего стола, отличных от Windows 10. Например клиенты Windows 7 нет этой проблемы.

#### <a name="modify-the-users-group-membership-or-user-rights-assignment"></a>Изменить членство в группе пользователей или назначение прав пользователя

Если эта проблема затрагивает один пользователь, наиболее простым решением этой проблемы заключается в добавлении пользователю **пользователи удаленного рабочего стола** группы.

Если пользователь уже является членом этой группы (или если несколько члены группы имеют ту же проблему), проверьте конфигурацию права пользователя на удаленном компьютере Windows 10 или Windows Server 2016.

1. Откройте редактор объектов групповой политики (GPE) и подключитесь к локальной политике удаленного компьютера.
2. Перейдите к **Конфигурация компьютера\\параметры Windows\\параметры безопасности\\локальные политики\\назначение прав пользователя**, щелкните правой кнопкой мыши **получить доступ к этому компьютеру из сети**, а затем выберите **свойства**.
3. Ознакомьтесь со списком пользователей и групп для **пользователи удаленного рабочего стола** (или родительской группы).
4. Если список не содержит **пользователи удаленного рабочего стола** (или родительской группы, такие как **все**) необходимо добавить его в список (при наличии более чем на одном или двух компьютерах в развертывании, используйте объект групповой политики) .  
    Например, членства по умолчанию для **доступ к этому компьютеру из сети** включает в себя **все**. Если в развертывании используется объект групповой политики для удаления **все**, может потребоваться восстановить доступ, обновив объект групповой политики, чтобы добавить **пользователи удаленного рабочего стола**.

### <a name="access-denied-a-remote-call-to-the-sam-database-has-been-denied"></a>Отказано в доступе, запрещен удаленный вызов к базе данных SAM

Такое поведение обычно возникает, если контроллеры домена под управлением Windows Server 2016 или более поздней версии, а пользователи пытаются подключиться с помощью настраиваемого подключения приложения. В частности приложений, обращающихся к сведениям профиля пользователя в Active Directory будет отказано в доступе.

Это происходит из изменения в Windows. В Windows Server 2012 R2 и более ранних версиях, когда пользователь выполняет вход на удаленного рабочего стола, контактов удаленного диспетчера соединений (RCM) контроллер домена (DC) для запроса конфигурации, относящиеся к удаленному рабочему столу в объекте пользователя в домен Active Directory Службы (AD DS). Эта информация отображается на вкладке "Профиль служб удаленных рабочих столов" свойств объекта пользователя в Active Directory — пользователи и компьютеры оснастки.

Начиная с Windows Server 2016, RCM больше не запрашивает объект пользователей в AD DS. Если вам требуется RCM для запроса Доменных службах Active Directory, так как вы используете атрибуты служб удаленных рабочих столов, необходимо вручную включить прежнее поведение RCM.

> [!IMPORTANT]  
> Внимательно выполните действия, описанные в этом разделе. Неправильное изменение реестра может привести к серьезным проблемам. Перед внесением изменений [создать резервную копию реестра для последующего восстановления](https://support.microsoft.com/en-us/help/322756%22%20target=%22_self%22) в случае возникновения проблем.

Чтобы разрешить устаревшее поведение RCM на сервере узла сеансов удаленных рабочих Столов, настройте следующие параметры реестра и перезапустите **служб удаленных рабочих столов** службы:  
  - **Открываемый раздел HKEY\_ЛОКАЛЬНОГО\_МАШИНЫ\\программного обеспечения\\политики\\Microsoft\\Windows NT\\служб терминалов**
  - **Открываемый раздел HKEY\_ЛОКАЛЬНОГО\_МАШИНЫ\\системы\\CurrentControlSet\\управления\\сервера терминалов\\WinStations\\\<имя станции\>\\**  
      - Имя: **fQueryUserConfigFromDC**
      - Введите команду: **REG\_DWORD**
      - Значение: **1** (десятичное)

Чтобы разрешить устаревшее поведение RCM на сервере, отличном от сервера узла сеансов удаленных рабочих Столов, настройте эти записи реестра и следующий дополнительный параметр реестра (и затем перезапустите службу):
  - **Открываемый раздел HKEY\_ЛОКАЛЬНОГО\_МАШИНЫ\\системы\\CurrentControlSet\\управления\\сервера терминалов**

Дополнительные сведения об этом поведении см. в статье базы Знаний 3200967 [изменяет удаленного диспетчера подключений в Windows Server](https://support.microsoft.com/en-us/help/3200967/changes-to-remote-connection-manager-in-windows-server).

### <a name="a-user-cannot-sign-in-by-using-a-smart-card"></a>Пользователь не сможет войти с помощью смарт-карты

В этой статье рассматриваются три распространенных ситуациях, в которых пользователь не сможет войти на удаленный рабочий стол с помощью смарт-карты:  
  - [Пользователь не сможет войти в филиале, который использует только для чтения контроллер домена (RODC)](#cannot-sign-in-with-a-smart-card-in-a-branch-office-with-a-rodc)
  - [Пользователь не сможет войти на компьютер Windows Server 2008 SP2, был недавно изменен](#cannot-sign-in-with-a-smart-card-to-a-windows-server-2008-sp2-computer)
  - [Пользователь не может оставаться в системе на компьютере Windows, который был недавно обновлен, и служба служб удаленных рабочих столов становится отвечать на запросы (зависает)](#cannot-stay-signed-in-with-a-smart-card-and-remote-desktop-services-service-hangs)

#### <a name="cannot-sign-in-with-a-smart-card-in-a-branch-office-with-a-rodc"></a>Не удается выполнить вход в систему с помощью смарт-карты в филиале с RODC

Эта проблема возникает в развертываниях, которые включают RDSH-сервере, на сайте филиала, где используется RODC. Сервер RDSH размещается в корневом домене. Пользователи на сайте филиала входить в дочерний домен и использовать смарт-карты для проверки подлинности. RODC настроен к паролям пользователей кэша (принадлежит RODC **допускается группу репликации паролей RODC**). Когда пользователи пытаются подписаться, чтобы сеансы на сервере RDSH, они получать сообщения, такие как «попытка входа в систему является недопустимым. Это может быть либо из-за неправильный имя_пользователя или проверки подлинности сведения.»

Это известная проблема, так что корневого контроллера домена и RODC Управление шифрованием учетных данных пользователя. Корневой контроллер домена использует ключ шифрования для шифрует учетные данные, а RODC предоставляет ключ расшифровки клиенту. Тем не менее двух ключи не совпадают.

Чтобы обойти эту проблему, рассмотрите возможность изменения топологии контроллера домена, либо отключив кэширование пароля на RODC, либо путем развертывания для записи контроллера домена на сайте филиала. Альтернативным способом является перемещение сервера RDSH к тому же домену дочерних, что и пользователи. Другой вариант — позволяют пользователям входить без смарт-карты. Любой из этих решений может потребоваться компромиссов в производительности или уровень безопасности.

#### <a name="cannot-sign-in-with-a-smart-card-to-a-windows-server-2008-sp2-computer"></a>Не удается выполнить вход в систему с помощью смарт-карты на компьютере Windows Server 2008 SP2

Эта проблема возникает при входе пользователей к компьютеру Windows Server 2008 SP2, который был обновлен с KB4093227 (2018.4B). При попытке входа с помощью смарт-карты, им отказано в доступе с сообщениями, например «действительные сертификаты не найдены. Убедитесь, что карта вставлена правильно и плотно.» В то же время на компьютере Windows Server регистрирует приложение «произошла ошибка при получении цифрового сертификата с вставленной смарт-карты. Недопустимая подпись.»

Чтобы устранить эту проблему, обновите на компьютере Windows Server с 2018.06 B повторного выпуска 4093227 КБ, [Описание обновления безопасности для Windows удаленного рабочего стола (RDP) отказ в обслуживании, в Windows Server 2008: 10 апреля 2018 г](https://support.microsoft.com/en-us/help/4093227/security-update-for-vulnerabilities-in-windows-server-2008).

#### <a name="cannot-stay-signed-in-with-a-smart-card-and-remote-desktop-services-service-hangs"></a>Не может оставаться в системе с использованием смарт-карты и зависанию службы служб удаленных рабочих столов

Эта проблема возникает при входе на компьютер Windows или Windows Server, была дополнена 4056446 КБ. На первый, пользователь может быть возможность входа в систему с помощью смарт-карты, но затем получает «БРОСИТЬ\_E\_нет\_службы» сообщение об ошибке. Удаленный компьютер может перестать отвечать.

Чтобы обойти эту проблему, перезапустите компьютер.

Чтобы устранить эту проблему, обновите удаленный компьютер с помощью соответствующего исправления:

  - Windows Server 2008 SP2: КБ 4090928, [Windows утечек дескрипторов в процессе lsm.exe и приложениями смарт-карты может отобразить «БРОСИТЬ\_E\_нет\_службы» ошибки](https://support.microsoft.com/en-us/help/4090928/scard-e-no-service-errors-when-windows-leaks-handles-in-the-lsm-exe)
  - Windows Server 2012 R2: КБ 4103724, [17 мая 2018 г. — KB4103724 (Предварительная версия ежемесячного накопительного пакета)](https://support.microsoft.com/en-us/help/4103724/windows-81-update-kb4103724)
  - Windows Server 2016 и Windows 10 версии 1607: КБ 4103720, [17 мая 2018 г. — KB4103720 (сборка ОС 14393.2273)](https://support.microsoft.com/en-us/help/4103720/windows-10-update-kb4103720)

### <a name="if-the-remote-pc-is-locked-a-user-needs-to-enter-a-password-twice"></a>Если удаленный компьютер заблокирован, пользователю нужно дважды введите пароль

Эта проблема может возникать, когда пользователь пытается подключиться к удаленному рабочему столу под управлением Windows 10 версии 1709 в развертывании, в котором RDP-подключения не требуют NLA. В этих условиях Если удаленный рабочий стол был заблокирован, пользователь должен ввести свои учетные данные дважды при подключении.

Чтобы устранить эту проблему, обновите компьютера Windows 10 версии 1709 с 4343893 КБ [30 августа 2018 г. — KB4343893 (ОС сборки 16299.637)](https://support.microsoft.com/en-us/help/4343893/windows-10-update-kb4343893).

### <a name="user-cannot-sign-in-and-receives-authentication-error-and-credssp-encryption-oracle-remediation-messages"></a>Пользователь, не удается выполнить вход и получает «ошибка проверки подлинности» и «Исправления oracle CredSSP шифрования» сообщения

Когда пользователи пытаются выполнить вход с использованием любой версии Windows из Windows Vista SP2 и более поздних версиях или Windows Server 2008 SP2 и более поздних версий, они отказано в доступе и получать сообщения, такие как следующие:

  - Ошибка проверки подлинности. Указанная функция не поддерживается.
  - Это может быть вызвано CredSSP шифрования oracle исправления

«Исправление oracle CredSSP шифрования» ссылается на набор обновлений безопасности, выпускаемых в марта, апреля и мая 2018 г. CredSSP — это поставщик проверки подлинности, который обрабатывает запросы проверки подлинности для других приложений. 13 марта 2018 г, «3B» и всех последующих обновлений обращаться эксплойта, в котором он передает учетные данные пользователя для выполнения кода в целевой системе.

Начальной обновления добавлена поддержка нового объекта групповой политики, **исправления Oracle шифрования**, который имеет следующие возможные параметры:

  - **Уязвимые**. Клиентские приложения, использующие CredSSP может переключиться на небезопасных версий, но это поведение предоставляет удаленные рабочие столы для атак. Службы, использующие CredSSP клиентами, которые не были обновлены.
  - **Устранен**. Клиентские приложения, использующие CredSSP не могут быть переданы небезопасных версий, но службы, использующие CredSSP принятие клиентов, которые не были обновлены.
  - **Принудительно обновить клиенты**. Клиентские приложения, использующие CredSSP не могут быть переданы небезопасных версий и служб, использующих CredSSP не примет Неисправленные клиентов. 
    Примечание. Этот параметр не следует развертывать, пока все узлы удаленной поддержки последней версии.

Обновление 8 мая 2018 г., изменили значение по умолчанию **исправления Oracle шифрования** Azure с помощью **дефект** для **mitigated (устранено)** . Это изменение на месте клиенты удаленного рабочего стола, которые были установлены обновления не удается подключиться к серверам, которые не имеют (или обновление серверов, которые еще не выполнена перезагрузка). Дополнительные сведения о влиянии обновления и типов связи, который они блокируются, см. в статье базы Знаний 4093492, [CredSSP обновлений CVE-2018-0886](https://support.microsoft.com/en-us/help/4093492/credssp-updates-for-cve-2018-0886-march-13-2018).

Чтобы устранить эту проблему, убедитесь, что все системы полностью обновляются и перезапускаются. Полный список обновлений и Дополнительные сведения об уязвимостях, см. в разделе [CVE-2018-0886 | Уязвимость удаленного CredSSP](https://portal.msrc.microsoft.com/en-us/security-guidance/advisory/CVE-2018-0886).

Чтобы обойти эту проблему, до завершения обновления, проверьте 4093492 КБ для разрешенных типов соединений. Если не представляется возможным альтернативные варианты можно одним из следующих методов:

  - На затронутых клиентских компьютерах, задать **исправления Oracle шифрования** политики обратно в **дефект**.
  - Измените следующие политики в **Конфигурация компьютера\\административные шаблоны\\компоненты Windows\\служб удаленных рабочих столов\\узла сеансов удаленных рабочих столов\\ Безопасность** папки групповой политики:  
      - **Требовать использования специального уровня безопасности для подключений удаленного (рабочего стола RDP)** : значение **включено** и выберите **RDP**.
      - **Требовать проверку подлинности для удаленных подключений с помощью проверки подлинности на уровне сети**: значение **отключено**.
      > [!IMPORTANT]  
      > Эти изменения к снижению уровня безопасности развертывания. Их должно быть временным, если они вообще используются.

Дополнительные сведения о работе с помощью групповой политики см. в разделе [изменение объекта групповой Политики блокировки](#modifying-a-blocking-gpo).

### <a name="after-you-update-client-computers-some-users-need-to-sign-in-twice"></a>После обновления клиентских компьютеров, некоторые пользователи должны входить два раза

Пользователи на некоторые Windows 7 или Windows 10 версии 1709 войти в сеанс удаленного рабочего стола и сразу видеть второй экран входа в систему. Эта проблема возникает, если клиентские компьютеры получили следующие обновления:

  - Windows 7: КБ 4103718, [8 мая 2018 г. — KB4103718 (ежемесячных накопительных)](https://support.microsoft.com/en-us/help/4103718/windows-7-update-kb4103718)
  - Windows 10 версии 1709. КБ 4103727, [8 мая 2018 г. — KB4103727 (сборка ОС 16299.431)](https://support.microsoft.com/en-us/help/4103727/windows-10-update-kb4103727)

Чтобы устранить эту проблему, убедитесь, что компьютеры, которые требуется подключиться, (а также серверы RDSH или RDVI) полностью обновлены до июня 2018. Сюда входят следующие обновления:

  - Windows Server 2016: КБ 4284880, [12 июня 2018 г. — KB4284880 (сборка ОС 14393.2312)](https://support.microsoft.com/en-us/help/4284880/windows-10-update-kb4284880)
  - Windows Server 2012 R2: КБ 4284815, [12 июня 2018 г. — KB4284815 (ежемесячных накопительных)](https://support.microsoft.com/en-us/help/4284815/windows-81-update-kb4284815)
  - Windows Server 2012: КБ 4284855, [12 июня 2018 г. — KB4284855 (ежемесячных накопительных)](https://support.microsoft.com/en-us/help/4284855/windows-server-2012-update-kb4284855)
  - Windows Server 2008 R2: КБ 4284826, [12 июня 2018 г. — KB4284826 (ежемесячных накопительных)](https://support.microsoft.com/en-us/help/4284826/windows-7-update-kb4284826)
  - Windows Server 2008 SP2: KB4056564, [Описание обновления безопасности для CredSSP уязвимость в Windows Server 2008, Windows Embedded POSReady 2009 и Windows Embedded Standard 2009: 13 марта 2018 г.](https://support.microsoft.com/en-us/help/4056564/security-update-for-vulnerabilities-in-windows-server-2008)

### <a name="users-are-denied-access-on-a-deployment-that-uses-remote-credential-guard-with-multiple-rd-connection-brokers"></a>Пользователям будет запрещен доступ на развертывание, использующее удаленный Credential Guard с помощью нескольких посредников подключений к удаленному рабочему Столу

Эта проблема возникает в развертываниях высокого уровня доступности с использованием двух или более удаленного рабочего стола посредников подключений, если используется Windows Defender удаленный Credential Guard. Пользователям не удается войти в удаленные рабочие столы.

Эта проблема возникает, так как удаленный Credential Guard использует Kerberos для проверки подлинности, а также ограничивает NTLM. Тем не менее в конфигурации высокой доступности с балансировкой нагрузки, посредников подключений к удаленному рабочему Столу не может поддерживать операции Kerberos.

Если вам нужно использовать конфигурации высокого уровня доступности с балансировкой нагрузки посредников подключений к удаленному рабочему Столу, можно обойти эту проблему, отключив удаленный Credential Guard. Дополнительные сведения об управлении Windows Defender удаленный Credential Guard см. в разделе [защитить удаленный рабочий стол с помощью удаленного Credential Guard Windows Defender](https://docs.microsoft.com/en-us/windows/security/identity-protection/remote-credential-guard#enable-windows-defender-remote-credential-guard).

## <a name="on-connecting-user-receives-remote-desktop-service-is-currently-busy-message"></a>О подключении, пользователь получает сообщение «Службы удаленных рабочих столов в настоящее время занято»

Чтобы определить соответствующий ответ на эту проблему, используйте следующие действия:

1. Службу служб удаленных рабочих столов перестает отвечать на запросы (например, клиент удаленного рабочего стола отображается к «зависанию» на экране приветствия).  
      - Если служба перестает отвечать, см. в разделе [проблемы с памятью сервера RDSH](#rdsh-server-memory-issue).
      - Если клиент обычно взаимодействия со службой, перейдите к следующему шагу.
2. Если одному или нескольким пользователям отключить их сеансы удаленного рабочего стола, пользователи подключаются снова?  
   - Если служба по-прежнему запрещают подключения независимо от того, какое количество пользователей, отключите их сеансы, см. в разделе [проблему прослушивателя к удаленному рабочему Столу](#rd-listener-issue).
   - Если служба начинает принимать подключения после определенного числа пользователей, входивших свои сеансы [проверьте политики ограничения подключения](#check-the-connection-limit-policy).

### <a name="rdsh-server-memory-issue"></a>Проблемы с памятью сервера RDSH

На некоторых серверах Windows Server 2012 R2 RDSH обнаружена утечка памяти. Со временем эти серверы начинаться на отказ от подключения удаленного рабочего стола и локальную консоль входы в систему с сообщениями, например следующие:

> Невозможно выполнить задачу, которую вы пытаетесь выполнить, поскольку служба удаленных рабочих столов в настоящее время занято. Повторите попытку через несколько минут. Другим пользователям должен входить в систему.

Клиенты удаленного рабочего стола, попытка подключения также перестать отвечать на запросы.

Чтобы обойти эту проблему, перезапустите сервер RDSH.

Чтобы устранить эту проблему, примените 4093114 КБ [10 апреля 2018 г. — KB4093114 (ежемесячных накопительных)] (file:///C:\\пользователей\\v jesits\\AppData\\локальной\\Microsoft\\Windows\\INetCache\\Content.Outlook\\FUB8OO45\\% апреля 2010 г., % 202018 — KB4093114% 20\(ежемесячные 20Rollup %\)), на RDSH-серверы.

### <a name="rd-listener-issue"></a>Проблема прослушивателя к удаленному рабочему Столу

Проблема уже было отмечено в некоторые RDSH-серверы, которые были обновлены непосредственно из Windows Server 2008 R2 до Windows Server 2012 R2 или Windows Server 2016. Когда клиент удаленного рабочего стола подключается к RDSH-сервера, сервера RDSH создает прослушиватель удаленных рабочих Столов для сеанса пользователя. Затронутых серверах вести учет числа прослушивателей к удаленному рабочему Столу, на которые увеличивается по мере подключения пользователей, но никогда не уменьшается.

Чтобы обойти эту проблему, можно использовать следующие методы:

  - Перезапустите сервер RDSH, чтобы сбросить счетчик прослушивателей к удаленному рабочему Столу
  - Измените параметр подключения ограничение политики, его очень большое значение. Дополнительные сведения об управлении политики ограничения подключения, см. в разделе [проверьте политики ограничения подключения](#check-the-connection-limit-policy).

Чтобы устранить эту проблему, необходимо установите следующие обновления на RDSH-серверы:

  - Windows Server 2012 R2: КБ 4343891, [30 августа 2018 г. — KB4343891 (Предварительная версия ежемесячного накопительного пакета)](https://support.microsoft.com/en-us/help/4343891/windows-81-update-kb4343891)
  - Windows Server 2016: КБ 4343884, [30 августа 2018 г. — KB4343884 (сборка ОС 14393.2457)](https://support.microsoft.com/en-us/help/4343884/windows-10-update-kb4343884)

### <a name="check-the-connection-limit-policy"></a>Проверьте политику ограничения подключения

Можно задать ограничение на количество одновременных подключений удаленного рабочего стола, на уровне отдельного компьютера или путем настройки объекта групповой политики (GPO). По умолчанию ограничение не задано.

Чтобы проверить текущие параметры и определить любые существующие объекты групповой политики на сервере RDSH, откройте окно командной строки с правами администратора и введите следующую команду:
  
```
gpresult /H c:\gpresult.html
```
   
После завершения этой команды, откройте gpresult.html и в **Конфигурация компьютера\\административные шаблоны\\компоненты Windows\\служб удаленных рабочих столов\\узла сеансов удаленных рабочих столов \\Подключений**, найти **ограничить количество подключений** политики.

  - Если соответствующий параметр для этой политики не **отключено**, а затем групповой политики не ограничивают RDP-подключения.
  - Если соответствующий параметр для этой политики не **включено**, затем проверьте **результирующего объекта групповой Политики**. Если вам нужно удалить или изменить ограничение числа подключений, измените этот объект групповой Политики.

Чтобы применить изменения политики, откройте окно командной строки на соответствующем компьютере и введите следующую команду:
  
```
gpupdate /force
```
  
## <a name="rd-client-disconnects-and-cannot-reconnect-to-the-same-session"></a>Отключение клиента к удаленному рабочему Столу и сможет повторно подключиться к тому же сеансу

После клиент удаленного рабочего стола не удается установить подключение к удаленному рабочему столу, клиент не может сразу же повторно подключиться. Пользователь получает сообщения об ошибках, например следующие:

  - Из-за ошибки безопасности клиент не удалось подключиться к серверу терминалов. Убедитесь, что вы вошли в сеть, повторите попытку подключения к серверу.
  - Удаленный рабочий стол отключен. Из-за ошибки безопасности клиент не удалось подключиться к удаленному компьютеру. Проверьте, вошли сети и повторите попытку.

В дальнейшем клиент удаленного рабочего стола выполняет повторное подключение к удаленному рабочему столу. Однако вместо подключения клиента к исходному, сервера RDSH подключает клиента к новому сеансу. Проверка сервера RDSH показывает, исходном сеансе не ввели отключенным, но вместо этого остается активным.

Чтобы обойти эту проблему, вы можете включить **интервал проверки активности подключения Настройка** политики в **Конфигурация компьютера\\административные шаблоны\\компоненты Windows\\ Службы удаленных рабочих столов\\узла сеансов удаленных рабочих столов\\подключений** папки групповой политики. Если эта политика включена, необходимо ввести интервал проверки активности. Интервал проверки активности определяет, как часто, в минутах, сервер проверяет состояние сеанса.

Эта проблема может быть вызвано неправильной настройки параметров проверки подлинности и конфигурации. Эти параметры можно настроить на уровне сервера или с помощью объектов групповой политики. Параметры групповой политики доступны в **Конфигурация компьютера\\административные шаблоны\\компоненты Windows\\служб удаленных рабочих столов\\узла сеансов удаленных рабочих столов\\ Безопасность** папки групповой политики.

1. Откройте на сервере узла сеансов удаленных рабочих столов средство настройка узла сеансов удаленных рабочих столов.
2. В разделе **подключений**, щелкните правой кнопкой мыши имя подключения и нажмите кнопку **свойства**.
3. В **свойства** диалоговое окно подключения на **Общие** на вкладке **безопасности** слоев, выберите метод защиты.
4. В **уровень шифрования**, выберите нужный уровень. Можно выбрать **низким**, **совместимый с клиентом**, **высокой**, или **FIPS-совместимые**.

> [!NOTE]  
>  - Если обмен данными между клиентами и серверами узла сеансов удаленных рабочих Столов требуется самый высокий уровень шифрования, используйте FIPS-совместимое шифрование.
>  - Любые настройки уровня шифрования, которые можно настроить в групповой политике переопределить конфигурацию, настроенную с помощью средства настройки служб удаленных рабочих столов. Кроме того при включении [Системная криптография: Использовать FIPS-совместимые алгоритмы для шифрования, хэширования и подписывания](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/cc780081\(v=ws.10\)) политики, этот параметр переопределяет **установить уровень шифрования для клиентских подключений** политики. Политика шифрования системы находится в **Конфигурация компьютера\\параметры Windows\\параметры безопасности\\локальные политики\\параметры безопасности** папки.
>  - После изменения уровня шифрования новый уровень шифрования вступает в действие при следующем входе пользователя. Если требуется несколько уровней шифрования на одном сервере, установите несколько сетевых адаптеров и настройте каждый адаптер отдельно.
>  - Чтобы убедиться, что сертификат имеет соответствующий закрытый ключ в Конфигурация службы удаленного рабочего стола, щелкните правой кнопкой мыши подключение, для которого вы хотите просмотреть сертификат, выберите **Общие**выберите **изменить**, выберите сертификат, который вы хотите просмотреть, а затем выберите **Просмотр сертификата**. В нижней части **Общие** вкладке, оператор «имеется закрытый ключ, соответствующий этому сертификату» должен отображаться. Эти сведения также можно просмотреть, используя оснастку «Сертификаты».
>  - FIPS-совместимого шифрования ( **Системная криптография: Использовать FIPS-совместимые алгоритмы для шифрования, хэширования и подписывания** политики или **FIPS-совместимые** в конфигурации сервера удаленного рабочего стола) шифрует и расшифровывает данные, отправленные клиентом на сервер и от сервер, на клиент, с алгоритмами шифрования 140-1 федеральных обработки информации Standard (FIPS), использует криптографические модули Майкрософт. Дополнительные сведения см. в разделе [проверка FIPS 140](https://docs.microsoft.com/en-us/windows/security/threat-protection/fips-140-validation).
>  - **Высокой** параметр шифрует данные, передаваемые от клиента к серверу и от сервера клиенту с помощью 128-разрядное шифрование.
>  - **Совместимый с клиентом** параметр шифрует данные, передаваемые между клиентом и сервером в Максимальная стойкость ключа, поддерживаемые клиентом.
>  - **Низким** параметр шифрует данные, отправленные клиентом на сервер с помощью 56-битного шифрования.

## <a name="remote-laptop-disconnects-from-wireless-network"></a>Переносные отключается от беспроводной сети

Эта проблема может возникать, когда клиент удаленного рабочего стола подключается к переносной компьютер с помощью беспроводной сети 802.1 x. Периодически переносной компьютер отключается от сети и не переподключается автоматически.

Это известная проблема, которая происходит, когда параметр проверки подлинности сети для беспроводного сетевого подключения **проверки подлинности пользователя**.

Чтобы обойти эту проблему, установите для параметра проверки подлинности сети **проверки подлинности пользователя или компьютера** или **проверки подлинности компьютера**.

 > [!NOTE]  
> Чтобы изменить параметры проверки подлинности сети на одном компьютере, может потребоваться использовать панель управления сетями и общим доступом для создания нового беспроводного подключения с новыми параметрами.

Полное описание того, как Настройка параметров беспроводной сети, с помощью объектов групповой политики, см. в разделе [политики настройки беспроводной сети (IEEE 802.11)](https://docs.microsoft.com/en-us/windows-server/networking/core-network-guide/cncg/wireless/e-wireless-access-deployment#bkmk_policies).

## <a name="user-experiences-poor-performance-or-application-problems"></a>Работа пользователя к снижению производительности и приложениями.

В этом разделе рассматриваются несколько распространенных проблем, которые пользователи могут столкнуться при использовании функций удаленного рабочего стола:

  - [Пользователи, подключающиеся к новых виртуальных машин Microsoft Azure периодически возникают проблемы](#intermittent-problems-with-new-microsoft-azure-virtual-machines).
  - [Пользователи, подключающиеся к удаленным рабочим столам по Windows 10 версии 1709 могут возникнуть проблемы, воспроизведение видео](#video-playback-issues-on-windows-10-version-1709).
  - [Пользователи с профилями пользователей только для чтения, которые подключаются к удаленные рабочие столы Windows 10 не могут совместно использовать на своих настольных компьютеров.](#desktop-sharing-issues-on-windows-10)
  - [Пользователи, подключающиеся к удаленных рабочих столов Windows 10 с помощью клиенты, работающие в более старых версиях Windows 10 наблюдаться низкая производительность при отключении NLA](#performance-issues-when-mixing-versions-of-windows-10-if-nla-is-disabled)
  - [Когда пользователи выполнять несколько приложений в сеансы удаленного рабочего стола и отключения и повторного подключения часто, они могут столкнуться черным экраном на повторное подключение.](#black-screen-issue)

### <a name="intermittent-problems-with-new-microsoft-azure-virtual-machines"></a>Временные проблемы с новыми виртуальными машинами Microsoft Azure

Эта проблема затрагивает виртуальные машины, которые были недавно созданы. После того как пользователь подключится к виртуальной машине, сеанс удаленного рабочего стола не может загрузить параметры пользователя во всех правильно.

Чтобы обойти эту проблему, отключиться от виртуальной машины, подождите по крайней мере 20 минут и повторите попытку подключения.

Чтобы устранить эту проблему, необходимо установите следующие обновления к виртуальным машинам, соответствующим образом:

  - Windows 10 и Windows Server 2016: КБ 4343884, [30 августа 2018 г. — KB4343884 (сборка ОС 14393.2457)](https://support.microsoft.com/en-us/help/4343884/windows-10-update-kb4343884)
  - Windows Server 2012 R2: КБ 4343891, [30 августа 2018 г. — KB4343891 (Предварительная версия ежемесячного накопительного пакета)](https://support.microsoft.com/en-us/help/4343891/windows-81-update-kb4343891)

### <a name="video-playback-issues-on-windows-10-version-1709"></a>Вопросы воспроизведения видео в Windows 10 версии 1709

Эта проблема возникает, когда пользователи подключаются к удаленным компьютерам, работающих под управлением Windows 10 версии 1709. Когда эти пользователи воспроизведения видео, с помощью VMR9 кодек (видео смешивание модуля подготовки отчетов. 9), проигрыватель показано только черный окно.

Это известная проблема в Windows 10 версии 1709. Проблема возникает в Windows 10 версии 1703.

### <a name="desktop-sharing-issues-on-windows-10"></a>Совместное использование проблемы в Windows 10 Desktop

Эта проблема возникает, когда у пользователя есть профиля пользователя только для чтения (и куста реестра), такие как в сценарии киоска. Когда такой пользователь подключается к удаленному компьютеру, на котором выполняется Windows 10 версии 1803, они не могут совместно использовать их рабочем столе.

Чтобы устранить эту проблему, примените обновление Windows 10 4340917, [24 июля 2018 г. — KB4340917 (ОС сборки 17134.191)](https://support.microsoft.com/en-us/help/4340917/windows-10-update-kb4340917).

### <a name="performance-issues-when-mixing-versions-of-windows-10-if-nla-is-disabled"></a>Проблемы с производительностью при совместном использовании версий Windows 10, если NLA отключена

Эта проблема возникает, когда NLA отключена, и клиент удаленного рабочего стола компьютеров под управлением Windows 10 подключения к удаленным рабочим столам под управлением разных версий Windows 10. Низкая производительность работы пользователей удаленного рабочего стола клиентов на компьютерах под управлением Windows 10 версии 1709 или более ранних версий, при подключении к удаленным рабочим столам под управлением Windows 10 версии 1803 или более поздней версии.

Это происходит потому, что при отключении NLA старые клиентские компьютеры используют более медленного протокола при подключении к Windows 10, версии 1803 или более поздней версии.

Чтобы устранить эту проблему, примените 4340917 КБ [24 июля 2018 г. — KB4340917 (ОС сборки 17134.191)](https://support.microsoft.com/en-us/help/4340917/windows-10-update-kb4340917).

### <a name="black-screen-issue"></a>Черный экран

Эта проблема возникает в Windows 8.0, Windows 8.1, Windows 10 RTM и Windows Server 2012 R2. Пользователь запускает несколько приложений в удаленном рабочем столе, а затем отключается от сеанса. Периодически пользователь выполняет повторное подключение к удаленному рабочему столу для взаимодействия с приложениями, а затем отключить еще раз. Рано или поздно при повторном подключении пользователя сеанса удаленного рабочего стола просто показано черным экраном. Пользователь должен завершить сеанс удаленного рабочего стола из консоли удаленного компьютера (или консоли сервера RDSH). Это действие останавливает приложения.

Чтобы устранить эту проблему, установите следующие обновления соответствующим образом:

  - Windows 8 и Windows Server 2012: KB4103719, [17 мая 2018 г. — KB4103719 (Предварительная версия ежемесячного накопительного пакета)](https://support.microsoft.com/en-us/help/4103719/windows-server-2012-update-kb4103719)
  - Windows 8.1 и Windows Server 2012 R2: KB4103724, [17 мая 2018 г. — KB4103724 (Предварительная версия ежемесячного накопительного пакета)](https://support.microsoft.com/en-us/help/4103724/windows-81-update-kb4103724) и КБ 4284863, [21 июня 2018 г. — KB4284863 (Предварительная версия ежемесячного накопительного пакета)](https://support.microsoft.com/en-us/help/4284863/windows-81-update-kb4284863)
  - Windows 10: Исправлена в KB4284860, [12 июня 2018 г. — KB4284860 (сборка ОС 10240.17889)](https://support.microsoft.com/en-us/help/4284860/windows-10-update-kb4284860)
