---
title: Пользователь не может выполнить аутентификацию или должен выполнить ее дважды
description: Узнайте, как устранить проблему, когда пользователь не может выполнить аутентификацию или должен выполнить ее дважды перед запуском подключения к удаленному рабочему столу.
audience: itpro
ms.custom: na
ms.reviewer: rklemen
ms.suite: na
ms.tgt_pltfrm: na
ms.topic: troubleshooting
ms.assetid: ''
author: kaushika-msft
manager: dcscontentpm
ms.author: delhan
ms.date: 07/24/2019
ms.localizationpriority: medium
ms.openlocfilehash: 7dbb037e335af52dacbc56c920b1776be995e753
ms.sourcegitcommit: c5709021aa98abd075d7a8f912d4fd2263db8803
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/18/2020
ms.locfileid: "76265936"
---
# <a name="user-cant-authenticate-or-must-authenticate-twice"></a>Пользователь не может выполнить аутентификацию или должен выполнить ее дважды

В этой статье описаны некоторые причины проблем с аутентификацией пользователей.

## <a name="access-denied-restricted-type-of-logon"></a>Отказано в доступе (ограничение по типу входа в систему)

В этом случае пользователь Windows 10, который пытается подключиться к компьютерам с Windows 10 или Windows Server 2016, получит отказ в доступе со следующим сообщением:

> Подключение к удаленному рабочему столу  
> Системный администратор ограничил типы входа в систему (сетевой или интерактивный), которые можно использовать. Обратитесь за помощью к системному администратору или в службу технической поддержки.

Эта проблема возникает, если для подключения к удаленному рабочему столу требуется пройти проверку подлинности на уровне сети (NLA), но пользователь не является членом группы **Пользователи удаленного рабочего стола**. Она также может возникать, если группе **Пользователи удаленного рабочего стола** не назначено право пользователя **Доступ к компьютеру из сети**.

Чтобы решить эту проблему, выполните одно из указанных ниже действий.

  - [Измените членство пользователя в группах или назначенные ему права](#modify-the-users-group-membership-or-user-rights-assignment).
  - Отключите NLA (не рекомендуется).
  - Используйте клиенты удаленного рабочего стола, отличающиеся от Windows 10. Например, в клиентах Windows 7 нет такой проблемы.

### <a name="modify-the-users-group-membership-or-user-rights-assignment"></a>Изменение членства пользователя в группах или назначенных ему прав

Если эта проблема затрагивает одного пользователя, наиболее простым решением будет добавить этого пользователя в группу **Пользователи удаленного рабочего стола**.

Если пользователь уже является членом этой группы (или если проблема возникает у нескольких членов группы), проверьте конфигурацию прав пользователей на удаленном компьютере Windows 10 или Windows Server 2016.

1. Откройте редактор объектов групповой политики (GPE) и подключитесь к локальной политике удаленного компьютера.
2. Выберите **Конфигурация компьютера\\Конфигурация Windows\\Параметры безопасности\\Локальные политики\\Назначение прав пользователя**, щелкните правой кнопкой мыши элемент **Доступ к компьютеру из сети** и выберите **Свойства**.
3. Просмотрите список пользователей и групп для группы **Пользователи удаленного рабочего стола** (или родительской группы).
4. Если список не включает группу **Пользователи удаленного рабочего стола** или родительскую группу, например **Все**, добавьте их. Если развертывание включает больше одного компьютера, используйте объект групповой политики.  
    Например, членством по умолчанию для политики **Доступ к компьютеру из сети** будет **Все**. Если в развертывании используется объект групповой политики для удаления **Все**, может потребоваться восстановить доступ, обновив объект групповой политики, чтобы добавить группу **Пользователи удаленного рабочего стола**.

## <a name="access-denied-a-remote-call-to-the-sam-database-has-been-denied"></a>Отказано в доступе (удаленный вызов к базе данных SAM отклонен)

Такое поведение обычно возникает, если контроллеры домена работают под управлением Windows Server 2016 или более поздней версии, а пользователи пытаются подключиться с помощью настраиваемого приложения для подключения. В частности, отказ в доступе получат приложения, которым требуется доступ к сведениям профиля пользователя в Active Directory.

Такое поведение обусловлено изменением в Windows. В Windows Server 2012 R2 и более ранних версиях, когда пользователь выполняет вход на удаленный рабочий стол, диспетчер удаленных подключений (RCM) обращается к контроллеру домена (DC), чтобы запросить конфигурацию, относящуюся к удаленному рабочему столу, в объекте пользователя в доменных службах Active Directory (AD DS). Эта информация отображается на вкладке "Профиль служб удаленных рабочих столов" в окне свойств объекта пользователя в оснастке MMC "Пользователи и компьютеры Active Directory".

Начиная с Windows Server 2016 RCM больше не запрашивает объект пользователя в AD DS. Если требуется, чтобы RCM обращался к AD DS из-за того, что вы используете атрибуты служб удаленных рабочих столов, вам нужно вручную разрешить отправку запросов.

> [!IMPORTANT]  
> Внимательно выполните действия, описанные в этом разделе. Неправильное изменение реестра может привести к серьезным проблемам. Перед внесением изменений [создайте резервную копию реестра для его восстановления](https://support.microsoft.com/help/322756) в случае возникновения проблем.

Чтобы разрешить прежнее поведение RCM на сервере узла сеансов удаленных рабочих столов, настройте следующие записи реестра и перезапустите службу **Службы удаленных рабочих столов**:  
  - **HKEY\_LOCAL\_MACHINE\\SOFTWARE\\Policies\\Microsoft\\Windows NT\\Terminal Services**.
  - **HKEY\_LOCAL\_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Terminal Server\\WinStations\\\<Winstation name\>\\** .  
      - Имя: **fQueryUserConfigFromDC**.
      - Введите команду: **Reg\_DWORD**.
      - Значение: **1** (десятичное число).

Чтобы разрешить устаревшее поведение RCM на сервере, отличающемся от сервера RDSH, настройте эти записи реестра и следующую дополнительную запись (затем перезапустите службу).
  - **HKEY\_LOCAL\_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Terminal Server**

Дополнительные сведения об этом поведении см. в статье базы знаний № 3200967 [Changes to Remote Connection Manager in Windows Server](https://support.microsoft.com/help/3200967/changes-to-remote-connection-manager-in-windows-server) (Внесение изменений в диспетчер удаленных подключений в Windows Server).

## <a name="user-cant-sign-in-using-a-smart-card"></a>Пользователю не удается выполнить вход с помощью смарт-карты

В этом разделе рассматриваются три типичных сценария, когда пользователь не может войти на удаленный рабочий стол с помощью смарт-карты.

### <a name="cant-sign-in-with-a-smart-card-in-a-branch-office-with-a-read-only-domain-controller-rodc"></a>Не удается войти в систему с помощью смарт-карты в филиале с контроллером домена только для чтения (RODC)

Эта проблема возникает в развертываниях, в которых задействован сервер RDSH на сайте филиала, где используется RODC. Сервер RDSH размещен в корневом домене. Пользователи на сайте филиала относятся к дочернему домену и используют смарт-карты для проверки подлинности. Контроллер домена RODC настроен на кэширование паролей и принадлежит к **группе с разрешением реплицировать пароли RODC**. Когда пользователи пытаются выполнить вход в сеанс на сервере RDSH, они получают сообщение, например: "Неудачная попытка входа в систему. Указано неверное имя пользователя или другие неверные личные данные."

Эта проблема связана с тем, как корневой контроллер домена и RDOC управляют шифрованием учетных данных пользователей. Корневой контроллер домена использует ключ шифрования, чтобы зашифровать учетные данные, а RODC предоставляет ключ расшифровки клиенту. Если пользователь получает ошибку "Недопустимо", значит два ключа не совпадают.

Чтобы решить эту проблему, выполните одно из указанных ниже действий:

- измените топологию контроллера домена, отключив кэширование паролей на RODC, или разверните на сайте филиала контроллер домена с доступом на запись;
- переместите сервер RDSH в тот же дочерний домен, где находятся пользователи;
- разрешите пользователям выполнять вход без смарт-карты.

Учтите, что эти решения предполагают наличие компромисса между производительностью и уровнем безопасности.

### <a name="user-cant-sign-in-to-a-windows-server-2008-sp2-computer-using-a-smart-card"></a>Пользователь не может войти на компьютер с Windows Server 2008 с пакетом обновления 2 (SP2) с помощью смарт-карты

Эта проблема возникает, когда пользователи выполняют вход в систему компьютера Windows Server 2008 с пакетом обновления 2 (SP2), на котором установлено обновление KB4093227 (2018.4B). Когда пользователи пытаются выполнить вход с помощью смарт-карты, они получают отказ в доступе с сообщениями, например: "Действительные сертификаты не найдены. Убедитесь, что эта карта вставлена правильно и плотно сидит в разъеме". В то же время на компьютере Windows Server регистрируется событие приложения с сообщением "При получении цифрового сертификата с вставленной смарт-карты произошла ошибка: неправильная подпись."

Чтобы устранить эту проблему, обновите на компьютере ОС Windows Server до повторного выпуска 2018.06 B (обновление KB4093227). См. статью [Description of the security update for the Windows Remote Desktop Protocol (RDP) denial of service vulnerability in Windows Server 2008: April 10, 2018](https://support.microsoft.com/help/4093227/security-update-for-vulnerabilities-in-windows-server-2008) (Описание обновления системы безопасности для защиты протокола RDP в Windows от уязвимости службы в Windows Server 2008 (10 апреля 2018 г.).

### <a name="cant-stay-signed-in-with-a-smart-card-and-remote-desktop-services-service-hangs"></a>Не удается оставаться в системе, вход в которую выполнен с помощью смарт-карты, и служба удаленных рабочих столов зависает

Эта проблема возникает, когда пользователи входят в систему компьютера Windows или Windows Server с обновлением KB4056446. Возможно, сначала пользователю удается войти в систему с помощью смарт-карты, но потом он получает сообщение об ошибке SCARD\_E\_NO\_SERVICE. Удаленный компьютер может перестать отвечать.

Чтобы устранить эту проблему, перезапустите удаленный компьютер.

Чтобы устранить эту проблему, обновите систему на удаленном компьютере, установив соответствующее исправление:

  - Windows Server 2008 с пакетом обновления 2 (SP2): KB4090928 [Windows leaks handles in the lsm.exe process and smart card applications may display SCARD\_E\_NO\_SERVICE errors](https://support.microsoft.com/help/4090928/scard-e-no-service-errors-when-windows-leaks-handles-in-the-lsm-exe) (Windows зависает на процессе lsm.exe, а в приложениях, для которых используются смарт-карты, может отображаться сообщение SCARD_E_NO_SERVICE).
  - Windows Server 2012 R2: [17 мая 2018 г. — KB4103724 (ознакомительная версия ежемесячного накопительного пакета)](https://support.microsoft.com/help/4103724/windows-81-update-kb4103724).
  - Windows Server 2016 и Windows 10 версии 1607: [17 мая 2018 г. — KB4103720 (сборка ОС 14393.2273)](https://support.microsoft.com/help/4103720/windows-10-update-kb4103720).

## <a name="if-the-remote-pc-is-locked-the-user-needs-to-enter-a-password-twice"></a>Если удаленный компьютер заблокирован, пользователю нужно дважды ввести пароль

Эта проблема может возникать, когда пользователь пытается подключиться к удаленному рабочему столу под управлением Windows 10 версии 1709 в развертывании, где для подключений по протоколу RDP не требуется использовать NLA. Если в таком случае удаленный рабочий стол оказался заблокированным, пользователю нужно ввести свои учетные данные дважды при подключении.

Чтобы устранить эту проблему, обновите Windows 10 версии 1709 на соответствующем компьютере с использованием обновления за [30 августа 2018 г. — KB4343893 (ОС сборки 16299.637)](https://support.microsoft.com/help/4343893/windows-10-update-kb4343893).

## <a name="user-cant-sign-in-and-receives-authentication-error-and-credssp-encryption-oracle-remediation-messages"></a>Пользователю не удается войти, при этом отображаются сообщения "Ошибка аутентификации" и "Защита CredSSP от атак с использованием криптографического оракула"

Когда пользователи пытаются войти с использованием любой версии Windows (начиная с Windows Vista с пакетом обновления 2 (SP2) или Windows Server 2008 с пакетом обновления 2 (SP2)), они получают отказ в доступе и такие сообщения:

```
An authentication error has occurred. The function requested is not supported.
...
This could be due to CredSSP encryption oracle remediation
...
```

Ошибка "Исправление шифрования CredSSP" ссылается на набор обновлений системы безопасности, выпущенный в марте, апреле и мае 2018 г. CredSSP — это поставщик проверки подлинности, который обрабатывает запросы проверки подлинности для других приложений. Обновление за 13 марта 2018 г., 3B и все последующие обновления подверглись эксплойту, когда злоумышленник мог передать учетные данные пользователя для выполнения кода в целевой системе.

В исходные обновления была добавлена поддержка нового объекта групповой политики "Защита от атак с использованием криптографического оракула", который может иметь следующие настройки:

  - Уязвимо. Клиентские приложения, использующие CredSSP, могли переключиться на небезопасные версии, но из-за этого удаленные рабочие столы могли подвергаться атакам. Службы, использующие CredSSP, принимали клиенты, которые не были обновлены.
  - Устранено. Клиентские приложения, использующие CredSSP, не могут переключиться на небезопасные версии, но службы, использующие CredSSP, принимают клиенты, которые не были обновлены.
  - Принудительно обновленные клиенты. Клиентские приложения, использующие CredSSP, не могут переключиться на небезопасные версии, и службы, использующие CredSSP, не принимают клиенты без установленных обновлений. 
    > [!NOTE]
    > Этот параметр не следует развертывать, пока все узлы поддержки в удаленном расположении не будут поддерживать последнюю версию.

В обновлении за 8 мая 2018 г. значение для параметра по умолчанию "Защита от атак с использованием криптографического оракула" изменилось с "Уязвимо" на "Устранено". После реализации этого изменения клиенты Удаленного рабочего стола, на которых были установлены обновления, не могут подключаться к серверам без этого обновления (или к обновленным серверам, которые еще не были перезапущены). Подробные сведения об обновлениях CredSSP см. в статье базы знаний [KB4093492](https://support.microsoft.com/help/4093492/credssp-updates-for-cve-2018-0886-march-13-2018).

Чтобы устранить эту проблему, обновите и перезапустите все системы. Полный список обновлений и дополнительные сведения об уязвимостях см. в разделе [CVE-2018-0886 | CredSSP Remote Code Execution Vulnerability](https://portal.msrc.microsoft.com/security-guidance/advisory/CVE-2018-0886) (CVE-2018-0886 | Уязвимость CredSSP, допускающая удаленное выполнение кода).

Чтобы устранить эту проблему до завершения обновления, просмотрите список допустимых типов подключений в обновлении KB4093492. Если нет других осуществимых альтернатив, можете попробовать один из следующих методов:

- На затронутых клиентских компьютерах верните для политики "Защита от атак с использованием криптографического оракула" значение **Уязвимо**.
- Измените следующие политики в папке групповой политики, выбрав **Конфигурация компьютера\\Административные шаблоны\\Компоненты Windows\\Службы удаленных рабочих столов\\Узел сеансов удаленных рабочих столов\\Безопасность**:  
  - для политики **Требовать использования специального уровня безопасности для удаленных подключений по протоколу RDP** задайте значение **Включено** и выберите **RDP**.
  - для политики **Требовать проверку подлинности пользователя для удаленных подключений путем проверки подлинности на уровне сети** задайте значение **Отключено**.
    > [!IMPORTANT]  
    > Изменение этих групповых политик делает развертывание менее защищенным. Мы рекомендуем использовать их только временно (или вообще не использовать).

Дополнительные сведения о работе с групповой политикой см. в разделе [Изменение блокирующего объекта групповой политики](rdp-error-general-troubleshooting.md#modifying-a-blocking-gpo).

## <a name="after-you-update-client-computers-some-users-need-to-sign-in-twice"></a>После обновления клиентских компьютеров некоторым пользователям приходится выполнять вход дважды

Если пользователи входят на Удаленный рабочий стол с помощью компьютера под управлением Windows 7 или Windows 10 версии 1709, им сразу же отображается запрос на повторный вход. Эта проблема возникает, если на клиентском компьютере установлены следующие обновления:

  - Windows 7: [8 мая 2018 г. — KB4103718 (ежемесячный накопительный пакет)](https://support.microsoft.com/help/4103718/windows-7-update-kb4103718);
  - Windows 10 версии 1709: [8 мая 2018 г. — KB4103727 (сборка ОС 16299.431)](https://support.microsoft.com/help/4103727/windows-10-update-kb4103727).

Чтобы устранить эту проблему, убедитесь, что на компьютерах, к которым подключаются пользователи, (а также серверы RDSH или RDVI) установлены все обновления в том числе за июнь 2018 г. К ним относятся следующие обновления:

  - Windows Server 2016: [12 июня 2018 г. — KB4284880 (сборка ОС 14393.2312)](https://support.microsoft.com/help/4284880/windows-10-update-kb4284880);
  - Windows Server 2012 R2: [12 июня 2018 г. — KB4284815 (ежемесячный накопительный пакет)](https://support.microsoft.com/help/4284815/windows-81-update-kb4284815);
  - Windows Server 2012: [12 июня 2018 г. — KB4284855 (ежемесячный накопительный пакет)](https://support.microsoft.com/help/4284855/windows-server-2012-update-kb4284855);
  - Приложение. [12 июня 2018 г. — KB4284826 (ежемесячный накопительный пакет)](https://support.microsoft.com/help/4284826/windows-7-update-kb4284826);
  - Windows Server 2008 с пакетом обновления 2 (SP2): обновление KB4056564, [Description of the security update for the CredSSP remote code execution vulnerability in Windows Server 2008, Windows Embedded POSReady 2009, and Windows Embedded Standard 2009: March 13, 2018](https://support.microsoft.com/help/4056564/security-update-for-vulnerabilities-in-windows-server-2008) (Описание обновления системы безопасности для устранения уязвимости CredSSP, допускающей удаленное выполнение кода, в Windows Server 2008, Windows Embedded POSReady 2009 и Windows Embedded Standard 2009: 13 марта 2018 г.).

## <a name="users-are-denied-access-on-a-deployment-that-uses-remote-credential-guard-with-multiple-rd-connection-brokers"></a>Пользователям запрещается доступ к развертыванию, которое использует Remote Credential Guard с несколькими брокерами подключений к удаленному рабочему столу

Эта проблема возникает в развертываниях с высоким уровнем доступности, в которых используются не менее двух брокеров подключений к удаленному рабочему столу и Remote Credential Guard в Защитнике Windows. Пользователям не удается войти на удаленные рабочие столы.

Эта проблема связана с тем, что Remote Credential Guard использует Kerberos для проверки подлинности, а также запрещает использовать NTLM. Но в конфигурации с высоким уровнем доступности и балансировкой нагрузки брокеры подключений к удаленному рабочему столу не могут поддерживать операции Kerberos.

Если нужно использовать конфигурации с высоким уровнем доступности и балансировкой нагрузки брокеров подключений к удаленному рабочему столу, эту проблему можно устранить, отключив Remote Credential Guard. Дополнительные сведения об управлении Remote Credential Guard в Защитнике Windows см. в статье [Protect Remote Desktop credentials with Windows Defender Remote Credential Guard](https://docs.microsoft.com/windows/security/identity-protection/remote-credential-guard#enable-windows-defender-remote-credential-guard) (Защита учетных данных удаленного рабочего стола с помощью Remote Credential Guard в Защитнике Windows).
