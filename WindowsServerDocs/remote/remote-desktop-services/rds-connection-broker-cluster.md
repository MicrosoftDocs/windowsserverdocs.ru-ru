---
title: Добавление сервера посредника подключений к удаленному рабочему Столу для настройки высокого уровня доступности в RDS
description: Узнайте, как добавить в развертывание служб удаленных рабочих СТОЛОВ для обеспечения высокой доступности посредника подключений к удаленному рабочему Столу.
ms.custom: na
ms.prod: windows-server-threshold
ms.reviewer: na
ms.suite: na
ms.technology: remote-desktop-services
ms.author: elizapo
ms.date: 04/10/2017
ms.tgt_pltfrm: na
ms.topic: article
author: lizap
manager: dongill
ms.openlocfilehash: 2f4fc63c6ff7c1254fda630a8f34188d8fedc8e5
ms.sourcegitcommit: 0d0b32c8986ba7db9536e0b8648d4ddf9b03e452
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2019
ms.locfileid: "59825045"
---
# <a name="add-the-rd-connection-broker-server-to-the-deployment-and-configure-high-availability"></a>Добавление сервера посредника подключений к удаленному рабочему столу в развертывание и настройка высокого уровня доступности

>Область применения. Windows Server (полугодовой канал), Windows Server 2016

Можно развернуть кластер посредник подключений удаленных рабочих столов (RD Connection Broker) для повышения доступности и масштабирования инфраструктуры служб удаленных рабочих столов. 

## <a name="pre-requisites"></a>Предварительные требования

Настройка сервера в качестве второго посредника подключений к удаленному рабочему Столу — это может быть физический сервер или виртуальную Машину.

Настройка базы данных для посредника подключений. Можно использовать [базы данных SQL Azure](https://azure.microsoft.com/documentation/articles/sql-database-get-started/#create-a-new-aure-sql-database) экземпляра или SQL Server в локальной среде. Мы говорим об использовании ниже SQL Azure, но действия также применимы к SQL Server. Необходимо найти строку подключения для базы данных и убедитесь, что у вас есть драйвер ODBC.

## <a name="step-1-configure-the-database-for-the-connection-broker"></a>Шаг 1. Настройка базы данных для посредника подключений

1. Найти строку подключения для базы данных, которую вы создали, — нужно его как для идентификации версии драйвера ODBC требуется и более поздней версии, при настройке подключения брокер (шаг 3), поэтому сохранить строку где-то, где на него можно ссылаться без труда. Вот, как найти строку подключения для Azure SQL:  
    1. На портале Azure щелкните **Обзор > группы ресурсов** и щелкните группу ресурсов для развертывания.   
    2. Выберите базу данных SQL, который вы только что создали (например, CB DB1).   
    3. Нажмите кнопку **параметры > Свойства > Показать строки подключения к базе данных**.   
    4. Скопируйте строку подключения для **ODBC (включает Node.js)**, который должен выглядеть следующим образом:   
      
        Driver = {SQL Server Native Client 13.0}; Server = tcp:cb-sqls1.database.windows.net,1433; Database = CB-DB1; UID =sqladmin@contoso; PWD = {your_password_here}; Шифрование = yes; TrustServerCertificate = нет; Время ожидания подключения = 30;   
  
    5. Замените «your_password_here» текущий пароль. Вы будете использовать этот всю строку с включен пароль, при подключении к базе данных. 
2. Установка драйвера ODBC на новый посредник подключений: 
   1. Если вы используете виртуальную Машину для посредника подключений, создайте общедоступный IP-адрес для первого посредника подключений к удаленному рабочему Столу. (Только необходимо это сделать, если виртуальная машина СУРБД еще не содержит общедоступный IP-адрес, чтобы разрешить подключения по протоколу RDP.)
       1. На портале Azure щелкните **Обзор > группы ресурсов**, щелкните группу ресурсов для развертывания и нажмите кнопку первой виртуальной машины посредника подключений к удаленному рабочему Столу (например, Contoso-Cb1).
       2. Нажмите кнопку **параметры > Сетевые интерфейсы**и выберите соответствующий сетевой интерфейс.
       3. Нажмите кнопку **параметры > IP-адрес**.
       4. Для **общедоступный IP-адрес**выберите **включено**, а затем нажмите кнопку **IP-адрес**.
       5. Если у вас есть существующий общедоступный IP-адрес, вы хотите использовать, выберите его из списка. В противном случае нажмите **создать**, введите имя и нажмите кнопку **ОК** и затем **Сохранить**.
   2. Подключитесь к первой посредника подключений к удаленному рабочему Столу:
       1. На портале Azure щелкните **Обзор > группы ресурсов**, щелкните группу ресурсов для развертывания и нажмите кнопку первой виртуальной машины посредника подключений к удаленному рабочему Столу (например, Contoso-Cb1).
       2. Нажмите кнопку **Connect > Открыть** открыт клиент удаленного рабочего стола.
       3. В окне клиента, выберите **Connect**, а затем нажмите кнопку **использовать другую учетную запись пользователя**. Введите имя пользователя и пароль для учетной записи администратора домена.
       4. Нажмите кнопку **Да** при предупреждение о сертификате.
   3. Скачайте [драйвер ODBC для SQL Server](https://www.microsoft.com/download/confirmation.aspx?id=50420) , соответствующий версии в строке подключения ODBC. Выше примере строки нам нужно установить драйвер ODBC 13 версии.
   4. Скопируйте файл sqlincli.msi первый сервер посредника подключений к удаленному рабочему Столу.   
   5. Откройте файл sqlincli.msi и установить собственный клиент.  
   6. Повторите шаги 1 – 5 для каждой дополнительной посредников подключений к удаленному рабочему Столу (например, Contoso-Cb2).
   7. Установка драйвера ODBC на каждом сервере, который будет выполняться посредника подключений.

## <a name="step-2-configure-load-balancing-on-the-rd-connection-brokers"></a>Шаг 2. Настройка балансировки нагрузки для посредников подключений к удаленному рабочему Столу 

Если вы используете инфраструктуру Azure, можно создать [балансировщика нагрузки Azure](#create-a-load-balancer); Если нет, вы можете задать вверх [циклический перебор DNS](#configure-dns-round--robin). 

### <a name="create-a-load-balancer"></a>Создание подсистемы балансировки нагрузки  
1. Создание подсистемы балансировки нагрузки Azure   
      1. На портале Azure откройте **Обзор > подсистемы балансировки нагрузки > Добавить**.   
      2. Введите имя для новой подсистемы балансировки нагрузки (например, hacb).   
      3. Выберите **внутренний** для **схемы**, **виртуальной сети** для развертывания (например, Contoso-VNet) и **подсети** со всеми ресурсов (например, по умолчанию).   
      4. Выберите **статический** для **назначение IP-адресов** и введите **частный IP-адрес** то есть не в настоящее время используется (например, 10.0.0.32).   
      5. Выберите соответствующий **подписки**, **группы ресурсов** со всеми ресурсами и соответствующий **расположение**.   
      6. Щелкните **Создать**.   
2. Создание [пробы](https://azure.microsoft.com/documentation/articles/load-balancer-custom-probe-overview/) к монитору, активные серверы:   
      1. На портале Azure щелкните **Обзор > подсистемы балансировки нагрузки**, а затем нажмите кнопку подсистемы балансировки нагрузки вы только что создали, (например, CBLB). Щелкните **Параметры**.   
      2. Нажмите кнопку **пробы > Добавить**.   
      3. Введите имя для проверки (например, **RDP**) выберите **TCP** как **протокола**, введите **3389** для **порт**, а затем нажмите кнопку **ОК**.   
3. Создайте внутренний пул посредников подключений:   
      1. В **параметры**, нажмите кнопку **внутренние пулы адресов > Добавить**.   
      2. Введите имя (например, CBBackendPool), а затем щелкните **добавить виртуальную машину**.  
      3. Выберите группу доступности (например, CbAvSet), а затем нажмите кнопку **ОК**.   
      3. Нажмите кнопку **выберите виртуальные машины**, выберите все виртуальные машины и нажмите кнопку **выберите > ОК > ОК**.   
4. Создайте правило балансировки нагрузки протокола удаленного рабочего СТОЛА:   
      1. В **параметры**, нажмите кнопку **правила балансировки нагрузки**, а затем нажмите кнопку **добавить**.   
      2. Введите имя (например, RDP), выберите **TCP** для **протокола**, введите **3389** для обоих **порт** и **внутренний порт** и нажмите кнопку **ОК**.   
5. Добавьте запись DNS для подсистемы балансировки нагрузки:   
      1. Подключитесь к виртуальной машине server СУРБД (например, Contoso-CB1). Ознакомьтесь с [подготовьте виртуальную Машину Broker подключения к удаленному рабочему Столу](Prepare-the-RD-Connection-Broker-VM-for-Remote-Desktop.md) статье описано, как подключаться к виртуальной Машине.   
      2. В диспетчере серверов щелкните **средства > DNS**.   
      3. На панели слева разверните **DNS**выберите машины DNS, нажмите кнопку **зоны прямого просмотра**и щелкните имя домена (например, Contoso.com). (Может занять несколько секунд для обработки запросов на DNS-сервер для данных.)  
      4. Нажмите кнопку **действие > новый узел (A или AAAA)**.   
      9. Введите имя (например, hacb) и IP-адрес указанной ранее (например, 10.0.0.32).   
  
### <a name="configure-dns-round-robin"></a>Настройка циклический перебор DNS  
  
Следующие действия являются альтернативой созданию внутреннего балансировщика нагрузки Azure.   
  
1. Подключитесь к серверу СУРБД на портале Azure. с помощью клиента удаленного рабочего стола   
2. Создание записей DNS:   
      1. В диспетчере серверов щелкните **средства > DNS**.   
      2. На панели слева разверните **DNS**выберите машины DNS, нажмите кнопку **зоны прямого просмотра**и щелкните имя домена (например, Contoso.com). (Может занять несколько секунд для обработки запросов на DNS-сервер для данных.)  
      3. Нажмите кнопку **действие** и **новый узел (A или AAAA)**.   
      4. Введите **DNS-имя** для посредника подключений к удаленному рабочему Столу кластера (например, hacb), а затем введите **IP-адрес** из первого посредника подключений к удаленному рабочему Столу.   
      5. Повторите шаги 3 и 4 для каждой дополнительной RD Connection Broker, предоставляя каждый уникальный IP-адрес для каждой дополнительной записи.


Например если IP-адресов для двух виртуальных машин посредника подключений к удаленному рабочему Столу 10.0.0.8 и 10.0.0.9, вы создадите две записи узла DNS:
 - Имя узла: hacb.contoso.com, IP-адрес: 10.0.0.8
 - Имя узла: hacb.contoso.com, IP-адрес: 10.0.0.9

## <a name="step-3-configure-the-connection-brokers-for-high-availability"></a>Шаг 3. Настройка посредников подключений для обеспечения высокой доступности

1. Добавьте новый сервер посредника подключений к удаленному рабочему Столу в диспетчер серверов:
   1. В диспетчере серверов щелкните **Управление > Добавление серверов**.
   2. Щелкните **Find Now**(Найти).
   3. Щелкните только что созданный сервер посредника подключений к удаленному рабочему Столу (например, Contoso-Cb2) и нажмите кнопку **ОК**.
2. Настройка высокого уровня доступности для посредника подключений к удаленному рабочему Столу:
   1. В диспетчере серверов щелкните **служб удаленных рабочих столов > Обзор**.
   2. Щелкните правой кнопкой мыши **посредника подключений к удаленному рабочему Столу**, а затем нажмите кнопку **Настройка высокого уровня доступности**.
   3. Страница в мастере, пока не откроется раздел тип конфигурации. Выберите **сервер базы данных Shared**, а затем нажмите кнопку **Далее**.
   4. Введите имя DNS для кластера посредника подключений к удаленному рабочему Столу.
   5. Введите строку подключения для базы данных SQL и затем странице мастер для обеспечения высокого уровня доступности.
3. Добавить новый посредник подключений к удаленному рабочему Столу в развертывание
   1. В диспетчере серверов щелкните **служб удаленных рабочих столов > Обзор**.
   2. Щелкните правой кнопкой мыши посредника подключений к удаленному рабочему Столу и нажмите кнопку **Добавление сервера посредника подключений к удаленному рабочему Столу**.
   3. Страницы мастера, пока не дойдете до выбора сервера, затем выберите только что созданный сервер посредника подключений к удаленному рабочему Столу (например, Contoso-CB2).
   4. Завершите работу мастера, приняв значения по умолчанию.
4. Настройка доверенных сертификатов серверов посредника подключений к удаленному рабочему Столу и клиентов.

