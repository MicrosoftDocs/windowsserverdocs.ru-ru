---
title: Добавление сервера посредника подключений к удаленному рабочему столу для настройки высокого уровня доступности в RDS
description: Узнайте, как добавить в развертывание RDS посредник подключений к удаленному рабочему столу, чтобы обеспечить высокую доступность.
ms.author: elizapo
ms.date: 04/10/2017
ms.topic: article
author: lizap
manager: dongill
ms.openlocfilehash: d5e69c35baf9f74542a85041b95808bc823b746a
ms.sourcegitcommit: dfa48f77b751dbc34409aced628eb2f17c912f08
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/07/2020
ms.locfileid: "87961798"
---
# <a name="add-the-rd-connection-broker-server-to-the-deployment-and-configure-high-availability"></a>Добавление сервера посредника подключений к удаленному рабочему столу в развертывание и настройка высокого уровня доступности

>Применяется к: Windows Server (Semi-Annual Channel), Windows Server 2019, Windows Server 2016

Можно развернуть кластер посредника подключений к удаленному рабочему столу, чтобы повысить доступность и масштабирование инфраструктуры служб удаленных рабочих столов.

## <a name="pre-requisites"></a>Предварительные требования

Настройте сервер в качестве второго посредника подключений к удаленному рабочему столу. Это может быть физический сервер или виртуальная машина.

Настройте базу данных для посредника подключений. Можно использовать экземпляр [Базы данных SQL Azure](/azure/azure-sql/database/single-database-create-quickstart#create-a-new-aure-sql-database) или SQL Server в локальной среде. Ниже мы рассматриваем использование SQL Azure, но инструкции также применимы к SQL Server. Необходимо будет найти строку подключения к базе данных и убедиться, что установлен правильный драйвер ODBC.

## <a name="step-1-configure-the-database-for-the-connection-broker"></a>Шаг 1. Настройка базы данных для посредника подключений

1. Найдите строку подключения к базе данных, которую вы создали. Она нужна как для идентификации версии драйвера ODBC, который потребуется позже, так и для настройки посредника подключений (шаг 3), поэтому сохраните эту строку где-нибудь, чтобы она была под рукой. Вот как можно найти строку подключения к Базе данных SQL Azure.
    1. На портале Azure щелкните **Обзор > Группы ресурсов**, а затем щелкните группу ресурс для развертывания.
    2. Выберите базу данных SQL, которую вы только что создали (например, CB-DB1).
    3. Щелкните **Параметры** > **Свойства** > **Показать строки подключения к базам данных**.
    4. Скопируйте строку подключения для **ODBC (включая Node.js)** , которая должна выглядеть следующим образом.

        ```
        Driver={SQL Server Native Client 13.0};Server=tcp:cb-sqls1.database.windows.net,1433;Database=CB-DB1;Uid=sqladmin@contoso;Pwd={your_password_here};Encrypt=yes;TrustServerCertificate=no;Connection Timeout=30;
        ```

    5. Замените your_password_here своим текущим паролем. Вы будете использовать эту строку с паролем при подключении к базе данных.
2. Установите драйвер ODBC на новый посредник подключений.
   1. Если вы используете виртуальную машину для посредника подключений, создайте общедоступный IP-адрес для первого посредника подключений к удаленному рабочему столу. (Это необходимо сделать, только если у виртуальной машины RDMS еще нет общедоступного IP-адреса для подключений по протоколу RDP.)
       1. На портале Azure щелкните **Обзор** > **Группы ресурсов**. Выберите группу ресурсов для развертывания и щелкните первую виртуальную машину посредника подключений к удаленному рабочему столу (например, Contoso-Cb1).
       2. Щелкните **Параметры > Сетевые интерфейсы** и выберите соответствующий сетевой интерфейс.
       3. Щелкните **Параметры > IP-адрес**.
       4. Для параметра **Общедоступный IP-адрес** выберите **Включено**, а затем щелкните **IP-адрес**.
       5. Если у вас имеется общедоступный IP-адрес, который вы хотите использовать, выберите его из списка. В противном случае щелкните **Создать**, введите имя и нажмите кнопку **ОК**, а затем — кнопку **Сохранить**.
   2. Подключитесь к первому посреднику подключений к удаленному рабочему столу.
       1. На портале Azure щелкните **Обзор** > **Группы ресурсов**. Выберите группу ресурсов для развертывания и щелкните первую виртуальную машину посредника подключений к удаленному рабочему столу (например, Contoso-Cb1).
       2. Щелкните **Подключить > Открыть**, чтобы открыть клиент удаленного рабочего стола.
       3. В окне клиента выберите **Подключить**, а затем щелкните **Use another user account** (Использовать другую учетную запись пользователя). Введите имя пользователя и пароль для учетной записи администратора домена.
       4. Нажмите кнопку **Да** в ответ на предупреждение о сертификате.
   3. Скачайте [драйвер ODBC для SQL Server](https://www.microsoft.com/download/confirmation.aspx?id=50420), соответствующий версии в строке подключения ODBC. Для примера строки выше нам нужно установить драйвер ODBC версии 13.
   4. Скопируйте файл sqlincli.msi на первый сервер посредника подключений к удаленному рабочему столу.
   5. Откройте файл sqlincli.msi и установите собственный клиент.
   6. Повторите шаги 1–5 для всех остальных посредников подключений к удаленному рабочему столу (например, Contoso-Cb2).
   7. Установите драйвер ODBC на каждом сервере, на котором будет выполняться посредник подключений.

## <a name="step-2-configure-load-balancing-on-the-rd-connection-brokers"></a>Шаг 2. Настройка балансировки нагрузки для посредников подключений к удаленному рабочему столу

Если вы используете инфраструктуру Azure, то можете создать [Azure Load Balancer](#create-a-load-balancer). Если нет, то вы можете настроить [циклический перебор DNS](#configure-dns-round-robin).

### <a name="create-a-load-balancer"></a>Создание подсистемы балансировки нагрузки
1. Создайте Azure Load Balancer.
      1. На портале Azure выберите **Обзор > Балансировщики нагрузки > Добавить**.
      2. Введите имя для новой подсистемы балансировки нагрузки (например, hacb).
      3. Выберите значение **Внутренний** для параметра **Схема**, а также выберите для развертывания **виртуальную сеть** (например, Contoso-VNet) и **подсеть** со всеми вашими ресурсами (например, default).
      4. Выберите значение **Статический** для параметра **Назначение IP-адресов** и введите **частный IP-адрес**, который сейчас не используется (например, 10.0.0.32).
      5. Выберите соответствующую **подписку**, **группу ресурсов** со всеми вашими ресурсами и соответствующее **расположение**.
      6. Щелкните **Создать**.
2. Создайте [пробу](/azure/load-balancer/load-balancer-custom-probe-overview) для отслеживания активности серверов.
      1. На портале Azure щелкните **Обзор > Балансировщик нагрузки**, а затем щелкните подсистему балансировки нагрузки, которую вы только что создали, (например, CBLB). Щелкните **Параметры**.
      2. Щелкните **Пробы > Добавить**.
      3. Введите имя пробы (например, **RDP**), выберите **протокол** **TCP**, введите **3389** в качестве номера **порта**, а затем нажмите кнопку **ОК**.
3. Создайте внутренний пул посредников подключений.
      1. В разделе **Параметры** щелкните **Серверные пулы адресов > Добавить**.
      2. Введите имя (например, CBBackendPool), а затем щелкните **Добавить виртуальную машину**.
      3. Выберите группу доступности (например, CbAvSet), а затем нажмите кнопку **ОК**.
      3. Щелкните **Выберите виртуальные машины**, выберите все виртуальные машины и щелкните **Выбрать > ОК > ОК**.
4. Создайте правило балансировки нагрузки RDP.
      1. В разделе **Параметры** щелкните **Правила балансировки нагрузки**, а затем нажмите кнопку **Добавить**.
      2. Введите имя (например, RDP), выберите **протокол** **TCP**, введите **3389** в качестве номера **порта** и **внутреннего порта**, а затем нажмите кнопку **ОК**.
5. Добавьте запись DNS для подсистемы балансировки нагрузки.
      1. Подключитесь к виртуальной машине сервера RDMS (например, Contoso-CB1). Инструкции по подключению к виртуальной машине можно найти в статье [Создание виртуальных машин для удаленного рабочего стола](./rds-prepare-vms.md).
      2. В диспетчере серверов щелкните **Средства > DNS**.
      3. В области слева разверните пункт **DNS**, выберите компьютер DNS, щелкните **Зоны прямого просмотра** и щелкните используемое вами доменное имя (например, Contoso.com). (Обработка запроса к DNS-серверу для получения данных может занять несколько секунд.)
      4. Щелкните **Действие > Новый узел (A или AAAA)** .
      9. Введите имя (например, hacb) и IP-адрес, указанный ранее (например, 10.0.0.32).

### <a name="configure-dns-round-robin"></a>Настройка циклического перебора DNS

Следующие действия являются альтернативой созданию внутренней подсистемы балансировки нагрузки Azure.

1. Подключитесь к серверу RDMS на портале Azure. Использование клиента подключения к удаленному рабочему столу
2. Создайте записи DNS.
      1. В диспетчере серверов щелкните **Средства > DNS**.
      2. В области слева разверните пункт **DNS**, выберите компьютер DNS, щелкните **Зоны прямого просмотра** и щелкните используемое вами доменное имя (например, Contoso.com). (Обработка запроса к DNS-серверу для получения данных может занять несколько секунд.)
      3. Щелкните **Действие** > **Новый узел (A или AAAA)** .
      4. Введите **DNS-имя** для кластера посредника подключений к удаленному рабочему столу (например, hacb), а затем введите **IP-адрес** первого посредника подключений к удаленному рабочему столу.
      5. Повторите шаги 3 и 4 для всех остальных посредников подключений к удаленному рабочему столу, указывая уникальный IP-адрес для каждой дополнительной записи.


Например, если IP-адреса двух виртуальных машин посредника подключений к удаленному рабочему столу — 10.0.0.8 и 10.0.0.9, то вы создадите две записи узла DNS:
 - Имя узла: hacb.contoso.com, IP-адрес: 10.0.0.8
 - Имя узла: hacb.contoso.com, IP-адрес: 10.0.0.9

## <a name="step-3-configure-the-connection-brokers-for-high-availability"></a>Шаг 3. Настройка посредников подключений для обеспечения высокой доступности

1. Добавьте в диспетчер серверов сервер посредника подключений к удаленному рабочему столу.
   1. В диспетчере серверов щелкните **Управление > Добавить серверы**.
   2. Щелкните **Find Now**(Найти).
   3. Щелкните только что созданный сервер посредника подключений к удаленному рабочему столу (например, Contoso-Cb2) и нажмите кнопку **ОК**.
2. Настройте высокий уровень доступности для посредника подключений к удаленному рабочему столу.
   1. В диспетчере серверов щелкните **Службы удаленных рабочих столов > Обзор**.
   2. Щелкните правой кнопкой мыши **посредник подключений к удаленному рабочему столу**, а затем выберите **Настройка высокого уровня доступности**.
   3. Переходите между страницами мастера, пока не откроется раздел "Тип конфигурации". Выберите **Общий сервер базы данных**, а затем нажмите кнопку **Далее**.
   4. Введите DNS-имя для кластера посредника подключений к удаленному рабочему столу.
   5. Введите строку подключения к базе данных SQL, затем переходите по страницам мастера, чтобы настроить высокий уровень доступности.
3. Добавление нового посредника подключений к удаленному рабочему столу в развертывание
   1. В диспетчере серверов щелкните **Службы удаленных рабочих столов > Обзор**.
   2. Щелкните правой кнопкой мыши посредник подключений к удаленному рабочему столу и выберите **Add RD Connection Broker Server** (Добавить сервер посредника подключений к удаленному рабочему столу).
   3. Переходите между страницами мастера, пока не дойдете до выбора сервера. Выберите только что созданный сервер посредника подключений к удаленному рабочему столу (например, Contoso-CB2).
   4. Завершите работу мастера, приняв значения по умолчанию.
4. Настройте доверенные сертификаты на серверах и клиентах посредника подключений к удаленному рабочему столу.
