---
title: Использование счетчиков производительности для диагностики проблем скорости реагирования приложения на удаленных узлах сеанса рабочего стола
description: Работает ли приложение медленно на RDS? Дополнительные сведения о счетчиках производительности, которые можно использовать для диагностики проблем производительности приложения на RDSH
ms.prod: windows-server-threshold
ms.technology: remote-desktop-services
ms.author: elizapo
ms.date: 09/19/2018
ms.tgt_pltfrm: na
ms.topic: article
author: lizap
manager: dougkim
ms.localizationpriority: medium
ms.openlocfilehash: 241b2b776a68cf5aec68a4d331201a07f0e5ea53
ms.sourcegitcommit: 0d0b32c8986ba7db9536e0b8648d4ddf9b03e452
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2019
ms.locfileid: "59844655"
---
# <a name="use-performance-counters-to-diagnose-app-performance-problems-on-remote-desktop-session-hosts"></a>Использование счетчиков производительности для диагностики проблем производительности приложения на удаленных узлах сеанса рабочего стола

Одна из наиболее сложных проблем для диагностики является ухудшения производительности приложения — приложения выполняется медленно или не отвечает. В большинстве случаев запуск вашего диагностики путем сбора данных ЦП, памяти, дискового ввода вывода и других метрик и затем использовать такие средства, как Windows Performance Analyzer выяснить причину проблемы. К сожалению в большинстве случаев эти данные не поможет определить основную причину, так как счетчики потребления ресурсов встречаются частые и большие. Это затрудняет чтение данных и сопоставить его с обнаруженной проблемы. Помогут вам более быстро устранить проблемы производительности приложения, мы добавили некоторые новые счетчики производительности (доступные [для загрузки](#download-windows-server-insider-software) через [программа предварительной оценки Windows](https://insider.windows.com)) этот пользователь мер входные потоки.

Счетчик задержки ввода пользователя может помочь быстро определить основную причину неправильный конечных пользователей возможности удаленного рабочего СТОЛА. Этот счетчик измеряет, сколько любой пользователь, ввод (например, использование мыши или клавиатуры) остается в очереди перед выбирается с помощью процесса, а счетчик работает в локальных и удаленных сеансах.

На следующем рисунке грубого представление входного потока пользователя от клиента к приложению.

![Удаленный рабочий стол - входных потоков пользователей из клиента удаленного рабочего стола пользователей для приложения](.\media\rds-user-input.png)

Задержка ввода пользователя счетчик измеряет задайте максимальную разницу (в течение интервала времени) между входные данные в очередь и когда его получает приложением в [цикл обработки сообщений традиционных](https://msdn.microsoft.com/library/windows/desktop/ms644927.aspx#loop), как показано на следующей блок-схема:

![Ввод пользователя удаленного рабочего стола - потока счетчика производительности для задержки](.\media\rds-user-input-delay.png)

Один важный момент этого счетчика является, что он сообщает задержка ввода максимального числа пользователей в течение интервала можно настроить. Это самое большое время, необходимое для входных данных к приложению, что может повлиять на скорость выполнения операций важные и видимым, как вводить.

Например в следующей таблице, задержка ввода пользователя будет отмечено как 1000 мс в течение этого интервала. Счетчик медленных пользовательского ввода задержки в интервале, поскольку пользователя впечатление «медленным» определяется наиболее медленно введенное время (максимум) они возникают, не средняя скорость все общее входные данные.

|Номер| 0 | 1 | 2 |
|------|---|---|---|
|Задержка |16 мс| 20 мс| 1000 мс|

## <a name="enable-and-use-the-new-performance-counters"></a>Включение и использование счетчиков производительности

Чтобы использовать эти новые счетчики производительности, необходимо сначала включить раздел реестра, выполнив следующую команду:

```
reg add "HKLM\System\CurrentControlSet\Control\Terminal Server" /v "EnableLagCounter" /t REG_DWORD /d 0x1 /f
```

>[!NOTE]
> Если вы используете Windows 10, 1809 или более поздней версии или Windows Server 2019 или более поздней версии, не нужно будет включить раздел реестра.

Затем перезагрузите сервер. Затем откройте системный монитор и щелкните значок плюса (+), как показано на следующем снимке экрана.

![Удаленный рабочий стол — снимок экрана, показывающий, как добавить пользователя входных данных счетчика производительности для задержки](.\media\rds-add-user-input-counter-screen.png)

После этого вы увидите диалоговое окно Добавить счетчики, где можно выбрать **задержки ввода пользователя на процесс** или **задержки входные данные пользователя за сеанс**.

![Удаленный рабочий стол — снимок экрана, показывающий, как добавить задержку ввода пользователя за сеанс](.\media\rds-user-delay-per-session.png)

![Удаленный рабочий стол — снимок экрана, показывающий Добавление задержка ввода пользователя на процесс](.\media\rds-user-delay-per-process.png)

При выборе **задержки ввода пользователя на процесс**, вы увидите **экземпляры выбранного объекта** (другими словами, процессы) в ```SessionID:ProcessID <Process Image>``` формате.

Например, если приложение калькулятора выполняется в [1 идентификатор сеанса](https://msdn.microsoft.com/library/ms524326.aspx), вы увидите ```1:4232 <Calculator.exe>```.

> [!NOTE]
> Не все процессы включаются. Вы не увидите все процессы, запущенные как системы.

Счетчик запускает reporting задержки ввода пользователя, как только его добавить. Обратите внимание на то, что максимальный масштаб становится равным 100 (мс) по умолчанию. 

![Удаленный рабочий стол — пример действия для каждого процесса в системном мониторе задержка входных данных пользователя](.\media\rds-sample-user-input-delay-perfmon.png)

Теперь давайте взглянем на **задержки входные данные пользователя за сеанс**. Экземпляров для каждого идентификатора сеанса, и их счетчики показывают задержка ввода пользователя любого процесса в указанном сеансе. Кроме того есть два экземпляра, именем «Max» (максимальное количество пользовательских входных задержку во всех сеансах) и «Average» (среднее acorss все сеансы).

В этой таблице показан пример visual из этих экземпляров. (Можно получить те же сведения в системном мониторе, переключившись в graph тип отчета.)

|Тип счетчика|Имя экземпляра|Сообщаемые задержка (мс)|
|---------------|-------------|-------------------|
|Задержка ввода пользователя каждого процесса|1:4232 < Calculator.exe >|  200|
|Задержка ввода пользователя каждого процесса|2:1000 < Calculator.exe >|  16|
|Задержка ввода пользователя каждого процесса|1:2000 < Calculator.exe >|  32|
|Задержка ввода пользователя за сеанс|1|    200|
|Задержка ввода пользователя за сеанс|2|    16|
|Задержка ввода пользователя за сеанс|Среднее|  108|
|Задержка ввода пользователя за сеанс|Max|  200|

## <a name="counters-used-in-an-overloaded-system"></a>Счетчики, используемые в системе перегруженных

Теперь давайте рассмотрим, что вы увидите в отчете Если снижается производительность приложения. На следующей диаграмме показано показания пользователям, работающим удаленно в Microsoft Word. В этом случае когда дополнительные пользователи входят, со временем ухудшится производительность сервера RDSH.

![Удаленный рабочий стол - приведен образец графика производительности, адресованные RDSH-серверу под управлением Microsoft Word](.\media\rds-user-input-perf-graph.png)

Вот как можно прочесть линиях графика:

- Розовая строка показывает количество сеансов входа на сервере.
- Красная линия является ЦП.
- Зеленая линия — это задержка ввода максимального числа пользователей во всех сеансах.
- Синяя линия, (отображается как черный цвет в этот граф) представляет средний пользователь входной задержки во всех сеансах.

Можно заметить, что настроена корреляция между пиков использования ЦП и задержки ввода пользователя, как ЦП получает более широко, от пользователя ввести задержка увеличивается. Кроме того при добавлении большего числа пользователей в систему и ЦП получает ближе к 100%, что приводит к более частые пики задержка на ввода пользователя. Хотя этот счетчик является очень полезным в случаях, когда серверу не хватает ресурсов, вы также можно использовать для отслеживания задержки ввода пользователя, относящиеся к определенному приложению.

## <a name="configuration-options"></a>Параметры конфигурации

Важно помнить при использовании этого счетчика производительности является то, что он сообщает задержки ввода пользователя через определенный интервал 1000 мс по умолчанию. Если задать свойство interval образец счетчика производительности (как показано на следующем снимке экрана) на какие-либо изменения, содержащееся в отчете значение будет неправильным.

![Удаленный рабочий стол — свойства для монитора производительности](.\media\rds-user-input-perfmon-properties.png)

Чтобы устранить эту проблему, можно задать раздел реестра, в соответствии с интервала (в миллисекундах), который вы хотите использовать. Например если мы изменим пример каждые x секунд до 5 секунд, нам нужно значение этого ключа 5000 мс.

```
[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server]

"LagCounterInterval"=dword:00005000
```

>[!NOTE]
>Если вы используете Windows 10, 1809 или более поздней версии или Windows Server 2019 или более поздней версии, не нужно задавать LagCounterInterval исправить счетчика производительности.

Мы также добавили несколько ключей, которые могут оказаться полезными в тот же раздел реестра:

**LagCounterImageNameFirst** — значение этого ключа `DWORD 1` (значение по умолчанию 0 или ключ не существует). Имена счетчиков при этом изменится на «Имя изображения < SessionID:ProcessId >.» Например «обозреватель < 1:7964 >.» Это полезно, если нужно выполнить сортировку по имени изображения.

**LagCounterShowUnknown** — значение этого ключа `DWORD 1` (значение по умолчанию 0 или ключ не существует). Это показывает все процессы, запущенные как службы или системы. Некоторые процессы будут отображаться сеанса работы в качестве «?.»

Это, как если вы включите оба ключа выглядит:

![Удаленный рабочий стол — монитор производительности с помощью обоих ключей на](.\media\rds-user-input-delay-with-two-counters.png)

## <a name="using-the-new-counters-with-non-microsoft-tools"></a>С помощью новых счетчиков с помощью средств сторонних разработчиков

Средства мониторинга можно использовать с помощью этого счетчика [Perfmon API](https://msdn.microsoft.com/library/windows/desktop/aa371903.aspx).

## <a name="download-windows-server-insider-software"></a>Загрузить программное обеспечение Windows Server Insider

Можно перейти непосредственно в раздел зарегистрированных участников программы предварительной оценки [странице загрузки Windows Server Insider Preview](https://www.microsoft.com/en-us/software-download/windowsinsiderpreviewserver) получение последней предварительной оценки программного обеспечения, файлы для загрузки.  Чтобы узнать, как зарегистрировать как изнутри, см. в разделе [Приступая к работе с сервером](https://insider.windows.com/en-us/for-business-getting-started-server/).

## <a name="share-your-feedback"></a>Поделитесь своим мнением

Вы можете отправить отзыв для этой функции через Центр обратной связи. Выберите **приложения > все приложения** и включают «счетчики производительности служб удаленных рабочих СТОЛОВ — системный монитор» в заголовок сообщения в блоге.

Идеи общих функций, см. в статье [страницу RDS UserVoice](https://aka.ms/uservoice-rds).
