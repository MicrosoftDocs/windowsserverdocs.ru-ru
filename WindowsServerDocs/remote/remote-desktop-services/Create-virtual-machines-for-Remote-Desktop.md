---
title: Создание виртуальных машин для удаленного рабочего стола
description: Создайте виртуальные машины, чтобы разместить компоненты удаленного рабочего стола в облаке.
ms.prod: windows-server
ms.technology: remote-desktop-services
ms.author: elizapo
ms.date: 08/01/2016
ms.topic: article
ms.assetid: b0f62d6f-0915-44ca-afef-be44a922e20e
author: lizap
manager: dongill
ms.openlocfilehash: fa17c472e3311e4e34ac7b2176d0045886463274
ms.sourcegitcommit: b00d7c8968c4adc8f699dbee694afe6ed36bc9de
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/08/2020
ms.locfileid: "80818467"
---
# <a name="create-virtual-machines-for-remote-desktop"></a>Создание виртуальных машин для удаленного рабочего стола

>Применяется к: Windows Server (Semi-Annual Channel), Windows Server 2019, Windows Server 2016

Следуйте инструкциям ниже, чтобы создать виртуальные машины в среде клиента, которые будут использоваться для выполнения ролей, служб и компонентов Windows Server 2016, необходимых для развертывания по размещению рабочих столов.   
  
В этом примере базового развертывания будет создано минимальное количество виртуальных машин, то есть 3 единицы. Одна виртуальная машина будет размещать посредник подключений к удаленному рабочему столу, службы роли сервера лицензирования и общую папку для развертывания. Вторая виртуальная машина будет размещать шлюз удаленных рабочих столов и службы роли веб-доступа.  Третья виртуальная машина размещает службу роли узла сеансов удаленных рабочих столов. Для малых развертываний вы можете сократить расходы виртуальной машины, используя прокси-сервер приложения AAD, чтобы исключить все общедоступные конечные точки из развертывания и совместить все службы ролей на одной виртуальной машине. Чтобы предоставить лучшее масштабирование, для более крупных развертываний можно установить различные службы ролей на отдельные виртуальные машины.  
  
В этом разделе описаны действия, необходимые для развертывания виртуальных машин каждой роли, на основе образов Windows Server в [Microsoft Azure Marketplace](https://azure.microsoft.com/marketplace/). Если вам нужно создать виртуальные машины из пользовательского образа, требующего PowerShell, см. статью [Создание виртуальной машины Windows с помощью диспетчера ресурсов и PowerShell](https://azure.microsoft.com/documentation/articles/virtual-machines-windows-ps-create/). Затем вернитесь сюда, чтобы подключить диски данных Azure для общей папки, и введите внешний URL-адрес для развертывания.  
  
1. [Создайте виртуальные машины Windows](https://azure.microsoft.com/documentation/articles/virtual-machines-windows-hero-tutorial/), чтобы разместить посредник подключений к удаленному рабочему столу, сервер лицензирования удаленного рабочего стола и файловый сервер.  
  
   Для наших целей мы использовали следующие соглашения об именовании:  
   - Посредник подключений к удаленному рабочему столу, сервер лицензирования удаленного рабочего стола и файловый сервер:   
       - Виртуальная машина: Contoso-Cb1  
       - Группа доступности: CbAvSet    
   - Веб-доступ к удаленным рабочим столам и шлюз удаленных рабочих столов:   
       - Виртуальная машина: Contoso-WebGw1  
       - Группа доступности: WebGwAvSet  
          
   - Узел сеансов удаленных рабочих столов:   
       - Виртуальная машина: Contoso-Sh1  
       - Группа доступности: ShAvSet  
          
   Каждая виртуальная машина использует одинаковую группу ресурсов.  
2. Создайте и подключите диск данных Azure, чтобы предоставить общий доступ для диска профиля пользователя (UPD).  
   1.  На портале Azure щелкните **Обзор > Группы ресурсов**, выберите группу ресурсов для развертывания, а затем — виртуальную машину, созданную для посредника подключений к удаленному рабочему столу (например, Contoso-Cb1).  
   2.  Щелкните **Параметры > Диски > Подключить новый**.  
   3.  Примите значения по умолчанию для имени и типа.  
   4.  Введите размер (в ГБ), который будет достаточным для хранения общих сетевых ресурсов среды клиента, включая диски профилей пользователей и сертификаты. Вы можете уделить приблизительно 5 ГБ на пользователя, которого вы планируете использовать  
   5.  Примите значения по умолчанию для расположения и кэширование узла и нажмите кнопку **ОК**.  
3. Создайте внешний балансировщик нагрузки, чтобы предоставить доступ к развертыванию вне системы.
   1. На портале Azure щелкните **Обзор > Load balancer**, а затем нажмите кнопку **Добавить**.
   2. Введите **имя**, выберите **Общедоступный** в качестве **типа** подсистемы балансировки нагрузки и выберите соответствующую **подписку**,  **группу ресурсов**, и **расположение**.
   3. Нажмите **Выбрать общедоступный IP-адрес**, **Создать новый**, введите имя и нажмите **ОК**.
   4. Нажмите **Создать**, чтобы создать подсистему балансировки нагрузки.
4. Настройка внешней подсистемы балансировки нагрузки для развертывания
   1. На портале Azure щелкните **Обзор > Группы ресурсов**, выберите группу ресурсов для развертывания, а затем — подсистему балансировки нагрузки, созданную для развертывания.
   2. Добавьте серверный пул для подсистемы балансировки нагрузки, чтобы отправить трафик в:
       1. Нажмите **Серверный пул** и **Добавить**.
       2. Введите **имя** и выберите **\+ Добавить виртуальную машину**.
       3. Нажмите **Группа доступности** и **WebGwAvSet**.
       4. Нажмите **Виртуальные машины**, **Contoso WebGw1**, **Выбрать**, **ОК**, и **ОК**.
   3. Добавьте пробу, чтобы подсистеме балансировки нагрузки было известно, какие машины активны:
       1. Выберите **Пробы** и **Добавить**.
       2. Введите **имя** (например, HTTPS), выберите **TCP**, введите **Порт** 443 и нажмите **ОК**.
   4. Введите правила балансировки нагрузки для распределения нагрузки входящего трафика:
      1. Нажмите **Правила балансировки нагрузки** и **Добавить**
      2. Введите **имя** (например, HTTPS), выберите **TCP**и 443 для **порта** и **внутреннего порта**.
          - Если вы выполняете развертывание на Windows 10 и Windows Server 2016, оставьте значение **Сохранение состояния сеанса** как **None** (Нет), или выберите **IP-адрес клиента**.
      3. Нажмите **ОК**, чтобы подтвердить правило HTTPS.
      4. Создайте новое правило, нажав **Добавить**.
      5. Введите **имя** (например, UDP), выберите **UDP**и 3391 для <strong>порта и **внутреннего порта</strong>.
          - Если вы выполняете развертывание на Windows 10 и Windows Server 2016, оставьте значение **Сохранение состояния сеанса** как **None** (Нет), или выберите **IP-адрес клиента**.
      6. Нажмите **ОК**, чтобы подтвердить правило UDP.
   5. Введите правило NAT для входящего трафика, чтобы создать прямое подключение к Contoso WebGw1
       1. Выберите **Правило NAT для входящего трафика** и нажмите **Добавить**.
       2. Введите **имя** (например, RDP-Contoso-WebGw1), выберите **Customm** для службы, **TCP** для протокола и введите 14000 для **порта**.
       3. Нажмите **Выбрать виртуальную машину** и выберите Contoso WebGw1.
       4. Выберите **Custom** (Настраиваемый) для сопоставления портов, введите 3389 для **Целевой порт**и нажмите **ОК**.
5. Введите внешний URL-адрес или DNS-имя для развертывания, чтобы получить к нему внешний доступ:  
   1.  На портале Azure щелкните **Обзор > Группы ресурсов**, выберите группу ресурсов для развертывания, а затем — общедоступный IP-адрес для веб-доступа к удаленным рабочим столам и шлюза удаленных рабочих столов.  
   2.  Нажмите **Конфигурация**, введите метку DNS-имени (например, contoso), а затем кнопку **Сохранить**. Эта метка имени DNS (contoso.westus.cloudapp.azure.com) является DNS-именем, которое будет использоваться для подключения к серверу веб-доступа к удаленным рабочим столам и шлюза удаленных рабочих столов.  

