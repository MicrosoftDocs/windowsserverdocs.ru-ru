---
title: Создание плана аварийного восстановления
description: Узнайте, как создать план аварийного восстановления для развертывания служб удаленных рабочих СТОЛОВ.
ms.custom: na
ms.prod: windows-server-threshold
ms.reviewer: na
ms.suite: na
ms.technology: remote-desktop-services
ms.author: elizapo
ms.date: 05/05/2017
ms.tgt_pltfrm: na
ms.topic: article
author: lizap
manager: dongill
ms.openlocfilehash: 8ad759a73e4a0ce1dc28f2b8e8d80f4365895430
ms.sourcegitcommit: 0d0b32c8986ba7db9536e0b8648d4ddf9b03e452
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2019
ms.locfileid: "59879505"
---
# <a name="create-your-disaster-recovery-plan-for-rds"></a>Создать план аварийного восстановления для служб удаленных рабочих СТОЛОВ

>Область применения. Windows Server (полугодовой канал), Windows Server 2016

Можно создать план аварийного восстановления в Azure Site Recovery для автоматизации процесса отработки отказа. Добавьте все виртуальные машины компонента служб удаленных рабочих СТОЛОВ в план восстановления.

Выполните следующие действия в Azure для создания плана восстановления:

1. Откройте хранилище Azure Site Recovery на портале Azure, а затем нажмите кнопку **планы восстановления**.
2. Нажмите кнопку **создать** и введите имя для плана.
3. Выберите ваш **источника** и **целевой**. Целью является вторичного сайта служб удаленных рабочих СТОЛОВ или в Azure.
4. Выберите виртуальные машины, на которых размещаются компоненты служб удаленных рабочих СТОЛОВ и нажмите кнопку **ОК**.

Дополнительные сведения о создании планов восстановления для различных типов развертывания служб удаленных рабочих СТОЛОВ в следующих разделах.

## <a name="sessions-based-rds-deployment"></a>Развертывание на основе сеансов служб удаленных рабочих СТОЛОВ

Для развертывания на основе сеансов служб удаленных рабочих СТОЛОВ сгруппируйте виртуальные машины, чтобы они отобразились в последовательности:

1. Группа отработки отказа 1 - сеанс виртуальной Машины узла
2. Группа отработки отказа 2 - виртуальной Машины Broker подключения
3. Группа отработки отказа 3 — виртуальных Машин Web Access

Ваш план будет выглядеть следующим образом: 

![План аварийного восстановления для развертывания на основе сеансов служб удаленных рабочих СТОЛОВ](media/rds-asr-session-drplan.png)

## <a name="pooled-desktops-rds-deployment"></a>Развертывания служб удаленных рабочих СТОЛОВ в составе пула рабочих столов

Для развертывания служб удаленных рабочих СТОЛОВ в составе пула рабочих столов Группировка виртуальных машин, чтобы они отобразились в последовательности, добавление ручного действия и скрипты.

1. Группа отработки отказа 1 - виртуальной Машины Broker подключения служб удаленных рабочих СТОЛОВ
2. Группе 1 выполняемое вручную действие - обновление DNS

   Запустите PowerShell с повышенными правами на виртуальной Машине Broker подключения. Выполните следующую команду и подождите несколько минут, чтобы убедиться, что служба DNS обновляется новым значением:

   ```
   ipconfig /registerdns
   ```
3. Сценарий 1 - групповой добавить узлы виртуализации

   Измените приведенный ниже сценарий, чтобы запустить для каждого узла виртуализации в облаке. Обычно после добавления узла виртуализации для посредника подключений, необходимо перезапустить узел. Убедитесь, что узел не имеет ожидается перезагрузка перед запуском сценария, иначе он завершится ошибкой.

   ```
   Broker - broker.contoso.com
   Virtualization host - VH1.contoso.com

   ipmo RemoteDesktop; 
   add-rdserver –ConnectionBroker broker.contoso.com –Role RDS-VIRTUALIZATION –Server VH1.contoso.com 
   ```
4. Группа отработки отказа 2 - шаблон виртуальной Машины
5. Группа 2 сценарий 1 - Включение off шаблона виртуальной Машины
   
   Шаблон виртуальной Машины при восстановлении на дополнительный сайт запустится, но его обработки командой Sysprep виртуальной Машины и не может начинаться полностью. Также служба удаленных рабочих СТОЛОВ требуется виртуальная машина закрытия, чтобы создать конфигурацию виртуальной Машины в составе пула из него. Таким образом нам нужно отключить эту функцию. Если у вас есть один сервер VMM, имя шаблона виртуальной Машины является одинаковым на первичной и вторичной реплике. Поэтому мы используем идентификатор виртуальной Машины в соответствии с *контекст* переменной в приведенном ниже сценарии. Если у вас есть несколько шаблонов, отключите их все.

   ```powershell
   ipmo virtualmachinemanager; 
   Foreach($vm in $VMsAsTemplate)
   {
      Get-SCVirtualMachine -ID $vm | Stop-SCVirtualMachine –Force
   } 
   ```
6. Группа 2 сценария 2 — удаление существующего пула виртуальных машин

   Необходимо удалить пула виртуальных машин на первичном сайте из посредника подключений, поэтому можно создать новые виртуальные машины на вторичном сайте. В этом случае необходимо указать точный узел, на котором для создания виртуальной Машины в составе пула. Обратите внимание на то, что это приведет к удалению виртуальных машин из только коллекции.

   ```powershell
   ipmo RemoteDesktop
   $desktops = Get-RDVirtualDesktop -CollectionName Win8Desktops; 
   Foreach($vm in $desktops){
      Remove-RDVirtualDesktopFromCollection -CollectionName Win8Desktops -VirtualDesktopName $vm.VirtualDesktopName –Force
   }
   ```
7. Группа 2 выполняемое вручную действие — назначить новый шаблон

   Необходимо назначить новый шаблон для посредника подключений для коллекции, чтобы вы могли создавать новые виртуальные машины в составе пула на сайте восстановления. Перейдите к посредник подключений служб удаленных рабочих СТОЛОВ и идентификации коллекции. Изменение свойств и укажите новый образ виртуальной Машины в качестве его шаблона.
8. Группа 2 сценарии 3 — повторно создать все пула виртуальных машин

   Повторное создание пула виртуальных машин на сайте восстановления через посредника подключений. В этом случае необходимо указать точный узел, на котором для создания виртуальной Машины в составе пула.

   Имя виртуальной Машины в составе пула должно быть уникальным, используя префикс и суффикс. Если имя виртуальной Машины уже существует, скрипт завершится ошибкой. Кроме того Если первичным виртуальных машин нумеруются от 1 до 5, нумерация site recovery продолжит работу с 6.

   ```powershell
   ipmo RemoteDesktop; 
   Add-RDVirtualDesktopToCollection -CollectionName Win8Desktops -VirtualDesktopAllocation @{"RDVH1.contoso.com" = 1} 
   ```
9. Группа отработки отказа 3 - веб-доступа и сервер шлюза виртуальной Машины

План восстановления будет выглядеть следующим образом:

![План аварийного восстановления для развертывания служб удаленных рабочих СТОЛОВ в составе пула рабочих столов](media/rds-asr-pooled-drplan.png)

## <a name="personal-desktops-rds-deployment"></a>Развертывание служб удаленных рабочих СТОЛОВ личных рабочих столов

Для развертывания служб удаленных рабочих СТОЛОВ с помощью личных рабочих столов Группировка виртуальных машин, чтобы они отобразились в последовательности, добавление ручного действия и скрипты.

1. Группа отработки отказа 1 - виртуальной Машины Broker подключения служб удаленных рабочих СТОЛОВ
2. Группе 1 выполняемое вручную действие - обновление DNS

   Запустите PowerShell с повышенными правами на виртуальной Машине Broker подключения. Выполните следующую команду и подождите несколько минут, чтобы убедиться, что служба DNS обновляется новым значением:

   ```
   ipconfig /registerdns
   ```
3. Сценарий 1 - групповой добавить узлы виртуализации
      
   Измените приведенный ниже сценарий, чтобы запустить для каждого узла виртуализации в облаке. Обычно после добавления узла виртуализации для посредника подключений, необходимо перезапустить узел. Убедитесь, что узел не имеет ожидается перезагрузка перед запуском сценария, иначе он завершится ошибкой.

   ```powershell
   Broker - broker.contoso.com
   Virtualization host - VH1.contoso.com

   ipmo RemoteDesktop; 
   add-rdserver –ConnectionBroker broker.contoso.com –Role RDS-VIRTUALIZATION –Server VH1.contoso.com 
   ```
4. Группа отработки отказа 2 - шаблон виртуальной Машины
5. Группа 2 сценарий 1 - Включение off шаблона виртуальной Машины
   
   Шаблон виртуальной Машины при восстановлении на дополнительный сайт запустится, но его обработки командой Sysprep виртуальной Машины и не может начинаться полностью. Также служба удаленных рабочих СТОЛОВ требуется виртуальная машина закрытия, чтобы создать конфигурацию виртуальной Машины в составе пула из него. Таким образом нам нужно отключить эту функцию. Если у вас есть один сервер VMM, имя шаблона виртуальной Машины является одинаковым на первичной и вторичной реплике. Поэтому мы используем идентификатор виртуальной Машины в соответствии с *контекст* переменной в приведенном ниже сценарии. Если у вас есть несколько шаблонов, отключите их все.

   ```powershell
   ipmo virtualmachinemanager; 
   Foreach($vm in $VMsAsTemplate)
   {
      Get-SCVirtualMachine -ID $vm | Stop-SCVirtualMachine –Force
   } 
   ```
6. Группа отработки отказа 3 — личные виртуальные машины
7. Сценарий 3 1 групповой - удалить существующие личные виртуальные машины и добавить их

   Удалите персональные виртуальные машины на первичном сайте из посредника подключений, поэтому новые виртуальные машины могут создаваться на вторичном сайте. Необходимо извлечь назначений виртуальных машин и повторно добавить виртуальные машины посредника подключений с хэшем назначений. Это только удалить персональные виртуальные машины из коллекции и повторно добавить их. Личные распределения рабочих столов будет экспортировать и импортировать обратно в коллекцию.

   ```powershell
   ipmo RemoteDesktop
   $desktops = Get-RDVirtualDesktop -CollectionName CEODesktops; 
   Export-RDPersonalVirtualDesktopAssignment -CollectionName CEODesktops -Path ./Desktopallocations.txt -ConnectionBroker broker.contoso.com 

   Foreach($vm in $desktops){
     Remove-RDVirtualDesktopFromCollection -CollectionName CEODesktops -VirtualDesktopName $vm.VirtualDesktopName –Force
   }
   
   Import-RDPersonalVirtualDesktopAssignment -CollectionName CEODesktops -Path ./Desktopallocations.txt -ConnectionBroker broker.contoso.com 
   ```
8. Группа отработки отказа 3 - веб-доступа и сервер шлюза виртуальной Машины

Ваш план будет выглядеть следующим образом: 

![План аварийного восстановления для развертывания служб удаленных рабочих СТОЛОВ личных рабочих столов](media/rds-asr-personal-desktops-drplan.png)
