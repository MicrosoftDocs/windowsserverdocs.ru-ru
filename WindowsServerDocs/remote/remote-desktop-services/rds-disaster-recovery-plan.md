---
title: Создание плана аварийного восстановления
description: Узнайте, как создать план аварийного восстановления для развертывания служб удаленных рабочих столов.
ms.custom: na
ms.prod: windows-server
ms.reviewer: na
ms.suite: na
ms.technology: remote-desktop-services
ms.author: elizapo
ms.date: 05/05/2017
ms.tgt_pltfrm: na
ms.topic: article
author: lizap
manager: dongill
ms.openlocfilehash: e4e9a9ab05e672c72925e3699900218abdf1c682
ms.sourcegitcommit: 6aff3d88ff22ea141a6ea6572a5ad8dd6321f199
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/27/2019
ms.locfileid: "71404028"
---
# <a name="create-your-disaster-recovery-plan-for-rds"></a>Создание плана аварийного восстановления для служб удаленных рабочих столов

>Относится к: Windows Server (Semi-Annual Channel), Windows Server 2019, Windows Server 2016

Вы можете создать план аварийного восстановления в Azure Site Recovery для автоматизации процесса отработки отказа. Добавьте все виртуальные машины компонента служб удаленных рабочих столов в план восстановления.

Выполните следующие действия в Azure для создания плана восстановления.

1. Откройте хранилище Azure Site Recovery на портале Azure, а затем нажмите кнопку **Планы восстановления**.
2. Нажмите кнопку **Создать** и введите имя плана.
3. Выберите ваш **Источник** и **Цель**. Целью может быть вторичный сайт служб удаленных рабочих столов или Azure.
4. Выберите виртуальные машины, на которых размещаются компоненты служб удаленных рабочих столов, и нажмите кнопку **ОК**.

Дополнительные сведения о создании планов восстановления для различных типов развертывания служб удаленных рабочих столов см. в следующих разделах.

## <a name="sessions-based-rds-deployment"></a>Развертывание служб удаленных рабочих столов на основе сеансов

Для развертывания служб удаленных рабочих столов на основе сеансов сгруппируйте виртуальные машины, чтобы они отобразились в следующей последовательности:

1. Группа отработки отказа 1 — виртуальная машина узла сеансов;
2. Группа отработки отказа 2 — виртуальная машина посредника подключений;
3. Группа отработки отказа 3 — виртуальная машина веб-доступа.

Ваш план будет выглядеть следующим образом. 

![План аварийного восстановления для развертывания служб удаленных рабочих столов на основе сеансов](media/rds-asr-session-drplan.png)

## <a name="pooled-desktops-rds-deployment"></a>Развертывание служб удаленных рабочих столов с пулами рабочих столов

Для развертывания служб удаленных рабочих столов с пулами рабочих столов сгруппируйте виртуальные машины, чтобы они стояли в последовательности, добавив ручные действия и скрипты.

1. Группа отработки отказа 1 — виртуальная машина посредника подключений к удаленным рабочим столам
2. Группа 1, выполняемое вручную действие — обновление DNS

   Запустите PowerShell с повышенными правами на виртуальной машине посредника подключений. Выполните следующую команду и подождите несколько минут, чтобы убедиться, что в службе DNS появилось новое значение:

   ```
   ipconfig /registerdns
   ```
3. Группа 1, скрипт — добавление узлов виртуализации

   Измените приведенный ниже скрипт, чтобы запустить его для каждого узла виртуализации в облаке. Обычно после добавления узла виртуализации в посредник подключений необходимо перезапустить узел. Убедитесь, что узел не ожидает перезагрузки, перед запуском скрипта, иначе он завершится ошибкой.

   ```
   Broker - broker.contoso.com
   Virtualization host - VH1.contoso.com

   ipmo RemoteDesktop; 
   add-rdserver –ConnectionBroker broker.contoso.com –Role RDS-VIRTUALIZATION –Server VH1.contoso.com 
   ```
4. Группа отработки отказа 2 — шаблон виртуальной машины
5. Группа 2, скрипт 1 — отключение шаблона виртуальной машины
   
   Шаблон виртуальной машины при восстановлении на вторичном сайте запустится, но это виртуальная машина, подготовленная с помощью sysprep, которая не может запуститься полностью. Также службе удаленных рабочих столов требуется, чтобы виртуальная машина завершила работу, чтобы создать на ее основе конфигурацию виртуальной машины в составе пула. Таким образом, нам нужно отключить ее. Если у вас есть один сервер VMM, имя шаблона виртуальной машины будет одинаковым на первичной и вторичной реплике. Поэтому мы используем идентификатор виртуальной машины в соответствии с переменной *Context* в приведенном ниже скрипте. Если у вас есть несколько шаблонов, отключите их все.

   ```powershell
   ipmo virtualmachinemanager; 
   Foreach($vm in $VMsAsTemplate)
   {
      Get-SCVirtualMachine -ID $vm | Stop-SCVirtualMachine –Force
   } 
   ```
6. Группа 2, скрипт 2 — удаление существующего пула виртуальных машин

   Необходимо удалить пул виртуальных машин на первичном сайте из посредника подключений, чтобы можно было создать новые виртуальные машины на вторичном сайте. В этом случае необходимо указать точный узел, на котором создаются виртуальные машины в составе пула. Обратите внимание, что это приведет к удалению виртуальных машин только из коллекции.

   ```powershell
   ipmo RemoteDesktop
   $desktops = Get-RDVirtualDesktop -CollectionName Win8Desktops; 
   Foreach($vm in $desktops){
      Remove-RDVirtualDesktopFromCollection -CollectionName Win8Desktops -VirtualDesktopName $vm.VirtualDesktopName –Force
   }
   ```
7. Группа 2, выполняемое вручную действие — назначение нового шаблона

   Необходимо назначить новый шаблон для коллекции в посреднике подключений, чтобы вы могли создавать новые виртуальные машины в составе пула на сайте восстановления. Перейдите в посредник подключений к удаленному рабочему столу и найдите коллекцию. Измените ее свойства и укажите новый образ виртуальной машины в качестве шаблона.
8. Группа 2, скрипт 3 — повторное создание всех виртуальных машин в пуле

   Повторите создание пула виртуальных машин на сайте восстановления через посредник подключений. В этом случае необходимо указать точный узел, на котором создаются виртуальные машины в составе пула.

   Имя виртуальной машины в составе пула должно быть уникальным; учитывается префикс и суффикс. Если имя виртуальной машины уже существует, скрипт завершится ошибкой. Кроме того, если первичные виртуальные машины нумеруются от 1 до 5, нумерация на сайте восстановления продолжит работу с номера 6.

   ```powershell
   ipmo RemoteDesktop; 
   Add-RDVirtualDesktopToCollection -CollectionName Win8Desktops -VirtualDesktopAllocation @{"RDVH1.contoso.com" = 1} 
   ```
9. Группа отработки отказа 3 — виртуальные машины веб-доступа и сервера шлюза

План восстановления будет выглядеть следующим образом:

![План аварийного восстановления для развертывания служб удаленных рабочих столов с пулами рабочих столов](media/rds-asr-pooled-drplan.png)

## <a name="personal-desktops-rds-deployment"></a>Развертывание служб удаленных рабочих столов с личными рабочими столами

Для развертывания служб удаленных рабочих столов с личными рабочими столами сгруппируйте виртуальные машины, чтобы они стояли в последовательности, добавив ручные действия и скрипты.

1. Группа отработки отказа 1 — виртуальная машина посредника подключений к удаленным рабочим столам
2. Группа 1, выполняемое вручную действие — обновление DNS

   Запустите PowerShell с повышенными правами на виртуальной машине посредника подключений. Выполните следующую команду и подождите несколько минут, чтобы убедиться, что в службе DNS появилось новое значение:

   ```
   ipconfig /registerdns
   ```
3. Группа 1, скрипт — добавление узлов виртуализации
      
   Измените приведенный ниже скрипт, чтобы запустить его для каждого узла виртуализации в облаке. Обычно после добавления узла виртуализации в посредник подключений необходимо перезапустить узел. Убедитесь, что узел не ожидает перезагрузки, перед запуском скрипта, иначе он завершится ошибкой.

   ```powershell
   Broker - broker.contoso.com
   Virtualization host - VH1.contoso.com

   ipmo RemoteDesktop; 
   add-rdserver –ConnectionBroker broker.contoso.com –Role RDS-VIRTUALIZATION –Server VH1.contoso.com 
   ```
4. Группа отработки отказа 2 — шаблон виртуальной машины
5. Группа 2, скрипт 1 — отключение шаблона виртуальной машины
   
   Шаблон виртуальной машины при восстановлении на вторичном сайте запустится, но это виртуальная машина, подготовленная с помощью sysprep, которая не может запуститься полностью. Также службе удаленных рабочих столов требуется, чтобы виртуальная машина завершила работу, чтобы создать на ее основе конфигурацию виртуальной машины в составе пула. Таким образом, нам нужно отключить ее. Если у вас есть один сервер VMM, имя шаблона виртуальной машины будет одинаковым на первичной и вторичной реплике. Поэтому мы используем идентификатор виртуальной машины в соответствии с переменной *Context* в приведенном ниже скрипте. Если у вас есть несколько шаблонов, отключите их все.

   ```powershell
   ipmo virtualmachinemanager; 
   Foreach($vm in $VMsAsTemplate)
   {
      Get-SCVirtualMachine -ID $vm | Stop-SCVirtualMachine –Force
   } 
   ```
6. Группа отработки отказа 3 — личные виртуальные машины
7. Группа 3, скрипт 1 — удалить существующие личные виртуальные машины и добавить их

   Следует удалить личные виртуальные машины на первичном сайте из посредника подключений, чтобы можно было создать новые виртуальные машины на вторичном сайте. Необходимо извлечь назначения виртуальных машин и повторно добавить виртуальные машины в посреднике подключений, указывая хэши назначений. Это лишь удалит персональные виртуальные машины из коллекции и повторно добавит их. Личное распределение рабочих столов будет экспортировано и импортировано обратно в коллекцию.

   ```powershell
   ipmo RemoteDesktop
   $desktops = Get-RDVirtualDesktop -CollectionName CEODesktops; 
   Export-RDPersonalVirtualDesktopAssignment -CollectionName CEODesktops -Path ./Desktopallocations.txt -ConnectionBroker broker.contoso.com 

   Foreach($vm in $desktops){
     Remove-RDVirtualDesktopFromCollection -CollectionName CEODesktops -VirtualDesktopName $vm.VirtualDesktopName –Force
   }
   
   Import-RDPersonalVirtualDesktopAssignment -CollectionName CEODesktops -Path ./Desktopallocations.txt -ConnectionBroker broker.contoso.com 
   ```
8. Группа отработки отказа 3 — виртуальные машины веб-доступа и сервера шлюза

Ваш план будет выглядеть следующим образом. 

![План аварийного восстановления для развертывания служб удаленных рабочих столов с личными рабочими столами](media/rds-asr-personal-desktops-drplan.png)
