---
title: Репликация хранилища "сервер-сервер"
description: Как настроить и использовать реплику хранилища для репликации "сервер-сервер" в Windows Server, включая Windows Admin Center и PowerShell.
ms.prod: windows-server-threshold
manager: siroy
ms.author: nedpyle
ms.technology: storage-replica
ms.topic: get-started-article
author: nedpyle
ms.date: 04/26/2019
ms.assetid: 61881b52-ee6a-4c8e-85d3-702ab8a2bd8c
ms.openlocfilehash: fccdb8547ff27083ce943892842c2e2d05e5ace8
ms.sourcegitcommit: f6490192d686f0a1e0c2ebe471f98e30105c0844
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/10/2019
ms.locfileid: "70865286"
---
# <a name="server-to-server-storage-replication-with-storage-replica"></a>Репликация хранилища "сервер-сервер" с репликой хранилища

> Относится к: Windows Server 2019, Windows Server 2016, Windows Server (Semi-Annual Channel)

С помощью реплики хранилища можно настроить два сервера для синхронизации данных таким образом, чтобы каждый из них имел идентичную копию одного тома. Этот раздел содержит некоторые базовые сведения о такой конфигурации межсерверной репликации, а также инструкции по настройке такой среды и управлению ею.

Для управления репликой хранилища можно использовать [центр администрирования Windows](../../manage/windows-admin-center/overview.md) или PowerShell.

Ниже приведен обзор использования реплики хранилища в центре администрирования Windows.
> [!video https://www.microsoft.com/videoplayer/embed/3aa09fd4-867b-45e9-953e-064008468c4b?autoplay=false]


## <a name="prerequisites"></a>Предварительные требования  

* Лес служб домен Active Directory (не требуется запускать Windows Server 2016).  
* Два сервера под Windows Server 2019 или Windows Server 2016, Datacenter Edition. Если вы используете Windows Server 2019, вы можете использовать выпуск Standard Edition, если вы нормально реплицируете только один том размером до 2 ТБ.  
* Два набора хранилищ со следующими компонентами: SAS JBOD, SAN на основе протокола Fibre Channel, цели iSCSI и (или) локальные хранилища SCSI или SATA. Хранилище должно включать как жесткие диски, так и твердотельные накопители. Каждой набор хранилищ должен быть доступен только для одного из этих серверов (без возможности общего доступа).  
* Каждый набор хранилищ должен допускать создание по меньшей мере двух виртуальных дисков: один для реплицируемых данных и один для журналов. На всех дисках данных в физическом хранилище необходимо использовать одинаковый размер секторов. На всех дисках с журналами в физическом хранилище необходимо использовать одинаковый размер секторов.  
* На каждом сервере должно быть создано по меньшей мере одно подключение Ethernet/TCP для синхронной репликации, но желательно использовать RDMA.   
* Правила всех задействованных брандмауэров и маршрутизаторов должны разрешать двунаправленный трафик ICMP, SMB (порт 445, а также 5445 для SMB Direct) и WS-MAN (порт 5985) между всеми узлами.  
* Сеть между серверами должна иметь достаточную пропускную способность для ваших рабочих нагрузок ввода-вывода, а средняя задержка приема-передачи должна составлять 5 мс для синхронной репликации. Для асинхронной репликации не предусмотрена рекомендация по задержке.<br>
Если выполняется репликация между локальными серверами и виртуальными машинами Azure, необходимо создать сетевую связь между локальными серверами и виртуальными машинами Azure. Для этого воспользуйтесь [Express Route](#add-azure-vm-expressroute), [подключением VPN-шлюза типа "сеть — сеть](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-howto-site-to-site-resource-manager-portal)" или установите программное обеспечение VPN на виртуальных машинах Azure, чтобы подключить их к локальной сети.
* Реплицируемое хранилище не может находиться на диске с папкой операционной системы Windows.

> [!IMPORTANT]
>  В этом сценарии каждый сервер должен находиться на отдельном физическом или логическом узле. Для серверов нужно настроить обмен данными через сеть.  


Многие из этих требований можно определить с помощью командлета `Test-SRTopology cmdlet`. Это средство будет доступно, если установить реплику хранилища или средства управления репликой хранилища хотя бы на один сервер. Настраивать реплику хранилища не нужно. Для использования инструмента достаточно только установить командлет. Дополнительная информация приведена ниже.  

## <a name="windows-admin-center-requirements"></a>Требования центра администрирования Windows

Для совместного использования реплики хранилища и центра администрирования Windows вам потребуется следующее:

| Система                        | Операционная система                                            | Требуется для     |
|-------------------------------|-------------------------------------------------------------|------------------|
| Два сервера <br>(любое сочетание локального оборудования, виртуальных машин и облачных виртуальных машин, включая виртуальные машины Azure);| Windows Server 2019, Windows Server 2016 или Windows Server (половина ежегодного канала) | Реплика хранилища  |
| Один компьютер                     | Windows 10                                                  | Windows Admin Center |

> [!NOTE]
> Сейчас вы не можете использовать центр администрирования Windows на сервере для управления репликой хранилища.

## <a name="terms"></a>Термины  
В этом руководстве в качестве примера используется следующая среда:  

-   Два сервера с именами **SR-SRV05** и **SR SRV06**.  

-   пара логических "сайтов", представляющих два разных центра обработки данных, один из которых называется **Redmond**, а второй **Bellevue**.  

![Схема, показывающая репликацию сервера в строении 5 с сервером в строении 9](media/Server-to-Server-Storage-Replication/Storage_SR_ServertoServer.png)  

**Рис. 1. Репликация сервера на сервер**  

## <a name="step-1-install-and-configure-windows-admin-center-on-your-pc"></a>Шаг 1. Установка и настройка центра администрирования Windows на компьютере

Если вы используете центр администрирования Windows для управления репликой хранилища, выполните следующие действия, чтобы подготовить компьютер к управлению репликой хранилища.
1. Скачайте и установите [центр администрирования Windows](../../manage/windows-admin-center/overview.md).
2. Скачайте и установите [средства удаленного администрирования сервера](https://www.microsoft.com/download/details.aspx?id=45520).
    - Если вы используете Windows 10 версии 1809 или более поздней, установите "RSAT: Модуль реплики хранилища для Windows PowerShell "компоненты по запросу".
3. Откройте сеанс PowerShell от имени администратора, нажав кнопку " **Пуск** ", введя команду **PowerShell**, щелкните правой кнопкой мыши **Windows PowerShell** и выберите команду **Запуск от имени администратора**.
4. Введите следующую команду, чтобы включить протокол WS-Management на локальном компьютере и настроить конфигурацию по умолчанию для удаленного управления на клиенте.

    ```PowerShell
    winrm quickconfig
    ```

5. Введите **Y** , чтобы включить службы WinRM и включить исключение брандмауэра WinRM.

## <a name="provision-os"></a>Шаг 2. Подготовка операционной системы, функций, ролей, хранилища и сети

1.  Установите Windows Server на обоих узлах сервера с типом установки Windows Server **(возможности рабочего стола)** . 
 
    Сведения об использовании виртуальной машины Azure, подключенной к сети через ExpressRoute, см. в статье [Добавление виртуальной машины Azure, подключенной к сети через expressroute](#add-azure-vm-expressroute).

3.  Добавьте сведения о сети, присоедините серверы к тому же домену, что и компьютер управления Windows 10 (если вы используете его), а затем перезапустите серверы.  

    > [!NOTE]
    > С этого момента вход в систему всегда нужно выполнять от имени пользователя домена, входящего в группу встроенной учетной записи администратора на всех серверах. Не забывайте повысить полномочия командных строк PowerShell и CMD, запуская их через графический интерфейс на компьютере с ОС Windows 10.  

3.  Подключите первый набор дискового корпуса JBOD, целевого объекта iSCSI, сети SAN FC или локального дискового накопителя (DAS) к серверу в составе сайта **Redmond**.  

4.  Подключите второй набор данных к серверу на сайте **Бельвью**.  

5.  По возможности установите на обоих узлах все последние версии встроенного ПО и драйверов, предоставляемых поставщиками для полок дисков и хранилищ, HBA, BIOS или UEFI, а также для сетевых адаптеров и набора микросхем материнской платы. Перезапустите узлы при необходимости.  

    > [!NOTE]
    > Для настройки общих хранилищ и сетевого оборудования обратитесь к документации поставщика оборудования.  

6.  Убедитесь, что для параметров BIOS или UEFI настроена высокая производительность, например отключено C-состояние, установлена скорость QPI, включена архитектура NUMA и установлена максимально возможная частота памяти. Убедитесь, что для параметра Управление питанием в Windows Server установлено значение Высокая производительность. При необходимости перезагрузите компьютер.  

7.  Настройте роли следующим образом.  

    -   **Метод центра администрирования Windows**
        1. В центре администрирования Windows перейдите к диспетчер сервера, а затем выберите один из серверов.
        2. Перейдите к **роли & компоненты**.
        3. Выберите **компоненты** > **Реплика хранилища**и нажмите кнопку **установить**.
        4. Повторите на другом сервере.
    -   **Метод диспетчер сервера**  

        1.  Запустите **ServerManager.exe** и создайте группу серверов, добавив в нее все узлы серверов.  

        2.  Установите роли и компоненты **файлового сервера** и **реплики хранилища** на всех узлах и перезапустите их.  

    -   **Метод Windows PowerShell**  

        На компьютере SR-SRV06 или на компьютере удаленного управления выполните следующую команду в консоли Windows PowerShell. Она установит все необходимые компоненты и роли и перезапустит их.  

        ```powershell  
        $Servers = 'SR-SRV05','SR-SRV06'  

        $Servers | ForEach { Install-WindowsFeature -ComputerName $_ -Name Storage-Replica,FS-FileServer -IncludeManagementTools -restart }  
        ```  

        Дополнительные сведения об этих действиях см. в статье [Установка и удаление ролей, служб ролей и компонентов](../../administration/server-manager/install-or-uninstall-roles-role-services-or-features.md).  

8.  Настройте хранилище следующим образом:  

    > [!IMPORTANT]  
    > -   Необходимо создать два тома на каждой полке: один для данных и один для журналов.  
    > -   Диски журналов и данных следует инициализировать как GPT, а не MBR.  
    > -   Два тома данных должны иметь одинаковый размер.  
    > -   Два тома журналов должны иметь одинаковый размер.  
    > -   Все реплицируемые диски данных должны иметь одинаковый размер сектора.  
    > -   Все диски журналов должны иметь одинаковый размер сектора.  
    > -   Тома журнала следует располагать на твердотельных накопителях. Майкрософт рекомендует, чтобы хранилище журналов работало так же быстро или быстрее, чем хранилище данных. Томы журнала никогда не должны использоваться для других задач.
    > -   В качестве дисков данных можно использовать жесткие диски, твердотельные накопители или их многоуровневое сочетание. Диски можно организовать как зеркальные массивы, массивы с контролем четности, RAID1 или 10, RAID5 или RAID50.  
    > -   Том журнала должен иметь размер по умолчанию не менее 9 ГБ, но может отличаться как в большую, так и в меньшую сторону в зависимости от требований к ведению журнала.  
    > -   Роль файлового сервера необходима только для работы Test-SRTopology, так как она открывает порты брандмауэра, необходимые для тестирования.
    
    - **Для корпусов JBOD:**  

        1.  Убедитесь, что каждый сервер может видеть только полки дисков своего расположения, и что подключения SAS правильно сконфигурированы.  

        2.  Подготовьте хранилище с помощью дисковых пространств, выполнив **шаги 1–3** из статьи [Развертывание дисковых пространств на автономном сервере](../storage-spaces/deploy-standalone-storage-spaces.md) с помощью Windows PowerShell или диспетчера сервера.  

    - **Для хранилища iSCSI:**  

        1.  Убедитесь, что каждый кластер может видеть только полки дисков своего расположения. При работе с iSCSI следует использовать несколько сетевых адаптеров.    

        2.  Подготовьте хранилище в соответствии с документацией поставщика. При использовании целей iSCSI для Windows изучите статью [Блочное хранилище конечного сервера iSCSI, краткое руководство](../iscsi/iscsi-target-server.md).  

    - **Для хранилища SAN FC:**  

        1.  Убедитесь, что каждый кластер можно видеть только полки дисков своего расположения, и что правильно выбраны зоны узлов.   

        2.  Подготовьте хранилище в соответствии с документацией поставщика.  

    - **Для локального фиксированного дискового накопителя:**  

        -   Убедитесь, что хранилище не содержит системный том, файл подкачки или файлы дампа.  

        -   Подготовьте хранилище в соответствии с документацией поставщика.  

9. Запустите Windows PowerShell и используйте командлет **Test-SRTopology**, чтобы определить, все ли требования для реплики хранилища выполнены. Этот командлет можно запустить в режиме быстрой проверки требований или в режиме длительной оценки производительности.  

    Например, следующая команда проверит предложенное узлы на наличие томов **F:** и **G:** , а также запустит тест длительностью 30 минут:  
        
    ```PowerShell
    MD c:\temp  

    Test-SRTopology -SourceComputerName SR-SRV05 -SourceVolumeName f: -SourceLogVolumeName g: -DestinationComputerName SR-SRV06 -DestinationVolumeName f: -DestinationLogVolumeName g: -DurationInMinutes 30 -ResultPath c:\temp  
    ```

    > [!IMPORTANT]
      > Если вы используете тестовый сервер, на котором во время проверки не выполняются операции ввода-вывода для выбранного тома источника, попробуйте добавить рабочую нагрузку, иначе отчет не будет содержать полезные сведения. Чтобы получить фактические результаты и рекомендованные размеры журнала, тестовая нагрузка должна соответствовать ожидаемой рабочей нагрузке. В качестве альтернативы во время теста можно просто копировать некоторые файлы на том источника, а также скачать и запустить средство [DISKSPD](https://gallery.technet.microsoft.com/DiskSpd-a-robust-storage-6cd2f223) для создания операций ввода-вывода на запись. Этот пример команды создает низкую рабочую нагрузку операций записи на дискD: в течение десяти минут:  
      >
      > `Diskspd.exe -c1g -d600 -W5 -C5 -b8k -t2 -o2 -r -w5 -i100 -j100 d:\test` 

10. Изучите отчет **тестсртопологирепорт. HTML** , показанный на рис. 2, чтобы обеспечить соответствие требованиям реплики хранилища.  

    ![Экран с отчетом о топологии](media/Server-to-Server-Storage-Replication/SRTestSRTopologyReport.png)

    **Рис. 2. Отчет о топологии репликации хранилища**

## <a name="step-3-set-up-server-to-server-replication"></a>Шаг 3. Настройка репликации "сервер-сервер"
### <a name="using-windows-admin-center"></a>Использование центра администрирования Windows

1. Добавьте исходный сервер.
    1. Нажмите кнопку **Добавить** .
    2. Выберите **Добавить соединение с сервером**.
    3. Введите имя сервера и нажмите кнопку **Отправить**.
2. На странице **все подключения** выберите исходный сервер.
3. Выберите **Реплика хранилища** на панели "Инструменты".
4. Выберите **создать, чтобы** создать новое партнерство.
5. Укажите сведения о партнерстве и нажмите кнопку **создать**. <br>
   ![Новый экран партнерства, отображающий сведения о партнерстве, например размер журнала размером 8 ГБ.](media/Storage-Replica-UI/Honolulu_SR_Create_Partnership.png)

    **Рис. 3. Создание новой связи**

> [!NOTE]
> Удаление партнерства из реплики хранилища в центре администрирования Windows не приводит к удалению имени группы репликации.

### <a name="using-windows-powershell"></a>Использование Windows PowerShell

Теперь мы перейдем к настройке межсерверной репликации с помощью Windows PowerShell. Необходимо выполнить все приведенные ниже действия на узлах непосредственно или с удаленного компьютера управления, который содержит средства удаленного администрирования сервера Windows Server.  

1. Не забывайте, что консоль Powershell должна иметь повышенные привилегии администратора.  
2. Настройте межсерверную репликацию, указав исходный и конечный диски, журналы источника и назначения, узлы источника и назначения, а также размер журнала.  

    ```PowerShell  
    New-SRPartnership -SourceComputerName sr-srv05 -SourceRGName rg01 -SourceVolumeName f: -SourceLogVolumeName g: -DestinationComputerName sr-srv06 -DestinationRGName rg02 -DestinationVolumeName f: -DestinationLogVolumeName g:  
    ```  

   Вывод:
   ```PowerShell
   DestinationComputerName : SR-SRV06
   DestinationRGName       : rg02
   SourceComputerName      : SR-SRV05
   PSComputerName          :
   ```

    > [!IMPORTANT]
    > По умолчанию размер журнала составляет 8ГБ. В зависимости от вывода командлета `Test-SRTopology` иногда целесообразно использовать журнал большего или меньшего размера (параметр -LogSizeInBytes).  

2.  Чтобы узнать состояние источника и назначения репликации, используйте `Get-SRGroup` и `Get-SRPartnership`:  

    ```PowerShell  
    Get-SRGroup  
    Get-SRPartnership  
    (Get-SRGroup).replicas  
    ```
    Вывод:

    ```PowerShell
    CurrentLsn             : 0
    DataVolume             : F:\
    LastInSyncTime         :
    LastKnownPrimaryLsn    : 1
    LastOutOfSyncTime      :
    NumOfBytesRecovered    : 37731958784
    NumOfBytesRemaining    : 30851203072
    PartitionId            : c3999f10-dbc9-4a8e-8f9c-dd2ee6ef3e9f
    PartitionSize          : 68583161856
    ReplicationMode        : synchronous
    ReplicationStatus      : InitialBlockCopy
    PSComputerName         :
    ```

3.  Выполнение репликации можно отслеживать так:  

    1.  На исходном сервере введите следующую команду и изучите события 5015, 5002, 5004, 1237, 5001 и 2200.  

        ```PowerShell  
        Get-WinEvent -ProviderName Microsoft-Windows-StorageReplica -max 20  
        ```  

    2.  На конечном сервере выполните следующую команду для просмотра событий реплики хранилища, которые показывают создание партнерства. Это событие сообщает количество скопированных байтов и время выполнения. Пример.  

        ```PowerShell  
        Get-WinEvent -ProviderName Microsoft-Windows-StorageReplica | Where-Object {$_.ID -eq "1215"} | fl  
        ```
        Вот пример выходных данных:
        ```
        TimeCreated  : 4/8/2016 4:12:37 PM  
        ProviderName : Microsoft-Windows-StorageReplica  
        Id           : 1215  
        Message      : Block copy completed for replica.  

        ReplicationGroupName: rg02  
        ReplicationGroupId: {616F1E00-5A68-4447-830F-B0B0EFBD359C}  
        ReplicaName: f:\  
        ReplicaId: {00000000-0000-0000-0000-000000000000}  
        End LSN in bitmap:   
        LogGeneration: {00000000-0000-0000-0000-000000000000}  
        LogFileId: 0  
        CLSFLsn: 0xFFFFFFFF  
        Number of Bytes Recovered: 68583161856  
        Elapsed Time (ms): 117  
        ```  

        > [!NOTE]
        > Реплика хранилища отключает конечные тома и их буквы диска или точки подключения. Это сделано намеренно.  

    3.  Кроме того, целевая группа серверов для реплики постоянно сообщает о числе оставшихся байтов для копирования, и эти сведения можно запрашивать через PowerShell. Пример:  

        ```PowerShell  
        (Get-SRGroup).Replicas | Select-Object numofbytesremaining  
        ```  

        Пример контроля выполнения (не завершается самостоятельно):  

        ```PowerShell  
        while($true) {  

         $v = (Get-SRGroup -Name "RG02").replicas | Select-Object numofbytesremaining  
         [System.Console]::Write("Number of bytes remaining: {0}`r", $v.numofbytesremaining)  
         Start-Sleep -s 5  
        }  
        ```  

    4.  На конечном сервере выполните следующую команду и проверьте события 5009, 1237, 5001, 5015, 5005 и 2200 для отслеживания хода обработки события. В этой последовательности не должно быть предупреждений или ошибок. Будет много событий 1237, которые указывают ход выполнения.  

        ```PowerShell  
        Get-WinEvent -ProviderName Microsoft-Windows-StorageReplica | FL  
        ```  

## <a name="step-4-manage-replication"></a>Шаг 4. Управление репликацией

Теперь можно приступить к управлению инфраструктурой межсерверной репликации и ее использованию. Вы можете выполнить все приведенные ниже действия на узлах непосредственно или с удаленного компьютера управления, который содержит средства удаленного администрирования сервера Windows Server.  

1.  Используйте `Get-SRPartnership` и `Get-SRGroup`, чтобы узнать источник и назначение репликации и их текущее состояние.  

2.  Для измерения производительности репликации выполните командлет `Get-Counter` на исходном и конечном узлах. Ниже перечислены имена счетчиков.  

    -   \Статистика ввода-вывода раздела реплики хранилища(*)\Количество раз приостановки записи на диск  

    -   \Статистика ввода-вывода раздела реплики хранилища(*)\Количество вводов-выводов записи на диск в ожидании  

    -   \Статистика ввода-вывода раздела реплики хранилища(*)\Количество запросов для последней записи в журнал  

    -   \Статистика ввода-вывода раздела реплики хранилища(*)\Среднее Длина очереди записи на диск  

    -   \Статистика ввода-вывода раздела реплики хранилища(*)\Текущая длина очереди записи на диск  

    -   \Статистика ввода-вывода раздела реплики хранилища(*)\Количество запросов записи приложения  

    -   \Статистика ввода-вывода раздела реплики хранилища(*)\Среднее Число запросов на операцию записи в журнал  

    -   \Статистика ввода-вывода раздела реплики хранилища(*)\Среднее Задержка записи приложения  

    -   \Статистика ввода-вывода раздела реплики хранилища(*)\Среднее Задержка чтения приложения  

    -   \Статистика реплики хранилища(*)\Целевая RPO  

    -   \Статистика реплики хранилища(*)\Текущая RPO  

    -   \Статистика реплики хранилища(*)\Среднее Длина очереди журнала  

    -   \Статистика реплики хранилища(*)\Длина очереди текущего журнала  

    -   \Статистика реплики хранилища(*)\Всего байт получено  

    -   \Статистика реплики хранилища(*)\Всего байт отправлено  

    -   \Статистика реплики хранилища(*)\Среднее Время задержки исходящих данных в сети  

    -   \Статистика реплики хранилища(*)\Состояние репликации  

    -   \Статистика реплики хранилища(*)\Среднее Задержка приема-передачи сообщения  

    -   \Статистика реплики хранилища(*)\Время, затраченное на последнее восстановление  

    -   \Статистика реплики хранилища(*)\Количество транзакций восстановления, записанных на диск  

    -   \Статистика реплики хранилища(*)\Количество транзакций восстановления  

    -   \Статистика реплики хранилища(*)\Количество транзакций репликации, записанных на диск  

    -   \Статистика реплики хранилища(*)\Количество транзакций репликации  

    -   \Статистика реплики хранилища(*)\Максимальный порядковый номер журнала  

    -   \Статистика реплики хранилища(*)\Количество полученных сообщений  

    -   \Статистика реплики хранилища(*)\Количество отправленных сообщений  

    Дополнительные сведения о счетчиках производительности, доступных в Windows PowerShell, есть в описании командлета [Get-Counter](https://docs.microsoft.com/powershell/module/Microsoft.PowerShell.Diagnostics/Get-Counter).  

3.  Чтобы изменить направление репликации из одного расположения, используйте командлет `Set-SRPartnership`.  

    ```PowerShell  
    Set-SRPartnership -NewSourceComputerName sr-srv06 -SourceRGName rg02 -DestinationComputerName sr-srv05 -DestinationRGName rg01  
    ```  

    > [!WARNING]  
    > Windows Server предотвращает переключение ролей при выполнении начальной синхронизации, так как это может привести к потери данных при попытке переключения перед выполнением начальной репликации. Не принудительно переключайтейте направления, пока не завершится начальная синхронизация.  

    Проверьте журналы событий и убедитесь, что направление репликации изменено и режим восстановления установлен, а затем выполните согласование. Теперь операции записи смогут использовать хранилище, принадлежащее новому исходному серверу. Изменение направления репликации блокирует операции записи на компьютере, который ранее был исходным.  

4.  Чтобы удалить репликацию, выполните `Get-SRGroup`, `Get-SRPartnership`, `Remove-SRGroup` и `Remove-SRPartnership` на каждом узле. Командлет `Remove-SRPartnership` следует выполнять только на том узле, который сейчас является источником репликации, но не на целевом сервере. Выполните `Remove-Group` на обоих серверах. Например, вот как можно удалить репликацию на двух серверах:  

    ```powershell
    Get-SRPartnership  
    Get-SRPartnership | Remove-SRPartnership  
    Get-SRGroup | Remove-SRGroup  
    ```  

## <a name="replacing-dfs-replication-with-storage-replica"></a>Замена репликации DFS на реплику хранилища  
У многих клиентов корпорации Майкрософт репликация DFS развернута в качестве решения для аварийного восстановления таких неструктурированных пользовательских данных, как домашние папки и общие папки отделов. Репликация DFS входит в состав в Windows Server 2003 R2 и всех последующих выпусков операционных систем. Она хорошо показала себя в сетях с низкой пропускной способностью, благодаря чему является привлекательным решением для сред с высокой задержкой, малыми объемами изменений и большим числом узлов. Однако при использовании для репликации данных это решение имеет существенные ограничения:  
* Он не реплицирует используемые или открытые файлы.  
* Она не реплицируется синхронно.  
* Задержка асинхронной репликации может составлять несколько минут, часов или даже дней.  
* Она зависима от базы данных, поэтому при сбое подачи питания может потребоваться длительная проверка согласованности.  
* Обычно она настроена в качестве нескольких хозяев, что позволяет изменять поток в обоих направлениях, возможно, перезаписывая новые данные.  

Реплика хранилища отличается отсутствием этих ограничений. Но у нее есть несколько других ограничений, из-за которых она менее удобна для использования в некоторых сетевых средах.  

* Оно поддерживает только репликацию "один к одному" между томами. Можно реплицировать различные тома между несколькими серверами.  
* Хотя она поддерживает асинхронную репликацию, она не предназначена для низкой пропускной способности и сетей с высокой задержкой.  
* Он не разрешает пользователю доступ к защищенным данным в месте назначения, пока выполняется репликация  

Если для вас эти факторы не являются критичными, вы можете использовать вместо серверов репликации DFS более новую технологию, реализованную в реплике хранилища.   
В общем этот процесс происходит так.  

1. Установите Windows Server на двух серверах и настройте хранилище. Вы можете обновить существующий набор серверов или установить их заново.  
2. Убедитесь, что все подлежащие репликации данные размещены на одном или нескольких томах данных, а не на диске C:.   
   1\.  Чтобы сэкономить время, вы можете заранее передать эти данные на другой сервер, например, с помощью резервной копии или копирования файлов, или использовать хранилище с тонкой подготовкой. В отличие от репликации DSF здесь не требуется точное совпадение метаданных.  
3. Предоставьте общий доступ к данным на исходном сервере и сделайте его доступным через пространство имен DFS. Это важно для того, чтобы пользователи сохранили доступ к данным в случае аварийного изменения имени сервера на имя резервного расположения.  
   1\.  На сервере назначения можно создать аналогичные общие файловые ресурсы. Во время обычной работы они будут недоступны по сети.   
   2\.  Не добавляйте целевой сервер в пространство имен пространства имен DFS или, если это необходимо, убедитесь, что все целевые объекты папки отключены.  
4. Включите реплику хранилища и выполните начальную синхронизацию. Репликация может быть синхронной или асинхронной.   
   1\.  Синхронная репликация более предпочтительна, так как она обеспечивает согласованность данных ввода-вывода на конечном сервере.   
   2\.  Мы настоятельно рекомендуем включить теневое копирование томов и периодически создавать моментальные снимки с помощью VSSADMIN или других удобных для вас средств. Это гарантирует согласованную запись файлов приложений на диск. В случае аварии вы сможете восстановить из моментальных снимков на целевом сервере те файлы, для которых асинхронная репликация была выполнена лишь частично. Моментальные снимки реплицируются вместе с остальными файлами.  
5. Теперь можно просто работать в обычном режиме, пока не случится авария.  
6. Назначьте сервер назначения новым источником, и его реплицированные тома станут доступны для пользователей.  
7. Если вы используете синхронную репликацию, восстановление данных не потребуется, если во время отключения исходного сервера не выполнялись операции записи данных без защиты транзакций (этот механизм не зависит от репликации). Если вы используете асинхронную репликацию, теневое копирование томов будет более востребованным. Мы рекомендуем использовать теневое копирование во всех случаях, чтобы обеспечить наличие моментальных снимков, согласованных на уровне приложений.  
8. Добавьте сервер и его общие папки в качестве целевого объекта папки пространств имен DFS.   
9. Теперь пользователи могут снова обратиться к своим данным.  

   > [!NOTE]
   > Планирование аварийного восстановления – это сложная задача, которая требует большого внимания к деталям. Настоятельно рекомендуем создавать модули Runbook и ежегодно проводить практические занятия с отработкой отказов. Когда случится реальная авария, повсюду будет царить хаос, а опытные сотрудники могут оказаться вне доступа.  

## <a name="add-azure-vm-expressroute"></a>Добавление виртуальной машины Azure, подключенной к сети через ExpressRoute

1. [Создайте ExpressRoute в портал Azure](https://docs.microsoft.com/azure/expressroute/expressroute-howto-circuit-portal-resource-manager).<br>После утверждения ExpressRoute в подписку добавляется группа ресурсов. Перейдите к разделу **группы ресурсов** , чтобы просмотреть эту новую группу. Запишите имя виртуальной сети.
![портал Azure отображение группы ресурсов, добавленной с помощью ExpressRoute](media/Server-to-Server-Storage-Replication/express-route-resource-group.png)
    
    **Рис. 4. Ресурсы, связанные с ExpressRoute — запишите имя виртуальной сети.**
1. [Создайте новую группу ресурсов](https://docs.microsoft.com/azure/azure-resource-manager/resource-group-portal).
1. [Добавьте группу безопасности сети](https://docs.microsoft.com/azure/virtual-network/virtual-networks-create-nsg-arm-pportal). При создании выберите идентификатор подписки, связанный с созданной службой ExpressRoute, и выберите только что созданную группу ресурсов.
<br><br>Добавьте в группу безопасности сети любые необходимые правила безопасности для входящего и исходящего трафика. Например, может потребоваться разрешить удаленный рабочий стол доступ к виртуальной машине.
1. [Создайте виртуальную машину Azure](https://docs.microsoft.com/azure/virtual-machines/windows/quick-create-portal) со следующими параметрами (показаны на рис. 5):
    - **Общедоступный IP-адрес**: Нет
    - **Виртуальная сеть**: Выберите выбранную виртуальную сеть из группы ресурсов, добавленной с помощью ExpressRoute.
    - **Группа безопасности сети (брандмауэр)** : Выберите ранее созданную группу безопасности сети.
    ![Создание виртуальной машины с параметрами](media/Server-to-Server-Storage-Replication/azure-vm-express-route.png)
    **сети ExpressRoute рис. 5. Создание виртуальной машины при выборе параметров сети ExpressRoute**
1. После создания виртуальной машины см [. шаг 2. Подготавливает операционную систему, функции, роли, хранилище и](#provision-os)сеть.


## <a name="related-topics"></a>См. также  
- [Общие сведения о реплике хранилища](storage-replica-overview.md)  
- [Растяжение репликации кластера с помощью общего хранилища](stretch-cluster-replication-using-shared-storage.md)  
- [Репликация кластера в кластерное хранилище](cluster-to-cluster-storage-replication.md)
- [Реплика хранилища: Известные проблемы](storage-replica-known-issues.md)  
- [Реплика хранилища: вопросы и ответы](storage-replica-frequently-asked-questions.md)
- [Локальные дисковые пространства в Windows Server 2016](../storage-spaces/storage-spaces-direct-overview.md)  
