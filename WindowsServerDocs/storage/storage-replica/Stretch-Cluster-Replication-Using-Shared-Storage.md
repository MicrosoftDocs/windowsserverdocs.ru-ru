---
title: Репликация растянутого кластера с помощью общего хранилища
ms.prod: windows-server-threshold
manager: eldenc
ms.author: nedpyle
ms.technology: storage-replica
ms.topic: get-started-article
author: nedpyle
ms.date: 04/26/2019
ms.assetid: 6c5b9431-ede3-4438-8cf5-a0091a8633b0
ms.openlocfilehash: 9cfe587983ccce2c9f8ae0f029cf18ade7451465
ms.sourcegitcommit: eaf071249b6eb6b1a758b38579a2d87710abfb54
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/31/2019
ms.locfileid: "66447642"
---
# <a name="stretch-cluster-replication-using-shared-storage"></a>Репликация растянутого кластера с помощью общего хранилища

>Относится к: Windows Server 2019 г., Windows Server 2016, Windows Server (Semi-Annual Channel)

В этом примере оценки вы настроите компьютеры и их хранилища в одном растянутом кластере, где два узла будут совместно использовать один набор хранилищ и еще два узла— другой набор хранилищ. Затем будет выполнено зеркалирование обоих наборов хранилищ в кластере путем репликации, чтобы обеспечить немедленную отработку отказа. Эти узлы и соответствующие хранилища желательно расположить на различных физических сайтах, но это не является обязательным требованием. Здесь приведены отдельные шаги для создания кластеров Hyper-V и файлового сервера в рамках примеров сценариев.  

> [!IMPORTANT]  
> В этой оценке серверы на различных сайтах должны взаимодействовать с другими серверами через сеть и не должны быть подключены к общему хранилищу другого сайта с помощью физических средств. В этом сценарии не используются локальные дисковые пространства.  

## <a name="terms"></a>Термины  
В этом руководстве в качестве примера используется следующая среда:  

-   четыре сервера с именами **SR-SRV01**, **SR-SRV02**, **SR SRV03** и **SR-SRV04**, объединенные в один кластер с именем **SR-SRVCLUS**;  

-   пара логических "сайтов", представляющих два разных центра обработки данных, один из которых называется **Redmond**, а второй— **Bellevue**.  

> [!NOTE]  
> Можно использовать только два узла. При этом на каждом сайте используется по одному узлу. Тем не менее невозможно выполнить отработку отказа внутри сайта, используя только два сервера. Можно использовать до 64узлов.

![Схема, на которой показаны два узла на сайте Redmond, репликация которых обеспечивается двумя узлами того же кластера на сайте Bellevue](./media/Stretch-Cluster-Replication-Using-Shared-Storage/Storage_SR_StretchClusterExample.png)  

**РИС. 1.  Репликация хранилища в растянутом кластере**  

## <a name="prerequisites"></a>предварительные требования  
-   Лес доменных служб Active Directory (использовать Windows Server 2016 не обязательно).  
-   2-64 серверов под управлением Windows Server 2019 или Windows Server 2016 Datacenter Edition. Если вы используете Windows Server 2019, воспользуйтесь Standard Edition при ОК репликации только одного тома размером до 2 ТБ. 
-   Два набора общего хранилища, использующие SAS JBOD (например, в случае дисковых пространствах), сеть SAN стандарта Fibre Channel, общие VHDX-файлы или цель iSCSI. Хранилище должно содержать жесткий диск и твердотельный накопитель, а также поддерживать постоянное резервирование. Доступ к каждому набору хранилищ нужно предоставить только для двух серверов (асимметричная конфигурация).  
-   Каждый набор хранилищ должен допускать создание по меньшей мере двух виртуальных дисков: один для реплицируемых данных и один для журналов. На всех дисках данных в физическом хранилище необходимо использовать одинаковый размер секторов. На всех дисках с журналами в физическом хранилище необходимо использовать одинаковый размер секторов.  
-   На каждом сервере должно быть создано по меньшей мере одно подключение 1Гбит Ethernet для синхронной репликации, но желательно использовать RDMA.   
-   По крайней мере 2ГБ ОЗУ и два ядра на каждый сервер. Для большего числа виртуальных машин потребуется больше памяти и ядер.  
-   Правила всех задействованных брандмауэров и маршрутизаторов должны разрешать двунаправленный трафик ICMP, SMB (порт 445, а также 5445 для SMB Direct) и WS-MAN (порт 5985) между всеми узлами.  
-   Сеть между серверами должна иметь достаточную пропускную способность для ваших рабочих нагрузок ввода-вывода, а средняя задержка приема-передачи должна составлять 5 мс для синхронной репликации. Для асинхронной репликации рекомендации по задержке приема и передачи отсутствуют.  
-   Реплицируемое хранилище не может находиться на диске с папкой операционной системы Windows.

Многие из этих требований можно определить с помощью командлета `Test-SRTopology`. Это средство будет доступно, если установить реплику хранилища или средства управления репликой хранилища хотя бы на один сервер. Настраивать реплику хранилища не нужно. Для использования инструмента достаточно только установить командлет. В описании следующих шагов есть дополнительная информация.  

## <a name="provision-operating-system-features-roles-storage-and-network"></a>Подготовка операционной системы, функций, ролей, хранилища и сети  

1.  Установите Windows Server на всех узлах сервера, с помощью основных серверных компонентов или сервера с параметрами установки возможностей рабочего стола.  
    > [!IMPORTANT]
    > С этого момента вход в систему всегда нужно выполнять от имени пользователя домена, входящего в группу встроенной учетной записи администратора на всех серверах. Не забывайте повысить полномочия командных строк PowerShell и CMD, запуская их через графический интерфейс на компьютере с ОС Windows 10.

2.  Добавьте сведения о сети и присоедините узлы к домену, а затем перезапустите их.  
    > [!NOTE]
    > Начиная с этого этапа в руководстве предполагается, что у вас есть две пары серверов для использования в растянутом кластере. Глобальная или локальная сеть разделяет серверы, принадлежащие к физическим или логическим сайтам. Здесь также предполагается, что сервер **SR-SRV01** и **SR-SRV02** находятся на узле Redmond, а **SR-SRV03** и **SR SRV04**— на узле **Bellevue**.  

3.  Подключите первый набор общих хранилищ (дисковую полку JBOD, общий диск VHDX, цель iSCSI или Fibre Channel SAN) к серверам на сайте **Redmond**.  

4.  Подключите второй набор хранилищ к серверу на сайте **Bellevue**.  

5.  Установите на всех четырех узлах, насколько применимо, все последние версии встроенного ПО и драйверов, предоставляемых поставщиками для полки дисков, HBA, BIOS или UEFI, для сетевых адаптеров и для набора микросхем материнской платы. Перезапустите узлы при необходимости.  

    > [!NOTE]
    > Для настройки общих хранилищ и сетевого оборудования обратитесь к документации поставщика оборудования.  

6.  Убедитесь, что для параметров BIOS или UEFI настроена высокая производительность, например отключено C-состояние, установлена скорость QPI, включена архитектура NUMA и установлена максимально возможная частота памяти. Убедитесь, что для управления питанием в Windows Server выбрана схема высокой производительности. При необходимости перезагрузите компьютер.  

7.  Настройте роли следующим образом.  

    -   **Графический метод**  

        Запустите **ServerManager.exe** и добавьте все узлы сервера, щелкнув **Управление** и **Добавление серверов**.  

        > [!IMPORTANT]
        > Установите роли и компоненты **отказоустойчивой кластеризации** и **реплики хранилища** на всех узлах и перезапустите их. Если планируется использовать другие роли, например Hyper-V, файловый сервер и т.д., их также можно установить.  

    -   **С помощью метода Windows PowerShell**  

        На сервере **SR-SRV04** или на компьютере удаленного управления выполните следующую команду в консоли Windows PowerShell, которая установит все необходимые компоненты и роли для растянутого кластера на четырех узлах и перезапустит их:  

        ```PowerShell  
        $Servers = 'SR-SRV01','SR-SRV02','SR-SRV03','SR-SRV04'  

        $Servers | foreach { Install-WindowsFeature -ComputerName $_ -Name Storage-Replica,Failover-Clustering,FS-FileServer -IncludeManagementTools -restart }  

        ```  

        Дополнительные сведения об этих действиях см. в статье [Установка и удаление ролей, служб ролей и компонентов](../../administration/server-manager/install-or-uninstall-roles-role-services-or-features.md).  


8. Настройте хранилище следующим образом:  

    > [!IMPORTANT]  
    > -   Необходимо создать два тома на каждой полке: один для данных и один для журналов.  
    > -   Диски журналов и данных следует инициализировать как GPT, а не MBR.  
    > -   Два тома данных должны иметь одинаковый размер.  
    > -   Два тома журналов должны иметь одинаковый размер.  
    > -   Все реплицируемые диски данных должны иметь одинаковый размер сектора.  
    > -   Все диски журналов должны иметь одинаковый размер сектора.  
    > -   Тома журналов должны использовать хранилище на базе флэш-памяти и параметры устойчивости, обеспечивающие высокую производительность. Майкрософт рекомендует, чтобы хранилище журналов работало так же быстро или быстрее, чем хранилище данных. Томы журнала никогда не должны использоваться для других задач. 
    > -   В качестве дисков данных можно использовать жесткие диски, твердотельные накопители или их многоуровневое сочетание. Диски можно организовать как зеркальные массивы, массивы с контролем четности, RAID1 или 10, RAID5 или RAID50.  
    > -  Том журнала должен иметь размер по умолчанию не менее 9ГБ, но может отличаться как в большую, так и в меньшую сторону в зависимости от требований к ведению журнала.  
    > - Тома должны форматироваться с помощью файловой системы NTFS или ReFS.
    > - Роль файлового сервера необходима только для работы Test-SRTopology, так как она открывает порты брандмауэра, необходимые для тестирования.  

    -   **Для корпуса JBOD:**  

        1.  Убедитесь, что каждый набор узлов в парах серверов может видеть только дисковые полки своего сайта (асимметричное хранилище) и что подключения SAS правильно настроены.  

        2.  Подготовьте хранилище с помощью дисковых пространств, выполнив **шаги 1–3** из статьи [Развертывание дисковых пространств на автономном сервере](../storage-spaces/deploy-standalone-storage-spaces.md) с помощью Windows PowerShell или диспетчера сервера.  

    -   **Для хранения данных iSCSI:**  

        1.  Убедитесь, что каждый набор узлов в парах серверов может видеть только дисковые полки своего сайта (асимметричное хранилище). При работе с iSCSI следует использовать несколько сетевых адаптеров.  

        2.  Подготовьте хранилище в соответствии с документацией поставщика. При использовании целей iSCSI для Windows изучите статью [Блочное хранилище конечного сервера iSCSI, краткое руководство](../iscsi/iscsi-target-server.md).  

    -   **Для хранилища сеть SAN FC:**  

        1.  Убедитесь, что каждый набор узлов в парах серверов может видеть только дисковые полки своего сайта (асимметричное хранилище) и что правильно выбраны зоны узлов.  

        2.  Подготовьте хранилище в соответствии с документацией поставщика.  

## <a name="configure-a-hyper-v-failover-cluster-or-a-file-server-for-a-general-use-cluster"></a>Настройте отказоустойчивый кластер Hyper-V или кластерный файловый сервер для общего использования.

После настройки узлов сервера создайте кластер одного из следующих типов:  
*  [Отказоустойчивый кластер Hyper-V](#BKMK_HyperV)  
*  [Файловый сервер для общего использования кластера](#BKMK_FileServer)  

### <a name="BKMK_HyperV"></a> Настройка отказоустойчивого кластера Hyper-V  

>[!NOTE]
> Пропустите этот раздел и перейдите к разделу [Настройка кластерного файлового сервера для общего использования](#BKMK_FileServer), если нужно создать кластерный файловый сервер, а не кластер Hyper-V.  

Теперь создадим обычный отказоустойчивый кластер. После настройки, проверки и тестирования он будет растянут с помощью реплики хранилища. Все описанные ниже шаги можно выполнять на узлах кластера непосредственно или с помощью компьютера удаленного управления, который содержит средства удаленного администрирования сервера Windows Server.  

#### <a name="graphical-method"></a>Графический интерфейс  

1. Запустите файл **cluadmin.msc**.  

2. Проверьте предложенный кластер и проанализируйте результаты, чтобы убедиться, что можно продолжить.  

   > [!NOTE]  
   > Из-за использования асимметричного хранилища при проверке кластера могут возникнуть ошибки хранилища.  

3. Создайте вычислительный кластер Hyper-V. Убедитесь, что имя кластера содержит не более 15 символов. В примере ниже использован кластер SR-SRVCLUS. Если узлы находятся в разных подсетях, необходимо создать IP-адрес для имени кластера для каждой подсети и использовать зависимости «Или».  Дополнительные сведения можно найти на [Настройка IP-адреса и зависимости для кластеров с несколькими подсетями — часть III](https://techcommunity.microsoft.com/t5/Failover-Clustering/Configuring-IP-Addresses-and-Dependencies-for-Multi-Subnet/ba-p/371698).  

4. Настройте файловый ресурс-свидетель или облако-свидетель для предоставления кворума в случае потери сайта.  

   > [!NOTE]  
   > WIndows Server теперь предоставляет возможность использования облако (Azure)-свидетеля. Можно выбрать этот вариант кворума вместо файлового ресурса-свидетеля.  

   > [!WARNING]  
   > Дополнительные сведения о конфигурации кворума см. в разделе [Настройка свидетеля](https://technet.microsoft.com/library/jj612870.aspx) руководства о настройке кворума и управлении им на отказоустойчивом кластере Windows Server 2012. Дополнительные сведения о командлете `Set-ClusterQuorum` см. в статье [Set-ClusterQuorum](https://docs.microsoft.com/powershell/module/failoverclusters/set-clusterquorum).  

5. Просмотрите статью [Network Recommendations for a Hyper-V Cluster in Windows Server 2012](https://technet.microsoft.com/library/dn550728.aspx) (Рекомендации в отношении сети для кластера Hyper-V в Windows Server 2012) и убедитесь, что сеть кластера настроена оптимально.  

6. Добавьте один диск сайта Redmond к кластеру CSV. Для этого щелкните правой кнопкой мыши исходный диск в узле **Диски** раздела **Хранилище** и щелкните **Добавить в общие тома кластера**.  

7. Выполните шаги 7–10 в руководстве [Deploy a Hyper-V Cluster](https://technet.microsoft.com/library/jj863389.aspx) (Развертывание кластера Hyper-V) на сайте **Redmond**, чтобы создать тестовую виртуальную машину. Это нужно только для того, чтобы обеспечить нормальную работу кластера с двумя узлами, которые совместно используют хранилище на первом тестовом сайте.  

8. Если вы создаете растянутый кластер с двумя узлами, перед продолжением необходимо добавить все хранилища. Для этого откройте сеанс PowerShell с разрешениями администратора на узлах кластера и выполните следующую команду: `Get-ClusterAvailableDisk -All | Add-ClusterDisk`.

   Это ожидаемое поведение в Windows Server 2016.

9. Запустите Windows PowerShell и используйте командлет `Test-SRTopology`, чтобы определить, все ли требования для реплики хранилища выполнены.  

    Например, для проверки двух предложенных узлов растянутого кластера, в которых есть тома **D:** и **E:** , и выполнения тестирования в течение 30 минут:
   1. Переместите все доступные хранилища на сервер **SR-SRV01**.
   2. Щелкните команду **Создать пустую роль** в разделе **Роли** диспетчера отказоустойчивости кластеров.
   3. Добавьте интернет-хранилище в пустую роль с именем **Новая роль**.
   4. Переместите все доступные хранилища на сервер **SR-SRV03**.
   5. Щелкните команду **Создать пустую роль** в разделе **Роли** диспетчера отказоустойчивости кластеров.
   6. Переместите пустую роль **Новая роль (2)** на сервер **SR-SRV03**.
   7. Добавьте интернет-хранилище в пустую роль с именем **New Role (2)** (Новая роль (2)).
   8. Теперь, когда установлены все хранилища с буквами дисков, можно оценить кластер с помощью `Test-SRTopology`.

       Пример:

           MD c:\temp  

           Test-SRTopology -SourceComputerName SR-SRV01 -SourceVolumeName D: -SourceLogVolumeName E: -DestinationComputerName SR-SRV03 -DestinationVolumeName D: -DestinationLogVolumeName E: -DurationInMinutes 30 -ResultPath c:\temp        

      > [!IMPORTANT]
      > Если вы используете тестовый сервер, на котором в период оценки не создается нагрузка ввода-вывода на выбранный исходный том, попробуйте добавить рабочую нагрузку, иначе отчет Test-SRTopology будет бесполезным. Чтобы получить фактические результаты и рекомендованные размеры журнала, тестовая нагрузка должна соответствовать ожидаемой рабочей нагрузке. Как альтернативный вариант, во время теста можно просто копировать некоторые файлы на том источника или скачать и запустить средство DISKSPD для создания операций ввода-вывода на запись. Этот пример команды создает низкую рабочую нагрузку операций записи на дискD: в течение десяти минут:   
       `Diskspd.exe -c1g -d600 -W5 -C5 -b4k -t2 -o2 -r -w5 -i100 d:\test.dat`  

10. Изучите отчет **TestSrTopologyReport-<дата>.html**, чтобы убедиться в выполнении всех требований к реплике хранилища, и запишите прогноз относительно времени начальной синхронизации и рекомендации для журнала.  

      ![Снимок экрана с отчетом репликации](./media/Stretch-Cluster-Replication-Using-Shared-Storage/SRTestSRTopologyReport.png)

11. Верните диски в доступное хранилище и удалите временные пустые роли.

12. После этого удалите тестовую виртуальную машину. Добавьте настоящие тестовые виртуальные машины, необходимые для дальнейшей оценки, в предложенный исходный узел.  

13. Настройте доступность сведений о сайтах растянутого кластера таким образом, чтобы сервер **SR-SRV01** и **SR-SRV02** находились на сайте **Redmond**, **SR-SRV03** и **SR SRV04**— на сайте **Bellevue**, а сайт **Redmond** был предпочтительным для хранения узлов исходного хранилища и виртуальных машин.  

    ```PowerShell
    New-ClusterFaultDomain -Name Seattle -Type Site -Description "Primary" -Location "Seattle Datacenter"  
   
    New-ClusterFaultDomain -Name Bellevue -Type Site -Description "Secondary" -Location "Bellevue Datacenter"  
   
    Set-ClusterFaultDomain -Name sr-srv01 -Parent Seattle  
    Set-ClusterFaultDomain -Name sr-srv02 -Parent Seattle  
    Set-ClusterFaultDomain -Name sr-srv03 -Parent Bellevue  
    Set-ClusterFaultDomain -Name sr-srv04 -Parent Bellevue  

    (Get-Cluster).PreferredSite="Seattle"
    ```

    > [!NOTE]
    > Невозможно настроить доступность сведений о сайтах с помощью диспетчера отказоустойчивости кластеров в Windows Server 2016.  

14. **(Необязательно.)** Настройте сеть кластера и Active Directory для ускоренной отработки отказа сайта DNS. Для этого можно использовать программно-конфигурируемую сеть Hyper-V, распределенные виртуальные локальные сети, устройства для абстрагирования сети, сокращение срока жизни DNS и другие распространенные методы.

    Дополнительные сведения ознакомьтесь с материалами семинара конференции Microsoft Ignite: [Растяжение отказоустойчивых кластеров и использование реплики хранилища в Windows Server vNext](http://channel9.msdn.com/Events/Ignite/2015/BRK3487) и [Включение уведомлений об изменениях между сайтами — как и почему?](http://blogs.technet.com/b/qzaidi/archive/2010/09/23/enable-change-notifications-between-sites-how-and-why.aspx) записи блога.  

15. **(Необязательно.)** Настройте устойчивость виртуальной машины, чтобы работа гостей не прерывалась надолго во время сбоев узлов. Вместо этого будет выполняться отработка отказа с переключением на новое хранилище источника репликации за 10секунд.  

    ```PowerShell  
    (Get-Cluster).ResiliencyDefaultPeriod=10  
    ```  

    > [!NOTE]
    >  Невозможно настроить устойчивость виртуальной машины с помощью диспетчера отказоустойчивости кластеров в Windows Server 2016.  

#### <a name="windows-powershell-method"></a>Метод с Windows PowerShell  

1. Протестируйте предложенный кластер и проанализируйте результаты, чтобы убедиться, что можно продолжить.  

   ```PowerShell  
   Test-Cluster SR-SRV01, SR-SRV02, SR-SRV03, SR-SRV04  
   ```  

   > [!NOTE]
   >  Из-за использования асимметричного хранилища при проверке кластера могут возникнуть ошибки хранилища.  

2. Создайте вычислительный кластер Hyper-V (необходимо указать собственный статический IP-адрес для кластера). Убедитесь, что имя кластера содержит не более 15 символов.  Если узлы находятся в разных подсетях, чем IP-адресом для дополнительного сайта должен быть создан с помощью зависимостей «Или». Дополнительные сведения можно найти на [Настройка IP-адреса и зависимости для кластеров с несколькими подсетями — часть III](https://techcommunity.microsoft.com/t5/Failover-Clustering/Configuring-IP-Addresses-and-Dependencies-for-Multi-Subnet/ba-p/371698).
   ```PowerShell  
   New-Cluster -Name SR-SRVCLUS -Node SR-SRV01, SR-SRV02, SR-SRV03, SR-SRV04 -StaticAddress <your IP here>  
   Add-ClusterResource -Name NewIPAddress -ResourceType “IP Address” -Group “Cluster Group”
   Set-ClusterResourceDependency -Resource “Cluster Name” -Dependency “[Cluster IP Address] or [NewIPAddress]”
   ```  

3. Настройте файловый ресурс-свидетель или облако-свидетель Azure в кластере, который указывает на общий ресурс, размещенный в контроллере домена или на другом независимом сервере. Пример:  

   ```PowerShell  
   Set-ClusterQuorum -FileShareWitness \\someserver\someshare  
   ```  

   > [!NOTE]
   > WIndows Server теперь предоставляет возможность использования облако (Azure)-свидетеля. Можно выбрать этот вариант кворума вместо файлового ресурса-свидетеля.  
    
   Дополнительные сведения о конфигурации кворума см. в разделе [Настройка свидетеля](https://technet.microsoft.com/library/jj612870.aspx) руководства о настройке кворума и управлении им на отказоустойчивом кластере Windows Server 2012. Дополнительные сведения о командлете `Set-ClusterQuorum` см. в статье [Set-ClusterQuorum](https://docs.microsoft.com/powershell/module/failoverclusters/set-clusterquorum).  

4. Просмотрите статью [Network Recommendations for a Hyper-V Cluster in Windows Server 2012](https://technet.microsoft.com/library/dn550728.aspx) (Рекомендации в отношении сети для кластера Hyper-V в Windows Server 2012) и убедитесь, что сеть кластера настроена оптимально.  

5. Если вы создаете растянутый кластер с двумя узлами, перед продолжением необходимо добавить все хранилища. Для этого откройте сеанс PowerShell с разрешениями администратора на узлах кластера и выполните следующую команду: `Get-ClusterAvailableDisk -All | Add-ClusterDisk`.

   Это ожидаемое поведение в Windows Server 2016.

6. Выполните шаги 7–10 в руководстве [Deploy a Hyper-V Cluster](https://technet.microsoft.com/library/jj863389.aspx) (Развертывание кластера Hyper-V) на сайте **Redmond**, чтобы создать тестовую виртуальную машину. Это нужно только для того, чтобы обеспечить нормальную работу кластера с двумя узлами, которые совместно используют хранилище на первом тестовом сайте.  

7. После этого удалите тестовую виртуальную машину. Добавьте настоящие тестовые виртуальные машины, необходимые для дальнейшей оценки, в предложенный исходный узел.  

8. Настройте доступность сведений о сайтах растянутого кластера таким образом, чтобы сервер **SR-SRV01** и **SR-SRV02** находились на сайте **Redmond**, **SR-SRV03** и **SR SRV04** — на сайте **Bellevue**, а сайт **Redmond** был предпочтительным для хранения узлов исходного хранилища и виртуальных машин.  

   ```PowerShell  
   New-ClusterFaultDomain -Name Seattle -Type Site -Description "Primary" -Location "Seattle Datacenter"  

   New-ClusterFaultDomain -Name Bellevue -Type Site -Description "Secondary" -Location "Bellevue Datacenter"  

   Set-ClusterFaultDomain -Name sr-srv01 -Parent Seattle  
   Set-ClusterFaultDomain -Name sr-srv02 -Parent Seattle  
   Set-ClusterFaultDomain -Name sr-srv03 -Parent Bellevue  
   Set-ClusterFaultDomain -Name sr-srv04 -Parent Bellevue  

   (Get-Cluster).PreferredSite="Seattle"  
   ```  

9. **(Необязательно.)** Настройте сеть кластера и Active Directory для ускоренной отработки отказа сайта DNS. Для этого можно использовать программно-конфигурируемую сеть Hyper-V, распределенные виртуальные локальные сети, устройства для абстрагирования сети, сокращение срока жизни DNS и другие распространенные методы.  

   Дополнительные сведения ознакомьтесь с материалами семинара конференции Microsoft Ignite: [Растяжение отказоустойчивых кластеров и использование реплики хранилища в Windows Server vNext](http://channel9.msdn.com/Events/Ignite/2015/BRK3487) и [Включение уведомлений об изменениях между сайтами — как и почему](http://blogs.technet.com/b/qzaidi/archive/2010/09/23/enable-change-notifications-between-sites-how-and-why.aspx).  

10. **(Необязательно.)** Настройте устойчивость виртуальной машины, чтобы работа гостей не прерывалась надолго во время сбоев узлов. Вместо этого будет выполняться отработка отказа с переключением на новое хранилище источника репликации за 10секунд.  

    ```PowerShell  
    (Get-Cluster).ResiliencyDefaultPeriod=10  
    ```  

    > [!NOTE]  
    > Невозможно настроить устойчивость виртуальной машины с помощью диспетчера отказоустойчивости кластеров в Windows Server 2016.  



### <a name="BKMK_FileServer"></a> Настройка файлового сервера для использования кластера Общие  

>[!NOTE]
> Пропустите этот раздел, если вы уже настроили отказоустойчивый кластер Hyper-V, как описано в разделе [Настройка отказоустойчивого кластера Hyper-V](#BKMK_HyperV).  

Теперь создадим обычный отказоустойчивый кластер. После настройки, проверки и тестирования он будет растянут с помощью реплики хранилища. Все описанные ниже шаги можно выполнять на узлах кластера непосредственно или с помощью компьютера удаленного управления, который содержит средства удаленного администрирования сервера Windows Server.  

#### <a name="graphical-method"></a>Графический интерфейс  

1. Запустите файл cluadmin.msc.  

2. Проверьте предложенный кластер и проанализируйте результаты, чтобы убедиться, что можно продолжить.  
   >[!NOTE]
   >Из-за использования асимметричного хранилища при проверке кластера могут возникнуть ошибки хранилища.   
3. Создайте кластер хранилища файлового сервера для общего использования. Убедитесь, что имя кластера содержит не более 15 символов. В примере ниже использован кластер SR-SRVCLUS.  Если узлы находятся в разных подсетях, необходимо создать IP-адрес для имени кластера для каждой подсети и использовать зависимости «Или».  Дополнительные сведения можно найти на [Настройка IP-адреса и зависимости для кластеров с несколькими подсетями — часть III](https://techcommunity.microsoft.com/t5/Failover-Clustering/Configuring-IP-Addresses-and-Dependencies-for-Multi-Subnet/ba-p/371698).  

4. Настройте файловый ресурс-свидетель или облако-свидетель для предоставления кворума в случае потери сайта.  
   >[!NOTE]
   > WIndows Server теперь предоставляет возможность использования облако (Azure)-свидетеля. Можно выбрать этот вариант кворума вместо файлового ресурса-свидетеля.                                                                                                                                                                             
   >[!NOTE]
   >  Дополнительные сведения о конфигурации кворума см. в разделе [Настройка свидетеля](https://technet.microsoft.com/library/jj612870.aspx) руководства о настройке кворума и управлении им на отказоустойчивом кластере Windows Server 2012. Дополнительные сведения о командлете Set-ClusterQuorum см. в статье [Set-ClusterQuorum](https://docs.microsoft.com/powershell/module/failoverclusters/set-clusterquorum). 

5. Если вы создаете растянутый кластер с двумя узлами, перед продолжением необходимо добавить все хранилища. Для этого откройте сеанс PowerShell с разрешениями администратора на узлах кластера и выполните следующую команду: `Get-ClusterAvailableDisk -All | Add-ClusterDisk`.

   Это ожидаемое поведение в Windows Server 2016.

6. Убедитесь, что сеть кластера настроена оптимально.  
    >[!NOTE]
    > Прежде чем перейти к следующему шагу, установите роль файлового сервера.   |  

7. В разделе **Роли** щелкните **Настройка роли**. Просмотрите экран **Перед началом работы** и нажмите кнопку **Далее**.  

8. Выберите **Файловый сервер** и нажмите кнопку **Далее**.  

9. Не снимайте флажок **Файловый сервер для общего использования** и нажмите кнопку **Далее**.  

10. Укажите имя **точки доступа клиента** (не более 15 символов) и нажмите кнопку **Далее**.  

11. Выберите диск, который будет использоваться в качестве тома данных, и нажмите кнопку **Далее**.  

12. Проверьте параметры и нажмите кнопку **Далее**. Нажмите кнопку **Готово**.  

13. Щелкните новую роль файлового сервера правой кнопкой мыши и выберите пункт **Добавить общий файловый ресурс**. Следуйте указаниям мастера для настройки общих ресурсов.  

14. Дополнительно Добавьте другую роль файлового сервера, использующую другое хранилище на этом сайте.  

15. Настройте доступность сведений о сайтах растянутого кластера таким образом, чтобы сервер SR-SRV01 и SR-SRV02 находились на сайте Redmond, SR-SRV03 и SR SRV04— на сайте Bellevue, а сайт Redmond был предпочтительным для хранения узлов исходного хранилища и виртуальных машин.  

    ```PowerShell  
    New-ClusterFaultDomain -Name Seattle -Type Site -Description "Primary" -Location "Seattle Datacenter"  

    New-ClusterFaultDomain -Name Bellevue -Type Site -Description "Secondary" -Location "Bellevue Datacenter"  

    Set-ClusterFaultDomain -Name sr-srv01 -Parent Seattle  
    Set-ClusterFaultDomain -Name sr-srv02 -Parent Seattle  
    Set-ClusterFaultDomain -Name sr-srv03 -Parent Bellevue  
    Set-ClusterFaultDomain -Name sr-srv04 -Parent Bellevue  

    (Get-Cluster).PreferredSite="Seattle"  
    ```  

      >[!NOTE]
      > Невозможно настроить доступность сведений о сайтах с помощью диспетчера отказоустойчивости кластеров в Windows Server 2016.  

16. (Необязательно.) Настройте сеть кластера и Active Directory для ускоренной отработки отказа сайта DNS. Для этого можно использовать распределенные виртуальные локальные сети, устройства для абстрагирования сети, сокращение срока жизни DNS и другие распространенные методы.  

Чтобы получить дополнительные сведения, ознакомьтесь с материалами семинара конференции Microsoft Ignite [Stretching Failover Clusters and Using Storage Replica in Windows Server vNext](http://channel9.msdn.com/events/ignite/2015/brk3487) (Растягивание отказоустойчивых кластеров и использование реплики хранилища в Windows Server vNext) и записью блога [Enable Change Notifications between Sites — How and Why](http://blogs.technet.com/b/qzaidi/archive/2010/09/23/enable-change-notifications-between-sites-how-and-why.aspx) (Включение уведомлений об изменениях между сайтами: выполнение процесса и преимущества).    

#### <a name="powershell-method"></a>Метод для PowerShell

1. Протестируйте предложенный кластер и проанализируйте результаты, чтобы убедиться, что можно продолжить.    

    ```PowerShell
    Test-Cluster SR-SRV01, SR-SRV02, SR-SRV03, SR-SRV04
    ```

    > [!NOTE]
    >  Из-за использования асимметричного хранилища при проверке кластера могут возникнуть ошибки хранилища.   

2.  Создайте вычислительный кластер Hyper-V (необходимо указать собственный статический IP-адрес для кластера). Убедитесь, что имя кластера содержит не более 15 символов.  Если узлы находятся в разных подсетях, чем IP-адресом для дополнительного сайта должен быть создан с помощью зависимостей «Или». Дополнительные сведения можно найти на [Настройка IP-адреса и зависимости для кластеров с несколькими подсетями — часть III](https://techcommunity.microsoft.com/t5/Failover-Clustering/Configuring-IP-Addresses-and-Dependencies-for-Multi-Subnet/ba-p/371698).  

    ```PowerShell
    New-Cluster -Name SR-SRVCLUS -Node SR-SRV01, SR-SRV02, SR-SRV03, SR-SRV04 -StaticAddress <your IP here> 

    Add-ClusterResource -Name NewIPAddress -ResourceType “IP Address” -Group “Cluster Group”

    Set-ClusterResourceDependency -Resource “Cluster Name” -Dependency “[Cluster IP Address] or [NewIPAddress]”
    ```


3. Настройте файловый ресурс-свидетель или облако-свидетель Azure в кластере, который указывает на общий ресурс, размещенный в контроллере домена или на другом независимом сервере. Пример:  

    ```PowerShell
    Set-ClusterQuorum -FileShareWitness \\someserver\someshare
    ```

    >[!NOTE]
    > Windows Server теперь предоставляет возможность для облака-свидетеля с помощью Azure. Можно выбрать этот вариант кворума вместо файлового ресурса-свидетеля.  

   Дополнительные сведения о конфигурации кворума см. в разделе [кворума кластера и пул понимание](../storage-spaces/understand-quorum.md). Дополнительные сведения о командлете Set-ClusterQuorum см. в статье [Set-ClusterQuorum](https://docs.microsoft.com/powershell/module/failoverclusters/set-clusterquorum).

4.  Если вы создаете растянутый кластер с двумя узлами, перед продолжением необходимо добавить все хранилища. Для этого откройте сеанс PowerShell с разрешениями администратора на узлах кластера и выполните следующую команду: `Get-ClusterAvailableDisk -All | Add-ClusterDisk`.

    Это ожидаемое поведение в Windows Server 2016.

5. Убедитесь, что сеть кластера настроена оптимально.  

6.  Настройте роль файлового сервера. Пример:

    ```PowerShell  
    Get-ClusterResource  
    Add-ClusterFileServerRole -Name SR-CLU-FS2 -Storage "Cluster Disk 4"  

    MD e:\share01  

    New-SmbShare -Name Share01 -Path f:\share01 -ContinuouslyAvailable $false  
    ```

7. Настройте доступность сведений о сайтах растянутого кластера таким образом, чтобы сервер SR-SRV01 и SR-SRV02 находились на сайте Redmond, SR-SRV03 и SR SRV04— на сайте Bellevue, а сайт Redmond был предпочтительным для хранения узлов исходного хранилища и виртуальных машин.  

    ```PowerShell
    New-ClusterFaultDomain -Name Seattle -Type Site -Description "Primary" -Location "Seattle Datacenter"  

    New-ClusterFaultDomain -Name Bellevue -Type Site -Description "Secondary" -Location "Bellevue Datacenter"  

    Set-ClusterFaultDomain -Name sr-srv01 -Parent Seattle  
    Set-ClusterFaultDomain -Name sr-srv02 -Parent Seattle  
    Set-ClusterFaultDomain -Name sr-srv03 -Parent Bellevue  
    Set-ClusterFaultDomain -Name sr-srv04 -Parent Bellevue  

    (Get-Cluster).PreferredSite="Seattle"  
    ```

8.  (Необязательно.) Настройте сеть кластера и Active Directory для ускоренной отработки отказа сайта DNS. Для этого можно использовать распределенные виртуальные локальные сети, устройства для абстрагирования сети, сокращение срока жизни DNS и другие распространенные методы.  
    
    Чтобы получить дополнительные сведения, ознакомьтесь с материалами семинара конференции Microsoft Ignite [Stretching Failover Clusters and Using Storage Replica in Windows Server vNext](http://channel9.msdn.com/events/ignite/2015/brk3487) (Растягивание отказоустойчивых кластеров и использование реплики хранилища в Windows Server vNext) и записью блога [Enable Change Notifications between Sites — How and Why](http://blogs.technet.com/b/qzaidi/archive/2010/09/23/enable-change-notifications-between-sites-how-and-why.aspx) (Включение уведомлений об изменениях между сайтами: выполнение процесса и преимущества).

### <a name="configure-a-stretch-cluster"></a>Настройка растянутого кластера  
Теперь необходимо настроить растянутый кластер с помощью диспетчера отказоустойчивости кластеров или Windows PowerShell. Все описанные ниже шаги можно выполнять на узлах кластера непосредственно или с помощью компьютера удаленного управления, который содержит средства удаленного администрирования сервера Windows Server.  

#### <a name="failover-cluster-manager-method"></a>Метод для диспетчера отказоустойчивости кластеров  

1.  Для рабочих нагрузок Hyper-V на одном узле с данными, которые нужно реплицировать, добавьте исходный диск данных из доступных дисков, чтобы поместить общие тома в кластер, если они не настроены. Не добавляйте все диски. Просто добавьте один диск. На этом этапе для половины дисков будет отображаться автономное состояние, так как это асимметричное хранилище.  
Если репликация рабочей нагрузки физического диска выполнялась так же, как и репликация файлового сервера для общего использования, у вас уже есть готовый диск, подключенный к роли.  

    ![Снимок экрана: диспетчер отказоустойчивости кластеров](./media/Stretch-Cluster-Replication-Using-Shared-Storage/Storage_SR_OnlineDisks2.png)  

2.  Щелкните диск CSV или диск, подключенный к роли, правой кнопкой мыши и выберите **Репликация**, а затем — **Включить**.  

3.  Выберите соответствующий конечный том данных и нажмите кнопку **Далее**. Тома отобразившихся конечных дисков и выбранного исходного диска будут одинакового размера. При перемещении между диалоговыми окнами мастера доступное хранилище переместится автоматически и при необходимости перейдет в оперативный режим работы в фоновом режиме.  

    ![Снимок экрана: страница "Выбор диска назначения" в мастере настройки реплики хранилища](./media/Stretch-Cluster-Replication-Using-Shared-Storage/Storage_SR_SelectDestinationDataDisk2.png)  

4.  Выберите соответствующий исходный диск журнала и нажмите кнопку **Далее**. Исходный том журнала должен находиться на диске, использующем твердотельный накопитель или подобный носитель с быстрой передачей данных, а не на вращающихся дисках.  

5.  Выберите соответствующий конечный том журнала и нажмите кнопку "Далее". Тома отобразившихся конечных дисков журнала и выбранного исходного диска журнала будут одинакового размера.  

6.  Оставьте для параметра **Overwrite Volume** (Перезаписать том) значение **Перезаписать конечный том**, если конечный том не содержит предыдущую копию данных с исходного сервера. Если конечный том содержит схожие данные с момента последней архивации или предыдущей репликации, выберите значение **Заполненный конечный диск** и нажмите кнопку **Далее**.  

7.  Оставьте для параметра **Режим репликации** значение **Синхронная репликация**, если планируется использовать репликацию без целевых точек восстановления. Измените значение на **Асинхронная репликация**, если планируется растянуть кластер по сетям с более длительными задержками или требуется снизить задержку операций ввода-вывода на узлах основного сайта.  
8.  Оставьте значение **Группа согласованности** для параметра **Максимальная производительность**, если не планируется использовать порядок записи позже с парой дополнительных дисков в группе репликации. Если планируется добавить дополнительные диски в эту группу репликации и требуется обеспечить гарантированный порядок записи, выберите значение **Включить порядок записи** и нажмите кнопку **Далее**.  

9.  Нажмите кнопку **Далее**, чтобы настроить репликацию и растянуть кластер.  

    ![Снимок экрана: страница подтверждения выбора в мастере настройки реплики хранилища](./media/Stretch-Cluster-Replication-Using-Shared-Storage/Storage_SR_ConfigureSR2.png)  

10. На экране "Сводка" обратите внимание на результаты в диалоговом окне завершения. Отчет можно просмотреть в браузере.  

11. На этом этапе настроено партнерство реплики хранилища между двумя частями кластера. Репликация все еще выполняется. Просмотреть состояние репликации с помощью графического средства можно несколькими способами.  

    1.  Используйте столбец **Роль репликации** и вкладку **Репликация**. После завершения начальной синхронизации репликация исходного и конечного дисков будет находиться в состоянии **Непрерывная репликация**.   

        ![Снимок экрана: вкладка "Репликация" диска в диспетчере отказоустойчивости кластеров](./media/Stretch-Cluster-Replication-Using-Shared-Storage/Storage_SR_ReplicationDetails2.png)  

    2.  Запустите файл **eventvwr.exe**.  

        1.  На исходном сервере выберите **Приложения и службы\Майкрософт\Windows\StorageReplica\Администратор** и просмотрите события 5015, 5002, 5004, 1237, 5001 и 2200.  

        2.  На конечном сервере выберите **Приложения и службы\Майкрософт\Windows\StorageReplica\Операционное** и дождитесь события 1215. Это событие сообщает количество скопированных байтов и время выполнения. Пример.  

            ```  
            Log Name:      Microsoft-Windows-StorageReplica/Operational  
            Source:        Microsoft-Windows-StorageReplica  
            Date:          4/6/2016 4:52:23 PM  
            Event ID:      1215  
            Task Category: (1)  
            Level:         Information  
            Keywords:      (1)  
            User:          SYSTEM  
            Computer:      SR-SRV03.Threshold.nttest.microsoft.com  
            Description:  
            Block copy completed for replica.  

            ReplicationGroupName: Replication 2  
            ReplicationGroupId: {c6683340-0eea-4abc-ab95-c7d0026bc054}  
            ReplicaName: \\?\Volume{43a5aa94-317f-47cb-a335-2a5d543ad536}\  
            ReplicaId: {00000000-0000-0000-0000-000000000000}  
            End LSN in bitmap:   
            LogGeneration: {00000000-0000-0000-0000-000000000000}  
            LogFileId: 0  
            CLSFLsn: 0xFFFFFFFF  
            Number of Bytes Recovered: 68583161856  
            Elapsed Time (ms): 140  
            ```  

        3.  На конечном сервере выберите **Приложения и службы\Майкрософт\Windows\StorageReplica\Администратор** и просмотрите события 5009, 1237, 5001, 5015, 5005 и 2200 для отслеживания хода обработки события. В этой последовательности не должно быть предупреждений или ошибок. Будет много событий 1237, которые указывают ход выполнения.  

            > [!WARNING]
            > Загрузка ЦП и памяти может быть выше обычного до завершения начальной синхронизации.  

#### <a name="windows-powershell-method"></a>Метод с Windows PowerShell  

1.  Убедитесь, что консоль Powershell выполняется с использованием учетной записи администратора с повышенными привилегиями.  
2.  Добавьте исходное хранилище данных в качестве CSV-файла только в кластер. Чтобы получить сведения о размере, разделах и структуре томов доступных дисков, используйте следующие команды:  

    ```PowerShell  
    Move-ClusterGroup -Name "available storage" -Node sr-srv01  

    $DiskResources = Get-ClusterResource | Where-Object { $_.ResourceType -eq 'Physical Disk' -and $_.State -eq 'Online' }  
    $DiskResources | foreach {  
        $resource = $_  
        $DiskGuidValue = $resource | Get-ClusterParameter DiskIdGuid  

        Get-Disk | where { $_.Guid -eq $DiskGuidValue.Value } | Get-Partition | Get-Volume |  
            Select @{N="Name"; E={$resource.Name}}, @{N="Status"; E={$resource.State}}, DriveLetter, FileSystemLabel, Size, SizeRemaining  
    } | FT -AutoSize  

    Move-ClusterGroup -Name "available storage" -Node sr-srv03  

    $DiskResources = Get-ClusterResource | Where-Object { $_.ResourceType -eq 'Physical Disk' -and $_.State -eq 'Online' }  
    $DiskResources | foreach {  
        $resource = $_  
        $DiskGuidValue = $resource | Get-ClusterParameter DiskIdGuid  

        Get-Disk | where { $_.Guid -eq $DiskGuidValue.Value } | Get-Partition | Get-Volume |  
            Select @{N="Name"; E={$resource.Name}}, @{N="Status"; E={$resource.State}}, DriveLetter, FileSystemLabel, Size, SizeRemaining  
    } | FT -AutoSize  
    ```  

4.  Задайте правильный диск для CSV-файла с помощью следующих команд:  

    ```PowerShell  
    Add-ClusterSharedVolume -Name "Cluster Disk 4"  
    Get-ClusterSharedVolume  
    Move-ClusterSharedVolume -Name "Cluster Disk 4" -Node sr-srv01  
    ```  

5.  Настройте растянутый кластер, указав следующее:  

    -   Исходные и конечные узлы (исходный диск данных является диском CSV, а все остальные диски— нет).  

    -   Имена исходной и конечной групп репликации.  

    -   Исходный и конечный диски с разделами одинакового размера.  

    -   Исходный и конечный тома журналов с достаточным объемом свободного места для хранения журналов на обоих дисках. При этом в качестве хранилища используется твердотельный накопитель или аналогичный носитель с быстрой передачей данных.  

    -   Исходный и конечный тома журналов с достаточным объемом свободного места для хранения журналов на обоих дисках. При этом в качестве хранилища используется твердотельный накопитель или аналогичный носитель с быстрой передачей данных.  

    -   Размер журнала.  

    -   Исходный том журнала должен находиться на диске, использующем твердотельный накопитель или подобный носитель с быстрой передачей данных, а не на вращающихся дисках.  

    ```PowerShell  
    New-SRPartnership -SourceComputerName sr-srv01 -SourceRGName rg01 -SourceVolumeName "C:\ClusterStorage\Volume1" -SourceLogVolumeName e: -DestinationComputerName sr-srv03 -DestinationRGName rg02 -DestinationVolumeName d: -DestinationLogVolumeName e:  
    ```  

    > [!NOTE]  
    > Кроме того, можно использовать `New-SRGroup` для одного узла на каждом сайте и `New-SRPartnership` для создания поэтапной, а не одновременной репликации всех объектов.  

6.  Определите этап репликации.  

    1.  На исходном сервере введите следующую команду и изучите события 5015, 5002, 5004, 1237, 5001 и 2200.  

        ```PowerShell  
        Get-WinEvent -ProviderName Microsoft-Windows-StorageReplica -max 20  
        ```  

    2.  На конечном сервере выполните следующую команду для просмотра событий реплики хранилища, которые показывают создание партнерства. Это событие сообщает количество скопированных байтов и время выполнения. Пример.  

            Get-WinEvent -ProviderName Microsoft-Windows-StorageReplica | Where-Object {$_.ID -eq "1215"} | fl  

            TimeCreated  : 4/6/2016 4:52:23 PM  
            ProviderName : Microsoft-Windows-StorageReplica  
            Id           : 1215  
            Message      : Block copy completed for replica.  

               ReplicationGroupName: Replication 2  
               ReplicationGroupId: {c6683340-0eea-4abc-ab95-c7d0026bc054}  
               ReplicaName: ?Volume{43a5aa94-317f-47cb-a335-2a5d543ad536}  
               ReplicaId: {00000000-0000-0000-0000-000000000000}  
               End LSN in bitmap:   
               LogGeneration: {00000000-0000-0000-0000-000000000000}  
               LogFileId: 0  
               CLSFLsn: 0xFFFFFFFF  
               Number of Bytes Recovered: 68583161856  
               Elapsed Time (ms): 140  

    3.  На конечном сервере выполните следующую команду и проверьте события 5009, 1237, 5001, 5015, 5005 и 2200 для отслеживания хода обработки события. В этой последовательности не должно быть предупреждений или ошибок. Будет много событий 1237, которые указывают ход выполнения.  

        ```PowerShell  
        Get-WinEvent -ProviderName Microsoft-Windows-StorageReplica | FL  
        ```  

    4.  Кроме того, группа конечных серверов для реплики постоянно сообщает количество оставшихся байтов для копирования, и эти сведения можно запрашивать через PowerShell. Пример:  

        ```PowerShell  
        (Get-SRGroup).Replicas | Select-Object numofbytesremaining  
        ```  

        Пример контроля выполнения (не завершается самостоятельно):  

        ```PowerShell  
        while($true) {  

         $v = (Get-SRGroup -Name "Replication 2").replicas | Select-Object numofbytesremaining  
         [System.Console]::Write("Number of bytes remaining: {0}`r", $v.numofbytesremaining)  
         Start-Sleep -s 5  
        }  
        ```  

7.  Для получения состояния источника и назначения репликации в растянутом кластере используйте `Get-SRGroup` и `Get-SRPartnership`, чтобы просмотреть настроенное состояние репликации в растянутом кластере.  

    ```PowerShell  
    Get-SRGroup  
    Get-SRPartnership  
    (Get-SRGroup).replicas  
    ```  

### <a name="manage-stretched-cluster-replication"></a>Управление репликацией растянутого кластера  
Теперь вы приступите к управлению растянутым кластером и к его эксплуатации. Все описанные ниже шаги можно выполнять на узлах кластера непосредственно или с помощью компьютера удаленного управления, который содержит средства удаленного администрирования сервера Windows Server.  

#### <a name="graphical-tools-method"></a>Метод с использованием графических средств  

1.  Используйте диспетчер отказоустойчивости кластеров, чтобы узнать источник и назначение репликации и их текущее состояние.  

2.  Для измерения производительности репликации выполните файл **Perfmon.exe** на исходном и конечном узлах.  

    1.  На конечном узле сделайте следующее:  

        1.  Добавьте объект **Статистика реплики хранилища** со всеми счетчиками производительности для тома данных.  

        2.  Проанализируйте результаты.  

    2.  На исходном узле сделайте следующее:  

        1.  Добавьте объекты **Статистика реплики хранилища** и **Статистика ввода-вывода раздела реплики хранилища** со всеми счетчиками производительности для тома данных (последний доступен только с данными на текущем исходном сервере).  

        2.  Проанализируйте результаты.  

3.  Чтобы изменить источник и назначение репликации в растянутом кластере, используйте следующие методы:  

    1.  Чтобы переместить источник репликации между узлами на одном сайте, щелкните исходный CSV правой кнопкой мыши, выберите пункт **Move Storage** (Переместить хранилище), щелкните **Выбрать узел** и выберите узел на том же сайте. При использовании хранилища другого типа для диска с назначенной ролью нужно переместить роль.  

    2.  Чтобы переместить источник репликации с одного сайта на другой, щелкните исходный CSV правой кнопкой мыши, выберите пункт **Move Storage** (Переместить хранилище), щелкните **Выбрать узел** и выберите узел на другом сайте. Если настроен предпочтительный сайт, можно использовать лучший узел, на который можно постоянно перемещать исходное хранилище— узел на предпочтительном сайте. При использовании хранилища другого типа для диска с назначенной ролью нужно переместить роль.  

    3.  Чтобы выполнить запланированную отработку отказа для изменения направления репликации с одного узла на другой, завершите работу обоих узлов на одном сайте, используя **ServerManager.exe** или **SConfig**.  

    4.  Чтобы выполнить незапланированную отработку отказа для изменения направления репликации с одного сайта на другой, отключите оба узла на одном сайте.  

        > [!NOTE]
        > В Windows Server 2016 может потребоваться использовать диспетчер отказоустойчивости кластеров или Move-ClusterGroup для перемещения конечных дисков на другой сайт вручную после перехода узлов в оперативный режим.  

        > [!NOTE]
        > Реплика хранилища отключает конечные тома. Это сделано намеренно.  

4.  Чтобы изменить размер журнала 8 ГБ по умолчанию, щелкните исходный и конечный диски журналов правой кнопкой мыши, нажмите кнопку **журнал репликации** , а затем установите одинаковый размер для дисков для сопоставления.  

    > [!NOTE]  
    > По умолчанию размер журнала составляет 8ГБ. В зависимости от результатов работы командлета `Test-SRTopology`, иногда целесообразно использовать журнал большего или меньшего размера (параметр `-LogSizeInBytes`).  

5.  Чтобы добавить другую пару реплицированных дисков в имеющуюся группу репликации, необходимо убедиться, что в доступном хранилище есть по крайней мере один дополнительный диск. Затем можно щелкнуть исходный диск правой кнопкой мыши и выбрать пункт **Add replication partnership** (Добавить партнерство репликации).  
    > [!NOTE]  
    > Эта потребность в дополнительном диске в доступном хранилище продиктована ухудшением функциональности, а не намеренным изменением. Диспетчер отказоустойчивости кластеров ранее нормально обрабатывал добавление дополнительных дисков и снова будет его поддерживать в более поздней версии.  


6.  Чтобы удалить имеющуюся репликацию, сделайте следующее:  

    1.  Запустите файл **cluadmin.msc**.  

    2.  Щелкните исходный диск CSV правой кнопкой мыши и выберите пункт **Репликация**, а затем щелкните **Удалить**. Подтвердите запрос с предупреждением.  

    3.  При необходимости удалите хранилище из диска CSV, чтобы вернуть его в доступное хранилище для дальнейшего тестирования.  

        > [!NOTE]  
        > Чтобы добавить буквы дисков к томам после возврата в доступное хранилище, может понадобиться использовать файл **DiskMgmt.msc** или **ServerManager.exe**.  

#### <a name="windows-powershell-method"></a>Метод с Windows PowerShell  

1.  Используйте **Get-SRGroup** и **(Get-SRGroup).Replicas**, чтобы узнать источник и назначение репликации и их текущее состояние.  

2.  Для измерения производительности репликации выполните командлет `Get-Counter` на исходном и конечном узлах. Ниже перечислены имена счетчиков.  

    -   \Статистика ввода-вывода раздела реплики хранилища(*)\Количество раз приостановки записи на диск  

    -   \Статистика ввода-вывода раздела реплики хранилища(*)\Количество вводов-выводов записи на диск в ожидании  

    -   \Статистика ввода-вывода раздела реплики хранилища(*)\Количество запросов для последней записи в журнал  

    -   \Статистика ввода-вывода раздела реплики хранилища(*)\Среднее Длина очереди записи на диск  

    -   \Статистика ввода-вывода раздела реплики хранилища(*)\Текущая длина очереди записи на диск  

    -   \Статистика ввода-вывода раздела реплики хранилища(*)\Количество запросов записи приложения  

    -   \Статистика ввода-вывода раздела реплики хранилища(*)\Среднее Число запросов на операцию записи в журнал  

    -   \Статистика ввода-вывода раздела реплики хранилища(*)\Среднее Задержка записи приложения  

    -   \Статистика ввода-вывода раздела реплики хранилища(*)\Среднее Задержка чтения приложения  

    -   \Статистика реплики хранилища(*)\Целевая RPO  

    -   \Статистика реплики хранилища(*)\Текущая RPO  

    -   \Статистика реплики хранилища(*)\Среднее Длина очереди журнала  

    -   \Статистика реплики хранилища(*)\Длина очереди текущего журнала  

    -   \Статистика реплики хранилища(*)\Всего байт получено  

    -   \Статистика реплики хранилища(*)\Всего байт отправлено  

    -   \Статистика реплики хранилища(*)\Среднее Время задержки исходящих данных в сети  

    -   \Статистика реплики хранилища(*)\Состояние репликации  

    -   \Статистика реплики хранилища(*)\Среднее Задержка приема-передачи сообщения  

    -   \Статистика реплики хранилища(*)\Время, затраченное на последнее восстановление  

    -   \Статистика реплики хранилища(*)\Количество транзакций восстановления, записанных на диск  

    -   \Статистика реплики хранилища(*)\Количество транзакций восстановления  

    -   \Статистика реплики хранилища(*)\Количество транзакций репликации, записанных на диск  

    -   \Статистика реплики хранилища(*)\Количество транзакций репликации  

    -   \Статистика реплики хранилища(*)\Максимальный порядковый номер журнала  

    -   \Статистика реплики хранилища(*)\Количество полученных сообщений  

    -   \Статистика реплики хранилища(*)\Количество отправленных сообщений  

    Дополнительные сведения о счетчиках производительности, доступных в Windows PowerShell, есть в описании командлета [Get-Counter](https://docs.microsoft.com/powershell/module/Microsoft.PowerShell.Diagnostics/Get-Counter).  

3.  Чтобы изменить источник и назначение репликации в растянутом кластере, используйте следующие методы:  

    1.  Чтобы переместить источник репликации с одного узла на другой на сайте **Redmond**, переместите ресурс CSV, используя командлет Move-ClusterSharedVolume.  

        ```PowerShell  
        Get-ClusterSharedVolume | fl *  
        Move-ClusterSharedVolume -Name "cluster disk 4" -Node sr-srv02  
        ```  

    2.  Чтобы изменить направление репликации с одного сайта на другой в запланированном режиме, переместите ресурс CSV, используя командлет **Move-ClusterSharedVolume**.  

        ```PowerShell 
        Get-ClusterSharedVolume | fl *  
        Move-ClusterSharedVolume -Name "cluster disk 4" -Node sr-srv04  
        ```  

        При этом также соответствующим образом переместятся журналы и данные для других сайтов и узлов.  

    3.  Чтобы выполнить незапланированную отработку отказа для изменения направления репликации с одного сайта на другой, отключите оба узла на одном сайте.  

        > [!NOTE]  
        > Реплика хранилища отключает конечные тома. Это сделано намеренно.  

4.  Чтобы изменить размер журнала 8 ГБ по умолчанию, используйте **Set-SRGroup** в группах реплик хранилищ источника и назначения.   Например, чтобы задать для всех журналов размер в 2ГБ, выполните следующее команды:  

    ```PowerShell  
    Get-SRGroup | Set-SRGroup -LogSizeInBytes 2GB  
    Get-SRGroup  
    ```  

5.  Чтобы добавить другую пару реплицированных дисков в имеющуюся группу репликации, необходимо убедиться, что в доступном хранилище есть по крайней мере один дополнительный диск. Затем можно щелкнуть исходный диск правой кнопкой мыши и выбрать пункт Add replication partnership (Добавить партнерство репликации).  
       >[!NOTE]
       >Эта потребность в дополнительном диске в доступном хранилище продиктована ухудшением функциональности, а не намеренным изменением. Диспетчер отказоустойчивости кластеров ранее нормально обрабатывал добавление дополнительных дисков и снова будет его поддерживать в более поздней версии.  

    Используйте командлет **Set-SRPartnership** с параметрами **-SourceAddVolumePartnership** и **-DestinationAddVolumePartnership**.  
6.  Чтобы удалить репликацию, выполните `Get-SRGroup`, Get-`SRPartnership`, `Remove-SRGroup` и `Remove-SRPartnership` на любом узле.  

    ```PowerShell  
    Get-SRPartnership | Remove-SRPartnership  
    Get-SRGroup | Remove-SRGroup  
    ```  

    > [!NOTE]
    > При использовании компьютера удаленного управления понадобится указать имя кластера для этих командлетов, а также имена двух групп ресурсов.  

### <a name="related-topics"></a>Связанные разделы  
- [Общие сведения о реплике хранилища](storage-replica-overview.md)  
- [Репликация сервера на сервер хранилища](server-to-server-storage-replication.md)  
- [Межкластерная репликация](cluster-to-cluster-storage-replication.md)  
- [Реплика хранилища: Известные проблемы](storage-replica-known-issues.md) 
- [Реплика хранилища: вопросы и ответы](storage-replica-frequently-asked-questions.md)  

## <a name="see-also"></a>См. также  
- [Windows Server 2016](../../get-started/windows-server-2016.md)  
- [Дисковые пространства в Windows Server 2016](../storage-spaces/storage-spaces-direct-overview.md)
