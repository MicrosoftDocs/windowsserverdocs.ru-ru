---
title: "Часто задаваемые вопросы о реплике хранилища"
ms.prod: windows-server-threshold
manager: siroy
ms.author: nedpyle
ms.technology: storage-replica
ms.topic: get-started-article
author: nedpyle
ms.date: 07/20/2017
ms.assetid: 12bc8e11-d63c-4aef-8129-f92324b2bf1b
ms.openlocfilehash: f29ca24a39e00f5142fe700e6abb09d1673acf7b
ms.sourcegitcommit: 583355400f6b0d880dc0ac6bc06f0efb50d674f7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/17/2017
---
# <a name="frequently-asked-questions-about-storage-replica"></a>Часто задаваемые вопросы о реплике хранилища

>Область применения: Windows Server (Semi-Annual Channel), Windows Server 2016

В этой статье содержатся ответы на часто задаваемые вопросы о реплике хранилища.

## <a name="FAQ1"></a> Поддерживается ли реплика хранилища для Nano Server?  
Да.  

> [!NOTE]
> При установке нужно выбрать пакет **хранилища** для Nano Server. Сведения о развертывании сервера Nano Server см. в статье [Getting Started with Nano Server](https://technet.microsoft.com/library/mt126167.aspx) (Приступая к работе с сервером Nano Server).  

Установите реплику хранилища на Nano Server с помощью удаленного взаимодействия PowerShell следующим образом:  

1. Добавьте Nano Server в список доверия клиента.  
   > [!NOTE]
   > Этот шаг необходим, только если компьютер не включен в лес доменных служб Active Directory или ненадежный лес. Он позволяет добавить поддержку NTLM для удаленного взаимодействия PSSession, которая по умолчанию отключена из соображений безопасности. Подробнее см. [Вопросы обеспечения безопасности удаленного взаимодействия PowerShell](https://msdn.microsoft.com/powershell/scriptiwinrmsecurity).  

   ```  
       Set-Item WSMan:\localhost\Client\TrustedHosts "<computer name of Nano Server>"  
   ```  
2.  Чтобы установить компонент реплики хранилища, выполните следующий командлет с компьютера управления:  

    ```  
    Install-windowsfeature -Name storage-replica,RSAT-Storage-Replica -ComputerName <nano server> -Restart -IncludeManagementTools  
    ```  

    Чтобы запустить командлет `Test-SRTopology` на сервере Nano Server версии Windows Server2016, следует использовать вызов удаленного сценария с использованием CredSSP. В отличие от других командлетов реплики хранилища, `Test-SRTopology` необходимо запустить локально на исходном сервере.   
На сервере Nano Server (через удаленное взаимодействие PSSession):  

    >[!NOTE]
    >CREDSSP необходим только для подключения Kerberos с помощью двух прыжков в командлете `Test-SRTopology`, и не используется другими командлетами реплики хранилища, которые автоматически обрабатывают учетные данные распределенной системы. В обычных условиях не рекомендуется использовать CREDSSP. Чтобы ознакомиться с альтернативой CREDSSP, см. следующую запись блога Майкрософт: "PowerShell Remoting Kerberos Double Hop Solved Securely" (Надежное решение проблемы двойного прыжка Kerberos при удаленном взаимодействии PowerShell)— https://blogs.technet.microsoft.com/ashleymcglone/2016/08/30/powershell-remoting-kerberos-double-hop-solved-securely/ 

        Enable-WSManCredSSP -role server       

    На компьютере управления выполните:  

         Enable-WSManCredSSP Client -DelegateComputer <remote server name>  

         $CustomCred = Get-Credential  

         Invoke-Command -ComputerName sr-srv01 -ScriptBlock { Test-SRTopology <commands> } -Authentication Credssp -Credential $CustomCred  

       Теперь скопируйте результат на компьютер управления или предоставьте этот путь в общий доступ. На сервере Nano отсутствуют необходимые графические библиотеки, поэтому для обработки результатов и составления отчета с диаграммами следует применить командлет Test-SRTopology. Например:  

        Test-SRTopology -GenerateReport -DataPath \\sr-srv05\c$\temp  


## <a name="FAQ2"></a> Как следить за ходом выполнения репликации при начальной синхронизации?  
Сообщения о событии1237, которые отображаются в журнале административных событий реплики хранилища на конечном сервере каждые 10секунд, информируют о количестве скопированных и оставшихся байтов. Также можно использовать счетчик производительности реплики хранилища на узле назначения, который отображает общее количество полученных байтов для одного или нескольких реплицируемых томов (**\Storage Replica Statistics\Total Bytes Received**). Еще можно с помощью Windows PowerShell отправить запрос к группе репликации. Например, команда из этого примера возвращает имена групп на целевом компьютере, а затем каждые 10секунд запрашивает одну группу с именем **Replication2** и отображает ход выполнения задания:  

```  
Get-SRGroup

do{
    $r=(Get-SRGroup -Name "Replication 2").replicas
    [System.Console]::Write("Number of remaining bytes {0}`n", $r.NumOfBytesRemaining)
    Start-Sleep 10
}until($r.ReplicationStatus -eq 'ContinuouslyReplicating')
Write-Output "Replica Status: "$r.replicationstatus

```  

## <a name="FAQ3"></a>Можно ли указать, какие сетевые интерфейсы будут использоваться для репликации?  

Да, с помощью `Set-SRNetworkConstraint`. Этот командлет работает на уровне интерфейсов, как для кластерных развертываний, так и без использования кластеров.  
Пример команды для изолированного сервера (выполнить на каждом узле):  

```  
Get-SRPartnership  

Get-NetIPConfiguration  
```  
Запишите сведения о шлюзе и интерфейсе (на обоих серверах), а также информацию о направлениях партнерства. Далее выполните:  

```  
Set-SRNetworkConstraint -SourceComputerName sr-srv06 -SourceRGName rg02 -  
SourceNWInterface 2 -DestinationComputerName sr-srv05 -DestinationNWInterface 3 -DestinationRGName rg01  

Get-SRNetworkConstraint  

Update-SmbMultichannelConnection  

```  

Чтобы настроить сетевые ограничения для растянутого кластера, выполните:  

    Set-SRNetworkConstraint -SourceComputerName sr-srv01 -SourceRGName group1 -SourceNWInterface "Cluster Network 1","Cluster Network 2" -DestinationComputerName sr-srv03 -DestinationRGName group2 -DestinationNWInterface "Cluster Network 1","Cluster Network 2"  

## <a name="FAQ4"></a> Можно ли настроить репликацию "один ко многим" или транзитивную репликацию (A > B > C)?  
Не в Windows Server2016. Этот выпуск поддерживает только репликацию "один к одному" для сервера, кластера или узла растянутого кластера. Возможно, ситуация изменится в более поздней версии. Конечно, вы можете настроить репликацию в любом направлении между разными серверами определенной пары томов. Например, сервер1 может реплицировать свой том D на сервер2, а свой том E— с сервера3.

## <a name="FAQ5"></a> Можно ли увеличить или уменьшить размер томов, которые реплицирует реплика хранилища?  
Размер тома можно увеличить, но не уменьшить. По умолчанию администраторы не могут увеличивать размер реплицированных томов. Используйте параметр `Set-SRGroup -AllowVolumeResize $TRUE` для исходной группы до изменения размера. Например:

1. Используйте для исходного компьютера: `Set-SRGroup -Name YourRG -AllowVolumeResize $TRUE`
2. Увеличьте размер тома с помощью любого метода.
3. Используйте для исходного компьютера: `Set-SRGroup -Name YourRG -AllowVolumeResize $FALSE` 

## <a name="FAQ6"></a>Можно ли настроить для конечного тома веб-доступ в режиме только для чтения?  
Не в выпуске Windows Server 2016 RTM, также известном как выпуск "RS1". Реплика хранилища отключает конечный том, когда начинается репликация. 

Тем не менее, в Windows Server версии 1709 теперь возможно подключить конечное хранилище. Эта возможность называется тестовой отработкой отказа. Для этого потребуется неиспользуемый том, отформатированный в файловой системе NTFS или ReFS, который на данный момент не реплицируется в конечной системе. Затем можно временно подключить моментальный снимок реплицированного хранилища для тестирования или резервного копирования. 

Например, для проведения тестовой отработки отказа с репликацией тома на диске "D:" в группе репликации "RG2" на конечном сервере "SRV2" и создания нереплицируемого диска "T:" на сервере SRV2 нужно сделать следующее.

 `Mount-SRDestination -Name RG2 -Computername SRV2 -TemporaryPath T:\`
 
Теперь реплицированный том D: доступен на сервере SRV2. Он поддерживает стандартные чтение и запись, копирование файлов с него, а также создание оперативной резервной копии, которая сохраняется в каком-либо другом расположении.

Для удаления моментального снимка тестовой отработки отказа и отмены внесенных им изменений сделайте следующее.

 `Dismount-SRDestination -Name RG2 -Computername SRV2`
 
Тестовую отработку отказа следует использовать только для коротких временных операций. Эта возможность не предназначена для длительного использования. Во время использования этой возможности продолжается репликация на реальный конечный том. 

## <a name="FAQ7"></a>Можно ли настроить масштабируемый файловый сервер (SOFS) в растянутом кластере?  
Технически это возможно, но мы не рекомендуем использовать такую конфигурацию в Windows Server2016, так как вычислительные узлы, контактирующие с SOFS, не имеют достаточной информации о сайтах. В географически компактной сети, где задержки не превышают миллисекунды, такая конфигурация может работать без заметных проблем.   

Для сценариев межкластерной репликации реплика хранилища полностью поддерживает масштабируемые файловые серверы, в том числе использование локальных дисковых пространств при репликации между двумя кластерами.  

## <a name="FAQ8"></a>Можно ли настроить локальные дисковые пространства в растянутом кластере с использованием реплики хранилища?  
Это не поддерживается в Windows Server2016.  Возможно, ситуация изменится в более поздней версии. Для сценариев межкластерной репликации реплика хранилища полностью поддерживает масштабируемые файловые серверы и серверы Hyper-V, в том числе использование локальных дисковых пространств.  

## <a name="FAQ9"></a>Как настроить асинхронную репликацию?  

Выполните `New-SRPartnership -ReplicationMode` с аргументом **Asynchronous**. По умолчанию все репликации в реплике хранилища являются синхронными. Этот режим также можно изменить командлетом `Set-SRPartnership -ReplicationMode`.  

## <a name="FAQ10"></a>Как запретить автоматическую отработку отказа для растянутого кластера?  
Чтобы избежать автоматической отработки отказа, выполните командлет `Get-ClusterNode -Name "NodeName").NodeWeight=0`. Эта операция удаляет голоса с каждого узла на сайте аварийного восстановления. Теперь для принудительной отработки отказа нужно выполнить `Start-ClusterNode -PreventQuorum` на узлах первичного сайта, а затем `Start-ClusterNode -ForceQuorum` на узлах сайта аварийного восстановления. Невозможно отключить автоматическую отработку отказа с помощью графических средств. Рекомендуем никогда не отключать автоматическую отработку отказа.  

## <a name="FAQ11"></a>Как отключить устойчивость виртуальной машины?  
Чтобы новая функция устойчивости виртуальной машины Hyper-V не запускала новые виртуальные машины (что приводит к приостановке работы виртуальной машины вместо отработки отказа), выполните: `(Get-Cluster).ResiliencyDefaultPeriod=0`  

## <a name="FAQ12"></a> Как сократить время начальной синхронизации?  

Для ускорения процесса начальной синхронизации можно использовать хранилище с тонкой подготовкой. Реплика хранилища запрашивает и автоматически использует хранилища с тонкой подготовкой, в том числе некластеризованные дисковые пространства, динамические диски Hyper-V и SAN LUN.  

Можно также использовать заполненные тома данных, чтобы снизить использование пропускной способности, а иногда—и затрачиваемое время. Передайте на целевой том некоторое подмножество данных с источника. Для этого можно применить восстановление из резервной копии, старый моментальный снимок, файлы предыдущей репликации, копирование файлов или другие методы. После этого воспользуйтесь параметром "Заполнено" в диспетчере отказоустойчивости кластеров или командлетом `New-SRPartnership`. Если том практически пуст, использование синхронизации с заполнением может уменьшить затрачиваемое время и использование пропускной способности.

## <a name="FAQ13"></a> Можно ли делегировать выполнение репликации пользователям?  

Вы можете использовать командлет `Grant-SRDelegation` в Windows Server2016. Он позволяет назначить сценарии межсерверной и межкластерной репликации, а также репликации растянутого кластера конкретным пользователям, которые получат разрешения на создание, изменение или удаление репликации, не являясь при этом членами группы локальных администраторов. Например:  

    Grant-SRDelegation -UserName contso\tonywang  

Командлет напомнит, что для вступления этих изменений в силу пользователи должны выйти из системы на сервере, который они будут администрировать, и снова войти в нее. Управлять такими полномочиями можно с помощью `Get-SRDelegation` и `Revoke-SRDelegation`.  

## <a name="FAQ13"></a> Какие есть варианты резервного копирования и восстановления реплицируемых томов?
Реплика хранилища поддерживает резервное копирование и восстановление исходного тома. Она также поддерживает создание и восстановление моментальных снимков исходного тома. Для конечного тома резервное копирование и восстановление невозможны, пока он используется репликой хранилища, так как этот том не подключен и не доступен. Если после аварийной ситуации исходный том будет утрачен, выполните `Set-SRPartnership`, чтобы конечный том стал новым исходным томом. Тогда этот том станет доступен для чтения и записи, и соответственно для резервного копирования или восстановления. Можно также удалить репликацию, выполнив `Remove-SRPartnership` и `Remove-SRGroup`, чтобы получить возможность подключить том для чтения и записи.
Чтобы создавать для реплицируемых томов данных периодические моментальные снимки, согласованные на уровне приложений, можно запустить VSSADMIN.EXE на исходном сервере. Например, если вы используете реплику хранилища для репликации томаF:, выполите:

    vssadmin create shadow /for=F:
Затем вы сможете восстановить такой моментальный снимок до состояния на момент времени на том же исходном томе или на томе назначения (для этого переключите направление репликации или удалите репликацию). Пример команд для того же томаF:

    vssadmin list shadows
     vssadmin revert shadow /shadow={shadown copy ID GUID listed previously}
Можно также настроить периодический запуск этого средства с помощью запланированной задачи. Дополнительные сведения об использовании VSS см. здесь: [Vssadmin](https://technet.microsoft.com/library/cc754968.aspx). Нет никакой необходимости или пользы в резервном копировании томов журналов. VSS будет игнорировать такие попытки.
Реплика хранилища поддерживает использование архивации данных Windows Server, службы архивации Microsoft Azure, Microsoft DPM и других технологий резервного копирования, использующих моментальные снимки, VSS, виртуальные машины или файлы, при условии, что эти технологии работают на уровне тома. Реплика хранилища не поддерживает резервное копирование и восстановление на основе блоков.

## <a name="FAQ14"></a> Можно ли сделать так, чтобы репликация не превышала определенную скорость передачи данных?
Да, с помощью механизма ограничения пропускной способности в протоколе SMB. Эта настройка глобально влияет на весь трафик реплики хранилища, то есть на все операции репликации с определенного сервера. Обычно такие меры нужны только на время начальной синхронизации реплики хранилища, при которой полностью передаются все данные тома. Если у вас возникла такая потребность после начальной синхронизации, значит, пропускная способность вашей сети слишком мала для текущей нагрузки ввода-вывода и следует сократить объем ввода-вывода либо увеличить пропускную способность.

Это ограничение можно использовать только для асинхронной репликации (примечание: начальная синхронизация всегда выполняется асинхронно, даже если указана синхронная репликация).
Также параметры трафика реплики хранилища можно изменять с помощью политик качества обслуживания (QoS). Вы можете существенно снизить нагрузку на пропускную способность сети при начальной синхронизации, если примените для реплики хранилища заполненный том назначения с высоким уровнем сопоставления.


Чтобы задать ограничение пропускной способности, используйте следующую команду:

    Set-SmbBandwidthLimit  -Category StorageReplication -BytesPerSecond x

Чтобы увидеть текущее ограничение пропускной способности, используйте следующую команду:

    Get-SmbBandwidthLimit -Category StorageReplication

Чтобы удалить ограничение пропускной способности, используйте следующую команду:

    Remove-SmbBandwidthLimit -Category StorageReplication
    
## <a name="FAQ15"></a>Какие сетевые порты требует реплика хранилища?
Для репликации и управления реплика хранилища использует протоколы SMB и WSMAN. Это означает, что требуются следующие порты:

   445 (SMB — транспортный протокол репликации) 5445 (iWARP SMB — требуется только при использовании сети RDMA iWARP) 5895 (WSManHTTP — протокол управления для WMI, CIM и PowerShell)

Примечание. Командлет Test-SRTopology требует ICMPv4 или ICMPv6, но не для репликации или управления.

## <a name="FAQ15"></a>Каковы рекомендации по тому журнала?
Оптимальный размер журнала в значительной степени зависит от среды и рабочей нагрузки и определяется объемом операций ввода-вывода, выполняемых рабочей нагрузкой. 

1.  Увеличение или уменьшение размера журнала не влияет на скорость работы.
2.  Например, размер журнала не влияет на скорость обработки тома данных в 10 ГБ или тома данных в 10 ТБ.

Журнал большего размера просто накапливает в себе больше операций ввода-вывода, прежде чем они будут перенесены. За счет этого допустимо более длительное прерывание в работе службы между исходным и конечным компьютером (например, сбой сети или отключение конечного компьютера от сети). Если размера журнала достаточно для хранения 10 часов операций записи и в работе сети происходит сбой продолжительностью 2 часа, при восстановлении сетевого подключения исходный компьютер может просто передать разницу в объемах несинхронизированных изменений обратно на целевой компьютер, после чего защита будет очень быстро восстановлена. Если журнал содержит 10часов операций записи, а продолжительность сбоя составляет 2дня, исходному компьютеру придется считывать данные из другого журнала, называемого битовой картой, и восстановление синхронизированного состояния, скорее всего, будет происходить медленнее. После перехода в синхронный режим исходный компьютер вернется к использованию журнала.

Существуют счетчики производительности SR, которые сообщают о скорости обновления журнала и помогают оценивать текущую ситуацию. Также это делает командлет Test-SRTopology. По сути, просто необходимо следить за операциями ввода-вывода на имеющейся рабочей нагрузке, чтобы определить, сколько операций ввода-вывода будет проходить через журнал в минуту, в час или в день.

Реплика хранилища зависит от журнала для всей производительности записи. Производительность журнала является критически важной для производительности репликации. Необходимо убедиться, что том журнала работает лучше, чем том данных, так как журнал будет определять порядок следования всех операций ввода-вывода, а также выполнять их сериализацию. На томах журнала следует всегда использовать носители на основе флэш-памяти, например SSD. Не следует разрешать другие задачи для выполнения на томе журнала. Аналогично, не разрешайте другие задачи для выполнения на томах журнала базы данных SQL. 

Следует помнить, что корпорация Майкрософт настоятельно рекомендует, чтобы хранилище журналов работало быстрее, чем хранилище данных, и никогда не использовать тома журналов для других рабочих нагрузок.

## <a name="FAQ16"></a> Какие различия между растянутым кластером, межкластерной топологией и межсерверной топологией?  
Реплика хранилища поставляется в трех основных конфигурациях: растянутый кластер, межкластерная топология и межсерверная топология. Каждая конфигурация обладает своими преимуществами.

Топология растянутого кластера оптимально подходит для рабочих нагрузок, требующих автоматической отработки отказа с оркестрацией, например для кластеров частного облака Hyper-V и экземпляров отказоустойчивого кластера SQL Server. Она также имеет встроенный графический интерфейс, работающий на базе диспетчера отказоустойчивости кластеров. В этой топологии используется классическая архитектура общего хранилища асимметричного кластера для дисковых пространств, SAN, iSCSI и RAID через постоянное резервирование. Для выполнения этого кластера достаточно двух узлов.

В основе межкластерной топологии лежат два отдельных кластера, и она идеально подходит для администраторов, которые предпочитают выполнять отработку отказов вручную, особенно в том случае, когда второй узел подготовлен для аварийного восстановления, а не повседневного использования. Оркестрация выполняется вручную. В отличие от растянутого кластера в этой конфигурации можно использовать локальные дисковые пространства. Для выполнения этого кластера достаточно четырех узлов. 

Межсерверная топология оптимально подходит для клиентов, запускающих оборудование, которое нельзя объединить в кластеры. В рамках этой конфигурации отработка отказа и оркестрация выполняются вручную. Эта топология идеально подходит для недорогих развертываний между филиалами и главными центрами обработки данных, особенно при использовании асинхронной репликации. Эту конфигурацию можно часто использовать для замены экземпляров DFSR-защищенных файловых серверов, используемых для монопольных сценариев аварийного восстановления.

Во всех конфигурациях топологии поддерживают выполнение как на физическом оборудовании, так и на виртуальных машинах. При выполнении на виртуальных машинах базовым гипервизором не обязательно должен быть гипервизор Hyper-V; это может быть гипервизор VMware, KVM, Xen и т. д.

Реплика хранилища также поддерживает односерверный режим, в котором репликация выполняется на двух разных томах на одном компьютере.

## <a name="FAQ17"></a> Как сообщить о проблемах, связанных с репликой хранилища или этим руководством?  
Для получения технической поддержки по реплике хранилища можно разместить публикацию [на форумах Microsoft TechNet](https://social.technet.microsoft.com/Forums/windowsserver/en-US/home?forum=WinServerPreview). Также любые вопросы и сообщения, srfeed@microsoft.com имеющие отношение к реплике хранилища или этой документации, можно отправить по электронной почте на адрес. Для запросов на изменение структуры предпочтительнее использовать сайт https://windowsserver.uservoice.com, так как он позволяет вашим клиентам отправлять отзывы о предлагаемых вами идеях.



## <a name="related-topics"></a>Связанные разделы  
- [Общие сведения о реплике хранилища](storage-replica-overview.md) 
- [Репликация растянутого кластера с помощью общего хранилища](stretch-cluster-replication-using-shared-storage.md)  
- [Репликация с сервера в хранилище сервера](server-to-server-storage-replication.md)  
- [Межкластерная репликация хранилища](cluster-to-cluster-storage-replication.md)  
- [Известные проблемы с репликой хранилища](storage-replica-known-issues.md)  

## <a name="see-also"></a>См. также  
- [Общие сведения о хранилище](../storage.md)  
- [Локальные дисковые пространства в Windows Server2016](../storage-spaces/storage-spaces-direct-overview.md)  
