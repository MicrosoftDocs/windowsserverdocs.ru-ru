---
ms.assetid: 13210461-1e92-48a1-91a2-c251957ba256
title: Устранение неполадок обновлений встроенного ПО диска
ms.prod: windows-server
ms.author: toklima
manager: masriniv
ms.technology: storage
ms.topic: article
author: toklima
ms.date: 04/18/2017
ms.openlocfilehash: b62fdfe64ea579f61239dc582c639fb10ec1371c
ms.sourcegitcommit: b00d7c8968c4adc8f699dbee694afe6ed36bc9de
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/08/2020
ms.locfileid: "80820887"
---
# <a name="troubleshooting-drive-firmware-updates"></a>Устранение неполадок обновлений встроенного ПО диска

>Область применения: Windows 10, Windows Server (Semi-Annual Channel),

В Windows 10 версии 1703 и более поздних версиях, а также в Windows Server (Semi-Annual Channel) имеется возможность обновлять встроенное ПО жестких дисков и дисков SSD, которые были сертифицированы с помощью дополнительного квалификатора обновляемого встроенного ПО через PowerShell.

Дополнительные сведения об этом компоненте можно найти здесь:

- [Обновление встроенного по диска в Windows Server 2016](update-firmware.md)
- [Обновление встроенного по диска без простоя в Локальные дисковые пространства](https://channel9.msdn.com/Blogs/windowsserver/Update-Drive-Firmware-Without-Downtime-in-Storage-Spaces-Direct)

Обновление встроенного ПО может завершиться с ошибкой по различным причинам. Эта статья предназначена помочь при выполнении расширенных действий по устранению неполадок.

  > [!Note]
  > Сведения в этой статье, в зависимости от проблемы, могут быть недостаточными для полной отладки всех возможных сбоев.

## <a name="common-issues"></a>Распространенные проблемы
С точки зрения архитектуры эта новая возможность опирается на API, реализованные в стеке хранилища Windows, в который PowerShell направляет вызовы. Стек хранилища зависит от драйверов и оборудования, чтобы правильно реализовывать определенные в отрасли команды. Вследствие этого создаются несколько точек, в которых возникают сбои. Далее перечислены наиболее частые проблемы.

1.  Определенный диск не реализует стандартные команды надлежащим образом (у него отсутствует ДК)
2.  API, необходимые для выполнения обновления, не реализованы или работают со сбоями (если используются драйверы других производителей)
3.  API работают, но существует проблема с самым встроенным ПО (недопустимый или поврежденный образ, …)

В следующих разделах описываются сведения об устранении неполадок, связанных с использованием драйверов Microsoft или сторонних драйверов.

## <a name="identifying-inappropriate-hardware"></a>Определение недопустимого оборудования
Самый быстрый способ определить, поддерживает ли устройство правильный набор команд, — просто запустить PowerShell и передать объект PhysicalDisk, представляющий диск, в командлет Get-StorageFirmwareInfo. Пример.

```powershell
Get-PhysicalDisk -SerialNumber 15140F55976D | Get-StorageFirmwareInformation
```
Вот пример выходных данных:

```
PhysicalDisk          : MSFT_PhysicalDisk (ObjectId = "{1}\\TOKLIMA-DL380\root/Microsoft/Windo...)
SupportsUpdate        : True
NumberOfSlots         : 1
ActiveSlotNumber      : 0
SlotNumber            : {0}
IsSlotWritable        : {True}
FirmwareVersionInSlot : {0013}
```

Поле SupportsUpdate, по крайней мере для устройств SATA и NVMe, будет указывать, может ли использоваться встроенная функция PowerShell для обновления встроенного ПО.

Поле SupportsUpdate всегда будет отображать значение True для последовательно подключенных устройств SAS, так как запросы на поддержку соответствующей команды невозможны с помощью стандартных отраслевых команд.

Чтобы проверить, поддерживает ли устройство SAS набор необходимых команд, существует два варианта:
1.  Попробуйте воспользоваться командлетом Update-StorageFirmware с изображением соответствующего образа, или
2.  Просмотрите каталог Windows Server, чтобы узнать, какие устройства SAS успешно получили обновление FW AQ (https://www.windowsservercatalog.com/)

### <a name="remediation-options"></a>Параметры исправлений
Если тестируемое вами устройство не поддерживает соответствующий набор команд, обратитесь к поставщику, чтобы узнать о наличии обновленного встроенного ПО с набором необходимых команд, или обратитесь к Каталогу Windows Server для определения устройств, способных реализовать набор соответствующих команд.

## <a name="troubleshooting-with-3rd-party-drivers-sas"></a>Устранение неполадок сторонних драйверов (SAS)
Компонентами программного обеспечения, наиболее тесно взаимодействующими с оборудованием, являются драйверы мини-портов в стеке хранилища Windows. Для некоторых протоколов хранилища, например SATA и NVMe, корпорация Майкрософт предоставляет собственные драйверы для Windows. Эти драйверы предоставляют дополнительную информацию об отладке. Однако поставщики стороннего оборудования и программного обеспечения имеют полную свободу написания собственных драйверов мини-порта для своих устройств. При этом уровень их поддержки для информации об отладке может быть разным.

Чтобы определить, что произошло со встроенным ПО, скачайте и активируйте API, отправленные в стек хранилища, независимо от драйвера мини-порта. Обратитесь к следующему каналу журнала:

Просмотр событий — Журналы приложений и служб — Microsoft — Windows — StorDiag — **Microsoft-Windows-Storage-ClassPnP/Operational**

Этот канал записывает сведения об API Windows, отправляемых драйверам мини-порта, а также их ответы. Например, состояние ошибки, показанное непосредственно ниже, проявляется при попытке скачать образ встроенного ПО на устройство SATA, подключенное через HBA SAS, которое не реализует надлежащим образом необходимый перевод из SAS в SATA:

```powershell
Get-PhysicalDisk -SerialNumber 44GS103UT5EW | Update-StorageFirmware -ImagePath C:\Firmware\J3E160@3.enc -SlotNumber 0
```
Ниже приведен пример выходных данных.

```
Update-StorageFirmware : Failed

Extended information:
A warning or error has been encountered during storage firmware update.
Incorrect function.

Activity ID: {1224482b-2315-4a38-81eb-27bb7de19c00}
At line:1 char:47
+ ... S103UT5EW | Update-StorageFirmware -ImagePath C:\Firmware\J3E160@3.en ...
+                 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
+ CategoryInfo          : NotSpecified: (:) [Update-StorageFirmware], CimException
+ FullyQualifiedErrorId : StorageWMI 4,Microsoft.Management.Infrastructure.CimCmdlets.InvokeCimMethodCommand,Update-StorageFirmware
```
    
PowerShell вызовет ошибку и получит информацию о том, что вызванная функция (то есть Kernel API) является неправильной. Это может означать, что API не реализован драйвером мини-порта стороннего устройства SAS (значение true в этом случае) или сбой API произошел по другой причине, например из-за рассогласования сегментов скачивания.

```
EventData
DeviceGUID  {132EDB55-6BAC-A3A0-C2D5-203C7551D700}
DeviceNumber    1
Vendor  ATA 
Model   TOSHIBA THNSNJ12
FirmwareVersion 6101
SerialNumber    44GS103UT5EW
DownLevelIrpStatus  0xc0000185
SrbStatus   132
ScsiStatus  2
SenseKey    5
AdditionalSenseCode 36
AdditionalSenseCodeQualifier    0
CdbByteCount    10
CdbBytes    3B0E0000000001000000
NumberOfRetriesDone 0
```

Событие трассировки событий Windows 507 из канала показывает, что сбой запроса SCSI СРБ и предоставление дополнительных сведений, которые Сенсекэй был "5" (недопустимый запрос), а Аддитионалсенсе сведения были "36" (недопустимое поле в CDB).

   > [!Note]
   > Эта информация предоставляется непосредственно соответствующим мини-портом, и точность этих сведений будут зависеть от реализации и усовершенствования драйвера мини-порта.

Возможно, разные состояния ошибки будут вызывать одинаковые коды ошибок, если драйвер мини-порта не разграничит их. Например, попытка скачать недопустимый образ встроенного ПО через SAS HBA на устройство SATA (на котором ожидается ошибка) может быть переведена в аналогичные коды ошибок.

В случаях, в которых смешиваются протоколы и происходят переводы, т. е. SATA за SAS, лучше всего проверять устройство SATA с прямым подключением к контроллеру SATA, чтобы исключить его потенциальные проблемы.

### <a name="remediation-options"></a>Параметры исправлений
Если сторонний драйвер будет определен как таковой, что не реализует необходимые API или переводы, можно перейти на предоставленные корпорацией Майкрософт альтернативы для SATA (StorAHCI.sys) и NVMe (StorNVMe.sys) или обратиться к изготовителю OEM или HBA, который предоставил драйвер SAS, и спросить о существовании более новой версии с надлежащей поддержкой.

## <a name="additional-troubleshooting-with-microsoft-drivers-satanvme"></a>Дополнительное устранение неполадок в драйверах Microsoft (SATA/NVMe)
Когда встроенные драйверы Windows, например StorAHCI.sys или StorNVMe.sys, используются для хранения данных устройства управления питанием, можно получить дополнительные сведения о возможных случаях сбоев во время обновления встроенного ПО.

Помимо операционного канала Класспнп, СторахЦи и Сторнвме будут регистрировать коды возврата, относящиеся к протоколу устройства, в следующем канале ETW:

Просмотр событий — Журналы приложений и служб — Microsoft — Windows — StorDiag — **Microsoft-Windows-Storage-StorPort/Diagnose**

Журналы диагностики не отображаются по умолчанию и могут быть активированы или показаны выбором команды "Просмотр" в EventViewer и элемента "Показать журналы аналитики и отладки" из раскрывающего меню.

Для сбора этих расширенных записей журнала включите журнал, воспроизведите сбой обновления встроенного ПО и сохраните журнал диагностики.

Вот пример обновления встроенного ПО на неисправном устройстве SATA из-за недопустимого образа для скачивания (код события: 258):

``` 
EventData
MiniportName    storahci
MiniportEventId 19
MiniportEventDescription    Firmware Activate Completion
PortNumber  0
Bus 2
Target  0
LUN 0
Irp 0xffff8c84cd45aca0
Srb 0xffffab0024030bc0
Parameter1Name  SrbStatus
Parameter1Value 130
Parameter2Name  ReturnCode
Parameter2Value 0
Parameter3Name  FeaturesReg
Parameter3Value 15
Parameter4Name  SectorCountReg
Parameter4Value 0
Parameter5Name  DriveHeadReg
Parameter5Value 160
Parameter6Name  CommandReg
Parameter6Value 146
Parameter7Name  NULL
Parameter7Value 0
Parameter8Name  NULL
Parameter8Value 0
```

Указанное выше событие содержит подробные сведения об устройстве в значениях параметров 2–6. Здесь мы рассматриваем различные значения регистров ATA. Спецификации ACS ATA можно использовать для декодирования указанных ниже значений для сбоя команды Download Microcode:
- Код возврата: 0 (0000 0000) (Н/Д — бессмысленно, так как не передавалась рабочая нагрузка)
- Функции: 15 (0000 1111) (бит 1 имеет значение "1" и указывает "Abort")
- SectorCount: 0 (0000 0000) (Н/Д)
- DriveHead: 160 (1010 0000) (Н/Д — настраиваются только устаревшие биты)
- Команда: 146 (1001 0010) (бит 1 имеет значение "1", указывающее на доступность осмысленных данных)

Это сообщает нам, что операция обновления встроенного ПО была прервана устройством.

Аналогичный уровень сведений об отладке доступен в этом канале при использовании устройств NVMe со встроенным драйвером Windows для NVMe (StorNVMe.sys).
