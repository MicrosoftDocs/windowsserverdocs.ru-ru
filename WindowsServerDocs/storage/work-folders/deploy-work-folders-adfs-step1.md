---
description: 'Дополнительные сведения см. в статье Развертывание рабочих папок с помощью AD FS и прокси веб-приложения: шаг 1, настройка AD FS'
title: Развертывание рабочих папок с помощью AD FS и прокси-службы веб-приложения. Шаг 1. Настройка AD FS
ms.topic: article
manager: klaasl
ms.author: jeffpatt
author: JeffPatt24
ms.date: 10/18/2018
ms.assetid: 938cdda2-f17e-4964-9218-f5868fd96735
ms.openlocfilehash: 0cb9e88455a6c7c1b3d917a8ad839d7f7217a6a3
ms.sourcegitcommit: 65b6de6b44d41f1180c45db11cdd60cb2a093b46
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/10/2020
ms.locfileid: "97048582"
---
# <a name="deploy-work-folders-with-ad-fs-and-web-application-proxy-step-1-set-up-ad-fs"></a>Развертывание рабочих папок с помощью AD FS и прокси-службы веб-приложения. Шаг 1. Настройка AD FS

>Применяется к: Windows Server (Semi-Annual Channel), Windows Server 2016

В этой статье описывается первый шаг процесса развертывания рабочих папок с помощью службы федерации Active Directory (AD FS) и прокси-службы веб-приложения. Другие шаги этого процесса можно найти в следующих статьях:

-   [Развертывание рабочих папок с помощью AD FS и прокси веб-приложения: обзор](deploy-work-folders-adfs-overview.md)

-   [Развертывание рабочих папок с помощью AD FS и прокси-службы веб-приложения. Шаг 2. Действия после настройки AD FS](deploy-work-folders-adfs-step2.md)

-   [Развертывание рабочих папок с помощью AD FS и прокси-службы веб-приложения. Шаг 3. Настройка рабочих папок](deploy-work-folders-adfs-step3.md)

-   [Развертывание рабочих папок с помощью AD FS и прокси-службы веб-приложения. Шаг 4. Настройка прокси-службы веб-приложения](deploy-work-folders-adfs-step4.md)

-   [Развертывание рабочих папок с помощью AD FS и прокси-службы веб-приложения. Шаг 5. Настройка клиентов](deploy-work-folders-adfs-step5.md)

> [!NOTE]
>   Инструкции, описанные в этом разделе, предназначены для среды Windows Server 2019 или Windows Server 2016. Если вы используете Windows Server 2012 R2, следуйте [инструкциями для Windows Server 2012 R2](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/dn747208(v=ws.11)).

Чтобы настроить AD FS для использования с рабочими папками, выполните следующие процедуры.

## <a name="pre-installment-work"></a>Подготовка к установке
Если вы собираетесь преобразовать тестовую среду, которую настраиваете с помощью этих инструкций, в рабочую, следует выполнить два действия перед началом работы:

-   настроить учетную запись администратора домена Active Directory для запуска службы AD FS;

-   получить SSL-сертификат с альтернативным именем субъекта для проверки подлинности сервера. В рамках тестового примера вы будете использовать самозаверяющий сертификат, но в рабочей среде следует использовать открытый доверенный сертификат.

В зависимости от политик вашей компании получение учетной записи и сертификата может занять некоторое время, поэтому следует приступить к их запросу перед началом создания тестовой среды.

Существует множество коммерческих центров сертификации, в которых можно приобрести сертификат. Список центров сертификации, которым доверяет корпорация Майкрософт, можно найти в [статье базы знаний 931125](https://support.microsoft.com/kb/931125). Вы также можете получить сертификат в корпоративном центре сертификации вашей компании.

В тестовой среде вы будете использовать самозаверяющий сертификат, созданный одним из предоставленных сценариев.

> [!NOTE]
> Служба AD FS не поддерживает сертификаты криптографии следующего поколения (CNG), то есть вы не можете создать самозаверяющий сертификат с помощью командлета New-SelfSignedCertificate Windows PowerShell. Но вы можете использовать сценарий makecert.ps1 в составе записи блога [Развертывание рабочих папок с помощью AD FS и прокси-службы веб-приложения](https://techcommunity.microsoft.com/t5/storage-at-microsoft/deploying-work-folders-with-ad-fs-and-web-application-proxy-wap/ba-p/425318). Этот сценарий создает самозаверяющий сертификат, работающий с AD FS, и запрашивает имена SAN, которые потребуются для создания сертификата.

Далее выполните дополнительные действия по подготовке к установке, описанные в следующих разделах.

### <a name="create-an-ad-fs-self-signed-certificate"></a>Создание самозаверяющего сертификата AD FS
Чтобы создать самозаверяющий сертификат AD FS, сделайте следующее.

1.  Скачайте сценарии из записи блога [Развертывание рабочих папок с помощью AD FS и прокси-службы веб-приложения](https://techcommunity.microsoft.com/t5/storage-at-microsoft/deploying-work-folders-with-ad-fs-and-web-application-proxy-wap/ba-p/425318), а затем скопируйте файл makecert.ps1 на компьютер AD FS.

2.  Откройте окно Windows PowerShell с правами администратора.

3.  Сделайте политику выполнения неограниченной:

    ```powershell
    Set-ExecutionPolicy –ExecutionPolicy Unrestricted
    ```

4.  Измените на каталог, в который скопирован сценарий.

5.  Выполните сценарий makecert:

    ```powershell
    .\makecert.ps1
    ```

6.  При появлении запроса на изменение сертификата субъекта введите новое значение для субъекта. В этом примере используется значение **blueadfs.contoso.com**.

7.  При запросе на ввод имен SAN нажмите клавишу Y и введите имена SAN по очереди.

    В этом примере введите **blueadfs.contoso.com**, нажмите клавишу ВВОД, затем введите **2016-adfs.contoso.com**, нажмите клавишу ВВОД, после чего введите **enterpriseregistration.contoso.com** и нажмите клавишу ВВОД.

    После ввода всех имен SAN нажмите клавишу ВВОД на пустой строке.

8.  При появлении запроса на установку сертификатов в хранилище доверенных корневых центров сертификации нажмите клавишу Y.

Сертификат AD FS должен быть сертификатом SAN со следующими значениями:

-   имя службы AD FS.домен

-   enterpriseregistration.домен

-   имя сервера AD FS.домен

В тестовом примере используются следующие значения:

-   **blueadfs.contoso.com**

-   **enterpriseregistration.contoso.com**

-   **2016-adfs.contoso.com**

SAN enterpriseregistration требуется для Workplace Join.

### <a name="set-the-server-ip-address"></a>Установка IP-адреса сервера
Измените IP-адрес сервера на статический IP-адрес. В тестовом примере используется IP-адрес класса A, а именно 192.168.0.160 / маска подсети: 255.255.0.0 / Шлюз по умолчанию: 192.168.0.1 / Основной DNS-сервер: 192.168.0.150 (IP-адрес контроллера домена\).

## <a name="install-the-ad-fs-role-service"></a>Установка службы роли AD FS
Для установки AD FS выполните следующие действия:

1.  Войдите на физический или виртуальный компьютер, на котором требуется установить AD FS, откройте **диспетчер сервера** и запустите мастер добавления ролей и компонентов.

2.  На странице **Роли сервера** выберите роль **Службы федерации Active Directory (AD FS)** и нажмите кнопку **Далее**.

3.  На странице **Службы федерации Active Directory (AD FS)** отобразится сообщение о том, что прокси-службу веб-приложения нельзя установить на компьютер с AD FS. Нажмите кнопку **Далее**.

4.  Нажмите **Установить** на странице подтверждения.

Чтобы выполнить такую же установку AD FS через Windows PowerShell, используйте следующие команды:

```powershell
Add-WindowsFeature RSAT-AD-Tools
Add-WindowsFeature ADFS-Federation –IncludeManagementTools
```

## <a name="configure-ad-fs"></a>Настройка службы федерации Active Directory
Далее настройте AD FS с помощью диспетчера сервера или Windows PowerShell.

### <a name="configure-ad-fs-by-using-server-manager"></a>Настройка AD FS с помощью диспетчера сервера
Чтобы настроить AD FS с помощью диспетчера сервера, выполните следующие действия.

1.  Откройте диспетчер сервера.

2.  Щелкните флаг **Уведомления** в верхней части окна диспетчера сервера и нажмите **Настроить службу федерации на этом сервере**.

3.  Откроется мастер настройки службы федерации Active Directory (AD FS). На странице **Подключение к AD DS** введите учетную запись администратора домена, которую требуется использовать в качестве учетной записи AD FS, и нажмите **Далее**.

4.  На странице **Укажите свойства службы** введите имя субъекта SSL-сертификата, которое следует использовать для обмена данными с AD FS. В тестовом примере используется имя **blueadfs.contoso.com**.

5.  Введите имя службы федерации. В тестовом примере используется имя **blueadfs.contoso.com**. Нажмите кнопку **Далее**.

    > [!NOTE]
    > Имя службы федерации не должно совпадать с именем существующего в среде сервера. Если вы используете имя существующего сервера, установка AD FS завершится ошибкой и потребует перезапуска.

6.  На странице **Укажите учетную запись службы** введите имя, которое следует использовать для управляемой учетной записи службы. В тестовом примере выберите **Создать групповую управляемую учетную запись службы** и в поле **Имя учетной записи** введите **ADFSService**. Нажмите кнопку **Далее**.

7.  На странице **Указание базы данных конфигурации** выберите **создать базу данных на этом сервере с помощью внутренней базы данных Windows** и нажмите кнопку **Далее**.

8.  На странице **Просмотр параметров** представлены общие сведения о выбранных параметрах. Нажмите кнопку **Далее**.

9. На странице **Предварительные проверки** указано, все ли предварительные проверки пройдены успешно. Если проблем нет, нажмите **Настройка**.

    > [!NOTE]
    > Если вы использовали имя сервера AD FS или любого другого существующего компьютера в качестве имени службы федерации, отобразится сообщение об ошибке. Необходимо заново начать установку и выбрать имя, отличное от имени любого существующего компьютера.

10. После успешного завершения настройки на странице **Результаты** отображается подтверждение успешной настройки AD FS.

### <a name="configure-ad-fs-by-using-powershell"></a>Настройка AD FS с помощью PowerShell
Чтобы выполнить такую же настройку AD FS через Windows PowerShell, используйте следующие команды.

Установка AD FS:

```powershell
Add-WindowsFeature RSAT-AD-Tools
Add-WindowsFeature ADFS-Federation -IncludeManagementTools
```

Создание управляемой учетной записи службы:

```powershell
New-ADServiceAccount "ADFSService"-Server 2016-DC.contoso.com -Path "CN=Managed Service Accounts,DC=Contoso,DC=COM" -DNSHostName 2016-ADFS.contoso.com -ServicePrincipalNames HTTP/2016-ADFS,HTTP/2016-ADFS.contoso.com
```

После настройки AD FS необходимо настроить ферму AD FS с помощью управляемой учетной записи службы, созданной на предыдущем шаге, и сертификата, созданного при подготовке к настройке.

Настройка фермы AD FS:

```powershell
$cert = Get-ChildItem CERT:\LocalMachine\My |where {$_.Subject -match blueadfs.contoso.com} | sort $_.NotAfter -Descending | select -first 1 
$thumbprint = $cert.Thumbprint
Install-ADFSFarm -CertificateThumbprint $thumbprint -FederationServiceDisplayName "Contoso Corporation" –FederationServiceName blueadfs.contoso.com -GroupServiceAccountIdentifier contoso\ADFSService$ -OverwriteConfiguration -ErrorAction Stop
```

Следующий шаг: [Развертывание рабочих папок с помощью AD FS и прокси-службы веб-приложения. Шаг 2. Действия после настройки AD FS](deploy-work-folders-adfs-step2.md)

## <a name="see-also"></a>См. также:
[Обзор рабочих папок](Work-Folders-Overview.md)

