---
title: Развертывание рабочих папок с помощью AD FS и прокси-службы веб-приложения. Шаг 3. Настройка рабочих папок
ms.prod: windows-server
ms.technology: storage-work-folders
ms.topic: article
manager: klaasl
ms.author: jeffpatt
author: JeffPatt24
ms.date: 4/5/2017
ms.assetid: 5a43b104-4d02-4d73-a385-da1cfb67e341
ms.openlocfilehash: ef76b87928e696586356c499367051ff0d0e9ab4
ms.sourcegitcommit: 6aff3d88ff22ea141a6ea6572a5ad8dd6321f199
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/27/2019
ms.locfileid: "71365768"
---
# <a name="deploy-work-folders-with-ad-fs-and-web-application-proxy-step-3-set-up-work-folders"></a>Развертывание рабочих папок с помощью AD FS и прокси веб-приложения: Шаг 3. Настройка рабочих папок

>Относится к: Windows Server (Semi-Annual Channel), Windows Server 2016

В этой статье описывается третий шаг процесса развертывания рабочих папок с помощью службы федерации Active Directory (AD FS) и прокси-службы веб-приложения. Другие шаги этого процесса можно найти в следующих статьях:  
  
-   [Deploy рабочие папки с AD FS и прокси веб-приложения: Средств](deploy-work-folders-adfs-overview.md)  
  
-   [Deploy рабочие папки с AD FS и прокси веб-приложения: Шаг 1. Настройка AD FS @ no__t-0  
  
-   [Deploy рабочие папки с AD FS и прокси веб-приложения: Шаг 2 AD FS действия после настройки @ no__t-0  
  
-   [Deploy рабочие папки с AD FS и прокси веб-приложения: Шаг 4. Настройка прокси веб-приложения @ no__t-0  
  
-   [Deploy рабочие папки с AD FS и прокси веб-приложения: Шаг 5. Настройка клиентов @ no__t-0  
  
> [!NOTE]
>   Инструкции, описанные в этом разделе, предназначены для среды Windows Server 2019 или Windows Server 2016. Если вы используете Windows Server 2012 R2, следуйте [инструкциями для Windows Server 2012 R2](https://technet.microsoft.com/library/dn747208(v=ws.11).aspx).

Для настройки рабочих папок используйте следующие процедуры.  
  
## <a name="pre-installment-work"></a>Подготовка к установке  
Для установки рабочих папок вам потребуется присоединенный к домену сервер под управлением Windows Server 2016. На этом сервере должна быть допустимая конфигурация сети.  
  
Для тестового примера присоедините компьютер, на котором будут запущены рабочие папки, к домену Contoso и настройте сетевой интерфейс, как описано в следующих разделах. 

### <a name="set-the-server-ip-address"></a>Установка IP-адреса сервера  
Измените IP-адрес сервера на статический IP-адрес. Для примера теста используйте класс IP-адреса A, который является 192.168.0.170/маской подсети. 255.255.0.0 и шлюз по умолчанию: 192.168.0.1/предпочтительный DNS: 192.168.0.150 (IP-адрес контроллера домена). 
  
### <a name="create-the-cname-record-for-work-folders"></a>Создание записи CNAME для рабочих папок  
Чтобы создать запись CNAME для рабочих папок, выполните следующие действия:  
  
1.  На контроллере домена откройте раздел **Диспетчер DNS**.  
  
2.  Разверните папку "Зоны прямого просмотра", щелкните правой кнопкой мыши домен и нажмите **Новый псевдоним (CNAME)** .  
  
3.  В окне **Новая запись ресурса** в поле **Имя псевдонима** введите псевдоним для рабочих папок. В тестовом примере используется имя **workfolders**.  
  
4.  В поле **Полное доменное имя** должно быть значение **workfolders.contoso.com**.  
  
5.  В поле **Полное доменное имя для целевого узла** введите FQDN для сервера рабочих папок. В тестовом примере используется имя **2016-WF.contoso.com**.  
  
6.  Нажмите кнопку **ОК**.  
  
Чтобы выполнить те же действия через Windows PowerShell, используйте следующую команду. Команду необходимо выполнить на контроллере домена.  
  
```powershell  
Add-DnsServerResourceRecord  -ZoneName "contoso.com" -Name workfolders -CName  -HostNameAlias 2016-wf.contoso.com   
```  
  
### <a name="install-the-ad-fs-certificate"></a>Установка сертификата AD FS  
Установите сертификат AD FS, созданный при настройке AD FS, в хранилище сертификатов на локальном компьютере. Для этого выполните следующие действия.  
  
1.  Нажмите кнопку **Пуск** и выберите команду **Выполнить**.  
  
2.  Введите **MMC**.  
  
3.  В меню **Файл** выберите команду **Добавить или удалить оснастку**.  
  
4.  В списке **Доступные оснастки** выберите пункт **Сертификаты** и нажмите кнопку **Добавить**. Запустится мастер оснастки сертификатов.  
  
5.  Выберите **Учетная запись компьютера** и нажмите кнопку **Далее**.  
  
6.  Выберите **Локальный компьютер: (компьютер, на котором запущена эта консоль)** и нажмите кнопку **Готово**.  
  
7.  Нажмите кнопку **ОК**.  
  
8.  Разверните папку **Console Root\Certificates\(Local Computer)\Personal\Certificates**.  
  
9. Щелкните правой кнопкой мыши **Сертификаты**, нажмите **Все задачи**, а затем — **Импорт...** .  
  
10. Найдите папку с сертификатом AD FS и следуйте инструкциям в мастере, чтобы импортировать файл и поместить его в хранилище сертификатов.

11. Разверните папку **Console Root\Certificates\(Local Computer)\Trusted Root Certification Authorities\Certificates**.  
  
12. Щелкните правой кнопкой мыши **Сертификаты**, нажмите **Все задачи**, а затем — **Импорт...** .  
  
13. Найдите папку с сертификатом AD FS и следуйте инструкциям в мастере, чтобы импортировать файл и поместить его в хранилище доверенных корневых центров сертификации.  
  
### <a name="create-the-work-folders-self-signed-certificate"></a>Создание самозаверяющего сертификата рабочих папок  
Чтобы создать самозаверяющий сертификат рабочих папок, выполните следующие действия.  
  
1.  Скачайте сценарии из записи блога [Развертывание рабочих папок с помощью AD FS и прокси-службы веб-приложения](https://blogs.technet.microsoft.com/filecab/2014/03/03/deploying-work-folders-with-ad-fs-and-web-application-proxy-wap), а затем скопируйте файл makecert.ps1 на компьютер с рабочими папками.  
  
2.  Откройте окно Windows PowerShell с правами администратора.  
  
3.  Сделайте политику выполнения неограниченной:  
  
    ```powershell  
    PS C:\temp\scripts> Set-ExecutionPolicy -ExecutionPolicy Unrestricted   
    ```  
  
4.  Измените на каталог, в который скопирован сценарий.  
  
5.  Выполните сценарий makeCert:  
  
    ```powershell  
    PS C:\temp\scripts> .\makecert.ps1  
    ```  
  
6.  При появлении запроса на изменение сертификата субъекта введите новое значение для субъекта. В этом примере используется значение **workfolders.contoso.com**.  
  
7.  При запросе на ввод имен SAN нажмите клавишу Y и введите альтернативные имена субъектов (SAN) по очереди.  
  
    В этом примере введите **workfolders.contoso.com** и нажмите клавишу ВВОД. Затем введите **2016-WF.contoso.com** и нажмите клавишу ВВОД.  
  
    После ввода всех имен SAN нажмите клавишу ВВОД на пустой строке.  
  
8.  При появлении запроса на установку сертификатов в хранилище доверенных корневых центров сертификации нажмите клавишу Y.  
  
Сертификат рабочих папок должен быть сертификатом SAN со следующими значениями:  
  
-   **workfolders**.**домен**  
  
-   **имя компьютера**.**домен**  
  
В тестовом примере используются следующие значения:  
  
-   **workfolders.contoso.com**  
  
-   **2016-WF.contoso.com**  
  
## <a name="install-work-folders"></a>Установка рабочих папок  
Чтобы установить роль рабочих папок, выполните следующие действия:  
  
1.  Откройте **Диспетчер сервера**, нажмите **Добавить роли и компоненты**, а затем нажмите кнопку **Далее**.  
  
2.  На странице **Тип установки** выберите раздел **Установка на основе ролей или компонентов**, а затем нажмите **Далее**.  
  
3.  На странице **Выбор сервера** выберите текущий сервер и нажмите кнопку **Далее**.  
  
4.  На странице **Роли сервера** разверните **Файловые службы и службы хранилища**, разверните **Файловые службы и службы iSCSI**, а затем выберите **Рабочие папки**.  
  
5.  На странице **Мастер добавления ролей и компонентов** щелкните **Добавить компоненты**и нажмите кнопку **Далее**.  
  
6.  На странице **Компоненты** нажмите кнопку **Далее**.  
  
7.  На странице **подтверждения** нажмите кнопку **Установить**.  
  
## <a name="configure-work-folders"></a>Настройка рабочих папок  
Чтобы настроить рабочие папки, выполните следующие действия:  
  
1.  Откройте **Диспетчер сервера**.  
  
2.  Выберите **Файловые службы и службы хранилища**, а затем — **Рабочие папки**.  
  
3.  на странице **Рабочие папки** запустите **Мастер создания общих ресурсов синхронизации** и нажмите кнопку **Далее**.  
  
4.  На странице **Сервер и путь** выберите сервер, на котором следует создать общий ресурс синхронизации, введите локальный путь к месту хранения данных рабочих папок и нажмите кнопку **Далее**.  
  
    Если путь не существует, вам будет предложено создать его. Нажмите кнопку **ОК**.  
  
5.  На странице **Структура папок пользователя** выберите **Псевдоним пользователя** и нажмите кнопку **Далее**.  
  
6.  На странице **Имя общего ресурса синхронизации** введите имя общего ресурса синхронизации. В тестовом примере используется имя **WorkFolders**. Нажмите кнопку **Далее**.  
  
7.  На странице **Доступ к синхронизации** добавьте пользователей или группы, у которых будет доступ к новому общему ресурсу синхронизации. В тестовом примере предоставьте доступ всем пользователям домена. Нажмите кнопку **Далее**.  
  
8.  На странице **Политики безопасности компьютеров** выберите **Шифровать рабочие папки** и **Автоматически блокировать страницу и требовать пароль**. Нажмите кнопку **Далее**.  
  
9. На странице **Подтверждение** нажмите кнопку **Создать**, чтобы завершить процесс настройки.  
  
## <a name="work-folders-post-configuration-work"></a>Действия с рабочими папками после настройки  
Чтобы завершить настройку рабочих папок, выполните следующие дополнительные шаги:  
  
-   Привязка сертификата рабочих папок к порту SSL  
  
-   Настройка рабочих папок для использования проверки подлинности AD FS  
  
-   Экспорт сертификата рабочих папок (если вы используете самозаверяющий сертификат)  
  
### <a name="bind-the-certificate"></a>Привязка сертификата  
Рабочие папки обмениваются данными только по протоколу SSL и требуют привязки ранее созданного (или выданного центром сертификации) самозаверяющего сертификата к порту.  
  
Существует два способа привязки сертификата к порту через Windows PowerShell: Командлеты IIS и Netsh.  
  
#### <a name="bind-the-certificate-by-using-netsh"></a>Привязка сертификата с помощью netsh  
Чтобы воспользоваться служебной программой на базе командной строки netsh в Windows PowerShell, команду необходимо передать по конвейеру в netsh. Сценарий в следующем примере находит сертификат с субъектом **workfolders.contoso.com** и привязывает его к порту 443 с помощью netsh:  
  
```powershell  
$subject = "workfolders.contoso.com"   
Try  
{  
#In case there are multiple certificates with the same subject, get the latest version   
$cert = Get-ChildItem CERT:\LocalMachine\My |where {$_.Subject -match $subject} | sort $_.NotAfter -Descending | select -first 1    
$thumbprint = $cert.Thumbprint  
$Command = "http add sslcert ipport=0.0.0.0:443 certhash=$thumbprint appid={CE66697B-3AA0-49D1-BDBD-A25C8359FD5D} certstorename=MY"  
$Command | netsh  
}  
Catch  
{  
"     Error: unable to locate certificate for $($subject)"  
Exit  
}   
```  
  
#### <a name="bind-the-certificate-by-using-iis-cmdlets"></a>Привязка сертификата с помощью командлетов IIS  
Вы также можете привязать сертификат к порту с помощью командлетов управления IIS, которые доступны после установки средств и сценариев управления IIS.  
  
> [!NOTE]  
> Установка средств управления IIS не предоставляет полную версию служб IIS на компьютере с рабочими папками, а только позволяет использовать командлеты управления. У этой конфигурации есть несколько потенциальных преимуществ. Например, если вы надеетесь получить возможности netsh при использовании командлетов. Если сертификат привязан к порту с помощью командлета New-WebBinding, привязка никаким образом не зависит от IIS. После привязки вы даже можете удалить компонент Web-Mgmt-Console, а сертификат останется привязанным к порту. Вы можете проверить привязку через netsh. Для этого введите **netsh http show sslcert**.  
  
В следующем примере командлет New-WebBinding используется для поиска сертификата с субъектом **workfolders.contoso.com** и его привязки к порту 443.  
  
```powershell  
$subject = "workfolders.contoso.com"  
Try  
{  
#In case there are multiple certificates with the same subject, get the latest version   
$cert =Get-ChildItem CERT:\LocalMachine\My |where {$_.Subject -match $subject } | sort $_.NotAfter -Descending | select -first 1   
$thumbprint = $cert.Thumbprint  
New-WebBinding -Name "Default Web Site" -IP * -Port 443 -Protocol https  
#The default IIS website name must be used for the binding. Because Work Folders uses Hostable Web Core and its own configuration file, its website name, 'ECSsite', will not work with the cmdlet. The workaround is to use the default IIS website name, even though IIS is not enabled, because the NewWebBinding cmdlet looks for a site in the default IIS configuration file.   
Push-Location IIS:\SslBindings  
Get-Item cert:\LocalMachine\MY\$thumbprint | new-item *!443  
Pop-Location  
}  
Catch  
{  
"     Error: unable to locate certificate for $($subject)"  
Exit  
}   
```  
  
### <a name="set-up-ad-fs-authentication"></a>Настройка проверки подлинности через AD FS  
Чтобы настроить рабочие папки на использование AD FS для проверки подлинности, выполните следующие действия.  
  
1.  Откройте **Диспетчер сервера**.  
  
2.  Нажмите **Серверы** и выберите сервер рабочих папок из списка.  
  
3.  Щелкните правой кнопкой мыши имя сервера и выберите команду **Параметры рабочих папок**.  
  
4.  В окне **Параметры рабочих папок** выберите **Службы федерации Active Directory (AD FS)** и введите URL-адрес службы федерации. Щелкните **Применить**.  
  
    В примере теста URL-адрес имеет значение **https://blueadfs.contoso.com** .  
  
Для выполнения этой же задачи через Windows PowerShell используется следующий командлет:  
  
```powershell  
Set-SyncServerSetting -ADFSUrl "https://blueadfs.contoso.com"   
```  
  
Если вы настраиваете AD FS с использованием самозаверяющих сертификатов, вы можете получить сообщение об ошибке, в котором говорится, что URL-адрес службы федерации неверен, недоступен или что отношения доверия с проверяющей стороной не настроены.  
  
Эта ошибка также может возникнуть, если сертификат AD FS не установлен на сервере рабочих папок или если запись CNAME для AD FS настроена неверно. Необходимо исправить эти проблемы, прежде чем продолжить.  
  
### <a name="export-the-work-folders-certificate"></a>Экспорт сертификата рабочих папок  
Самозаверяющий сертификат рабочих папок необходимо экспортировать, чтобы в дальнейшем установить его на следующих компьютерах в тестовой среде:  
  
-   сервер, используемый для прокси-службы веб-приложения;  
  
-   присоединенный к домену клиент Windows;  
  
-   не присоединенный к домену клиент Windows.  
  
Чтобы экспортировать сертификат, выполните те же действия, которые использовались для экспорта сертификата AD FS ранее, как описано в статье о [Deploy рабочих папках с помощью AD FS и прокси веб-приложения. Шаг 2 AD FS действия после настройки @ no__t-0, экспорт сертификата AD FS.  
  
Далее: [Deploy рабочие папки с AD FS и прокси веб-приложения: Шаг 4. Настройка прокси веб-приложения @ no__t-0  
  
## <a name="see-also"></a>См. также  
[Общие сведения о рабочих папках](Work-Folders-Overview.md)  
  

