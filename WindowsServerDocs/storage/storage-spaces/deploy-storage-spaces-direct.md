---
title: Развертывание локальных дисковых пространств
ms.prod: windows-server-threshold
manager: eldenc
ms.author: stevenek
ms.technology: storage-spaces
ms.topic: get-started-article
ms.assetid: 20fee213-8ba5-4cd3-87a6-e77359e82bc0
author: stevenek
ms.date: 06/07/2019
description: Пошаговые инструкции по развертыванию программно определяемого хранилища с дисковыми пространствами в Windows Server как гиперконвергентная инфраструктура или инфраструктура со схождением (также известный как с разделением).
ms.localizationpriority: medium
ms.openlocfilehash: a4159c85be23025ef57084b47dcc77d4f749888f
ms.sourcegitcommit: 6ef4986391607bb28593852d06cc6645e548a4b3
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/07/2019
ms.locfileid: "66812354"
---
# <a name="deploy-storage-spaces-direct"></a>Развертывание локальных дисковых пространств

> Относится к: Windows Server 2019, Windows Server 2016

Этот раздел содержит пошаговые инструкции по развертыванию [Storage Spaces Direct](storage-spaces-direct-overview.md).

> [!Tip]
> Необходимы для инфраструктуры Hyper-Converged? Корпорация Майкрософт рекомендует приобрести проверенные оборудование и программное обеспечение решения от наших партнеров, которые включают средства и процедуры развертывания. Эти решения разработаны, собраны и проверены в нашей эталонной архитектуры для обеспечения совместимости и надежности, чтобы оперативно настраивайте и быстрый запуск. Для решений Windows Server 2019 посетите [веб-сайт решения Azure Stack HCI](https://azure.microsoft.com/overview/azure-stack/hci). Для решений Windows Server 2016, Подробнее см. на [определяемые серверное программное обеспечение Windows](https://microsoft.com/wssd).

> [!Tip]
> Можно использовать виртуальные машины Hyper-V, включая в Microsoft Azure, на [оценить дисковыми пространствами без оборудования](storage-spaces-direct-in-vm.md). Можно также просмотреть удобной [скрипты развертывания Windows Server быстрой лаборатории](https://aka.ms/wslab), который мы используем в учебных целях.

## <a name="before-you-start"></a>Прежде чем начать

Просмотрите [дисковые требования к оборудованию](Storage-Spaces-Direct-Hardware-Requirements.md) и вытянуть этот документ, чтобы ознакомиться с общим подходом и важные примечания, связанные с некоторыми действиями.

Соберите следующую информацию:

- **Вариант развертывания.** Storage Spaces Direct поддерживает [два варианта развертывания: гиперконвергентной и принимают](storage-spaces-direct-overview.md#deployment-options), также известный как с разделением. Ознакомьтесь с преимуществами друг от друга выбрать подходящий вариант для вас. Шаги 1 – 3 ниже применяются оба варианта развертывания. Шаг 4 требуется только для развертывания со схождением.

- **Имена серверов.** Ознакомиться с политиками именования вашей организации для компьютеров, файлов, путей и других ресурсов. Вам потребуется подготовить несколько серверов, каждый из которых уникальные имена.

- **Имя домена.** Ознакомиться с политиками организации для именования доменов и присоединение к домену.  Вы сможете зарегистрироваться серверов к домену, и вам потребуется указать имя домена. 

- **Сеть RDMA.** Существует два типа протоколов RDMA: iWarp и RoCE. Обратите внимание, какой из них использовать сетевые адаптеры, и если RoCE, также Обратите внимание на версию (v1 или v2). Для RoCE Кроме модели коммутатора верхнего уровня.

- **ИД ВИРТУАЛЬНОЙ ЛС.** Обратите внимание идентификатор виртуальной локальной сети для сетевых адаптеров управления операционной системы на серверах, если таковые имеются. Его можно получить у администратора сети.

## <a name="step-1-deploy-windows-server"></a>Шаг 1. Развертывание Windows Server

### <a name="step-11-install-the-operating-system"></a>Шаг 1.1. Установить операционную систему

Первым шагом является установка Windows Server на каждом сервере, который будет находиться в кластере. Дисковые пространства требуется Windows Server 2016 Datacenter Edition. Можно использовать вариант установки основных серверных компонентов, то есть сервер с рабочим столом.

При установке Windows Server с помощью мастера установки, можно выбрать между *Windows Server* (по отношению к основных серверных компонентов) и *Windows Server (сервер с рабочим столом)* , это будет эквивалентно из *полный* вариант установки, доступных в Windows Server 2012 R2. Если вы не выберете, вы получите вариант установки основных серверных компонентов. Дополнительные сведения см. в разделе [установки параметров для Windows Server 2016](../../get-started/Windows-Server-2016.md).

### <a name="step-12-connect-to-the-servers"></a>Шаг 1.2. Подключение к серверам

В этом руководстве рассматриваются основные серверные компоненты и развертывание и управление удаленно из системы управления, который должен иметь:

- Windows Server 2016 с теми же обновлениями, что и серверы управляемых им
- Сетевое подключение к серверам, которыми он управляет
- Присоединен к тому же домену или полностью доверенному домену
- На нем должны быть установлены средства удаленного администрирования сервера (RSAT) и модули PowerShell для Hyper-V и отказоустойчивой кластеризации. Средства RSAT и модули PowerShell доступны в Windows Server и можно установить, не устанавливая другие компоненты. Вы также можете установить [средства удаленного администрирования сервера](https://www.microsoft.com/download/details.aspx?id=45520) на управления ПК Windows 10.

В системе управления установите отказоустойчивый кластер и средства управления Hyper-V. Это можно сделать в диспетчере сервера с помощью мастера **добавления ролей и компонентов**. На странице **Компоненты** щелкните **Средства удаленного администрирования сервера** и выберите средства, которые требуется установить.

Войдите в сеанс PowerShell и используйте имя сервера или IP-адрес узла, к которому хотите подключиться. Будет предложено ввести пароль, после выполнения этой команды, введите пароль администратора, указанный при настройке Windows.

   ```PowerShell
   Enter-PSSession -ComputerName <myComputerName> -Credential LocalHost\Administrator
   ```

   Вот как это то же самое, способом, который более подходит для скриптов, при необходимости это можно сделать более одного раза:

   ```PowerShell
   $myServer1 = "myServer-1"
   $user = "$myServer1\Administrator"

   Enter-PSSession -ComputerName $myServer1 -Credential $user
   ```

> [!TIP]
> Если вы развертываете удаленно из системы управления, может появиться сообщение об ошибке *WinRM не удается обработать запрос.* Чтобы устранить эту проблему, добавьте каждый сервер в список доверенных узлов на ваш компьютер управления с помощью Windows PowerShell:  
>   
> `Set-Item WSMAN:\Localhost\Client\TrustedHosts -Value Server01 -Force`
>  
> Примечание: в список надежных узлов поддерживает подстановочные знаки, например `Server*`.
>
> Чтобы просмотреть список доверенных узлов, введите `Get-Item WSMAN:\Localhost\Client\TrustedHosts`.  
>   
> Чтобы очистить список, введите `Clear-Item WSMAN:\Localhost\Client\TrustedHost`.  

### <a name="step-13-join-the-domain-and-add-domain-accounts"></a>Шаг 1.3. Присоединение к домену и добавьте учетные записи домена

Итак, вы настроили отдельных серверов с учетной записью локального администратора, `<ComputerName>\Administrator`.

Для управления дисковыми пространствами, необходимо присоединить сервер к домену и использовать учетную запись домена доменных служб Active Directory, входящую в группу администраторов на каждом сервере.

Из системы управления откройте консоль PowerShell с правами администратора. Используйте `Enter-PSSession` для подключения к каждому серверу и выполните следующий командлет, подставив имя компьютера, имя домена и учетные данные домена:

```PowerShell  
Add-Computer -NewName "Server01" -DomainName "contoso.com" -Credential "CONTOSO\User" -Restart -Force  
```

Если администратор учетной записи хранения не является членом группы "Администраторы домена", добавьте учетную запись администратора хранилища для локальной группы администраторов на каждом узле - или еще лучше, добавьте группу, которую можно использовать для администраторов. Можно использовать следующую команду (или написать функцию Windows PowerShell, чтобы сделать это — см. в разделе [использовать PowerShell, чтобы добавить пользователей домена локальной группы](http://blogs.technet.com/b/heyscriptingguy/archive/2010/08/19/use-powershell-to-add-domain-users-to-a-local-group.aspx) Дополнительные сведения):

```
Net localgroup Administrators <Domain\Account> /add
```

### <a name="step-14-install-roles-and-features"></a>Шаг 1.4. Установка ролей и компонентов

Следующий шаг — Установка роли сервера на каждом сервере. Это можно сделать с помощью [Windows Admin Center](../../manage/windows-admin-center/use/manage-servers.md), [диспетчера серверов](../../administration/server-manager/install-or-uninstall-roles-role-services-or-features.md)), или PowerShell. Ниже приведены роли для установки.

- Отказоустойчивая кластеризация
- Hyper-V
- Файловый сервер (Если вы хотите разместить любые общие папки, например, для конвергентном развертывании)
- Мост для центра обработки данных (если вы используете RoCEv2 вместо сетевых адаптеров iWARP)
- PowerShell для кластеризации RSAT
- PowerShell для Hyper-V

Чтобы установить с помощью PowerShell, используйте [Install-WindowsFeature](https://docs.microsoft.com/powershell/module/microsoft.windows.servermanager.migration/install-windowsfeature) командлета. Его можно использовать на одном сервере следующим образом:

```PowerShell
Install-WindowsFeature -Name "Hyper-V", "Failover-Clustering", "Data-Center-Bridging", "RSAT-Clustering-PowerShell", "Hyper-V-PowerShell", "FS-FileServer"
```

Чтобы выполнить команду на всех серверах в кластере, в то же время, используйте этот маленький фрагмент скрипта, изменение списка переменных в начале скрипта для конкретной среды.

```PowerShell
# Fill in these variables with your values
$ServerList = "Server01", "Server02", "Server03", "Server04"
$FeatureList = "Hyper-V", "Failover-Clustering", "Data-Center-Bridging", "RSAT-Clustering-PowerShell", "Hyper-V-PowerShell", "FS-FileServer"

# This part runs the Install-WindowsFeature cmdlet on all servers in $ServerList, passing the list of features into the scriptblock with the "Using" scope modifier so you don't have to hard-code them here.
Invoke-Command ($ServerList) {
    Install-WindowsFeature -Name $Using:Featurelist
}
```

## <a name="step-2-configure-the-network"></a>Шаг 2. Настройка сети

Если вы развертываете дисковыми пространствами в виртуальных машинах, пропустите этот раздел.

Storage Spaces Direct требует высокой пропускной способностью, низкой задержкой, сетевые подключения между серверами в кластере. По крайней мере 10 GbE сети является обязательным, и рекомендуется использовать удаленный прямой доступ к памяти (RDMA). До тех пор, пока он имеет логотип Windows Server 2016, но обычно проще настроить iWARP, можно использовать iWARP или RoCE.

> [!Important]
> В зависимости от своего сетевого оборудования и особенно с RoCE v2 может потребоваться настройка top-of-rack switch. Важно обеспечить надежность и производительность дисковых настроен правильный ключ.

Windows Server 2016 обеспечивает внедренных коммутатор объединения (SET) в пределах виртуального коммутатора Hyper-V. Благодаря этому же физических портов сетевой КАРТЫ, используемый для всего сетевого трафика при использовании RDMA, уменьшение числа физических портов сетевой КАРТЫ требуется. Switch embedded teaming рекомендуется для дисковых пространств.

Инструкции по настройке сети для дисковых пространств, см. в разделе [со схождением сетевого Адаптера Windows Server 2016 и руководство по развертыванию RDMA гостевой](https://github.com/Microsoft/SDN/blob/master/Diagnostics/S2D%20WS2016_ConvergedNIC_Configuration.docx).

## <a name="step-3-configure-storage-spaces-direct"></a>Шаг 3. Настройка локальных дисковых пространств.

Следующие действия выполняются в системе управления, версия которой совпадает с версией настраиваемых серверов. Следующие действия не должно быть выполнять удаленно с помощью сеанса PowerShell, однако для запуска в локальном сеансе PowerShell в системе управления, с правами администратора.

### <a name="step-31-clean-drives"></a>Шаг 3.1. Очистка носителей

Прежде чем разрешить Storage Spaces Direct, убедитесь, дисков пусты: нет старые секции или других данных. Выполните следующий скрипт, заменив имена компьютеров, чтобы удалить все старые секции или других данных.

> [!Warning]
> Этот сценарий безвозвратно удалит все данные на все диски, отличные от загрузочный диск операционной системы!

```PowerShell
# Fill in these variables with your values
$ServerList = "Server01", "Server02", "Server03", "Server04"

Invoke-Command ($ServerList) {
    Update-StorageProviderCache
    Get-StoragePool | ? IsPrimordial -eq $false | Set-StoragePool -IsReadOnly:$false -ErrorAction SilentlyContinue
    Get-StoragePool | ? IsPrimordial -eq $false | Get-VirtualDisk | Remove-VirtualDisk -Confirm:$false -ErrorAction SilentlyContinue
    Get-StoragePool | ? IsPrimordial -eq $false | Remove-StoragePool -Confirm:$false -ErrorAction SilentlyContinue
    Get-PhysicalDisk | Reset-PhysicalDisk -ErrorAction SilentlyContinue
    Get-Disk | ? Number -ne $null | ? IsBoot -ne $true | ? IsSystem -ne $true | ? PartitionStyle -ne RAW | % {
        $_ | Set-Disk -isoffline:$false
        $_ | Set-Disk -isreadonly:$false
        $_ | Clear-Disk -RemoveData -RemoveOEM -Confirm:$false
        $_ | Set-Disk -isreadonly:$true
        $_ | Set-Disk -isoffline:$true
    }
    Get-Disk | Where Number -Ne $Null | Where IsBoot -Ne $True | Where IsSystem -Ne $True | Where PartitionStyle -Eq RAW | Group -NoElement -Property FriendlyName
} | Sort -Property PsComputerName, Count
```

Выходные данные будут выглядеть следующим образом, где **число** число дисков на каждой модели, на каждом сервере:

```
Count Name                          PSComputerName
----- ----                          --------------
4     ATA SSDSC2BA800G4n            Server01
10    ATA ST4000NM0033              Server01
4     ATA SSDSC2BA800G4n            Server02
10    ATA ST4000NM0033              Server02
4     ATA SSDSC2BA800G4n            Server03
10    ATA ST4000NM0033              Server03
4     ATA SSDSC2BA800G4n            Server04
10    ATA ST4000NM0033              Server04
```

### <a name="step-32-validate-the-cluster"></a>Шаг 3.2. Проверить кластер

На этом шаге вы будете запускать средство проверки кластеров, чтобы убедиться, что узлы сервера настроены правильно для создания кластера с помощью дисковых пространств. При проверке кластера (`Test-Cluster`) — запустить перед созданием кластера, он будут выполняться тесты, убедитесь, что конфигурация подходит для успешной работы отказоустойчивого кластера. В примере ниже используется `-Include` указанных параметров, а затем определенные категории тестов. Таким образом, в проверку будут включены тесты локальных дисковых пространств.

Используйте следующую команду PowerShell, чтобы проверить набор серверов для использования в качестве кластера локальных дисковых пространств.

```PowerShell
Test-Cluster –Node <MachineName1, MachineName2, MachineName3, MachineName4> –Include "Storage Spaces Direct", "Inventory", "Network", "System Configuration"
```

### <a name="step-33-create-the-cluster"></a>Шаг 3.3. Создание кластера

На этом шаге вы создадите кластер с узлами, специально проверенными на предыдущем шаге, с помощью командлета PowerShell с кластером.

При создании кластера, вы получите предупреждение с текстом: «произошли ошибки при создании кластерной роли, может предотвратить запуск. Для получения подробной информации просмотрите файл отчета ниже". Это предупреждение можно игнорировать. Оно появляется из-за того, что нет доступных дисков для кворума кластера. Рекомендуется настраивать файловый ресурс-свидетель или облако-свидетель после создания кластера.

> [!Note]
> Если для серверов используются статические IP-адреса, измените приведенную ниже команду, чтобы отразить статический IP-адрес. Для этого добавьте следующий параметр и укажите IP-адрес: –StaticAddress &lt;X.X.X.X&gt;.
> В следующей команде заполнитель ClusterName необходимо заменить на уникальное имя NetBIOS длиной до 15 символов.
> ```PowerShell
> New-Cluster –Name <ClusterName> –Node <MachineName1,MachineName2,MachineName3,MachineName4> –NoStorage
> ```

После создания кластера репликация записи DNS для имени кластера может занять некоторое время. Продолжительность времени зависит от среды и конфигурации репликации DNS. Если разрешение кластера не удалось выполнить, в большинстве случаев вместо имени кластера можно использовать имя компьютера узла, который является активным участником кластера.

### <a name="step-34-configure-a-cluster-witness"></a>Шаг 3.4. Настройка следящего кластера

Рекомендуется настроить свидетель для кластера, поэтому кластерах с тремя или несколькими серверами может выдержать два сервера, сбой или находится в автономном режиме. Развертывание двух серверов требуется следящий кластер, в противном случае вызывает либо сервер переходит в автономный режим другой также становятся недоступными. В этих системах в качестве свидетеля можно использовать файловый ресурс или облако-свидетель. 

См. также следующие разделы:

- [Настройка кворума и управление им](../../failover-clustering/manage-cluster-quorum.md)
- [Развертывание облака-свидетеля для отказоустойчивого кластера](../../failover-clustering/deploy-cloud-witness.md)

### <a name="step-35-enable-storage-spaces-direct"></a>Шаг 3.5. Включение локальных дисковых пространств

После создания кластера, используйте `Enable-ClusterStorageSpacesDirect` командлет PowerShell, который будет перевести систему хранения в Storage Spaces Direct режим и автоматически сделает следующее:

-   **Создание пула:** Создает один большой пул с именем, похожим на «S2D на Cluster1».

-   **Настраивает дисковых кэшей:** Если имеется более одного носителя типа (диск), доступных для использования с дисковыми пространствами, он задает самые быстрые как устройства кэша (чтение и запись в большинстве случаев)

-   **Уровни:** Создает два уровня в качестве уровней по умолчанию. Один из них называется "Емкость", а другой — "Производительность". Командлет анализирует устройства и настраивает каждый уровень на основе типов устройств и устойчивости.

Из системы управления откройте командное окно PowerShell с правами администратора и запустите следующую команду. Нужно указать имя кластера, созданного при выполнении предыдущих действий. Если эта команда выполняется локально на одном из узлов, параметр -CimSession не требуется.

```PowerShell
Enable-ClusterStorageSpacesDirect –CimSession <ClusterName>
```

Чтобы включить локальные дисковые пространства с помощью указанной выше команды, вместо имени кластера можно использовать имя узла. Это может быть более надежным, так как при использовании имени только что созданного кластера могут возникнуть задержки репликации DNS.

После выполнения этой команды, которое может занять несколько минут, система будет готова для создания томов.

### <a name="step-36-create-volumes"></a>Шаг 3.6. Создание томов

Мы рекомендуем использовать `New-Volume` командлет, так как он обеспечивает быстрый и самый простой. Этот командлет автоматически создает виртуальный диск, разбивает и форматирует его, создает том с соответствующим именем и добавляет его в общие тома кластера — и все это за один шаг.

Подробнее см. в разделе [Создание томов в локальных дисковых пространствах](create-volumes.md).

### <a name="step-37-optionally-enable-the-csv-cache"></a>Шаг 3.7. При необходимости включить кэш CSV

При необходимости можно включить кэш кластер Общие тома (CSV) для использования системной памяти (ОЗУ) в качестве кэша сквозной записи уровня блока операций чтения, которые уже не кэшируются диспетчером кэша Windows. Это может повысить производительность приложений, таких как Hyper-V. Кэш CSV может резко повысить производительность запросов на чтение и также является полезным для сценариев масштабируемого файлового сервера.

Включение кэша CSV уменьшает объем памяти, доступной для запуска виртуальных машин на гиперконвергированного кластера, поэтому вы должны сбалансировать производительность хранилища с помощью памяти для виртуальных жестких дисков.

Чтобы задать размер кэша CSV, откройте сеанс PowerShell в системе управления под учетной записью, имеющей права администратора в кластере хранилища и затем использовать этот сценарий, изменив `$ClusterName` и `$CSVCacheSize` переменные в соответствии с (это пример задает кэш CSV 2 ГБ для каждого сервера):

```PowerShell
$ClusterName = "StorageSpacesDirect1"
$CSVCacheSize = 2048 #Size in MB

Write-Output "Setting the CSV cache..."
(Get-Cluster $ClusterName).BlockCacheSize = $CSVCacheSize

$CSVCurrentCacheSize = (Get-Cluster $ClusterName).BlockCacheSize
Write-Output "$ClusterName CSV cache size: $CSVCurrentCacheSize MB"
```

Дополнительные сведения см. в разделе [с помощью CSV-ФАЙЛ в памяти кэш чтения](csv-cache.md).

### <a name="step-38-deploy-virtual-machines-for-hyper-converged-deployments"></a>Шаг 3.8. Развертывание виртуальных машин для гиперконвергентных развертываниях

Если вы развертываете гиперконвергированного кластера, осталось для подготовки виртуальных машин в кластере дисковыми пространствами.

Файлы виртуальной машины, которые должны храниться в пространстве имен CSV систем (пример: c:\\ClusterStorage\\Volume1) так же, как кластерные виртуальные машины в отказоустойчивые кластеры.

Можно использовать в стандартных инструментов или других средств для управления хранилищем и виртуальные машины, такие как System Center Virtual Machine Manager.

## <a name="step-4-deploy-scale-out-file-server-for-converged-solutions"></a>Шаг 4. Развертывание масштабируемого файлового сервера со схождением решений

При развертывании решения со схождением, следующим шагом является создание экземпляра масштабируемого файлового сервера и настройку некоторых общих папок. Если вы развертываете гиперконвергированного кластера - все сделано и не требуется раздел.

### <a name="step-41-create-the-scale-out-file-server-role"></a>Шаг 4.1. Создать роль масштабируемого файлового сервера

Следующий шаг в настройке служб кластеров для файлового сервера создается роль кластеризованного файлового сервера, при создании экземпляра масштабируемого файлового сервера, на котором размещаются ваши постоянно доступные файловые ресурсы.

#### <a name="to-create-a-scale-out-file-server-role-by-using-server-manager"></a>Чтобы создать роль масштабируемого файлового сервера с помощью диспетчера серверов

1. В диспетчере отказоустойчивости кластеров выберите или укажите кластер, перейдите к **ролей**, а затем нажмите кнопку **настроить роль...** .<br>Откроется мастер высокой доступности.
2. На **Выбор роли** щелкните **файлового сервера**.
3. На **тип файлового сервера** щелкните **масштабируемого файлового сервера для данных приложений**.
4. На **точки доступа клиента** введите имя для масштабируемого файлового сервера.
5. Убедитесь, что роль была успешно, перейдя к **ролей** и проверяет, что **состояние** показан столбец **под управлением** рядом с роли кластерного файлового сервера, вы создали, как показано на рис. 1.

   ![Снимок экрана диспетчера отказоустойчивости кластеров, в отображение Scale-Out File Server](media/Hyper-converged-solution-using-Storage-Spaces-Direct-in-Windows-Server-2016/SOFS_in_FCM.png "Диспетчер отказоустойчивости кластеров, показывающий масштабируемого файлового сервера")

    **Рис. 1** Диспетчер отказоустойчивости кластеров, показывающий масштабируемого файлового сервера с состоянием выполнения

> [!NOTE]
>  После создания кластерной роли, могут существовать некоторые сетевой задержки при распространении данных, которые могут возникнуть проблемы от создания общих папок на нем, в течение нескольких минут, и потенциально более.  
  
#### <a name="to-create-a-scale-out-file-server-role-by-using-windows-powershell"></a>Чтобы создать роль масштабируемого файлового сервера с помощью Windows PowerShell

 В сеансе Windows PowerShell, который подключен к кластеру файлового сервера, введите следующие команды, чтобы создать роль масштабируемого файлового сервера, изменение *FSCLUSTER* должно соответствовать имени кластера, и *SOFS* должно соответствовать имени, необходимо предоставить роль масштабируемого файлового сервера:

```PowerShell
Add-ClusterScaleOutFileServerRole -Name SOFS -Cluster FSCLUSTER
```

> [!NOTE]
>  После создания кластерной роли, могут существовать некоторые сетевой задержки при распространении данных, которые могут возникнуть проблемы от создания общих папок на нем, в течение нескольких минут, и потенциально более. Если роль масштабируемого файлового сервера прекращается немедленно и не запускается, возможно, так как объект-компьютер кластера не имеет разрешения на создание учетной записи компьютера для роли масштабируемого файлового сервера. Для облегчения этого, см. в разделе этой записи блога: [Горизонтальное масштабирование не роли сервера файл запускается с ИД событий 1205, 1069 и 1194](http://www.aidanfinn.com/?p=14142).

### <a name="step-42-create-file-shares"></a>Шаг 4.2. Создание файловых ресурсов

После создания виртуальных дисков и их добавления в общие тома кластера, пришло время для создания общих папок на них - одного файлового ресурса в CSV-ФАЙЛ на виртуальный диск. System Center Virtual Machine Manager (VMM) — это, вероятно, handiest способ это сделать, так как она обрабатывает разрешения, но если ее нет в вашей среде, можно использовать Windows PowerShell для частично автоматизации развертывания.

Используйте сценарии, включенные в [Настройка общего ресурса SMB для рабочих нагрузок Hyper-V](http://gallery.technet.microsoft.com/SMB-Share-Configuration-4a36272a) сценарий, который частично автоматизирует процесс создания группы и общие папки. Документ предназначен для рабочих нагрузок Hyper-V, поэтому если вы развертываете других рабочих нагрузок, может потребоваться изменить параметры или выполнить дополнительные действия после создания общих ресурсов. Например при использовании Microsoft SQL Server, учетная запись службы SQL Server должен быть предоставить полный доступ к общему ресурсу и файловой системе.

> [!NOTE]
>  Необходимо обновить список членов группы, при добавлении узлов кластера, если вы не используете System Center Virtual Machine Manager для создания к ним.

Для создания общих папок с помощью сценариев PowerShell, сделайте следующее:

1. Загрузите сценарии, включенные в [Настройка общего ресурса SMB для рабочих нагрузок Hyper-V](http://gallery.technet.microsoft.com/SMB-Share-Configuration-4a36272a) к одному из узлов кластера файловых серверов.
2. Откройте сеанс Windows PowerShell с учетными данными администратора домена в системе управления, а затем используйте следующий сценарий для создания группы Active Directory для объектов-компьютеров Hyper-V, изменив значения переменных в зависимости от вашей Среда:

    ```PowerShell
    # Replace the values of these variables
    $HyperVClusterName = "Compute01"
    $HyperVObjectADGroupSamName = "Hyper-VServerComputerAccounts" <#No spaces#>
    $ScriptFolder = "C:\Scripts\SetupSMBSharesWithHyperV"

    # Start of script itself
    CD $ScriptFolder
    .\ADGroupSetup.ps1 -HyperVObjectADGroupSamName $HyperVObjectADGroupSamName -HyperVClusterName $HyperVClusterName
    ```
3. Откройте сеанс Windows PowerShell с учетными данными администратора на одном из узлов хранения и затем используйте следующий сценарий для создания общих ресурсов для каждого CSV и предоставить административные разрешения для общих ресурсов в группу "Администраторы домена" и вычислительного кластера.

    ```PowerShell
    # Replace the values of these variables
    $StorageClusterName = "StorageSpacesDirect1"
    $HyperVObjectADGroupSamName = "Hyper-VServerComputerAccounts" <#No spaces#>
    $SOFSName = "SOFS"
    $SharePrefix = "Share"
    $ScriptFolder = "C:\Scripts\SetupSMBSharesWithHyperV"

    # Start of the script itself
    CD $ScriptFolder
    Get-ClusterSharedVolume -Cluster $StorageClusterName | ForEach-Object
    {
        $ShareName = $SharePrefix + $_.SharedVolumeInfo.friendlyvolumename.trimstart("C:\ClusterStorage\Volume")
        Write-host "Creating share $ShareName on "$_.name "on Volume: " $_.SharedVolumeInfo.friendlyvolumename
        .\FileShareSetup.ps1 -HyperVClusterName $StorageClusterName -CSVVolumeNumber $_.SharedVolumeInfo.friendlyvolumename.trimstart("C:\ClusterStorage\Volume") -ScaleOutFSName $SOFSName -ShareName $ShareName -HyperVObjectADGroupSamName $HyperVObjectADGroupSamName
    }
    ```

### <a name="step-43-enable-kerberos-constrained-delegation"></a>Ограниченное делегирование Kerberos включить шаг 4.3

Чтобы настроить ограниченное делегирование Kerberos для сценария удаленного управления, а также повышенную безопасность динамической миграции, в одном из узлов кластера хранилища, используйте скрипт KCDSetup.ps1, включенный в [Настройка общего ресурса SMB для рабочих нагрузок Hyper-V](http://gallery.technet.microsoft.com/SMB-Share-Configuration-4a36272a). Вот небольшой программы-оболочки для скрипта.

```PowerShell
$HyperVClusterName = "Compute01"
$ScaleOutFSName = "SOFS"
$ScriptFolder = "C:\Scripts\SetupSMBSharesWithHyperV"

CD $ScriptFolder
.\KCDSetup.ps1 -HyperVClusterName $HyperVClusterName -ScaleOutFSName $ScaleOutFSName -EnableLM
```

## <a name="next-steps"></a>Следующие шаги

Развернув кластерного файлового сервера, мы рекомендуем, тестирование производительности решения с помощью искусственных рабочих нагрузок перед вызовом любого реальных рабочих нагрузок. Это позволяет подтвердить, что решение работает без ошибок и решить все активные проблемы перед добавлением сложность рабочих нагрузок. Дополнительные сведения см. в разделе [теста хранилища пробелы производительности с помощью искусственных рабочих нагрузок](https://technet.microsoft.com/library/dn894707.aspx).

## <a name="see-also"></a>См. также

-   [Дисковые пространства в Windows Server 2016](storage-spaces-direct-overview.md)
-   [Понять, в кэш в Storage Spaces Direct](understand-the-cache.md)
-   [Планирование томов в дисковых пространств](plan-volumes.md)
-   [Отказоустойчивость дисковых пространств](storage-spaces-fault-tolerance.md)
-   [Дисковые пространства требования к оборудованию](Storage-Spaces-Direct-Hardware-Requirements.md)
-   [В RDMA или не в RDMA — вот в чем вопрос](https://blogs.technet.microsoft.com/filecab/2017/03/27/to-rdma-or-not-to-rdma-that-is-the-question/) (блог TechNet)
