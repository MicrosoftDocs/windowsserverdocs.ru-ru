---
ms.assetid: 898d72f1-01e7-4b87-8eb3-a8e0e2e6e6da
title: Добавление серверов или дисков в локальные дисковые пространства
ms.prod: windows-server-threshold
ms.author: cosdar
ms.manager: dongill
ms.technology: storage-spaces
ms.topic: article
author: cosmosdarwin
ms.date: 11/06/2017
description: Добавление серверов или дисков в кластер с локальными дисковыми пространствами
ms.localizationpriority: medium
ms.openlocfilehash: ae639b920788911dbc16952d7b61aab85b0a391b
ms.sourcegitcommit: 0d0b32c8986ba7db9536e0b8648d4ddf9b03e452
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2019
ms.locfileid: "59833455"
---
# <a name="adding-servers-or-drives-to-storage-spaces-direct"></a>Добавление серверов или дисков в локальные дисковые пространства

>Относится к: Windows Server 2019, Windows Server 2016

В этом разделе описывается добавление серверов или дисков в локальные дисковые пространства.

## <a name="adding-servers"></a> Добавление серверов

Добавление серверов, которое часто называют горизонтальным масштабированием, позволяет увеличить емкость, повысить производительность хранилища и улучшить эффективность хранения. Если ваше развертывание гиперконвергентное, добавление серверов также поможет увеличить объем вычислительных ресурсов для рабочих нагрузок.

![Анимация для добавления сервера в кластер с четырьмя узлами](media/add-nodes/Scaling-Out.gif)

Горизонтальное масштабирование обычных развертываний легко достигается путем добавления серверов. Регистрация состоит всего из двух этапов.

1. Запустите [мастер проверки кластера](https://technet.microsoft.com/library/cc732035(v=ws.10).aspx) с помощью оснастки отказоустойчивого кластера или командлета **Test-Cluster** в PowerShell (запустите его от имени администратора). Добавьте новый сервер *\<NewNode>*, который вы хотите добавить.

   ```PowerShell
   Test-Cluster -Node <Node>, <Node>, <Node>, <NewNode> -Include "Storage Spaces Direct", Inventory, Network, "System Configuration"
   ```

   Это позволит убедиться в том, что новый сервер работает под управлением Windows Server 2016 Datacenter Edition, присоединен к тому же домену доменных служб Active Directory, что и существующие серверы, имеет все необходимые роли и компоненты и для него правильно настроено сетевое взаимодействие.

   >[!IMPORTANT]
   > Если вы повторно используете диски, содержащие старые данные или метаданные, которые вам больше не нужны, очистите их с помощью оснастки **Управление дисками** или командлета **Reset-PhysicalDisk**. При обнаружении старых данных или метаданных диски не объединяются в пул.

2. Чтобы завершить добавление сервера, выполните следующую команду в кластере:

```
Add-ClusterNode -Name NewNode 
```

   >[!NOTE]
   > Автоматическое добавление в пул возможно только в том случае, если имеется только один пул. Если вместо стандартной конфигурации вы создали несколько пулов, то вам потребуется добавить новые диски в нужный пул самостоятельно с помощью командлета **Add-PhysicalDisk**.

### <a name="from-2-to-3-servers-unlocking-three-way-mirroring"></a>От двух до трех серверов: разблокирование трехстороннего зеркального отображения

![Добавление сторонний сервер кластера с двумя узлами](media/add-nodes/Scaling-2-to-3.png)

При наличии двух серверов можно создать только тома с двухсторонним зеркалированием (сопоставимо с распределенными массивами RAID-1). При наличии трех серверов вы можете создать трехсторонние зеркальные тома для улучшенной отказоустойчивости. Мы рекомендуем по возможности использовать трехстороннее зеркалирование.

Двусторонние зеркальные тома невозможно обновить на месте до трехстороннего зеркального отображения. Вместо этого вы можете создать новый том и перенести (скопировать, например с помощью [реплики хранения](../storage-replica/server-to-server-storage-replication.md)) в него свои данные, а затем удалить старый том.

Приступить к созданию томов с трехсторонним зеркалированием можно несколькими способами. Вы можете использовать любой из них по своему усмотрению. 

#### <a name="option-1"></a>Способ 1

Укажите значение **PhysicalDiskRedundancy= 2** для каждого создаваемого тома.

```PowerShell
New-Volume -FriendlyName <Name> -FileSystem CSVFS_ReFS -StoragePoolFriendlyName S2D* -Size <Size> -PhysicalDiskRedundancy 2
```

#### <a name="option-2"></a>Способ 2

Вместо этого можно указать значение **PhysicalDiskRedundancyDefault = 2** для объекта **ResiliencySetting** пула с именем **Mirror**. После этого все новые зеркальные тома будут автоматически использовать *трехстороннее* зеркальное отображение, даже если это не указано.

```PowerShell
Get-StoragePool S2D* | Get-ResiliencySetting -Name Mirror | Set-ResiliencySetting -PhysicalDiskRedundancyDefault 2

New-Volume -FriendlyName <Name> -FileSystem CSVFS_ReFS -StoragePoolFriendlyName S2D* -Size <Size>
```

#### <a name="option-3"></a>Способ 3

Задайте значение **PhysicalDiskRedundancy= 2** для шаблона **StorageTier** под названием *Capacity*, а затем создайте тома, указав уровень.

```PowerShell
Set-StorageTier -FriendlyName Capacity -PhysicalDiskRedundancy 2 

New-Volume -FriendlyName <Name> -FileSystem CSVFS_ReFS -StoragePoolFriendlyName S2D* -StorageTierFriendlyNames Capacity -StorageTierSizes <Size>
```

### <a name="from-3-to-4-servers-unlocking-dual-parity"></a>От трех до четырех серверов: разблокирование двойной четности

![добавлении четвертый сервера в кластер с тремя узлами](media/add-nodes/Scaling-3-to-4.png)

При наличии четырех серверов можно использовать двойную четность, также часто называемую помехоустойчивым кодированием (сопоставимо с распределенными массивами RAID-6). При этом обеспечивается та же двойная отказоустойчивость, что и при трехстороннем зеркалировании, но с повышенным уровнем эффективности. Дополнительные сведения см. в разделе [Отказоустойчивость и эффективность хранения](storage-spaces-fault-tolerance.md).

Если вы начинаете с небольшого развертывания, у вас есть несколько вариантов для создания томов двойной четности. Вы можете использовать любой из них по своему усмотрению.

#### <a name="option-1"></a>Способ 1

Укажите значения **PhysicalDiskRedundancy = 2** и **ResiliencySettingName = Parity** при создании каждого нового тома.

```PowerShell
New-Volume -FriendlyName <Name> -FileSystem CSVFS_ReFS -StoragePoolFriendlyName S2D* -Size <Size> -PhysicalDiskRedundancy 2 -ResiliencySettingName Parity
```

#### <a name="option-2"></a>Способ 2

Установите значение **PhysicalDiskRedundancy = 2** для объекта **ResiliencySetting** пула с именем **Parity**. После этого для всех новых томов будет использоваться *двойная* четность, даже если это не указано.

```PowerShell
Get-StoragePool S2D* | Get-ResiliencySetting -Name Parity | Set-ResiliencySetting -PhysicalDiskRedundancyDefault 2

New-Volume -FriendlyName <Name> -FileSystem CSVFS_ReFS -StoragePoolFriendlyName S2D* -Size <Size> -ResiliencySettingName Parity
```

При наличии четырех серверов можно также начинать использовать четность с зеркальным ускорением, при которой для отдельного тома применяется как зеркалирование, так и контроль четности.

Для этого необходимо изменить шаблоны **StorageTier** так, чтобы она включала уровни *Performance* и *Capacity*, которые были бы созданы, если бы вы предварительно выполнили командлет **Enable-ClusterS2D** на четырех серверах. В частности, должны иметь тип **MediaType** устройств хранения (например, твердотельные или жесткие диски) и значение **PhysicalDiskRedundancy= 2**. Уровень *Performance* должен иметь значение **ResiliencySettingName= Mirror**, а уровень *Capacity*— значение **ResiliencySettingName= Parity**.

#### <a name="option-3"></a>Способ 3

Возможно, будет проще просто удалить существующий шаблон, а затем создать два новых. Это не повлияет на существующие тома, которые были созданы с помощью шаблона уровня: это просто шаблон.

```PowerShell
Remove-StorageTier -FriendlyName Capacity

New-StorageTier -StoragePoolFriendlyName S2D* -MediaType HDD -PhysicalDiskRedundancy 2 -ResiliencySettingName Mirror -FriendlyName Performance
New-StorageTier -StoragePoolFriendlyName S2D* -MediaType HDD -PhysicalDiskRedundancy 2 -ResiliencySettingName Parity -FriendlyName Capacity
```

Вот и все! Теперь вы готовы создать тома с зеркально ускоренной четностью, ссылаясь на эти шаблоны уровней.

#### <a name="example"></a>Пример

```PowerShell
New-Volume -FriendlyName "Sir-Mix-A-Lot" -FileSystem CSVFS_ReFS -StoragePoolFriendlyName S2D* -StorageTierFriendlyNames Performance, Capacity -StorageTierSizes <Size, Size> 
```

### <a name="beyond-4-servers-greater-parity-efficiency"></a>Больше четырех серверов: повышение эффективности контроля четности

При использовании более чем четырех серверов с контролем четности эффективность новых томов может быть еще выше. Например, при количестве серверов от шести до семи эффективность повышается с 50,0 % до 66,7 %, так становится возможным использовать код Рида-Соломона 4+2 (а не 2+2). Чтобы получить такую эффективность, не нужно предпринимать дополнительных действий. Оптимальное кодирование определяется автоматически при каждом создании тома.

Однако ранее существовавшие тома *не* будут преобразовываться в новые с расширенной кодировкой. Одна из веских причин этого в том, что для этого потребовались бы сложные вычислительные операции буквально с *каждым битом*, имеющимся в среде. Чтобы обеспечить более эффективную кодировку существующих данных, их можно перенести в новые тома.

Дополнительные сведения см. в разделе [Отказоустойчивость и эффективность хранения](storage-spaces-fault-tolerance.md).

### <a name="adding-servers-when-using-chassis-or-rack-fault-tolerance"></a>Добавление серверов при использовании отказоустойчивости на уровне шасси или стоек

Если в развертывании применяется отказоустойчивость на уровне шасси или стоек, необходимо указать шасси или стойку для новых серверов, прежде чем добавлять их в кластер. Таким образом вы сообщаете локальным дисковым пространствам, как лучше распределять данные для достижения максимальной отказоустойчивости.

1. Создайте временный домен сбоя для узла, открыв сеанс PowerShell с повышенными привилегиями и выполнив следующую команду, где *\<NewNode>*— это имя нового узла кластера:

   ```PowerShell
   New-ClusterFaultDomain -Type Node -Name <NewNode> 
   ```

2. Переместите временный домен сбоя в шасси или стойку, где в реальности находится новый сервер, в соответствии со значением *\<ParentName>*:

   ```PowerShell
   Set-ClusterFaultDomain -Name <NewNode> -Parent <ParentName> 
   ```

   Дополнительные сведения см. в разделе [Информация о домене сбоя в Windows Server2016](../../failover-clustering/fault-domains.md).

3. Добавьте сервер в кластер, как описано в разделе [Добавление серверов](#adding-servers). Когда новый сервер присоединяется к кластеру, он автоматически связывается (по имени) с доменом-заполнителем сбоя.

## <a name="adding-drives"></a> Добавление дисков

Добавление дисков (также известное как вертикальное масштабирование) позволяет увеличить объем хранилища, а также повысить его производительность. При наличии доступных слотов можно добавить диски в каждый сервер, чтобы увеличить емкость хранения, не добавляя серверы. Диски для хранения кэша и основных данных можно добавлять независимо друг от друга в любое время.

   >[!IMPORTANT]
   > Мы настоятельно рекомендуем использовать одинаковую конфигурации хранилища для всех серверов.

![Анимации, в котором показано добавление дисков в систему](media/add-nodes/Scale-Up.gif)

Чтобы произвести вертикальное масштабирование, подключите диски и проверьте, обнаруживает ли их система Windows. Они должны отображаться в выходных данных командлета **Get-PhysicalDisk** в PowerShell со свойством **CanPool**, имеющим значение **True**. Если они отображаются как **CanPool = False**, вы можете узнать, почему, изучив свойство **CannotPoolReason**.

```PowerShell
Get-PhysicalDisk | Select SerialNumber, CanPool, CannotPoolReason
```

Вскоре соответствующие диски будут автоматически затребованы локальными дисковыми пространствами, добавлены в пул носителей, а тома будут [равномерно распределены по всем дискам](https://blogs.technet.microsoft.com/filecab/2016/11/21/deep-dive-pool-in-spaces-direct/). После этого можно приступать к [расширению существующих](resize-volumes.md) или [созданию дополнительных томов](create-volumes.md).

Если диски не отображаются, вручную проверьте наличие изменений в оборудовании. Это можно сделать с помощью **диспетчера устройств** в меню **Действие**. Если диски содержат старые данные или метаданные, рекомендуем переформатировать их. Это можно сделать с помощью оснастки **Управление дисками** или командлета **Reset-PhysicalDisk**.

   >[!NOTE]
   > Автоматическое добавление в пул возможно только в том случае, если имеется только один пул. Если вместо стандартной конфигурации вы создали несколько пулов, то вам потребуется добавить новые диски в нужный пул самостоятельно с помощью командлета **Add-PhysicalDisk**.

## <a name="optimizing-drive-usage-after-adding-drives-or-servers"></a>Оптимизация использования дисков после добавления диски или серверы

Со временем как диски добавляются или удаляются, распределение данных между дисками в пуле может стать неравномерным. В некоторых случаях это может привести некоторые диски станут заполненными, хотя других дисков в пуле будут использоваться гораздо меньше.

Чтобы сохранить даже по всему пулу выделенное для диска, дисковыми пространствами автоматически оптимизирует использование дисков после добавления диски или серверы в пул (это ручной процесс для дисковых системах, использующих корпуса общего SAS). Оптимизация начинается 15 минут, после добавления нового диска в пул. Оптимизация пула выполняется в фоновом режиме с низким приоритетом операции, поэтому может занять часов или дней, особенно в том случае, если вы используете жесткие диски большого объема.

Оптимизация использует два задания — один с именем *оптимизировать* и *перераспределить* — и вы сможете отслеживать их выполнение с помощью следующей команды:

```powershell
Get-StorageJob
```

Вы можете вручную оптимизировать пул носителей с [Optimize-StoragePool](https://docs.microsoft.com/powershell/module/storage/optimize-storagepool?view=win10-ps) командлета. Ниже приведен пример:

```powershell
Get-StoragePool <PoolName> | Optimize-StoragePool
```
