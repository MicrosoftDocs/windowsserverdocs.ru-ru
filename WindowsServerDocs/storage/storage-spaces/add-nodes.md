---
ms.assetid: 898d72f1-01e7-4b87-8eb3-a8e0e2e6e6da
title: Добавление серверов или дисков в локальные дисковые пространства
ms.author: cosdar
manager: dongill
ms.topic: article
author: cosmosdarwin
ms.date: 11/06/2017
description: Добавление серверов или дисков в кластер Локальные дисковые пространства
ms.localizationpriority: medium
ms.openlocfilehash: b9a26d3ac982cccf4471f3a3e03bfdae55b55eed
ms.sourcegitcommit: dfa48f77b751dbc34409aced628eb2f17c912f08
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/07/2020
ms.locfileid: "87961068"
---
# <a name="adding-servers-or-drives-to-storage-spaces-direct"></a>Добавление серверов или дисков в локальные дисковые пространства

>Применяется к: Windows Server 2019, Windows Server 2016

В этом разделе описывается добавление серверов или дисков в локальные дисковые пространства.

## <a name="adding-servers"></a><a name="adding-servers"></a>Добавление серверов

Добавление серверов, которое часто называют горизонтальным масштабированием, позволяет увеличить емкость, повысить производительность хранилища и улучшить эффективность хранения. Если ваше развертывание гиперконвергентное, добавление серверов также поможет увеличить объем вычислительных ресурсов для рабочих нагрузок.

![Анимация добавления сервера в кластер с четырьмя узлами](media/add-nodes/Scaling-Out.gif)

Горизонтальное масштабирование обычных развертываний легко достигается путем добавления серверов. Регистрация состоит всего из двух этапов.

1. Запустите [мастер проверки кластера](/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/cc732035(v=ws.10)) с помощью оснастки отказоустойчивого кластера или командлета **Test-Cluster** в PowerShell (запустите его от имени администратора). Включите новый сервер *\<NewNode>* , который вы хотите добавить.

   ```PowerShell
   Test-Cluster -Node <Node>, <Node>, <Node>, <NewNode> -Include "Storage Spaces Direct", Inventory, Network, "System Configuration"
   ```

   Это позволит убедиться в том, что новый сервер работает под управлением Windows Server 2016 Datacenter Edition, присоединен к тому же домену доменных служб Active Directory, что и существующие серверы, имеет все необходимые роли и компоненты и для него правильно настроено сетевое взаимодействие.

   >[!IMPORTANT]
   > Если вы повторно используете диски, содержащие старые данные или метаданные, которые вам больше не нужны, очистите их с помощью оснастки **Управление дисками** или командлета **Reset-PhysicalDisk**. При обнаружении старых данных или метаданных диски не объединяются в пул.

2. Чтобы завершить добавление сервера, выполните следующую команду в кластере:

```
Add-ClusterNode -Name NewNode
```

   >[!NOTE]
   > Автоматическое добавление в пул возможно только в том случае, если имеется только один пул. Если вы обработали стандартную конфигурацию для создания нескольких пулов, вам потребуется вручную добавить новые диски в предпочтительный пул с помощью **Add-** Drive.

### <a name="from-2-to-3-servers-unlocking-three-way-mirroring"></a>От двух до трех серверов: разблокирование трехстороннего зеркального отображения

![Добавление третьего сервера в кластер с двумя узлами](media/add-nodes/Scaling-2-to-3.png)

При наличии двух серверов можно создать только тома с двухсторонним зеркалированием (сопоставимо с распределенными массивами RAID-1). При наличии трех серверов вы можете создать трехсторонние зеркальные тома для улучшенной отказоустойчивости. Мы рекомендуем по возможности использовать трехстороннее зеркалирование.

Двусторонние зеркальные тома невозможно обновить на месте до трехстороннего зеркального отображения. Вместо этого вы можете создать новый том и перенести (скопировать, например с помощью [реплики хранения](../storage-replica/server-to-server-storage-replication.md)) в него свои данные, а затем удалить старый том.

Приступить к созданию томов с трехсторонним зеркалированием можно несколькими способами. Вы можете использовать любой из них по своему усмотрению.

#### <a name="option-1"></a>Вариант 1

Укажите значение **PhysicalDiskRedundancy= 2** для каждого создаваемого тома.

```PowerShell
New-Volume -FriendlyName <Name> -FileSystem CSVFS_ReFS -StoragePoolFriendlyName S2D* -Size <Size> -PhysicalDiskRedundancy 2
```

#### <a name="option-2"></a>Вариант 2

Вместо этого можно указать значение **PhysicalDiskRedundancyDefault = 2** для объекта **ResiliencySetting** пула с именем **Mirror**. После этого все новые зеркальные тома будут автоматически использовать *трехстороннее* зеркальное отображение, даже если это не указано.

```PowerShell
Get-StoragePool S2D* | Get-ResiliencySetting -Name Mirror | Set-ResiliencySetting -PhysicalDiskRedundancyDefault 2

New-Volume -FriendlyName <Name> -FileSystem CSVFS_ReFS -StoragePoolFriendlyName S2D* -Size <Size>
```

#### <a name="option-3"></a>Предложение 3

Задайте значение **PhysicalDiskRedundancy= 2** для шаблона **StorageTier** под названием *Capacity*, а затем создайте тома, указав уровень.

```PowerShell
Set-StorageTier -FriendlyName Capacity -PhysicalDiskRedundancy 2

New-Volume -FriendlyName <Name> -FileSystem CSVFS_ReFS -StoragePoolFriendlyName S2D* -StorageTierFriendlyNames Capacity -StorageTierSizes <Size>
```

### <a name="from-3-to-4-servers-unlocking-dual-parity"></a>От трех до четырех серверов: разблокирование двойной четности

![Добавление четвертого сервера в кластер с тремя узлами](media/add-nodes/Scaling-3-to-4.png)

При наличии четырех серверов можно использовать двойную четность, также часто называемую помехоустойчивым кодированием (сопоставимо с распределенными массивами RAID-6). При этом обеспечивается та же двойная отказоустойчивость, что и при трехстороннем зеркалировании, но с повышенным уровнем эффективности. Дополнительные сведения см. в разделе [Отказоустойчивость и экономичность хранения](storage-spaces-fault-tolerance.md).

Если вы начинаете с небольшого развертывания, у вас есть несколько вариантов для создания томов двойной четности. Вы можете использовать любой из них по своему усмотрению.

#### <a name="option-1"></a>Вариант 1

Укажите значения **PhysicalDiskRedundancy = 2** и **ResiliencySettingName = Parity** при создании каждого нового тома.

```PowerShell
New-Volume -FriendlyName <Name> -FileSystem CSVFS_ReFS -StoragePoolFriendlyName S2D* -Size <Size> -PhysicalDiskRedundancy 2 -ResiliencySettingName Parity
```

#### <a name="option-2"></a>Вариант 2

Установите значение **PhysicalDiskRedundancy = 2** для объекта **ResiliencySetting** пула с именем **Parity**. После этого для всех новых томов будет использоваться *двойная* четность, даже если это не указано.

```PowerShell
Get-StoragePool S2D* | Get-ResiliencySetting -Name Parity | Set-ResiliencySetting -PhysicalDiskRedundancyDefault 2

New-Volume -FriendlyName <Name> -FileSystem CSVFS_ReFS -StoragePoolFriendlyName S2D* -Size <Size> -ResiliencySettingName Parity
```

При наличии четырех серверов можно также начинать использовать четность с зеркальным ускорением, при которой для отдельного тома применяется как зеркалирование, так и контроль четности.

Для этого необходимо изменить шаблоны **StorageTier** так, чтобы она включала уровни *Performance* и *Capacity*, которые были бы созданы, если бы вы предварительно выполнили командлет **Enable-ClusterS2D** на четырех серверах. В частности, должны иметь тип **MediaType** устройств хранения (например, твердотельные или жесткие диски) и значение **PhysicalDiskRedundancy= 2**. Уровень *Performance* должен иметь значение **ResiliencySettingName = Mirror**, а уровень *Capacity* — значение **ResiliencySettingName = Parity**.

#### <a name="option-3"></a>Предложение 3

Возможно, будет проще просто удалить существующий шаблон, а затем создать два новых. Это не повлияет на существующие тома, созданные с помощью шаблона уровня. это просто шаблон.

```PowerShell
Remove-StorageTier -FriendlyName Capacity

New-StorageTier -StoragePoolFriendlyName S2D* -MediaType HDD -PhysicalDiskRedundancy 2 -ResiliencySettingName Mirror -FriendlyName Performance
New-StorageTier -StoragePoolFriendlyName S2D* -MediaType HDD -PhysicalDiskRedundancy 2 -ResiliencySettingName Parity -FriendlyName Capacity
```

Вот и все! Теперь вы готовы создать тома с зеркально ускоренной четностью, ссылаясь на эти шаблоны уровней.

#### <a name="example"></a>Пример

```PowerShell
New-Volume -FriendlyName "Sir-Mix-A-Lot" -FileSystem CSVFS_ReFS -StoragePoolFriendlyName S2D* -StorageTierFriendlyNames Performance, Capacity -StorageTierSizes <Size, Size>
```

### <a name="beyond-4-servers-greater-parity-efficiency"></a>Больше четырех серверов: повышение эффективности контроля четности

При использовании более чем четырех серверов с контролем четности эффективность новых томов может быть еще выше. Например, при количестве серверов от шести до семи эффективность повышается с 50,0 % до 66,7 %, так становится возможным использовать код Рида-Соломона 4+2 (а не 2+2). Чтобы получить такую эффективность, не нужно предпринимать дополнительных действий. Оптимальное кодирование определяется автоматически при каждом создании тома.

Однако ранее существовавшие тома *не* будут преобразовываться в новые с расширенной кодировкой. Одна из веских причин этого в том, что для этого потребовались бы сложные вычислительные операции буквально с *каждым битом*, имеющимся в среде. Чтобы обеспечить более эффективную кодировку существующих данных, их можно перенести в новые тома.

Дополнительные сведения см. в разделе [Отказоустойчивость и экономичность хранения](storage-spaces-fault-tolerance.md).

### <a name="adding-servers-when-using-chassis-or-rack-fault-tolerance"></a>Добавление серверов при использовании отказоустойчивости на уровне шасси или стоек

Если в развертывании применяется отказоустойчивость на уровне шасси или стоек, необходимо указать шасси или стойку для новых серверов, прежде чем добавлять их в кластер. Таким образом вы сообщаете локальным дисковым пространствам, как лучше распределять данные для достижения максимальной отказоустойчивости.

1. Создайте временный домен сбоя для узла, открыв сеанс PowerShell с повышенными привилегиями, а затем используя следующую команду, где *\<NewNode>* — это имя нового узла кластера:

   ```PowerShell
   New-ClusterFaultDomain -Type Node -Name <NewNode>
   ```

2. Переместите этот временный домен сбоя в корпус или стойку, где новый сервер находится в реальном мире, как указано в *\<ParentName>* :

   ```PowerShell
   Set-ClusterFaultDomain -Name <NewNode> -Parent <ParentName>
   ```

   Дополнительные сведения см. в разделе [Информация о домене сбоя в Windows Server 2016](../../failover-clustering/fault-domains.md).

3. Добавьте сервер в кластер, как описано в разделе [Добавление серверов](#adding-servers). Когда новый сервер присоединяется к кластеру, он автоматически связывается (по имени) с доменом-заполнителем сбоя.

## <a name="adding-drives"></a><a name="adding-drives"></a>Добавление дисков

Добавление дисков (также известное как вертикальное масштабирование) позволяет увеличить объем хранилища, а также повысить его производительность. При наличии доступных слотов можно добавить диски в каждый сервер, чтобы увеличить емкость хранения, не добавляя серверы. Диски для хранения кэша и основных данных можно добавлять независимо друг от друга в любое время.

   >[!IMPORTANT]
   > Мы настоятельно рекомендуем использовать одинаковую конфигурации хранилища для всех серверов.

![Анимация, показывающая добавление дисков в Sytem](media/add-nodes/Scale-Up.gif)

Чтобы произвести вертикальное масштабирование, подключите диски и проверьте, обнаруживает ли их система Windows. Они должны отображаться в выходных данных командлета **Get-PhysicalDisk** в PowerShell со свойством **CanPool**, имеющим значение **True**. Если они отображаются как **CanPool = False**, вы можете узнать, почему, изучив свойство **CannotPoolReason**.

```PowerShell
Get-PhysicalDisk | Select SerialNumber, CanPool, CannotPoolReason
```

В течение короткого промежутка времени подходящие диски будут автоматически запрошены Локальные дисковые пространства, добавлены в пул носителей, а тома будут автоматически [перераспределяться по всем дискам](https://techcommunity.microsoft.com/t5/storage-at-microsoft/deep-dive-the-storage-pool-in-storage-spaces-direct/ba-p/425959). После этого можно приступать к [расширению существующих](resize-volumes.md) или [созданию дополнительных томов](create-volumes.md).

Если диски не отображаются, вручную проверьте наличие изменений в оборудовании. Это можно сделать с помощью **диспетчера устройств** в меню **Действие**. Если диски содержат старые данные или метаданные, рекомендуем переформатировать их. Это можно сделать с помощью оснастки **Управление дисками** или командлета **Reset-PhysicalDisk**.

   >[!NOTE]
   > Автоматическое добавление в пул возможно только в том случае, если имеется только один пул. Если вы обработали стандартную конфигурацию для создания нескольких пулов, вам потребуется вручную добавить новые диски в предпочтительный пул с помощью **Add-** Drive.

## <a name="optimizing-drive-usage-after-adding-drives-or-servers"></a>Оптимизация использования диска после добавления дисков или серверов

Со временем при добавлении или удалении дисков распределение данных между дисками в пуле может стать нечетным. В некоторых случаях это может привести к полному заполнению некоторых дисков, в то время как другие диски в пуле значительно более низкие.

Для обеспечения равномерного выделения места на диске в пуле Локальные дисковые пространства автоматически оптимизирует использование диска после добавления дисков или серверов в пул (это процесс вручную для систем дисковых пространств, использующих общие корпусы SAS). Оптимизация начинается через 15 минут после добавления нового диска в пул. Оптимизация пула выполняется как фоновая операция с низким приоритетом, поэтому ее выполнение может занять несколько часов или дней, особенно если вы используете большие жесткие диски.

Оптимизация использует два задания — одно с именем *optimize* , а другое — *перебалансировка* . Вы можете отслеживать ход выполнения с помощью следующей команды:

```powershell
Get-StorageJob
```

Пул носителей можно оптимизировать вручную с помощью командлета [optimize-StoragePool](/powershell/module/storage/optimize-storagepool?view=win10-ps) . Ниже приведен пример.

```powershell
Get-StoragePool <PoolName> | Optimize-StoragePool
```
