---
title: Изучение и настройка Azure Monitor
description: Подробные сведения о настройке Azure Monitor и настройке оповещений электронной почты и SMS для кластера локальных дисковых пространств в Windows Server 2016 и 2019.
ms.author: adagashe
ms.topic: article
author: adagashe
ms.date: 01/10/2020
ms.openlocfilehash: 0cbcccb66c3fa49fb55a882601cf8044bc1dc99c
ms.sourcegitcommit: 7674bbe49517bbfe0e2c00160e08240b60329fd9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/20/2021
ms.locfileid: "98603444"
---
# <a name="use-azure-monitor-to-send-emails-for-health-service-faults"></a>Использование Azure Monitor для отправки сообщений электронной почты о сбоях в службе работоспособности

>Применяется к: Windows Server 2019, Windows Server 2016

Служба Azure Monitor обеспечивает максимальную доступность и производительность приложений, предоставляя полноценное решение для сбора, анализа и обработки данных телеметрии из облачных и локальных сред. Она поможет вам понять, как выполняются приложения, а также заранее определить проблемы, влияющие на них, и ресурсы, от которых они зависят.

Это особенно полезно для локального кластера с поддержкой Hyper-in. Благодаря встроенной Azure Monitor Вы сможете настроить электронную почту, текст (SMS) и другие оповещения, чтобы проверить связь с вами при возникновении проблем с кластером (или если требуется отметить некоторые другие действия в зависимости от собираемых данных). Ниже будет кратко объяснено, как работает Azure Monitor, как установить Azure Monitor и как настроить его для отправки уведомлений.

Если вы используете System Center, ознакомьтесь с [пакетом управления Локальные дисковые пространства](https://www.microsoft.com/download/details.aspx?id=100782) , который наблюдает за кластерами Локальные дисковые пространства windows Server 2019 и windows Server 2016.

Этот пакет управления включает в себя:

* Мониторинг работоспособности физического диска и производительности
* Мониторинг работоспособности и производительности узла хранилища
* Мониторинг работоспособности и производительности пула носителей
* Тип устойчивости тома и состояние дедупликации

## <a name="understanding-azure-monitor"></a>Основные сведения о Azure Monitor

Все данные, собираемые службой Azure Monitor, соответствуют одному из двух основных типов, то есть представляют собой метрики или журналы.

1. [Метрики](/azure/azure-monitor/platform/data-collection#metrics) — это числовые значения, описывающие конкретный аспект системы в определенный момент времени. Они занимают небольшой объем, и их можно использовать в сценариях, предусматривающих работу в режиме практически реального времени. Данные, собранные Azure Monitor прямо на странице "Обзор", отображаются в портал Azure.

![изображение приема данных метрик в обозревателе метрик](media/configure-azure-monitor/metrics.png)

2. [Журналы](/azure/azure-monitor/platform/data-collection#logs) содержат данные различных типов, упорядоченные по записям с разными наборами свойств для каждого типа. Помимо данных производительности в системе (в виде журналов) хранятся данные телеметрии, например события и трассировки, так что можно объединить все эти данные для анализа. Данные журналов, собранные службой Azure Monitor, можно проанализировать с помощью [запросов](/azure/azure-monitor/log-query/log-query-overview), которые быстро получают, консолидируют и анализируют собранные данные. Вы можете создавать и тестировать запросы с помощью [Log Analytics](/azure/azure-monitor/log-query/portals) на портале Azure, а затем либо напрямую анализировать данные с помощью этих средств, либо сохранять запросы для использования с [визуализациями](/azure/azure-monitor/visualizations) или [правилами генерации оповещений](/azure/azure-monitor/platform/alerts-overview).

![изображение приема данных журналов в Log Analytics](media/configure-azure-monitor/logs.png)

Ниже приводятся дополнительные сведения о настройке этих оповещений.

## <a name="onboarding-your-cluster-using-windows-admin-center"></a>Подключение кластера с помощью центра администрирования Windows

С помощью центра администрирования Windows можно подключить кластер к Azure Monitor.

![GIF-файл для адаптации кластера к Azure Monitor "](media/configure-azure-monitor/onboarding.gif)

Во время этого процесса адаптации действия, приведенные ниже, выполняются внутри. Мы подробно рассмотрим, как настроить их в случае необходимости ручной настройки кластера.

### <a name="configuring-health-service"></a>Настройка служба работоспособности

Сначала вам нужно настроить кластер. Возможно, вы уже знаете, что [служба работоспособности](../../failover-clustering/health-service-overview.md) оптимизирует регулярный мониторинг и выполнение операций для кластеров с Локальными дисковыми пространствами.

Как уже отмечалось, Azure Monitor собирает журналы из каждого узла в кластере. Мы настроим службу работоспособности на запись в такой канал событий.

```
Event Channel: Microsoft-Windows-Health/Operational
Event ID: 8465
```

Чтобы настроить службу работоспособности, выполните следующий командлет:

```PowerShell
get-storagesubsystem clus* | Set-StorageHealthSetting -Name "Platform.ETW.MasTypes" -Value "Microsoft.Health.EntityType.Subsystem,Microsoft.Health.EntityType.Server,Microsoft.Health.EntityType.PhysicalDisk,Microsoft.Health.EntityType.StoragePool,Microsoft.Health.EntityType.Volume,Microsoft.Health.EntityType.Cluster"
```

При выполнении приведенного выше командлета, чтобы задать параметры работоспособности, события, которые мы хотим записать, будут записаны в канал событий *Microsoft-Windows-Health/эксплуатация* .

### <a name="configuring-log-analytics"></a>Настройка Log Analytics

Теперь, когда вы настроили правильную регистрацию в кластере, следующим шагом является правильная настройка log Analytics.

Чтобы получить общие сведения, [Azure log Analytics](/azure/azure-monitor/platform/agent-windows) может получать данные непосредственно с физических или виртуальных компьютеров Windows в вашем центре обработки данных или в другой облачной среде в одном репозитории для подробного анализа и корреляции.

Дополнительные сведения о поддерживаемой конфигурации см. в разделах о [поддерживаемых операционных системах Windows](/azure/azure-monitor/platform/log-analytics-agent#supported-windows-operating-systems) и [требованиях к сетевым брандмауэрам](/azure/azure-monitor/platform/log-analytics-agent#network-firewall-requirements).

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу.

#### <a name="login-in-to-azure-portal"></a>Вход на портал Azure

Войдите на портал Azure по адресу [https://portal.azure.com](https://azure.microsoft.com/free/?WT.mc_id=A261C142F).

#### <a name="create-a-workspace"></a>Создание рабочей области

Дополнительные сведения о приведенных ниже действиях см. в [документации по Azure Monitor](/azure/azure-monitor/learn/quick-collect-windows-computer).

1. На портале Azure щелкните **Все службы**. В списке ресурсов введите **Log Analytics**. Как только вы начнете вводить символы, список отфильтруется соответствующим образом. Выберите **Log Analytics**.<br><br>

   ![Портал Azure](media/configure-azure-monitor/azure-portal-01.png)<br><br>

2. Щелкните **Создать** и задайте следующие параметры:

   * Введите имя для новой **рабочей области Log Analytics**, например *DefaultLAWorkspace*.
   * Выберите в раскрывающемся списке **Подписку**, с которой нужно связать рабочую область, если выбранная по умолчанию не подходит.
   * В разделе **Группа ресурсов** выберите имеющуюся группу ресурсов, в которой содержится одна или несколько виртуальных машин Azure. <br><br>

      ![Колонка создания ресурса Log Analytics](media/configure-azure-monitor/create-loganalytics-workspace-02.png) <br><br>

3. После ввода необходимых сведений в области **Рабочая область Log Analytics** щелкните **OK**.

Пока проверяются данные, ход создания рабочей области можно проверить в разделе **Уведомления** в меню.

#### <a name="obtain-workspace-id-and-key"></a>Получение идентификатора и ключа рабочей области
Перед установкой Microsoft Monitoring Agent для Windows требуется получить идентификатор и ключ для рабочей области Log Analytics.  Эта информация необходима мастеру установки для правильной настройки агента и обеспечения его взаимодействия с Log Analytics.

1. На портале Azure щелкните **Все службы** в нижнем левом углу. В списке ресурсов введите **Log Analytics**. Как только вы начнете вводить символы, список отфильтруется соответствующим образом. Выберите **Log Analytics**.
2. В списке рабочих областей Log Analytics выберите рабочую область *DefaultLAWorkspace*, созданную ранее.
3. Выберите **Дополнительные параметры**.<br><br> ![Дополнительные параметры Log Analytics](media/configure-azure-monitor/log-analytics-advanced-settings-01.png)<br><br>
4. Выберите **Подключенные источники**, а затем выберите **Серверы с Windows**.
5. Необходимые значения указаны справа от полей **Идентификатор рабочей области** и **Первичный ключ**. Временно сохраните оба значения — скопируйте и вставьте их в текстовый редактор.

### <a name="installing-the-agent-on-windows"></a>Установка агента в Windows
Ниже приведена процедура по установке и настройке Microsoft Monitoring Agent. **Не забудьте установить этот агент на каждом сервере в кластере и указать, что агент должен запускаться при запуске Windows.**

1. На странице **Серверы с Windows** выберите соответствующую версию **агента для Windows** для скачивания в зависимости от архитектуры процессора, на котором выполняется операционная система Windows.
2. Запустите программу установки, чтобы установить агент на компьютере.
2. На странице **приветствия** нажмите кнопку **Далее**.
3. На странице **Условия лицензии** прочтите лицензию и нажмите кнопку **Принимаю**.
4. На странице **Папка назначения** измените или оставьте папку установки по умолчанию и нажмите кнопку **Далее**.
5. На странице **Параметры установки агента** выберите подключение агента к Azure Log Analytics и нажмите **Далее**.
6. На странице **Azure Log Analytics** выполните следующее.
   1. Вставьте **идентификатор рабочей области** и **ключ рабочей области (первичный ключ)** , скопированные ранее.
    а. Если компьютер должен обмениваться данными со службой Log Analytics через прокси-сервер, щелкните **Дополнительно** и укажите URL-адрес и номер порта прокси-сервера.  Если для доступа к прокси-серверу требуется аутентификация, введите имя пользователя и пароль для аутентификации на прокси-сервере, затем нажмите кнопку **Далее**.
7. Нажмите кнопку **Далее** после завершения ввода необходимых параметров конфигурации.<br><br> ![Вставка идентификатора рабочей области и первичного ключа](media/configure-azure-monitor/log-analytics-mma-setup-laworkspace.png)<br><br>
8. На странице **Готовность к установке** просмотрите выбранные параметры и нажмите кнопку **Установить**.
9. На странице **Настройка успешно завершена** нажмите кнопку **Готово**.

После завершения установки на **панели управления** появится **Microsoft Monitoring Agent**. Вы можете просмотреть конфигурацию и проверить, подключен ли агент к Log Analytics. При подключении на вкладке **Azure Log Analytics** отображается сообщение от агента: **Microsoft Monitoring Agent успешно подключен к службе Microsoft Log Analytics**.

![Состояние подключения MMA к Log Analytics](media/configure-azure-monitor/log-analytics-mma-laworkspace-status.png)

Дополнительные сведения о поддерживаемой конфигурации см. в разделах о [поддерживаемых операционных системах Windows](/azure/azure-monitor/platform/log-analytics-agent#supported-windows-operating-systems) и [требованиях к сетевым брандмауэрам](/azure/azure-monitor/platform/log-analytics-agent#network-firewall-requirements).

## <a name="setting-up-alerts-using-windows-admin-center"></a>Настройка оповещений с помощью Windows Admin Center

В центре администрирования Windows можно настроить оповещения по умолчанию, которые будут применяться ко всем серверам в рабочей области Log Analytics.

![Короткое видео, в котором показан пользователь, который настраивает оповещения по умолчанию, которые будут применяться ко всем серверам в рабочей области Log Analytics.](media/configure-azure-monitor/setup1.gif)

Оповещения и их условия по умолчанию, которые вы можете выбрать:

| Имя предупреждения                | Условие по умолчанию                                  |
|---------------------------|----------------------------------------------------|
| загрузка ЦП;           | Свыше 85 % в течение 10 минут                            |
| Использование емкости диска | Свыше 85 % в течение 10 минут                            |
| Использование памяти        | Объем доступной памяти составляет менее 100 МБ в течение 10 минут   |
| Пульс                 | Меньше 2 пульсов в течение 5 минут                   |
| Критическая ошибка системы     | Любое критическое оповещение в журнале событий системы кластера |
| Оповещение службы работоспособности      | Любая ошибка в службе работоспособности в кластере            |

После настройки оповещений в центре администрирования Windows можно просмотреть оповещения в рабочей области log Analytics в Azure.

![Короткое видео, в котором показан пользователь, обращающийся к оповещениям в рабочей области log Analytics в Azure.](media/configure-azure-monitor/setup2.gif)

Во время этого процесса адаптации действия, приведенные ниже, выполняются внутри. Мы подробно рассмотрим, как настроить их в случае необходимости ручной настройки кластера.

### <a name="collecting-event-and-performance-data"></a>Сбор данных о событиях и производительности

Log Analytics может собирать события из журналов событий и счетчиков производительности Windows, указанных для долгосрочного анализа и формирования отчетов, а также предпринимать действия при обнаружении определенного условия.  Сначала выполните приведенные ниже действия для настройки сбора событий из журнала событий Windows, а также нескольких стандартных счетчиков производительности.

1. На портале Azure щелкните **Другие службы** в нижнем левом углу. В списке ресурсов введите **Log Analytics**. Как только вы начнете вводить символы, список отфильтруется соответствующим образом. Выберите **Log Analytics**.
2. Выберите **Дополнительные параметры**.<br><br> ![Дополнительные параметры Log Analytics](media/configure-azure-monitor/log-analytics-advanced-settings-01.png)<br><br>
3. Выберите **Данные**, а затем — **Журналы событий Windows**.
4. Добавьте здесь канал событий службы работоспособности, введя указанное ниже имя, а затем щелкните значок плюса **+** .
   ```
   Event Channel: Microsoft-Windows-Health/Operational
   ```
5. Проверьте степени серьезности **Ошибка** и **Предупреждение** в таблице.
6. В верхней части страницы щелкните **Сохранить**, чтобы сохранить конфигурацию.
7. Выберите **Счетчики производительности Windows**, чтобы включить сбор данных счетчиков производительности на компьютере Windows.
8. При первой настройке счетчиков производительности Windows для новой рабочей области Log Analytics вы можете быстро создать несколько распространенных счетчиков. Рядом с каждым счетчиком в списке есть флажок.<br> ![Выбраны стандартные счетчики производительности Windows](media/configure-azure-monitor/windows-perfcounters-default.png)<br> Щелкните **Add the selected performance counters** (Добавить выбранные счетчики производительности).  Они добавляются и устанавливаются с десятисекундным интервалом сбора.
9. В верхней части страницы щелкните **Сохранить**, чтобы сохранить конфигурацию.

## <a name="creating-alerts-based-on-log-data"></a>Создание предупреждений на основе данных журнала

Если вы выполнили все приведенные выше инструкции, кластер должен отправлять журналы и данные счетчиков производительности в Log Analytics. Теперь вам нужно создать правила генерации оповещений, которые автоматически выполняют поиск по журналам через регулярные интервалы. Если результаты поиска по журналам соответствуют определенным условиям, создается оповещение для отправки вам сообщения электронной почты или текстового уведомления. Рассмотрим подробнее.

### <a name="create-a-query"></a>Создание запроса

Откройте портал поиска по журналам, используя

1. На портале Azure щелкните **Все службы**. В списке ресурсов введите **Монитор**. Как только вы начнете вводить символы, список отфильтруется соответствующим образом. Щелкните **Монитор**.
2. В меню навигации Монитор выберите **Log Analytics** и нужную рабочую область.

Самый быстрый способ получить некоторые данные для работы — создать простой запрос, который возвращает все записи в таблице. Введите следующие запросы в поле поиска и нажмите кнопку поиска.

```
Event
```

Данные возвращаются в представлении списка по умолчанию. Вы можете просмотреть общее количество возвращенных записей.

![Простой запрос](media/configure-azure-monitor/log-analytics-portal-eventlist-01.png)

В левой области экрана расположена панель фильтров, которая позволяет добавить фильтрацию к запросу, не изменяя его напрямую.  Для этого типа записи показано несколько свойств. Вы можете выбрать одно или несколько значений свойств для сужения результатов поиска.

Установите флажок рядом с параметром **Ошибка** в разделе **EVENTLEVELNAME** или введите следующую команду, чтобы ограничить результаты событиями ошибок.

```
Event | where (EventLevelName == "Error")
```

![Filter](media/configure-azure-monitor/log-analytics-portal-eventlist-02.png)

После создания соответствующих запросов для нужных событий сохраните их для следующего шага.

### <a name="create-alerts"></a>Создание оповещений
Теперь давайте рассмотрим пример создания оповещения.

1. На портале Azure щелкните **Все службы**. В списке ресурсов введите **Log Analytics**. Как только вы начнете вводить символы, список отфильтруется соответствующим образом. Выберите **Log Analytics**.
2. На панели слева выберите **Оповещения** и щелкните **Новое правило генерации оповещений** в верхней части страницы, чтобы создать оповещение.<br><br> ![Создание правила генерации оповещений](media/configure-azure-monitor/alert-rule-02.png)<br>
3. Сначала выберите в разделе **Создать оповещение** рабочую область Log Analytics в качестве ресурса, так как мы создаем сигнал оповещения на основе журналов.  Если у вас несколько подписок, отфильтруйте результаты, выбрав из раскрывающегося списка конкретную **подписку**, содержащую рабочую область Log Analytics, которую вы создали ранее.  Установите фильтр по **Типу ресурса**, выбрав **Log Analytics** из раскрывающегося списка.  Наконец, выберите **Ресурс** **DefaultLAWorkspace** и щелкните **Готово**.<br><br> ![Создание оповещения, шаг 1](media/configure-azure-monitor/alert-rule-03.png)<br>
4. В разделе **Критерии оповещения** щелкните **Добавить критерии**, чтобы выбрать сохраненный запрос, а затем настройте логику для этого правила генерации оповещений.
5. Настройте оповещение, указав следующие сведения: В раскрывающемся списке **На основе** выберите **Измерение метрик**.  Измерение метрик позволяет создать оповещение для каждого объекта в запросе, для которого значение превышает указанное пороговое значение.
   b. В поле **Условие** выберите **Больше чем** и укажите пороговое значение.
   c. Затем определите, когда следует активировать оповещение. Например, выберите **Последовательные бреши**, а из раскрывающего списка выберите **Больше чем** и введите значение 3.
   d. В разделе "Вычисляется на основе" задайте для параметра **Период** значение **30**, а для параметра **Частота** — значение 5. Это правило будет запускаться каждые пять минут и возвращать все записи, созданные за последние тридцать минут.  Установка большего периода потенциально может привести к задержкам при передаче данных, но в то же время гарантирует, что запрос всегда будет возвращать данные. Это, в свою очередь, позволит избежать ложноотрицательных результатов, при которых оповещение не срабатывает.
6. Щелкните **Готово**, чтобы завершить создание правила генерации оповещений.<br><br> ![Настройка сигнала оповещения](media/configure-azure-monitor/alert-signal-logic-02.png)<br>
7. Теперь переходите ко второму шагу. Укажите имя для оповещения в поле **Имя правила генерации оповещений**, например **Создавать оповещения для всех событий ошибок**.  Укажите подробное **Описание** для оповещения и выберите уровень **Критический (уровень серьезности 0)** из представленных в поле **Серьезность** вариантов.
8. Чтобы правило генерации оповещений начало работать сразу после создания, сохраните установленный по умолчанию флажок **Включить правило при создании**.
9. На последнем, третьем, шаге укажите **Группу действий**, которая позволит гарантировать выполнение одинаковых действий всякий раз, когда активируется это оповещение. Эту функцию можно использовать для каждого созданного правила. Настройте новую группу действий со следующими параметрами: Выберите **Новая группа действий**, чтобы открыть панель **Добавить группу действий**.
   b. В поле **Имя группы действий** укажите имя, например **Уведомление ИТ-отдела**, и **Короткое имя**, например **itops-n**.
   c. Убедитесь, что в полях **Подписка** и **Группа ресурсов** заданы правильные значения по умолчанию. Если нет, выберите правильные варианты из раскрывающегося списка.
   d. В разделе "Действия" укажите имя для этого действия, например **Отправить электронное письмо**, а в поле **Тип действия** выберите **Email/SMS/Push/Voice** (Электронная почта, SMS, push-уведомление, голосовой вызов) из раскрывающегося списка. Справа откроется панель свойств **Email/SMS/Push/Voice** (Электронная почта, SMS, push-уведомление, голосовой вызов) для дополнительных сведений.
   д) В области **Email/SMS/Push/Voice** (Электронная почта, SMS, push-уведомление, голосовой вызов) укажите нужные значения. Например, выберите значение **Электронная почта** и укажите допустимый SMTP-адрес электронной почты для доставки сообщения.
   е) Нажмите кнопку **ОК** , чтобы сохранить внесенные изменения.<br><br>

    ![Создание группы действий](media/configure-azure-monitor/action-group-properties-01.png)

10. Нажмите кнопку **ОК**, чтобы завершить создание группы действий.
11. Щелкните **Создать правило генерации оповещений**, чтобы завершить создание этого правила. Оно начнет выполняться немедленно.<br><br> ![Завершение создания правила генерации оповещений](media/configure-azure-monitor/alert-rule-01.png)<br>

### <a name="example-alert"></a>Пример оповещения

Оповещение в Azure выглядит следующим образом:

![GIF оповещения в Azure](media/configure-azure-monitor/alert.gif)

Ниже приведен пример сообщения электронной почты, которое будет отправлено Azure Monitor:

![Пример оповещения по электронной почте](media/configure-azure-monitor/warning.png)

## <a name="additional-references"></a>Дополнительные ссылки

- [Обзор Локальных дисковых пространств](storage-spaces-direct-overview.md)
- Более подробные сведения см. в [документации по Azure Monitor](/azure/azure-monitor/learn/tutorial-viewdata).
- Дополнительные сведения о [подключении к другим гибридным службам Azure](../../manage/windows-admin-center/azure/index.md)см. в этой статье.
