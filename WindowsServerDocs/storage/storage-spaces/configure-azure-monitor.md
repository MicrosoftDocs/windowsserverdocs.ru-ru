---
title: Изучение и настройка Azure Monitor
description: Подробные сведения о настройке Azure Monitor и настройке оповещений электронной почты и SMS для кластера локальных дисковых пространств в Windows Server 2016 и 2019.
ms.prod: windows-server
ms.author: adagashe
ms.technology: storage-spaces
ms.topic: article
author: adagashe
ms.date: 01/10/2020
ms.openlocfilehash: fa4d8793c07cabd39ee6cc0d54b5cddc84eac202
ms.sourcegitcommit: b00d7c8968c4adc8f699dbee694afe6ed36bc9de
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/08/2020
ms.locfileid: "80859047"
---
# <a name="use-azure-monitor-to-send-emails-for-health-service-faults"></a>Использование Azure Monitor для отправки сообщений электронной почты о сбоях служба работоспособности

>Область применения: Windows Server 2019, Windows Server 2016

Azure Monitor максимально увеличивает доступность и производительность приложений, предоставляя исчерпывающее решение для сбора, анализа и взаимодействия телеметрии из облачных и локальных сред. Он помогает понять, как работают приложения и заранее определяет проблемы, влияющие на них, а также на ресурсы, от которых они зависят.

Это особенно полезно для локального кластера с поддержкой Hyper-in. Благодаря встроенной Azure Monitor Вы сможете настроить электронную почту, текст (SMS) и другие оповещения, чтобы проверить связь с вами при возникновении проблем с кластером (или если требуется отметить некоторые другие действия в зависимости от собираемых данных). Ниже будет кратко объяснено, как работает Azure Monitor, как установить Azure Monitor и как настроить его для отправки уведомлений.

Если вы используете System Center, ознакомьтесь с [пакетом управления Локальные дисковые пространства](https://www.microsoft.com/download/details.aspx?id=100782) , который наблюдает за кластерами Локальные дисковые пространства windows Server 2019 и windows Server 2016.

Этот пакет управления включает в себя:

* Мониторинг работоспособности физического диска и производительности
* Мониторинг работоспособности и производительности узла хранилища
* Мониторинг работоспособности и производительности пула носителей
* Тип устойчивости тома и состояние дедупликации

## <a name="understanding-azure-monitor"></a>Основные сведения о Azure Monitor

Все данные, собранные Azure Monitor, помещаются в один из двух фундаментальных типов: метрики и журналы.

1. [Метрики](https://docs.microsoft.com/azure/azure-monitor/platform/data-collection#metrics) — это числовые значения, которые описывают некоторый аспект системы в определенный момент времени. Они являются облегченными и способны поддерживать сценарии практически в реальном времени. Данные, собранные Azure Monitor прямо на странице "Обзор", отображаются в портал Azure.

![изображение метрик, принимающих данные в обозревателе метрик](media/configure-azure-monitor/metrics.png)

2. [Журналы](https://docs.microsoft.com/azure/azure-monitor/platform/data-collection#logs) содержат различные типы данных, организованные в записи с разными наборами свойств для каждого типа. Данные телеметрии, такие как события и трассировки, хранятся в виде журналов в дополнение к данным о производительности, чтобы их можно было объединить для анализа. Данные журнала, собранные Azure Monitor, можно анализировать с помощью [запросов](https://docs.microsoft.com/azure/azure-monitor/log-query/log-query-overview) для быстрого извлечения, консолидации и анализа собранных данных. Вы можете создавать и тестировать запросы с помощью [log Analytics](https://docs.microsoft.com/azure/azure-monitor/log-query/portals) в портал Azure, а затем либо напрямую анализировать данные с помощью этих средств, либо сохранять запросы для использования с [визуализациями](https://docs.microsoft.com/azure/azure-monitor/visualizations) или [правилами генерации оповещений](https://docs.microsoft.com/azure/azure-monitor/platform/alerts-overview).

![изображение журналов, принимающих данные в log Analytics](media/configure-azure-monitor/logs.png)

Ниже приводятся дополнительные сведения о настройке этих оповещений.

## <a name="onboarding-your-cluster-using-windows-admin-center"></a>Подключение кластера с помощью центра администрирования Windows

С помощью центра администрирования Windows можно подключить кластер к Azure Monitor.

![GIF-файл для адаптации кластера к Azure Monitor "](media/configure-azure-monitor/onboarding.gif)

Во время этого процесса адаптации действия, приведенные ниже, выполняются внутри. Мы подробно рассмотрим, как настроить их в случае необходимости ручной настройки кластера. 

### <a name="configuring-health-service"></a>Настройка служба работоспособности

В первую очередь необходимо настроить кластер. Как вы, возможно, узнаете, [Служба работоспособности](../../failover-clustering/health-service-overview.md) улучшает повседневный мониторинг и эксплуатацию для кластеров под управлением Локальные дисковые пространства. 

Как было показано выше, Azure Monitor собирает журналы из каждого узла, на котором они выполняются в кластере. Поэтому необходимо настроить служба работоспособности для записи в канал событий, который:

```
Event Channel: Microsoft-Windows-Health/Operational
Event ID: 8465
```

Чтобы настроить служба работоспособности, выполните:

```PowerShell
get-storagesubsystem clus* | Set-StorageHealthSetting -Name "Platform.ETW.MasTypes" -Value "Microsoft.Health.EntityType.Subsystem,Microsoft.Health.EntityType.Server,Microsoft.Health.EntityType.PhysicalDisk,Microsoft.Health.EntityType.StoragePool,Microsoft.Health.EntityType.Volume,Microsoft.Health.EntityType.Cluster"
```

При выполнении приведенного выше командлета, чтобы задать параметры работоспособности, события, которые мы хотим записать, будут записаны в канал событий *Microsoft-Windows-Health/эксплуатация* .

### <a name="configuring-log-analytics"></a>Настройка Log Analytics

Теперь, когда вы настроили правильную регистрацию в кластере, следующим шагом является правильная настройка log Analytics.

Чтобы получить общие сведения, [Azure log Analytics](https://docs.microsoft.com/azure/azure-monitor/platform/agent-windows) может получать данные непосредственно с физических или виртуальных компьютеров Windows в вашем центре обработки данных или в другой облачной среде в одном репозитории для подробного анализа и корреляции.

Чтобы ознакомиться с поддерживаемой конфигурацией, ознакомьтесь с [поддерживаемыми операционными системами Windows](https://docs.microsoft.com/azure/azure-monitor/platform/log-analytics-agent#supported-windows-operating-systems) и [конфигурацией сетевого брандмауэра](https://docs.microsoft.com/azure/azure-monitor/platform/log-analytics-agent#network-firewall-requirements).

Если у вас нет подписки Azure, создайте [бесплатную учетную запись](https://azure.microsoft.com/free/?WT.mc_id=A261C142F) , прежде чем начинать работу.

#### <a name="login-in-to-azure-portal"></a>Вход на портал Azure

Войдите в портал Azure на [https://portal.azure.com](https://azure.microsoft.com/free/?WT.mc_id=A261C142F).

#### <a name="create-a-workspace"></a>Создать рабочую область

Дополнительные сведения о действиях, перечисленных ниже, см. в [документации по Azure Monitor](https://docs.microsoft.com/azure/azure-monitor/learn/quick-collect-windows-computer).

1. В портал Azure щелкните **все службы**. В списке ресурсов введите **log Analytics**. По мере ввода, список фильтруется на основе введенных данных. Выберите **log Analytics**.<br><br> 

   ![Портал Azure](media/configure-azure-monitor/azure-portal-01.png)<br><br>

2. Нажмите кнопку **создать**, а затем выберите параметры для следующих элементов:

   * Укажите имя новой **рабочей области log Analytics**, например *дефаултлаворкспаце*. 
   * Выберите **подписку** для связи, выбрав из раскрывающегося списка, если выбранное по умолчанию значение не подходит.
   * В поле **Группа ресурсов**выберите существующую группу ресурсов, содержащую одну или несколько виртуальных машин Azure. <br><br>

      ![Колонка "Создание Log Analytics ресурсов"](media/configure-azure-monitor/create-loganalytics-workspace-02.png) <br><br>  

3. После ввода необходимых сведений в области **log Analytics Рабочая область** нажмите кнопку **ОК**.  

При проверке сведений и создании рабочей области можно отслеживать ход выполнения в разделе **уведомления** в меню. 

#### <a name="obtain-workspace-id-and-key"></a>Получение идентификатора и ключа рабочей области
Перед установкой Microsoft Monitoring Agent для Windows вам потребуется идентификатор и ключ рабочей области Log Analytics.  Эти сведения необходимы мастеру установки для правильной настройки агента и обеспечения его успешной связи с Log Analytics.  

1. В портал Azure щелкните **все службы** , найденные в верхнем левом углу. В списке ресурсов введите **log Analytics**. По мере ввода, список фильтруется на основе введенных данных. Выберите **log Analytics**.
2. В списке Log Analytics рабочих областей выберите *дефаултлаворкспаце* , созданные ранее.
3. Выберите **Дополнительные параметры**.<br><br> ![Log Analytics дополнительные параметры](media/configure-azure-monitor/log-analytics-advanced-settings-01.png)<br><br>  
4. Выберите **подключенные источники**, а затем выберите **серверы Windows**.   
5. Значение справа от **идентификатора рабочей области** и **первичного ключа**. Сохраните оба временного копирования и вставьте их в свой любимый редактор.   

### <a name="installing-the-agent-on-windows"></a>Установка агента в Windows
Следующие шаги устанавливают и настраивают Microsoft Monitoring Agent. **Не забудьте установить этот агент на каждом сервере в кластере и указать, что агент должен запускаться при запуске Windows.**

1. На странице **серверы Windows** выберите подходящую версию **агента Windows** для загрузки в зависимости от архитектуры процессора операционной системы Windows.
2. Запустите программу установки, чтобы установить агент на компьютере.
2. На странице **приветствия** нажмите кнопку **Далее**.
3. На странице **условия лицензии** Прочтите лицензию и нажмите кнопку **принимаю**.
4. На странице **Папка назначения** измените или сохраните папку установки по умолчанию, а затем нажмите кнопку **Далее**.
5. На странице **Параметры установки агента** выберите подключение агента к Azure log Analytics а затем нажмите кнопку **Далее**.   
6. На странице **log Analytics Azure** выполните следующие действия.
   1. Вставьте **идентификатор рабочей области** и **ключ рабочей области (первичный ключ)** , скопированные ранее.    
    а) Если компьютер должен взаимодействовать через прокси-сервер со службой Log Analytics, нажмите кнопку **Дополнительно** и укажите URL-адрес и номер порта прокси-сервера.  Если для прокси-сервера требуется проверка подлинности, введите имя пользователя и пароль для проверки подлинности на прокси-сервере, а затем нажмите кнопку **Далее**.  
7. После завершения предоставления необходимых параметров конфигурации нажмите кнопку **Далее** .<br><br> ![вставить идентификатор рабочей области и первичный ключ](media/configure-azure-monitor/log-analytics-mma-setup-laworkspace.png)<br><br>
8. На странице **все готово для установки** просмотрите выбранные параметры и нажмите кнопку **установить**.
9. На странице **Настройка успешно завершена** нажмите кнопку **Готово**.

По завершении на **панели управления**появится **Microsoft Monitoring Agent** . Вы можете проверить конфигурацию и убедиться, что агент подключен к Log Analytics. При подключении на вкладке **log Analytics Azure** агент отображает сообщение о том **, что Microsoft Monitoring Agent успешно подключился к службе Microsoft log Analytics.** 

![MMA состояние подключения к Log Analytics](media/configure-azure-monitor/log-analytics-mma-laworkspace-status.png)

Чтобы ознакомиться с поддерживаемой конфигурацией, ознакомьтесь с [поддерживаемыми операционными системами Windows](https://docs.microsoft.com/azure/azure-monitor/platform/log-analytics-agent#supported-windows-operating-systems) и [конфигурацией сетевого брандмауэра](https://docs.microsoft.com/azure/azure-monitor/platform/log-analytics-agent#network-firewall-requirements).

## <a name="setting-up-alerts-using-windows-admin-center"></a>Настройка оповещений с помощью центра администрирования Windows

В центре администрирования Windows можно настроить оповещения по умолчанию, которые будут применяться ко всем серверам в рабочей области Log Analytics. 

![GIF для настройки оповещений»](media/configure-azure-monitor/setup1.gif)

Это предупреждения и их условия по умолчанию, которые можно использовать.

| Имя оповещения                | Условие по умолчанию                                  |
|---------------------------|----------------------------------------------------|
| Использование ЦП           | Свыше 85% на 10 минут                            |
| Использование емкости диска | Свыше 85% на 10 минут                            |
| Использование памяти        | Объем доступной памяти менее 100 МБ в течение 10 минут   |
| Периодический сигнал                 | Меньше 2 переритмов в течение 5 минут                   |
| Критическая ошибка системы     | Любое критическое оповещение в журнале событий системы кластера |
| Оповещение службы работоспособности      | Любая ошибка службы работоспособности в кластере            |

После настройки оповещений в центре администрирования Windows можно просмотреть оповещения в рабочей области log Analytics в Azure.

![GIF для настройки оповещений»](media/configure-azure-monitor/setup2.gif)

Во время этого процесса адаптации действия, приведенные ниже, выполняются внутри. Мы подробно рассмотрим, как настроить их в случае необходимости ручной настройки кластера. 

### <a name="collecting-event-and-performance-data"></a>Сбор данных о событиях и производительности

Log Analytics может получать события из журнала событий Windows и счетчиков производительности, указанных для долгосрочного анализа и создания отчетов, и предпринимать действия при обнаружении определенного условия.  Выполните следующие действия, чтобы настроить сбор событий из журнала событий Windows и несколько распространенных счетчиков производительности для запуска.  

1. В портал Azure щелкните **больше служб** , найденных в левом нижнем углу. В списке ресурсов введите **log Analytics**. По мере ввода, список фильтруется на основе введенных данных. Выберите **log Analytics**.
2. Выберите **Дополнительные параметры**.<br><br> ![Log Analytics дополнительные параметры](media/configure-azure-monitor/log-analytics-advanced-settings-01.png)<br><br> 
3. Выберите **данные**, а затем выберите **журналы событий Windows**.  
4. Добавьте служба работоспособности канал событий, введя имя ниже, а затем щелкните знак плюса **+** .  
   ```
   Event Channel: Microsoft-Windows-Health/Operational
   ```
5. В таблице проверьте **ошибки** и **предупреждения**уровня серьезности.   
6. Щелкните **сохранить** в верхней части страницы, чтобы сохранить конфигурацию.
7. Выберите **счетчики производительности Windows** , чтобы включить сбор данных счетчиков производительности на компьютере Windows. 
8. При первой настройке счетчиков производительности Windows для новой рабочей области Log Analytics можно быстро создать несколько распространенных счетчиков. Они перечислены флажками рядом с каждым из них.<br> ![выбранные счетчики производительности Windows по умолчанию](media/configure-azure-monitor/windows-perfcounters-default.png)<br> Щелкните **Добавить выбранные счетчики производительности**.  Они добавляются и предустанавливаются с интервалом в 10 секунд сбора.  
9. Щелкните **сохранить** в верхней части страницы, чтобы сохранить конфигурацию.

## <a name="creating-alerts-based-on-log-data"></a>Создание предупреждений на основе данных журнала

Если вы сделали это до сих пор, кластер должен отправлять журналы и счетчики производительности в Log Analytics. Следующим шагом является создание правил генерации оповещений, автоматически выполняющих поиск по журналам с регулярными интервалами. Если результаты поиска по журналам соответствуют определенным условиям, создается предупреждение, которое отправляет вам сообщение электронной почты или текстовое уведомление. Давайте рассмотрим эту ссылку.

### <a name="create-a-query"></a>Создание запроса

Для начала откройте портал поиска по журналам.   

1. В портал Azure щелкните **все службы**. В списке ресурсов введите **Monitor**. По мере ввода, список фильтруется на основе введенных данных. Выберите **монитор**.
2. В меню навигации монитора выберите **log Analytics** , а затем выберите рабочую область.

Самый быстрый способ извлечь некоторые данные для работы — простой запрос, возвращающий все записи в таблице. Введите следующие запросы в поле поиска и нажмите кнопку поиска.  

```
Event
```

Данные возвращаются в представлении списка по умолчанию, и можно увидеть общее количество возвращенных записей.

![Простой запрос](media/configure-azure-monitor/log-analytics-portal-eventlist-01.png)

В левой части экрана находится панель фильтра, которая позволяет добавить фильтрацию в запрос, не изменяя его напрямую.  Для этого типа записи отображаются несколько свойств записей, и можно выбрать одно или несколько значений свойств, чтобы уточнить результаты поиска.

Установите флажок рядом с элементом **Ошибка** в разделе **него eventlevelname** или введите следующую команду, чтобы ограничить результаты событиями ошибок.

```
Event | where (EventLevelName == "Error")
```

![Фильтр](media/configure-azure-monitor/log-analytics-portal-eventlist-02.png)

После выполнения запросов аппрориате для событий, которые вас интересуют, сохраните их для следующего шага.

### <a name="create-alerts"></a>Создание оповещений
Теперь давайте рассмотрим пример создания оповещения.

1. В портал Azure щелкните **все службы**. В списке ресурсов введите **log Analytics**. По мере ввода, список фильтруется на основе введенных данных. Выберите **log Analytics**.
2. В области слева выберите **оповещения** , а затем в верхней части страницы щелкните **новое правило генерации оповещений** , чтобы создать новое оповещение.<br><br> ![создать новое правило генерации оповещений](media/configure-azure-monitor/alert-rule-02.png)<br>
3. Для первого шага в разделе **Создание оповещения** будет выбрана рабочая область log Analytics в качестве ресурса, так как это сигнал оповещения на основе журнала.  Отфильтруйте результаты, выбрав определенную **подписку** из раскрывающегося списка, если у вас больше одного, который содержит log Analytics созданную ранее рабочую область.  Отфильтруйте **тип ресурса** , выбрав **log Analytics** из раскрывающегося списка.  Наконец, выберите **ресурс** **дефаултлаворкспаце** и нажмите кнопку **Готово**.<br><br> ![задачи создания предупреждения](media/configure-azure-monitor/alert-rule-03.png)<br>
4. В разделе **условия оповещения**щелкните **Добавить условие** , чтобы выбрать сохраненный запрос, а затем укажите логику, которую следует использовать в правиле оповещения.
5. Настройте оповещение со следующими сведениями:  
   а) В раскрывающемся списке **на основе** выберите **измерение метрик**.  Измерение метрики создаст предупреждение для каждого объекта в запросе со значением, превышающим указанный порог.  
   б. Для **условия**выберите **больше** и укажите сершолд.  
   в. Затем определите, когда следует активировать оповещение. Например, можно выбрать **последовательные нарушения** и в раскрывающемся списке выбрать значение больше, **чем** 3.  
   . В разделе Оценка на основе раздела измените значение параметра **период** на **30** минут и **частоту** на 5. Правило будет выполняться каждые пять минут и вернет записи, которые были созданы за последние 30 минут с текущего момента.  Установка для периода времени более широкой учетной записи для возможной задержки данных, а также гарантирует, что запрос возвращает данные, чтобы избежать ложного отрицательного значения, при котором предупреждение никогда не срабатывает.  
6. Нажмите кнопку **Готово** , чтобы завершить правило генерации оповещений.<br><br> ![настроить сигнал оповещения](media/configure-azure-monitor/alert-signal-logic-02.png)<br> 
7. Теперь, когда вы перейдете на второй шаг, укажите имя оповещения в поле **имя правила генерации оповещений** , например **предупреждение для всех событий ошибок**.  Укажите подробные **описания** для предупреждения и выберите значение **критическое (уровень серьезности 0)** для параметра **серьезность** в указанных параметрах.
8. Чтобы немедленно активировать правило генерации оповещений при создании, примите значение по умолчанию для параметра **включить правило при создании**.
9. Для третьего и последнего шага необходимо указать **группу действий**, которая гарантирует, что одни и те же действия будут выполняться каждый раз при активации оповещения и могут использоваться для каждого определяемого правила. Настройте новую группу действий со следующими сведениями:  
   а) Выберите пункт **создать группу действий** , после чего появится панель **Добавление группы действий** .  
   б. В качестве **имени группы действий**укажите имя, например **операции ИТ-уведомлений** , и **короткое имя** , например **итопс-n**.  
   в. Проверьте правильность значений по умолчанию для **подписки** и **группы ресурсов** . В противном случае выберите правильный вариант из раскрывающегося списка.   
   . В разделе действия укажите имя действия, например **Отправить сообщение электронной почты** и в поле **тип действия** выберите **Электронная почта, SMS, Push/Voice** в раскрывающемся списке. Панель "свойства **электронной почты/SMS/Push/Voice** " откроется справа, чтобы предоставить дополнительные сведения.  
   д) На панели **Электронная почта, SMS/Push/Voice** выберите и настройте свои предпочтения. Например, включите **электронную почту** и укажите допустимый SMTP-адрес электронной почты для доставки сообщения.  
   е) Нажмите кнопку **ОК**, чтобы сохранить изменения.<br><br> 

    ![Создать новую группу действий](media/configure-azure-monitor/action-group-properties-01.png)

10. Нажмите кнопку **ОК** , чтобы завершить группу действий. 
11. Щелкните **создать правило генерации оповещений** , чтобы завершить правило генерации оповещений. Он начинает выполняться немедленно.<br><br> ![завершить создание нового правила генерации оповещений](media/configure-azure-monitor/alert-rule-01.png)<br> 

### <a name="example-alert"></a>Пример оповещения

Для справки вот как выглядит пример оповещения в Azure.

![GIF оповещения в Azure](media/configure-azure-monitor/alert.gif)

Ниже приведен пример сообщения электронной почты, которое будет отправлено Azure Monitor:

![Пример оповещения по электронной почте](media/configure-azure-monitor/warning.png)

## <a name="see-also"></a>См. также:

- [Обзор Локальные дисковые пространства](storage-spaces-direct-overview.md)
- Более подробные сведения см. в [документации по Azure Monitor](https://docs.microsoft.com/azure/azure-monitor/learn/tutorial-viewdata).
- Дополнительные сведения о [подключении к другим гибридным службам Azure](../../manage/windows-admin-center/azure/index.md)см. в этой статье.
