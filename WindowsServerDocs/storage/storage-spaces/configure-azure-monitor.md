---
title: Изучение и настройка Azure Monitor
description: Подробные сведения о настройке Azure Monitor и настройке оповещений электронной почты и SMS для кластера локальных дисковых пространств в Windows Server 2016 и 2019.
keywords: Локальные дисковые пространства, Azure Monitor, уведомления, электронная почта, SMS
ms.assetid: ''
ms.prod: ''
ms.author: adagashe
ms.technology: storage-spaces
ms.topic: article
author: adagashe
ms.date: 3/26/2019
ms.localizationpriority: ''
ms.openlocfilehash: 4a11ad670bdd26cdc771bb5ae357db4928995bb8
ms.sourcegitcommit: bfe9c5f7141f4f2343a4edf432856f07db1410aa
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/25/2019
ms.locfileid: "75352643"
---
---
# <a name="use-azure-monitor-to-send-emails-for-health-service-faults"></a>Использование Azure Monitor для отправки сообщений электронной почты о сбоях служба работоспособности

>Область применения: Windows Server 2019, Windows Server 2016

Служба Azure Monitor обеспечивает максимальную доступность и производительность приложений, предоставляя полноценное решение для сбора, анализа и обработки данных телеметрии из облачных и локальных сред. Она поможет вам понять, как выполняются приложения, а также заранее определить проблемы, влияющие на них, и ресурсы, от которых они зависят.

Это особенно полезно для локального кластера с поддержкой Hyper-in. Благодаря встроенной Azure Monitor Вы сможете настроить электронную почту, текст (SMS) и другие оповещения, чтобы проверить связь с вами при возникновении проблем с кластером (или если требуется отметить некоторые другие действия в зависимости от собираемых данных). Ниже будет кратко объяснено, как работает Azure Monitor, как установить Azure Monitor и как настроить его для отправки уведомлений.


## <a name="understanding-azure-monitor"></a>Основные сведения о Azure Monitor

Все данные, собранные Azure Monitor, помещаются в один из двух фундаментальных типов: метрики и журналы.

1. [Метрики](https://docs.microsoft.com/azure/azure-monitor/platform/data-collection#metrics) — это числовые значения, описывающие конкретный аспект системы в определенный момент времени. Они занимают небольшой объем, и их можно использовать в сценариях, предусматривающих работу в режиме практически реального времени. Данные, собранные Azure Monitor прямо на странице "Обзор", отображаются в портал Azure.

![изображение метрик, принимающих данные в обозревателе метрик](media/configure-azure-monitor/metrics.png)

2. [Журналы](https://docs.microsoft.com/azure/azure-monitor/platform/data-collection#logs) содержат данные различных типов, упорядоченные по записям с разными наборами свойств для каждого типа. Помимо данных производительности в системе (в виде журналов) хранятся данные телеметрии, например события и трассировки, так что можно объединить все эти данные для анализа. Данные журналов, собранные службой Azure Monitor, можно проанализировать с помощью [запросов](https://docs.microsoft.com/azure/azure-monitor/log-query/log-query-overview), которые быстро получают, консолидируют и анализируют собранные данные. Вы можете создавать и тестировать запросы с помощью [Log Analytics](https://docs.microsoft.com/azure/azure-monitor/log-query/portals) на портале Azure, а затем либо напрямую анализировать данные с помощью этих средств, либо сохранять запросы для использования с [визуализациями](https://docs.microsoft.com/azure/azure-monitor/visualizations) или [правилами генерации оповещений](https://docs.microsoft.com/azure/azure-monitor/platform/alerts-overview).

![изображение журналов, принимающих данные в log Analytics](media/configure-azure-monitor/logs.png)

Ниже приводятся дополнительные сведения о настройке этих оповещений.

## <a name="onboarding-your-cluster-using-windows-admin-center"></a>Подключение кластера с помощью центра администрирования Windows

С помощью центра администрирования Windows можно подключить кластер к Azure Monitor.

![GIF-файл для адаптации кластера к Azure Monitor "](media/configure-azure-monitor/onboarding.gif)

Во время этого процесса адаптации действия, приведенные ниже, выполняются внутри. Мы подробно рассмотрим, как настроить их в случае необходимости ручной настройки кластера. 

### <a name="configuring-health-service"></a>Настройка служба работоспособности

В первую очередь необходимо настроить кластер. Как вы, возможно, узнаете, [Служба работоспособности](../../failover-clustering/health-service-overview.md) улучшает повседневный мониторинг и эксплуатацию для кластеров под управлением Локальные дисковые пространства. 

Как было показано выше, Azure Monitor собирает журналы из каждого узла, на котором они выполняются в кластере. Поэтому необходимо настроить служба работоспособности для записи в канал событий, который:

```
Event Channel: Microsoft-Windows-Health/Operational
Event ID: 8465
```

Чтобы настроить служба работоспособности, выполните:

```PowerShell
get-storagesubsystem clus* | Set-StorageHealthSetting -Name "Platform.ETW.MasTypes" -Value "Microsoft.Health.EntityType.Subsystem,Microsoft.Health.EntityType.Server,Microsoft.Health.EntityType.PhysicalDisk,Microsoft.Health.EntityType.StoragePool,Microsoft.Health.EntityType.Volume,Microsoft.Health.EntityType.Cluster"
```

При выполнении приведенного выше командлета, чтобы задать параметры работоспособности, события, которые мы хотим записать, будут записаны в канал событий *Microsoft-Windows-Health/эксплуатация* .

### <a name="configuring-log-analytics"></a>Настройка Log Analytics

Теперь, когда вы настроили правильную регистрацию в кластере, следующим шагом является правильная настройка log Analytics.

Чтобы получить общие сведения, [Azure log Analytics](https://docs.microsoft.com/azure/azure-monitor/platform/agent-windows) может получать данные непосредственно с физических или виртуальных компьютеров Windows в вашем центре обработки данных или в другой облачной среде в одном репозитории для подробного анализа и корреляции.

Дополнительные сведения о поддерживаемой конфигурации см. в разделах о [поддерживаемых операционных системах Windows](https://docs.microsoft.com/azure/azure-monitor/platform/log-analytics-agent#supported-windows-operating-systems) и [требованиях к сетевым брандмауэрам](https://docs.microsoft.com/azure/azure-monitor/platform/log-analytics-agent#network-firewall-requirements).

Если у вас еще нет подписки Azure, создайте [бесплатную учетную запись Azure](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу.

#### <a name="login-in-to-azure-portal"></a>Вход на портал Azure

Войдите на портал Azure по адресу [https://portal.azure.com](https://azure.microsoft.com/free/?WT.mc_id=A261C142F).

#### <a name="create-a-workspace"></a>Создание рабочего пространства

Дополнительные сведения о действиях, перечисленных ниже, см. в [документации по Azure Monitor](https://docs.microsoft.com/azure/azure-monitor/learn/quick-collect-windows-computer).

1. На портале Azure щелкните **Все службы**. В списке ресурсов введите **Log Analytics**. Элементы списка фильтруются автоматически по мере ввода символов. Выберите **Log Analytics**.<br><br> 

   ![Портал Azure](media/configure-azure-monitor/azure-portal-01.png)<br><br>

2. Щелкните **Создать** и задайте следующие параметры:

   * Введите имя для новой **рабочей области Log Analytics**, например *DefaultLAWorkspace*. 
   * Выберите в раскрывающемся списке **Подписку**, с которой нужно связать рабочую область, если выбранная по умолчанию не подходит.
   * В разделе **Группа ресурсов** выберите имеющуюся группу ресурсов, в которой содержится одна или несколько виртуальных машин Azure. <br><br>

      ![Колонка создания ресурса Log Analytics](media/configure-azure-monitor/create-loganalytics-workspace-02.png) <br><br>  

3. После ввода необходимых сведений в области **Рабочая область Log Analytics** щелкните **OK**.  

Пока проверяются данные, ход создания рабочей области можно проверить в разделе **Уведомления** в меню. 

#### <a name="obtain-workspace-id-and-key"></a>Получение идентификатора и ключа рабочей области
Перед установкой Microsoft Monitoring Agent для Windows требуется получить идентификатор и ключ для рабочей области Log Analytics.  Эта информация необходима мастеру установки для правильной настройки агента и обеспечения его взаимодействия с Log Analytics.  

1. На портале Azure щелкните **Все службы** в нижнем левом углу. В списке ресурсов введите **Log Analytics**. Элементы списка фильтруются автоматически по мере ввода символов. Выберите **Log Analytics**.
2. В списке рабочих областей Log Analytics выберите рабочую область *DefaultLAWorkspace*, созданную ранее.
3. Выберите **Дополнительные параметры**.<br><br> ![Дополнительные параметры Log Analytics](media/configure-azure-monitor/log-analytics-advanced-settings-01.png)<br><br>  
4. Выберите **Подключенные источники**, а затем выберите **Серверы с Windows**.   
5. Необходимые значения указаны справа от полей **Идентификатор рабочей области** и **Первичный ключ**. Сохраните оба временного копирования и вставьте их в свой любимый редактор.   

### <a name="installing-the-agent-on-windows"></a>Установка агента в Windows
Следующие шаги устанавливают и настраивают Microsoft Monitoring Agent. **Не забудьте установить этот агент на каждом сервере в кластере и указать, что агент должен запускаться при запуске Windows.**

1. На странице **Серверы с Windows** выберите соответствующую версию **агента для Windows** для скачивания в зависимости от архитектуры процессора, на котором выполняется операционная система Windows.
2. Запустите программу установки, чтобы установить агент на компьютере.
2. На странице **приветствия** нажмите кнопку **Далее**.
3. На странице **Условия лицензии** прочтите лицензию и нажмите кнопку **Принимаю**.
4. На странице **Папка назначения** измените или оставьте папку установки по умолчанию и нажмите кнопку **Далее**.
5. На странице **Параметры установки агента** выберите подключение агента к Azure Log Analytics и нажмите **Далее**.   
6. На странице **Azure Log Analytics** выполните следующее.
   1. Вставьте **идентификатор рабочей области** и **ключ рабочей области (первичный ключ)** , скопированные ранее.    
    А. Если компьютер должен обмениваться данными со службой Log Analytics через прокси-сервер, щелкните **Дополнительно** и укажите URL-адрес и номер порта прокси-сервера.  Если для доступа к прокси-серверу требуется аутентификация, введите имя пользователя и пароль для аутентификации на прокси-сервере, затем нажмите кнопку **Далее**.  
7. Нажмите кнопку **Далее** после завершения ввода необходимых параметров конфигурации.<br><br> ![Вставка идентификатора рабочей области и первичного ключа](media/configure-azure-monitor/log-analytics-mma-setup-laworkspace.png)<br><br>
8. На странице **Готовность к установке** просмотрите выбранные параметры и нажмите кнопку **Установить**.
9. На странице **Настройка успешно завершена** нажмите кнопку **Готово**.

По завершении на **Microsoft Monitoring Agent** появится **Microsoft Management Agent**. Вы можете просмотреть конфигурацию и проверить, подключен ли агент к Log Analytics. При подключении на вкладке **Azure Log Analytics** агент выдает сообщение о том, что **Microsoft Monitoring Agent успешно подключен к службе Microsoft Log Analytics.** 

![Состояние подключения MMA к Log Analytics](media/configure-azure-monitor/log-analytics-mma-laworkspace-status.png)

Дополнительные сведения о поддерживаемой конфигурации см. в разделах о [поддерживаемых операционных системах Windows](https://docs.microsoft.com/azure/azure-monitor/platform/log-analytics-agent#supported-windows-operating-systems) и [требованиях к сетевым брандмауэрам](https://docs.microsoft.com/azure/azure-monitor/platform/log-analytics-agent#network-firewall-requirements).

## <a name="setting-up-alerts-using-windows-admin-center"></a>Настройка оповещений с помощью центра администрирования Windows

В центре администрирования Windows можно настроить оповещения по умолчанию, которые будут применяться ко всем серверам в рабочей области Log Analytics. 

![GIF для настройки оповещений»](media/configure-azure-monitor/setup1.gif)

Это предупреждения и их условия по умолчанию, которые можно использовать.

| Имя оповещения                | Условие по умолчанию                                  |
|---------------------------|----------------------------------------------------|
| Использование ЦП           | Свыше 85% на 10 минут                            |
| Использование емкости диска | Свыше 85% на 10 минут                            |
| Использование памяти        | Объем доступной памяти менее 100 МБ в течение 10 минут   |
| Периодический сигнал                 | Меньше 2 переритмов в течение 5 минут                   |
| Критическая ошибка системы     | Любое критическое оповещение в журнале событий системы кластера |
| Оповещение службы работоспособности      | Любая ошибка службы работоспособности в кластере            |

После настройки оповещений в центре администрирования Windows можно просмотреть оповещения в рабочей области log Analytics в Azure.

![GIF для настройки оповещений»](media/configure-azure-monitor/setup2.gif)

Во время этого процесса адаптации действия, приведенные ниже, выполняются внутри. Мы подробно рассмотрим, как настроить их в случае необходимости ручной настройки кластера. 

### <a name="collecting-event-and-performance-data"></a>Сбор данных о событиях и производительности

Log Analytics может собирать события из журналов событий и счетчиков производительности Windows, указанных для долгосрочного анализа и формирования отчетов, а также предпринимать действия при обнаружении определенного условия.  Сначала выполните приведенные ниже действия для настройки сбора событий из журнала событий Windows, а также нескольких стандартных счетчиков производительности.  

1. На портале Azure щелкните **Другие службы** в нижнем левом углу. В списке ресурсов введите **Log Analytics**. Элементы списка фильтруются автоматически по мере ввода символов. Выберите **Log Analytics**.
2. Выберите **Дополнительные параметры**.<br><br> ![Дополнительные параметры Log Analytics](media/configure-azure-monitor/log-analytics-advanced-settings-01.png)<br><br> 
3. Выберите **Данные**, а затем — **Журналы событий Windows**.  
4. Добавьте служба работоспособности канал событий, введя имя ниже, а затем щелкните знак плюса **+** .  
   ```
   Event Channel: Microsoft-Windows-Health/Operational
   ```
5. Проверьте степени серьезности **Ошибка** и **Предупреждение** в таблице.   
6. В верхней части страницы щелкните **Сохранить**, чтобы сохранить конфигурацию.
7. Выберите **Счетчики производительности Windows**, чтобы включить сбор данных счетчиков производительности на компьютере Windows. 
8. При первой настройке счетчиков производительности Windows для новой рабочей области Log Analytics вы можете быстро создать несколько распространенных счетчиков. Рядом с каждым счетчиком в списке есть флажок.<br> ![Выбраны стандартные счетчики производительности Windows](media/configure-azure-monitor/windows-perfcounters-default.png)<br> Щелкните **Add the selected performance counters** (Добавить выбранные счетчики производительности).  Они добавляются и устанавливаются с десятисекундным интервалом сбора.  
9. В верхней части страницы щелкните **Сохранить**, чтобы сохранить конфигурацию.

## <a name="creating-alerts-based-on-log-data"></a>Создание предупреждений на основе данных журнала

Если вы сделали это до сих пор, кластер должен отправлять журналы и счетчики производительности в Log Analytics. Следующим шагом является создание правил генерации оповещений, автоматически выполняющих поиск по журналам с регулярными интервалами. Если результаты поиска по журналам соответствуют определенным условиям, создается предупреждение, которое отправляет вам сообщение электронной почты или текстовое уведомление. Давайте рассмотрим эту ссылку.

### <a name="create-a-query"></a>Создание запроса

Откройте портал поиска по журналам, используя   

1. На портале Azure щелкните **Все службы**. В списке ресурсов введите **Монитор**. Элементы списка фильтруются автоматически по мере ввода символов. Щелкните **Монитор**.
2. В меню навигации выберите **Log Analytics** и нужную рабочую область.

Самый быстрый способ получить некоторые данные для работы — создать простой запрос, который возвращает все записи в таблице. Введите следующие запросы в поле поиска и нажмите кнопку поиска.  

```
Event
```

Данные возвращаются в представлении списка по умолчанию. Вы можете просмотреть общее количество возвращенных записей.

![Простой запрос](media/configure-azure-monitor/log-analytics-portal-eventlist-01.png)

В левой области экрана расположена панель фильтров, которая позволяет добавить фильтрацию к запросу, не изменяя его напрямую.  Для этого типа записи показано несколько свойств. Вы можете выбрать одно или несколько значений свойств для сужения результатов поиска.

Установите флажок рядом с элементом **Ошибка** в разделе **него eventlevelname** или введите следующую команду, чтобы ограничить результаты событиями ошибок.

```
Event | where (EventLevelName == "Error")
```

![Фильтр](media/configure-azure-monitor/log-analytics-portal-eventlist-02.png)

После выполнения запросов аппрориате для событий, которые вас интересуют, сохраните их для следующего шага.

### <a name="create-alerts"></a>Создание оповещений
Теперь давайте рассмотрим пример создания оповещения.

1. На портале Azure щелкните **Все службы**. В списке ресурсов введите **Log Analytics**. Элементы списка фильтруются автоматически по мере ввода символов. Выберите **Log Analytics**.
2. На панели слева выберите **Оповещения** и щелкните **Новое правило генерации оповещений** в верхней части страницы, чтобы создать оповещение.<br><br> ![Создание правила генерации оповещений](media/configure-azure-monitor/alert-rule-02.png)<br>
3. Сначала выберите в разделе **Создать оповещение** рабочую область Log Analytics в качестве ресурса, так как мы создаем сигнал оповещения на основе журналов.  Отфильтруйте результаты, выбрав определенную **подписку** из раскрывающегося списка, если у вас больше одного, который содержит log Analytics созданную ранее рабочую область.  Отфильтруйте по **типу ресурса**, выбрав **Log Analytics** из раскрывающегося списка.  Наконец, выберите **ресурс** **дефаултлаворкспаце** и нажмите кнопку **Готово**.<br><br> ![Создание оповещения, шаг 1](media/configure-azure-monitor/alert-rule-03.png)<br>
4. В разделе **условия оповещения**щелкните **Добавить условие** , чтобы выбрать сохраненный запрос, а затем укажите логику, которую следует использовать в правиле оповещения.
5. Настройте оповещение, указав следующие сведения:  
   А. В раскрывающемся списке **На основе** выберите **Измерение метрик**.  Измерение метрик позволяет создать оповещение для каждого объекта в запросе, для которого значение превышает указанное пороговое значение.  
   Б. Для **условия**выберите **больше** и укажите сершолд.  
   в. Затем определите, когда следует активировать оповещение. Например, можно выбрать **последовательные нарушения** и в раскрывающемся списке выбрать значение больше, **чем** 3.  
   г. В разделе Оценка на основе раздела измените значение параметра **период** на **30** минут и **частоту** на 5. Это правило будет запускаться каждые пять минут и возвращать все записи, созданные за последние тридцать минут.  Установка большего периода потенциально может привести к задержкам при передаче данных, но в то же время гарантирует, что запрос всегда будет возвращать данные. Это, в свою очередь, позволит избежать ложноотрицательных результатов, при которых оповещение не срабатывает.  
6. Щелкните **Готово**, чтобы завершить создание правила генерации оповещений.<br><br> ![Настройка сигнала оповещения](media/configure-azure-monitor/alert-signal-logic-02.png)<br> 
7. Теперь, когда вы перейдете на второй шаг, укажите имя оповещения в поле **имя правила генерации оповещений** , например **предупреждение для всех событий ошибок**.  Укажите подробное **описание** для оповещения и выберите уровень **Критический (уровень серьезности 0)** из представленных в поле **Серьезность** вариантов.
8. Чтобы правило генерации оповещений начало работать сразу после создания, сохраните установленный по умолчанию флажок **Включить правило при создании**.
9. На последнем, третьем, шаге укажите **группу действий**, которая позволит гарантировать выполнение одинаковых действий всякий раз, когда активируется это оповещение. Эту функцию можно использовать для каждого созданного правила. Настройте новую группу действий со следующими параметрами:  
   А. Выберите **Новая группа действий**, чтобы открыть панель **Добавить группу действий**.  
   Б. В поле **Имя группы действий** укажите имя, например **Уведомление ИТ-отдела**, и **короткое имя**, например **itops-n**.  
   в. Убедитесь, что в полях **Подписка** и **Группа ресурсов** заданы правильные значения по умолчанию. Если нет, выберите правильные варианты из раскрывающегося списка.   
   г. В разделе "Действия" укажите имя для этого действия, например **Отправить электронное письмо**, а в поле **Тип действия** выберите **Email/SMS/Push/Voice** (Электронная почта, SMS, push-уведомление, голосовой вызов) из раскрывающегося списка. Справа откроется панель свойств **Email/SMS/Push/Voice** (Электронная почта, SMS, push-уведомление, голосовой вызов) для дополнительных сведений.  
   e. На панели **Электронная почта, SMS/Push/Voice** выберите и настройте свои предпочтения. Например, включите **электронную почту** и укажите допустимый SMTP-адрес электронной почты для доставки сообщения.  
   е. Нажмите кнопку **ОК** , чтобы сохранить изменения.<br><br> 

    ![Создание группы действий](media/configure-azure-monitor/action-group-properties-01.png)

10. Нажмите кнопку **ОК**, чтобы завершить создание группы действий. 
11. Щелкните **Создать правило генерации оповещений**, чтобы завершить создание этого правила. Оно начнет выполняться немедленно.<br><br> ![Завершение создания правила генерации оповещений](media/configure-azure-monitor/alert-rule-01.png)<br> 

## <a name="see-alerts"></a>Просмотр оповещений

Для справки вот как выглядит пример оповещения в Azure.

![GIF оповещения в Azure "](media/configure-azure-monitor/alert.gif)

Ниже приведен пример сообщения электронной почты, которое будет отправлено Azure Monitor:

![Пример оповещения по электронной почте](media/configure-azure-monitor/warning.png)

## <a name="see-also"></a>См. также статью

- [Обзор Локальные дисковые пространства](storage-spaces-direct-overview.md)
- Более подробные сведения см. в [документации по Azure Monitor](https://docs.microsoft.com/azure/azure-monitor/learn/tutorial-viewdata).
- Дополнительные сведения о [подключении к другим гибридным службам Azure](../../manage/windows-admin-center/azure/index.md)см. в этой статье.
