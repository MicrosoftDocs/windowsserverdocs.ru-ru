---
title: Освоение и настройка Azure Monitor
description: Подробные сведения об установке, на что такое Azure Monitor и настройка электронной почты и sms оповещений для кластера прямой пробелы хранилища в Windows Server 2016 и 2019 г.
keywords: Дисковыми пространствами, azure monitor, уведомлений, адрес электронной почты, sms
ms.assetid: ''
ms.prod: ''
ms.author: adagashe
ms.technology: storage-spaces
ms.topic: article
author: adagashe
ms.date: 3/26/2019
ms.localizationpriority: ''
ms.openlocfilehash: 908e4a7a75606905caebfa4b79168b3976982e6d
ms.sourcegitcommit: eaf071249b6eb6b1a758b38579a2d87710abfb54
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/31/2019
ms.locfileid: "66447594"
---
---
# <a name="use-azure-monitor-to-send-emails-for-health-service-faults"></a>Использование Azure Monitor для отправки сообщений электронной почты для ошибки службы работоспособности

>Относится к: Windows Server 2019, Windows Server 2016

Azure Monitor обеспечивает максимальную доступность и производительность приложений, обеспечивая комплексное решение для сбора, анализа и использования телеметрии из вашего облака и локальных средах. Он поможет вам понять, как выполняются приложения и заранее определяет проблемы, влияющие на их и ресурсы, от которых они зависят.

Это особенно полезно для локальной гиперконвергированного кластера. С помощью Azure Monitor интегрированы можно настроить адрес электронной почты, текст (SMS) и другие предупреждения для проверки связи, когда есть проблема с вашим кластером (или когда нужно пометить другое действие на основе собранных данных). Ниже мы кратко расскажем, как работает Azure Monitor, как установить Azure Monitor и как настроить его на отправку уведомлений.


## <a name="understanding-azure-monitor"></a>Основные сведения об Azure Monitor

Все данные, собранные Azure Monitor, помещаются в одну из двух основных типов: метрики и журналы.

1. [Метрики](https://docs.microsoft.com/en-us/azure/azure-monitor/platform/data-collection#metrics) — это числовые значения, которые описывают некоторые аспекты системы в определенной точке во времени. Это упрощенный и поддерживает практически сценариев в реальном времени. Вы увидите данные, собранные Azure Monitor правой кнопкой мыши на своей странице "Обзор" на портале Azure.

![изображение метрики приема в обозревателе метрик](media/configure-azure-monitor/metrics.png)

2. [Журналы](https://docs.microsoft.com/en-us/azure/azure-monitor/platform/data-collection#logs) содержат различные виды данных, упорядоченных в записи, в которых разные наборы свойств для каждого типа. Данные телеметрии, такие как события и трассировки хранятся в виде журналов в дополнение к данным производительности таким образом, чтобы он могут быть объединены для анализа. Данные журнала, полученных службой Azure Monitor можно проанализировать с помощью [запросы](https://docs.microsoft.com/en-us/azure/azure-monitor/log-query/log-query-overview) для быстрого получения, консолидации и анализа собранных данных. Можно создавать и тестировать запросы с помощью [Log Analytics](https://docs.microsoft.com/en-us/azure/azure-monitor/log-query/portals) в портале Azure, а затем либо напрямую анализировать данные с помощью этих средств или сохранять запросы для использования с [визуализации](https://docs.microsoft.com/en-us/azure/azure-monitor/visualizations) или [оповещение правила](https://docs.microsoft.com/en-us/azure/azure-monitor/platform/alerts-overview).

![Снимок экрана: журналы, прием в log analytics](media/configure-azure-monitor/logs.png)

Дополнительные сведения см. ниже будет зависеть как настроить эти оповещения.

## <a name="configuring-health-service"></a>Настройка службы работоспособности

Первое, что необходимо сделать, — это настройки кластера. Как вы знаете, [служба работоспособности](../../failover-clustering/health-service-overview.md) улучшает ежедневного мониторинга и опыт эксплуатации кластеров дисковыми пространствами. 

Как было показано выше, Azure Monitor собирает журналы из каждого узла, на котором он выполняется в кластере. Таким образом нам нужно настроить службу работоспособности для записи в канал событий, который является:

```
Event Channel: Microsoft-Windows-Health/Operational
Event ID: 8465
```

Чтобы настроить службу работоспособности, выполните:

```PowerShell
get-storagesubsystem clus* | Set-StorageHealthSetting -Name "Platform.ETW.MasTypes" -Value "Microsoft.Health.EntityType.Subsystem,Microsoft.Health.EntityType.Server,Microsoft.Health.EntityType.PhysicalDisk,Microsoft.Health.EntityType.StoragePool,Microsoft.Health.EntityType.Volume,Microsoft.Health.EntityType.Cluster"
```

При выполнении командлета, выше, чтобы задать параметры работоспособности, можно вызвать события, мы хотим начать, записываемый *Microsoft-Windows-работоспособности/Operational* канал событий.

## <a name="configuring-log-analytics"></a>Настройка Log Analytics

Теперь, когда вы настроили правильное ведение журнала в кластере, необходимо будет правильно настроить службу log analytics.

Для обзора, [Azure Log Analytics](https://docs.microsoft.com/en-us/azure/azure-monitor/platform/agent-windows) может собирать данные напрямую c физических или виртуальных компьютеров Windows в центре обработки данных или другой облачной среде в один репозиторий для подробного анализа и корреляции.

Сведения о поддерживаемых конфигурациях, просмотрите [поддерживаемые операционные системы Windows](https://docs.microsoft.com/en-us/azure/azure-monitor/platform/log-analytics-agent#supported-windows-operating-systems) и [конфигурации брандмауэра сети](https://docs.microsoft.com/en-us/azure/azure-monitor/platform/log-analytics-agent#network-firewall-requirements).

Если у вас нет подписки Azure, создайте [бесплатную учетную запись](https://azure.microsoft.com/free/?WT.mc_id=A261C142F) перед началом работы.

### <a name="login-in-to-azure-portal"></a>Войдите в портал Azure

Войдите на портал Azure по адресу [ https://portal.azure.com ](https://azure.microsoft.com/free/?WT.mc_id=A261C142F).

### <a name="create-a-workspace"></a>Создание рабочей области

Дополнительные сведения о приведенные ниже действия, см. в разделе [документация по Azure Monitor](https://docs.microsoft.com/en-us/azure/azure-monitor/learn/quick-collect-windows-computer).

1. На портале Azure щелкните **все службы**. В списке ресурсов введите **Log Analytics**. Как только вы начнете вводить, список фильтров на основе ввода. Выберите **Log Analytics**.<br><br> 

   ![Портал Azure](media/configure-azure-monitor/azure-portal-01.png)<br><br>

2. Нажмите кнопку **создать**, а затем выберите параметры для следующих элементов:

   * Укажите имя для нового **рабочей области Log Analytics**, такие как *DefaultLAWorkspace*. 
   * Выберите **подписки** для связывания, выбрав из раскрывающегося списка, если выбранная по умолчанию не подходит.
   * Для **группы ресурсов**, выберите существующую группу ресурсов, которая содержит один или несколько виртуальных машин Azure. <br><br>

      ![Создать колонку ресурса Log Analytics](media/configure-azure-monitor/create-loganalytics-workspace-02.png) <br><br>  

3. После ввода необходимых сведений на **рабочей области Log Analytics** панели щелкните **ОК**.  

Проверки данных и создания рабочей области, можно отслеживать ход его выполнения в разделе **уведомления** в меню. 

### <a name="obtain-workspace-id-and-key"></a>Получить идентификатор и ключ
Перед установкой Microsoft Monitoring Agent для Windows, требуется идентификатор и ключ для рабочей области Log Analytics.  Эта информация необходима мастеру установки для правильной настройки агента и обеспечения его взаимодействия с Log Analytics.  

1. На портале Azure щелкните **все службы** в верхнем левом углу. В списке ресурсов введите **Log Analytics**. Как только вы начнете вводить, список фильтров на основе ввода. Выберите **Log Analytics**.
2. В списке рабочих областей Log Analytics, выберите *DefaultLAWorkspace* созданного ранее.
3. Выберите **Дополнительные параметры**.<br><br> ![Дополнительные параметры log Analytics](media/configure-azure-monitor/log-analytics-advanced-settings-01.png)<br><br>  
4. Выберите **подключенные источники**, а затем выберите **серверов Windows**.   
5. Значение справа от **Ид_рабочей_области** и **первичный ключ**. Сохраните оба временно — скопируйте и вставьте в любом удобном редакторе на данный момент.   

## <a name="installing-the-agent-on-windows"></a>Установка агента на Windows
Следующие действия, установите и настройте Microsoft Monitoring Agent. **Не забудьте установить этот агент на каждом сервере в кластере и указать, что агент на запуск при загрузке Windows.**

1. На **серверов Windows** странице, выберите соответствующий **загрузить агент Windows** версию для загрузки в зависимости от архитектуры процессора операционной системы Windows.
2. Запустите программу установки для установки агента на компьютере.
2. На странице **приветствия** нажмите кнопку **Далее**.
3. На **условия лицензионного соглашения** странице, прочтите лицензию и нажмите кнопку **принимаю**.
4. На **конечная папка** странице, измените или оставьте папку установки по умолчанию и нажмите кнопку **Далее**.
5. На **параметры установки агента** выберите подключение агента к Azure Log Analytics, а затем нажмите кнопку **Далее**.   
6. На **Azure Log Analytics** странице, выполните следующие действия:
   1. Вставить **Ид_рабочей_области** и **ключ рабочей области (первичный ключ)** , скопированный ранее.    
    1. Если компьютер должен обмениваться данными через прокси-сервер, к службе Log Analytics, щелкните **Дополнительно** и укажите URL-адрес и номер порта прокси-сервера.  Если прокси-сервер требует проверки подлинности, введите имя пользователя и пароль для проверки подлинности на прокси-сервере и нажмите кнопку **Далее**.  
7. Нажмите кнопку **Далее** после завершения ввода необходимых параметров конфигурации.<br><br> ![Вставьте идентификатор рабочей области и первичный ключ](media/configure-azure-monitor/log-analytics-mma-setup-laworkspace.png)<br><br>
8. На **все готово для установки** странице, просмотрите выбранные параметры и нажмите кнопку **установить**.
9. На **Настройка успешно завершена** щелкните **Готово**.

По завершении **Microsoft Monitoring Agent** отображается в **панели управления**. Можно просмотреть конфигурацию и убедитесь, что агент подключен к Log Analytics. При подключении на **Azure Log Analytics** вкладке Агент выдает следующее сообщение: **Microsoft Monitoring Agent успешно подключен к службе Microsoft Log Analytics.** 

![Состояние подключения MMA к Log Analytics](media/configure-azure-monitor/log-analytics-mma-laworkspace-status.png)

Сведения о поддерживаемых конфигурациях, просмотрите [поддерживаемые операционные системы Windows](https://docs.microsoft.com/en-us/azure/azure-monitor/platform/log-analytics-agent#supported-windows-operating-systems) и [конфигурации брандмауэра сети](https://docs.microsoft.com/en-us/azure/azure-monitor/platform/log-analytics-agent#network-firewall-requirements).

## <a name="collecting-event-and-performance-data"></a>Сбор данных о событиях и производительности

Log Analytics может собирать события из журнала событий Windows и счетчики производительности, указанных для долгосрочного анализа и создания отчетов и предпринимать действия при обнаружении определенного условия.  Выполните следующие действия для настройки сбора событий из журнала событий Windows, а также нескольких стандартных счетчиков производительности для начала.  

1. На портале Azure щелкните **больше служб** в нижнем левом углу. В списке ресурсов введите **Log Analytics**. Как только вы начнете вводить, список фильтров на основе ввода. Выберите **Log Analytics**.
2. Выберите **Дополнительные параметры**.<br><br> ![Дополнительные параметры log Analytics](media/configure-azure-monitor/log-analytics-advanced-settings-01.png)<br><br> 
3. Выберите **данных**, а затем выберите **журналы событий Windows**.  
4. Здесь, добавить канал событий службы работоспособности, введя его имя и нажмите кнопку «плюс» **+** .  
   ```
   Event Channel: Microsoft-Windows-Health/Operational
   ```
5. В таблице, проверьте степени серьезности **ошибка** и **предупреждение**.   
6. Нажмите кнопку **Сохранить** в верхней части страницы, чтобы сохранить конфигурацию.
7. Выберите **счетчики производительности Windows** включить сбор данных счетчиков производительности на компьютере Windows. 
8. При первой настройке счетчиков производительности Windows для новой рабочей области Log Analytics, вам предоставляется возможность быстро создать несколько распространенных счетчиков. Они перечислены с флажком рядом с каждой.<br> ![Выбраны счетчики производительности Windows по умолчанию](media/configure-azure-monitor/windows-perfcounters-default.png)<br> Нажмите кнопку **добавить выбранные счетчики производительности**.  Они добавляются и устанавливаются с десятисекундным коллекции интервал выборки.  
9. Нажмите кнопку **Сохранить** в верхней части страницы, чтобы сохранить конфигурацию.

## <a name="creating-alerts-based-on-log-data"></a>Создание оповещений на основе данных журнала

Если он стал это далеко, кластера должен быть отправку журналов и счетчиков производительности в Log Analytics. Следующим шагом является создание правил генерации оповещений, которые автоматически выполняют поиск по журналам с регулярными интервалами. Если результаты поиска по журналам соответствуют определенным условиям, а затем создается оповещение, которое отправляет уведомление по электронной почте или текст. Давайте обсудим это ниже.

### <a name="create-a-query"></a>Создание запроса

Сначала откройте портал поиска по журналам.   

1. На портале Azure щелкните **все службы**. В списке ресурсов введите **монитор**. Как только вы начнете вводить, список фильтров на основе ввода. Выберите **монитор**.
2. В меню навигации монитора, выберите **Log Analytics** и затем выберите рабочую область.

Самый быстрый способ получить некоторые данные для работы с является простой запрос, возвращающий все записи в таблице. Введите следующие запросы в поле поиска и нажмите кнопку поиска.  

```
Event
```

Данные возвращаются в представлении списка по умолчанию, и вы увидите, сколько всего записей были возвращены.

![Простой запрос](media/configure-azure-monitor/log-analytics-portal-eventlist-01.png)

В левой части экрана — панель фильтра, которая позволяет добавить фильтрацию к запросу не изменяя его напрямую.  Для этого типа записи отображаются несколько свойств, и можно выбрать один или несколько значений свойств для сужения результатов поиска.

Установите флажок рядом с полем **ошибка** под **EVENTLEVELNAME** или введите следующую команду, чтобы ограничить результаты событиями ошибки.

```
Event | where (EventLevelName == "Error")
```

![Filter](media/configure-azure-monitor/log-analytics-portal-eventlist-02.png)

Получив соответствующие запросы, относящиеся к события, которые вас интересуют, сохраните их для следующего шага.

### <a name="create-alerts"></a>Создание оповещений
Теперь давайте подробно рассмотрим пример для создания оповещений.

1. На портале Azure щелкните **все службы**. В списке ресурсов введите **Log Analytics**. Как только вы начнете вводить, список фильтров на основе ввода. Выберите **Log Analytics**.
2. В области слева выберите **оповещения** и нажмите кнопку **новое правило генерации оповещений** в верхней части страницы, чтобы создать новое оповещение.<br><br> ![Создать новое правило генерации оповещений](media/configure-azure-monitor/alert-rule-02.png)<br>
3. Для первого шага в разделе **создать оповещение** разделе, вы будете выберите рабочую область Log Analytics в качестве ресурса, так как это сигнал оповещения на основе журнала.  Отфильтровать результаты по определенному **подписки** из раскрывающегося списка, при наличии более чем одной, которая содержит рабочую область Log Analytics, созданные ранее.  Фильтр **тип ресурса** , выбрав **Log Analytics** из раскрывающегося списка.  Наконец, выберите **ресурсов** **DefaultLAWorkspace** и нажмите кнопку **сделать**.<br><br> ![Создание задачи предупреждения шаг 1](media/configure-azure-monitor/alert-rule-03.png)<br>
4. В разделе **критерии предупреждения**, нажмите кнопку **добавить критерий** выберите сохраненный запрос, а затем задайте логику, которая следует за правило генерации оповещений.
5. Настройте предупреждение со следующими сведениями:  
   1. Из **на основе** стрелку раскрывающегося списка выберите **измерение метрик**.  Измерение метрик будет создать оповещение для каждого объекта в запросе со значением, превышающим заданного порогового значения.  
   2. Для **условие**выберите **больше** и укажите thershold.  
   В. Затем определите время активации оповещения. Например можно выбрать **последовательные бреши** и в раскрывающемся списке пункт **больше, чем** значение 3.  
   Г. В разделе оценки, в зависимости от раздела, изменить **период** значение **30** минут и **частота** до 5. Правило будет выполняться каждые пять минут и возвращает записи, которые были созданы в течение последних 30 минут от текущего времени.  Установка периода времени на окно шире учетные записи для потенциально задержки при передаче данных и гарантирует, что запрос возвращает данные, чтобы избежать ложный отрицательный результат, где никогда не срабатывает оповещение.  
6. Нажмите кнопку **сделать** для выполнения правила генерации оповещений.<br><br> ![Настройка сигнал оповещения](media/configure-azure-monitor/alert-signal-logic-02.png)<br> 
7. Теперь перенесена на втором шаге укажите имя оповещения в **имя правила генерации оповещений** поля, такие как **оповещения включены все события ошибок**.  Укажите **описание** подробные сведения о предупреждении и выберите **критическое (уровень серьезности 0)** для **серьезность** значение в параметрах.
8. Сразу же активировать правило оповещения при создании, примите значение по умолчанию для **включить правило при создании**.
9. На третьем и заключительном шаге укажите **группы действий**, которое гарантирует, что те же действия будут создаваться каждый раз, оповещение активируется и может использоваться для каждого правила, можно определить. Настройка новой группы действий со следующими сведениями:  
   1. Выберите **новая группа действий** и **добавить группу действий** откроется панель.  
   2. Для **имя группы действий**, укажите имя, такие как **уведомлять ИТ-операций —** и **короткое имя** например **itops-n**.  
   В. Проверьте значения по умолчанию для **подписки** и **группы ресурсов** указаны правильно. Если нет, выберите ее из раскрывающегося списка.   
   Г. В разделе «действия», укажите имя для действия, такие как **отправить электронное письмо** и в разделе **тип действия** выберите **электронной почты/SMS/Push/Voice** из раскрывающегося списка. **Электронной почты/SMS/Push/Voice** дополнительной информацией справа откроется панель свойств.  
   Д. На **электронной почты/SMS/Push/Voice** области, выберите и настройка предпочитаемого отображения. Например, включить **электронной почты** и укажите допустимый адрес электронной почты SMTP-адрес для доставки сообщения.  
   f. Нажмите кнопку **ОК**, чтобы сохранить изменения.<br><br> 

    ![Создание новой группы действий](media/configure-azure-monitor/action-group-properties-01.png)

10. Нажмите кнопку **ОК** для завершения группы действий. 
11. Нажмите кнопку **создать правило генерации оповещений** для выполнения правила генерации оповещений. Оно начнет выполняться немедленно.<br><br> ![Завершить создание нового правила генерации оповещений](media/configure-azure-monitor/alert-rule-01.png)<br> 

### <a name="test-alerts"></a>Тестовые оповещения

Для справки Вот как выглядит пример предупреждения:

![Пример оповещения по электронной почте](media/configure-azure-monitor/warning.png)

## <a name="see-also"></a>См. также

- [Общие сведения о дисковых хранилища](storage-spaces-direct-overview.md)
- Более подробные сведения о [документация по Azure Monitor](https://docs.microsoft.com/en-us/azure/azure-monitor/learn/tutorial-viewdata).
