---
title: Вложенная устойчивость для Локальные дисковые пространства
ms.prod: windows-server
ms.author: jgerend
manager: dansimp
ms.technology: storagespaces
ms.topic: article
author: cosmosdarwin
ms.date: 03/15/2019
ms.openlocfilehash: 6c3e16f0965be5fc7de4bdc7bd751fb1dd193556
ms.sourcegitcommit: d5e27c1f2f168a71ae272bebf8f50e1b3ccbcca3
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/23/2020
ms.locfileid: "86962206"
---
# <a name="nested-resiliency-for-storage-spaces-direct"></a>Вложенная устойчивость для Локальные дисковые пространства

> Область применения: Windows Server 2019

Вложенная устойчивость — это новая возможность [Локальные дисковые пространства](storage-spaces-direct-overview.md) в Windows Server 2019, которая позволяет кластеру с двумя серверами выдерживать несколько аппаратных сбоев одновременно без потери доступности хранилища, так что пользователи, приложения и виртуальные машины продолжают работать без перерывов. В этом разделе объясняется, как это работает, приводятся пошаговые инструкции по началу работы и ответы на наиболее часто задаваемые вопросы.

## <a name="prerequisites"></a>Обязательные условия

### <a name="green-checkmark-icon-consider-nested-resiliency-if"></a>![Зеленый значок галочки.](media/nested-resiliency/supported.png) Рассмотрите вложенную устойчивость, если:

- Ваш кластер работает под управлением Windows Server 2019; перетаскивани
- Кластер содержит ровно 2 узла сервера

### <a name="red-x-icon-you-cant-use-nested-resiliency-if"></a>![Красный значок X.](media/nested-resiliency/unsupported.png) Нельзя использовать вложенную устойчивость, если:

- Ваш кластер работает под управлением Windows Server 2016; ни
- Кластер содержит 3 или более узлов серверов

## <a name="why-nested-resiliency"></a>Почему вложенная устойчивость

Тома, использующие вложенную устойчивость, могут **оставаться в сети и быть доступными даже в случае возникновения нескольких аппаратных сбоев в то же время**, в отличие от классической [двусторонней зеркальной копии](storage-spaces-fault-tolerance.md) . Например, если два диска в одно и то же время выйдут из строя или если сервер выйдет из строя и произойдет сбой диска, тома, использующие вложенную устойчивость, остаются в сети и доступны. Для инфраструктуры с технологией Hyper-in это увеличивает время бесперебойной работы приложений и виртуальных машин. для рабочих нагрузок файловых серверов это означает, что пользователи получают доступ к файлам без перерывов.

![Доступность службы хранилища](media/nested-resiliency/storage-availability.png)

Компромисс заключается в том, что вложенная устойчивость имеет **меньшую эффективность, чем классическая двусторонняя зеркальная копия**, что означает, что вы получаете немного меньше свободного места. Дополнительные сведения см. в разделе [эффективность емкости](#capacity-efficiency) ниже.

## <a name="how-it-works"></a>Принципы работы

### <a name="inspiration-raid-51"></a>О-в. RAID 5 + 1

RAID 5 + 1 — это установленная форма устойчивости распределенного хранилища, которая предоставляет полезные сведения для понимания вложенной устойчивости. В RAID 5 + 1 на каждом сервере локальная устойчивость обеспечивается RAID-5 или *одним контролем четности*для защиты от потери одного диска. Затем обеспечивается дополнительная отказоустойчивость с помощью RAID-1 или *двустороннего зеркального отображения*между двумя серверами для защиты от потери любого сервера.

![RAID 5 + 1](media/nested-resiliency/raid-51.png)

### <a name="two-new-resiliency-options"></a>Два новых варианта устойчивости

Локальные дисковые пространства в Windows Server 2019 предлагает два новых варианта устойчивости, реализованные в программном обеспечении без необходимости специализированного оборудования RAID:

- **Вложенное двустороннее зеркало.** На каждом сервере локальная устойчивость обеспечивается двумя способами зеркального отображения, а затем обеспечивается последующее обеспечение устойчивости между двумя серверами. Это, по сути, четыре зеркала с двумя копиями на каждом сервере. Вложенное двустороннее зеркальное отображение обеспечивает несогласованную производительность: записи попадают во все копии, а операции чтения — из любой копии.

  ![Вложенное двустороннее зеркало](media/nested-resiliency/nested-two-way-mirror.png)

- **Вложенная контрольная четность с зеркальным отображением.** Объедините вложенное двустороннее зеркальное отображение выше с вложенной четностью. В пределах каждого сервера локальная устойчивость для большинства данных обеспечивается одной [побитовой арифметикой четности](storage-spaces-fault-tolerance.md#parity), за исключением новых операций записи, которые используют двустороннее зеркальное отображение. Затем обеспечивается последующее обеспечение устойчивости для всех данных, обеспечиваемое двусторонним зеркальным отображением между серверами. Дополнительные сведения о том, как работает контроль четности с зеркальным отображением, см. в разделе [контроль четности с зеркальным](../refs/mirror-accelerated-parity.md)ускорением.

  ![Вложенная четность с ускорением зеркального отображения](media/nested-resiliency/nested-mirror-accelerated-parity.png)

### <a name="capacity-efficiency"></a>Эффективность использования емкости

Эффективность емкости — это отношение использования пространства к объему места на [томе](plan-volumes.md#choosing-the-size-of-volumes). В нем описываются накладные расходы на емкость, которые можно присвоить устойчивости, и зависит от выбранного варианта устойчивости. Как простой пример, хранение данных без устойчивости составляет 100% эффективности (1 ТБ данных занимает 1 ТБ физической емкости), в то время как двухстороннее зеркальное отображение составляет 50% эффективности (1 ТБ данных занимает 2 ТБ физического объема хранилища).

- **Вложенное двустороннее зеркало** записывает четыре копии всего, что означает хранение 1 ТБ данных, вам потребуется 4 ТБ физического объема хранилища. Несмотря на то, что его простота является привлекательной, то вложенная производительность двусторонней зеркальной копии в 25% является самым низким из любого варианта устойчивости в Локальные дисковые пространства.

- **Вложенная контрольная четность с зеркальным отображением** достигает более высокой эффективности, чем 35%-40%. это зависит от двух факторов: количества дисков емкости на каждом сервере, а также от сочетания зеркала и четности, указанных для тома. В этой таблице содержится поиск типичных конфигураций:

  | Число дисков емкости на сервер | Зеркальное отображение на 10% | 20% зеркала | на 30% зеркала |
  |----------------------------|------------|------------|------------|
  | 4                          | 35,7%      | 34,1%      | 32,6%      |
  | 5                          | 37,7%      | 35,7%      | 33,9%      |
  | 6                          | 39,1%      | 36,8%      | 34,7%      |
  | 7 или выше                         | 40,0%      | 37,5%      | 35,3%      |

  > [!NOTE]
  > **Если интересно, Вот пример полной математики.** Предположим, что у нас есть шесть дисков емкости на каждом из двух серверов, и мы хотим создать том 1 100 ГБ, состоящий из 10 ГБ зеркала и 90 ГБ четности. Локальное зеркальное отображение на сервере составляет 50,0% эффективности, то есть 10 ГБ зеркальных данных на каждом сервере занимает 20 ГБ. При отображении на обоих серверах его общий объем составляет 40 ГБ. В данном случае серверная локальная проверка четности — 5/6 = 83,3% эффективно, что означает, что 90 ГБ данных четности занимает 108 ГБ для хранения на каждом сервере. При отображении на обоих серверах его общий объем составляет 216 ГБ. Общий объем занимаемой памяти составляет [(10 ГБ/50,0%) + (90 ГБ/83,3%)] × 2 = 256 ГБ, что позволяет повысить эффективность общей емкости на 39,1%.

Обратите внимание, что эффективность классической двусторонней зеркальной копии (около 50%) и вложенная четность с ускорением зеркального отображения (до 40%) не сильно отличаются. В зависимости от ваших требований, существенное повышение уровня доступности хранилища может быть очень эффективным. Вы выбираете устойчивость для каждого тома, поэтому вы можете смешивать вложенные тома устойчивости и классические двусторонние зеркальные тома в одном кластере.

![Выгод](media/nested-resiliency/tradeoff.png)

## <a name="usage-in-powershell"></a>Использование в PowerShell

Вы можете использовать привычные командлеты хранилища в PowerShell для создания томов с вложенной устойчивостью.

### <a name="step-1-create-storage-tier-templates"></a>Шаг 1. Создание шаблонов уровня хранилища

Сначала создайте новые шаблоны уровня хранилища с помощью `New-StorageTier` командлета. Это необходимо сделать только один раз, а затем каждый созданный том может ссылаться на этот шаблон. Укажите `-MediaType` диски емкости и, при необходимости, нужный `-FriendlyName` вариант. Не изменяйте другие параметры.

Если диски емкости являются жесткими дисками (HDD), запустите PowerShell от имени администратора и выполните команду:

```PowerShell
# For mirror
New-StorageTier -StoragePoolFriendlyName S2D* -FriendlyName NestedMirror -ResiliencySettingName Mirror -MediaType HDD -NumberOfDataCopies 4

# For parity
New-StorageTier -StoragePoolFriendlyName S2D* -FriendlyName NestedParity -ResiliencySettingName Parity -MediaType HDD -NumberOfDataCopies 2 -PhysicalDiskRedundancy 1 -NumberOfGroups 1 -FaultDomainAwareness StorageScaleUnit -ColumnIsolation PhysicalDisk
```

Если диски емкости являются твердотельными накопителями (SSD), задайте `-MediaType` `SSD` вместо него значение. Не изменяйте другие параметры.

> [!TIP]
> Проверьте, успешно ли созданы уровни `Get-StorageTier` .

### <a name="step-2-create-volumes"></a>Шаг 2. Создание томов

Затем создайте новые тома с помощью `New-Volume` командлета.

#### <a name="nested-two-way-mirror"></a>Вложенное двустороннее зеркало

Чтобы использовать вложенное двустороннее зеркало, сослаться на `NestedMirror` шаблон уровня и укажите размер. Например.

```PowerShell
New-Volume -StoragePoolFriendlyName S2D* -FriendlyName Volume01 -StorageTierFriendlyNames NestedMirror -StorageTierSizes 500GB
```

#### <a name="nested-mirror-accelerated-parity"></a>Вложенная четность с ускорением зеркального отображения

Чтобы использовать вложенную контрольную четность с зеркальным отображением, сослаться как на `NestedMirror` шаблоны уровня и, так `NestedParity` и на два размера, по одному для каждой части тома (сначала зеркало, а затем четность). Например, чтобы создать том 1 500 ГБ с 20% вложенной двусторонней зеркальной копии и 80% вложенной четности, выполните:

```PowerShell
New-Volume -StoragePoolFriendlyName S2D* -FriendlyName Volume02 -StorageTierFriendlyNames NestedMirror, NestedParity -StorageTierSizes 100GB, 400GB
```

### <a name="step-3-continue-in-windows-admin-center"></a>Шаг 3. продолжение в центре администрирования Windows

Тома, использующие вложенную устойчивость, отображаются в [центре администрирования Windows](../../manage/windows-admin-center/overview.md) с четкими метками, как показано на снимке экрана ниже. После создания вы сможете управлять ими и отслеживать их с помощью центра администрирования Windows, как и любой другой том в Локальные дисковые пространства.

![](media/nested-resiliency/windows-admin-center.png)

### <a name="optional-extend-to-cache-drives"></a>Необязательно: расширение на диски кэша

При использовании параметров по умолчанию вложенная устойчивость защищается одновременно с потерей нескольких дисков емкости, или один сервер и один диск емкости. Чтобы расширить эту защиту на [дисках кэша](understand-the-cache.md) , необходимо учитывать дополнительные факторы. Поскольку диски кэша часто обеспечивают Кэширование чтения *и записи* для *нескольких* дисков емкости, единственным способом убедиться в том, что вероятность потери диска кэша при отключении другого сервера, просто не является кэшированием операций записи, но это влияет на производительность.

Для решения этой ситуации Локальные дисковые пространства предлагает возможность автоматического отключения кэширования записи, когда один сервер в кластере из двух серверов не работает, а затем повторно включает кэширование записи после резервного копирования сервера. Чтобы разрешить перезагрузку без снижения производительности, кэширование записи не будет отключено, пока сервер не выйдет в течение 30 минут. После отключения кэширования записи содержимое кэша записи записывается на устройства емкости. После этого сервер может допустить неисправное устройство кэша на сервере в сети, хотя считывание из кэша может быть отложено или завершаться неудачей в случае сбоя устройства кэширования.

Чтобы задать это поведение (необязательно), запустите PowerShell от имени администратора и выполните следующую команду:

```PowerShell
Get-StorageSubSystem Cluster* | Set-StorageHealthSetting -Name "System.Storage.NestedResiliency.DisableWriteCacheOnNodeDown.Enabled" -Value "True"
```

После установки значения **true**поведение кэша будет следующим:

| Ситуация                       | Поведение кэша                           | Может ли допускаться потери диска кэша? |
|---------------------------------|------------------------------------------|--------------------------------|
| Оба сервера                 | Операции чтения и записи в кэше, полная производительность | Да                            |
| Сервер не работает, первые 30 минут   | Операции чтения и записи в кэше, полная производительность | Нет (временно)               |
| Через первые 30 минут          | Только чтение кэша, затронутая производительность   | Да (после того как кэш записан на диски емкости)                           |

## <a name="frequently-asked-questions"></a>Часто задаваемые вопросы

### <a name="can-i-convert-an-existing-volume-between-two-way-mirror-and-nested-resiliency"></a>Можно ли преобразовать существующий том между двусторонней зеркальной и вложенной устойчивостью?

Нет, тома не могут быть преобразованы между типами устойчивости. Для новых развертываний на Windows Server 2019 следует заранее принять решение о том, какой тип устойчивости наилучшим образом соответствует вашим потребностям. При обновлении Windows Server 2016 можно создать новые тома с вложенной устойчивостью, перенести данные, а затем удалить старые тома.

### <a name="can-i-use-nested-resiliency-with-multiple-types-of-capacity-drives"></a>Можно ли использовать вложенную устойчивость с несколькими типами дисков емкости?

Да, просто укажите `-MediaType` для каждого уровня соответствующий параметр на [шаге 1](#step-1-create-storage-tier-templates) выше. Например, с NVMe, SSD и HDD в одном и том же кластере NVMe предоставляет кэш, тогда как две последние обеспечивают емкость: задайте `NestedMirror` уровень `-MediaType SSD` и `NestedParity` уровень `-MediaType HDD` . Обратите внимание, что эффективность емкости четности зависит только от количества жестких дисков, и на каждом сервере требуется по крайней мере 4 из них.

### <a name="can-i-use-nested-resiliency-with-3-or-more-servers"></a>Можно ли использовать вложенную устойчивость с тремя или более серверами?

Нет, используйте только вложенную устойчивость, если в кластере ровно два сервера.

### <a name="how-many-drives-do-i-need-to-use-nested-resiliency"></a>Сколько дисков требуется для использования вложенной устойчивости?

Минимальное число дисков, необходимое для Локальные дисковые пространства, — 4 емкости на каждом узле сервера, а также 2 кэша дисков на каждом узле сервера (при наличии). Это не изменилось с Windows Server 2016. Для вложенной устойчивости нет дополнительных требований, и рекомендации по резервированию емкости не меняются.

### <a name="does-nested-resiliency-change-how-drive-replacement-works"></a>Изменяет ли вложенное устойчивость изменение того, как работает замена дисков?

Нет.

### <a name="does-nested-resiliency-change-how-server-node-replacement-works"></a>Изменилась ли вложенная устойчивость, как работает замена узлов серверов?

Нет. Чтобы заменить узел сервера и его диски, выполните следующий порядок:

1. Снятие дисков с учета на исходящем сервере
2. Добавление нового сервера с его дисками в кластер
3. Пул носителей будет перераспределяться
4. Удаление сервера исходящей почты и его дисков

Дополнительные сведения см. в разделе [Удаление серверов](remove-servers.md) .

## <a name="additional-references"></a>Дополнительные ссылки

- [Обзор Локальные дисковые пространства](storage-spaces-direct-overview.md)
- [Общие сведения о отказоустойчивости в Локальные дисковые пространства](storage-spaces-fault-tolerance.md)
- [Планирование томов в Локальные дисковые пространства](plan-volumes.md)
- [Создание томов в локальных дисковых пространствах](create-volumes.md)
