---
title: Перевод сервера локальных дисковых пространств в автономный режим для обслуживания
ms.prod: windows-server-threshold
ms.author: eldenc
ms.manager: eldenc
ms.technology: storage-spaces
ms.topic: article
author: eldenchristensen
ms.date: 10/08/2018
Keywords: Storage Spaces Direct, S2D, maintenance
ms.assetid: 73dd8f9c-dcdb-4b25-8540-1d8707e9a148
ms.localizationpriority: medium
ms.openlocfilehash: 96ae0ad0d1def12ab68466f0a9ae60d0afcc2c17
ms.sourcegitcommit: e73fbe1046a8bd2bf4f24ccffc11465ad8dfab1d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2019
ms.locfileid: "8992527"
---
# Перевод сервера локальных дисковых пространств в автономный режим для обслуживания

> Область применения: Windows Server 2016, Windows Server 2019 г.

В этом разделе приведены рекомендации для корректного перезапуска или завершения работы серверов с [локальными дисковыми пространствами](storage-spaces-direct-overview.md).

При использовании локальных дисковых пространств перевод сервера в автономный режим также означает отключение от сети частей хранилища, которые совместно используются на всех серверах в кластере. Для этого необходимо приостановить соответствующий сервер, перенести роли на другие серверы кластера и убедиться, что все данные доступны на других серверах в кластере, чтобы обеспечить их безопасность и доступность на период обслуживания.

Используйте следующие процедуры для корректной приостановки сервера в кластере локальных дисковых пространств перед его переводом в автономный режим. 

   > [!IMPORTANT]
   > Для установки обновлений в кластере локальных дисковых пространств используйте кластерное обновление (CAU), которое автоматически выполняет процедуры, описанные в этом разделе. Дополнительные сведения см. в статье [Кластерное обновление (CAU)](https://technet.microsoft.com/library/hh831694.aspx).

## Проверка безопасности перевода сервера в автономный режим

Перед переводом сервера в автономный режим для обслуживания убедитесь, что все тома работоспособны.

Для этого откройте сеанс PowerShell с разрешениями администратора и выполните следующую команду для просмотра состояния тома:

```PowerShell
Get-VirtualDisk 
```

Вот пример того, как могут выглядеть выходные данные команды:
```
FriendlyName ResiliencySettingName OperationalStatus HealthStatus IsManualAttach Size
------------ --------------------- ----------------- ------------ -------------- ----
MyVolume1    Mirror                OK                Healthy      True           1 TB
MyVolume2    Mirror                OK                Healthy      True           1 TB
MyVolume3    Mirror                OK                Healthy      True           1 TB
```

Убедитесь, что в свойстве **HealthStatus** каждого тома (виртуального диска) задано значение **Healthy**.

Для этого в диспетчере отказоустойчивости кластеров выберите **Хранилище** > **Диски**.

Убедитесь, что в столбце **Состояние** каждого тома (виртуального диска) указано значение **В сети**.

## Приостановка и очистка сервера

Перед перезапуском или завершением работы сервера приостановите и очистите (перенесите) все роли, например виртуальные машины, запущенные на нем. Это позволяет локальным дисковым пространствам корректно очистить и сохранить данные, чтобы обеспечить прозрачное завершение работы для всех приложений, работающих на этом сервере.

   > [!IMPORTANT]
   > Всегда приостанавливайте и очищайте серверы кластера до перезагрузки или завершения их работы.

В PowerShell выполните следующий командлет (от имени администратора) для приостановки и очистки сервера.

```PowerShell
Suspend-ClusterNode -Drain
```

Для этого в диспетчере отказоустойчивости кластера перейдите в раздел **Узлы**, щелкните узел правой кнопкой мыши и выберите **Приостановить** > **Очистить роли**.

![Pause-Drain](media/maintain-servers/pause-drain.png)

Все виртуальные машины начнут динамическую миграцию на другие серверы в кластере. Это может занять несколько минут.

   > [!NOTE]
   > При корректной приостановке и очистке узла кластера Windows выполняет автоматическую проверку безопасности продолжения процесса. Если существуют неработоспособные тома, процесс будет остановлен, а вы увидите предупреждение о том, что продолжать не безопасно.

![Safety-Check](media/maintain-servers/safety-check.png)

## Завершение работы сервера

После завершения очистки сервера в диспетчере отказоустойчивого кластера и PowerShell он будет показан с состоянием **Приостановлено**.

![Приостановлено](media/maintain-servers/paused.png)

Теперь вы можете безопасно перезапустить или завершить работу сервера обычным способом (например, с помощью командлетов PowerShell Stop-Computer или Restart-Computer).

```PowerShell
Get-VirtualDisk 

FriendlyName ResiliencySettingName OperationalStatus HealthStatus IsManualAttach Size
------------ --------------------- ----------------- ------------ -------------- ----
MyVolume1    Mirror                Incomplete        Warning      True           1 TB
MyVolume2    Mirror                Incomplete        Warning      True           1 TB
MyVolume3    Mirror                Incomplete        Warning      True           1 TB
```

Не завершена или при работе рабочее состояние при обычном узлов выполняется завершение работы или запуск и остановка кластера службы на узле и не должно вызывать проблем. Все другие тома остаются доступными и подключенными к сети.

## Возобновление работы сервера

Когда вы будете готовы к тому, чтобы начать использовать сервер для размещения рабочих нагрузок, возобновите его работу.

В PowerShell выполните следующий командлет (от имени администратора), чтобы возобновить работу сервера.

```PowerShell
Resume-ClusterNode
```

Чтобы вернуть ранее запущенные роли на сервер, используйте дополнительный флаг **-Failback**.

```PowerShell
Resume-ClusterNode –Failback Immediate
```

Для этого в диспетчере отказоустойчивости кластера перейдите в раздел **Узлы**, щелкните узел правой кнопкой мыши и выберите **Возобновить** > **Восстановить размещение ролей**.

![Resume-Failback](media/maintain-servers/resume-failback.png)

## Ожидание синхронизации хранилища

После возобновления работы сервера все новые операции записи, которые произошли во время оно было недоступно необходимо повторно синхронизировать. Это происходит автоматически. Благодаря интеллектуальному отслеживанию изменений не требуется сканировать или синхронизировать *все* данные, это необходимо сделать только для изменений. Этот процесс регулируется для снижения влияния на рабочие нагрузки. В зависимости от того, как долго сервер был приостановлен и сколько новых данных было записано, процесс может занять несколько минут.

Вам следует дождаться завершения повторной синхронизации перед переводом других серверов кластера в автономный режим.

В PowerShell выполните следующий командлет (от имени администратора) для отслеживания хода выполнения.

```PowerShell
Get-StorageJob
```
Вот пример выходных данных с отображением заданий синхронизации (восстановления):
```
Name   IsBackgroundTask ElapsedTime JobState  PercentComplete BytesProcessed BytesTotal
----   ---------------- ----------- --------  --------------- -------------- ----------
Repair True             00:06:23    Running   65              11477975040    17448304640
Repair True             00:06:40    Running   66              15987900416    23890755584
Repair True             00:06:52    Running   68              20104802841    22104819713
```

Значение **BytesTotal** показывает, сколько данных требуется синхронизировать повторно. **PercentComplete** — ход выполнения операции.

   > [!WARNING]
   > Небезопасно отключать другой сервер до завершения заданий восстановления.

В это время для томов будет отображаться состояние **Предупреждение** — это нормально. 

Например, если вы используете командлет `Get-VirtualDisk`, можно увидеть следующее:
```
FriendlyName ResiliencySettingName OperationalStatus HealthStatus IsManualAttach Size
------------ --------------------- ----------------- ------------ -------------- ----
MyVolume1    Mirror                InService         Warning      True           1 TB
MyVolume2    Mirror                InService         Warning      True           1 TB
MyVolume3    Mirror                InService         Warning      True           1 TB
```

После завершения заданий убедитесь, что для томов отображается состояние **Исправен**, используя командлет `Get-VirtualDisk`. Вот пример выходных данных:

```
FriendlyName ResiliencySettingName OperationalStatus HealthStatus IsManualAttach Size
------------ --------------------- ----------------- ------------ -------------- ----
MyVolume1    Mirror                OK                Healthy      True           1 TB
MyVolume2    Mirror                OK                Healthy      True           1 TB
MyVolume3    Mirror                OK                Healthy      True           1 TB
```

Теперь можно безопасно приостановить и перезапустить другие серверы в кластере.

## Обновление локальных дисковых пространств узлов в автономный режим
Выполните следующие действия для пути систему локальных дисковых пространств быстро. Он включает в себя планирование периода обслуживания и отключением системы для внесения исправлений. Если обновления безопасности, которое требуется применить быстро или может быть необходимо убедиться, что исправления завершается в окне обслуживания, этот метод может быть за вас. Этот процесс повысить эффективность работы кластера локальных дисковых пространств и исправления его соединяющий все до еще раз. Компромисс — это простой размещенного ресурсов.

1. Планирование окно вашего обслуживания.
2. Отключение виртуальных дисков.
3. Остановите кластера перевода пул носителей в автономный режим. Выполните командлет **Stop-Cluster** или используйте Диспетчер отказоустойчивости кластеров, чтобы кластера.
4. Значение службы кластеров **отключено** в Services.msc на каждом узле. Это предотвращает запуск во время вносятся исправления службой кластеров.
5. Применение накопительного обновления Windows Server и любые необходимые обновления стека обслуживания для всех узлов. (Вы можете обновить все узлы в то же время, не нужно ждать поскольку кластера не работает).  
6. Перезапустите узлы и убедитесь, что все выглядит хорошо.
7. Служба кластеров снова установите **Автоматическое** на каждом узле.
8. Запустите кластера. Выполните командлет **Кластером меню "Пуск"** или с помощью диспетчера отказоустойчивости кластеров. 

   Присвойте ему несколько минут.  Убедитесь, что пул носителей работает нормально.
9. Необходимо подключить виртуальные диски обратно.
10. Мониторинг статуса виртуальных жестких дисков, выполнив командлеты **Get-Volume** и **Get-VirtualDisk** .


## См. также

- [Обзор локальных дисковых пространств](storage-spaces-direct-overview.md)
- [Кластерное обновление (CAU)](https://technet.microsoft.com/library/hh831694.aspx)
