---
title: Использование Локальные дисковые пространства в виртуальной машине
description: Развертывание Локальные дисковые пространства в гостевом кластере виртуальной машины, например в Microsoft Azure.
ms.prod: windows-server
ms.author: eldenc
manager: eldenc
ms.technology: storage-spaces
ms.topic: article
author: eldenchristensen
ms.date: 07/15/2020
ms.localizationpriority: medium
ms.openlocfilehash: 581b80fe07043314e573261a6735f121bc30e2e3
ms.sourcegitcommit: a5badf6b08ec0b25ec73df4b827c4e40b5ccd974
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/16/2020
ms.locfileid: "86410368"
---
# <a name="using-storage-spaces-direct-in-guest-virtual-machine-clusters"></a>Использование Локальные дисковые пространства в кластерах гостевых виртуальных машин

> Применяется к: Windows Server 2019, Windows Server 2016

Локальные дисковые пространства (иногда называемые S2D) можно развернуть в кластере физических серверов или в гостевых кластерах виртуальных машин, как описано в этом разделе. Этот тип развертывания обеспечивает виртуальное общее хранилище на множестве виртуальных машин на основе частного или общедоступного облака, чтобы можно было использовать решения высокого уровня доступности приложения для повышения доступности приложений.

Чтобы вместо этого использовать общие диски Azure для гостевых виртуальных машин, см. статью [Общие диски Azure](/azure/virtual-machines/windows/disks-shared).

![](media/storage-spaces-direct-in-vm/storage-spaces-direct-in-vm.png)

## <a name="deploying-in-azure-iaas-vm-guest-clusters"></a>Развертывание в гостевых кластерах виртуальных машин IaaS Azure

Опубликованные [шаблоны Azure](https://github.com/robotechredmond/301-storage-spaces-direct-md) снижают сложность, настраивают рекомендации и ускоряют развертывание Локальные дисковые пространства на виртуальной машине Azure IaaS. Это рекомендуемое решение для развертывания в Azure.

<iframe src="https://channel9.msdn.com/Series/Microsoft-Hybrid-Cloud-Best-Practices-for-IT-Pros/Step-by-Step-Deploy-Windows-Server-2016-Storage-Spaces-Direct-S2D-Cluster-in-Microsoft-Azure/player" width="960" height="540" allowfullscreen></iframe>

## <a name="requirements-for-guest-clusters"></a>Требования к гостевым кластерам

При развертывании Локальные дисковые пространства в виртуализованной среде следует учитывать следующие моменты.

> [!TIP]
> Шаблоны Azure автоматически настраивают указанные ниже рекомендации и являются рекомендуемым решением при развертывании на виртуальных машинах Azure IaaS.

- Минимум 2 узла и максимум 3 узла

- развертывания с двумя узлами должны настроить следящий сервер (облако-свидетель или файловый ресурс-свидетель)

- Развертывание из трех узлов может допускать 1 узел и потерять 1 или более дисков на другом узле.  При завершении 2 узлов виртуальные диски находятся в автономном режиме до тех пор, пока один из узлов не вернет значение.

- Настройка виртуальных машин для развертывания в доменах сбоя

    - Azure — Настройка группы доступности

    - Hyper-V — Настройка AntiAffinityClassNames на виртуальных машинах для разделения виртуальных машин между узлами

    - VMware — настройте правило защиты виртуальных машин виртуальной машины, создав правило DRS типа "отдельные виртуальные машины" для разделения виртуальных машин между узлами ESX. Диски, представленные для использования с Локальные дисковые пространства, должны использовать адаптер Virtual SCSI (PVSCSI). Сведения о поддержке PVSCSI в Windows Server см https://kb.vmware.com/s/article/1010398 . в.

- Используйте хранилище с низкой задержкой или высокой производительностью. требуются управляемые диски Azure класса Premium.

- Развертывание плоской структуры хранилища без настроенных устройств кэширования

- Не менее 2 виртуальных дисков данных, представленных для каждой виртуальной машины (VHD/VHDX/VMDK)

    Это число отличается от развертывания на компьютере без операционной системы, так как виртуальные диски могут быть реализованы как файлы, не подверженные физическим сбоям.

- Отключите функции автоматического замены дисков в служба работоспособности, выполнив следующий командлет PowerShell:

    ```powershell
    Get-storagesubsystem clus* | set-storagehealthsetting -name "System.Storage.PhysicalDisk.AutoReplace.Enabled" -value "False"
    ```

- Чтобы обеспечить повышенную устойчивость к возможным задержкам хранилища VHD/VHDX/VMDK в гостевых кластерах, увеличьте значение времени ожидания ввода-вывода для дисковых пространств:

    `HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\spaceport\\Parameters\\HwTimeout`

    `dword: 00007530`

    Десятичный эквивалент шестнадцатеричного 7530 равен 30000, что составляет 30 секунд. Обратите внимание, что значение по умолчанию — 1770 шестнадцатеричное или 6000 десятичное, то есть 6 секунд.

## <a name="not-supported"></a>Не поддерживается

- Моментальный снимок или восстановление виртуального диска на уровне узла

    Вместо этого используйте традиционные решения резервного копирования на гостевом уровне для резервного копирования и восстановления данных на Локальные дисковые пространства томах.

- Изменение размера виртуального диска на уровне узла

    Виртуальные диски, предоставляемые через виртуальную машину, должны иметь одинаковый размер и характеристики. Добавление дополнительных ресурсов в пул носителей можно выполнить, добавив дополнительные виртуальные диски к каждой виртуальной машине и добавив их в пул. Настоятельно рекомендуется использовать виртуальные диски того же размера и характеристик, что и текущие виртуальные диски.

## <a name="additional-references"></a>Дополнительные ссылки

- [Дополнительные шаблоны виртуальных машин Azure IaaS для развертывания Локальные дисковые пространства, видеороликов и](https://techcommunity.microsoft.com/t5/Failover-Clustering/Deploying-IaaS-VM-Guest-Clusters-in-Microsoft-Azure/ba-p/372126)пошаговых руководств.

- [Обзор дополнительных Локальные дисковые пространства](https://docs.microsoft.com/windows-server/storage/storage-spaces/storage-spaces-direct-overview)
