---
title: Общие сведения о кэше локальных дисковых пространств
ms.assetid: 69b1adc0-ee64-4eed-9732-0fb216777992
ms.prod: windows-server
ms.author: cosdar
ms.manager: dongill
ms.technology: storage-spaces
ms.topic: article
author: cosmosdarwin
ms.date: 07/17/2019
ms.localizationpriority: medium
ms.openlocfilehash: f2c2e0435d06c18dbacab4e85db770ba86e654b3
ms.sourcegitcommit: 6aff3d88ff22ea141a6ea6572a5ad8dd6321f199
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/27/2019
ms.locfileid: "71366004"
---
# <a name="understanding-the-cache-in-storage-spaces-direct"></a>Общие сведения о кэше локальных дисковых пространств

>Относится к: Windows Server 2019, Windows Server 2016

[Локальные дисковые пространства](storage-spaces-direct-overview.md) имеют встроенный кэш на стороне сервера для повышения производительности хранилищ. Это большой, постоянно работающий в режиме реального времени кэш чтения *и* записи. При включении локальных дисковых пространств кэш настраивается автоматически. В большинстве случаев никакого ручного управления не требуется.
Способ работы кэша зависит от типов имеющихся накопителей.

Видео ниже рассказывает о принципах работы кэширования для локальных дисковых пространств, а также о других аспектах проектирования.

<strong>Рекомендации по проектированию Локальные дисковые пространства</strong><br>(20 минут)<br>
<iframe src="https://channel9.msdn.com/Blogs/windowsserver/Design-Considerations-for-Storage-Spaces-Direct/player" width="960" height="540" allowFullScreen frameBorder="0"></iframe>

## <a name="drive-types-and-deployment-options"></a>Типы накопителей и варианты развертывания

Локальные дисковые пространства в настоящее время поддерживают работу с тремя типами запоминающих устройств:

<table>
    <tr style="border: 0;">
        <td style="padding: 10px; border: 0; width:70px">
            <img src="media/understand-the-cache/NVMe-100px.png">
        </td>
        <td style="padding: 10px; border: 0;" valign="middle">
            Накопитель NVMe (Non-Volatile Memory Express)
        </td>
    </tr>
    <tr style="border: 0;">
        <td style="padding: 10px; border: 0; width:70px">
            <img src="media/understand-the-cache/SSD-100px.png">
        </td>
        <td style="padding: 10px; border: 0;" valign="middle">
            Твердотельный накопитель (SSD) SATA/SAS
        </td>
    </tr>
    <tr style="border: 0;">
        <td style="padding: 10px; border: 0; width:70px">
            <img src="media/understand-the-cache/HDD-100px.png">
        </td>
        <td style="padding: 10px; border: 0;" valign="middle">
            Жесткий диск (HDD)
        </td>
    </tr>
</table>

Их можно комбинировать шестью способами, которые мы сгруппировали в две категории — «только с флэш-накопителями» и «гибридные».

### <a name="all-flash-deployment-possibilities"></a>Варианты развертывания только с флэш-накопителями

Развертывания только с флэш-накопителями ориентированы на максимальную производительность устройств хранения и не используют вращающиеся жесткие диски.

![Варианты развертывания только с флэш-накопителями](media/understand-the-cache/All-Flash-Deployment-Possibilities.png)

### <a name="hybrid-deployment-possibilities"></a>Варианты гибридного развертывания

Гибридные развертывания ориентируются на баланс между производительностью и емкостью либо на максимальную емкость и используют вращающиеся жесткие диски.

![Варианты гибридного развертывания](media/understand-the-cache/Hybrid-Deployment-Possibilities.png)

## <a name="cache-drives-are-selected-automatically"></a>Кэш-накопители выбираются автоматически

При развертывании с несколькими типами накопителей локальные дисковые пространства автоматически используют для кэша все самые быстрые накопители. Остальные накопители используются для емкости.

Скорость работы накопителя определяется согласно следующей иерархии.

![Drive-Type-Hierarchy](media/understand-the-cache/Drive-Type-Hierarchy.png)

Например, если у вас есть накопители NVMe и SSD, NVMe будут использоваться в качестве кэша для SSD.

Если у вас есть твердотельные накопители (SSD) и жесткие диски, SSD будут использоваться в качестве кэша для жестких дисков.

   >[!NOTE]
   > Кэш-накопители не добавляют полезной емкости хранения. Все данные, хранящиеся в кэше, хранятся и в других местах или будут храниться там после их переноса из кэша на устройство. Это означает, что общая номинальная емкость хранения в развернутой системе является суммой емкостей накопителей-хранилищ.

Если все накопители принадлежат к одному типу, кэш не настраивается автоматически. Вы можете вручную задать более износостойкие накопители в качестве кэша для менее износостойких накопителей того же типа. Соответствующие инструкции см. в разделе [Ручная настройка](#manual-configuration).

   >[!TIP]
   > При развертывании систем только с накопителями NVMe или SSD (особенно небольших масштабов) отсутствие кэш-накопителей может значительно повысить эффективность хранения.

## <a name="cache-behavior-is-set-automatically"></a>Режим работы кэша задается автоматически

Режим работы кэша определяется автоматически, исходя из типов кэшируемых накопителей. При кэшировании твердотельных накопителей (например, когда твердотельные накопители (SSD) кэшируются накопителями NVMe) кэшируются только операции записи. При кэшировании жестких дисков (например, когда жесткие диски кэшируются накопителями SSD) кэшируются операции и чтения, и записи.

![Cache-Read-Write-Behavior](media/understand-the-cache/Cache-Read-Write-Behavior.png)

### <a name="write-only-caching-for-all-flash-deployments"></a>Кэширование только операций записи для развертываний только с флэш-накопителями

При кэшировании твердотельных накопителей (NVMe или SSDs) кэшируются только операции записи. Это снижает износ накопителей-хранилищ, так как многие операции записи и перезаписи могут быть объединены в кэше и затем перенесены на устройство только при необходимости, что сокращает общий поток данных на накопители-хранилища и увеличивает срок их службы. Поэтому для кэша рекомендуется выбирать [более износостойкие и оптимизированные для записи](http://whatis.techtarget.com/definition/DWPD-device-drive-writes-per-day) накопители. Накопители-хранилища в целом могут иметь менее высокий ресурс записи.

Поскольку операции чтения не влияют существенно на продолжительность срока службы флэш-накопителей и поскольку твердотельные накопители обычно имеют низкую задержку чтения, то операции чтения не кэшируются — чтение выполняется непосредственно с накопителей-хранилищ (за исключением ситуаций, когда данные были записаны совсем недавно и еще не перенесены из кэша на устройство). Это позволяет ориентировать работу кэша исключительно на операции записи, повышая их эффективность.

Это приводит к тому, что характеристики записи (например, задержка записи) определяются кэш-накопителями, а характеристики чтения — накопителями-хранилищами. И те, и другие согласованы, предсказуемы и унифицированы.

### <a name="readwrite-caching-for-hybrid-deployments"></a>Кэширование операций чтения и записи для гибридных развертываний

При кэшировании жестких дисков (HDD) кэшируются операции чтения *и* записи с тем, чтобы обеспечить для них показатели задержки, как при использовании флэш-накопителей (зачастую улучшив примерно в 10 раз). Кэш чтения хранит недавно считанные и часто считываемые данные для организации быстрого доступа к ним и сведения к минимуму объема произвольных обращений к жестким дискам. (Из-за задержки поиска и ротации время задержки и потери при случайном доступе к жесткому диску очень важны.) Операции записи кэшируются для снижения нагрузки и, как и раньше, для объединения записей и повторной записи, а также для снижения объема общего трафика к дискам емкости.

В локальных дисковых пространствах реализован алгоритм, который устраняет произвольный порядок операций записи перед их переносом из кэша на устройство и эмулирует шаблон ввода-вывода, который выглядит последовательным, даже если реальные операции ввода-вывода, инициируемые рабочей нагрузкой (например, виртуальными машинами), имеют произвольный порядок. Это позволяет увеличить количество операций ввода-вывода в секунду и пропускную способность для жестких дисков.

### <a name="caching-in-deployments-with-drives-of-all-three-types"></a>Кэширование в развертываниях с накопителями всех трех типов

При наличии накопителей всех трех типов накопители NVMe обеспечивают кэширование для твердотельных накопителей (SSD) и жестких дисков. Режим работы соответствует описанному ранее: для накопителей SSD кэшируются только операции записи, для жестких дисков — операции чтения и записи. Работа по кэшированию жестких дисков равномерно распределяется среди кэш-накопителей. 

## <a name="summary"></a>Сводка

В этой таблице приведена сводная информация о том, какие накопители используются для кэширования, какие — для хранения данных и как осуществляется кэширование в каждом варианте развертывания.

| Развертывание     | Кэш-накопители                        | Накопители-хранилища | Режим кэширования (по умолчанию)  |
| -------------- | ----------------------------------- | --------------- | ------------------------- |
| Только NVMe         | Нет (как вариант — настройка вручную) | NVMe            | Только запись (если настроено)  |
| Только SSD          | Нет (как вариант — настройка вручную) | SSD             | Только запись (если настроено)  |
| NVMe + SSD       | NVMe                                | SSD             | Только запись                  |
| NVMe + жесткий диск       | NVMe                                | Жесткий диск             | Чтение + запись                |
| SSD + жесткий диск        | SSD                                 | Жесткий диск             | Чтение + запись                |
| NVMe + SSD + жесткий диск | NVMe                                | SSD + жесткий диск       | Для жесткого диска — чтение + запись, для SSD — только запись  |

## <a name="server-side-architecture"></a>Серверная архитектура

Кэш реализуется на уровне накопителя: отдельные кэш-накопители на одном сервере привязаны к одному или нескольким накопителям-хранилищам на том же сервере.

Поскольку кэш находится ниже остального стека программно-определяемого хранилища Windows, он не использует такие концепции, как дисковые пространства или отказоустойчивость, и не нуждается в них. Можно считать это созданием «гибридных» накопителей (частично флэш-накопителей, частично дисковых), которые затем предоставляются операционной системе Windows. Как и в случае с реальным гибридным накопителем, перемещение в режиме реального времени «горячих» и «холодных» данных между более быстрыми и более медленными зонами физического носителя почти незаметно извне.

С учетом того, что устойчивость в локальных дисковых пространствах реализуется как минимум на уровне сервера (то есть, копии данных всегда записываются на разные сервера; не более одной копии на сервер), на данные в кэше распространяются те же преимущества устойчивости, что и на данные не в кэше.

![Cache-Server-Side-Architecture](media/understand-the-cache/Cache-Server-Side-Architecture.png)

Например, при использовании трехстороннего зеркалирования три копии любых данных записываются на разные серверы и оказываются там в кэше. Вне зависимости от того, будут ли они позднее перенесены из кэша на устройство или нет, три эти копии всегда существуют.

## <a name="drive-bindings-are-dynamic"></a>Привязки к накопителям являются динамическими

Привязка кэш-накопителей к накопителям-хранилищам может иметь любой коэффициент — от 1:1 до 1:12 и так далее. Он настраивается динамически всякий раз, когда добавляются или удаляются накопители, например при увеличении масштаба системы или после сбоев. Это означает, что вы можете добавлять кэш-накопители или накопители-хранилища независимо друг от друга, когда это необходимо.

![Dynamic-Binding](media/understand-the-cache/Dynamic-Binding.gif)

Рекомендуется делать число накопителей-хранилищ кратным числу кэш-накопителей для соблюдения симметрии. Например, если у вас четыре кэш-накопителя, то при наличии восьми накопителей-хранилищ (соотношение 1:2) производительность будет более постоянной, чем при наличии семи или девяти накопителей-хранилищ.

## <a name="handling-cache-drive-failures"></a>Обработка сбоев кэш-накопителей

При сбое в работе кэш-накопителя все операции записи, которые еще не были перенесены из кэша на устройство, теряются *на локальном сервере*, то есть существуют только в других копиях (на других серверах). Так же, как и при сбоях других накопителей, дисковые пространства могут выполнять автоматическое восстановление и делают это, обращаясь к сохранившимся копиям.

В течение небольшого периода времени накопители-хранилища, которые были привязаны к отказавшему кэш-накопителю, будут отображаться как неисправные. После повторной привязки кэша (выполняется автоматически) и завершения восстановления данных (выполняется автоматически) они снова будут отображаться как исправные.

Этот сценарий показывает, почему для поддержания работоспособности сервера требуется не менее двух кэш-накопителей на сервер.

![Handling-Failure](media/understand-the-cache/Handling-Failure.gif)

Затем можно заменить кэш-накопитель, следуя стандартной процедуре замены любых накопителей.

   >[!NOTE]
   > Может потребоваться отключение питания для безопасной замены накопителя NVMe в виде дополнительной карты (AIC) или в форм-факторе M.2.

## <a name="relationship-to-other-caches"></a>Связь с другими кэшами

Существует несколько других несвязанных друг с другом кэшей в стеке программно-определяемого хранилища Windows. Примерами могут служить кэш обратной записи дисковых пространств и кэш чтения в памяти общего тома кластера (CSV).

При использовании локальных дисковых пространств не следует изменять стандартный режим работы кэша обратной записи дисковых пространств. Например, не следует использовать такой параметр, как **-WriteCacheSize** в командлете **New-Volume**.

Решайте сами, использовать кэш CSV или нет. По умолчанию он отключен в локальных дисковых пространствах, но никак не конфликтует с новым кэшем, описанным в этом разделе. В некоторых рабочих сценариях он может повысить производительность. Подробнее см. в разделе [Включение кэша CSV](../../failover-clustering/failover-cluster-csvs.md#enable-the-csv-cache-for-read-intensive-workloads-optional).

## <a name="manual-configuration"></a>Ручная настройка

В большинстве случаев ручная настройка не требуется. Если это необходимо, см. следующие разделы. 

Если после установки необходимо внести изменения в модель устройства кэширования, измените документ по компонентам поддержки служба работоспособности, как описано в разделе [Общие сведения о служба работоспособности](../../failover-clustering/health-service-overview.md#supported-components-document).

### <a name="specify-cache-drive-model"></a>Указание модели кэш-накопителя

В развертываниях, где все накопители одного типа (например, только NVMe или SSD), кэш не настроен, поскольку Windows не может автоматически определить у накопителей одного типа такие характеристики, как ресурс записи.

Чтобы использовать более износостойкие накопители в качестве кэша для менее износостойких накопителей того же типа, используйте для указания нужной модели накопителя параметр **-CacheDeviceModel** командлета **Enable-ClusterS2D**. После включения локальных дисковых пространств все накопители указанной модели будут использоваться для кэширования.

   >[!TIP]
   > Убедитесь, что строка модели указана в точности так, как она отображается в выходных данных командлета **Get-PhysicalDisk**.

####  <a name="example"></a>Пример

Сначала получите список физических дисков:

```PowerShell
Get-PhysicalDisk | Group Model -NoElement
```

Вот пример выходных данных:

```
Count Name
----- ----
    8 FABRIKAM NVME-1710
   16 CONTOSO NVME-1520
```

Затем введите следующую команду, указав модель устройства кэша:

```PowerShell
Enable-ClusterS2D -CacheDeviceModel "FABRIKAM NVME-1710"
```

Вы можете проверить, что назначенные накопители используются для кэширования, запустив командлет **Get-PhysicalDisk** в PowerShell и проверив свойство **Usage** — оно должно иметь значение **«Journal»** .

### <a name="manual-deployment-possibilities"></a>Варианты развертывания вручную

Ручная настройка поддерживает следующие варианты развертывания:

![Exotic-Deployment-Possibilities](media/understand-the-cache/Exotic-Deployment-Possibilities.png)

### <a name="set-cache-behavior"></a>Установка режима работы кэша

Можно переопределить режим работы кэша по умолчанию. Например, можно включить кэширование операций чтения даже для развертываний только с использованием флэш-накопителей. Не рекомендуется менять режим работы, если вы не уверены, что режим работы по умолчанию не подходит для ваших рабочих нагрузок.

Чтобы переопределить поведение, используйте командлет **Set-клустерсторажеспацесдирект** и параметры **-качемодессд** и **-качемодехдд** . Параметр **CacheModeSSD** задает режим работы кэша при кэшировании твердотельных накопителей. Параметр **CacheModeHDD** задает режим работы кэша при кэшировании жестких дисков. Это можно сделать в любой момент после включения локальных дисковых пространств.

Чтобы проверить, задано ли поведение, можно использовать **Get-клустерсторажеспацесдирект** .

#### <a name="example"></a>Пример

Сначала получите параметры Локальные дисковые пространства:

```PowerShell
Get-ClusterStorageSpacesDirect
```

Вот пример выходных данных:

```
CacheModeHDD : ReadWrite
CacheModeSSD : WriteOnly
```

Затем выполните следующие действия.

```PowerShell
Set-ClusterStorageSpacesDirect -CacheModeSSD ReadWrite

Get-ClusterS2D
```

Вот пример выходных данных:

```
CacheModeHDD : ReadWrite
CacheModeSSD : ReadWrite
```

## <a name="sizing-the-cache"></a>Изменение размера кэша

Размер кэша должен выбираться таким, чтобы в нем мог разместиться рабочий набор (активно читаемые и записываемые данные в любой момент времени) ваших приложений и рабочих нагрузок.

Это особенно важно в гибридных развертываниях с использованием жестких дисков. Если размер активного рабочего набора превышает размер кэша либо размер активного рабочего набора меняется слишком быстро, будет возрастать число промахов в кэше чтения и операции записи должны будут чаще переноситься из кэша на устройство, что будет негативно сказываться на общей производительности.

Для проверки показателя промахов в кэше можно использовать встроенную служебную программу Windows «Системный монитор» (PerfMon.exe). В частности, можно сравнить значение **Cache Miss Reads/sec** (Промахов в кэше чтения в секунду) из группы счетчиков **Cluster Storage Hybrid Disk** (Гибридный диск системы хранения данных кластера) с общим числом операций чтения в вашем развертывании. Каждый «гибридный диск» соответствует одному накопителю-хранилищу.

Например, два кэш-накопителя, привязанные к четырем накопителям-хранилищам, дадут четыре экземпляра объекта «гибридный диск» на сервер.

![Performance-Monitor](media/understand-the-cache/PerfMon.png)

Универсальных правил нет, но если слишком много операций чтения не попадают в кэш, его размер может быть недостаточным. В этом случае рекомендуется добавить дополнительные кэш-накопители для увеличения размера кэша. Добавлять кэш-накопители и накопители-хранилища можно независимо друг от друга, когда это необходимо.

## <a name="see-also"></a>См. также

- [Выбор дисков и типов устойчивости](choosing-drives.md)
- [Отказоустойчивость и эффективность хранения](storage-spaces-fault-tolerance.md)
- [Требования к оборудованию Локальные дисковые пространства](storage-spaces-direct-hardware-requirements.md)
