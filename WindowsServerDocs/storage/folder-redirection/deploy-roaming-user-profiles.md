---
title: Развертывание перемещаемых профилей пользователей
TOCTitle: Deploying Roaming User Profiles
ms.prod: windows-server
ms.technology: storage
ms.topic: article
author: JasonGerend
manager: brianlic
ms.date: 06/07/2019
ms.author: jgerend
ms.openlocfilehash: 8feed2adb606edfb6068d7fe10c18baf142077ac
ms.sourcegitcommit: 07c9d4ea72528401314e2789e3bc2e688fc96001
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/29/2020
ms.locfileid: "76822347"
---
# <a name="deploying-roaming-user-profiles"></a>Развертывание перемещаемых профилей пользователей

>Применяется к: Windows 10, Windows 8.1, Windows 8, Windows 7, Windows Server 2019, Windows Server 2016, Windows Server (Semi-Annual Channel), Windows Server 2012 R2, Windows Server 2012, Windows Server 2008 R2

В этом разделе описано развертывание [перемещаемых профилей пользователей](folder-redirection-rup-overview.md) на клиентских компьютерах под управлением Windows Server. Технология перемещаемых профилей пользователей позволяет перенаправлять профили пользователей в общую папку, чтобы обеспечить получение одинаковых параметров операционной системы и приложения на разных компьютерах.

Список последних изменений этой статьи см. в ее разделе [Журнал изменений](#change-history).

> [!IMPORTANT]
> Из-за изменений в системе безопасности, внесенных в [MS16-072](https://support.microsoft.com/help/3163622/ms16-072-security-update-for-group-policy-june-14%2c-2016), мы обновили [Шаг 4. Создание GPO для перемещаемых профилей пользователей (при необходимости)](#step-4-optionally-create-a-gpo-for-roaming-user-profiles) в этой статье, чтобы Windows могла правильно применить политику перемещаемых профилей пользователей (а не возвращаться к использованию локальных политик на затронутых компьютерах).

> [!IMPORTANT]
>  Пользовательские настройки начального экрана не сохраняются после обновления операционной системы на месте в следующей конфигурации:
> - для пользователей настроены перемещаемые профили;
> - пользователям разрешено вносить изменения в начальный экран.
>
> В таких случаях начальный экран при обновлении операционной системы на месте сбрасывается до состояния по умолчанию для новой установки. Возможные обходные варианты можно изучить в [приложении C об обходных решениях для сброса макета начального экрана после обновления](#appendix-c-working-around-reset-start-menu-layouts-after-upgrades).

## <a name="prerequisites"></a>Предварительные условия

### <a name="hardware-requirements"></a>Требования к оборудованию

Для использования перемещаемых профилей пользователей требуется компьютер с процессором на базе архитектуры x64 или x86. Windows RT не поддерживает эту функцию.

### <a name="software-requirements"></a>Требования к программному обеспечению

Для использования перемещаемых профилей пользователей действуют следующие программные требования.

- Если вы выполняете развертывание перемещаемые профили пользователей с перенаправлением папок в среде с существующими локальными профилями пользователей, сначала настройте перенаправление папок, а затем — перемещаемые профили пользователей, чтобы минимизировать размер перемещаемых профилей. После успешного перенаправления существующих пользовательских папок вы можете развернуть перемещаемые профили пользователей.
- Для администрирования перемещаемых профилей пользователей вам потребуется войти в систему в качестве члена группы безопасности "Администраторы домена", "Администраторы предприятия" или "Владельцы-создатели групповой политики".
- На клиентских компьютерах должна работать ОС Windows 10, Windows 8.1, Windows 8, Windows 7, Windows Vista, Windows Server 2012 R2, Windows Server 2012, Windows Server 2008 R2 или Windows Server 2008.
- Компьютеры клиентов должны быть присоединены к доменным службам Active Directory (AD DS), которыми вы управляете.
- На компьютере должны быть установлены компоненты "Управление групповой политикой" и "Центр администрирования Active Directory".
- Файловый сервер должен поддерживать перемещаемые профили пользователей.

    - Если общая папка использует пространства имен DFS, у папок DFS (ссылок) должен быть один целевой объект, чтобы избежать конфликтов серверов при изменении настроек пользователем.
    - Если общая папка использует репликацию DFS для копирования данных на другой сервер, пользователи должны иметь доступ лишь к исходному серверу, чтобы избежать конфликтов при изменении параметров серверов.
    - Если общая папка кластеризована, отключите непрерывную доступность в общей папке, чтобы избежать проблем с производительностью.
- Для использования поддержки основных компьютеров с перемещаемыми профилями пользователей нужно выполнить дополнительные требования к клиентским компьютерам и схеме Active Directory. Дополнительные сведения см. в статье о [развертывании основных компьютеров для перенаправления папок и перемещаемых профилей пользователей](deploy-primary-computers.md).
- Макет начального экрана не будет перемещаться в Windows 10, Windows Server 2019 или Windows Server 2016, если пользователь использует несколько компьютеров, узел сеансов удаленных рабочих столов или сервер инфраструктуры виртуализованных рабочих столов (VDI). В качестве обходного решения можно указать макет начального экрана, как описано в этом разделе. Также вы можете использовать диски профилей пользователей, которые правильно перемещают параметры начального экрана при работе с серверами узла сеансов удаленных рабочих столов или серверами VDI. Дополнительные сведения см. в статье об [упрощении управления данными пользователей благодаря дискам профилей пользователей в Windows Server 2012](https://blogs.technet.microsoft.com/enterprisemobility/2012/11/13/easier-user-data-management-with-user-profile-disks-in-windows-server-2012/).

### <a name="considerations-when-using-roaming-user-profiles-on-multiple-versions-of-windows"></a>Рекомендации по использованию перемещаемых профилей пользователей в нескольких версиях Windows

Если вы собираетесь использовать перемещаемые профили пользователей в нескольких версиях Windows, рекомендуется выполнить следующие действия.

- Настройте каждую версию Windows для хранения отдельных версий профилей. Это позволит избежать нежелательных и неожиданных проблем, таких как повреждение профилей.
- Используйте перенаправление папок, чтобы хранить пользовательские файлы, такие как документы и изображения, вне профилей пользователей. Это сделает файлы доступными для пользователей всех версий ОС, а также позволит уменьшить размер профилей и ускорить вход.
- Выделите достаточно дискового пространства для перемещаемых профилей пользователей. Если вы работаете с двумя версиями ОС, количество профилей (а также занимаемое ими место) удвоится, поскольку отдельные профили хранятся в разных версиях системы.
- Не используйте перемещаемые профили пользователей на компьютерах под управлением Windows Vista или Windows Server 2008 и Windows 7 или Windows Server 2008 R2. Перемещение между этими версиями ОС не поддерживается из-за несовместимости версий профилей.
- Оповестите пользователей, что изменения, сделанные в одной ОС, не будут распространяться на другую версию ОС.
- При перемещении среды в версию Windows, которая использует другую версию профиля (например, из Windows 10 в Windows 10 версии 1607, полный список версий профиля см. в [приложении B со справочной информацией о версиях профилей](#appendix-b-profile-version-reference-information)), пользователи получают новый пустой перемещаемый профиль пользователя. Вы можете уменьшить трудности, связанные с получением нового профиля, настроив перенаправление для самых важных папок. Не существует поддерживаемых методов для переноса перемещаемых профилей пользователей из одной операционной системы в другую.

## <a name="step-1-enable-the-use-of-separate-profile-versions"></a>Шаг 1. Включение отдельных профилей

Если вы развертываете перемещаемые профили пользователей на компьютерах под управлением Windows 8.1, Windows 8, Windows Server 2012 R2 или Windows Server 2012, мы рекомендуем внести ряд изменений в среду Windows перед началом процесса. Эти изменения обеспечат безотказное обновление ОС в будущем, а также облегчат одновременное использование нескольких версий Windows с перемещаемыми профилями пользователей.

Чтобы внести эти изменения, выполните нижеописанные действия.

1. Скачайте и установите необходимые программные обновления на всех компьютерах, на которых планируете использовать перемещаемые, обязательные или сверхобязательные профили, а также профили домена по умолчанию.

    - Windows 8.1 или Windows Server 2012: установите обновление ПО, описанное в статье [2887595](https://support.microsoft.com/kb/2887595) базы знаний Майкрософт (по мере выпуска).
    - Windows 8 или Windows Server 2012: установите обновление, описанное в статье [2887239](https://support.microsoft.com/kb/2887239) базы знаний Майкрософт.

2. На компьютерах под управлением Windows 8.1, Windows 8, Windows Server 2012 R2 или Windows Server 2012, на которых вы планируете использовать перемещаемые профили пользователей, с помощью редактора реестра или групповой политики создайте в реестре параметр DWORD и присвойте ему значение `1`. Подробную информацию о создании разделов реестра с помощью групповой политики см. в статье [Настройка элемента реестра](<https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/cc753092(v=ws.11)>).

    ```
    HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\ProfSvc\Parameters\UseProfilePathExtensionVersion
    ```

    > [!WARNING]
    > Неправильное изменение реестра может серьезно повредить систему. Перед внесением изменений следует сделать резервную копию всех ценных данных на компьютере.
3. Перезагрузите компьютеры.

## <a name="step-2-create-a-roaming-user-profiles-security-group"></a>Шаг 2. Создание группы безопасности перемещаемых профилей пользователей

Если в вашей среде еще не настроены перемещаемые профили пользователей, в первую очередь необходимо создать группу безопасности, включающую всех пользователей и/или все компьютеры, для которых вы хотите применить настройки политики перемещаемых профилей пользователей.

- Администраторы развертываний перемещаемых профилей пользователей общего назначения обычно создают группу безопасности для пользователей.
- Администраторы служб удаленных рабочих столов или развертываний виртуальных рабочих столов обычно используют группу безопасности для пользователей и общих компьютеров.

Ниже описано создание группы безопасности для перемещаемых профилей пользователей.

1. Откройте диспетчер сервера на компьютере с установленным Центром администрирования Active Directory.
2. В меню **Инструменты** щелкните **Active Directory Administration Center** (Центр администрирования Active Directory). Отобразится центр администрирования Active Directory.
3. Щелкните правой кнопкой мыши необходимый домен или подразделение и последовательно выберите элементы **Создать**, **Группа**.
4. В окне **Создание группы** в разделе **Группа** укажите следующие параметры.

    - В поле **Имя группы** введите имя группы безопасности, например **Пользователи перемещаемых профилей и компьютеры**.
    - В разделе **Область действия группы** щелкните элемент **Безопасность**, а затем элемент **Глобальная**.

5. В разделе **Участники** щелкните элемент **Добавить**. Откроется диалоговое окно "Выбор пользователей, контактов, компьютеров, учетных записей служб или групп".
6. Если вы хотите включить в группу безопасности учетные записи компьютеров, щелкните элемент **Типы объектов**, установите флажок рядом с пунктом **Компьютеры**, после чего нажмите кнопку **OK**.
7. Укажите имена пользователей, групп и (или) компьютеров, для которых хотите выполнить развертывание перемещаемых профилей пользователей. Затем нажмите кнопку **OK** и еще раз нажмите кнопку **OK**.

## <a name="step-3-create-a-file-share-for-roaming-user-profiles"></a>Шаг 3. Создание файлового ресурса для перемещаемых профилей пользователей

Если у вас еще нет отдельной общей папки для перемещаемых профилей пользователей (созданной независимо от любых общих папок для перенаправляемых папок, чтобы предотвратить нежелательное кэширование папки перемещаемого профиля), выполните описанные ниже действия, чтобы создать общую папку на сервере под управлением Windows Server.

> [!NOTE]
> Некоторые функции могут отличаться или быть недоступны в зависимости от используемой версии Windows Server.

Ниже описано создание общей папки в Windows Server.

1. В области навигации диспетчера серверов щелкните элемент **Файловые службы и службы хранилища**, а затем элемент **Общие папки**, чтобы перейти на страницу общих папок.
2. На плитке "Общие папки" щелкните элемент **Задачи**, а затем — **Новая общая папка**. Откроется мастер создания общих ресурсов.
3. На странице **Выберите профиль** щелкните **SMB Share – Quick** (Общая папка SMB — быстрый профиль). Если у вас установлен диспетчер ресурсов файлового сервера и вы используете свойства управления папками, вместо этого выберите пункт **Общая папка SMB — дополнительные**.
4. На странице **Расположение общего ресурса** выберите сервер и том, в котором хотите создать общий ресурс.
5. На странице **Имя общего ресурса** укажите имя (например, **User Profiles$** ) в поле **Имя общего ресурса** .

    > [!TIP]
    > При создании общей папки необходимо скрыть ее, добавив после имени символ ```$```. Это предотвратит доступ к нему случайных веб-обозревателей.

6. На странице **Другие параметры** снимите флажок **Включить постоянную доступность на этом клиенте** , если он показан, и при необходимости установите флажки **Включить перечисление на основе доступа** и **Шифровать доступ к данным** .
7. На странице **Разрешения** щелкните элемент **Настройка разрешений доступа…** . Отобразится диалоговое окно с расширенными параметрами безопасности.
8. Нажмите кнопку **Отключение наследования**, а затем щелкните элемент **Convert inherited permissions into explicit permission on this object** (Преобразовать наследуемые разрешения для объекта в явные).
9. Установите разрешения, как описано в таблице [Требуемые разрешения для общей папки, где размещаются перемещаемые профили пользователей](#required-permissions-for-the-file-share-hosting-roaming-user-profiles) и показано на рисунке ниже, удалите разрешения для всех остальных групп и учетных записей, а также добавьте особые разрешения для группы пользователей перемещаемых профилей и компьютеров, которую вы создали на шаге 1.
    
    ![Окно "Дополнительные параметры безопасности" с настроенными разрешениями согласно таблице 1](media/advanced-security-user-profiles.jpg)
    
    **Рисунок 1** . Установка разрешений для общего ресурса перемещаемых профилей пользователей
10. Если вы выбрали профиль **Общий ресурс SMB — дополнительные** , на странице **Свойства управления** установите для параметра "Использование папки" значение **Файлы пользователя** .
11. Если вы выбрали профиль **Общий ресурс SMB — дополнительные** , на странице **Квота** вы можете при необходимости выбрать квоту, которая будет распространяться на пользователей общего ресурса.
12. На странице **Подтверждение** щелкните элемент **Создать**.

### <a name="required-permissions-for-the-file-share-hosting-roaming-user-profiles"></a>Требуемые разрешения для общей папки, где размещаются перемещаемые профили пользователей

| Учетная запись пользователя | Доступ | Область применения |
|   -   |   -   |   -   |
|   Система    |  Полный доступ     |  Данная папка, вложенные папки и файлы     |
|  Администраторы     |  Полный доступ     |  Только эта папка     |
|  Создатель/владелец     |  Полный доступ     |  Только вложенные папки и файлы     |
| Группа безопасности пользователей, которым требуется обеспечить общий доступ к данным (пользователи перемещаемых профилей и компьютеры)      |  Содержание папки, чтение данных *(Дополнительные разрешения)* <br />Создание папок, добавление данных *(Дополнительные разрешения)* |  Только эта папка     |
| Прочие группы и учетные записи   |  Нет (удаление)     |       |

## <a name="step-4-optionally-create-a-gpo-for-roaming-user-profiles"></a>Шаг 4. Создание GPO для перемещаемых профилей пользователей (при необходимости)

Если у вас еще нет объекта групповой политики для параметров перемещаемых профилей пользователей, выполните нижеописанные действия, чтобы создать для этой цели пустой GPO. Этот объект групповой политики позволит вам установить параметры перемещаемых профилей пользователей (такие, как поддержка основного компьютера, обсуждаемая отдельно), а также могут использоваться для задействования перемещаемых профилей пользователей на компьютерах, как, например, при развертывании в средах виртуальных рабочих столов или со службами удаленных рабочих столов.

Ниже описано создание GPO для перемещаемых профилей пользователей.

1. Откройте диспетчер сервера на компьютере с установленным компонентом управления групповой политикой.
2. В меню **Средства** щелкните элемент **Управление групповой политикой**. Появится окно управления групповыми политиками.
3. Правой кнопкой мыши щелкните домен или организационное подразделение, в котором хотите настроить перемещаемые профили пользователей, после чего выберите элемент **Создать объект групповой политики в этом домене и связать его**.
4. В диалоговом окне **Новый объект групповой политики** укажите имя GPO (например, **Настройки перемещаемого профиля пользователя**) и щелкните **OK**.
5. Щелкните правой кнопкой мыши по новому объекту групповой политики и уберите флажок **Связь включена** . Это исключит применение GPO до завершения его настройки.
6. Выберите GPO. В разделе **Фильтрация ограничений безопасности** на вкладке **Область** выберите пункт **Прошедшие проверку** и нажмите кнопку **Удалить**, чтобы исключить применение GPO ко всем пользователям.
7. В разделе **Фильтрация ограничений безопасности** щелкните элемент **Добавить**.
8. В диалоговом окне **Выбор пользователей, компьютеров или групп** укажите имя группы безопасности, которую вы создали на шаге 1 (например, **Пользователи перемещаемых профилей и компьютеры**), после чего нажмите кнопку **OK**.
9. Перейдите на вкладку **Делегирование**, нажмите кнопку **Добавить**, введите **Прошедшие проверку**, нажмите кнопку **ОК**, а затем снова нажмите **ОК**, чтобы применить разрешения на чтение по умолчанию.
    
    Этот шаг необходим из-за изменений в системе безопасности, внесенных в [MS16-072](https://support.microsoft.com/help/3163622/ms16-072-security-update-for-group-policy-june-14%2c-2016).

>[!IMPORTANT]
>В связи с изменениями, внесенными в [MS16-072A](https://support.microsoft.com/help/3163622/ms16-072-security-update-for-group-policy-june-14%2c-2016), необходимо предоставить группе "Прошедшие проверку" делегированные разрешения на чтение GPO. Иначе GPO не будет применен к пользователям, а уже примененный GPO будет удален, то есть профили пользователей будут снова направляться на локальный компьютер. Дополнительные сведения об изменениях в развертывании GPO, внесенных в MS16-072, см. [здесь](https://blogs.technet.microsoft.com/askds/2016/06/22/deploying-group-policy-security-update-ms16-072-kb3163622/).

## <a name="step-5-optionally-set-up-roaming-user-profiles-on-user-accounts"></a>Шаг 5. Настройка перемещаемых профилей в учетных записях пользователей (при необходимости)

Если вы производите развертывание перемещаемых профилей для учетных записей пользователей, выполните нижеописанные действия, чтобы указать перемещаемые профили пользователей для учетных записей в доменных службах Active Directory. Если вы развертываете перемещаемые профили пользователей для компьютеров, как, например, при использовании служб удаленных рабочих столов или развертывании виртуальных рабочих столов, обратитесь к инструкциям, описанным в разделе [Шаг 6. Настройка перемещаемых профилей пользователей на компьютерах (при необходимости)](#step-6-optionally-set-up-roaming-user-profiles-on-computers).

> [!NOTE]
> Если вы настраиваете перемещаемые профили для учетных записей пользователей, используя Active Directory, или для компьютеров, используя групповую политику, приоритет отдается настройке политики на компьютере.

Далее описана настройка перемещаемых профилей в учетных записях пользователей.

1. В центре администрирования Active Directory перейдите в контейнер **Пользователи** (или в контейнер подразделений) в соответствующем домене.
2. Выберите всех пользователей, для которых хотите использовать перемещаемые профили, щелкните их правой кнопкой мыши и выберите пункт **Свойства**.
3. В разделе **Профиль** отметьте флажком пункт **Путь к профилю:** и укажите путь к общей папке, в которой планируете хранить перемещаемый профиль пользователя. В конце пути следует добавить `%username%` (этот заполнитель автоматически заменится именем пользователя при первом входе). Например:
    
    `\\fs1.corp.contoso.com\User Profiles$\%username%`
    
    Чтобы указать обязательный перемещаемый профиль пользователя, введите путь к файлу NTuser.man, который вы создали ранее, например `fs1.corp.contoso.comUser Profiles$default`. Дополнительные сведения см. в статье о [создании обязательных профилей пользователей](https://docs.microsoft.com/windows/client-management/mandatory-user-profile).
4. Щелкните **ОК**.

> [!NOTE]
> По умолчанию при использовании перемещаемых профилей пользователей разрешается развертывание всех приложений на основе среды выполнения Windows® (Магазин Windows). Однако при использовании специальных профилей приложения не развертываются по умолчанию. Специальный статус имеют профили, изменения в которых сбрасываются после выхода пользователя:
> <br><br>Чтобы убрать ограничения на развертывание приложений для специальных профилей, включите параметр политики **Allow deployment operations in special profiles** (расположен по следующему пути: Конфигурация компьютера\Политики\Административные шаблоны\Компоненты Windows\Развертывание пакетов приложений). Однако при таком сценарии развернутые приложения будут хранить на компьютере определенные данные, которые могут накапливаться, например, если с одним ПК работают сотни пользователей. Чтобы очистить пакеты приложений для пользователей, у которых больше нет профиля на компьютере, найдите или создайте средство, которое использует API [CleanupPackageForUserAsync](https://msdn.microsoft.com/library/windows/apps/windows.management.deployment.packagemanager.cleanuppackageforuserasync.aspx).
> <br><br>Подробную информацию о приложениях Магазина Windows см. в разделе [Управление клиентским доступом к Магазину Windows](<https://docs.microsoft.com/previous-versions/windows/it-pro/windows-8.1-and-8/hh832040(v=ws.11)>).

## <a name="step-6-optionally-set-up-roaming-user-profiles-on-computers"></a>Шаг 6. Настройка перемещаемых профилей пользователей на компьютерах (при необходимости)

Если вы выполняете развертывание перемещаемых профилей пользователей для компьютеров, как, например, при использовании служб удаленных рабочих столов или развертывании виртуальных рабочих столов, выполните нижеописанные действия. Если вы развертываете перемещаемые профили для учетных записей пользователей, следуйте инструкциям, приведенным в разделе [Шаг 5. Настройка перемещаемых профилей в учетных записях пользователей (при необходимости)](#step-5-optionally-set-up-roaming-user-profiles-on-user-accounts).

Вы можете использовать групповую политику, чтобы применить перемещаемые профили пользователей на компьютерах под управлением Windows 8.1, Windows 8, Windows 7, Windows Vista, Windows Server 2019, Windows Server 2016, Windows Server 2012 R2, Windows Server 2012, Windows Server 2008 R2 или Windows Server 2008.

> [!NOTE]
> Если вы настраиваете перемещаемые профили пользователей для компьютеров, используя групповую политику, и для учетных записей пользователей, используя Active Directory, приоритет отдается настройке политики на компьютере.

Ниже описана настройка перемещаемых профилей пользователей на компьютерах.

1. Откройте диспетчер сервера на компьютере с установленным компонентом управления групповой политикой.
2. В меню **Средства** щелкните элемент **Управление групповой политикой**. Откроется окно управления групповыми политиками.
3. В компоненте управления групповыми политиками щелкните правой кнопкой мыши GPO, который вы создали на этапе 3 (например, **Настройки перемещаемых профилей пользователей**), после чего выберите пункт **Изменить**.
4. В окне редактора управления групповыми политиками перейдите к разделу **Конфигурация компьютера**&gt; **Политики**&gt; **Административные шаблоны**&gt; **Система**&gt; **Профили пользователей**.
5. Щелкните правой кнопкой мыши элемент **Установить путь к перемещаемым профилям для всех пользователей, входящих в систему на данном компьютере** и щелкните **Изменить**.
    > [!TIP]
    > Такие программы, как Windows PowerShell, по умолчанию используют домашнюю папку пользователя, если она настроена. Вы можете настроить альтернативное локальное или сетевое расположение для каждого пользователя в разделе **Домашняя папка** параметров учетной записи пользователя в доменных службах Active Directory. Чтобы указать путь к домашней папке для всех пользователей компьютера, работающих в Windows 8.1, Windows 8, Windows Server 2019, Windows Server 2016, Windows Server 2012 R2 или Windows Server 2012 в среде виртуального рабочего стола, включите параметр политики **Настроить домашнюю папку пользователя** и укажите общую папку и букву диска для сопоставления (или укажите локальную папку). Не используйте переменные среды или многоточия. В конце пути, указанного при входе пользователя, добавляется пользовательский псевдоним.
6. В диалоговом окне **Свойства** щелкните элемент **Включить**.
7. В поле **Пользователи, входящие на данный компьютер, должны использовать следующий путь для перемещаемых профилей** укажите путь к общей папке, в которой собираетесь хранить перемещаемый профиль пользователя. В конце пути следует добавить `%username%` (этот заполнитель автоматически заменится на имя пользователя при первом входе). Например:

    `\\fs1.corp.contoso.com\User Profiles$\%username%`

    Чтобы указать обязательный перемещаемый профиль пользователя, предварительные настройки которого пользователи не могут изменить на постоянной основе (при выходе пользователя изменения сбрасываются), введите путь к файлу NTuser.man, который вы создали ранее, например `\\fs1.corp.contoso.com\User Profiles$\default`. Дополнительные сведения см. в разделе [Создание обязательного профиля пользователя](https://docs.microsoft.com/windows/client-management/mandatory-user-profile).
8. Щелкните **ОК**.

## <a name="step-7-optionally-specify-a-start-layout-for-windows-10-pcs"></a>Шаг 7. Выбор макета начального экрана для компьютеров с Windows 10 (необязательно)

С помощью групповой политики вы можете применить определенную структуру начального экрана, чтобы она была одинаковой для пользователей на всех компьютерах. Если пользователи входят на несколько компьютеров и вы хотите, чтобы на всех этих компьютерах они получали одинаковый макет начального экрана, убедитесь, что объект групповой политики применяется ко всем этим компьютерам.

Чтобы задать макет начального экрана, выполните следующие действия:

1. Обновите компьютеры с Windows 10 до Windows 10 версии 1607 (также именуется "Юбилейное обновление") или более поздних версий, затем установите накопительный пакет обновления за 14 марта 2017 г. ([KB4013429](https://support.microsoft.com/kb/4013429)) или более поздней версии.
2. Создайте XML-файл полного или частичного макета начального экрана. Дополнительный сведения см. в статье о [настройке и экспорте макета начального экрана](https://docs.microsoft.com/windows/configuration/customize-and-export-start-layout).
    * Если вы укажете *полный* макет начального экрана, пользователь не сможет настраивать любые элементы начального экрана. Если вы укажете *частичный* макет начального экрана, пользователи смогут настраивать все, кроме выбранных вами заблокированных групп плиток. Но при использовании частичного макета начального экрана пользовательские настройки начального экрана не будут перемещаться на другие компьютеры.
3. Используйте групповую политику, чтобы применить настроенный макет начального экрана к объекту групповой политики, созданному для перемещаемых профилей пользователей. Дополнительный сведения см. в статье о [применении настроенного начального экрана в домене с помощью групповой политики](https://docs.microsoft.com/windows/configuration/customize-windows-10-start-screens-by-using-group-policy#bkmk-domaingpodeployment).
4. Используйте групповую политику для настройки следующего значения реестра на компьютерах с Windows 10. Дополнительную информацию см. в [этой статье](<https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/cc753092(v=ws.11)>).

| **Действие**   | **Обновление**                  |
| ------------ | ------------                |
| Куст         | **HKEY_LOCAL_MACHINE**      |
| Путь к ключу     | **Software\Microsoft\Windows\CurrentVersion\Explorer** |
| Имя значения   | **SpecialRoamingOverrideAllowed** |
| Тип значения   | **REG_DWORD**               |
| «Значение»   | **1** (или **0**, чтобы отключить) |
| Основной         | **Десятичное число**                 |

5. (Необязательно) Включите оптимизацию первого входа, чтобы пользователи могли быстрее входить в систему. Сведения о том, как это сделать, см. в [этой статье](https://docs.microsoft.com/windows/client-management/mandatory-user-profile#apply-policies-to-improve-sign-in-time).
6. (Необязательно) Дополнительно сократите время входа, удалив ненужные приложения из базового образа Windows 10, который вы используете для развертывания клиентских компьютеров. В Windows Server 2019 и Windows Server 2016 нет предварительно подготовленных приложений. Поэтому этот шаг для образов сервера можно пропустить.
    - Чтобы удалить приложения, используйте командлет [Remove-AppxProvisionedPackage](https://docs.microsoft.com/powershell/module/dism/remove-appxprovisionedpackage?view=win10-ps) в Windows PowerShell, чтобы удалить следующие приложения. Если компьютеры уже развернуты, вы можете создать скрипты для удаления этих приложений с помощью [Remove-AppxPackage](https://docs.microsoft.com/powershell/module/appx/remove-appxpackage?view=win10-ps):
    
      - Microsoft.windowscommunicationsapps\_8wekyb3d8bbwe;
      - Microsoft.BingWeather\_8wekyb3d8bbwe;
      - Microsoft.DesktopAppInstaller\_8wekyb3d8bbwe;
      - Microsoft.Getstarted\_8wekyb3d8bbwe;
      - Microsoft.Windows.Photos\_8wekyb3d8bbwe;
      - Microsoft.WindowsCamera\_8wekyb3d8bbwe;
      - Microsoft.WindowsFeedbackHub\_8wekyb3d8bbwe;
      - Microsoft.WindowsStore\_8wekyb3d8bbwe;
      - Microsoft.XboxApp\_8wekyb3d8bbwe;
      - Microsoft.XboxIdentityProvider\_8wekyb3d8bbwe;
      - Microsoft.ZuneMusic\_8wekyb3d8bbwe.

>[!NOTE]
>Удаление этих приложений сокращает время входа. Но вы можете оставить любые из них установленными, если они используются в развертывании.

## <a name="step-8-enable-the-roaming-user-profiles-gpo"></a>Шаг 8. Включение GPO перемещаемых профилей пользователей

Если вы настраиваете перемещаемые профили пользователей на компьютерах с помощью групповой политики, или изменили другие параметры перемещаемых профилей пользователей с помощью групповой политики, выполните нижеописанные действия, чтобы включить GPO и применить его к затронутым пользователям.

>[!TIP]
>Если вы планируете задействовать поддержку основного компьютера, это следует сделать до включения GPO. предотвратить копирование данных пользователя на неосновные компьютеры до включения поддержки основного компьютера. Сведения о конкретных настройках политики см. в статье о [развертывании основных компьютеров для перенаправления папок и перемещаемых профилей пользователей](deploy-primary-computers.md).

Ниже описано включение GPO для перемещаемого профиля пользователя.

1. Откройте "Управление групповой политикой".
2. Щелкните правой кнопкой мыши созданный вами GPO и выберите пункт **Связь включена**. Рядом с соответствующим пунктом меню появится флажок.

## <a name="step-9-test-roaming-user-profiles"></a>Шаг 9. Проверка перемещаемых профилей пользователей

Для проверки перемещаемых профилей пользователей войдите в учетную запись компьютера, на котором имеется настроенная для работы с перемещаемыми профилями пользователей учетная запись, или войдите в систему на компьютере, настроенном для работы с перемещаемыми профилями пользователей. После этого убедитесь, что профиль перенаправляется.

Ниже описана проверка перемещаемых профилей пользователей.

1. Войдите в систему на основном компьютере (если вы включили поддержку основного компьютера) при помощи учетной записи пользователя, для которого вы активировали перемещаемые профили пользователей. Если вы включили перемещаемые профили пользователей на определенных компьютерах, войдите в систему на одном из них.
2. Если пользователь уже вошел в систему, откройте командную строку с повышенными привилегиями и введите нижеприведенную команду, чтобы убедиться, что на компьютере используются последние настройки групповой политики.
    
    ```PowerShell
    GpUpdate /Force
    ```
3. Чтобы убедиться, что профиль пользователя перемещается, перейдите в **Панель управления**, выберите разделы **Система и безопасность**, **Система**, **Дополнительные параметры системы**, щелкните элемент **Параметры** в разделе с профилями пользователей и убедитесь, что в столбце **Тип** есть надпись **Перемещение**.

## <a name="appendix-a-checklist-for-deploying-roaming-user-profiles"></a>Приложение A. Контрольный список для развертывания перемещаемых профилей пользователей

| Состояние                     | Действие                                                |
| ---                        | ------                                                |
| ☐<br>☐<br>☐<br>☐<br>☐   | 1. Подготовка домена<br>— Присоединение компьютеров к домену<br>— Включение отдельных профилей<br>— Создание учетных записей пользователей<br>— Развертывание перенаправления папок (необязательно) |
| ☐<br><br><br>             | 2. Создание группы безопасности для перемещаемых профилей пользователей<br>— Имя группы:<br>— Члены: |
| ☐<br><br>                 | 3. Создание файлового ресурса для перемещаемых профилей пользователей<br>— Имя общей папки: |
| ☐<br><br>                 | 4. Создание GPO для перемещаемых профилей пользователей<br>— Имя GPO:|
| ☐                         | 5. Настройка параметров политики перемещаемых профилей пользователей    |
| ☐<br>☐<br>☐              | 6. Включение перемещаемых профилей пользователей<br>— С помощью доменных служб Active Directory для учетных записей пользователей?<br>— С помощью групповой политики для учетных записей компьютеров?<br> |
| ☐                         | 7. Настройка обязательного макета начального экрана для компьютеров с Windows 10 (необязательно) |
| ☐<br>☐<br><br>☐<br><br>☐ | 8. Включение поддержки основного компьютера (необязательно)<br>— Назначение основных компьютеров для пользователей<br>— Расположение сопоставлений пользователей и основных компьютеров:<br>— Включение поддержки основного компьютера для переназначения папок (необязательно)<br>— На основе компьютеров или на основе пользователей?<br>— Включение поддержки основного компьютера для перемещаемых профилей пользователей (необязательно) |
| ☐                        | 9. Включение GPO перемещаемых профилей пользователей                |
| ☐                        | 10. Проверка перемещаемых профилей пользователей                         |

## <a name="appendix-b-profile-version-reference-information"></a>Приложение B. Справочная информация о версиях профилей

У каждого профиля есть версия, приблизительно соответствующая версии Windows, в которой используется этот профиль. Например, Windows 10 версий 1703 и 1607 использует версию профиля .V6. Корпорация Майкрософт создает новую версию профиля только для сохранения совместимости, то есть не для каждой версии Windows.

В следующей таблице указан список расположений перемещаемых профилей пользователей в разных версиях Windows.

| Версия операционной системы | Расположение перемещаемого профиля пользователя |
| --- | --- |
| Windows XP и Windows Server 2003 | ```\\<servername>\<fileshare>\<username>``` |
| Windows Vista и Windows Server 2008 | ```\\<servername>\<fileshare>\<username>.V2``` |
| Windows 7 и Windows Server 2008 R2 | ```\\<servername>\<fileshare>\<username>.V2``` |
| Windows 8 и Windows Server 2012 | ```\\<servername>\<fileshare>\<username>.V3``` (после обновления ПО и изменения реестра)<br>```\\<servername>\<fileshare>\<username>.V2``` (до обновления ПО и изменения реестра) |
| Windows 8.1 и Windows Server 2012 R2 | ```\\<servername>\<fileshare>\<username>.V4``` (после обновления ПО и изменения реестра)<br>```\\<servername>\<fileshare>\<username>.V2``` (до обновления ПО и изменения реестра) |
| Windows 10 | ```\\<servername>\<fileshare>\<username>.V5``` |
| В Windows 10 версии 1703 или 1607 | ```\\<servername>\<fileshare>\<username>.V6``` |

## <a name="appendix-c-working-around-reset-start-menu-layouts-after-upgrades"></a>Приложение В. Обходные решения для сброса макета начального экрана после обновления

Ниже описаны несколько способов обойти проблему со сбросом макетов начального экрана после обновления на месте.

- Если только один пользователь использует устройство, а ИТ-администратор использует стратегию управляемого развертывания ОС, например через Configuration Manager, можно сделать следующее:
    
  1. перед обновлением экспортируйте макет начального экрана с помощью командлета Export-Startlayout; 
  2. после обновления на месте, но до первого входа пользователя импортируйте макет начального экрана с помощью командлета Import-StartLayout.  
 
     > [!NOTE] 
     > При импорте StartLayout изменяется профиль пользователя по умолчанию. Все профили пользователей, созданные после импорта, получат импортированный макет начального экрана.
 
- ИТ-администратор может использовать для управления макетом начального экрана групповую политику. Использование групповой политики обеспечивает централизованное решение управления, которое предоставляет пользователям стандартизированный макет начального экрана. Есть два режима использования групповой политики для управления начальным экраном. Полная или частичная блокировка. Сценарий полной блокировки не позволяет пользователю вносить изменения в макет начального экрана. Сценарий частичной блокировки позволяет пользователю вносить изменения в некоторую часть начального экрана. Дополнительные сведения см. в статье о [настройке и экспорте макета начального экрана](https://docs.microsoft.com/windows/configuration/customize-and-export-start-layout).
        
   > [!NOTE]
   > Изменения, внесенные пользователем в режиме частичной блокировки, не будут сохранены во время обновления.

- Не препятствуйте сбросу макета и позвольте пользователям самостоятельно настроить начальный экран. Чтобы снизить негативное влияние, можно отправить пользователям по электронной почте или другим образом уведомление о том, что после обновления операционной системы макеты начального экрана не будут сохранены. 

## <a name="change-history"></a>Журнал изменений

В следующей таблице представлены наиболее важные изменения этого раздела.

| Дата | Описание |Причина|
| --- | ---         | ---   |
| 1 мая 2019 г. | Добавлены обновления для Windows Server 2019 |
| 10 апреля 2018 г. | Добавлено обсуждение вопроса о сбросе пользовательских настроек начального экрана после обновления операционной системы на месте|Выноска об известной проблеме. |
| 13 марта 2018 г. | Обновлено с учетом Windows Server 2016 | Перемещено из библиотеки предыдущих версий и обновлены сведения о текущей версии Windows Server. |
| 13 апреля 2017 г. | Добавлена информация о профилях в Windows 10 версии 1703, и описано поведение версий перемещаемого профиля при обновлении операционных систем — см. [Рекомендации по использованию перемещаемых профилей пользователей в нескольких версиях Windows](#considerations-when-using-roaming-user-profiles-on-multiple-versions-of-windows). | Отзывы клиентов. |
| 14 марта 2017 г. | Добавлен необязательный шаг по настройке обязательного макета начального экрана для компьютеров с Windows 10 в [приложение А с контрольным списком для развертывания перемещаемых профилей пользователей](#appendix-a-checklist-for-deploying-roaming-user-profiles). |Изменения функций в последнем обновлении Windows. |
| 23 января 2017 г. | Добавлен новый этап в [Шаг 4. Создание GPO для перемещаемых профилей пользователей (при необходимости)](#step-4-optionally-create-a-gpo-for-roaming-user-profiles), в котором разрешения на чтение делегируются пользователям, прошедшим проверку подлинности. Это вызвано новым обновлением безопасности для групповой политики.|Изменения в процедуре обработки групповой политики, связанные с безопасностью. |
| 29 декабря 2016 г. | Добавлена ссылка в раздел [Шаг 8. Включение GPO перемещаемых профилей пользователей](#step-8-enable-the-roaming-user-profiles-gpo), чтобы упростить получение сведений о настройке групповой политики для основных компьютеров. Также исправлены несколько ссылок на шаги 5 и 6, в которых были неверно указаны номера.|Отзывы клиентов. |
| 5 декабря 2016 г. | Добавлены сведения о проблеме с перемещением настроек меню "Пуск". | Отзывы клиентов. |
| 6 июля 2016 г. | Добавлены суффиксы версий профилей для Windows 10 в [приложение B со справочной информацией о версиях профилей](#appendix-b-profile-version-reference-information). Кроме того, Windows XP и Windows Server 2003 удалены из списка поддерживаемых операционных систем. | Внесены обновления с учетом новых версий Windows и удалены сведения о тех версиях Windows, которые больше не поддерживаются. |
| 7 июля 2015 г. | Добавлены требования и последовательность действий для отключения постоянной доступности при использовании кластеризованного файлового сервера. | Кластеризованные общие папки производительнее для небольших операций записи (которые типичны для перемещаемых профилей пользователей), если постоянная доступность отключена. |
| 19 марта 2014 г. | Переведены в правильный регистр названия суффиксов версий профилей (.V2, .V3, .V4) в [приложении B со справочной информацией о версиях профилей](#appendix-b-profile-version-reference-information). | ОС Windows нечувствительна к регистру. Но если вы используете NFS с общей папкой, важно сохранять правильный (верхний) регистр суффикса профиля. |
| 9 октября 2013 г. | Внесены изменения для Windows Server 2012 R2 и Windows 8.1, прояснены некоторые вопросы и добавлены разделы [Рекомендации по использованию перемещаемых профилей пользователей в нескольких версиях Windows](#considerations-when-using-roaming-user-profiles-on-multiple-versions-of-windows) и [приложение B со справочной информацией о версиях профилей](#appendix-b-profile-version-reference-information). | Внесены изменения с учетом новых версий и отзывов пользователей. |

## <a name="more-information"></a>Дополнительные сведения

- [Развертывание перенаправления папок, автономных файлов и перемещаемых профилей пользователей](deploy-folder-redirection.md)
- [Развертывание основных компьютеров для перенаправления папок и использования перемещаемых профилей пользователей](deploy-primary-computers.md)
- [Implementing User State Management](<https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2003/cc784645(v=ws.10)>) (Реализация управления состоянием пользователя)
- [Microsoft's Support Statement Around Replicated User Profile Data](https://blogs.technet.microsoft.com/askds/2010/09/01/microsofts-support-statement-around-replicated-user-profile-data/) (Заявление корпорации Майкрософт о поддержке реплицированных данных профилей пользователей)
- [Sideload Apps with DISM](<https://docs.microsoft.com/previous-versions/windows/it-pro/windows-8.1-and-8/hh852635(v=win.10)>) (Загрузка неопубликованных приложений с помощью DISM)
- [Troubleshooting packaging, deployment, and query of Windows Runtime-based apps](https://msdn.microsoft.com/library/windows/desktop/hh973484.aspx) (Устранение проблем с упаковкой, развертыванием и запросами приложений среды выполнения Windows)