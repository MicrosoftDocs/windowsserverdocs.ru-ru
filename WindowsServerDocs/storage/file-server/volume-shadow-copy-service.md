---
title: Служба теневого копирования томов
ms.date: 01/30/2019
ms.prod: windows-server
ms.technology: storage
author: JasonGerend
manager: elizapo
ms.author: jgerend
ms.openlocfilehash: 19e07504dad49c5e23cc49630015529e2a746aa7
ms.sourcegitcommit: 6aff3d88ff22ea141a6ea6572a5ad8dd6321f199
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/27/2019
ms.locfileid: "71394450"
---
# <a name="volume-shadow-copy-service"></a>Служба теневого копирования томов

Область применения: Windows Server 2019, Windows Server 2016, Windows Server 2012 R2, Windows Server 2012 и Windows Server 2008 R2, Windows Server 2008, Windows 10, Windows 8.1, Windows 8, Windows 7

Резервное копирование и восстановление критически важных бизнес-данных может быть очень сложным из-за следующих проблем.

  - Обычно требуется резервное копирование данных, пока все приложения, создающие данные, продолжают работать. Это означает, что некоторые файлы данных могут быть открыты или находятся в нестабильном состоянии.  
      
  - Если набор данных большой, может быть трудно создать резервную копию всего.  
      

Для правильного выполнения операций резервного копирования и восстановления требуется тесное координация между приложениями резервного копирования, бизнес-приложениями, для которых выполняется резервное копирование, и оборудованием и программным обеспечением управления хранением. Служба теневого копирования томов (VSS), которая появилась в Windows Server® 2003, упрощает взаимодействие между этими компонентами, позволяя им лучше работать вместе. Когда все компоненты поддерживают VSS, их можно использовать для резервного копирования данных приложения без перевода приложений в автономный режим.

VSS координирует действия, необходимые для создания единообразной теневой копии (также известной как моментальный снимок или копия на момент времени) архивируемых данных. Теневая копия может использоваться "как есть" или ее можно использовать в следующих сценариях:

  - Необходимо выполнить резервное копирование данных приложения и сведений о состоянии системы, включая архивацию данных на другой жесткий диск, на ленту или на другой съемный носитель.  
      
  - Вы используете интеллектуальный анализ данных.  
      
  - Вы выполняете резервное копирование с диска на диск.  
      
  - Вам потребуется быстрое восстановление после потери данных, восстановив данные в исходном LUN или в совершенно новом LUN, который заменяет исходный LUN, который завершился сбоем.  
      

К функциям и приложениям Windows, использующим VSS, относятся следующие:

  - [Cистема архивации данных Windows Server](http://go.microsoft.com/fwlink/?linkid=180891) (http://go.microsoft.com/fwlink/?LinkId=180891)  
      
  - [Теневые копии общих папок](http://go.microsoft.com/fwlink/?linkid=142874) (http://go.microsoft.com/fwlink/?LinkId=142874)  
      
  - [Data Protection Manager System Center](http://go.microsoft.com/fwlink/?linkid=180892) (http://go.microsoft.com/fwlink/?LinkId=180892)  
      
  - [Восстановление системы](http://go.microsoft.com/fwlink/?linkid=180893) (http://go.microsoft.com/fwlink/?LinkId=180893)  
      

## <a name="how-volume-shadow-copy-service-works"></a>Как работает служба теневого копирования томов

Для полного решения VSS требуются следующие основные компоненты:

**Служба VSS**   часть операционной системы Windows, которая позволяет другим компонентам правильно взаимодействовать друг с другом и работать вместе.

**Инициатор запроса VSS**   программное обеспечение, запрашивающее фактическое создание теневых копий (или других крупномасштабных операций, таких как импорт или удаление). Как правило, это приложение резервного копирования. Программа cистема архивации данных Windows Server и приложение Data Protection Manager System Center являются запросами VSS. Сторонние® инициаторы запросов VSS включают почти все программное обеспечение для резервного копирования, работающее в Windows.

**Модуль записи VSS**   компонент, гарантирующий, что у нас есть согласованный набор данных для резервного копирования. Обычно это обеспечивается в составе бизнес-приложения, такого как SQL Server® или Exchange Server. Модули записи VSS для различных компонентов Windows, таких как реестр, входят в состав операционной системы Windows. Модули записи VSS сторонних производителей входят в состав многих приложений для Windows, которые должны обеспечить согласованность данных во время резервного копирования.

**Поставщик VSS**   компонент, который создает и поддерживает теневые копии. Это может произойти в программном обеспечении или на оборудовании. Операционная система Windows включает поставщик VSS, который использует копирование при записи. Если вы используете сеть хранения данных (SAN), важно установить поставщик оборудования VSS для сети SAN, если он предоставляется. Поставщик оборудования разгружает задачу создания и обслуживания теневой копии из операционной системы узла.

На следующей схеме показано, как служба VSS координирует работу с запрашивающими стороны, модулями записи и поставщиками для создания теневой копии тома.

![](media/volume-shadow-copy-service/Ee923636.94dfb91e-8fc9-47c6-abc6-b96077196741(WS.10).jpg)

**Рис. 1**   архитектурную схему Служба теневого копирования томов

### <a name="how-a-shadow-copy-is-created"></a>Создание теневой копии

В этом разделе перечисляются различные роли инициатора запроса, модуля записи и поставщика в контексте, в котором перечислены действия, которые необходимо выполнить для создания теневой копии. На следующей схеме показано, как служба теневого копирования томов управляет общей координацией запрашивающего, модуля записи и поставщика.

![](media/volume-shadow-copy-service/Ee923636.1c481a14-d6bc-4796-a3ff-8c6e2174749b(WS.10).jpg)

**Рис. 2** Процесс создания теневой копии

Чтобы создать теневую копию, инициатор запроса, модуль записи и поставщик выполняют следующие действия:

1.  Инициатор запроса запрашивает у служба теневого копирования томов перечисление модулей записи, собирает метаданные модуля записи и готовится к созданию теневого копирования.  
      
2.  Каждый модуль записи создает XML-описание компонентов и хранилищ данных, для которых необходимо создать резервную копию, и предоставляет их для служба теневого копирования томов. Модуль записи также определяет метод Restore, который используется для всех компонентов. В служба теневого копирования томов содержится описание модуля записи для инициатора запроса, в котором выбираются компоненты, для которых будет выполняться резервное копирование.  
      
3.  Служба теневого копирования томов уведомляет всех модулей записи о подготовке данных для создания теневой копии.  
      
4.  Каждый модуль записи подготавливает данные соответствующим образом, например для выполнения всех открытых транзакций, отката журналов транзакций и очистки кэшей. Когда данные готовы к теневому копированию, модуль записи уведомляет служба теневого копирования томов.  
      
5.  Служба теневого копирования томов предписывает средствам записи временно заморозить запросы на запись операций ввода-вывода приложения (запросы ввода-вывода на чтение по-прежнему возможны) в течение нескольких секунд, необходимых для создания теневой копии тома или томов. Замораживание приложения не может занять больше 60 секунд. Служба теневого копирования томов очищает буферы файловой системы, а затем закрепляет файловую систему, что гарантирует, что метаданные файловой системы будут записаны правильно, а данные, предназначенные для теневого копирования, записываются в единообразном порядке.  
      
6.  Служба теневого копирования томов указывает поставщику создать теневую копию. Период создания теневой копии длится не более 10 секунд, в течение которого все запросы на запись в файловую систему остаются замороженными.  
      
7.  Служба теневого копирования томов выпускает запросы ввода-вывода в файловой системе.  
      
8.  Служба VSS сообщает средствам записи о разморозку запросов ввода-вывода приложения. На этом этапе приложения могут возобновить запись данных на диск, на который выполняется теневое копирование.  
      

> [!NOTE]
> Создание теневой копии может быть прервано, если модули записи хранятся в состоянии замораживания дольше 60 секунд или если для фиксации теневой копии поставщики занимают больше 10 секунд. 
<br>

9. Инициатор запроса может повторить процесс (вернитесь к шагу 1) или уведомить администратора о необходимости повторить попытку позже.  
      
10. Если теневая копия создана успешно, служба теневого копирования томов возвращает сведения о расположении для теневой копии запрашивающей стороне. В некоторых случаях теневая копия может быть временно доступна в качестве тома для чтения и записи, чтобы служба VSS и одно или несколько приложений могли изменять содержимое теневой копии до завершения создания теневой копии. После того как VSS и приложения выполняют изменения, теневая копия становится доступна только для чтения. Этот этап называется автовосстановлением и используется для отмены любых транзакций файловой системы или приложений на томе теневого копирования, которые не были выполнены до создания теневой копии.  
      

### <a name="how-the-provider-creates-a-shadow-copy"></a>Как поставщик создает теневую копию

Поставщик теневого копирования оборудования или программного обеспечения использует один из следующих методов создания теневой копии:

**Завершение копирования**   этот метод создает полную копию исходного тома (называемую «полной копией» или «клон») на заданный момент времени. Эта копия доступна только для чтения.

**Копирование при записи**   этот метод не копирует исходный том. Вместо этого создается разностная копия путем копирования всех изменений (завершенных запросов ввода-вывода), сделанных на томе после определенного момента времени.

**Перенаправление при записи**   этот метод не копирует исходный том и не вносит изменения в исходный том после определенного момента времени. Вместо этого создается разностная копия путем перенаправления всех изменений на другой том.

## <a name="complete-copy"></a>Завершить копирование

Полная копия обычно создается путем выполнения разбиения зеркального отображения следующим образом.

1.  Исходный том и том теневой копии являются зеркальным набором томов.  
      
2.  Том теневой копии отделен от исходного тома. Это приводит к разрыву зеркального подключения.  
      

После разрыва зеркального подключения исходный том и том теневой копии будут независимыми. Исходный том продолжает принимать все изменения (запросы ввода-вывода), в то время как том теневой копии остается точной копией исходных данных только для чтения во время перерыва.

### <a name="copy-on-write-method"></a>Метод копирования при записи

В методе копирования при записи, когда происходит изменение исходного тома (но до завершения запроса на запись ввода-вывода), каждый изменяемый блок считывается, а затем записывается в область хранения теневых копий тома (также называется областью копирования). Область хранения теневых копий может находиться на том же томе или на другом томе. Это сохраняет копию блока данных на исходном томе до того, как изменение перезапишет его.


<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="header">
<th>Время</th>
<th>Исходные данные (состояние и данные)</th>
<th>Теневое копирование (состояние и данные)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>T0</p></td>
<td><p>Исходные данные: 1 2 3 4 5</p></td>
<td><p>Без копирования:</p></td>
</tr>
<tr class="even">
<td><p>T1</p></td>
<td><p>Данные изменены в кэше: от 3 до 3</p></td>
<td><p>Создана теневая копия (только различия): 3</p></td>
</tr>
<tr class="odd">
<td><p>T2</p></td>
<td><p>Исходные данные перезаписаны: 1 2 3 ' 4 5</p></td>
<td><p>Различия и индекс, хранимые в теневой копии: 3</p></td>
</tr>
</tbody>
</table>

**Таблица 1**   метода копирования при записи для создания теневых копий

Метод копирования при записи является быстрым способом создания теневой копии, поскольку копирует только измененные данные. Скопированные блоки в области diff можно объединить с измененными данными на исходном томе, чтобы восстановить том в состояние до внесения каких либо изменений. При наличии большого числа изменений метод копирования при записи может стать дорогостоящим.

### <a name="redirect-on-write-method"></a>Метод перенаправления при записи

В методе перенаправления записи, когда исходный том получает изменение (запрос на запись ввода-вывода), это изменение не применяется к исходному тому. Вместо этого изменение записывается в область хранения теневых копий другого тома.


<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="header">
<th>Время</th>
<th>Исходные данные (состояние и данные)</th>
<th>Теневое копирование (состояние и данные)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>T0</p></td>
<td><p>Исходные данные: 1 2 3 4 5</p></td>
<td><p>Без копирования:</p></td>
</tr>
<tr class="even">
<td><p>T1</p></td>
<td><p>Данные изменены в кэше: от 3 до 3</p></td>
<td><p>Создана теневая копия (только различия): 3 "</p></td>
</tr>
<tr class="odd">
<td><p>T2</p></td>
<td><p>Исходные данные не изменены: 1 2 3 4 5</p></td>
<td><p>Отличия и индекс, хранимые в теневом копировании: 3 '</p></td>
</tr>
</tbody>
</table>

**Таблица 2**   метода перенаправления на запись для создания теневых копий

Как и метод копирования при записи, метод перенаправления на запись является быстрым способом создания теневой копии, поскольку копирует только изменения данных. Скопированные блоки в области diff можно объединить с неизмененными данными на исходном томе, чтобы создать полную и актуальную копию данных. При наличии большого количества запросов на чтение ввода-вывода метод перенаправления на запись может оказаться дорогостоящим.

## <a name="shadow-copy-providers"></a>Поставщики теневого копирования

Существует два типа поставщиков теневого копирования: поставщики на основе оборудования и поставщики на основе программного обеспечения. Также существует поставщик системы, который является поставщиком программного обеспечения, встроенным в операционную систему Windows.

### <a name="hardware-based-providers"></a>Поставщики на основе оборудования

Аппаратные поставщики теневого копирования действуют в качестве интерфейса между служба теневого копирования томов и аппаратным уровнем, работая в сочетании с адаптером или контроллером хранилища оборудования. Работа по созданию и обслуживанию теневой копии выполняется массивом хранения данных.

Поставщики оборудования всегда получают теневую копию всего LUN, но служба теневого копирования томов предоставляет только теневую копию запрошенного тома или томов.

Аппаратный поставщик теневого копирования использует функции служба теневого копирования томов, определяющие момент времени, позволяет синхронизировать данные, управлять теневой копией и предоставляет общий интерфейс с приложениями резервного копирования. Однако в служба теневого копирования томов не указан базовый механизм, по которому поставщик аппаратного обеспечения создает и поддерживает теневые копии.

### <a name="software-based-providers"></a>Поставщики на основе программного обеспечения

Поставщики теневого копирования на основе программного обеспечения обычно перехватывают и обрабатывают запросы на чтение и запись в программном уровне между файловой системой и программным обеспечением диспетчера томов.

Эти поставщики реализуются как компонент DLL пользовательского режима и по крайней мере один драйвер устройства в режиме ядра, обычно это драйвер фильтра хранилища. В отличие от аппаратных поставщиков, поставщики на основе программного обеспечения создают теневые копии на уровне программного обеспечения, а не на уровне оборудования.

Поставщик теневого копирования на основе программного обеспечения должен поддерживать представление тома "на момент времени", имея доступ к набору данных, который можно использовать для повторного создания состояния тома до времени создания теневой копии. Примером является метод копирования при записи поставщика системы. Однако служба теневого копирования томов не накладывает ограничений на то, какой метод программных поставщиков использует для создания и обслуживания теневых копий.

Поставщик программного обеспечения применим к более широкому спектру платформ хранения, чем поставщик на основе оборудования. Кроме того, он должен хорошо работать с базовыми дисками или логическими томами. (Логический том — это том, который создается путем объединения свободного места с двух или более дисков.) В отличие от аппаратных теневых копий, поставщики программного обеспечения используют ресурсы операционной системы для обслуживания теневой копии.

Дополнительные сведения о базовых дисках см. в разделе [что такое основные диски и тома?](http://go.microsoft.com/fwlink/?linkid=180894) (http://go.microsoft.com/fwlink/?LinkId=180894) на сайте TechNet.

### <a name="system-provider"></a>Поставщик системы

Один поставщик теневых копий, поставщик системы, предоставляется в операционной системе Windows. Хотя поставщик по умолчанию предоставляется в Windows, другие поставщики могут предоставлять реализации, оптимизированные для аппаратных и программных приложений хранилища.

Для поддержания представления тома, содержащегося в теневой копии, поставщик системы использует метод копирования при записи. он используется для хранения данных в режиме "на момент времени". Копии блоков на томе, которые были изменены с начала создания теневой копии, хранятся в области хранения теневых копий.

Поставщик системы может предоставлять рабочий том, который может быть записан и прочитан обычным образом. Если требуется теневая копия, она логически применяет различия к данным на рабочем томе для предоставления полной теневой копии.

Для поставщика системы область хранения теневых копий должна находиться на томе NTFS. Том, для которого требуется выполнить теневое копирование, не обязательно должен быть томом NTFS, но по крайней мере один том, подключенный к системе, должны быть томом NTFS.

Файлы компонентов, составляющие поставщик системы, — это свпрв. dll и Volsnap. sys.

### <a name="in-box-vss-writers"></a>Модули записи VSS в Box

Операционная система Windows включает набор модулей записи VSS, которые отвечают за перечисление данных, необходимых для различных компонентов Windows.

Дополнительные сведения об этих модулях записи см. на следующих веб-сайтах корпорации Майкрософт:

  - [Модули записи VSS в Box](http://go.microsoft.com/fwlink/?linkid=180895) (http://go.microsoft.com/fwlink/?LinkId=180895)  
      
  - [Новые встроенные модули записи VSS для Windows Server 2008 и Windows Vista с пакетом обновления 1 (SP1)](http://go.microsoft.com/fwlink/?linkid=180896) (http://go.microsoft.com/fwlink/?LinkId=180896)  
      
  - [Новые встроенные модули записи VSS для Windows Server 2008 R2 и Windows 7](http://go.microsoft.com/fwlink/?linkid=180897) (http://go.microsoft.com/fwlink/?LinkId=180897)  
      

## <a name="how-shadow-copies-are-used"></a>Как используются теневые копии

Кроме резервного копирования данных приложения и сведений о состоянии системы, теневые копии можно использовать в ряде целей, включая следующие:

  - Восстановление LUN (повторная синхронизация LUN и переключение LUN)  
      
  - Восстановление отдельных файлов (теневые копии общих папок)  
      
  - Интеллектуальный анализ данных с помощью перепереносимых теневых копий  
      

### <a name="restoring-luns-lun-resynchronization-and-lun-swapping"></a>Восстановление LUN (повторная синхронизация LUN и переключение LUN)

В Windows Server 2008 R2 и Windows 7 инициаторы запросов VSS могут использовать функцию поставщика аппаратного теневого копирования, называемую повторной синхронизацией LUN (или "повторная синхронизация LUN"). Это схема быстрого восстановления, позволяющая администратору приложения восстанавливать данные из теневой копии в исходный LUN или в новый LUN.

Теневая копия может быть полным клоном или разностной теневой копией. В любом случае, в конце операции повторной синхронизации, конечный LUN будет иметь то же содержимое, что и LUN теневого копирования. Во время операции повторной синхронизации массив выполняет копирование на уровне блока из теневой копии в целевой LUN.


> [!NOTE]
> Теневая копия должна быть переносимой аппаратной теневой копией. 
<br>


Большинство массивов позволяют возобновлять рабочие операции ввода-вывода вскоре после начала операции повторной синхронизации. Пока выполняется операция повторной синхронизации, запросы на чтение перенаправляются на LUN теневой копии и запросы на запись в целевой LUN. Это позволяет массивам восстанавливать очень большие наборы данных и возобновлять нормальные операции за несколько секунд.

Повторная синхронизация LUN отличается от перекачки LUN. Переключение LUN — это сценарий быстрого восстановления, поддерживаемый службой VSS с Windows Server 2003 с пакетом обновления 1 (SP1). При смене LUN теневая копия импортируется, а затем преобразуется в том для чтения и записи. Преобразование является необратимой операцией, и после этого невозможно управлять Томом и базовым LUN с помощью API VSS. В следующем списке описано сравнение повторной синхронизации LUN с подкачкой LUN.

  - В случае повторной синхронизации LUN теневая копия не изменяется, поэтому ее можно использовать несколько раз. В подстановке LUN теневая копия может использоваться только один раз для восстановления. Для большинства администраторов, которым важна безопасность, это важно. Когда используется повторная синхронизация LUN, инициатор запроса может повторить всю операцию восстановления, если что-то пойдет в первый раз.  
      
  - В конце переключения LUN используется LUN теневой копии для рабочих запросов ввода-вывода. По этой причине LUN теневой копии должен использовать то же качество хранилища, что и у исходного рабочего LUN, чтобы обеспечить отсутствие влияния на производительность после операции восстановления. Если вместо этого используется повторная синхронизация LUN, поставщик оборудования может поддерживать теневую копию в хранилище, которое занимает меньше ресурсов, чем хранилище рабочего качества.  
      
  - Если целевой LUN непригоден для использования и его необходимо создать повторно, перестановка LUN может быть более экономичной, так как для него не требуется целевой LUN.  
      


> [!WARNING]
> Все перечисленные операции являются операциями на уровне LUN. Если вы попытаетесь восстановить конкретный том с помощью повторной синхронизации LUN, вам будет непреднамеренно возвращаться все остальные тома, которые совместно используют LUN. 
<br>


### <a name="restoring-individual-files-shadow-copies-for-shared-folders"></a>Восстановление отдельных файлов (теневые копии общих папок)

Теневые копии общих папок использует служба теневого копирования томов для предоставления копий файлов на момент времени, расположенных в общем сетевом ресурсе, например на файловом сервере. С помощью теневые копии общих папок пользователи могут быстро восстанавливать удаленные или измененные файлы, хранящиеся в сети. Так как они могут сделать это без помощи администратора, теневые копии общих папок может повысить производительность и снизить затраты на администрирование.

Дополнительные сведения о теневые копии общих папок см. в разделе [теневые копии общих папок](http://go.microsoft.com/fwlink/?linkid=180898) (http://go.microsoft.com/fwlink/?LinkId=180898) на сайте TechNet.

### <a name="data-mining-by-using-transportable-shadow-copies"></a>Интеллектуальный анализ данных с помощью перепереносимых теневых копий

С поставщиком оборудования, предназначенным для использования с служба теневого копирования томов, можно создавать переносимые теневые копии, которые можно импортировать на серверы в той же подсистеме (например, SAN). Эти теневые копии можно использовать для заполнения рабочей или тестовой установки с данными, предназначенными только для чтения, для интеллектуального анализа данных.

С служба теневого копирования томов и массивом хранения данных с поставщиком оборудования, предназначенным для использования с служба теневого копирования томов, можно создать теневую копию исходного тома данных на одном сервере, а затем импортировать теневую копию на другой сервер.  (или обратно на тот же сервер). Этот процесс выполняется через несколько минут независимо от размера данных. Процесс транспорта выполняется с помощью ряда действий, использующих инициатор запроса теневого копирования (приложение управления хранением), поддерживающий переносимые теневые копии.

## <a name="to-transport-a-shadow-copy"></a>Передача теневой копии

1.  Создайте транспортную теневую копию исходных данных на сервере.

2.  Импортируйте теневую копию на сервер, подключенный к сети SAN (можно импортировать на другой сервер или на тот же сервер).

3.  Теперь данные готовы к использованию.

![](media/volume-shadow-copy-service/Ee923636.633752e0-92f6-49a7-9348-f451b1dc0ed7(WS.10).jpg)

**Рис. 3**   создания и транспортировки теневых копий между двумя серверами


> [!NOTE]
> Невозможно импортировать транспортную теневую копию, созданную в Windows Server 2003, на сервер под Windows Server 2008 или Windows Server 2008 R2. Транспортную теневую копию, созданную в Windows Server 2008 или Windows Server 2008 R2, нельзя импортировать на сервер под Windows Server 2003. Однако теневую копию, созданную в Windows Server 2008, можно импортировать на сервер, работающий под Windows Server 2008 R2, и наоборот. 
<br>


Теневые копии доступны только для чтения. Если вы хотите преобразовать теневую копию в LUN для чтения и записи, в дополнение к служба теневого копирования томов можно использовать приложение для управления хранилищем на основе службы виртуальных дисков (включая некоторые запрашивающие стороны). С помощью этого приложения можно удалить теневую копию из служба теневого копирования томов управления и преобразовать ее в LUN для чтения и записи.

Служба теневого копирования томов транспорт — это расширенное решение на компьютерах под управлением Windows Server 2003 Enterprise Edition, Windows Server 2003 Datacenter Edition, Windows Server 2008 или Windows Server 2008 R2. Он работает только при наличии в массиве хранения данных поставщика оборудования. Транспорт теневого копирования может использоваться в ряде целей, включая резервное копирование на магнитную ленту, интеллектуальный анализ данных и тестирование.

## <a name="frequently-asked-questions"></a>Вопросы и ответы

Ответы на часто задаваемые вопросы о служба теневого копирования томов (VSS) для системных администраторов. Сведения об интерфейсах программирования приложений VSS см. в разделе [служба теневого копирования томов](http://go.microsoft.com/fwlink/?linkid=180899) (http://go.microsoft.com/fwlink/?LinkId=180899) в библиотеке центра разработчиков Windows.

### <a name="when-was-volume-shadow-copy-service-introduced-on-which-windows-operating-system-versions-is-it-available"></a>Когда служба теневого копирования томов появились? На какие версии операционной системы Windows она доступна?

Служба VSS появилась в Windows XP. Она доступна в Windows XP, Windows Server 2003, Windows Vista®, Windows Server 2008, Windows 7 и Windows Server 2008 R2.

### <a name="what-is-the-difference-between-a-shadow-copy-and-a-backup"></a>В чем разница между теневой копией и резервной копией?

В случае резервного копирования жесткого диска созданная теневая копия также является резервной копией. Данные могут быть скопированы из теневой копии для восстановления, или же теневая копия может использоваться для сценария быстрого восстановления, например для повторной синхронизации LUN или подкачки LUN.

При копировании данных из теневой копии на ленту или другой съемный носитель содержимое, хранящееся на носителе, образует резервную копию. Сама теневая копия может быть удалена после копирования данных из нее.

### <a name="what-is-the-largest-size-volume-that-volume-shadow-copy-service-supports"></a>Каков самый крупный объем, поддерживаемый служба теневого копирования томов?

Служба теневого копирования томов поддерживает размер тома до 64 ТБ.

### <a name="i-made-a-backup-on-windows-server2008-can-i-restore-it-on-windows-server2008r2"></a>Я сделал резервную копию на Windows Server 2008. Можно ли восстановить его в Windows Server 2008 R2?

Это зависит от используемого программного обеспечения резервного копирования. Большинство программ резервного копирования поддерживают этот сценарий для данных, но не для резервного копирования состояния системы.

Теневые копии, созданные в любой из этих версий Windows, можно использовать на другом.

### <a name="i-made-a-backup-on-windows-server2003-can-i-restore-it-on-windows-server2008"></a>Я сделал резервную копию на Windows Server 2003. Можно ли восстановить его в Windows Server 2008?

Это зависит от используемого программного обеспечения резервного копирования. При создании теневой копии на Windows Server 2003 ее нельзя использовать в Windows Server 2008. Кроме того, при создании теневой копии на Windows Server 2008 ее нельзя восстановить в Windows Server 2003.

### <a name="how-can-i-disable-vss"></a>Как отключить VSS?

Отключить служба теневого копирования томов можно с помощью консоли управления (MMC). Однако это не следует делать. Отключение VSS негативно влияет на любое используемое программное обеспечение, например восстановление системы и cистема архивации данных Windows Server.

Дополнительные сведения см. на следующих веб-сайтах Microsoft TechNet:

  - [Восстановление системы](http://go.microsoft.com/fwlink/?linkid=157113) (http://go.microsoft.com/fwlink/?LinkID=157113)  
      
  - [Cистема архивации данных Windows Server](http://go.microsoft.com/fwlink/?linkid=180891) (http://go.microsoft.com/fwlink/?LinkID=180891)  
      

### <a name="can-i-exclude-files-from-a-shadow-copy-to-save-space"></a>Можно ли исключить файлы из теневой копии, чтобы сэкономить место?

Служба VSS предназначена для создания теневых копий целых томов. Временные файлы, например файлы подкачки, автоматически удаляются из теневых копий для экономии пространства.

Чтобы исключить определенные файлы из теневых копий, используйте следующий раздел реестра: **филесноттоснапшот**.


> [!NOTE]
> Раздел реестра <STRONG>филесноттоснапшот</STRONG> предназначен для использования только приложениями. Пользователи, пытающиеся использовать это приложение, сталкиваются с такими ограничениями:
> <br>
> <UL>
> <LI>Он не может удалять файлы из теневой копии, созданной на сервере Windows Server, с помощью функции предыдущих версий.<BR><BR>
> <LI>Он не может удалять файлы из теневых копий для общих папок.<BR><BR>
> <LI>Он может удалять файлы из теневой копии, созданной с помощью служебной программы <a href="https://docs.microsoft.com/windows-server/administration/windows-commands/diskshadow" data-raw-source="[Diskshadow](https://docs.microsoft.com/windows-server/administration/windows-commands/diskshadow)">Diskshadow</a> , но не может удалять файлы из теневой копии, созданной с помощью программы <a href="https://docs.microsoft.com/windows-server/administration/windows-commands/vssadmin" data-raw-source="[Vssadmin](https://docs.microsoft.com/windows-server/administration/windows-commands/vssadmin)">vssadmin</a> .<BR><BR>
> <LI>Файлы удаляются из теневой копии на наиболее эффективном уровне. Это означает, что их удаление не гарантируется.<BR><BR></LI></UL>


Дополнительные сведения см. в разделе [исключение файлов из теневых копий](http://go.microsoft.com/fwlink/?linkid=180904) (http://go.microsoft.com/fwlink/?LinkId=180904) на сайте MSDN.

### <a name="my-non-microsoft-backup-program-failed-with-a-vss-error-what-can-i-do"></a>Программа резервного копирования, не относящаяся к Майкрософт, завершилась с ошибкой VSS. Что я могу сделать?

Просмотрите раздел Поддержка продуктов на веб-сайте компании, которая создала программу резервного копирования. Возможно, имеется обновление продукта, которое можно скачать и установить, чтобы устранить проблему. Если нет, обратитесь в отдел поддержки продуктов компании.

Системные администраторы могут использовать сведения об устранении неполадок VSS на следующем веб-сайте библиотеки Microsoft TechNet для сбора диагностических сведений о проблемах, связанных с VSS.

Дополнительные сведения см. в разделе [Служба теневого копирования томов](http://go.microsoft.com/fwlink/?linkid=180905) (http://go.microsoft.com/fwlink/?LinkId=180905) на сайте TechNet.

### <a name="what-is-the-diff-area"></a>Что такое "область копирования"?

Область хранения теневых копий (или «область копирования») — это расположение, в котором хранятся данные для теневой копии, создаваемой поставщиком программного обеспечения системы.

### <a name="where-is-the-diff-area-located"></a>Где находится область копирования?

Область diff может располагаться на любом локальном томе. Однако он должен располагаться на томе NTFS, на котором достаточно места для хранения.

### <a name="how-is-the-diff-area-location-determined"></a>Как определяется расположение области копирования?

Следующие критерии оцениваются в указанном порядке для определения расположения области копирования:

  - Если у тома уже есть теневая копия, используется это расположение.  
      
  - Если между исходным Томом и расположением тома теневых копий имеется предварительно настроенное сопоставление вручную, используется это расположение.  
      
  - Если предыдущие два критерия не предоставляют расположение, служба теневого копирования выбирает расположение на основе доступного свободного пространства. Если выполняется теневое копирование нескольких томов, служба теневого копирования создает список возможных расположений моментальных снимков в зависимости от размера свободного пространства в порядке убывания. Количество указанных расположений равно числу томов, для которых выполняется теневое копирование.  
      
  - Если копируемый том является одним из возможных расположений, то создается локальная ассоциация. В противном случае создается связь с томом с наибольшим доступным пространством.  
      

### <a name="can-vss-create-shadow-copies-of-non-ntfs-volumes"></a>Может ли VSS создавать теневые копии томов, отличных от NTFS?

Да. Однако постоянные теневые копии можно создавать только для томов NTFS. Кроме того, по крайней мере один том, подключенный в системе, должен быть томом NTFS.

### <a name="whats-the-maximum-number-of-shadow-copies-i-can-create-at-one-time"></a>Каково максимальное количество теневых копий, которые можно создать одновременно?

Максимальное число теневых скопированных томов в одном наборе теневых копий — 64. Обратите внимание, что это не то же самое, что количество теневых копий.

### <a name="whats-the-maximum-number-of-software-shadow-copies-created-by-the-system-provider-that-i-can-maintain-for-a-volume"></a>Каково максимальное количество теневых копий программного обеспечения, созданных поставщиком системы, которые я могу поддерживать для тома?

Максимальное число теневых копий программного обеспечения для каждого тома — 512. Однако по умолчанию поддерживается только теневые копии 64, используемые теневыми копиями общих папок. Чтобы изменить ограничение для теневых копий компонента "Общие папки", используйте следующий раздел реестра: **максшадовкопиес**.

### <a name="how-can-i-control-the-space-that-is-used-for-shadow-copy-storage-space"></a>Как можно управлять пространством, используемым для хранения теневых копий?

Введите команду **vssadmin Resize шадовстораже** .

Дополнительные сведения см. в статье [vssadmin Resize шадовстораже](http://go.microsoft.com/fwlink/?linkid=180906) (http://go.microsoft.com/fwlink/?LinkId=180906) на сайте TechNet.

### <a name="what-happens-when-i-run-out-of-space"></a>Что происходит, когда закончится место?

Теневые копии тома удаляются, начиная с самой старой теневой копии.

## <a name="volume-shadow-copy-service-tools"></a>Средства служба теневого копирования томов

Операционная система Windows предоставляет следующие средства для работы с VSS:

  - [Diskshadow](http://go.microsoft.com/fwlink/?linkid=180907) (http://go.microsoft.com/fwlink/?LinkId=180907)  
      
  - [VssAdmin](http://go.microsoft.com/fwlink/?linkid=84008) (http://go.microsoft.com/fwlink/?LinkId=84008)  
      

### <a name="diskshadow"></a>DiskShadow

DiskShadow — это инициатор запроса VSS, который можно использовать для управления всеми моментальными снимками оборудования и программного обеспечения, которые могут быть установлены в системе. Сценарий DiskShadow включает в себя следующие команды:

  - **список**: список модулей записи VSS, поставщиков VSS и теневых копий  
      
  - **создать**: создает новую теневую копию  
      
  - **Импорт**: импортирует транспортную теневую копию  
      
  - **предоставить**: предоставляет постоянную теневую копию (например, букву диска).  
      
  - **отменить**: возврат тома к указанной теневой копии  
      

Этот инструмент предназначен для использования ИТ-специалистами, но разработчики также могут найти его полезность при тестировании модуля записи VSS или поставщика VSS.

Сценарий DiskShadow доступен только в операционных системах Windows Server. Она недоступна в клиентских операционных системах Windows.

### <a name="vssadmin"></a>List

VssAdmin используется для создания, удаления и вывода списка сведений о теневых копиях. Его также можно использовать для изменения размера области хранения теневых копий (область копирования).

VssAdmin включает в себя следующие команды:

  - **создать тень**: создает новую теневую копию  
      
  - **удалить тени**: удаляет теневые копии  
      
  - **список поставщиков**: список всех зарегистрированных поставщиков VSS  
      
  - **модули записи списка**: список всех модулей записи VSS с подпиской  
      
  - **изменить размер шадовстораже**: изменение максимального размера области хранения теневых копий  
      

VssAdmin можно использовать только для управления теневыми копиями, созданными поставщиком системного программного обеспечения.

VssAdmin доступен в версиях операционной системы клиента Windows и Windows Server.

## <a name="volume-shadow-copy-service-registry-keys"></a>служба теневого копирования томов разделов реестра

Следующие разделы реестра доступны для использования с VSS.

  - **вссакцессконтрол**  
      
  - **максшадовкопиес**  
      
  - **миндиффареафилесизе**  
      

### <a name="vssaccesscontrol"></a>вссакцессконтрол

Этот ключ используется для указания пользователей, имеющих доступ к теневым копиям.

Дополнительные сведения см. в следующих записях на веб-сайте MSDN:

  - [Вопросы безопасности для модулей записи](http://go.microsoft.com/fwlink/?linkid=157739) (http://go.microsoft.com/fwlink/?LinkId=157739)  
      
  - [Вопросы безопасности для запрашивающих стороны](http://go.microsoft.com/fwlink/?linkid=180908) (http://go.microsoft.com/fwlink/?LinkId=180908)  
      

### <a name="maxshadowcopies"></a>максшадовкопиес

Этот ключ указывает максимальное количество доступных для клиента теневых копий, которые могут храниться на каждом томе компьютера. Теневые копии, доступные для клиента, используются теневые копии общих папок.

Дополнительные сведения см. в следующей записи на веб-сайте MSDN:

**Максшадовкопиес** в разделах [реестра для резервного копирования и восстановления](http://go.microsoft.com/fwlink/?linkid=180909) (http://go.microsoft.com/fwlink/?LinkId=180909)

### <a name="mindiffareafilesize"></a>миндиффареафилесизе

Этот ключ задает минимальный исходный размер области хранения теневых копий (в МБ).

Дополнительные сведения см. в следующей записи на веб-сайте MSDN:

**Миндиффареафилесизе** в разделах [реестра для резервного копирования и восстановления](http://go.microsoft.com/fwlink/?linkid=180910) (http://go.microsoft.com/fwlink/?LinkId=180910)

`##`# "Поддерживаемые версии операционной системы

В следующей таблице перечислены минимальные версии операционных систем, поддерживаемые функциями VSS.


<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="header">
<th>Компонент VSS</th>
<th>Минимальная версия клиента</th>
<th>Минимальная версия сервера</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>Повторная синхронизация LUN</p></td>
<td><p>Ни одна версия не поддерживается</p></td>
<td><p>Windows Server 2008 R2</p></td>
</tr>
<tr class="even">
<td><p>Раздел реестра <strong>филесноттоснапшот</strong></p></td>
<td><p>Windows Vista</p></td>
<td><p>Windows Server 2008</p></td>
</tr>
<tr class="odd">
<td><p>Переносимые теневые копии</p></td>
<td><p>Ни одна версия не поддерживается</p></td>
<td><p>Windows Server 2003 с пакетом обновления 1 (SP1);</p></td>
</tr>
<tr class="even">
<td><p>Аппаратные теневые копии</p></td>
<td><p>Ни одна версия не поддерживается</p></td>
<td><p>Windows Server 2003.</p></td>
</tr>
<tr class="odd">
<td><p>Предыдущие версии Windows Server</p></td>
<td><p>Windows Vista</p></td>
<td><p>Windows Server 2003.</p></td>
</tr>
<tr class="even">
<td><p>Быстрое восстановление с помощью переключения LUN</p></td>
<td><p>Ни одна версия не поддерживается</p></td>
<td><p>Windows Server 2003 с пакетом обновления 1 (SP1);</p></td>
</tr>
<tr class="odd">
<td><p>Несколько импортов аппаратных теневых копий</p>
<div class="alert">
<table>
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="header">
<th><img src="media/volume-shadow-copy-service/Dd560667.note(WS.10).gif" />Примечание.</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Это возможность импортировать теневую копию несколько раз. В каждый момент времени может выполняться только одна операция импорта.
<p></p></td>
</tr>
</tbody>
</table>
<p></p>
</div></td>
<td><p>Ни одна версия не поддерживается</p></td>
<td><p>Windows Server 2008</p></td>
</tr>
<tr class="even">
<td><p>теневые копии общих папок</p></td>
<td><p>Ни одна версия не поддерживается</p></td>
<td><p>Windows Server 2003.</p></td>
</tr>
<tr class="odd">
<td><p>Переносимые автоматически восстанавливаемые теневые копии</p></td>
<td><p>Ни одна версия не поддерживается</p></td>
<td><p>Windows Server 2008</p></td>
</tr>
<tr class="even">
<td><p>Одновременные сеансы резервного копирования (до 64)</p></td>
<td><p>Windows XP</p></td>
<td><p>Windows Server 2003.</p></td>
</tr>
<tr class="odd">
<td><p>Одновременный сеанс одиночного восстановления с резервными копиями</p></td>
<td><p>Windows Vista</p></td>
<td><p>Windows Server 2003 с пакетом обновления 2 (SP2)</p></td>
</tr>
<tr class="even">
<td><p>До 8 сеансов восстановления, параллельно с резервными копиями</p></td>
<td><p>Windows 7</p></td>
<td><p>Windows Server 2003 R2</p></td>
</tr>
</tbody>
</table>

## <a name="see-also"></a>См. также

[служба теневого копирования томов в центре разработчиков Windows](https://docs.microsoft.com/windows/desktop/vss/volume-shadow-copy-service-overview)