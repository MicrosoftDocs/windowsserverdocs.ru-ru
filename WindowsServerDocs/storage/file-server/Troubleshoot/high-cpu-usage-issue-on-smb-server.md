---
title: Высокая загрузка ЦП на SMB Server
description: В этой статье рассказывается, как устранить проблему высокой загрузки ЦП на сервере SMB.
author: Deland-Han
manager: dcscontentpm
audience: ITPro
ms.topic: article
ms.author: delhan
ms.date: 12/25/2019
ms.openlocfilehash: 8a14952ca90b6ee3bea901fd944d7c9843492fd4
ms.sourcegitcommit: 8cf04db0bc44fd98f4321dca334e38c6573fae6c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/03/2020
ms.locfileid: "75654345"
---
# <a name="high-cpu-usage-issue-on-the-smb-server"></a>Высокая загрузка ЦП на SMB Server

В этой статье описывается, как устранить проблему высокой загрузки ЦП на сервере SMB.

## <a name="high-cpu-usage-because-of-storage-performance-issues"></a>Высокая загрузка ЦП из-за проблем с производительностью хранилища

Проблемы с производительностью хранилища могут привести к высокой загрузке ЦП на серверах SMB. Перед устранением неполадок убедитесь, что на сервере SMB установлен последний накопительный пакет обновления, чтобы устранить все известные проблемы в SRV2. sys.

В большинстве случаев вы заметите проблемы высокой загрузки ЦП в системном процессе. Прежде чем продолжать, используйте обозреватель процессов, чтобы убедиться, что SRV2. sys или NTFS. sys потребляют чрезмерное количество ресурсов ЦП.

### <a name="storage-area-network-san-scenario"></a>Сценарий сети хранения данных (SAN)

На уровнях статистических вычислений общая производительность сети SAN может показаться неправильной. Однако при работе с проблемами SMB время ответа отдельного запроса — это наиболее важное значение.

Как правило, эта проблема может быть вызвана некоторой формой очереди команд в сети SAN. С помощью **perfmon** можно записать трассировку **Microsoft-Windows-Storport** и проанализировать ее, чтобы точно определить скорость реагирования хранилища.

### <a name="disk-io-latency"></a>Задержка ввода-вывода диска

Задержка ввода-вывода диска — это мера задержки между созданием и завершением запроса на ввод-вывод на диск.

Задержка ввода-вывода, измеряемая в PerfMon, включает в себя все время, затраченное на аппаратные уровни, а также время, затраченное на очередь драйверов портов Майкрософт (Storport. sys для SCSI). Если запущенные процессы создают большую очередь Storport, то измеряемая задержка увеличивается. Это связано с тем, что операции ввода-вывода должны ожидать перед отправкой на аппаратные уровни.

В PerfMon следующие счетчики показывают задержку физического диска:

- "Объект производительности физического диска"-\> "среднее время чтения с диска (сек.)" — показывает среднюю задержку чтения.

- "Объект производительности физического диска"-\> "среднее время записи на диск (сек.)" — показывает среднюю задержку записи.

- "Объект производительности физического диска"-\> "среднее время обращения к диску (сек.)" — показывает Объединенные средние значения для операций чтения и записи.

Экземпляр\_Total — это среднее значение задержки для всех физических дисков на компьютере. Каждый из других экземпляров представляет отдельный физический диск.

> [!NOTE]
> Не путайте эти счетчики со средним объемом обращений к диску/с. Это совершенно разные счетчики.

### <a name="windows-storage-stack-follows"></a>Стек хранилища Windows:

В этом разделе приводится краткое описание стека хранилища Windows.

Когда приложение создает запрос ввода-вывода, оно отправляет запрос в подсистему ввода-вывода Windows в верхней части стека. Затем операции ввода-вывода перемещаются вниз по стеку в аппаратную подсистему Disk. Затем ответ перемещается на все способы резервного копирования. Во время этого процесса каждый слой выполняет свою функцию, а затем передает операции ввода-вывода на следующий слой.

![Поток стека](media/high-cpu-usage-issue-on-smb-server-1.png)

PerfMon не создает никаких данных о производительности в секунду. Вместо этого он потребляет данные, предоставляемые другими подсистемами в Windows.

Для объекта производительности "физический диск" данные фиксируются на уровне "Диспетчер секций" в стеке хранилища.

При измерении счетчиков, упомянутых в предыдущем разделе, мы измеряем все время, затрачиваемое запросом ниже уровня "Диспетчер секций". Когда Диспетчер секций отправляет запрос на ввод-вывод по стеку вниз, он отмечает время. При возврате мы опять отметкам времени снова и вычислите разницу во времени. Разница во времени — это задержка.

Это делается для учета времени, затраченного на выполнение следующих компонентов:

- Драйвер класса — управляет типом устройства, например дисками, лентами и т. д.

- Драйвер порта — управляет транспортным протоколом, таким как SCSI, FC, SATA и т. д.

- Драйвер минипорта устройства — это драйвер для адаптера хранилища. Он предоставляется изготовителем устройств, например RAID-контроллером, и FC HBA.

- Дисковая подсистема — включает все, что находится ниже драйвера минипорта устройства. Это может быть так же просто, как кабель, подключенный к одному физическому жесткому диску, или сложнее, чем сеть хранения данных. Если проблема определена как вызванная этим компонентом, можно обратиться к поставщику оборудования за дополнительными сведениями об устранении неполадок.

### <a name="disk-queuing"></a>Очередь дисков

Существует ограниченный объем операций ввода-вывода, которые дисковая подсистема может принимать в определенный момент времени. Избыточный ввод-вывод ставится в очередь до тех пор, пока диск не сможет снова принять ввод-вывод. Время, затрачиваемое вводом-выводом в очереди под уровнем "Диспетчер секций", учитывается в измерениях задержки физического диска системного монитора. Так как очереди увеличиваются крупнее, а операции ввода-вывода должны ждать больше времени, измеряемая задержка также растет.

Ниже уровня "Диспетчер секций" имеется несколько очередей, как показано ниже.

- Очередь драйвера порта Майкрософт-порт/порт/Storport

- Очередь драйверов устройств, предоставленная изготовителем — драйвер устройства OEM

- Очереди оборудования, такие как очередь контроллера диска, очередь коммутаторов SAN, очередь контроллера массива и очередь жестких дисков

Мы также будем учитывать время, затрачиваемое на то, что жесткий диск тратит на активное обслуживание операций ввода-вывода, и время, затрачиваемое на выполнение запроса на возврат к уровню "Диспетчер секций", помеченному как завершенный.

Наконец, необходимо уделить особое внимание очереди драйверов портов (для SCSI Storport. sys). Драйвер порта — это последний компонент Майкрософт для сенсорного ввода-вывода, прежде чем мы переносимся к драйверу минипорта устройства, предоставленному изготовителем оборудования.

Если драйвер минипорта устройства не может принимать дополнительные операции ввода-вывода из-за того, что его очередь или очереди оборудования ниже, то мы начнем накопление операций ввода-вывода в очереди драйвера порта. Размер очереди драйвера Microsoft Port ограничивается только объемом доступной системной памяти (ОЗУ) и может увеличиваться очень большим. Это приводит к большой измеряемой задержке.

## <a name="high-cpu-caused-by-enumerating-folders"></a>Высокая загрузка ЦП, вызванная перечислением папок 

Чтобы устранить эту проблему, отключите функцию перечисления на основе доступа (ABE).

Чтобы определить, какие общие ресурсы SMB включены в параметр ABE, выполните следующую команду PowerShell:

```PowerShell
Get-SmbShare | Select Name, FolderEnumerationMode
```

Unrestricted = ABE отключен. <br />
Акцессбасе = ABE включен.


Можно включить ABE в **Диспетчер сервера**. Перейдите к **файлам и службам хранилища** > **Общие папки**, щелкните общую папку правой кнопкой мыши, выберите пункт " **Свойства**", перейдите в раздел " **Параметры** " и выберите " **включить перечисление на основе доступа**".

![Параметры пользовательского интерфейса](media/high-cpu-usage-issue-on-smb-server-2.png)

Кроме того, можно уменьшить **абелевел** до более низкого уровня (1 или 2), чтобы повысить производительность.

Если перечисление работает медленнее, можно проверить производительность диска, открыв папку локально через консоль или сеанс RDP.
