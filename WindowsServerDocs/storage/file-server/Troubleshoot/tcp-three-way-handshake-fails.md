---
title: Сбой TCP-подключения с тремя способами при подключении SMB
description: Представляется сбой TCP-подключения с тремя способами при подключении SMB.
author: Deland-Han
manager: dcscontentpm
ms.topic: article
ms.author: delhan
ms.date: 12/25/2019
ms.openlocfilehash: cb88fa89344172cfc1ed036865a4496ed73e9a22
ms.sourcegitcommit: b00d7c8968c4adc8f699dbee694afe6ed36bc9de
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/08/2020
ms.locfileid: "80815327"
---
# <a name="tcp-three-way-handshake-failure-during-smb-connection"></a>Сбой TCP-подключения с тремя способами при подключении SMB

При анализе трассировки сети вы заметили, что существует 3-сторонний сбой подтверждения протокола TCP, который приводит к возникновению проблемы с SMB. В этой статье описывается, как устранить эту ситуацию.

## <a name="troubleshooting"></a>Диагностика

Как правило, причина — это локальный брандмауэр или межсетевой экран инфраструктуры, который блокирует трафик. Эта проблема может возникнуть в одном из следующих сценариев.

## <a name="scenario-1"></a>Сценарий 1

Пакет TCP SYN поступает на сервер SMB, но сервер SMB не возвращает пакет TCP SYN-ACK.

Чтобы устранить эту проблему, выполните следующие действия.

### <a name="step-1"></a>Шаг 1

Выполните команду **netstat** или **Get-нетткпконнектион** , чтобы убедиться в наличии прослушивателя на TCP-порте 445, который должен принадлежать системному процессу.

```cmd
netstat -ano | findstr :445
```

```PowerShell
Get-NetTcpConnection -LocalPort 445
```

### <a name="step-2"></a>Шаг 2

Убедитесь, что служба сервера запущена и запущена.

### <a name="step-3"></a>Шаг 3

Выполните захват платформы фильтрации Windows (WFP), чтобы определить, какое правило или программа удаляет трафик. Для этого выполните в окне командной строки следующую команду:

```cmd
netsh wfp capture start
```

Воспроизведите ошибку, а затем выполните следующую команду:

```cmd
netsh wfp capture stop
```

Запустите трассировку сценария и найдите в SMB-трафике (TCP-порт 445) сбросы WFP.

При необходимости можно удалить антивирусные программы, так как они не всегда основаны на WFP.

### <a name="step-4"></a>Шаг 4

Если включен брандмауэр Windows, включите ведение журнала брандмауэра, чтобы определить, записывает ли он передачу трафика.

Убедитесь в том, что правила "общий доступ к файлам и принтерам (SMB-in)" включены в **брандмауэре Windows в области повышенной безопасности** \> **правила для входящих подключений**.

> [!NOTE]
> В зависимости от настроек компьютера "Брандмауэр Windows" может называться "брандмауэр защитника Windows".

## <a name="scenario-2"></a>Сценарий 2

Пакет TCP SYN никогда не поступает на SMB-сервер.

В этом сценарии необходимо исследовать устройства по сетевому пути. Вы можете проанализировать трассировки сети, которые записываются на каждом устройстве, чтобы определить, какое устройство блокирует трафик.
