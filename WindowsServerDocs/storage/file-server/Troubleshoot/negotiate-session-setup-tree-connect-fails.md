---
title: Сбои при согласовании, настройке сеанса и подключении дерева
description: В этой статье содержатся сведения об устранении неполадок при сбоях подключения, установки сеанса и дерева.
author: Deland-Han
manager: dcscontentpm
ms.topic: article
ms.author: delhan
ms.date: 12/25/2019
ms.openlocfilehash: 2bad602f934d844074ee96df06bf9234fdbf943f
ms.sourcegitcommit: d5e27c1f2f168a71ae272bebf8f50e1b3ccbcca3
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/23/2020
ms.locfileid: "86961166"
---
# <a name="negotiate-session-setup-and-tree-connect-failures"></a>Сбои при согласовании, настройке сеанса и подключении дерева

В этой статье описывается, как устранить неполадки, возникающие при выполнении запроса на подключение к SMB, установка сеанса и соединение дерева.

## <a name="negotiate-fails"></a>Сбой согласования

SMB Server получает запрос на СОГЛАСОВАНие SMB от клиента SMB. Время ожидания соединения истекло и сбрасывается через 60 секунд. После около 200 микросекунд может появиться сообщение с ПОДТВЕРЖДЕНИЕм.

Чаще всего эта проблема возникает из-за антивирусной программы.

Если вы используете Windows Server 2008 R2, существуют исправления этой проблемы. Убедитесь, что клиент SMB и сервер SMB обновлены.

## <a name="session-setup-fails"></a>Сбой установки сеанса

SMB-сервер получает запрос на установку сеанса SMB \_ от клиента SMB, но не смог ответить на него.

Если полное доменное имя (FQDN) или сетевое имя системы ввода-вывода (NetBIOS) сервера — "sed" в UNC-пути, Windows будет использовать Kerberos для проверки подлинности.

После получения ответа на согласование будет предпринята попытка получить билет Kerberos для имени участника-службы (SPN) Common Internet File System (CIFS) сервера. Просмотрите трафик Kerberos через TCP-порт 88, чтобы убедиться в отсутствии ошибок Kerberos при получении клиентом SMB маркера.

> [!NOTE]
> Ошибки, возникающие при предварительной проверке подлинности Kerberos, являются нормальными. Ошибки, возникающие после предварительной проверки подлинности Kerberos (экземпляры, в которых проверка подлинности не работают), являются ошибками, вызвавшими проблему с SMB.

Кроме того, выполните следующие проверки:

- Просмотрите большой двоичный объект безопасности в запросе на установку сеанса SMB, \_ чтобы обеспечить отправку правильных учетных данных.

- Попробуйте отключить усиление защиты имени SMB-сервера (**смбсервернамехарденинглевел = 0**).

- Убедитесь, что сервер SMB имеет имя участника-службы при доступе к нему через запись DNS CNAME.

- Убедитесь, что подписывание SMB работает. (Это особенно важно для старых устройств сторонних производителей.)

## <a name="tree-connect-fails"></a>Сбой подключения к дереву

Убедитесь, что учетные данные учетной записи пользователя имеют разрешения "общий доступ" и "NT File System" (NTFS) для папки.

Причину распространенных ошибок Connect Tree можно найти в [3.3.5.7 получении \_ запроса на подключение дерева SMB2](/openspecs/windows_protocols/ms-smb2/652e0c14-5014-4470-999d-b174d7b2da87). Ниже приведены решения для двух распространенных кодов состояния.

\[СОСТОЯНИЕ \_ плохое \_ Сетевое \_ имя\]

Убедитесь, что общая папка существует на сервере и правильно написана в запросе SMB-клиента.

\[\_доступ к состоянию \_ запрещен\]

Убедитесь, что диск и папка, используемые общей папкой, существуют и доступны.

Если вы используете SMBv3 или более поздней версии, проверьте, требуется ли шифрование сервера и общего ресурса, но клиент не поддерживает шифрование. Для этого вам нужно выполнить следующие действия.

- Проверьте сервер, выполнив следующую команду.

  ```PowerShell
  Get-SmbServerConfiguration | select Encrypt*
  ```

  Если EncryptData и Режектуненкриптедакцесс имеют значение true, сервер требует шифрования.

- Проверьте общий ресурс, выполнив следующую команду:

  ```PowerShell
  Get-SmbShare | select name, EncryptData  
  ```

  Если EncryptData имеет значение true для общей папки, а Режектуненкриптедакцесс имеет значение true на сервере, то для общей папки требуется шифрование.

При устранении неполадок следуйте приведенным ниже рекомендациям.

- Windows 8, Windows Server 2012 и более поздних версий Windows поддерживают шифрование на стороне клиента (SMBv3 и более поздние версии).

- Windows 7, Windows Server 2008 R2 и более ранние версии Windows не поддерживают шифрование на стороне клиента.

- Samba и сторонние устройства могут не поддерживать шифрование. Для получения дополнительных сведений может потребоваться обратиться к документации по продукту.

## <a name="references"></a>Ссылки

Дополнительные сведения см. в следующих руководствах.

[3.3.5.4 получение запроса на СОГЛАСОВАНие SMB2](/openspecs/windows_protocols/ms-smb2/b39f253e-4963-40df-8dff-2f9040ebbeb1)

[3.3.5.5 получение запроса на установку сеанса SMB2 \_](/openspecs/windows_protocols/ms-smb2/e545352b-9f2b-4c5e-9350-db46e4f6755e)

[3.3.5.7 получение запроса на подключение дерева SMB2 \_](/openspecs/windows_protocols/ms-smb2/652e0c14-5014-4470-999d-b174d7b2da87)
