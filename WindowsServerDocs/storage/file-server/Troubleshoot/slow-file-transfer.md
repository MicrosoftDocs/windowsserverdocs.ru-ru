---
title: Медленная передача файлов по SMB
description: Сведения об устранении проблем с производительностью при переносе файлов SMB.
author: Deland-Han
manager: dcscontentpm
ms.topic: article
ms.author: delhan
ms.date: 12/25/2019
ms.openlocfilehash: cb575015ea8a8fc6cbc35358103774a931b0b749
ms.sourcegitcommit: d5e27c1f2f168a71ae272bebf8f50e1b3ccbcca3
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/23/2020
ms.locfileid: "86958866"
---
# <a name="slow-smb-files-transfer-speed"></a>Медленная передача файлов по SMB

В этой статье приведены рекомендации по устранению медленной передачи файлов через SMB.

## <a name="large-file-transfer-is-slow"></a>Слишком большое число перемещений больших файлов

При снижении скорости передачи больших файлов необходимо выполнить следующие действия.

- Попробуйте выполнить команду копирования файлов для операций ввода-вывода без буферизации (**xcopy/j** или **Robocopy**).

- Проверьте скорость хранения. Это обусловлено тем, что скорость копирования файлов ограничена скоростью хранения.

- Копирование файлов иногда запускается быстро, а затем замедляется. Чтобы проверить ситуацию, следуйте приведенным ниже рекомендациям.
    
  - Обычно это происходит, когда начальная копия кэшируется или буферизована (в памяти или в кэш-памяти контроллера RAID), и кэш выполняется. Это приводит к тому, что данные записываются непосредственно на диск (сквозная запись). Это медленный процесс.
    
  - Используйте счетчики монитора производительности хранилища, чтобы определить, снижается ли производительность хранилища с течением времени. Дополнительные сведения см. в статье [Настройка производительности для файловых серверов SMB](../../../administration/performance-tuning/role/file-server/smb-file-server.md).

- Используйте Раммап (SysInternals), чтобы определить, прекращается ли увеличение использования сопоставленного файла в памяти из-за нехватки свободной памяти.

- Найдите потери пакетов в трассировке. Это может привести к регулированию поставщиком перегрузки TCP.

- Для SMBv3 и более поздних версий убедитесь, что многоканальный SMB включен и работает.

- На клиенте SMB включите крупный MTU в SMB и отключите регулирование полосы пропускания. Для этого выполните следующую команду:  
  
  ```PowerShell
  Set-SmbClientConfiguration -EnableBandwidthThrottling 0 -EnableLargeMtu 1
  ```

## <a name="small-file-transfer-is-slow"></a>Небольшое перемещение файлов выполняется слишком долго

Снижение скорости перемещения небольших файлов с помощью SMB происходит чаще всего, если имеется много файлов. Это ожидаемое поведение.

При переносе файлов процесс создания файла вызывает высокую нагрузку на протокол и высокую нагрузку на файловую систему. При передаче больших файлов эти затраты происходят только один раз. При передаче большого количества небольших файлов затраты повторяются и замедляется передача данных.

Ниже приведены технические сведения об этой проблеме.

- SMB вызывает команду CREATE, чтобы запросить создание файла. В коде будет проверяться, существует ли файл, а затем создан файл. Или некоторые разновидности команды CREATE создают фактический файл.

- Каждая команда Create создает действие в файловой системе.

- После того, как данные записаны, файл закрывается.

- В течение некоторого времени процесс страдает от задержки сети и задержки сервера SMB. Это связано с тем, что запрос SMB сначала преобразуется в команду файловой системы, а затем в фактическую задержку файловой системы для завершения операции.

- Если какая-либо антивирусная программа запущена, перенос замедляется. Это происходит потому, что данные, как правило, проверяются средством прослушивания пакетов один раз, а второй раз — при их запись на диск. В некоторых сценариях эти действия повторяются тысячами времени. Вы потенциально видите скорость менее 1 МБ/с.

## <a name="opening-office-documents-is-slow"></a>Открытие документов Office выполняется слишком долго

Обычно эта проблема возникает при подключении к глобальной сети. Это часто вызвано тем, как приложения Office (в частности, Microsoft Excel) получают доступ к данным и читают их.

Рекомендуется убедиться в том, что двоичные файлы Office и SMB актуальны, а затем протестировать, выполнив аренду на SMB-сервере. Для этого выполните следующие действия.
   
1. Выполните следующую команду PowerShell в Windows 8 и Windows Server 2012 или более поздних версиях Windows:
      
   ```PowerShell
   Set-SmbServerConfiguration -EnableLeasing $false  
   ```
      
   Или выполните следующую команду в окне командной строки с повышенными привилегиями:  

   ```cmd
   REG ADD HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\lanmanserver\parameters /v DisableLeasing /t REG\_DWORD /d 1 /f  
   ```
      
   > [!NOTE]
   > После установки этого раздела реестра SMB2 аренды больше не предоставляются, но операционные блокировки остаются доступными. Этот параметр используется в основном для устранения неполадок.
    
2. Перезапустите файловый сервер или перезапустите службу **сервера** . Чтобы перезапустить службу, выполните следующие команды:

   ```cmd  
   NET STOP SERVER 
   NET START SERVER
   ```

Чтобы избежать этой проблемы, можно также реплицировать файл на локальный файловый сервер. Дополнительные сведения см. [в статье Авинг Office Documents To a Network Server при использовании EFS](/office/troubleshoot/office/saving-file-to-network-server-slow).
