---
title: Протокол SMB для расширенного устранения неполадок
description: Представляет дополнительные методы устранения неполадок протокола SMB.
author: Deland-Han
manager: dcscontentpm
audience: ITPro
ms.topic: article
ms.author: delhan
ms.date: 12/25/2019
ms.openlocfilehash: 433221f9846e9e071557b5537974b5739131742b
ms.sourcegitcommit: 083ff9bed4867604dfe1cb42914550da05093d25
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/14/2020
ms.locfileid: "75949697"
---
# <a name="advanced-troubleshooting-server-message-block-smb"></a>Протокол SMB для расширенного устранения неполадок

SMB — это протокол сетевого транспорта для операций с файловыми системами, позволяющий клиенту получать доступ к ресурсам на сервере. Основной целью протокола SMB является обеспечение удаленного доступа файловой системы между двумя системами по протоколу TCP/IP.

Устранение неполадок SMB может быть чрезвычайно сложным. Эта статья не является исчерпывающим руководством по устранению неполадок, а представляет собой краткое руководство по эффективному устранению неполадок SMB.

## <a name="tools-and-data-collection"></a>Средства и сбор данных

Одним из ключевых аспектов устранения неполадок качества SMB является связь с правильной терминологией. Поэтому в этой статье рассматривается Базовая терминология SMB для обеспечения точности сбора и анализа данных.

> [!Note]
> *SMB-сервер (SRV)* относится к системе, в которой размещается файловая система, также известная как файловый сервер. *Клиент SMB (CLI)* относится к системе, которая пытается получить доступ к файловой системе, независимо от версии или выпуска операционной системы.

Например, если вы используете Windows Server 2016 для доступа к общему ресурсу SMB, размещенному в Windows 10, Windows Server 2016 является SMB-клиентом и Windows 10 сервером SMB.

### <a name="collect-data"></a>Сбор данных

Прежде чем устранять неполадки SMB, рекомендуется сначала получить трассировку сети на стороне клиента и сервера. Применяются следующие правила.

- В системах Windows для получения трассировки сети можно использовать NetShell (Netsh), сетевой монитор, средство анализа сообщений или Wireshark.

- Сторонние устройства обычно имеют встроенное средство записи пакетов, например tcpdump (Linux/FreeBSD/UNIX) или пктт (NetApp). Например, если клиент SMB или SMB-сервер является узлом UNIX, можно получить данные, выполнив следующую команду:
  
  ```cmd
  # tcpdump -s0 -n -i any -w /tmp/$(hostname)-smbtrace.pcap
  ```
  
  Останавливает сбор данных с клавиатуры с помощью **клавиш CTRL + C** .

Чтобы обнаружить источник проблемы, можно проверить двустороннюю трассировку: CLI, SRV или другое.

#### <a name="using-netshell-to-collect-data"></a>Использование NetShell для получения данных

В этом разделе содержатся инструкции по использованию NetShell для получения трассировки сети.

> [!NOTE]  
> Команда netsh trace создает ETL-файл. ETL-файлы можно открывать только в анализаторе сообщений (MA) и сетевой монитор 3,4 (Настройка средства синтаксического анализа для сетевой монитор анализаторов \> Windows).

1. На сервере SMB и клиенте SMB создайте **временную** папку на диске **C**. Затем выполните следующую команду:

   ```cmd
   netsh trace start capture=yes report=yes scenario=NetConnection level=5 maxsize=1024 tracefile=c:\\Temp\\%computername%\_nettrace.etl**
   ```
   
   Если вы используете PowerShell, выполните следующие командлеты:
   
   ```PowerShell
   New-NetEventSession -Name trace -LocalFilePath "C:\Temp\$env:computername`_netCap.etl" -MaxFileSize 1024

   Add-NetEventPacketCaptureProvider -SessionName trace -TruncationLength 1500

   Start-NetEventSession trace
   ```
   
2. Воспроизведите ошибку.

3. Завершите трассировку, выполнив следующую команду:

   ```cmd
   netsh trace stop
   ```
   
   Если вы используете PowerShell, выполните следующие командлеты:

   ```PowerShell
   Stop-NetEventSession trace  
   Remove-NetEventSession trace
   ```

> [!NOTE] 
> Следует отслеживать только минимальный объем передаваемых данных. При возникновении проблем с производительностью всегда следует использовать как хорошую, так и неверную трассировку, если такая ситуация разрешена.

### <a name="analyze-the-traffic"></a>Анализ трафика

SMB — это протокол уровня приложения, который использует протокол TCP/IP в качестве сетевого транспортного протокола. Поэтому проблема с SMB также может быть вызвана проблемами TCP/IP.

Проверьте, не возникают ли в TCP/IP какие-либо из следующих проблем.

1. TCP-это трехстороннее подтверждение не завершается. Обычно это означает, что имеется блок брандмауэра или служба сервера не запущена.

2. Происходит повторная передача. Это может вызвать медленную передачу файлов из-за составного регулирования перегрузки TCP.

3. Пять повторных передач, за которыми следует сброс TCP, могут означать, что подключение между системами было потеряно или что произошел сбой или зависание одной из служб SMB.

4. Окно приема TCP уменьшается. Это может быть вызвано снижением размера хранилища или какой-либо другой проблемой, которая не позволяет получить данные из буфера Winsock вспомогательной функции (АФД).

Если нет заметной проблемы TCP/IP, проверьте наличие ошибок SMB. Для этого выполните следующие действия:

1. Всегда проверяйте ошибки SMB по спецификации протокола MS-SMB2. Многие ошибки SMB являются небезопасными (неопасными). Ознакомьтесь со следующими сведениями, чтобы определить причину, по которой SMB возвращала ошибку, прежде чем вы завершите, что эта ошибка связана с одной из следующих проблем.

   - В разделе [синтаксис сообщений MS-SMB2](https://docs.microsoft.com/openspecs/windows_protocols/ms-smb2/6eaf6e75-9c23-4eda-be99-c9223c60b181) описывается каждая команда SMB и ее параметры.
    
   - В разделе об [обработке клиента MS-SMB2](https://docs.microsoft.com/openspecs/windows_protocols/ms-smb2/df0625a5-6516-4fbe-bf97-01bef451cab2) описывается, как клиент SMB создает запросы и реагирует на сообщения сервера.

   - В разделе [обработка сервера MS-SMB2](https://docs.microsoft.com/openspecs/windows_protocols/ms-smb2/e1d08834-42e0-41ca-a833-fc26f5132a6f) описывается, как SMB-сервер создает запросы и отвечает на запросы клиентов.

2. Проверьте, не отправлена ли команда TCP Reset сразу после выполнения команды ФСКТЛ\_проверки\_СОГЛАСОВАТЬ\_сведения (проверка согласованности). Если это так, см. следующие сведения:

   - Сеанс SMB должен быть завершен (Сброс TCP), когда процесс проверки согласованности завершается сбоем на клиенте или сервере.

   - Этот процесс может завершиться ошибкой, так как оптимизатор глобальной сети изменяет пакет согласования SMB.

   - Если соединение преждевременно завершилось, выявление последнего обмена данными между клиентом и сервером.

#### <a name="analyze-the-protocol"></a>Анализ протокола

Просмотрите фактические сведения о протоколе SMB в трассировке сети, чтобы понять, какие именно команды и параметры используются.

> [!NOTE]
> Только анализатор сообщений может анализировать команды SMBv3 и более поздних версий.

- Помните, что SMB выполняет только то, что ему нужно.

- Вы можете узнать о том, что пытается сделать приложение, изучив команды SMB.

Сравните команды и операции со спецификацией протокола, чтобы убедиться, что все работает правильно. Если это не так, собирайте данные, расположенные ближе или на более низком уровне, для поиска дополнительных сведений о основной причине. Для этого выполните следующие действия:

1. Сбор данных о стандартной записи пакетов.

2. Выполните команду **netsh** , чтобы выполнить трассировку и сбор сведений о наличии проблем в сетевом стеке или удалении приложений платформы фильтрации Windows (WFP), таких как брандмауэр или антивирусная программа.

3. Если все остальные параметры завершаются неудачно, собирайте t. cmd, если вы считаете, что проблема возникает в самом SMB, или если нет других данных, достаточных для идентификации основной причины.

Пример

- Скорость передачи файлов на один файловый сервер наблюдается.

- Двухсторонние трассировки показывают, что SRV медленно реагирует на запрос чтения.

- Удаление антивирусной программы разрешает передачу файлов с задержкой.

- Чтобы устранить эту проблему, обратитесь к антивирусной программе мануфактори.

> [!NOTE]
> При необходимости вы **также** можете временно удалить антивирусную программу во время устранения неполадок.

#### <a name="event-logs"></a>Журналы событий

Как клиент SMB, так и SMB-сервер имеют подробную структуру журнала событий, как показано на следующем снимке экрана. Собирайте журналы событий, чтобы помочь найти основную причину проблемы.

![Журналы событий](media/troubleshooting-smb-1.png)

## <a name="smb-related-system-files"></a>Системные файлы, связанные с SMB

В этом разделе перечислены системные файлы, связанные с SMB. Чтобы обеспечить обновление системных файлов, убедитесь, что установлен последний [накопительный пакет обновления](https://support.microsoft.com/help/4498140/windows-10-update-history) .

Двоичные файлы клиента SMB, перечисленные в разделе **% WINDIR%\\system32\\Drivers**:

- RDBSS. sys

- MRXSMB. sys

- MRXSMB10. sys

- MRXSMB20. sys

- MUP. sys

- Смбдирект. sys

Двоичные файлы SMB Server, перечисленные в разделе **% WINDIR%\\system32\\Drivers**:

- СРВНЕТ. sys

- SRV. sys

- SRV2. sys

- Смбдирект. sys

- В папке **% WINDIR%\\system32**

- srvsvc. dll

![Компоненты SMB](media/troubleshooting-smb-2.png)

### <a name="update-suggestions"></a>Обновление предложений

Перед устранением проблем с SMB рекомендуется обновить следующие компоненты:

- Файловый сервер требует наличия хранилища файлов. Если в хранилище есть компонент iSCSI, обновите эти компоненты.

- Обновите сетевые компоненты.

- Для повышения производительности и стабильности обновите Windows Core.

## <a name="reference"></a>Справочные материалы

[Сценарий обмена пакетами протокола SMB (Майкрософт)](https://docs.microsoft.com/windows/win32/fileio/microsoft-smb-protocol-packet-exchange-scenario)