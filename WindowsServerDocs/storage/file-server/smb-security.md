---
title: Улучшения в безопасности SMB
description: Описание возможности шифрования по протоколу SMB в Windows Server 2012 R2, Windows Server 2012 и Windows Server 2016.
ms.prod: windows-server
ms.topic: article
author: JasonGerend
ms.author: jgerend
ms.technology: storage
ms.date: 07/09/2018
ms.localizationpriority: medium
ms.openlocfilehash: 9052e9e6a1327b67fd75b07ab2ee6fc56b1190ac
ms.sourcegitcommit: d5e27c1f2f168a71ae272bebf8f50e1b3ccbcca3
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/23/2020
ms.locfileid: "86962139"
---
# <a name="smb-security-enhancements"></a>Улучшения в безопасности SMB

>Применяется к: Windows Server 2012 R2, Windows Server 2012, Windows Server 2016.

В этом разделе описаны улучшения в безопасности SMB в Windows Server 2012 R2, Windows Server 2012 и Windows Server 2016.

## <a name="smb-encryption"></a>Шифрование SMB

Шифрование по протоколу SMB обеспечивает сквозное шифрование данных SMB и защищает их от перехвата в ненадежных сетях. Вы можете развернуть шифрование SMB с минимальными усилиями, но могут потребоваться незначительные дополнительные затраты на специализированное оборудование или программное обеспечение. Требования в отношении ускорителей IPsec или глобальной сети (WAN) отсутствуют. Шифрование SMB можно настроить для отдельных общих папок или всего файлового сервера и включить для ряда сценариев, при которых данные проходят через ненадежные сети.

>[!NOTE]
>Шифрование SMB не охватывает безопасность неактивных данных, которые обычно обрабатываются с помощью шифрования диска BitLocker.

Шифрование SMB следует рассматривать для всех сценариев, в которых конфиденциальные данные необходимо защитить от атак типа "злоумышленник в середине". Вот возможные сценарии.

- Конфиденциальные данные информационного работника перемещаются с использованием протокола SMB. Шифрование SMB обеспечивает комплексную конфиденциальность и целостность данных между файловым сервером и клиентом независимо от прохождения сетей, например, для подключений WAN, поддерживаемых сторонними поставщиками.
- Протокол SMB 3.0 позволяет файловым серверам обеспечивать постоянное доступное хранилище для серверных приложений, таких как SQL Server или Hyper-V. Включение шифрования SMB позволяет защитить эту информацию от атак. Шифрование SMB проще использовать, чем выделяемые аппаратные решения, необходимые для большинства сетей хранения данных (SAN).

>[!IMPORTANT]
>Обратите внимание, что при любой сквозной защите шифрования существуют значительные эксплуатационные затраты в сравнении с использованием незашифрованных данных.

## <a name="enable-smb-encryption"></a>Включение шифрования SMB

Вы можете включить шифрование SMB для всего файлового сервера или только для определенных общих папок. Чтобы включить шифрование SMB, используйте одну из приведенных ниже процедур.

### <a name="enable-smb-encryption-with-windows-powershell"></a>Включение шифрования SMB с помощью Windows PowerShell

1. Чтобы включить шифрование SMB для отдельной общей папки, введите следующий скрипт на сервере:
    
    ```PowerShell
    Set-SmbShare –Name <sharename> -EncryptData $true
    ```
2. Чтобы включить шифрование SMB для всего файлового сервера, введите следующий скрипт на сервере:
    
    ```PowerShell
    Set-SmbServerConfiguration –EncryptData $true
    ```
3. Чтобы создать общую папку SMB с включенным шифрованием SMB, введите следующий скрипт:
    
    ```PowerShell
    New-SmbShare –Name <sharename> -Path <pathname> –EncryptData $true
    ```

### <a name="enable-smb-encryption-with-server-manager"></a>Включение шифрования SMB с помощью диспетчера сервера

1. В диспетчере сервера щелкните **Файловые службы и службы хранилища**.
2. Щелкните **Общие папки**, чтобы открыть страницу управления общими папками.
3. Щелкните правой кнопкой мыши общую папку, для которой нужно включить шифрование SMB, а затем выберите пункт **Свойства**.
4. На странице **Параметры** общей папки выберите **Encrypt data access** (Шифровать доступ к данным). Теперь удаленный доступ к этой общей папке будет шифроваться.

### <a name="considerations-for-deploying-smb-encryption"></a>Рекомендации по развертыванию шифрования SMB

По умолчанию, если для общей папки или сервера включено шифрование SMB, доступ к указанным общим папкам разрешен только клиентам SMB 3.0. Это вынуждает администратора защитить данные для всех клиентов с доступом к общим папкам. Тем не менее при некоторых обстоятельствах администратору может потребоваться разрешить незашифрованный доступ для клиентов, не поддерживающих SMB 3.0 (например, в течение периода перехода, когда клиент использует смешанные версии операционной системы). Чтобы разрешить незашифрованный доступ для клиентов, не поддерживающих SMB 3.0, введите следующий скрипт в Windows PowerShell:

```PowerShell
Set-SmbServerConfiguration –RejectUnencryptedAccess $false
```

Возможность безопасного согласования диалектов, описанная в следующем разделе, предотвращает атаки типа "злоумышленник в середине", которые могут понизить уровень подключения SMB 3.0 до SMB 2.0 (где используется незашифрованный доступ). Тем не менее она не предотвращает понижение на уровень более ранней версии SMB 1.0, что также приводит к незашифрованному доступу. Чтобы клиенты SMB 3.0 всегда использовали шифрование SMB для доступа к зашифрованным общим папкам, необходимо отключить сервер SMB 1.0. (Инструкции см. в разделе [Отключение SMB 1.0](#disabling-smb-10).) Если для параметра **–RejectUnencryptedAccess** оставить значение по умолчанию **$true**, доступ к общим папкам будет разрешен только клиентам SMB 3.0 с поддержкой шифрования (а клиенты SMB 1.0 также будут отклоняться).

>[!NOTE]
>* Для шифрования и расшифровки данных функция шифрования SMB использует алгоритм AES-CCM. AES-CCM также обеспечивает проверку целостности данных (подписывание) для зашифрованных общих папок, независимо от параметров подписывания SMB. Если вы хотите включить подписывание SMB без шифрования, можно выполнить эту задачу. Дополнительные сведения см. в статье [The Basics of SMB Signing](/archive/blogs/josebda/the-basics-of-smb-signing-covering-both-smb1-and-smb2) (Основы подписывания SMB).
>* При попытке доступа к общей папке или серверу могут возникнуть проблемы, если в вашей организации используются устройства ускорения WAN.
>* Если клиенты, не поддерживающие SMB 3.0, при использовании конфигурации по умолчанию (где незашифрованный доступ к зашифрованным общим папкам не разрешен) будут пытаться получить доступ к зашифрованной общей папке, событие с идентификатором 1003 будет занесено в журнал событий Microsoft-Windows-SmbServer/Operational, а клиент получит сообщение об ошибке **Доступ запрещен**.
>* Шифрование SMB и шифрованная файловая система (EFS) в файловой системе NTFS не связаны друг с другом, при этом шифрование SMB не требует использования EFS или не зависит от этой системы.
>* Шифрование SMB и шифрование диска BitLocker не связаны, а это значит, что шифрование SMB не требует использования шифрования диска BitLocker и не зависит от него.

## <a name="secure-dialect-negotiation"></a>Безопасное согласование диалектов

SMB 3.0 может обнаруживать атаки типа "злоумышленник в середине", которые пытаются понизить уровень протокола SMB 2.0 или SMB 3.0 или возможности согласования между клиентом и сервером. Когда клиент или сервер обнаруживает такую атаку, подключение отключается и событие с идентификатором 1005 заносится в журнал событий Microsoft-Windows-SmbServer/Operational. Безопасное согласование диалектов не позволяет обнаруживать или предотвращать переход с SMB 2.0 или 3.0 на SMB 1.0. Поэтому мы настоятельно рекомендуем отключить сервер SMB 1.0, чтобы пользоваться всеми возможностями шифрования SMB. Дополнительные сведения см. в разделе [Отключение SMB 1.0](#disabling-smb-10).

Возможность безопасного согласования диалектов, описанная в следующем разделе, не позволяет атаке типа "злоумышленник в середине" понизить уровень подключения с SMB 3 до SMB 2 (где используется незашифрованный доступ). Но она не предотвращает понижение уровня до SMB 1, что также приводит к незашифрованному доступу. Дополнительные сведения о потенциальных проблемах в ранних реализациях SMB, отличных от Windows, см. в [Базе знаний Майкрософт](https://support.microsoft.com/kb/2686098).

## <a name="new-signing-algorithm"></a>Новый алгоритм подписывания

SMB 3.0 использует более новый алгоритм шифрования для подписывания: AES — код проверки подлинности сообщений на основе шифров (CMAC). В SMB 2.0 использовался старый алгоритм шифрования HMAC-SHA256. AES-CMAC и AES-CCM могут значительно ускорить шифрование данных на самых современных процессорах с поддержкой инструкций AES. Дополнительные сведения см. в статье [The Basics of SMB Signing](/archive/blogs/josebda/the-basics-of-smb-signing-covering-both-smb1-and-smb2) (Основы подписывания SMB).

## <a name="disabling-smb-10"></a>Отключение SMB 1.0

Компоненты устаревшей службы браузера компьютеров и протокол удаленного администрирования (RAP) в SMB 1.0 теперь отделены, и их можно удалить. Эти компоненты по-прежнему включены по умолчанию, но если у вас нет клиентов SMB более ранних версий, таких как компьютеры под управлением Windows Server 2003 или Windows XP, можно удалить компоненты SMB 1.0, чтобы повысить безопасность и, возможно, сократить число исправлений.

>[!NOTE]
>Протокол SMB 2.0 представлен в Windows Server 2008 и Windows Vista. Клиенты более ранних версий, например компьютеры под управлением Windows Server 2003 или Windows XP, не поддерживают SMB 2.0. Поэтому они не смогут получить доступ к общим папкам или принтерам, если сервер SMB 1.0 отключен. Кроме того, у некоторых сторонних клиентов SMB может не быть доступа к общим папкам SMB 2.0 или принтерам (например, к принтерам с функциональной возможностью сканирования для общего доступа).

Прежде чем приступить к отключению SMB 1.0, необходимо выяснить, подключены ли ваши клиенты SMB к серверу под управлением SMB 1.0. Для этого введите следующий командлет в Windows PowerShell:

```PowerShell
Get-SmbSession | Select Dialect,ClientComputerName,ClientUserName | ? Dialect -lt 2
```

>[!NOTE]
>Этот скрипт следует запускать повторно в течение недели (несколько раз в день) для создания журнала аудита. Это также можно выполнять как запланированную задачу.

Чтобы отключить SMB 1.0, введите следующий скрипт в Windows PowerShell:

```PowerShell
Set-SmbServerConfiguration –EnableSMB1Protocol $false
```

>[!NOTE]
>Если подключение клиента SMB отклоняется из-за того, что сервер под управлением SMB 1.0 отключен, событие с идентификатором 1001 будет записано в журнал событий Microsoft-Windows-SmbServer/Operational.

## <a name="more-information"></a>Дополнительные сведения

Ниже приведены некоторые дополнительные ресурсы по SMB и связанным технологиям в Windows Server 2012.

- [Server Message Block Overview](file-server-smb-overview.md) (Общие сведения об SMB)
- [Хранилище в Windows Server](../storage.yml)
- [Scale-Out File Server for Application Data](../../failover-clustering/sofs-overview.md) (Масштабируемый файловый сервер для данных приложений)
