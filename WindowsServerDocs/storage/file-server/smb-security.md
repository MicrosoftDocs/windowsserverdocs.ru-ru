---
title: Улучшения системы безопасности SMB
description: Описание функции шифрования SMB в Windows Server 2012 R2, Windows Server 2012 и Windows Server 2016.
ms.prod: windows-server
ms.topic: article
author: JasonGerend
ms.author: jgerend
ms.technology: storage
ms.date: 07/09/2018
ms.localizationpriority: medium
ms.openlocfilehash: d7b96574dcfc2a4417aa36780d7bd87c2556f61f
ms.sourcegitcommit: 083ff9bed4867604dfe1cb42914550da05093d25
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/14/2020
ms.locfileid: "75950261"
---
# <a name="smb-security-enhancements"></a>Улучшения системы безопасности SMB

>Область применения: Windows Server 2012 R2, Windows Server 2012, Windows Server 2016

В этом разделе объясняются улучшения безопасности SMB в Windows Server 2012 R2, Windows Server 2012 и Windows Server 2016.

## <a name="smb-encryption"></a>Шифрование SMB

Шифрование SMB обеспечивает сквозное шифрование данных SMB и защищает данные от перехвата вхождений в ненадежных сетях. Вы можете развернуть шифрование SMB с минимальными усилиями, но это может потребовать небольших дополнительных затрат на специализированное оборудование или программное обеспечение. Он не имеет требований к протоколу IPsec или ускорителям глобальной сети. Шифрование SMB можно настроить для каждого общего ресурса или для всего файлового сервера, и его можно включить для различных сценариев, в которых данные проходят через ненадежные сети.

>[!NOTE]
>Шифрование SMB не охватывает неактивных средств безопасности, которые обычно обрабатываются шифрование диска BitLocker.

Шифрование SMB следует рассматривать в любом сценарии, в котором конфиденциальные данные должны быть защищены от атак типа "злоумышленник в середине". Вот возможные сценарии.

- Конфиденциальные данные информационного работника перемещаются с помощью протокола SMB. Шифрование SMB обеспечивает комплексное обеспечение конфиденциальности и целостности данных между файловым сервером и клиентом независимо от прохождения сетей, например подключений глобальной сети (WAN), поддерживаемых поставщиками сторонних поставщиков.
- SMB 3,0 позволяет файловым серверам обеспечить постоянное Доступное хранилище для серверных приложений, таких как SQL Server или Hyper-V. Включение шифрования SMB позволяет защитить эту информацию от атак с возможностью прослеживания. Шифрование SMB проще в использовании, чем выделенные аппаратные решения, необходимые для большинства сетей хранения данных (SAN).

>[!IMPORTANT]
>Обратите внимание, что при сравнении с незашифрованными данными существует значительная операционная плата, связанная с производительностью, а также сквозную защиту.

## <a name="enable-smb-encryption"></a>Включить шифрование SMB

Вы можете включить шифрование SMB для всего файлового сервера или только для определенных файловых ресурсов. Для включения шифрования SMB используйте одну из следующих процедур.

### <a name="enable-smb-encryption-with-windows-powershell"></a>Включение шифрования SMB с помощью Windows PowerShell

1. Чтобы включить шифрование SMB для отдельного файлового ресурса, введите следующий сценарий на сервере:
    
    ```PowerShell
    Set-SmbShare –Name <sharename> -EncryptData $true
    ```
2. Чтобы включить шифрование SMB для всего файлового сервера, введите следующий сценарий на сервере:
    
    ```PowerShell
    Set-SmbServerConfiguration –EncryptData $true
    ```
3. Чтобы создать новый файловый ресурс SMB с включенным шифрованием SMB, введите следующий скрипт:
    
    ```PowerShell
    New-SmbShare –Name <sharename> -Path <pathname> –EncryptData $true
    ```

### <a name="enable-smb-encryption-with-server-manager"></a>Включение шифрования SMB с помощью диспетчер сервера

1. В диспетчер сервера откройте **файл и службы хранилища**.
2. Выберите **Общие папки** , чтобы открыть страницу управления общими ресурсами.
3. Щелкните правой кнопкой мыши общую папку, для которой нужно включить шифрование SMB, и выберите пункт **Свойства**.
4. На странице **Параметры** общего ресурса выберите **шифрование доступа к данным**. Удаленный доступ к этому общему файлу зашифрован.

### <a name="considerations-for-deploying-smb-encryption"></a>Рекомендации по развертыванию шифрования SMB

По умолчанию, если для файлового ресурса или сервера включено шифрование SMB, доступ к указанным общим папкам разрешен только клиентам SMB 3,0. Это принуждает администратора к защите данных для всех клиентов, обращающихся к общим ресурсам. Однако в некоторых обстоятельствах администратору может потребоваться разрешить незашифрованный доступ для клиентов, не поддерживающих SMB 3,0 (например, в течение периода перехода при использовании смешанных версий операционной системы клиента). Чтобы разрешить незашифрованный доступ для клиентов, не поддерживающих SMB 3,0, введите следующий скрипт в Windows PowerShell:

```PowerShell
Set-SmbServerConfiguration –RejectUnencryptedAccess $false
```

Возможность согласования в безопасном диалекте, описанная в следующем разделе, предотвращает понижение подключения с SMB 3,0 на SMB 2,0 (при этом использовался незашифрованный доступ). Однако он не предотвращает переход на более раннюю версию SMB 1,0, что также приведет к незашифрованному доступу. Чтобы гарантировать, что клиенты SMB 3,0 всегда используют шифрование SMB для доступа к зашифрованным ресурсам, необходимо отключить сервер SMB 1,0. (Инструкции см. в разделе [Отключение SMB 1,0](#disabling-smb-10).) Если параметр **– режектуненкриптедакцесс** имеет значение по умолчанию **$true**, доступ к общим файловым ресурсам разрешен только клиентам SMB 3,0 с поддержкой шифрования (клиенты SMB 1,0 также будут отклонены).

>[!NOTE]
>* Для шифрования и расшифровки данных шифрование SMB использует алгоритм "AES (AES) — CCM". AES-CCM также обеспечивает проверку целостности данных (подписывание) для зашифрованных файловых ресурсов, независимо от параметров подписывания SMB. Если вы хотите включить подписывание SMB без шифрования, можно продолжить. Дополнительные сведения см. [в разделе основы подписывания SMB](https://blogs.technet.microsoft.com/josebda/2010/12/01/the-basics-of-smb-signing-covering-both-smb1-and-smb2/).
>* При попытке доступа к общей папке или серверу могут возникнуть проблемы, если в Организации используются устройства ускорения глобальной сети (WAN).
>* При использовании конфигурации по умолчанию (при отсутствии незашифрованного доступа к зашифрованным файловым ресурсам), если клиенты, не поддерживающие SMB 3,0, пытаются получить доступ к зашифрованной общей папке, событие с кодом 1003 заносится в журнал событий Microsoft-Windows-Смбсервер/операционный, а клиент получит сообщение об **отказе в доступе** .
>* Шифрование SMB и шифрованная файловая система (EFS) (EFS) в файловой системе NTFS не связаны друг с друга, а шифрование SMB не требует или не зависит от использования EFS.
>* Шифрование SMB и шифрование диска BitLocker не связаны, а шифрование SMB не требует и не зависит от использования шифрование диска BitLocker.

## <a name="secure-dialect-negotiation"></a>Безопасное согласование диалектов

SMB 3,0 может обнаруживать атаки "злоумышленник в середине", которые пытаются понизить уровень протокола SMB 2,0 или SMB 3,0, или возможности, согласованные клиентом и сервером. При обнаружении такой атаки клиентом или сервером подключение отключается, а событие с ИДЕНТИФИКАТОРом 1005 заносится в журнал событий Microsoft-Windows-Смбсервер/операцион. Безопасное согласование диалектов не позволяет обнаруживать или предотвращать переход от SMB 2,0 или 3,0 к SMB 1,0. Поэтому мы настоятельно рекомендуем отключить сервер SMB 1,0, чтобы воспользоваться всеми возможностями шифрования SMB. Дополнительные сведения см. в разделе [Отключение SMB 1,0](#disabling-smb-10).

Возможность согласования в безопасном диалекте, описанная в следующем разделе, не позволяет атаке "злоумышленник в середине" понизить подключение между SMB 3 и SMB 2 (что будет использовать незашифрованный доступ). Однако он не предотвращает понижение до SMB 1, что также приведет к незашифрованному доступу. Дополнительные сведения о потенциальных проблемах с ранними реализациями SMB, отличными от Windows, см. в базе [знаний Майкрософт](https://support.microsoft.com/kb/2686098).

## <a name="new-signing-algorithm"></a>Новый алгоритм подписывания

SMB 3,0 использует более новый алгоритм шифрования для подписывания: AES (AES) — код проверки подлинности сообщений на основе шифров (КМАК). SMB 2,0 использовала старый алгоритм шифрования HMAC-SHA256. AES-КМАК и AES-CCM могут значительно ускорить шифрование данных на самых современных процессорах с поддержкой инструкций AES. Дополнительные сведения см. [в разделе основы подписывания SMB](https://blogs.technet.microsoft.com/josebda/2010/12/01/the-basics-of-smb-signing-covering-both-smb1-and-smb2/).

## <a name="disabling-smb-10"></a>Отключение SMB 1,0

Функции обозревателя устаревших компьютеров и протоколов удаленного администрирования в SMB 1,0 теперь являются отдельными, и их можно устранить. Эти функции по-прежнему включены по умолчанию, но если у вас нет старых клиентов SMB, таких как компьютеры под управлением Windows Server 2003 или Windows XP, можно удалить компоненты SMB 1,0, чтобы повысить безопасность и, возможно, сократить число исправлений.

>[!NOTE]
>Протокол SMB 2,0 появился в Windows Server 2008 и Windows Vista. Более старые клиенты, например компьютеры под управлением Windows Server 2003 или Windows XP, не поддерживают SMB 2,0; Поэтому они не смогут получить доступ к общим папкам или принтерам, если сервер SMB 1,0 отключен. Кроме того, некоторые клиенты SMB сторонних производителей могут не иметь доступа к общим папкам SMB 2,0 или общим папкам для печати (например, к принтерам с функциональностью "сканирование на общий доступ").

Прежде чем приступить к отключению SMB 1,0, необходимо выяснить, подключены ли ваши клиенты SMB к серверу под управлением SMB 1,0. Для этого введите следующий командлет в Windows PowerShell:

```PowerShell
Get-SmbSession | Select Dialect,ClientComputerName,ClientUserName | ? Dialect -lt 2
```

>[!NOTE]
>Этот сценарий следует запускать повторно в течение недели (несколько раз в день) для создания журнала аудита. Это также можно выполнить как запланированную задачу.

Чтобы отключить SMB 1,0, введите следующий скрипт в Windows PowerShell:

```PowerShell
Set-SmbServerConfiguration –EnableSMB1Protocol $false
```

>[!NOTE]
>Если подключение клиента SMB отклоняется из-за того, что сервер под управлением SMB 1,0 был отключен, событие с ИДЕНТИФИКАТОРом 1001 будет записано в журнал событий Microsoft-Windows-Смбсервер/операцион.

## <a name="more-information"></a>Дополнительные сведения

Ниже приведены некоторые дополнительные ресурсы по SMB и связанным технологиям в Windows Server 2012.

- [Блок сообщений сервера](file-server-smb-overview.md)
- [Хранилище в Windows Server](../storage.md)
- [масштабируемый файловый сервер для данных приложения](../../failover-clustering/sofs-overview.md)