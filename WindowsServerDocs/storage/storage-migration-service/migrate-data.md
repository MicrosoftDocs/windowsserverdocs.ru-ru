---
title: Перенос файлового сервера с помощью службы миграции хранилища
description: Краткое описание раздела, посвященного результатам поисковой системы
author: jasongerend
ms.author: jgerend
manager: elizapo
ms.date: 02/13/2019
ms.topic: article
ms.prod: windows-server
ms.technology: storage
ms.openlocfilehash: 20aa5fbc40efc5a3a439361dadfac0f47f4b41d8
ms.sourcegitcommit: 07c9d4ea72528401314e2789e3bc2e688fc96001
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/29/2020
ms.locfileid: "76822627"
---
# <a name="use-storage-migration-service-to-migrate-a-server"></a>Использование службы миграции хранилища для миграции сервера

В этом разделе рассматривается миграция сервера, включая его файлы и конфигурацию, на другой сервер с помощью [службы миграции хранилища](overview.md) и центра администрирования Windows. Миграция занимает три шага после установки службы и открытия всех необходимых портов брандмауэра: Инвентаризация серверов, перенос данных и перерезание на новые серверы.

## <a name="step-0-install-storage-migration-service-and-check-firewall-ports"></a>Шаг 0. Установка службы миграции хранилища и проверка портов брандмауэра

Прежде чем приступить к работе, установите службу миграции хранилища и убедитесь, что нужные порты брандмауэра открыты.

1. Проверьте [требования к службе миграции хранилища](overview.md#requirements) и установите [центр администрирования Windows](../../manage/windows-admin-center/understand/windows-admin-center.md) на компьютере или сервере управления, если вы этого еще не сделали. При миграции исходных компьютеров, присоединенных к домену, необходимо установить и запустить службу миграции хранилища на сервере, присоединенном к тому же домену или лесу, что и исходные компьютеры.
2. В центре администрирования Windows подключитесь к серверу Orchestrator под Windows Server 2019. <br>Это сервер, на котором вы устанавливаете службу миграции хранилища на и используете для управления миграцией. Если выполняется миграция только одного сервера, можно использовать целевой сервер, если он работает под Windows Server 2019. Для миграции с несколькими серверами рекомендуется использовать отдельный сервер оркестрации.
3. Перейдите в **Диспетчер сервера** (в центре администрирования Windows) > **Служба миграции хранилища** и выберите **установить** , чтобы установить службу миграции хранилища и ее обязательные компоненты (показаны на рис. 1).
    Снимок экрана со страницей "Служба миграции хранилища", на которой отображается кнопка "установить"](media/migrate/install.png) **рис. 1. Установка службы миграции хранилища** ![
4. Установите прокси-сервер службы миграции хранилища на всех целевых серверах под Windows Server 2019. Это удваивает скорость передачи при установке на целевых серверах. <br>Для этого подключитесь к целевому серверу в центре администрирования Windows, а затем перейдите в **Диспетчер сервера** (в центре администрирования windows) > **роли и компоненты**, > **компоненты**, выберите **прокси-служба миграции хранилища**и нажмите кнопку **установить**. 
5. Если планируется переход на кластеры Windows Фаилвер или из него, установите средства отказоустойчивой кластеризации на сервере Orchestrator. <br>Для этого подключитесь к серверу Orchestrator в центре администрирования Windows, а затем перейдите в **Диспетчер сервера** (в центре администрирования windows) > **роли и компоненты**, > **компоненты**, > **средства удаленного администрирования сервера**, > **средства администрирования компонентов**, выберите **средства отказоустойчивой кластеризации**и нажмите кнопку **установить**. 
6. На всех исходных серверах и на целевых серверах под Windows Server 2012 R2 или Windows Server 2016 в центре администрирования Windows подключитесь к каждому серверу, перейдите в **Диспетчер сервера** (в центре администрирования windows) > **брандмауэр** > правила для **входящих**подключений, а затем убедитесь, что включены следующие правила.
    - Общий доступ к файлам и принтерам (входящий трафик SMB)
    - Служба Netlogon (NP-in)
    - Инструментарий управления Windows (WMI) (DCOM-in)
    - Инструментарий управления Windows (WMI-In)

   Если вы используете брандмауэры сторонних производителей, диапазоны входящих портов для открытия — это TCP/445 (SMB), TCP/135 (сопоставитель конечной точки RPC/DCOM) и TCP 1025-65535 (временные порты RPC/DCOM). Порты службы миграции хранилища — это TCP/28940 (Orchestrator) и TCP/28941 (прокси).

7. Если вы используете сервер Orchestrator для управления миграцией и хотите скачать события или журнал передаваемых данных, убедитесь, что на этом сервере включено правило брандмауэра для общего доступа к файлам и принтерам (SMB-in).

## <a name="step-1-create-a-job-and-inventory-your-servers-to-figure-out-what-to-migrate"></a>Шаг 1. Создание задания и Инвентаризация серверов для выяснения того, что нужно перенести

На этом шаге вы укажете, какие серверы нужно перенести, а затем проверите их, чтобы получить сведения о своих файлах и конфигурациях.

1. Выберите **создать задание**, укажите имя задания, а затем выберите, следует ли перенести серверы Windows и кластеры или серверы Linux, использующие Samba. Затем нажмите кнопку **ОК**.
2. На странице **Ввод учетных данных** введите учетные данные администратора, которые работают на серверах, с которых требуется выполнить миграцию, а затем нажмите кнопку **Далее**. <br>Если выполняется миграция с серверов Linux, вместо этого введите учетные данные на страницах учетных данных **Samba** и **учетных данных Linux** , включая пароль SSH или закрытый ключ. 

3. Выберите **Добавить устройство**, введите имя исходного сервера или имя кластеризованного файлового сервера, а затем нажмите кнопку **ОК**. <br>Повторите эти действия для всех серверов, для которых требуется выполнить инвентаризацию.

4. Выберите **начать сканирование**.<br>Страница обновляется для отображения после завершения проверки.
    Снимок экрана ![, показывающий сервер, готовый к сканированию](media/migrate/inventory.png) **рис. 2. Инвентаризация серверов**
5. Выберите каждый сервер, чтобы проверить общие папки, конфигурацию, сетевые адаптеры и тома, которые были внесены в опись. <br><br>Служба миграции хранилища не переносит файлы или папки, которые могут мешать работе Windows, поэтому в этом выпуске будут отображаться предупреждения для всех общих папок, расположенных в системной папке Windows. Эти общие ресурсы необходимо пропустить на этапе перемещения. Дополнительные сведения см. [в разделе какие файлы и папки исключаются из передачи](faq.md#what-files-and-folders-are-excluded-from-transfers).
6. Нажмите кнопку **Далее** , чтобы перейти к передаче данных.

## <a name="step-2-transfer-data-from-your-old-servers-to-the-destination-servers"></a>Шаг 2. Перенос данных со старых серверов на целевые серверы

На этом шаге вы перенесите данные после указания места размещения на целевых серверах.

1. На странице **Перемещение данных** > **введите учетные** данные введите учетные данные администратора, которые работают на целевых серверах, на которые требуется выполнить миграцию, а затем нажмите кнопку **Далее**.
2. На странице **Добавление целевого устройства и сопоставлений** отображается первый исходный сервер. Введите имя сервера или кластеризованного файлового сервера, на который требуется выполнить миграцию, а затем выберите **сканировать устройство**. При переходе с исходного компьютера, присоединенного к домену, целевой сервер должен быть присоединен к тому же домену. Вы также можете щелкнуть "создать новую виртуальную машину Azure", а затем с помощью мастера развернуть новый целевой сервер в Azure. Это приведет к автоматическому размеру виртуальной машины, подготовке хранилища, форматированию дисков, присоединению домена и добавлению прокси-сервера службы миграции хранилища в назначение Windows Server 2019. Вы можете выбрать один из виртуальных машин Windows Server 2019 (рекомендуется), Windows Server 2016 и Windows Server 2012 R2 любого размера и использовать управляемые диски.   

 > [!NOTE]
   > Для использования команды "создать виртуальную машину Azure" требуется:
   > - Допустимая подписка Azure.
   > - Существующая группа ресурсов вычислений Azure, в которой имеются права на создание.
   > - Существующая виртуальная сеть и подсеть Azure. 
   > - Решение Azure Express Route или VPN, привязанное к виртуальной сети и подсети, которые позволяют подключаться из этой виртуальной машины Azure IaaS к локальным клиентам, контроллерам домена, компьютеру Orchestrator службы миграции хранилища, компьютеру центра администрирования Windows, и исходный компьютер для переноса.

3. Сопоставьте исходные тома с томами назначения, снимите флажок **включить** для всех общих ресурсов, которые вы не хотите передавать (включая все административные общие папки, расположенные в системной папке Windows), а затем нажмите кнопку **Далее**.
   ![снимок экрана, показывающий исходный сервер и его тома и общие папки, а также место, куда они будут передаваться на целевом](media/migrate/transfer.png) **рис. 3. исходный сервер и место, куда будет перенесено хранилище.**
4. Добавьте целевой сервер и сопоставления для дополнительных исходных серверов, а затем нажмите кнопку **Далее**.
5. На странице **Настройка параметров переноса** укажите, следует ли перенести локальных пользователей и группы на исходные серверы, а затем нажмите кнопку **Далее**. Это позволяет повторно создать локальных пользователей и группы на целевых серверах, чтобы разрешения для файлов или общих ресурсов, настроенные для локальных пользователей и групп, не были потеряны. Ниже приведены варианты миграции локальных пользователей и групп.

    - **Переименование учетных записей с тем же именем** выбрано по умолчанию и переносит всех локальных пользователей и группы на исходном сервере. Если он находит локальных пользователей или группы с одинаковыми именами в источнике и назначении, он переименовывает их в целевом объекте, если они не являются встроенными (например, администратор и группа администраторов). Не используйте этот параметр, если исходный или целевой сервер является контроллером домена.
    - **Повторно использовать учетные записи с одинаковым именем** сопоставляют пользователей и группы в источнике и месте назначения. Не используйте этот параметр, если исходный или целевой сервер является контроллером домена.
    - **Не переносить пользователей и группы** пропускает миграцию локальных пользователей и групп, которые необходимы, если источником или назначением является контроллер домена или если заполнение данных для репликация DFS (репликация DFS не поддерживает локальные группы и пользователей).

   > [!NOTE]
   > Перенесенные учетные записи пользователей в назначении отключаются и им присваивается 127-символьный пароль, который является сложным и случайным, поэтому необходимо включить их и назначить новый пароль по окончании их использования. Это гарантирует, что все старые учетные записи с забытыми и ненадежными паролями в источнике не будут иметь проблем безопасности в назначении. Кроме того, для управления паролями локального администратора может потребоваться извлечь [решение "пароль локального администратора" (Lap)](https://www.microsoft.com/download/details.aspx?id=46899) .

6. Выберите **проверить** , а затем нажмите кнопку **Далее**.
7. Выберите **начать перемещение** , чтобы начать передачу данных.<br>При первом переносе все существующие файлы в папке назначения будут перемещены в папку резервного копирования. При последующих передачах по умолчанию мы будем обновлять назначение, не создавая сначала резервную копию. <br>Кроме того, служба миграции хранилища достаточно интеллектуальна для работы с перекрывающимися общими ресурсами — мы не будем копировать одни и те же папки дважды в одном задании.
8. После завершения передачи проверьте сервер назначения, чтобы убедиться, что все передано правильно. Выберите **журнал ошибок только** в том случае, если вы хотите скачать журнал всех файлов, которые не были переданы.

   > [!NOTE]
   > Если вы хотите сохранить журнал аудита или планируете выполнять несколько операций передачи в задании, щелкните **Журнал переноса** или другие параметры сохранения журнала, чтобы сохранить копию в формате CSV. При каждом последующем переносе перезаписываются сведения о базе данных предыдущего запуска. 

На этом этапе у вас есть три варианта:

- **Перейдите к следующему шагу**, обрезанием, чтобы целевые серверы применялись к идентификаторам исходных серверов.
- **Рассмотрим перенос завершенным,** не принимая во внимание удостоверения исходных серверов.
- **Снова перенесите**, копируя только те файлы, которые были обновлены с момента последнего перемещения.

Если ваша цель — синхронизировать файлы с Azure, можно настроить целевые серверы с Синхронизация файлов Azure после передачи файлов или после перехода на целевые серверы (см. раздел [Планирование развертывания Синхронизация файлов Azure](https://docs.microsoft.com/azure/storage/files/storage-sync-files-planning)).

## <a name="step-3-cut-over-to-the-new-servers"></a>Шаг 3. Вырезание на новые серверы

На этом шаге вы перейдете с исходных серверов на целевые серверы, переместив IP-адреса и имена компьютеров на целевые серверы. После завершения этого шага приложения и пользователи получают доступ к новым серверам с помощью имен и адресов серверов, которые были перенесены из.

1. Если вы перешли от задания миграции, в центре администрирования Windows перейдите в **диспетчер сервера** > **Служба миграции хранилища** , а затем выберите задание, которое требуется завершить.
2. На странице " **вырезание на новый сервер** > **Ввод учетных данных** " нажмите кнопку " **Далее** ", чтобы использовать введенные ранее учетные данные.

   Если целевым объектом является кластеризованный файловый сервер, может потребоваться предоставить учетные данные с разрешениями на удаление кластера из домена, а затем добавить его обратно с новым именем.

3. На странице **Настройка прямую миграцию** укажите, какой сетевой адаптер в назначении должен принимать параметры из каждого адаптера в источнике. При этом IP-адрес перемещается из источника в место назначения как часть прямую миграцию, предоставляя серверу-источнику новый протокол DHCP или статический IP-адрес. У вас есть возможность пропустить все сетевые миграции или определенные интерфейсы. 
4. Укажите, какой IP-адрес следует использовать для сервера-источника после того, как прямую миграцию переместит свой адрес в место назначения. Можно использовать DHCP или статический адрес. Если используется статический адрес, новая подсеть должна быть такой же, как и старая подсеть, иначе прямую миграцию завершится ошибкой.
    ![снимок экрана, показывающий исходный сервер, его IP-адреса и имена компьютеров и то, что они будут заменены после прямую миграцию](media/migrate/cutover.png) **рис. 4: исходный сервер и способ перемещения его конфигурации сети в место назначения** .
5. Укажите, как переименовать исходный сервер после того, как на целевом сервере будет достигнуто имя. Можно использовать произвольно созданное имя или тип. Затем нажмите кнопку **Далее**.
6. На странице **Настройка параметров прямую миграцию** нажмите кнопку **Далее** .
7. На странице **Проверка исходного и целевого устройства** выберите **проверить** , а затем нажмите кнопку **Далее**.
8. Когда вы будете готовы выполнить прямую миграцию, нажмите кнопку **запустить прямую миграцию**. <br>Пользователи и приложения могут столкнуться с прерыванием, когда адреса и имена перемещаются, а серверы перезапускаются несколько раз, но в противном случае миграция не затрагивается. Время выполнения прямую миграцию зависит от того, насколько быстро перезапускаются серверы, а также Active Directory и репликация DNS.

## <a name="see-also"></a>См. также статью

- [Обзор службы миграции хранилища](overview.md)
- [Часто задаваемые вопросы о службах миграции хранилища](faq.md)
- [Планирование развертывания Синхронизация файлов Azure](https://docs.microsoft.com/azure/storage/files/storage-sync-files-planning)
