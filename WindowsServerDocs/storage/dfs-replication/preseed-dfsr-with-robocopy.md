---
title: Используйте Robocopy, чтобы выполнить предзаполнение файлов для репликация DFS
description: Использование программы Robocopy. exe для предустановки начального значения файлов для репликация DFS.
ms.prod: windows-server
ms.topic: article
author: JasonGerend
ms.author: jgerend
ms.technology: storage
ms.date: 05/18/2018
ms.localizationpriority: medium
ms.openlocfilehash: ea5cd954dde6d4fa8fcaa7874f75cb9588115ab1
ms.sourcegitcommit: 6aff3d88ff22ea141a6ea6572a5ad8dd6321f199
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/27/2019
ms.locfileid: "71402126"
---
# <a name="use-robocopy-to-preseed-files-for-dfs-replication"></a>Используйте Robocopy, чтобы выполнить предзаполнение файлов для репликация DFS

>Относится к: Windows Server 2016, Windows Server 2012 R2, Windows Server 2012, Windows Server 2008 R2, Windows Server 2008

В этом разделе объясняется, как использовать программу командной строки **Robocopy. exe**для предварительного заполнения файлов при настройке репликации для репликации распределенная ФАЙЛОВАЯ система (DFS) (также известной как DFSR или DFS-R) в Windows Server. Предварительное заполнение файлов перед настройкой репликация DFS, добавлении нового партнера по репликации или замене сервера позволяет ускорить начальную синхронизацию и включить клонирование базы данных репликация DFS в Windows Server 2012 R2. Метод Robocopy является одним из нескольких методов предзаполнения. Общие сведения см. в разделе [Шаг 1. Заполнение файлов для репликация DFS](<https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/dn495046(v%3dws.11)>).

Программа командной строки Robocopy (надежная копия файлов) входит в состав Windows Server. Программа предоставляет широкие возможности, включая копирование безопасности, поддержку API резервного копирования, возможности повтора и ведение журнала. Более поздние версии включают поддержку многопоточности и без буферизации ввода-вывода.

>[!IMPORTANT]
>Средство Robocopy не копирует монопольно заблокированные файлы. Если пользователи предпочитают блокировать много файлов в течение длительных периодов на файловых серверах, рассмотрите возможность использования другого метода предзаполнения. Предварительное заполнение не требует идеального соответствия между списками файлов на исходном и целевом серверах, но чем больше файлов не существует при начальной синхронизации для репликация DFS, тем менее эффективным является предварительное заполнение. Чтобы избежать конфликтов блокировок, используйте Robocopy в нерабочее время для вашей организации. Всегда изучите журналы Robocopy после создания начального значения, чтобы понять, какие файлы были пропущены из-за монопольных блокировок.

Чтобы использовать Robocopy для репликация DFS в качестве начального значения для файлов, выполните следующие действия.

1. [Скачайте и установите последнюю версию средства Robocopy.](#step-1-download-and-install-the-latest-version-of-robocopy)
2. [Стабилизация файлов, которые будут реплицированы.](#step-2-stabilize-files-that-will-be-replicated)
3. [Скопируйте реплицированные файлы на целевой сервер.](#step-3-copy-the-replicated-files-to-the-destination-server)

## <a name="prerequisites"></a>Предварительные требования

Поскольку предварительное заполнение не подразумевает прямой репликация DFS, необходимо выполнить только требования к копированию файлов с помощью средства Robocopy.

- Вам потребуется учетная запись, которая является членом локальной группы администраторов на исходном и целевом серверах.

- Установите последнюю версию средства Robocopy на сервере, который будет использоваться для копирования файлов — либо исходного сервера, либо целевого сервера. необходимо установить самую последнюю версию для версии операционной системы. Инструкции см. в [разделе Шаг 2. Стабилизация файлов, которые будут реплицированы](#step-2-stabilize-files-that-will-be-replicated). Если вы не выполняете начальное заполнение файлов с сервера под управлением Windows Server 2003 R2, можно запустить Robocopy на исходном или целевом сервере. На целевом сервере, который обычно имеет более позднюю версию операционной системы, предоставляется доступ к самой последней версии средства Robocopy.

- Убедитесь, что на целевом диске достаточно места для хранения. Не создавайте папку по пути, в который планируется копировать: Средство Robocopy должно создать корневую папку.
    
    >[!NOTE]
    >При принятии решения о том, сколько места нужно выделить для предварительно заполненных файлов, учитывайте ожидаемый рост данных по времени и требованиям к хранилищу для репликация DFS. Сведения о планировании см. в статье [изменение размера квоты промежуточной папки и папки конфликтов и удалений](https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/cc754229(v=ws.11)) в разделе [Управление репликация DFS](<https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/cc754771(v=ws.11)>).

- На исходном сервере при необходимости установите монитор процессов или обозреватель процессов, который можно использовать для проверки приложений, блокирующих файлы. Сведения о загрузке см. в разделе [Process Monitor](https://docs.microsoft.com/sysinternals/downloads/procmon) и [Process Explorer](https://docs.microsoft.com/sysinternals/downloads/process-explorer).

## <a name="step-1-download-and-install-the-latest-version-of-robocopy"></a>Шаг 1. Скачивание и установка последней версии средства Robocopy

Прежде чем использовать Robocopy для предварительного заполнения файлов, необходимо скачать и установить последнюю версию файла **Robocopy. exe**. Это гарантирует, что репликация DFS не пропустит файлы из-за проблем в версиях отгрузки средства Robocopy.

Источник последней совместимой версии средства Robocopy зависит от версии Windows Server, которая работает на сервере. Сведения о загрузке исправления с последней версией средства Robocopy для Windows Server 2008 R2 или Windows Server 2008 см. [в статье список доступных исправлений для технологий распределенная файловая система (DFS) в Windows server 2008 и в Windows Server 2008 R2](https://support.microsoft.com/help/968429/list-of-currently-available-hotfixes-for-distributed-file-system-dfs-t).

Кроме того, можно выбрать и установить последнее исправление для операционной системы, выполнив следующие действия.

### <a name="locate-and-install-the-latest-version-of-robocopy-for-a-specific-version-of-windows-server"></a>Поиск и установка последней версии средства Robocopy для конкретной версии Windows Server

1. В веб-браузере откройте [https://support.microsoft.com](https://support.microsoft.com/).

2. В поле **Поддержка поиска**введите следующую строку, заменив `<operating system version>` соответствующими данными операционной системы, а затем нажмите клавишу ВВОД:
    
    ```robocopy.exe kbqfe "<operating system version>"```
    
    Например, введите **Robocopy. exe кбкфе "Windows Server 2008 R2"** .

3. Нахождение и скачивание исправления с наибольшим ИДЕНТИФИКАТОРом (то есть последней версией).

4. Установите исправление на сервере.

## <a name="step-2-stabilize-files-that-will-be-replicated"></a>Шаг 2. Стабилизация файлов, которые будут реплицированы

После установки на сервере последней версии средства Robocopy не следует блокировать копирование заблокированных файлов с помощью методов, описанных в следующей таблице. Большинство приложений не заблокировали монопольную блокировку файлов. Однако во время нормальной работы на файловых серверах может быть заблокирован небольшой процент файлов.

|Источник блокировки|Объяснение|Решение|
|---|---|---|
|Пользователи смогут удаленно открывать файлы на общих ресурсах.|Сотрудники подключаются к стандартному файловому серверу и редактируют документы, мультимедийное содержимое или другие файлы. Иногда называется традиционной домашней папкой или общими рабочими нагрузками данных.|Выполнять операции Robocopy только в нерабочее время. Это позволяет сокращать количество файлов, которые средство Robocopy должно пропустить во время начального заполнения.<br><br>Рекомендуется временно установить доступ только для чтения к общим файловым ресурсам, которые будут реплицироваться с помощью командлетов Windows PowerShell **Grant-смбшареакцесс** и **Close-смбсессион** . Если вы настроили разрешения для общей группы, например для всех пользователей или прошедших проверку подлинности, обычные пользователи могут быть менее открытыми файлами с монопольными блокировками (если их приложения обнаруживают доступ только для чтения при открытии файлов).<br><br>Вы также можете настроить временное правило брандмауэра для порта SMB 445, входящего на этот сервер, чтобы заблокировать доступ к файлам или использовать командлет **Block-смбшареакцесс** . Однако оба эти метода очень нарушают работу пользователей.|
|Приложения открывают файлы локально.|Рабочие нагрузки приложений, выполняющиеся на файловом сервере, иногда заблокируют файлы.|Временно отключите или удалите приложения, блокирующие файлы. Для определения приложений, блокирующих файлы, можно использовать монитор процессов или обозреватель процессов. Чтобы скачать монитор процессов или обозреватель процессов, посетите страницу " [Монитор процессов](https://docs.microsoft.com/sysinternals/downloads/procmon) " и [Обозреватель процессов](https://docs.microsoft.com/sysinternals/downloads/process-explorer) .|

## <a name="step-3-copy-the-replicated-files-to-the-destination-server"></a>Шаг 3. Копирование реплицированных файлов на целевой сервер

После сворачивания блокировок файлов, которые будут реплицированы, можно выполнить начальное заполнение файлов с исходного сервера на целевой сервер.

>[!NOTE]
>Средство Robocopy можно запустить на исходном или конечном компьютере. Следующая процедура описывает запуск Robocopy на целевом сервере, который обычно работает под управлением более поздней операционной системы, чтобы воспользоваться всеми дополнительными возможностями средства Robocopy, которые может предоставить более поздняя операционная система.

### <a name="preseed-the-replicated-files-onto-the-destination-server-with-robocopy"></a>Начальное заполнение реплицированных файлов на целевой сервер с помощью средства Robocopy

1. Войдите на целевой сервер с учетной записью, которая является членом локальной группы администраторов на исходном и целевом серверах.

2. Откройте командную строку с повышенными привилегиями.

3. Чтобы выполнить начальное заполнение файлов с исходного на целевой сервер, выполните следующую команду, подставив собственные пути к источнику, месту назначения и файлам журнала для значений в квадратных скобках:
    
    ```PowerShell
    robocopy "<source replicated folder path>" "<destination replicated folder path>" /e /b /copyall /r:6 /w:5 /MT:64 /xd DfsrPrivate /tee /log:<log file path> /v
    ```
    
    Эта команда копирует все содержимое исходной папки в целевую папку со следующими параметрами:
    
    |Параметр|Описание|
    |---|---|
    |"\<исходный путь к\>реплицированной папке"|Указывает исходную папку для начального заполнения на целевом сервере.|
    |"\<путь к\>целевой реплицированной папке"|Указывает путь к папке, в которой будут храниться файлы с начальным заполнением.<br><br>Целевая папка не должна быть создана на целевом сервере. Чтобы получить соответствующие хэши файлов, средство Robocopy должно создать корневую папку при предустановке файлов.|
    |/e|Копирует подкаталоги и их файлы, а также пустые подкаталоги.|
    |b|Копирует файлы в режиме резервного копирования.|
    |/копялл|Копирует все сведения о файле, включая данные, атрибуты, метки времени, список управления доступом (ACL) NTFS, сведения о владельце и сведения об аудите.|
    |/r: 6|Повторяет операцию в шесть раз при возникновении ошибки.|
    |/w: 5|Ожидает 5 секунд между повторными попытками.|
    |MT: 64|Одновременно копирует файлы 64.|
    |/КСД Дфсрпривате|Исключает папку Дфсрпривате.|
    |/ти|Записывает выходные данные состояния в окно консоли, а также в файл журнала.|
    |путь \<к файлу журнала/Log >|Указывает файл журнала для записи. Перезаписывает существующее содержимое файла. (Чтобы добавить записи в существующий файл журнала, используйте `/log+ <log file path>`.)|
    |/v|Создает подробный вывод, включающий пропущенные файлы.|
    
    Например, следующая команда реплицирует файлы из исходной реплицированной папки с адресом E:\\RF01 на диск данных D на целевом сервере:
    
    ```PowerShell
    robocopy.exe "\\srv01\e$\rf01" "d:\rf01" /e /b /copyall /r:6 /w:5 /MT:64 /xd DfsrPrivate /tee /log:c:\temp\preseedsrv02.log
    ```
    
    >[!NOTE]
    >Рекомендуется использовать параметры, описанные выше, при использовании средства Robocopy для предзаполнения файлов для репликация DFS. Однако некоторые из их значений можно изменить или добавить дополнительные параметры. Например, вы можете узнать о том, что у вас есть возможность задать большее значение (число потоков) для параметра */MT* . Кроме того, если вы в основном реплицируете файлы большего размера, можно увеличить производительность копирования, добавив параметр **/j** для операций ввода-вывода без буферизации. Дополнительные сведения о параметрах Robocopy см. в справочнике по командной строке [Robocopy](https://docs.microsoft.com/windows-server/administration/windows-commands/robocopy) .

    >[!WARNING]
    >Чтобы избежать возможной потери данных при использовании средства Robocopy для уточнения файлов для репликация DFS, не вносите в Рекомендуемые параметры следующие изменения:
    >- Не используйте параметр */мир* (который отражает дерево каталогов) или параметр */МОВ* (который перемещает файлы, а затем удаляет их из источника).
    >-  Не удаляйте параметры **/e**, **/b**и **/копялл** .

4. После завершения копирования проверьте журнал на наличие ошибок или пропущенных файлов. Используйте Robocopy, чтобы скопировать пропущенные файлы по отдельности вместо копирования всего набора файлов. Если файлы были пропущены из-за монопольных блокировок, либо попробуйте скопировать отдельные файлы с помощью Robocopy позже, либо оставьте так, чтобы эти файлы потребовали репликации по сети, репликация DFS во время начальной синхронизации.

## <a name="next-step"></a>Дальнейшие действия

После завершения начальной копии и использования средства Robocopy для разрешения проблем с максимально возможным количеством пропущенных файлов используйте командлет **Get-дфсрфилехаш** в Windows PowerShell или команду **Dfsrdiag** для проверки предварительно заполненных файлов путем сравнения хэши файлов на исходном и целевом серверах. Подробные инструкции см. в [разделе Шаг 2. Проверка предварительно заполненных файлов для](<https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/dn495042(v%3dws.11)>)репликация DFS.
