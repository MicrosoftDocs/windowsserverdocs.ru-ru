---
title: Использование средства Robocopy для preseed файлов для репликации DFS
description: Как использовать Robocopy.exe для preseed файлов для репликации DFS.
ms.prod: windows-server-threshold
ms.topic: article
author: JasonGerend
ms.author: jgerend
ms.technology: storage
ms.date: 05/18/2018
ms.localizationpriority: medium
ms.openlocfilehash: a7a14b1a1e0f91002b201869e4c68187ffaf3f8f
ms.sourcegitcommit: e0479b0114eac7f232e8b1e45eeede96ccd72b26
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/22/2018
ms.locfileid: "2082575"
---
# <a name="use-robocopy-to-preseed-files-for-dfs-replication"></a>Использование средства Robocopy для preseed файлов для репликации DFS

>Область применения: Windows Server 2016, Windows Server 2012 R2, Windows Server 2012, Windows Server 2008 R2, Windows Server 2008

В этом разделе объясняется, как использовать средство командной строки, **Robocopy.exe**для preseed файлов при настройке репликации для репликации распределенной файловой системы (DFS) (также известной как DFSR или DFS-R) в Windows Server. По preseeding файлы, прежде чем настраивать репликации DFS, добавьте новый партнер репликации или замените сервера, можно ускорить первоначальной синхронизации и включить клонирования базы данных репликации DFS в Windows Server 2012 R2. Метод Robocopy — это один из следующих способов preseeding; Общие сведения, в разделе [Шаг 1: preseed файлы для репликации DFS](<https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/dn495046(v%3dws.11)>).

Служебная программа командной строки Robocopy (надежную копирование файлов) входит в состав Windows Server. Служебная программа предоставляет расширенные возможности, включая копирование безопасности, резервного копирования API поддержки, возможности повтора и ведения журнала. Более поздние версии поддерживают многопоточные вычисления и Отмена буфер ввода-вывода.

>[!IMPORTANT]
>Robocopy не копирует исключительно заблокированные файлы. Если пользователи часто заблокировать много файлов для длительных периодов на серверах, рекомендуется использовать другой метод preseeding. Preseeding не требует точности совпадающие между списками файл на исходном и целевом серверах, но — это дополнительные файлы, не существует, при выполнении начальной синхронизации для репликации DFS, менее эффективно preseeding. Чтобы свести к минимуму конфликты блокировки, используйте Robocopy в часы наименьшей для вашей организации. Всегда Проверьте журналы Robocopy после preseeding, чтобы убедиться, что вы понимаете, какие файлы были пропущены из-за монопольной блокировки.

Использование средства Robocopy для preseed файлов для репликации DFS, выполните следующие действия:

1. [Загрузите и установите последнюю версию Robocopy.](#step-1:-download-and-install-the-latest-version-of-robocopy)
2. [Стабилизируйте файлы, которые будут реплицированы.](#step-2:-stabilize-files-that-will-be-replicated)
3. [Скопируйте файлы реплицированной на целевой сервер.](#step-3:-copy-the-replicated-files-to-the-destination-server)

## <a name="prerequisites"></a>Необходимые условия

Так как preseeding не связанных напрямую репликации DFS, необходимо только требованиям для копирования файлов с Robocopy для выполнения.

- Требуется учетная запись должна быть членом локальной группы администраторов на исходном и целевом серверах.

- Установка последней версии Robocopy на сервере, который будет использоваться для копирования файлов — на исходном сервере или на целевой сервер; необходимо установить наиболее поздней версии для версии операционной системы. Сведения содержатся в разделе [Шаг 2: стабилизировать файлы, которые будут реплицированы в](#step-2:-stabilize-files-that-will-be-replicated). Если не preseeding файлы с сервера под управлением Windows Server 2003 R2, можно запустить Robocopy на сервере источника или назначения. На целевой сервер, который обычно имеет более поздней версии операционной системы, предоставляет доступ к наиболее поздней версии Robocopy.

- Убедитесь, что достаточно места на диске назначения. Не создавать папки по пути, который планируется скопируйте: Robocopy необходимо создать в корневой папке.
    
    >[!NOTE]
    >При вам решить, какой объем дискового пространства, выделяемого для preseeded файлов, примите во внимание ожидаемые данные роста требования к времени и хранилища для репликации DFS. Планирование справки, в разделе [Изменение размера квот промежуточной папки и папки конфликтов и удалены](https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/cc754229(v=ws.11)) в [Управлении репликации DFS](<https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/cc754771(v=ws.11)>).

- На исходном сервере при необходимости установите монитор процессов или проводника процесс, который можно использовать для проверки для приложений, блокирующих файлы. Сведения о загрузке [Монитор процессов](https://docs.microsoft.com/sysinternals/downloads/procmon) и [Process Explorer](https://docs.microsoft.com/sysinternals/downloads/process-explorer)см.

## <a name="step-1-download-and-install-the-latest-version-of-robocopy"></a>Шаг 1: Загрузите и установите последнюю версию Robocopy

Перед preseed файлы с помощью Robocopy необходимости загрузить и установить последнюю версию **Robocopy.exe**. Это гарантирует, что репликация DFS не пропустить файлы из-за проблем в рамках версий доставки Robocopy абонента.

Источник последней версии совместимого Robocopy зависит от версии Windows Server, на котором работает на сервере. Сведения о загрузке исправления с последней версией Robocopy для Windows Server 2008 R2 или Windows Server 2008 в разделе [списка в настоящее время недоступен исправления для технологий распределенной файловой системы (DFS) в Windows Server 2008 и в Windows Server 2008 R2](https://support.microsoft.com/help/968429/list-of-currently-available-hotfixes-for-distributed-file-system-dfs-t).

Кроме того позволяющее найти и установите последние исправления для операционной системы, выполните следующие действия.

### <a name="locate-and-install-the-latest-version-of-robocopy-for-a-specific-version-of-windows-server"></a>Найдите и установите последнюю версию Robocopy для определенной версии Windows Server

1. Откройте в веб-браузере [https://support.microsoft.com](https://support.microsoft.com/).

2. **Поддержка поиска**, введите следующую команду Строка, заменив `<operating system version>` с соответствующую операционную систему, затем нажмите клавишу ВВОД:
    
    ```robocopy.exe kbqfe "<operating system version>"```
    
    Например введите **robocopy.exe kbqfe «Windows Server 2008 R2»**.

3. Найдите и загрузите исправление с наибольшим числом ID (то есть последней версии).

4. Установка исправления на сервере.

## <a name="step-2-stabilize-files-that-will-be-replicated"></a>Шаг 2: Стабилизируйте файлы, которые будут реплицированы

После установки последней версии Robocopy на сервере, следует запретить заблокированные файлы из блокировки копирование с помощью методов, описанных в следующей таблице. Большинство приложений не только блокировать файлы. Тем не менее во время обычной работы, а небольшая часть файлов заблокирован на файловых серверах.

|Источник блокировки|Объяснение|Упреждающая мера|
|---|---|---|
|Пользователи удаленно открывать файлы в общих папках.|Сотрудники подключиться к серверу standard файл и редактировать документы, мультимедийного содержимого и другие файлы. Иногда называется традиционных домашнюю папку или рабочих нагрузок общих данных.|Только выполнение операций Robocopy во время наименьшей нагрузки, нерабочее время. Это уменьшает число файлов, которые необходимо пропустить Robocopy во время preseeding.<br><br>Рассмотрите возможность временно установки доступ только для чтения в общих папках, которые будут реплицированы с помощью командлетов Windows PowerShell **Grant-SmbShareAccess** и **SmbSession закрыть** . Если установить разрешения для общей группы, например всех пользователей или пользователей, прошедших проверку на чтение, стандартный пользователи могут быть скорее всего, при открытии файлов с монопольной блокировки (если свои приложения определяет доступ только для чтения, при открытии файлов).<br><br>Можно также принять правило временные брандмауэра для SMB-порт 445 входящий трафик на этот сервер для блокировки доступа к файлам или с помощью командлета **SmbShareAccess блокировки** . Тем не менее оба этих метода, очень нарушает пользователями операций.|
|Приложения открывать файлы локального.|Приложения рабочих нагрузок, запущенные на сервере файла, в некоторых случаях блокировать файлы.|Временно отключить или удалить приложений, блокирующих файлы. Монитор процессов или Process Explorer можно использовать для определения приложения, которые блокируются файлы. Чтобы загрузить монитор процессов или Process Explorer, посетите страницы [Монитор процессов](https://docs.microsoft.com/sysinternals/downloads/procmon) и [Process Explorer](https://docs.microsoft.com/sysinternals/downloads/process-explorer) .|

## <a name="step-3-copy-the-replicated-files-to-the-destination-server"></a>Шаг 3: Копирование реплицируемых файлов на целевой сервер

После минимизировать блокировки файлов, которые будут реплицированы, можно preseed файлы с исходного сервера на целевой сервер.

>[!NOTE]
>Robocopy можно запустить на исходном компьютере или на конечном компьютере. В следующей процедуре описывается выполнение Robocopy на целевом сервере, который обычно выполняется более новой операционной системы, чтобы воспользоваться преимуществами любые дополнительные возможности Robocopy, которые может предоставить более новой операционной системы.

### <a name="preseed-the-replicated-files-onto-the-destination-server-with-robocopy"></a>Preseed реплицированной файлы на целевом сервере с помощью средства Robocopy

1. Войдите на целевой сервер с использованием учетной записи, которая является членом локальной группы администраторов на исходном и целевом серверах.

2. Откройте командную строку с повышенными привилегиями.

3. Чтобы preseed файлы из исходного на целевой сервер, выполните следующую команду, подставив свои собственные источника, назначения и пути к файлам журнала для квадратных скобках значений:
    
    ```PowerShell
    robocopy "<source replicated folder path>" "<destination replicated folder path>" /e /b /copyall /r:6 /w:5 /MT:64 /xd DfsrPrivate /tee /log:<log file path> /v
    ```
    
    Эта команда копирует все содержимое исходной папки в папке назначения, используя следующие параметры:
    
    |Параметр|Описание|
    |---|---|
    |«\ < источника path\ реплицированной папки >»|Указывает папку источника для preseed на целевом сервере.|
    |«\ < назначения реплицировать path\ папки >»|Указывает путь к папке, где будут храниться файлы preseeded.<br><br>Папка назначения не должен существовать на целевом сервере. Чтобы получить соответствия хэши файлов, Robocopy необходимо создать в корневой папке preseeds файлы.|
    |/e|Копирует вложенные папки и их файлы, а также пустые подкаталоги.|
    |/b|Копирование файлов в режиме резервного копирования.|
    |аудио- и copyal|Копирует все сведения о файле, включая данные, атрибутов, отметки времени, NTFS список управления доступом (ACL), сведения о владельце и аудит сведения.|
    |/r:6|Число повторов операции шести раз, когда возникает ошибка.|
    |/w:5|Ожидает 5 секунд между повторными попытками.|
    |MT:64|Копирует файлы 64 одновременно.|
    |/XD DfsrPrivate|Исключает папку DfsrPrivate.|
    |/TEE|Записывает выходные данные состояния в окне консоли, а также к файлу журнала.|
    |/ log \ < путь к файлу журнала >|Указывает файл журнала для записи. Перезапись существующих содержимое файла. (Для добавления записей в существующий файл журнала, используйте `/log+ <log file path>`.)|
    |/v|Создает verbose выходные данные, который включает в себя пропущенных файлов.|
    
    К примеру следующую команду реплицирует файлы из папки источника реплицировать E:\\RF01, данных диск D на целевом сервере:
    
    ```PowerShell
    robocopy.exe "\\srv01\e$\rf01" "d:\rf01" /e /b /copyall /r:6 /w:5 /MT:64 /xd DfsrPrivate /tee /log:c:\temp\preseedsrv02.log
    ```
    
    >[!NOTE]
    >Мы рекомендуем использовать параметров, описанных выше, при использовании Robocopy для preseed файлов для репликации DFS. Тем не менее можно изменить некоторые их значения или добавить дополнительные параметры. Например могут оказаться в работе по тестированию, что у вас есть емкости для задания для параметра */MT* выше значения (число потоков). Кроме того Если будет в основном реплицировать большие файлы, можно увеличить производительность копирования, добавив параметр **/j** для небуферизованных операций ввода-вывода. Дополнительные сведения о параметрах Robocopy [Robocopy](https://docs.microsoft.com/windows-server/administration/windows-commands/robocopy) командной строки см.

    >[!WARNING]
    >Чтобы избежать потери данных при использовании Robocopy для preseed файлов для репликации DFS, не внести следующие изменения в рекомендуемые параметры:
    >- Не используйте *параметр/MIR* (, отражающую дерева каталога) или параметр */mov* (, который перемещает эти файлы, а затем удаляет их из источника).
    >-  Не удаляйте параметры **/e** **/b** **и/COPYALL** .

4. После завершения копирования, проверьте журнал на наличие ошибок и пропущенных файлов. Использование средства Robocopy для копирования все пропущенные файлы по отдельности, а не recopying весь набор файлов. Если файлы были пропущены из-за монопольной блокировки, скопируйте отдельные файлы с Robocopy более поздней версии или примите, что эти файлы потребует по сети репликации при репликации DFS во время начальной синхронизации.

## <a name="next-step"></a>Следующий шаг

После выполнения начальной копировать и использовать Robocopy для устранения проблем с столько пропущенных файлов по мере возможности, командлет **Get-DfsrFileHash** в Windows PowerShell или с помощью команды **Dfsrdiag** будет использоваться для проверки preseeded файлов путем сравнения хэши файлов на исходном и целевом серверах. Подробные сведения содержатся в разделе [Шаг 2: проверка Preseeded файлов для репликации DFS](<https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/dn495042(v%3dws.11)>).