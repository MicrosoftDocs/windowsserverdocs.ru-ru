---
ms.assetid: 5ab76733-804d-4f30-bee6-cb672ad5075a
title: Устранение неполадок развертывания контроллера домена
author: iainfoulds
ms.author: iainfou
manager: daveba
ms.date: 03/20/2019
ms.topic: article
ms.openlocfilehash: 8c850a9a09af97d9aa377b79aaa87d06aa0d916c
ms.sourcegitcommit: 1dc35d221eff7f079d9209d92f14fb630f955bca
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/26/2020
ms.locfileid: "88940614"
---
# <a name="troubleshooting-domain-controller-deployment"></a>Устранение неполадок развертывания контроллера домена

>Область применения. Windows Server 2016

В этом разделе подробно рассматривается методика устранения неполадок, связанных с конфигурацией и развертыванием контроллеров доменов.

## <a name="introduction-to-troubleshooting"></a>Общие сведения об устранении неполадок

![Устранение неполадок](media/Troubleshooting-Domain-Controller-Deployment/adds_deploy_troubleshooting.png)

## <a name="built-in-logs-for-troubleshooting"></a>Встроенные журналы для устранения неполадок

Встроенные журналы — это самый важный инструмент устранения неполадок, связанных с повышением и понижением роли контроллеров домена. По умолчанию все эти журналы включены и для них настроена максимальная степень подробности.

| Этап | Журнал |
|--|--|
| Операции с диспетчером сервера или модулем ADDSDeployment Windows PowerShell | -%системрут%\дебуг\дкпромауи.лог<p>-%системрут%\дебуг\дкпромауи *. log |
| Установка или повышение роли контроллера домена | -%системрут%\дебуг\дкпромо.лог<p>-%системрут%\дебуг\дкпромо *. log<p>-Event Виевер\виндовс Логс\систем<p>-Event Виевер\виндовс Логс\аппликатион<p>-Event Viewer\applications and and Services Логс\директори Service<p>-Event Viewer\applications and and службы репликации Логс\филе<p>-Viewer\applications and событий и службы репликация Логс\дфс |
| Обновление леса или домена | -%системрут%\дебуг\адпреп \\ <datetime> \адпреп.лог<p>-%системрут%\дебуг\адпреп \\ <datetime> \ксв.лог<p>-%системрут%\дебуг\адпреп \\ <datetime> \дспекуп.лог<p>-%системрут%\дебуг\адпреп \\ <datetime> \лдиф.лог * |
| Модуль развертывания диспетчера сервера или ADDSDeployment Windows PowerShell | -Viewer\applications and событий и службы Логс\микрософт\виндовс\директорисервицес-деплоймент\оператионал |
| Windows Servicing | -%Системрут%\логс\кбс\\*<p>-% SystemRoot% \servicing\sessions\sessions.xml<p>-%системрут%\винсксс\покексек.лог<p>-% SystemRoot% \winsxs\pending.xml |

### <a name="tools-and-commands-for-troubleshooting-domain-controller-configuration"></a>Средства и команды для диагностики конфигурации контроллера домена

Чтобы диагностировать не поясненные в журналах проблемы, используйте следующие средства в качестве отправной точки:

-   Dcdiag.exe

-   Repadmin.exe

-   [AutoRuns.exe](/sysinternals/downloads/autoruns), диспетчер задач и MSInfo32.exe

-   [Network Monitor 3.4](https://www.microsoft.com/download/en/details.aspx?displaylang=en&id=4865) (или средство отслеживания и анализа сети сторонних производителей)

### <a name="general-methodology-for-troubleshooting-domain-controller-configuration"></a>Общая методика устранения неполадок, связанных с конфигурацией контроллеров домена

1.  Вызвала ли ошибку простая неточность в синтаксисе?

    1.  Не допустили ли вы ошибку в написании аргумента ADDSDeployment Windows PowerShell или не забыли ли вы указать его? Например, если вы используете модуль ADDSDeployment Windows PowerShell, возможно, вы забыли добавить обязательный аргумент **-domainname** с допустимым именем.

    2.  Тщательно изучите выходные данные в консоли Windows PowerShell, чтобы выяснить, почему не удается разобрать введенную команду.

2.  Связана ли ошибка с невыполнением необходимых условий?

    1.  Многие неустранимые ошибки повышения роли теперь предотвращаются средством проверки необходимых условий.

    2.  Тщательно изучите сообщения об ошибках, связанных с невыполнением необходимых условий, так как в них приводятся необходимые инструкции по устранению большинства проблем, являющихся контролируемыми сценариями.

3.  Связана ли ошибка с повышением роли и поэтому является неустранимой?

    1.  Тщательно изучите результаты: многие ошибки объясняются просто, например неправильными паролями, проблемами с разрешением сетевых имен или отключением критически важных контроллеров домена.

    2.  Проверьте журналы Dcpromoui.log и dcpromo.log на наличие ошибок, указанных в выходных данных, и, отталкиваясь от них, попытайтесь найти указания на то, почему произошел сбой.

        1.  Всегда выполняйте сравнение с рабочим журналом.

        2.  Обратитесь к журналам ADPrep, если в результатах указана проблема, связанная с расширением схемы или подготовкой леса или домена.

        3.  Обратитесь к журналу событий DirectoryServices-Deployment, если в журнале Dcpromoui.log отсутствуют подробные сведения или он внезапно прерывается из-за необработанного исключения в процессе настройки.

    3.  Изучите журналы "Служба каталогов", "Система" и "Приложение", чтобы найти другие указания на причины проблемы с конфигурацией. Зачастую проблемы с повышением роли контроллера домена — это симптом других ошибок в конфигурации сети, которые могут влиять на все распределенные системы.

    4.  Воспользуйтесь средствами dcdiag.exe и repadmin.exe, чтобы проверить общую работоспособность леса и выявить неявные ошибки в конфигурации, которые могут препятствовать повышению роли контроллеров домена в дальнейшем.

    5.  Воспользуйтесь программами AutoRuns.exe, MSinfo32.exe или диспетчером задач, чтобы проверить компьютер на наличие стороннего программного обеспечения, которое может мешать работе.

        1.  Удалите стороннее программное обеспечение (просто отключить его недостаточно, так как драйверы продолжат загружаться).

    6.  Установите сетевой монитор версии 3.4 на компьютере, на котором не удается повысить роль контроллера домена, являющегося партнером репликации, и проанализируйте процесс повышения роли с помощью записей двухстороннего сетевого мониторинга.

        1.  Сравните эти данные с результатами, полученными в лабораторной среде, чтобы понять, как должно выполняться успешное повышение роли и где происходит сбой.

        2.  На этом этапе ошибки, скорее всего, связаны с объектами леса, нестандартными изменениями системы безопасности или сетью, а сбои нового контроллера домена вызваны ошибками в конфигурации DNS, брандмауэров, программного обеспечения для предотвращения вторжений в узлы или иными внешними факторами.

## <a name="troubleshooting-events-and-error-messages"></a>Устранение неполадок событий и сообщений об ошибках

Когда операция повышения или понижения роли контроллера домена завершается, всегда возвращается код, который, в отличие от других операций, не равен нулю в случае успешного выполнения. Узнать код результата настройки контроллера домена можно несколькими способами.

1. При использовании диспетчера сервера изучите результат повышения роли, который отображается десять секунд перед автоматической перезагрузкой.

2. При использовании модуля ADDSDeployment Windows PowerShell изучите результат повышения роли, который отображается десять секунд перед автоматической перезагрузкой. Кроме того, можно отключить автоматическую перезагрузку по завершении операции. Чтобы сделать выходные данные более удобными для восприятия, следует добавить конвейер **Format-List**. Например:

   ```
   Install-addsdomaincontroller <options> -norebootoncompletion:$true | format-list
   ```

   Если при проверке необходимых условий были выявлены ошибки, перезагрузка не производится, так что эти ошибки видны в любом случае. Например:

   ![Устранение неполадок](media/Troubleshooting-Domain-Controller-Deployment/ADDS_PSPrereqError.png)

3. В любом сценарии изучите журналы dcpromo.log и dcpromoui.log.

   > [!NOTE]
   > Некоторые из перечисленных ниже ошибок больше не возможны из-за изменений в более поздних операционных системах и конфигурации контроллеров домена. Новые коды ADDSDeployment Windows PowerShell также предотвращают возникновение некоторых ошибок, в отличие от команды dcpromo.exe /unattend. Это еще одна убедительная причина для перехода с устаревшего средства DCPromo на модуль ADDSDeployment Windows PowerShell с целью обеспечения автоматизации.

### <a name="promotion-and-demotion-success-codes"></a>Коды успешного продвижения и понижения уровня

| Код ошибки | Пояснение | Примечание |
|--|--|--|
| 1 | Выход, успешное выполнение | Указывает на то, что флаг автоматической перезагрузки был снят; перезагрузку тем не менее выполнить необходимо |
| 2 | Выход, успешное выполнение, необходимо выполнить перезагрузку |  |
| 3 | Выход, успешное выполнение с некритическим сбоем | Обычно появляется при получении предупреждения о делегировании DNS. Если делегирование DNS не настраивается, используйте следующий атрибут:<p>-creatednsdelegation:$false |
| 4 | Выход, успешное выполнение с некритическим сбоем, необходимо выполнить перезагрузку | Обычно появляется при получении предупреждения о делегировании DNS. Если делегирование DNS не настраивается, используйте следующий атрибут:<p>-creatednsdelegation:$false |

### <a name="promotion-and-demotion-failure-codes"></a>Коды ошибок повышения и понижения роли

Операции повышения и понижения роли возвращают указанные ниже коды ошибок. Также может выводиться расширенное сообщение об ошибке. Всегда внимательно читайте все сообщение, а не только числовой код.

| Код ошибки | Пояснение | Предлагаемое решение |
|--|--|--|
| 11 | Повышение роли контроллера домена уже выполняется | Не выполняйте более одной операции повышения роли контроллера домена для одного целевого компьютера одновременно. |
| 12 | Пользователь должен быть администратором | Выполните вход как член встроенной группы "Администраторы" с контролем учетных записей |
| 13 | Установлен центр сертификации | Нельзя понизить роль этого контроллера домена, так как он является центром сертификации. Не удаляйте ЦС, не проверив тщательно, как он используется. Если он выдает сертификаты, то его удаление приведет к прерыванию работы. Устанавливать ЦС на контроллерах домена не рекомендуется. |
| 14 | Запуск в режиме безопасной загрузки | Запустите сервер в обычном режиме |
| 15 | Изменение роли выполняется или требует перезагрузки | Перед повышением роли необходимо перезапустить сервер (из-за предыдущих изменений в конфигурации). |
| 16 | Запуск на неверной платформе | *Вероятность этой ошибки мала.* |
| 17 | Нет дисков NTFS 5 | Эта ошибка невозможна в Windows Server 2012, в котором по крайней мере диск %systemdrive% должен быть отформатирован в NTFS. |
| 18 | Недостаточно места в WINDIR | Освободите место в томе %systemdrive% с помощью программы cleanmgr.exe. |
| 19 | Ожидание смены имени, требуется перезагрузка | Перезагрузите сервер. |
| 20 | Имя компьютера имеет недопустимый синтаксис | Присвойте компьютеру допустимое имя. |
| 21 | Этот контроллер домена имеет роли FSMO, является глобальным каталогом и/или DNS-сервером | Add **-демотеоператионмастерроле** при использовании **-форцеремовал**. |
| 22 | Протокол TCP/IP не установлен или не работает | Убедитесь в том, что протокол TCP/IP на компьютере настроен, привязан и работает правильно. |
| 23 | Сначала необходимо настроить DNS-клиент | При добавлении в домен нового контроллера домена задайте основной DNS-сервер. |
| 24 | Указанные учетные данные недействительны или не содержат необходимых элементов | Проверьте правильность имени пользователя и пароля. |
| 25 | Не удалось найти контроллер домена для указанного домена | Проверьте параметры DNS-клиента и правила брандмауэра. |
| 26 | Не удалось прочесть список доменов данного леса | Проверьте параметры DNS-клиента, функциональность LDAP и правила брандмауэра. |
| 27 | Отсутствует имя домена | При повышении или понижении роли укажите домен. |
| 28 | Неправильное доменное имя | При повышении роли выберите другое, допустимое доменное имя DNS. |
| 29 | Родительский домен не существует | Проверьте родительский домен, указанный при создании дочернего домена или домена дерева. |
| 30 | Домен не входит в лес | Проверьте указанное доменное имя. |
| 31 | Дочерний домен уже существует | Укажите другое доменное имя. |
| 32 | Неправильное доменное имя NetBIOS | Укажите допустимое доменное имя NetBIOS. |
| 33 | Недопустимый путь к файлам IFM | Проверьте путь к папке установки с носителя |
| 34 | Неправильная база данных IFM | Используйте правильную базу данных установки с носителя для этой операционной системы и роли (версия операционной системы и тип контроллера домена — RODC или RWDC — должны совпадать). |
| 35 | Отсутствует SYSKEY | Папка установки с носителя зашифрована. Для ее использования необходимо указать действительный ключ SYSKEY. |
| 37 | Недопустимый путь к базе данных NTDS или ее журналам | Укажите в качестве пути к базе данных и журналам путь к фиксированному тому NTFS, а не подключенный диск или UNC-путь. |
| 38 | В томе недостаточно места для базы данных NTDS или ее журналов | Освободите место с помощью программы cleanmgr.exe, увеличьте дисковое пространство или освободите место вручную, переместив ненужные данные в другое место |
| 39 | Недопустимый путь к SYSVOL | Измените путь к папке SYSVOL на путь к фиксированному тому NTFS вместо пути к подключенному диску или UNC-пути. |
| 40 | Недопустимое имя сайта | Укажите существующее имя сайта. |
| 41 | Необходимо указать пароль для безопасного режима | Укажите пароль для учетной записи DSRM. Он не может быть пустым вне зависимости от того, как настроена политика паролей. |
| 42 | Пароль безопасного режима не отвечает условиям (только при повышении роли) | Укажите для учетной записи DSRM пароль, отвечающий правилам, настроенным для политики паролей. |
| 43 | Пароль администратора не отвечает условиям (только при понижении роли) | Укажите для учетной записи локального администратора пароль, отвечающий правилам, настроенным для политики паролей. |
| 44 | Указано недопустимое имя для леса | Укажите допустимое корневое доменное имя DNS для леса. |
| 45 | Лес с указанным именем уже существует | Выберите другое корневое доменное имя DNS для леса. |
| 46 | Указано недопустимое имя для дерева | Укажите допустимое доменное имя DNS для дерева. |
| 47 | Дерево с указанным именем уже существует | Выберите другое доменное имя DNS для дерева. |
| 48 | Имя дерева не соответствует структуре леса | Выберите другое доменное имя DNS для дерева. |
| 49 | Указанный домен не существует | Проверьте введенное доменное имя. |
| 50 | При понижении роли контроллер домена был неправильно определен как последний или был указан как последний, хотя он им не является | Не указывайте **контроллер домена как последний в домене** (**-lastdomaincontrollerindomain**), если он им не является. Используйте параметр **-игнореластдЦиндомаинмисматч** , чтобы переопределить, если это действительно последний контроллер домена и имеются фантомные метаданные контроллера домена. |
| 51 | В этом контроллере домена есть разделы приложений | **Удалите разделы приложений** (**-removeapplicationpartitions**) |
| 52 | Пропущен обязательный аргумент командной строки (то есть в командной строке необходимо указать файл ответов) | *Отображается только с помощью dcpromo/unattend, что является устаревшим. См. более старую документацию* |
| 53 | Не удалось повысить или понизить роль. Для очистки компьютер необходимо перезагрузить. | Изучите расширенное сообщение об ошибке и журналы. |
| 54 | Не удалось повысить или понизить роль | Изучите расширенное сообщение об ошибке и журналы. |
| 55 | Повышение или понижение роли было отменено пользователем | Изучите расширенное сообщение об ошибке и журналы. |
| 56 | Повышение или понижение роли было отменено пользователем. Для очистки компьютер необходимо перезагрузить. | Изучите расширенное сообщение об ошибке и журналы. |
| 58 | При повышении роли контроллера домена только для чтения необходимо указать имя сайта | Для контроллера домена только для чтения необходимо указать сайт. Сайт не обнаруживается автоматически, как в случае с контроллером домена для чтения и записи. |
| 59 | При понижении роли доменный контроллер является последним DNS-сервером в одной из зон | Укажите, что контроллер домена является **последним DNS-сервером в домене**, или используйте параметр **-ignorelastdnsserverfordomain** |
| 60 | Для повышения роли контроллера домена только для чтения в домене должен быть контроллер домена с ОС Windows Server 2008 или более поздней версии | Повысьте роль по крайней мере одного доступного для записи контроллера домена с ОС Windows Server 2008 или более поздней версии. |
| 61 | Невозможно установить доменные службы Active Directory с DNS в существующем домене, который не содержит DNS | *Эта ошибка произойти не может.* |
| 62 | В файле ответов отсутствует секция [DCInstall] | *Отображается только с помощью dcpromo/unattend, что является устаревшим. См. более старую документацию.* |
| 63 | Режим работы леса ниже Windows Server 2003 | Повысьте режим работы леса по крайней мере до основного режима Windows Server 2003. Операционные системы Windows 2000 и Windows NT 4.0 больше не поддерживаются. |
| 64 | Не удалось повысить уровень, так как не были обнаружены двоичные файлы компонентов | Установите роль доменных служб Active Directory. |
| 65 | Не удалось повысить уровень из-за сбоя установки двоичных файлов компонентов. | Установите роль доменных служб Active Directory. |
| 66 | Не удалось повысить уровень из-за сбоя определения операционной системы. | Сервер не возвращает версию своей операционной системы. Изучите расширенное сообщение об ошибке и журналы. Скорее всего, компьютер потребуется переустановить, так как его общая работоспособность под большим подозрением. |
| 68 | Недопустимый партнер репликации | Используйте repadmin.exe или **Get-адрепликатион \\ ** \* Windows PowerShell для проверки работоспособности контроллера домена партнера |
| 69 | Требуемый порт уже используется другим приложением | Используйте команду **netstat.exe -anob**, чтобы определить процессы, которые ошибочно назначены зарезервированным портам доменных служб Active Directory. |
| 70 | Корневой контроллер домена в лесу должен быть глобальным каталогом | *Отображается только с помощью dcpromo/unattend, что является устаревшим. См. более старую документацию* |
| 71 | DNS-сервер уже установлен | Не устанавливайте службу DNS (**-installDNS**), если она уже установлена. |
| 72 | На компьютере выполняются службы удаленных рабочих столов в режиме не для администратора | Нельзя повысить роль этого контроллера домена, так как он также является сервером служб удаленных рабочих столов, настроенным для более чем двух администраторов. Не удаляйте службы удаленных рабочих столов, не проверив тщательно, как они используются. Если они используются приложениями или конечными пользователями, то его удаление приведет к прерыванию работы. |
| 73 | Указан недопустимый режим работы леса. | Укажите допустимый режим работы леса. |
| 74 | Указан недопустимый режим работы домена. | Укажите допустимый режим работы домена. |
| 75 | Не удается определить политику репликации паролей по умолчанию. | Убедитесь в том, что политика репликации паролей для контроллеров домена только для чтения существует и доступна. |
| 76 | Указанные реплицированные или нереплицированные группы безопасности недопустимы | Убедитесь в том, что при указании политики репликации паролей вы ввели допустимый домен и учетные записи пользователей. |
| 77 | Задан недопустимый аргумент | Изучите расширенное сообщение об ошибке и журналы. |
| 78 | Не удалось проанализировать лес Active Directory | Изучите расширенное сообщение об ошибке и журналы. |
| 79 | Нельзя повысить роль контроллера домена только для чтения, так как команда rodcprep не выполнена | Используйте Windows Server 2012 для подготовки леса или выполните команду **adprep.exe /rodcprep**. |
| 80 | Команда Domainprep не была выполнена | Используйте Windows Server 2012 для подготовки домена или выполните команду **adprep.exe /domainprep**. |
| 81 | Команда Forestprep не была выполнена | Используйте Windows Server 2012 для подготовки леса или выполните команду **adprep.exe /forestprep**. |
| 82 | Несоответствие схемы леса | Используйте Windows Server 2012 для подготовки леса или выполните команду **adprep.exe /forestprep**. |
| 83 | Неподдерживаемый номер SKU | *Вероятность этой ошибки мала.* |
| 84 | Не удается определить учетную запись контроллера домена | Убедитесь в том, что существующие контроллеры доменов имеют правильный набор атрибутов контроля учетных записей. |
| 85 | Не удалось выбрать учетную запись контроллера домена для этапа 2 | Эта ошибка происходит, если вы указали параметр "Использовать существующую учетную запись", но либо учетная запись не была найдена, либо при ее поиске произошла ошибка. Убедитесь в том, что указана правильная промежуточная учетная запись контроллера домена только для чтения. |
| 86 | Необходимо выполнить повышение до этапа 2 | Эта ошибка происходит, если вы повышаете роль дополнительного контроллера домена, но учетная запись уже существует, а параметр "Разрешить переустановку" не задан. |
| 87 | Существует учетная запись контроллера домена конфликтующего типа | Переименуйте компьютер перед повышением роли, если вы не пытаетесь подключиться к незанятому контроллеру домена. Необходимо присоединиться к незанятой учетной записи контроллера домена, используя параметр **-усиксистингаккаунт** и правильный аргумент только для чтения или доступный для записи, в зависимости от типа учетной записи. |
| 88 | Указан недопустимый администратор сервера | Указана недопустимая учетная запись для делегирования администрирования контроллера домена только для чтения. Проверьте, является ли учетная запись допустимой учетной записью пользователя или группы. |
| 89 | Хозяин RID для указанного домена находится в автономном режиме | Чтобы обнаружить хозяина RID, используйте команду **netdom.exe query fsmo**. Подключите его к сети и сделайте его доступным для контроллера домена, роль которого повышается. |
| 90 | Хозяин именования доменов находится в автономном режиме. | Чтобы обнаружить хозяина именования доменов, используйте команду **netdom.exe query fsmo**. Подключите его к сети и сделайте его доступным для контроллера домена, роль которого повышается. |
| 91 | Не удалось определить, является ли процесс процессом wow64 | *Эта ошибка больше не возможна, так как операционная система 64-разрядная* |
| 92 | Процесс wow64 не поддерживается | *Эта ошибка больше не возможна, так как операционная система 64-разрядная* |
| 93 | Служба контроллера домена не запущена для непринудительного понижения роли | Запустите доменные службы Active Directory. |
| 94 | Пароль локального администратора не соответствует требованиям: либо пустая, либо необязательная | Укажите непустой пароль и убедитесь в том, что в соответствии с локальной политикой паролей пароль обязателен. |
| 95 | Невозможно понизить роль последнего контроллера домена Windows Server 2008 или более поздней версии в домене, в котором есть работающие контроллеры домена только для чтения | Прежде чем понизить роль всех доступных для чтения контроллеров домена Windows Server 2008 или более поздней версии, необходимо понизить роль всех контроллеров домена только для чтения. |
| 96 | Невозможно удалить двоичные файлы доменных служб | *Отображается только с помощью dcpromo/unattend, что является устаревшим. См. более старую документацию* |
| 97 | Версия режимы работы леса выше, чем версия операционной системы дочернего домена | Укажите режим работы дочернего домена, совпадающий с режимом работы леса или превышающий его. |
| 98 | Выполняется установка или удаление двоичных файлов компонента. | *Отображается только с помощью dcpromo/unattend, что является устаревшим. См. более старую документацию* |
| 99 | Режим работы леса слишком низок (эта ошибка возможна только в Windows Server 2012) | Повысьте режим работы леса по крайней мере до основного режима Windows Server 2003. Операционные системы Windows 2000 и Windows NT 4.0 больше не поддерживаются. |
| 100 | Режим работы домена слишком низок (эта ошибка возможна только в Windows Server 2012) | Повысьте режим работы домена по крайней мере до основного режима Windows Server 2003. Операционные системы Windows 2000 и Windows NT 4.0 больше не поддерживаются. |

## <a name="known-issues-and-common-support-scenarios"></a>Известные проблемы и распространенные сценарии поддержки

Ниже описаны распространенные проблемы, возникающие в процессе разработки Windows Server 2012. Все они заложены в систему, и для них имеется либо обходной путь, либо иная методика работы, позволяющая предотвращать такие неполадки. Многие из этих особенностей поведения одинаковы в Windows Server 2008 R2 и более поздних версиях. Однако при переделке развертывания доменных служб Active Directory уязвимость к этим неполадкам повышается.

| Проблема | После понижения роли контроллера домена служба DNS остается без зон. |
|--|--|
| Симптомы | Сервер по-прежнему отвечает на запросы DNS, но сведения о зонах отсутствуют. |
| Решение и примечания | При удалении роли доменных служб Active Directory также удалите роль DNS-сервера или отключите службу DNS-сервера. Не забудьте сопоставить DNS-клиент с другим сервером (отличным от самого клиента). При использовании Windows PowerShell выполните одну из следующих команд после понижения роли сервера:<p>DNS-код — uninstall-WindowsFeature<p>или диспетчер конфигурации служб<p>Код-Set-служба DNS-старттипе отключена<br />Служба DNS |

| Проблема | При повышении роли Windows Server 2012 до существующего одноуровневого домена параметр updatetopleveldomain=1 или allowsinglelabeldnsdomain=1 не настраивается. |
|--|--|
| Симптомы | Динамическая регистрация записей DNS не происходит. |
| Решение и примечания | Установите значения с помощью Netlogon и групповых политик DNS. Корпорация Майкрософт начала блокировать создание одноуровневых доменов в Windows Server 2008. Для перехода к одобренной структуре доменов DNS используйте ADMT или средство переименования доменов. |

| Проблема | Понижение роли последнего контроллера домена в домене завершается сбоем, если есть предварительно созданные незанятые учетные записи контроллеров домена только для чтения. |
|--|--|
| Симптомы | При понижении роли происходит сбой со следующим сообщением:<p>**Dcpromo.General.54**<p>Доменным службам Active Directory не удалось обнаружить другой контроллер домена Active Directory для передачи оставшихся в разделе CN=Schema,CN=Configuration,DC=corp,DC=contoso,DC=com данных.<p>"Неверный формат имени домена." |
| Решение и примечания | Удалите все оставшиеся предварительно созданные учетные записи контроллеров домена только для чтения перед понижением роли домена с помощью средства **Dsa.msc** или команды **Ntdsutil.exe metadata cleanup**. |

| Проблема | При автоматической подготовке леса и домена не выполняется средство GPPREP. |
|--|--|
| Симптомы | Функция междоменного планирования групповой политики (режим планирования результирующей политики) требует обновления файловой системы и разрешений Active Directory для существующего глобального каталога. Без средства Gpprep нельзя использовать планирование результирующей политики между доменами. |
| Решение и примечания | Выполните команду **adprep.exe /gpprep** вручную для всех доменов, которые не были ранее подготовлены для Windows Server 2003, Windows Server 2008 или Windows Server 2008 R2. Администраторам следует запустить средство GPPrep только один раз за историю домена, а не при каждом обновлении. При автоматической подготовке Active Directory оно не запускается, так как если вы уже задали соответствующие настраиваемые разрешения, все содержимое SYSVOL будет повторно реплицировано во всех контроллерах домена. |

| Проблема | При установке с носителя не удается выполнить проверку, если указан UNC-путь |
|--|--|
| Симптомы | Возвращаемая ошибка:<p>Код: не удалось проверить путь к носителю. Исключение при вызове "Жетдатабасеинфо" с аргументами "2". Недопустимая папка. |
| Решение и примечания | Файлы IFM следует хранить на локальном диске, а не по удаленному UNC-пути. Эта преднамеренная блокировка предотвращает частичное повышение роли сервера из-за перебоев в работе сети. |

| Проблема | При повышении роли контроллера домена предупреждение о делегировании DNS выводится дважды. |
|--|--|
| Симптомы | Предупреждение возвращается *дважды* при повышении с помощью Аддсдеплоймент Windows PowerShell:<p>Code-"не удается создать делегирование для этого DNS-сервера, так как не удается найти удостоверяющую родительскую зону или он не работает под управлением Windows DNS-сервера. При интеграции с существующей инфраструктурой DNS необходимо вручную создать делегирование для этого DNS-сервера в родительской зоне, чтобы обеспечить надежное разрешение имен извне домена. В противном случае никаких действий не требуется. " |
| Решение и примечания | ограничение игнорируется. Модуль Windows PowerShell ADDSDeployment выводит предупреждение сперва при проверке необходимых условий, а затем еще раз при настройке контроллера домена. Если вы не хотите настраивать делегирование DNS, используйте следующий аргумент:<p>Код — креатеднсделегатион: $false<p>*Не* пропускайте проверки необходимых условий, чтобы подавить это сообщение. |

| Проблема | Если при настройке указывается имя участника-пользователя или учетные данные, не относящиеся к домену, выводятся ложные сообщения об ошибках. |
|--|--|
| Симптомы | Диспетчер сервера возвращает следующую ошибку:<p>Код-исключение при вызове "Днсоптион" с аргументами "6"<p>Модуль Windows PowerShell ADDSDeployment возвращает следующую ошибку:<p>Ошибка проверки кода разрешений пользователя. Необходимо указать имя домена, к которому принадлежит эта учетная запись пользователя. |
| Решение и примечания | Предоставьте действительные учетные данные домена в формате **домен\пользователь**. |

| Проблема | Удаление роли DirectoryServices-DomainController с помощью Dism.exe приводит к тому, что сервер перестает загружаться. |
|--|--|
| Симптомы | Если использовать средство Dism.exe для удаления роли доменных служб Active Directory перед безопасным понижением роли контроллера домена, сервер перестает загружаться нормально и выводится следующее сообщение об ошибке:<p>Код — состояние: 0x000000000<br />INFO: произошла непредвиденная ошибка. |
| Решение и примечания | Выполните загрузку в режиме восстановления служб каталогов с помощью клавиш *SHIFT+F8*. Верните роль доменных служб Active Directory, а затем принудительно понизьте роль контроллера домена. Также можно восстановить состояние системы из резервной копии. Не используйте программу Dism.exe для удаления роли доменных служб Active Directory, так как она не распознает контроллеры домена. |

| Проблема | При выборе режима работы леса Win2012 происходит сбой установки нового леса |
|--|--|
| Симптомы | При повышении роли с помощью Windows PowerShell ADDSDeployment возвращается следующая ошибка:<p>Code-Test. Верифидкпромокоре. DCPromo. General. 74<p>Сбой проверки предварительных требований для повышения роли контроллера домена. Указан недопустимый режим работы домена |
| Решение и примечания | Не указывайте режим работы леса Win2012, не указав *также* режим работы домена Win2012. Вот пример, который будет работать без ошибок:<p>Code--леса Win2012-домаинмоде Win2012] |

| Проблема | При нажатии на кнопку "Проверить" в области выбора "Установка с носителя" ничего не происходит. |
|--|--|
| Симптомы | Если указан путь к папке IFM, то при нажатии на кнопку **Проверить** не выводится никаких сообщений и не происходит никаких действий. |
| Решение и примечания | После нажатия на кнопку **Проверить** сообщения выводятся, только если есть неполадки. В противном случае становится доступной кнопка **Далее**, если указан путь к папке IFM. Если вы выбрали папку IFM, то чтобы продолжить, необходимо нажать кнопку **Проверить**. |

| Проблема | При понижении роли с помощью диспетчера сервера информация не выводится, пока операция не завершится. |
|--|--|
| Симптомы | При удалении роли служб каталогов Active Directory и понижении роли контроллера домена с помощью диспетчера сервера текущая информация не выводится, пока операция не завершится успешно или сбоем. |
| Решение и примечания | Это ограничение диспетчера сервера. Чтобы получать информацию, используйте командлет Windows PowerShell ADDSDeployment:<p>Код — удаление — аддсдомаинконтроллер |

| Проблема | Функция проверки при установке с носителя не определяет, что для доступного для записи контроллера домена предоставлен носитель, предназначенный для установки контроллера домена только для чтения, и наоборот. |
|--|--|
| Симптомы | При повышении роли нового контроллера домена с помощью IFM и предоставлении неправильного носителя, то есть носителя, предназначенного для установки контроллера домена только для чтения, для доступного для чтения контроллера домена или наоборот, после нажатия кнопки "Проверить" сообщение об ошибке не выводится. Позднее происходит сбой повышения роли со следующей ошибкой:<p>Код — произошла ошибка при попытке настроить этот компьютер в качестве контроллера домена. <br />Невозможно запустить повышение роли "Установка с носителя" контроллера домена только для чтения, так как указанная база данных-источник запрещена. Для повышения роли носителя RODC можно использовать только базы данных из других контроллеров домена только для чтения. |
| Решение и примечания | При нажатии на кнопку "Проверить" проверяется только общая целостность папки IFM. Не предоставляйте серверу носитель IFM неправильного типа. Перед тем как пытаться повысить роль еще раз, используя правильный носитель, перезапустите сервер. |

| Проблема | Повышение роли контроллера домена только для чтения до предварительно созданной учетной записи компьютера завершается сбоем. |
|--|--|
| Симптомы | При использовании модуля Windows PowerShell ADDSDeployment для повышения роли нового контроллера домена только для чтения с помощью промежуточной учетной записи компьютера появляется следующее сообщение об ошибке:<p>Не удается разрешить набор параметров кода с использованием указанных именованных параметров.    <br />InvalidArgument: Параметербиндинжексцептион<br />    + Фулликуалифиедеррорид: Амбигуауспараметерсет, Microsoft. DirectoryServices. Deployment. PowerShell. Commands. install |
| Решение и примечания | Не указывайте параметры, которые уже определены в предварительно созданной учетной записи контроллера домена только для чтения. Вот они:<p>Код — реадонлиреплика<br />-инсталлднс<br />-донотконфигуреглобалкаталог<br />-sitename<br />-инсталлднс |

| Проблема | При выборе или отмене выбора параметра "Автоматический перезапуск конечного сервера, если требуется" ничего не происходит. |
|--|--|
| Симптомы | Если выбрать (или не выбрать) параметр диспетчер сервера **перезапускать каждый сервер назначения автоматически, если требуется** вхендемотинг контроллер домена с помощью удаления роли, сервер всегда перезагружается, независимо от выбора. |
| Решение и примечания | Это сделано намеренно. Процесс понижения роли перезагружает сервер вне зависимости от значения этого параметра. |

| Проблема | В журнале Dcpromo.log содержится запись [error] setting security on server files failed with 2 ([ошибка] при установке защиты для файлов сервера произошла ошибка 2). |
|--|--|
| Симптомы | Понижение роли контроллера домена завершается без проблем, но в журнале dcpromo log содержится следующее сообщение об ошибке:<p>Код-[Ошибка] не удалось установить безопасность для файлов сервера с 2 |
| Решение и примечания | Игнорируйте сообщение, так как эта ошибка ожидаема и носит формальный характер. |

| Проблема | При проверке необходимых условий adprep происходит ошибка "Не удалось выполнить проверку конфликтов схемы с Exchange". |
|--|--|
| Симптомы | При попытке повысить роль контроллера домена Windows Server 2012 до существующего леса Windows Server 2003, Windows Server 2008 или Windows Server 2008 R2 проверка необходимых условий завершается со следующей ошибкой:<p>Не удалось проверить код предварительных требований для подготовки Active Directory. Не удалось выполнить проверку конфликта схемы Exchange для домена  *<domain name>* (исключение: сервер RPC недоступен)<p>В журнале adprep.log регистрируется ошибка:<p>Code-Adprep не удалось получить данные с сервера *<domain controller>*<p>с помощью инструментарий управления Windows (WMI) (WMI). |
| Решение и примечания | Новый контроллер домена не может получить доступ к инструментарию WMI в существующих контроллерах домена посредством протоколов DCOM и RPC. На данный момент выявлены три возможные причины:<p>— Правило брандмауэра блокирует доступ к существующим контроллерам домена.<p>— Учетная запись сетевой службы отсутствует в привилегии "вход в качестве службы" (SeServiceLogonRight) на существующих контроллерах домена.<p>-NTLM отключена на контроллерах домена с использованием политик безопасности, описанных в разделе [Введение в ограничение проверки подлинности NTLM](/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/dd560653(v=ws.10)) . |

| Проблема | При создании леса доменных служб Active Directory всегда выводится предупреждение DNS |
|--|--|
| Симптомы | При создании леса доменных служб Active Directory и собственной зоны DNS в новом контроллере домена всегда появляется следующее предупреждение:<p>Код — в конфигурации DNS обнаружена ошибка. <br />Ни один из DNS-серверов, используемых этим компьютером, не ответил в течение интервала времени ожидания.<br />(код ошибки 0x000005B4 "ERROR_TIMEOUT") |
| Решение и примечания | ограничение игнорируется. Это предупреждение выводится преднамеренно на первом контроллере домена в корневом домене нового леса на тот случай, если вы намеревались указать существующий DNS-сервер и зону. |

| Проблема | Аргумент Windows PowerShell -whatif возвращает неправильную информацию о DNS-сервере |
|--|--|
| Симптомы | Если вы используете аргумент **-whatif** при настройке контроллера домена с явным или неявным аргументом **-installdns:$true**, то в итоговых выходных данных будет указано:<p>Code — "DNS-сервер: нет" |
| Решение и примечания | ограничение игнорируется. Служба DNS установлена и настроена правильно. |

| Проблема | После повышения роли не удается войти из-за ошибки "Недостаточно памяти для обработки команды" |
|--|--|
| Симптомы | Если после повышения роли нового контроллера домена вы выходите, а затем пытаетесь войти в интерактивном режиме, происходит следующая ошибка:<p>Код-недостаточно места для обработки этой команды |
| Решение и примечания | Контроллер домена не был перезагружен после повышения роли из-за ошибки или по той причине, что был указан аргумент **-norebootoncompletion** из модуля Windows PowerShell ADDSDeployment. Перезапустите контроллер домена. |

| Проблема | Кнопка "Далее" недоступна на странице "Параметры контроллера домена" |
|--|--|
| Симптомы | Даже несмотря на то что пароль задан, кнопка **Далее** на странице **Параметры контроллера домена** в диспетчере сервера недоступна. В меню **Имя сайта** сайт не указан. |
| Решение и примечания | Имеется несколько сайтов доменных служб Active Directory и по крайней мере у одного нет подсетей. Создаваемый контроллер домена относится к одной из этих подсетей. Необходимо вручную выбрать подсеть в раскрывающемся меню "Имя сайта". Следует также проверить все сайты Active Directory с помощью средства DSSITE.MSC или воспользоваться следующей командой Windows PowerShell, чтобы найти все сайты без подсетей:<p>Код-Get-адрепликатионсите — \* подсети свойств, &#124; где-Object {! $ _. подсети-EQ " \* "} &#124; формате-имя таблицы |

| Проблема | Повышение или понижение роли завершается сбоем с сообщением "Невозможно запустить службу" |
|--|--|
| Симптомы | При попытке повысить роль, понизить роль или клонировать контроллер домена происходит следующая ошибка:<p>Код — служба не может быть запущена, так как она отключена или не имеет связанных с ней устройств (0x80070422).<p>Ошибка может быть интерактивной, происходить как событие или регистрироваться в журнале, например dcpromoui.log или dcpromo.log. |
| Решение и примечания | Служба сервера с ролью DS (DsRoleSvc) отключена. По умолчанию эта служба устанавливается при установке роли доменных служб Active Directory и для нее задается запуск вручную. Не отключайте эту службу. Снова задайте для нее тип запуска "Вручную" и разрешите операциям роли доменных служб запускать и останавливать ее по требованию. В этом весь замысел. |

| Проблема | Диспетчер сервера по-прежнему предупреждает о том, что необходимо повысить роль контроллера домена |
|--|--|
| Симптомы | После повышения роли контроллера домена с помощью устаревшей команды dcpromo.exe /unattend или обновления существующего контроллера домена Windows Server 2008 R2 до Windows Server 2012 в диспетчере сервера по-прежнему отображается задача настройки после развертывания **Повысить роль этого сервера до уровня контроллера домена**. |
| Решение и примечания | Щелкните ссылку в предупреждении, и сообщение исчезнет навсегда. Эта ошибка ожидаема и носит формальный характер. |

| Проблема | В сценарии развертывания в диспетчере сервера отсутствует операция установки роли |
|--|--|
| Симптомы | При повышении роли контроллера домена с помощью диспетчера сервера и сохранении сценария развертывания Windows PowerShell в нем отсутствует командлет установки роли и его аргументы (install-windowsfeature -name ad-domain-services -includemanagementtools). Без роли настроить контроллер домена нельзя. |
| Решение и примечания | Добавьте вручную этот командлет и его аргументы в любые сценарии. Это поведение ожидаемо и реализовано намеренно. |

| Проблема | Сценарий развертывания в диспетчере сервера имеет имя, отличное от PS1 |
|--|--|
| Симптомы | При повышении роли контроллера домена с помощью диспетчера сервера и сохранении сценария развертывания Windows PowerShell файлу присваивается случайное временное имя, отличное от PS1. |
| Решение и примечания | Переименуйте файл вручную. Это поведение ожидаемо и реализовано намеренно. |

| Проблема | Команда dcpromo /unattend допускает неподдерживаемые режимы работы |
|--|--|
| Симптомы | При повышении роли контроллера домена с помощью команды dcpromo /unattend с использованием следующего файла ответов:<p>Приведен<p>[ДЦинсталл]<br />Невдомаин = лес<p>Репликаорневдомаин = домен<p>Невдомаинднснаме = Corp. contoso. com<p>Сафемодеадминпассворд =Safepassword@6<p>Домаиннетбиоснаме = Corp<p>Днсоннетворк = да<p>Аутоконфигднс = да<p>Ребутонсукцесс = Ноанднопромптеисер<p>Ребутонкомплетион = нет<p>*Домаинлевел = 0*<p>*Форестлевел = 0*<p>происходит сбой, а в журнале dcpromoui.log регистрируются следующие ошибки:<p>Code-дкпромауи EA 4.5 B8 0089 13:31:50.783 ввод Каргументсспек:: Валидатеаргумент Домаинлевел<p>дкпромауи EA 4.5 B8 008A 13:31: значение 50.783 для Домаинлевел равно 0<p>дкпромауи EA 4.5 B8 008B 13:31: код выхода 50.783 — 77<p>дкпромауи EA 4.5 B8 008C 13:31:50.783 указанный аргумент является недопустимым.<p>дкпромауи EA 4.5 B8 008D 13:31:50.783 Закрытие журнала<p>дкпромауи EA 4.5 B8 0032 13:31: код выхода 50.830 — 77<p>Уровень 0 соответствует Windows 2000 и не поддерживается в Windows Server 2012. |
| Решение и примечания | Не используйте устаревшую команду dcpromo /unattend, так как она позволяет указывать недопустимые параметры, которые позднее приводят к сбою. Это поведение ожидаемо и реализовано намеренно. |

| Проблема | Продвижение "зависает" при создании объекта параметров NTDS, никогда не завершается |
|--|--|
| Симптомы | При повышении уровня реплики контроллера домена или RODC продвижение становится «создание объекта параметров NTDS» и никогда не продолжается или не завершается. Журналы также перестают обновляться. |
| Решение и примечания | Это известная проблема, вызванная предоставлением учетных данных встроенной учетной записи локального администратора с совпадающим паролем для встроенной учетной записи администратора домена. Это приводит к сбою в основном модуле настройки, который вместо обработки ошибки переходит в бесконечное ожидание (псевдоцикл). Это ожидаемое нежелательное поведение.<p>Чтобы устранить неполадку сервера, выполните указанные ниже действия.<p>1. перезагрузите его.<p>1. в AD удалите учетную запись компьютера-участника этого сервера (она еще не будет учетной записью контроллера домена).<p>1. принудительное исключение на этом сервере из домена<p>1. Удалите роль AD DS на этом сервере.<p>1. Перезагрузка<p>1. повторно добавьте роль AD DS и повторите продвижение, гарантируя, что вы всегда предоставляете учетные данные ***домаин\админ*** для повышения DC, а не только встроенную учетную запись локального администратора. |
