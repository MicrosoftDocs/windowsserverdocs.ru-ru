---
ms.assetid: ba7f2b9f-7351-4680-b7d8-a5f270614f1c
title: Что нового в установке и удалении доменных служб Active Directory
description: ''
ms.author: joflore
author: MicrosoftGuyJFlo
manager: mtillman
ms.date: 08/09/2018
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: identity-adds
ms.openlocfilehash: 66455a9ec4eb8a6ff6bfcfa387aeb59acb3ddcc2
ms.sourcegitcommit: 0d0b32c8986ba7db9536e0b8648d4ddf9b03e452
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2019
ms.locfileid: "59821355"
---
# <a name="whats-new-in-active-directory-domain-services-installation-and-removal"></a>Что нового в установке и удалении доменных служб Active Directory

>Область применения. Windows Server 2016, Windows Server 2012 R2, Windows Server 2012

Домен развертывание служб Active Directory (AD DS) в Windows Server 2012 стало проще и быстрее, чем предыдущие версии Windows Server. Установка AD DS теперь выполняется на основе Windows PowerShell и интегрирована с диспетчером серверов. Сократилось количество шагов, необходимых для внедрения контроллеров домена в существующую среду Active Directory. Это упрощает процесс создания новой среды Active Directory и повышает его эффективность. В новом процессе развертывания AD DS сведена к минимуму вероятность ошибок, которые могут воспрепятствовать установке.  
  
Кроме того, можно установить двоичные файлы роли сервера AD DS (то есть, роль сервера AD DS) на несколько серверов одновременно. Можно также удаленно запускать мастер установки AD DS на отдельном сервере. Эти усовершенствования обеспечивают большую гибкость при развертывании контроллеров домена под управлением Windows Server 2012, особенно в крупномасштабных, глобальных масштабах, где большое количество контроллеров домена должны быть развернуты в офисах, находящихся в разных регионах.  
  
Установка AD DS имеет следующие особенности:  
  
- **Интеграция Adprep.exe в процесс установки доменных служб Active Directory.** Трудоемкие задачи по подготовке существующей среды Active Directory, например необходимость использования разных учетных данных, копирования файлов Adprep.exe и входа в определенные контроллеры домена, упрощены или выполняются автоматически. Это ускоряет установку AD DS и снижает вероятность ошибок, которые могут воспрепятствовать повышению роли контроллера домена.  

   В средах, где предпочтительно выполнить команды adprep.exe до установки нового контроллера домена, команды adprep.exe можно по-прежнему выполнять отдельно от установки AD DS. Windows Server 2012 версию adprep.exe запускается удаленно, что позволяет выполнять все необходимые команды с сервера, работающего под управлением 64-разрядной версии Windows Server 2008 или более поздней версии.  

- **Новый процесс установки AD DS выполняется на основе Windows PowerShell и может быть инициирован удаленно.** Новый процесс установки AD DS интегрирован с диспетчером сервера, что позволяет использовать для установки AD DS тот же интерфейс, что и для установки других ролей сервера. При использовании Windows PowerShell командлеты развертывания AD DS обеспечивают дополнительные функциональные возможности и повышенную гибкость. Варианты установки с помощью командной строки и графического интерфейса пользователя функционально эквивалентны.  
- **Новый процесс установки AD DS включает проверку предварительных требований.** Любые потенциальные ошибки можно обнаружить до начала установки. Условия возникновения ошибок можно заблаговременно устранить, предотвратив проблемы, связанные с неполным обновлением. Например, если нужно выполнить команду adprep /domainprep, мастер установки проверяет, достаточно ли у пользователя прав для выполнения операции.  
- **Страницы настройки сгруппированы в последовательность, отражающую требования наиболее общих параметров повышения роли, при этом связанные параметры сгруппированы, что уменьшает количество страниц мастера.** Это улучшает контекст для выбора параметров установки.  
- **Можно экспортировать сценарий Windows PowerShell, содержащий все параметры, заданные во время установки через графический интерфейс.** По окончании установки или удаления можно экспортировать параметры в сценарий Windows PowerShell для использования при автоматическом выполнении той же операции.  
- **Перед перезагрузкой выполняется репликация только критически важных данных.** Новый переключатель позволяет разрешить репликацию некритических данных перед перезагрузкой. Дополнительные сведения см. в разделе [ADDSDeployment cmdlet arguments](../../ad-ds/deploy/Install-Active-Directory-Domain-Services--Level-100-.md#BKMK_Params).  

## <a name="BKMK_ADConfigurationWizard"></a>Мастер настройки доменных служб Active Directory

Начиная с Windows Server 2012, мастер настройки доменных служб Active Directory заменяет прежний Active Directory домена мастер установки служб как параметр пользовательского интерфейса пользователя, чтобы задать параметры при установке контроллера домена. Мастер настройки доменных служб Active Directory запускается после завершения работы мастера добавления ролей.  

> [!WARNING]  
> Прежний Active Directory домена мастер установки служб (dcpromo.exe) является устаревшим, начиная с Windows Server 2012.  

В [установки доменных служб Active Directory &#40;уровень 100&#41;](../../ad-ds/deploy/Install-Active-Directory-Domain-Services--Level-100-.md), в пользовательском Интерфейсе процедурах показано, как запустить мастер добавления ролей для установки сервера AD DS двоичных файлов роли, а затем запустите доменных служб Active Directory Мастер настройки для завершения установки контроллера домена. В примерах Windows PowerShell показано, как выполнить оба этапа с помощью командлета развертывания AD DS.  
  
## <a name="BKMK_NewAdprep"></a>Интеграция Adprep.exe

Начиная с Windows Server 2012, имеется только одна версия Adprep.exe (отсутствует 32-разрядная версия, adprep32.exe). Команды adprep выполняются автоматически по мере необходимости при установке контроллера домена под управлением Windows Server 2012 в существующем домене Active Directory или леса.  
  
Хотя операции Adprep выполняются автоматически, можно запускать программу adprep.exe отдельно. Например, если пользователь, устанавливающий AD DS, не является членом группы администраторов предприятия (необходимое условие для выполнения команды Adprep /forestprep), то может потребоваться выполнить команду отдельно. Но имеется только для запуска adprep.exe Если планируется выполнить обновление на месте первого контроллера домена Windows Server 2012 (другими словами, вы планируете на месте обновить операционную систему контроллера домена под управлением Windows Server 2012).  
  
Adprep.exe находится в папке \support\adprep установочного диска Windows Server 2012. Windows Server 2012 версия adprep поддерживает удаленное выполнение.  
  
Windows Server 2012 версию adprep.exe можно запустить на любом сервере под управлением 64-разрядной версии Windows Server 2008 или более поздней версии. Требуется сетевое подключение сервера к хозяину схемы для леса и к хозяину инфраструктуры домена, для которого вы хотите добавить контроллер домена. Если какая-либо из этих ролей размещена на сервере под управлением Windows Server 2003, то программу Adprep необходимо запускать удаленно. Сервер, на котором запускается Adprep, необязательно должен быть контроллером домена. Он может быть присоединен к домену или входить в рабочую группу.  

> [!NOTE]  
> При попытке запустить версию adprep.exe, Windows Server 2012 на сервере под управлением Windows Server 2003 возникает следующая ошибка:  
>   
> Adprep.exe не является допустимым приложением Win32.  

![Что нового](media/What-s-New-in-Active-Directory-Domain-Services-Installation-and-Removal/AdprepNotValid.gif)  

Сведения об устранении других ошибок, возвращаемых программой Adprep.exe, см. в разделе [Known issues](../../ad-ds/deploy/What-s-New-in-Active-Directory-Domain-Services-Installation-and-Removal.md#BKMK_KnownIssues).  

### <a name="group-membership-check-against-windows-server-2003-operations-master-roles"></a>Проверка членства в группах в сопоставлении с ролями хозяина операций в Windows Server 2003

Для каждой команды (/forestprep, /domainprep или /rodcprep) Adprep проводит проверку членства в группах, чтобы определить, соответствуют ли указанные учетные данные учетной записи в определенных группах. Чтобы выполнить эту проверку, Adprep обращается к владельцу роли хозяина операций. Если хозяин операций работает под управлением Windows Server 2003 и, запуская программу adprep.exe, вы хотите гарантировать выполнение проверки членства в группах во всех случаях, вы должны указать параметры командной строки /user и /userdomain.  
  
/ User и/USERDOMAIN — новые параметры для Adprep.exe в Windows Server 2012. Эти параметры определяют, соответственно, имя учетной записи и домен пользователя, который запускает команду Adprep. Служебная программа командной строки adprep.exe не позволяет указывать один из параметров /userdomain или /user, пропуская другой.  
  
Однако операции Adprep можно также выполнять в рамках установки AD DS с использованием Windows PowerShell или диспетчера серверов. В основе этих взаимодействий лежит та же реализация (adprep.dll), что и в основе adprep.exe. Windows PowerShell и диспетчер серверов используют отдельные учетные данные на входе, которые не устанавливают такие же требования, как adprep.exe. Используя Windows PowerShell или диспетчер серверов, можно передать в adprep.dll значение параметра /user, а параметр /userdomain пропустить. Если параметр/User задан, но не указан/USERDOMAIN, домен локального компьютера используется для выполнения проверки. Если компьютер не присоединен к домену, членство в группах проверить нельзя.  
  
Если членство в группах проверить невозможно, Adprep отображает предупреждающее сообщение в файлах журнала Adprep и продолжает свою работу:  

```
Adprep was unable to check the specified user's group membership. This could happen if the FSMO role owner <DNS host name of operations master> is running Windows Server 2003 or lower version of Windows.  
```

Если вы запускаете программу adprep.exe, не указывая параметры /user и /userdomain, и хозяин операций работает под управлением Windows Server 2003, то adprep.exe обращается к контроллеру домена в домене текущего пользователя, выполнившего вход в систему. Если учетная запись этого пользователя не является учетной записью домена, программа adprep.exe не сможет выполнить проверку членства в группах. Adprep.exe также не сможет выполнить проверку членства в группах, если используются учетные данные смарт-карты, даже если вы укажете оба параметра /user и /userdomain.  
  
Если работа Adprep завершается успешно, никаких действий выполнять не нужно. Если работа Adprep завершилась ошибками доступа, укажите учетную запись с правильным членством. Дополнительные сведения см. в разделе [Требования к учетным данным для выполнения программы adprep.exe и установки доменных служб Active Directory](../../ad-ds/deploy/Install-Active-Directory-Domain-Services--Level-100-.md#BKMK_Creds).  
  
### <a name="syntax-for-adprep-in-windows-server-2012"></a>Синтаксис Adprep в Windows Server 2012

Для запуска программы Adprep отдельно от установки AD DS используйте следующий синтаксис:  

```
Adprep.exe /forestprep /forest <forest name> /userdomain <user domain name> /user <user name> /password *  
```

Для более подробного ведения журнала используйте в команде параметр /logdsid. Файл adprep.log находится в папке %windir%\System32\Debug\Adprep\Logs.  

### <a name="running-adprep-using-smartcard"></a>Запуск Adprep с помощью смарт-карты

Windows Server 2012 версию adprep.exe использует учетные данные смарт-карты, но нет простого способа указать учетные данные смарт-карты через командную строку. Один из способов сделать это — получить учетные данные смарт-карты с помощью командлета PowerShell Get-Credential. Затем следует использовать имя пользователя из возвращенного объекта PSCredential, которое отображается как `@@...`. Паролем служит ПИН-код смарт-карты.  

Программа adprep.exe требует указать параметр /userdomain, если параметр /user задан. Для учетных данных смарт-карты параметр /userdomain должен соответствовать домену учетной записи пользователя, которую представляет смарт-карта.  

### <a name="adprep-domainprep-gpprep-command-is-not-run-automatically"></a>Команда adprep /domainprep /gpprep не выполняется автоматически

Команда adprep /domainprep /gpprep не выполняется в рамках установки AD DS. Эта команда устанавливает разрешения, необходимые для режима планирования результирующей политики. Подробнее об этой команде см. в [статье 324392 базы знаний Майкрософт](https://support.microsoft.com/kb/324392). Если команду нужно выполнить в вашем домене Active Directory, ее можно запустить отдельно от установки AD DS. Если команда уже была выполнена во время подготовки к развертыванию контроллеров домена, работающих под управлением Windows Server 2003 с пакетом обновления 1 или более поздней версии, запускать команду повторно не нужно.  

Можно добавить контроллеры домена под управлением Windows Server 2012 в существующий домен без выполнения команды adprep/domainprep / gpprep, но режим планирования результирующей ПОЛИТИКИ будет работать неправильно.  

## <a name="BKMK_PrereqCheck"></a>Проверка предварительных требований для установки доменных служб Active Directory AD

Мастер установки AD DS перед началом установки проверяет, выполняются ли следующие предварительные условия. Это позволяет исправить ошибки, которые могут воспрепятствовать установке.  
  
Предварительные требования, связанные с программой Adprep, включают, например, следующие.  

- Проверка учетных данных Adprep: если нужно запустить программу Adprep, мастер установки проверяет, достаточно ли у пользователя прав для выполнения необходимых операций Adprep.  
- Проверка доступности хозяина схемы: если мастер установки определит, что необходимо выполнить команду adprep /forestprep, он проверяет, подключен ли к сети хозяин схемы, и, если нет, завершается ошибкой.  
- Проверка доступности хозяина инфраструктуры: если мастер установки определит, что необходимо выполнить команду adprep /domainprep, он проверяет, подключен ли к сети хозяин инфраструктуры, и, если нет, завершается ошибкой.

Другие проверки предварительных требований, которые были перенесены из прежнего мастера установки Active Directory (dcpromo.exe), включают следующее.  

- Проверка имени леса: проверка того, является ли имя леса допустимым и не существует ли уже оно.  
- Проверка NetBIOS-имени: проверка того, является ли указанное NetBIOS-имя допустимым и не конфликтует ли оно с существующими именами.  
- Проверка путей к компонентам: проверка того, являются ли допустимыми пути к базе данных Active Directory, журналам и SYSVOL и достаточно ли для них свободного места на диске.  
- Проверка имени дочернего домена: проверка того, являются ли имена родительского и нового дочернего доменов допустимыми и не конфликтуют ли они с существующими доменами.  
- Проверка имени домена дерева: проверка того, является ли указанное имя домена в дереве допустимым и не существует ли уже оно.  

## <a name="BKMK_SystemReqs"></a>Требования к системе

Требования к системе для Windows Server 2012 не отличаются от Windows Server 2008 R2. Дополнительные сведения см. в разделе [Windows Server 2008 R2 с SP1 требования к системе](https://www.microsoft.com/windowsserver2008/en/us/system-requirements.aspx) (https://www.microsoft.com/windowsserver2008/en/us/system-requirements.aspx).  

Для некоторых компонентов могут быть установлены дополнительные требования. Например функции клонирования контроллера домена требуется, работе Windows Server 2012 и компьютер под управлением Windows Server 2012 с установленной ролью Hyper-V эмулятора основного контроллера домена.  

## <a name="BKMK_KnownIssues"></a>Известные проблемы

В этом разделе перечислены некоторые известные проблемы, которые влияют на процесс установки AD DS в Windows Server 2012. Дополнительные сведения об известных проблемах см. в разделе [Устранение проблем при развертывании контроллера домена](../../ad-ds/deploy/Troubleshooting-Domain-Controller-Deployment.md).  

- Если доступ WMI к хозяину схемы заблокирован брандмауэром Windows при удаленном выполнении команды adprep /forestprep, то в журнале Adprep в каталоге %systemroot%\system32\debug\adprep появляется следующее сообщение об ошибке:  

   ```
   Adprep encountered a Win32 error.
   Error code: 0x6ba Error message: The RPC server is unavailable.  
   ```

   В этом случае можно обойти ошибку, либо запустив команду adprep /forestprep непосредственно на хозяине схемы, либо выполнив одну из следующих команд, которые разрешают передачу трафика WMI через брандмауэр Windows.

   Для Windows Server 2008 или более поздней версии:

   ```
   netsh advfirewall firewall set rule group="windows management instrumentation (wmi)" new enable=yes
   ```

   Для Windows Server 2003:

   ```
   netsh firewall set service RemoteAdmin enable
   ```

   По завершении работы программы Adprep можно снова заблокировать трафик WMI, выполнив любую из следующих команд:

   ```
   netsh advfirewall firewall set rule group="windows management instrumentation (wmi)" new enable=no
   ```

   ```
   netsh firewall set service remoteadmin disable
   ```

- Чтобы отменить выполнение командлета Install-ADDSForest, можно нажать клавиши CTRL+C. Установка будет прекращена, и любые изменения состояния сервера будут отменены. Однако после выполнения команды отмены управление не вернется к Windows PowerShell и командлет может зависнуть на неопределенное время.  
- **Установка дополнительного контроллера домена с использованием учетных данных смарт-карт завершается сбоем, если целевой сервер не присоединен к домену перед установкой.**  

   В этом случае возвращается следующее сообщение об ошибке:  

   Не удается подключиться к исходному контроллеру домена репликации *имя исходного контроллера домена*. (Исключение: ошибка при входе: неизвестное имя пользователя или неверный пароль)  

   Если вы присоедините целевой сервер к домену и затем проведете установку с использованием смарт-карты, то установка завершится успешно.  
  
- **Модуль ADDSDeployment не поддерживает 32-разрядные процессы.** Если вы автоматизируете развертывание и настройку Windows Server 2012, с помощью сценария, который включает командлет ADDSDeployment и любой другой командлет, не поддерживающий собственные 64-разрядные процессы, то сценарий может завершиться с ошибкой, указывающей ADDSDeployment не удается найти командлет.  

   В этом случае нужно запустить командлет ADDSDeployment отдельно от командлета, который не поддерживает собственные 64-разрядные процессы.  

- В Windows Server 2012 с именем Resilient File System имеется новая файловая система. Не храните базу данных Active Directory, файлы журнала или SYSVOL на томе данных, отформатированном под файловую систему Resilient File System (ReFS). Дополнительные сведения о ReFS см. в разделе [создания нового поколения файловой системы для Windows: ReFS](http://blogs.msdn.com/b/b8/archive/2012/01/16/building-the-next-generation-file-system-for-windows-refs.aspx).  
- В диспетчере серверов, серверов под управлением AD DS или другие роли сервера в установке Server Core, будут модернизированы до Windows Server 2012, может отображаться с красным цветом, несмотря на то, что сбор событий и состояние выполняется должным образом. Серверы под управлением установки Server Core из предварительной версии, Windows Server 2012 также могут быть затронуты.  

### <a name="active-directory-domain-services-installation-hangs-if-an-error-prevents-critical-replication"></a>Установка доменных служб Active Directory зависает, если ошибка мешает репликации критически важных данных

Если при установке AD DS будет обнаружена ошибка на этапе репликации критически важных данных, то установка может зависнуть на неопределенное время. Например, если сетевые ошибки мешают завершить репликацию критически важных данных, то установка не продолжится.  
  
При установке с помощью диспетчера серверов страница хода установки может оставаться открытой, но ошибки на экране не отображаются и состояние процесса может не меняться около 15 минут. При использовании Windows PowerShell состояние процесса, отображаемое в окне Windows PowerShell, не будет меняться на протяжении более 15 минут.  
  
В случае возникновения этой проблемы проверьте файл dcpromo.log в папке %systemroot%\debug на целевом сервере. Обычно файл журнала содержит сведения о повторяющихся сбоях репликации. Некоторые известные причины этой проблемы  

- Сетевые неполадки мешают репликации критически важных данных между целевым сервером, роль которого повышается, и исходным контроллером домена репликации.  

   Например, файл dcpromo.log может содержать следующие данные:  

   ```  
   05/02/2012 14:16:46 [INFO] EVENTLOG (Error): NTDS Replication / DS RPC Client : 1963  
   Internal event: The following local directory service received an exception from a remote procedure call (RPC) connection. Extensive RPC information was requested. This is intermediate information and might not contain a possible cause.  
   Process ID:   
   500  
   Reported error information:  
   Error value:   
   Could not find the domain controller for this domain. (1908)  
   directory service:   
   <domain>.com  
   Extensive error information:  
   Error value:   
   A security package specific error occurred. 1825  
   directory service:   
   <DC Name>  
   ```  

   Поскольку в процессе установки попытки репликации критически важных данных повторяются бесконечное число раз, установка контроллера домена продолжится, если проблемы с сетью будут решены. Исследуйте проблему с сетью с использованием таких средств, как ipconfig, nslookup и netmon, если необходимо. Убедитесь, что существует подключение между контроллером домена, уровень которого вы повышаете, и партнером репликации, выбранным во время установки AD DS. Также убедитесь, что разрешение имен работает.  

   Требования для установки AD DS к сетевому подключению и разрешению имен проверяются во время проверки необходимых компонентов перед началом установки. Но некоторые ошибочные состояния могут возникнуть после выполнения проверки необходимых компонентов и до завершения установки, например если партнер репликации становится недоступным во время установки.  

- Во время установки контроллера домена репликации учетная запись локального администратора на целевом сервере указана для учетных данных установки, а пароль этой учетной записи совпадает с паролем учетной записи администратора домена. В этом случае можно завершить работу мастера установки и начать установку до возникновения ошибки «Отказано в доступе».  

   Например, файл dcpromo.log может содержать следующие данные:  

   ```  
   03/30/2012 11:36:51 [INFO] Creating the NTDS Settings object for this Active Directory Domain Controller on the remote AD DC DC2.contoso.com...  
   03/30/2012 11:36:51 [INFO] EVENTLOG (Error): NTDS Replication / DS RPC Client : 1963Internal event: The following local directory service received an exception from a remote procedure call (RPC) connection. Extensive RPC information was requested. This is intermediate information and might not contain a possible cause.  
   Process ID:   
   508  
   Reported error information:  
   Error value:   
   Access is denied. (5)  
   directory service:   
   DC2.contoso.com  
   ```  

   Если причиной ошибки стало указание локальной учетной записи администратора и пароля, для восстановления необходимо повторно установить операционную систему, [выполнить очистку метаданных](https://technet.microsoft.com/library/cc816907(WS.10).aspx) учетной записи контроллера домена, установка которой завершилась с ошибками, а затем повторить попытку установки AD DS с использованием учетных данных администратора домена. Это ошибочное состояние не может быть исправлено перезапуском сервера, потому что сервер определит, что AD DS установлена, даже если установка не была успешна завершена.  

### <a name="BKMK_nonnormalDNSNameWarning"></a>Мастер настройки доменных служб Active Directory выдает предупреждение, когда указано ненормализованное DNS-имени

Если вы создаете новый домен или лес и указываете DNS-имя домена, содержащее ненормализованные международные символы, то мастер настройки доменных служб Active Directory отображает предупреждение о том, что DNS-запросы имени могут завершиться ошибкой. Хотя DNS-имя домена указывается на странице конфигурации развертывания, предупреждение позднее выводится на странице проверки предварительных требований в мастере.  

Если имя домена DNS задается с помощью Ненормализованный имя, например füßball.com или «ΣΤ» .com (нормализованной версии являются: füssball.com и βστα.com), клиентские приложения, которые пытаются получить доступ к его с помощью WinHTTP нормализует имя перед вызовом разрешения имен API. Если пользователь вводит ««ΣΤ» .com» на некоторых диалоговое окно, запрос DNS будет отправляться как «βστα.com» и сервер DNS не будут совпадать с записью ресурса для ««ΣΤ» .com». Пользователь не сможет разрешить имя.  

Следующий пример поясняет одну из проблем, которая может возникнуть при использовании ненормализованного IDN-имени:  

1. Создается и регистрируется на сервере dns домена, используя имя не было нормализовано: füßball.com  
2. Nps «машины» присоединен к домену и возвращает его имя, зарегистрированное: nps.füßball.com  
3. Клиентское приложение пытается подключиться к nps.füßball.com сервера  
4. Клиентское приложение пытается разрешить имя nps.füßball.com, вызвав разрешения имен API.  
5. Из-за нормализации имя преобразуемого nps.füssball.com и запрашивается по сети как nps.füßball.com  
6. Клиентское приложение не удается разрешить имя, так как зарегистрированное имя nps.füßball.com  

Если на странице проверки предварительных требований в мастере настройки доменных служб Active Directory появляется предупреждение, вернитесь на страницу конфигурации развертывания и укажите нормализованное DNS-имя домена. Если вы устанавливаете новый домен с помощью Windows PowerShell, укажите нормализованное DNS-имя для параметра -DomainName.  

Подробнее об IDN см. в разделе [Обработка международных доменных имен (IDN)](https://msdn.microsoft.com/library/windows/desktop/dd318142(v=vs.85).aspx).  
