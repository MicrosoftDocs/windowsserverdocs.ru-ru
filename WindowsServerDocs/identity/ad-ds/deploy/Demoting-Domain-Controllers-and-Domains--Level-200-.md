---
ms.assetid: 65ed5956-6140-4e06-8d99-8771553637d1
title: Понижение уровня контроллеров домена и доменов (уровень 200)
author: iainfoulds
ms.author: iainfou
manager: daveba
ms.date: 11/14/2018
ms.topic: article
ms.openlocfilehash: 5a450d37c3dcd5f92e6685c1a7f0393d764b8e55
ms.sourcegitcommit: 1dc35d221eff7f079d9209d92f14fb630f955bca
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/26/2020
ms.locfileid: "88940964"
---
# <a name="demoting-domain-controllers-and-domains"></a>Понижение роли контроллеров домена и доменов

> Область применения. Windows Server

В этом разделе описывается, как удалить доменные службы Active Directory с помощью диспетчера сервера или Windows PowerShell.

## <a name="ad-ds-removal-workflow"></a>Рабочий процесс удаления AD DS

![Диаграмма рабочего процесса удаления AD DS](media/Demoting-Domain-Controllers-and-Domains--Level-200-/adds_demotedomainforest.png)

> [!CAUTION]
> Удаление ролей доменных служб Active Directory с помощью программы Dism.exe или модуля Windows PowerShell DISM после повышения роли до контроллера домена не поддерживается и приводит к тому, что сервер перестает загружаться нормально.
>
> В отличие от диспетчера сервера или модуля ADDSDeployment для Windows PowerShell, DISM — это собственная система обслуживания, которая не распознает доменные службы Active Directory или их конфигурацию. Не используйте программу Dism.exe или модуль Windows PowerShell DISM для удаления роли доменных служб Active Directory, если сервер все еще является контроллером домена.

## <a name="demotion-and-role-removal-with-powershell"></a>Понижение роли и удаление ролей с помощью PowerShell

| Командлеты ADDSDeployment и ServerManager | Аргументы (аргументы, выделенные **жирным шрифтом**, являются обязательными. Аргументы, выделенные *курсивом*, можно указать с помощью Windows PowerShell или мастера настройки доменных служб Active Directory). |
|--|--|
| Uninstall-Аддсдомаинконтроллер | -SkipPreChecks<p>*-LocalAdministratorPassword*<p>-Confirm<p>***-Credential***<p>-DemoteOperationMasterRole<p>*-DNSDelegationRemovalCredential*<p>-Force<p>*-ForceRemoval*<p>*-IgnoreLastDCInDomainMismatch*<p>*-IgnoreLastDNSServerForZone*<p>*-LastDomainControllerInDomain*<p>-Norebootoncompletion<p>*-RemoveApplicationPartitions*<p>*-RemoveDNSDelegation*<p>-RetainDCMetadata |
| Uninstall-WindowsFeature/Remove-WindowsFeature | ***-Имя***<p>***-IncludeManagementTools***<p>*-Restart*<p>-Remove<p>-Force<p>-ComputerName<p>-Credential<p>-LogPath<p>-Vhd |

> [!NOTE]
> Аргумент **-credential** требуется только в том случае, если вы еще не выполнили вход в качестве члена группы "Администраторы предприятия" (при понижении роли последнего контроллера домена в домене) или группы "Администраторы домена" (при понижении роли реплики контроллера домена). Аргумент **-includemanagementtools** необходим, только если вы хотите удалить все служебные программы управления доменными службами Active Directory.

## <a name="demote"></a>Понижение

### <a name="remove-roles-and-features"></a>Удалить роли и компоненты

В диспетчере сервера имеется два интерфейса для удаления роли доменных служб Active Directory.

* В меню **Управление** на главной информационной панели выберите пункт **Удалить роли и компоненты**

   ![Диспетчер сервера — удаление ролей и компонентов](media/Demoting-Domain-Controllers-and-Domains--Level-200-/ADDS_RRW_TR_Manage.png)

* На панели навигации выберите пункт **AD DS** или **Все серверы**. Перейдите вниз к разделу **Роли и компоненты**. В списке **Роли и компоненты** щелкните правой кнопкой мыши **Доменные службы Active Directory** и выберите команду **Удалить роль или компонент**. В этом интерфейсе пропускается страница **Выбор сервера**.

   ![Диспетчер сервера-All Servers — удаление ролей и компонентов](media/Demoting-Domain-Controllers-and-Domains--Level-200-/ADDS_RRW_TR_ServerSelection.png)

Командлеты ServerManager **uninstall-WindowsFeature** и **Remove-WindowsFeature** не позволяют удалить роль AD DS, пока контроллер домена не будет понижен.

### <a name="server-selection"></a>Выбор сервера

![Мастер удаления ролей и компонентов Выбор целевого сервера](media/Demoting-Domain-Controllers-and-Domains--Level-200-/ADDS_RRW_TR_ServerSelection2.png)

В диалоговом окне **Выбор сервера** можно выбрать один из серверов, ранее добавленных в пул, если он доступен. Локальный сервер, на котором запущен диспетчер сервера, доступен всегда.

### <a name="server-roles-and-features"></a>"Роли сервера" и "Компоненты"

![Мастер удаления ролей и компонентов — Выбор ролей для удаления](media/Demoting-Domain-Controllers-and-Domains--Level-200-/ADDS_RRW_TR_ServerRoles.png)

Чтобы понизить роль контроллера домена, снимите флажок **Доменные службы Active Directory**. Если сервер в настоящее время является контроллером домена, роль доменных служб Active Directory не удаляется, а открывается диалоговое окно **Результаты проверки** с предложением понизить роль. В противном случае он удаляет двоичные файлы, как и любые другие функции ролей.

* Не удаляйте другие роли или компоненты, связанные с доменными службами Active Directory, такие как DNS, консоль управления групповыми политиками или средства удаленного администрирования сервера, если вы планируете немедленно повысить роль контроллера домена снова. Удаление дополнительных ролей и компонентов увеличивает время, необходимое для повторного повышения роли, так как диспетчер сервера повторно устанавливает их при переустановке роли.
* Если вы планируете понизить роль контроллера домена навсегда, удалите ненужные роли и компоненты доменных служб Active Directory по собственному усмотрению. Для этого необходимо снять флажки, соответствующие этим ролям и компонентам.

   Вот полный список ролей и компонентов, связанных с доменными службами Active Directory:

   * Модуль Active Directory для Windows PowerShell
   * Средства AD DS и AD LDS
   * Центр администрирования Active Directory
   * Оснастки и программы командной строки AD DS
   * DNS-сервер
   * Консоль управления групповыми политиками

Эквивалентные командлеты модулей ADDSDeployment и ServerManager Windows PowerShell:

```
Uninstall-addsdomaincontroller
Uninstall-windowsfeature
```

![Мастер удаления ролей и компонентов — диалоговое окно подтверждения](media/Demoting-Domain-Controllers-and-Domains--Level-200-/ADDS_RRW_TR_RemoveFeatures.png)

![Мастер удаления ролей и компонентов — Проверка](media/Demoting-Domain-Controllers-and-Domains--Level-200-/ADDS_RRW_TR_Demote.png)

### <a name="credentials"></a>Учетные данные

![Мастер настройки служб домен Active Directory — Выбор учетных данных](media/Demoting-Domain-Controllers-and-Domains--Level-200-/ADDS_RRW_TR_Credentials.png)

Параметры понижения уровня настраиваются на странице **Учетные данные**. Учетные данные, необходимые для понижения уровня, представлены в следующем списке:

* Для понижения уровня дополнительного контроллера домена требуются учетные данные администратора домена. Выбор **принудительного удаления этого контроллера домена** понижает роль контроллера домена без удаления метаданных объекта контроллера домена из Active Directory.

   > [!WARNING]
   > Этот параметр следует выбрать, только если контроллер домена не может установить связь с другими контроллерами домена и нет *другого способа* разрешить эту сетевую проблему. Принудительное понижение уровня оставляет потерянные метаданные в Active Directory на оставшихся контроллерах домена леса. Помимо этого, все нереплицированные изменения на этом контроллере домена, например пароли и новые учетные записи пользователей, навсегда теряются. Потерянные метаданные — это основная причина обращения в службу поддержки пользователей Майкрософт по поводу AD DS, Exchange, SQL и другого программного обеспечения.
   >
   > При принудительном понижении уровня контроллера домена *необходимо* немедленно почистить метаданные вручную. Этапы очистки см. в разделе [Очистка метаданных сервера](ad-ds-metadata-cleanup.md).

   ![Мастер настройки служб домен Active Directory — принудительное удаление учетных данных](media/Demoting-Domain-Controllers-and-Domains--Level-200-/ADDS_RRW_TR_ForceDemote.png)

* Для понижения уровня последнего контроллера домена требуется членство в группе администраторов предприятия, так как при этом удаляется сам домен (если это последний домен леса, при этом удаляется лес). Диспетчер сервера сообщает, является ли текущий контроллер последним контроллером в домене. Для подтверждения того, что контроллер является последним в домене, необходимо установить флажок **Последний контроллер домена в домене**.

Эквивалентные аргументы Windows PowerShell ADDSDeployment:

```
-credential <pscredential>
-forceremoval <{ $true | false }>
-lastdomaincontrollerindomain <{ $true | false }>
```

### <a name="warnings"></a>Предупреждения

![Мастер настройки домен Active Directory Services — влияние ролей FSMO учетных данных](media/Demoting-Domain-Controllers-and-Domains--Level-200-/ADDS_RRW_TR_Warnings.png)

Страница **Предупреждения** информирует о возможных последствиях удаления контроллера домена. Чтобы продолжить, необходимо установить флажок **Продолжить удаление**.

> [!WARNING]
> Если ранее на странице **Учетные данные** вы выбрали параметр **Принудительно удалить контроллер домена**, на странице **Предупреждения** будут показаны все роли FSMO, размещенные в этом контроллере домена. *Необходимо* захватить роли с другого контроллера домена *сразу* после понижения роли этого сервера. Дополнительные сведения о захвате ролей FSMO см. в разделе [Захват роли хозяина операций](/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/cc816779(v=ws.10)).

У этой страницы нет эквивалентного аргумента в модуле Windows PowerShell ADDSDeployment.

### <a name="removal-options"></a>Параметры удаления

![Мастер настройки служб домен Active Directory — учетные данные для удаления DNS и разделов приложений](media/Demoting-Domain-Controllers-and-Domains--Level-200-/ADDS_RRW_TR_ReviewOptions.png)

Страница **Параметры удаления** выводится или не выводится в зависимости от того, был ли выбран параметр **Последний контроллер домена в домене** на странице **Учетные данные**. На ней можно настроить дополнительные параметры удаления. Установите флажок **пропускать последний DNS-сервер для зоны**, **удалить разделы приложений**и **Удалить делегирование DNS** , чтобы включить кнопку **Далее** .

Параметры выводятся, только если они применимы к этому контроллеру домена. Например, если делегирование DNS для сервера не используется, соответствующий флажок отображаться не будет.

Чтобы указать альтернативные учетные данные администратора DNS, нажмите кнопку **Изменить**. Чтобы просмотреть дополнительные разделы, которые мастер удалит во время понижения роли, нажмите кнопку **Просмотр разделов**. По умолчанию единственными дополнительными разделами являются зоны DNS-домена и DNS-леса. Все остальные разделы не относятся к Windows.

Эквивалентные аргументы командлета ADDSDeployment:

```
-ignorelastdnsserverforzone <{ $true | false }>
-removeapplicationpartitions <{ $true | false }>
-removednsdelegation <{ $true | false }>
-dnsdelegationremovalcredential <pscredential>
```

### <a name="new-administrator-password"></a>Новый пароль администратора

![Мастер настройки служб домен Active Directory — учетные данные новый пароль администратора](media/Demoting-Domain-Controllers-and-Domains--Level-200-/ADDS_RRW_TR_NewAdminPwd.png)

На странице **новый пароль администратора** необходимо указать пароль для встроенной учетной записи администратора локального компьютера, после завершения понижения роли, когда компьютер станет рядовым сервером домена или рабочей группой.

Если аргументы командлета **Uninstall-ADDSDomainController** не заданы, они имеют те же значения по умолчанию, что и параметры в диспетчере сервера.

Аргумент **LocalAdministratorPassword** действует особым образом.

* Если этот аргумент *не указан*, командлет предлагает ввести и подтвердить скрытый пароль. Это предпочтительный вариант использования при интерактивном выполнении командлета.
* Если аргумент указан *со значением*, это значение должно быть защищенной строкой. Это не является предпочтительным вариантом использования при интерактивном выполнении командлета.

Например, можно вручную запросить пароль с помощью командлета **Read-Host** , чтобы запросить безопасную строку у пользователя.

```
-localadministratorpassword (read-host -prompt "Password:" -assecurestring)
```

> [!WARNING]
> Поскольку два предыдущих варианта не подтверждают пароль, будьте предельно осторожны: пароль не отображается.

Можно также ввести защищенную строку в качестве переменной с преобразованным открытым текстом, хотя использовать такой вариант настоятельно не рекомендуется. Например:

```
-localadministratorpassword (convertto-securestring "Password1" -asplaintext -force)
```

> [!WARNING]
> Ввод или хранение пароля в виде открытого текста не рекомендуется. Любой пользователь, выполняющий эту команду в сценарии или заглядывающий через ваше плечо, сможет узнать пароль локального администратора этого компьютера. Зная пароль, он получит доступ ко всем данным на нем и сможет персонифицировать сам сервер.

### <a name="confirmation"></a>Подтверждение

![Мастер настройки служб домен Active Directory. параметры проверки](media/Demoting-Domain-Controllers-and-Domains--Level-200-/ADDS_RRW_TR_Confirmation.png)

На странице **Подтверждение** приводится описание запланированного понижения роли. Список параметров конфигурации понижения роли не отображается. Это последняя страница мастера, отображаемая перед тем, как начнется понижение роли. При нажатии на кнопку "Просмотреть сценарий" создается сценарий понижения роли Windows PowerShell.

Нажмите кнопку **Понизить уровень**, чтобы выполнить следующий командлет ADDSDeployment:

```
Uninstall-ADDSDomainController
```

Для просмотра информации о конфигурации используйте необязательный аргумент **Whatif** с командлетом **Uninstall-ADDSDomainController**. Это позволит просмотреть явные и неявные значения аргументов командлета.

Например:

![Пример удаления PowerShell — Аддсдомаинконтроллер](media/Demoting-Domain-Controllers-and-Domains--Level-200-/ADDS_PSUninstall.png)

Запрос на перезагрузку — это последняя возможность отменить эту операцию при использовании модуля Windows PowerShell ADDSDeployment. Чтобы подавить этот запрос, используйте аргумент **-force** или **confirm:$false**.

### <a name="demotion"></a>Понижение уровня

![Мастер настройки служб домен Active Directory — выполняется понижение уровня](media/Demoting-Domain-Controllers-and-Domains--Level-200-/ADDS_RRW_TR_Demotion.png)

Когда появляется страница **Понижение уровня**, это означает, что настройка контроллера домена началась и ее нельзя остановить или отменить. Подробная информация об операциях выводится на этой странице и записывается в следующие журналы:

* %systemroot%\debug\dcpromo.log
* %systemroot%\debug\dcpromoui.log

Поскольку **uninstall-аддсдомаинконтроллер** и **uninstall-WindowsFeature** имеют только одно действие каждый, они показаны на этапе подтверждения с минимальными необходимыми аргументами. При нажатии на клавишу ВВОД запускается процесс понижения роли, после чего компьютер перезапускается.

![Пример удаления PowerShell — Аддсдомаинконтроллер](media/Demoting-Domain-Controllers-and-Domains--Level-200-/ADDS_PSUninstallConfirm.png)

![Пример удаления PowerShell — WindowsFeature](media/Demoting-Domain-Controllers-and-Domains--Level-200-/ADDS_PSUninstallWindowsFeature.png)

Чтобы автоматически закрывать напоминание о перезагрузке, используйте аргументы **-force** или **-confirm:$false** с любым командлетом Windows PowerShell ADDSDeployment. Чтобы предотвратить автоматическую перезагрузку сервера по завершении повышения роли, используйте аргумент **-norebootoncompletion:$false**.

> [!WARNING]
> Отключать перезагрузку не рекомендуется. Для правильной работы рядовой сервер должен перезагрузиться.

![Удаление PowerShell — пример Аддсдомаинконтроллер Force](media/Demoting-Domain-Controllers-and-Domains--Level-200-/ADDS_PSUninstallFinished.png)

Ниже приводится пример принудительного понижения с минимальным набором обязательных аргументов **-forceremoval** и **-demoteoperationmasterrole**. Аргумент **-credential** не требуется, поскольку пользователь выполнил вход как член группы администраторов предприятия:

![Пример удаления PowerShell — Аддсдомаинконтроллер](media/Demoting-Domain-Controllers-and-Domains--Level-200-/ADDS_PSUninstallExampleForce.png)

Ниже приведен пример удаления последнего контроллера домена в домене с минимальным набором обязательных аргументов **-lastdomaincontrollerindomain** и **-removeapplicationpartitions**:

![Удаление PowerShell — пример Аддсдомаинконтроллер-Ластдомаинконтроллериндомаин](media/Demoting-Domain-Controllers-and-Domains--Level-200-/ADDS_PSUninstallExampleLastDC.png)

При попытке удалить роль AD DS перед понижением роли сервера Windows PowerShell блокирует ошибку:

![Не удалось продолжить выполнение предварительных условий при удалении AD-Domain-Services, и удаление не может быть продолжено. 1. Прежде чем можно будет удалить активную роль Директоридомаин Services, необходимо понизить уровень контроллера домена.](media/Demoting-Domain-Controllers-and-Domains--Level-200-/ADDS_PSUninstallError.png)

> [!IMPORTANT]
> Чтобы получить возможность удалить двоичные файлы роли доменных служб Active Directory, необходимо перезапустить компьютер после понижения роли сервера.

### <a name="results"></a>Результаты

![Вы собираетесь отключить предупреждение после удаления AD DS](media/Demoting-Domain-Controllers-and-Domains--Level-200-/ADDS_RRW_TR_DemoteSignoff.png)

На странице **Результаты** показано, успешно ли было выполнено повышение роли, а также приводится важная для администраторов информация. Контроллер домена автоматически перезагрузится через 10 секунд.
