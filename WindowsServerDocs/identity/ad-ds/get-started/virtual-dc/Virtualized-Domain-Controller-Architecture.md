---
ms.assetid: 341614c6-72c2-444f-8b92-d2663aab7070
title: "Архитектура виртуализованных контроллеров доменов"
description: 
author: billmath
ms.author: billmath
manager: femila
ms.date: 05/31/2017
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: identity-adds
ms.openlocfilehash: ac8b190df065547d82aa431761eb5c00c94a2ad6
ms.sourcegitcommit: db290fa07e9d50686667bfba3969e20377548504
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/12/2017
---
# <a name="virtualized-domain-controller-architecture"></a>Архитектура виртуализованных контроллеров доменов

>Область применения: Windows Server 2016, Windows Server 2012 R2, Windows Server 2012

В этом разделе описывается архитектуры клонирования виртуализированного контроллера домена и безопасного восстановления. Он приведены процессы клонирования и безопасного восстановления с поясняющими блок-схемами, а также дано подробное объяснение каждый шаг в процессе.  
  
-   [Архитектура клонирования виртуализированного контроллера домена](../../../ad-ds/get-started/virtual-dc/Virtualized-Domain-Controller-Architecture.md#BKMK_CloneArch)  
  
-   [Архитектура виртуализованных контроллеров доменов безопасного восстановления](../../../ad-ds/get-started/virtual-dc/Virtualized-Domain-Controller-Architecture.md#BKMK_SafeRestoreArch)  
  
## <a name="BKMK_CloneArch"></a>Архитектура клонирования виртуализированного контроллера домена  
  
### <a name="overview"></a>Обзор  
Клонирование виртуализированного контроллера домена полагается на платформе низкоуровневой оболочки на предоставлении идентификатора **ИД создания Виртуальной машины** для обнаружения создания виртуальной машины. Службы AD DS изначально сохраняют значение этого идентификатора в своей базе данных (NTDS. DIT) при повышении роли контроллера домена. При загрузке виртуальной машины текущее значение ИД создания Виртуальной машины из виртуальной машины сравнивается со значением в базе данных. Если значения не совпадают, контроллер домена выполняет сброс Invocationid и отменяет пул относительных ИДЕНТИФИКАТОРОВ, чтобы предотвратить повторное использование номера последовательного обновления или создание дублирующихся субъектов безопасности. Контроллер домена, а затем выполняет поиск файла DCCloneConfig.xml в расположениях упомянутых в шаге 3 [подробный процесс клонирования](../../../ad-ds/get-started/virtual-dc/../../../ad-ds/get-started/virtual-dc/../../../ad-ds/get-started/virtual-dc/../../../ad-ds/get-started/virtual-dc/Virtualized-Domain-Controller-Architecture.md#BKMK_CloneProcessDetails). Если он находит файл DCCloneConfig.xml, то считает, что развернутым в качестве клона и поэтому инициирует клонирования, чтобы подготовить себя в качестве дополнительного контроллера домена посредством повторного продвижении существующих NTDS. Содержимое дерева каталогов Active Directory и SYSVOL, скопированных с исходного носителя.  
  
В смешанной среде, где некоторые низкоуровневые оболочки поддерживают ИД создания виртуальной Машины, а другие — нет носитель клона может быть случайно развернут в низкоуровневой оболочке, которая не поддерживает ИД создания виртуальной Машины. Наличие файла DCCloneConfig.xml указывает на намерение администратора клонировать контроллер домена. Таким образом Если файл DCCloneConfig.xml найден во время загрузки, но ИД создания виртуальной Машины не предоставляется с узла, контроллер домена клона загружается в служб восстановления режиме каталогов (DSRM) чтобы предотвратить негативное воздействие на остальную часть среды. Носитель клона затем можно переместить в низкоуровневую оболочку, которая поддерживает ИД создания виртуальной Машины и затем попытку клонирования можно повторить.  
  
Если носитель клона развертывается в низкоуровневой оболочке, которая поддерживает ИД создания виртуальной Машины, а файл DCCloneConfig.xml не предоставляется, как контроллер домена обнаруживает изменение ИД создания виртуальной Машины между DIT и новой виртуальной машиной, она активирует меры безопасности, чтобы предотвратить повторное использование номера последовательного обновления и Создание повторяющихся идентификаторов безопасности. Однако клонирование не инициируется, поэтому дополнительный контроллер домена продолжит работу с тем же удостоверением, что исходный контроллер домена. Этот дополнительный контроллер домена следует удалить из сети в более ранней сроки, чтобы предотвратить возникновение несогласованностей в среде. Дополнительные сведения о том, как освободить этот дополнительный контроллер домена обеспечить исходящую репликацию обновлений, в статье базы Знаний Майкрософт статьи [2742970](https://support.microsoft.com/kb/2742970).  
  
### <a name="BKMK_CloneProcessDetails"></a>Подробный процесс клонирования  
На следующей схеме показана архитектура для операции начального клонирования и для операции повторной попытки клонирования. Далее в этом разделе более подробно описаны эти процессы.  
  
**Операция начального клонирования**  
  
![Архитектура виртуализированных контроллеров домена](media/Virtualized-Domain-Controller-Architecture/ADDS_VDC_InitialCloningProcess.png)  
  
**Операция повторной попытки клонирования**  
  
![Архитектура виртуализированных контроллеров домена](media/Virtualized-Domain-Controller-Architecture/ADDS_VDC_CloningRetryProcess.png)  
  
Далее описывается процесс более подробно:  
  
1.  Существующего контроллера домена виртуальной машины загружается в низкоуровневой оболочке, поддерживающей ИД создания Виртуальной машины.  
  
    1.  Эта виртуальная машина не имеет существующих ИД создания виртуальной Машины значения заданного для объекта-компьютера Доменных службах Active Directory после повышения роли.  
  
    2.  Даже если оно равно null, следующее создание компьютера будет означать по-прежнему клоны, как несовпадения нового ИД создания виртуальной Машины.  
  
    3.  ИД создания виртуальной Машины задается после следующей перезагрузки контроллера домена и не реплицируется.  
  
2.  Виртуальная машина считывает ИД создания Виртуальной машины, предоставленный драйвером VMGenerationCounter. Она сравнивает эти два ИД создания Виртуальной машины.  
  
    1.  Если идентификаторы совпадают, это не является новой виртуальной машины и клонирование не выполняется. Если существует файл DCCloneConfig.xml, контроллер домена переименует его с отметкой времени и даты, чтобы предотвратить клонирование. Сервер продолжает загружаться в обычном режиме. Именно так проходит каждая перезагрузка любого виртуального контроллера домена в Windows Server 2012.  
  
    2.  Если два идентификатора не совпадают, то новой виртуальной машины, которая содержит NTDS. DIT из предыдущего контроллера домена (или он является восстановленным моментальным снимком). Если существует файл DCCloneConfig.xml, контроллер домена приступает к выполнению операций клонирования. В противном случае он продолжает выполнение операций восстановления моментального снимка. В разделе [архитектура виртуализированных контроллеров доменов безопасного восстановления](../../../ad-ds/get-started/virtual-dc/../../../ad-ds/get-started/virtual-dc/../../../ad-ds/get-started/virtual-dc/../../../ad-ds/get-started/virtual-dc/Virtualized-Domain-Controller-Architecture.md#BKMK_SafeRestoreArch).  
  
    3.  Если низкоуровневая оболочка не предоставляет ИД создания Виртуальной машины для сравнения, однако существует файл DCCloneConfig.xml, Гость переименовывает этот файл и загружается в режиме восстановления служб Каталогов, чтобы защитить сеть от дублирования контроллера домена. Если файл dccloneconfig.xml не, Гость загружается обычно (с возможностью дублирования контроллера домена в сети). Дополнительные сведения о способах освобождения этого дублирующегося контроллера домена, статье базы Знаний Майкрософт [2742970](https://support.microsoft.com/kb/2742970).  
  
3.  Служба NTDS проверяет имя значения реестра VDCisCloning DWORD (в разделе HKEY_Local_Machine\System\CurrentControlSet\Services\Ntds\Parameters).  
  
    1.  Если он отсутствует, это первая попытка клонирования для данной виртуальной машины. Гость применяет меры безопасности дублирования объектов Виртуального прекращение действия локального пула относительных ИДЕНТИФИКАТОРОВ и задать новый идентификатор вызова репликации для контроллера домена  
  
    2.  Если оно уже установлено значение 0x1, значит «повторная», попытка клонирования, которой произошел сбой предыдущая операция клонирования. Меры безопасности для дублирования объектов виртуального контроллера домена не применяются, как они уже должны были выполняться ранее и бы к ненужному изменению гостя несколько раз.  
  
4.  Имя значения реестра IsClone DWORD записывается (в разделе Hkey_Local_Machine\System\CurrentControlSet\Services\NTDS\Parameters)  
  
5.  Служба NTDS изменяет флаг загрузки гостя, чтобы для всех дальнейших загрузок осуществлялся запуск в режиме восстановления служб Каталогов.  
  
6.  Служба NTDS пытается считать файл DcCloneConfig.xml в одном из трех допустимых расположениях (рабочий каталог DSA, % windir%\NTDS или носитель съемных чтения и записи, в порядке букв диска).  
  
    1.  Если файл не существует во всех допустимых расположениях, Гость проверяет IP-адрес для дублирования. Если IP-адрес не дублирован, сервер загружается в обычном режиме. Если существует дублирующийся IP-адрес, то компьютер загружается в режиме DSRM, чтобы защитить сеть от дублирования контроллера домена.  
  
    2.  Если файл существует в допустимом расположении, служба NTDS проверяет его параметры. Если файл пуст (или пусты отдельные параметры) то NTDS автоматически настраивает значения для этих параметров.  
  
    3.  Если файл DcCloneConfig.xml существует, но содержит все недопустимые записи или не может быть прочитан, клонирование завершается ошибкой, а Гость загружается в режиме восстановления служб каталогов (DSRM).  
  
7.  Гость отключает все автоматической регистрации DNS, чтобы предотвратить случайный перехват имени исходного компьютера и IP-адресов.  
  
8.  Гость останавливает службу входа в сеть, чтобы предотвратить получение объявлений или ответ на сетевые запросы доменных служб Active Directory от клиентов.  
  
9. NTDS проверяет, что не существует службы или установленные программы, которые не являются частью DefaultDCCloneAllowList.xml или CustomDCCloneAllowList.xml  
  
    1.  Если присутствуют службы или установленные программы, которые не находятся в исключений по умолчанию список разрешенных или пользовательский список разрешенных исключений, клонирование завершается ошибкой, а Гость загружается в режиме DSRM, чтобы защитить сеть от дублирования контроллера домена.  
  
    2.  При отсутствии несовместимостей, клонирование продолжается.  
  
10. Если из-за пустых параметров сети в DCCloneConfig.xml будет использоваться автоматическая IP-адресация, Гость включает DHCP на сетевых адаптерах, чтобы получить IP аренды адресов, сетевой маршрутизации и сведений о разрешении имен.  
  
11. Гость находит и обращается к контроллеру домена, ролью FSMO эмулятора PDC. При этом используется служба DNS и протокол DCLocator. Подключение RPC и вызывается метод IDL_DRSAddCloneDC для клонирования объекта-компьютера контроллера домена.  
  
    1.  Если исходный объект-компьютер гостя содержит расширенное разрешение заголовка домена из «' разрешить контроллеру домена клонировать себя», клонирование продолжается.  
  
    2.  Если исходный объект-компьютер гостя содержит это расширенное разрешение, клонирование завершается ошибкой, а Гость загружается в режиме восстановления служб Каталогов, чтобы защитить сеть от дублирования контроллера домена.  
  
12. Имя объекта компьютера Доменных службах Active Directory устанавливается аналогичным имени, указанному в файле DCCloneConfig.xml, если есть, или создается автоматически в pdce. NTDS создает правильный объект параметров NTDS для подходящего логического сайта Active Directory.  
  
    1.  Если это PDC клонирования, затем Гость переименовывает локальный компьютер и перезагружается. После перезагрузки она снова выполняет шаги 1 – 10, после чего переходит к шагу 13.  
  
    2.  Если это реплики контроллера домена существует клонирования, перезагрузка не требуется на данном этапе.  
  
13. Гость предоставляет параметры повышения уровня службе сервера с ролью DS, которая запускает повышение.  
  
14. Служба сервера с ролью DS останавливает все AD DS-службы, связанные с (NTDS, NTFRS/DFSR, KDC, DNS).  
  
15. Гость принудительно NT5DS синхронизацию времени (Windows NTP) с другим контроллером домена (в стандартной иерархии службы времени Windows это означает использование PDCE). Гость обращается к PDCE. Все имеющиеся билеты Kerberos записываются на диск.  
  
16. Гость настраивает службы DFSR или NTFRS на автоматический запуск. Гость удаляет все имеющиеся файлы баз данных DFSR и NTFRS (по умолчанию: c:\windows\ntfrs и c:\system information\dfsr\\ тома*< database_GUID >*), чтобы принудительно не заслуживающую доверия синхронизацию SYSVOL при следующем запуске службы. Гость не удаляет содержимое файлов SYSVOL, чтобы предварительно задать SYSVOL начальное значение при последующем запуске синхронизации.  
  
17. Гость переименовывается. Службы сервера с ролью DS в госте начинает настройку Доменных (повышение уровня), с помощью существующего NTDS. Файл базы данных DIT как источника вместо шаблона базы данных, включенного в c:\windows\system32, как повышение обычно делает.  
  
18. Гость обращается к владельцу роли FSMO хозяина RID для получения нового распределения пула относительных ИДЕНТИФИКАТОРОВ.  
  
19. Процесс повышения уровня создает новый идентификатор вызова и воссоздает объект параметров NTDS для клонированного контроллера домена (независимо от клонирования это входит в состав повышения домена при использовании существующих NTDS. База данных DIT).  
  
20. NTDS реплицирует объекты, которые отсутствуют, новая имеют или более поздней версии, с партнерского контроллера домена. NTDS. DIT уже содержит объекты от времени перехода исходного контроллера домена в автономный режим, и они используются максимально чтобы свести к минимуму трафик репликации входящего трафика. Выполняется заполнение разделов глобального каталога.  
  
21. Служба DFSR или FRS, запускает и из-за не базы данных SYSVOL непринудительно синхронизирует входящие данные от партнера репликации. Этот процесс повторно использует существующие данные в папке SYSVOL, чтобы свести к минимуму сетевой трафик репликации.  
  
22. Теперь, когда компьютер с именем и сетевым однозначно, Гость повторно активирует регистрацию DNS-клиента.  
  
23. Гость запускает модули SYSPREP, указанные в DefaultDCCloneAllowList.xml <SysprepInformation> элемент, чтобы очистить ссылки на предыдущее имя компьютера и предыдущий идентификатор безопасности.  
  
24. Повышение уровня клонирования выполнено.  
  
    1.  Гость удаляет флаг загрузки DSRM, чтобы следующая загрузка проходила в обычном режиме.  
  
    2.  Гость переименовывает файл DCCloneConfig.xml, добавив отметку даты даты и времени, чтобы не считывался повторно при следующей загрузке.  
  
    3.  Гость удаляет имя значения реестра DWORD vdciscloning из раздела hkey_local_machine\system\currentcontrolset\services\ntds\parameters.  
  
    4.  Гость задает DWORD «VdcCloningDone» имя значения реестра в разделе HKEY_Local_Machine\System\CurrentControlSet\Services\NTDS\Parameters значение 0x1. Windows не использует это значение, но предоставляет его в качестве маркера сторонним разработчикам.  
  
25. Гость обновляет атрибут msDS-GenerationID в свой собственный клонированном объекте контроллера домена в соответствии с текущему ИД создания Виртуальной машины гостя.  
  
26. Выполняется перезапуск гостя. Теперь это обычный контроллер домена объявлений.  
  
## <a name="BKMK_SafeRestoreArch"></a>Архитектура виртуализованных контроллеров доменов безопасного восстановления  
  
### <a name="overview"></a>Обзор  
AD DS полагается на платформе низкоуровневой оболочки на предоставлении идентификатора **ИД создания Виртуальной машины** для обнаружения восстановления моментального снимка виртуальной машины. Службы AD DS изначально сохраняют значение этого идентификатора в своей базе данных (NTDS. DIT) при повышении роли контроллера домена. Когда администратор восстанавливает машину из предыдущего снимка, текущее значение ИД создания Виртуальной машины из виртуальной машины сравнивается со значением в базе данных. Если значения не совпадают, контроллер домена выполняет сброс Invocationid и отменяет пул относительных ИДЕНТИФИКАТОРОВ, чтобы предотвратить повторное использование номера последовательного обновления или создание дублирующихся субъектов безопасности. Существует два сценария, в которых возможно выполнение безопасного восстановления:  
  
-   Когда виртуальный контроллер домена запускается после моментальный снимок был восстановлен при отключенном  
  
-   При восстановлении снимка на запущенном виртуальном контроллере домена  
  
    Если Виртуализированный контроллер домена в моментальном снимке находится в состоянии приостановки, а не завершения работы, необходимо перезапустить службу AD DS, чтобы активировать новый запрос пула относительных ИДЕНТИФИКАТОРОВ. Можно перезапустить службу AD DS с помощью оснастки служб или с помощью Windows PowerShell (Restart-Service NTDS-force).  
  
Следующие разделы содержат описание безопасного восстановления подробно для каждого сценария.  
  
### <a name="safe-restore-detailed-processing"></a>Подробный процесс безопасного восстановления  
Блок-схеме ниже показано, как безопасное восстановление происходит при запуске после моментальный снимок был восстановлен при отключенном виртуального контроллера домена.  
  
![Архитектура виртуализированных контроллеров домена](media/Virtualized-Domain-Controller-Architecture/ADDS_VDC_VirtualizationSafeguardsDuringNormalBoot.png)  
  
1.  Когда виртуальная машина загружается после восстановления моментального снимка, оно получит новый ИД создания виртуальной Машины, заданный узлом низкоуровневой оболочки в связи с восстановлением моментального снимка.  
  
2.  Новый ИД создания Виртуальной машины из виртуальной машины сравнивается с ИД создания Виртуальной машины в базе данных. Поскольку два идентификатора не совпадают, применяются меры безопасности виртуализации (см. шаг 3 в предыдущем разделе). После завершения восстановления применение ИД создания Виртуальной машины задайте для объекта-компьютера Доменных службах Active Directory обновляется, чтобы соответствовать новому Идентификатору предоставленному узлом низкоуровневой оболочки.  
  
3.  Гость применяет меры безопасности виртуализации:  
  
    1.  Прекращение действия локального пула относительных ИДЕНТИФИКАТОРОВ.  
  
    2.  Установка нового идентификатора вызова для базы данных контроллера домена.  
  
> [!NOTE]  
> Эта часть безопасного восстановления аналогична процессу клонирования. Несмотря на то, что данный процесс предназначен для безопасного восстановления виртуального контроллера домена, когда он загружается после восстановления моментального снимка, те же действия выполняются во время процесса клонирования.  
  
На следующей схеме показано, как меры безопасности виртуализации предотвращают расхождение, вносимое откатом номера последовательного обновления при восстановлении снимка на запущенном виртуальном контроллере домена.  
  
![Архитектура виртуализированных контроллеров домена](media/Virtualized-Domain-Controller-Architecture/ADDS_VDC_VirtualizationSafeguardsDuringSnapShotRestore.png)  
  
> [!NOTE]  
> Предыдущая иллюстрация специально упрощена, чтобы продемонстрировать наиболее основные принципы.  
  
1.  В момент времени T1 администратор низкоуровневой оболочки получает моментальный снимок виртуального контроллера домена DC1. При этом DC1 имеет значение номера последовательного обновления (**highestCommittedUsn** на практике) из значением 100 и InvocationId (в виде идентификатор на предыдущей схеме) значением A (на практике это была бы GUID). Значение savedVMGID — ИД создания виртуальной Машины в файле DIT контроллера домена (хранится для объекта-компьютера контроллера домена в атрибуте с именем **msDS-GenerationId**). VMGID — это текущее значение ИД создания Виртуальной машины из драйвера виртуальной машины. Это значение предоставляется низкоуровневой оболочкой.  
  
2.  В поздний момент времени T2 для этого контроллера домена добавляется 100 пользователей (рассмотрим пользователей в качестве примера обновлений, которые могли иметь место на этом контроллере домена между моментами T1 и T2; эти обновления могут включать в себя создание пользователей, групп, обновления паролей, атрибутов и т. д). В этом примере каждое обновление использует один уникальный номер последовательного обновления (хотя на практике Создание пользователя может использовать более одного номера последовательного обновления). Перед фиксацией этих обновлений DC1 проверяет, если значение ИД создания виртуальной Машины в его базе данных (savedVMGID) совпадает с текущим значением в драйвере (VMGID). Они совпадают, так как произошло никакого отката, поэтому обновления фиксируются, а номер последовательного обновления доводится до значения 200, указывая, что следующее обновление может использовать номер 201. Не изменяется в InvocationId, savedVMGID и VMGID. Эти обновления реплицируются на DC2 в рамках следующего цикла репликации. DC2 обновляет верхний предел (и **UptoDatenessVector**) представленный здесь просто как DC1(A) @USN = 200. То есть DC2 оповещен обо всех обновлениях из DC1 в контексте идентификатора InvocationId A до номера последовательного обновления 200.  
  
3.  В момент времени T3 моментальный снимок, полученный в момент времени T1, применяется к DC1. DC1 выполнен откат, поэтому его номер последовательного обновления вернулся к 100, указывая, что он может использовать номера с 101 для сопоставления с последующими обновлениями. Тем не менее на этом этапе значение vmgid было бы другим в низкоуровневых оболочках, которые поддерживают ИД создания виртуальной Машины.  
  
4.  Впоследствии когда DC1 выполняет любое обновление, он проверяет, совпадает ли значение ИД создания Виртуальной машины, в его базе данных (savedvmgid со) значением в драйвере виртуальной машины (VMGID). В этом случае это не так же, поэтому DC1 расценивает это как признак отката и активирует меры безопасности виртуализации; Другими словами, он сбрасывает свой InvocationId (ID = B) и отменяет пул относительных ИДЕНТИФИКАТОРОВ (не показан на предыдущей схеме). Он сохраняет новое значение VMGID в своей базе данных и фиксирует эти обновления (USN 101 — 250) в контексте нового InvocationId B. В ходе следующего цикла репликации DC2 ничего не знает из DC1 в контексте InvocationId B, поэтому все, что он запрашивает из DC1, связанные с InvocationID B. В результате осуществляется безопасное объединение обновлений, выполненных на DC1 после применения моментального снимка. Кроме того набор обновлений, выполненных на DC1 в момент времени T2 (которые были потеряны на DC1 после восстановления снимка), будут реплицированы обратно на DC1 при следующей запланированной репликации, так как они были реплицированы на DC2 (что показано пунктирной линией, возвращающейся к DC1).  
  
После гостем мер безопасности виртуализации NTDS реплицирует различия во входящих объектах Active Directory непринудительно, с партнерского контроллера домена. Вектор синхронизации конечного сервера службы каталогов обновляется соответствующим образом. После этого Гость синхронизирует SYSVOL:  
  
-   При использовании FRS Гость останавливает службу NTFRS и задает значение реестра D2 BURFLAGS. Затем она запускает службу NTFRS, которая непринудительно реплицирует входящие, повторное использование существующих данные неизмененные данные SYSVOL, когда это возможно.  
  
-   Если используется DFSR, Гость останавливает службу DFSR и удаляет файлы базы данных DFSR (расположение по умолчанию: %systemroot%\system тома information\dfsr\\*<database GUID>*). Затем она запускает службу DFSR, которая непринудительно реплицирует входящие, повторное использование существующих данные неизмененные данные SYSVOL, когда это возможно.  
  
> [!NOTE]  
> -   Если низкоуровневая оболочка не предоставляет ИД создания Виртуальной машины для сравнения, низкоуровневая оболочка не поддерживает меры безопасности виртуализации, и Гость будет работать виртуализированного контроллера домена под управлением Windows Server 2008 R2 или более ранних версий. Гость реализует карантинную защиту отката номера последовательного обновления при наличии попытки запустить репликацию с номерами последовательного обновления, не превышающими последний наибольший номер был зарегистрирован партнерским контроллером домена. Дополнительные сведения о карантинной защите отката номера последовательного обновления см. в разделе [USN и откат USN](https://technet.microsoft.com/library/virtual_active_directory_domain_controller_virtualization_hyperv(WS.10).aspx)  
  


