---
Title: Виртуализация контроллеров домена, с помощью Hyper-V
description: Факторы, которые необходимо принять при виртуализации контроллеров доменов Windows Server Active Directory в Hyper-V
author: MicrosoftGuyJFlo
ms.author: joflore
ms.date: 04/19/2018
ms.topic: article
ms.prod: windows-server-threshold
ms.openlocfilehash: 684f3418bf336af4959282e7a8c2088d22a8c8dc
ms.sourcegitcommit: 0d0b32c8986ba7db9536e0b8648d4ddf9b03e452
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2019
ms.locfileid: "59865135"
---
# <a name="virtualizing-domain-controllers-using-hyper-v"></a>Виртуализация контроллеров домена, с помощью Hyper-V

> Относится к: Windows Server 2016

В этом разделе будет обновляться, чтобы сделать рекомендации применимы к Windows Server 2016. Windows Server 2012 содержит множество улучшений для виртуализированных контроллеров домена (DC), включая защиту отката номера последовательного обновления на виртуальных контроллеров домена и возможность их клонирования виртуальных контроллеров домена. Дополнительные сведения об этих улучшениях см. в разделе [введение в виртуализацию доменных служб Active Directory (AD DS) (уровень 100)](../../introduction-to-active-directory-domain-services-ad-ds-virtualization-level-100.md).

Hyper-V объединяет различных ролей сервера на одном физическом компьютере. Это руководство описывает контроллеры домена выполняются как 32-разрядная или 64-разрядных гостевых операционных систем.

## <a name="planning-to-virtualize-domain-controllers"></a>Планирование виртуализации контроллеров домена

В этом разделе рассматриваются требования к оборудованию для сервера Hyper-v, как избежать единых точек отказа, выбор соответствующего типа конфигурации для серверов Hyper-V и виртуальных машин и решений безопасности и производительности.

## <a name="hyper-v-requirements"></a>Требования к Hyper-V

Чтобы установить и использовать роль Hyper-V, необходимо иметь следующее:

   - **X x64 процессора**
      - Hyper-V доступен в x64-разрядных версий Windows Server 2008 или более поздней версии.  
   - **Аппаратная поддержка виртуализации**
      - Эта функция доступна в процессорах, имеющих функцию виртуализации, в частности, технология виртуализации Intel (Intel VT) или AMD Virtualization (AMD-V).  
   - **Предотвращения выполнения данных оборудования (DEP)**
      - Оборудования DEP должен быть доступен и включен. В частности, необходимо включить разряд Intel XD (атрибут отключения выполнения) или AMD NX (разряд запрета исполнения).  

## <a name="avoid-creating-single-points-of-failure"></a>Не следует создавать единые точки отказа

Следует избегать создания потенциальных единых точек отказа, при планировании развертывания контроллера домена. Общие сведения о потенциальных единых точек отказа, реализовав избыточности системы можно избежать. Например учитывайте следующие рекомендации, учитывая возможное увеличение затраты на администрирование:

1. Выполните по крайней мере два виртуализированных контроллеров домена в домене на узлах разных виртуализации, что снижает риск потери всех контроллеров домена, при сбое одного хост.  
2. Согласно рекомендациям для других технологий, необходимо изменить оборудование (с использованием разных процессоров, материнских плат, сетевых адаптеров или других устройств), на какие контроллеры домена работают под управлением. Оборудование диверсификации ограничивают ущерб, который может быть вызвано неправильной работы, которая относится к конфигурации поставщика, драйвер, или один элемент или типа оборудования.  
3. Если это возможно контроллеры домена должна быть запущена на оборудовании, которое находится в разных регионах мира. Это позволяет уменьшить влияние аварии или сбое, которое влияет на сайт, в котором размещены контроллеры домена.  
4. Ведение физических контроллеров домена в каждом из доменов. Это уменьшает риск сбоя платформы виртуализации, которая влияет на все системы узлов, использующих эту платформу.  

## <a name="security-considerations"></a>Замечания по безопасности

Главного компьютера, на котором работают виртуальные контроллеры домена должны работать под тщательно, как контроллер домена с возможностью записи, даже если этот компьютер является только присоединенных к домену или рабочей группе. Это сделано из соображений безопасности. Mismanaged узла становится уязвимым для атаки повышение прав доступа, которое происходит, когда пользователь-злоумышленник доступ прибыли и системные права, которые не были прав или законным образом назначить. Пользователь-злоумышленник можно использовать этот тип атаки злоумышленнику все виртуальные машины, доменов и лесов, узлы этого компьютера.

Убедитесь в том, что следующие рекомендации по безопасности при учитывайте планируется виртуализировать контроллеры домена:

   - Локальный администратор компьютера, на котором размещается виртуальный, доступный для записи домена, контроллеров следует учитывать эквивалентного учетные данные администратора домена по умолчанию все домены и леса, которые принадлежат те контроллеры домена.  
   - Чтобы избежать проблем безопасности и производительности рекомендуется узле под управлением установки Server Core Windows Server 2008 или более поздней версии, без приложений, отличных от Hyper-V. Такая конфигурация ограничивает количество приложений и служб, установленных на сервере, что должно привести повышения производительности и меньшее количество приложений и служб, которые могут быть использованы злоумышленником для атак на компьютере или в сети. Последствия такая конфигурация называется сокращение возможных направлений атак. В филиале или другим размещениям, где не может быть защищена неудовлетворительно рекомендуется использовать контроллер домена только для чтения (RODC). Если раздельное управление сеть существует, мы рекомендуем, что узел подключены только к сети управления.  
   - Bitlocker можно использовать с контроллерами домена, так как Windows Server 2016 можно использовать функцию виртуального доверенного платформенного МОДУЛЯ, чтобы также предоставляют материал ключа гостевой разблокировать системный том.
   - [Защищенных структуры и экранированных виртуальных машин](/it-server/WindowsServerDocs/virtualization/guarded-fabric-shielded-vm/guarded-fabric-and-shielded-vms.md) может предоставить дополнительные элементы управления для защиты контроллеров домена.

Сведения о RODC, см. в разделе [планирования контроллера домена только для чтения и руководство по развертыванию](../../deploy/rodc/read-only-domain-controller-updates.md).

Дополнительные сведения о защите контроллеров домена см. в разделе [рекомендации по защите установок Active Directory](../../plan/security-best-practices/best-practices-for-securing-active-directory.md).

## <a name="security-boundaries-for-different-host-and-guest-configurations"></a>Границы безопасности для другого узла и конфигурации гостевого

С помощью виртуальных машин позволяет иметь множество разные конфигурации контроллеров домена. Предоставить тщательного анализа того, что виртуальные машины влияют на границ и отношения доверия в топологии Active Directory. В следующей таблице описаны возможные конфигурации для контроллера домена Active Directory и узлов (Hyper-V server) и его гостевые компьютеры (виртуальные машины на сервере Hyper-V).

|Компьютер|Конфигурация 1|Configuration 2|
|-------|---------------|---------------|
|Hyper-V|Компьютер рабочей группы или элемента|Компьютер рабочей группы или элемента|
|Гость|Контроллер домена|Компьютер рабочей группы или элемента|

![](media/virtualized-domain-controller-architecture/Dd363553.f44706fd-317e-4f0b-9578-4243f4db225f(WS.10).gif)

   - Администратор на главном компьютере, имеет такой же доступ с правами администратора домена на гостевых машинах контроллера домена с возможностью записи и должна обрабатываться таким же образом. В случае гостевой RODC администратор компьютера имеет тот же уровень доступа учетной записи локального администратора на гостевом компьютере RODC.   
   - Контроллер домена в виртуальной машине с правами администратора на узле, при присоединении узла к тому же домену. Есть возможность злоумышленнику нарушить безопасность всех виртуальных машин, если пользователь-злоумышленник сначала получает доступ к виртуальной машине 1. Это называется атаки. Если контроллеры домена для нескольких доменов или лесов, эти домены должны иметь возможность централизованного администрирования, в котором администратор одного домена является доверенным для всех доменов.  
   - Возможности для атаки с 1 виртуальной машины существует, даже если 1 виртуальной машины устанавливается как RODC. Несмотря на то, что явно администратора RODC, не имеет права администратора домена, RODC может использоваться для отправки политик на главном компьютере. Эти политики могут включать сценарии запуска. При успешном выполнении эта операция может быть нарушена главного компьютера и затем может использоваться для компрометации других виртуальных машин на главном компьютере.  

## <a name="security-of-vhd-files"></a>Безопасность файлов виртуального жесткого диска

Файл виртуального жесткого диска из виртуального контроллера домена соответствует физический жесткий диск из физический контроллер домена. Таким образом он должен быть защищен при одинаковом объеме лечение разбирает Защита жесткого диска физический контроллер домена. Убедитесь, что только администраторы надежную и проверенную разрешен доступ к контроллеру домена VHD-файлы.

## <a name="rodcs"></a>RODC

Одно из преимуществ RODC является возможность помещать их в расположениях, где физическая безопасность не гарантируется, такие как в офисах филиалов. Шифрование диска Windows BitLocker можно использовать для защиты сами файлы виртуального жесткого диска (не файловых систем этой последовательности) от компрометации на узле посредством кражи физического диска. 
<!-- Removed link to Windows Server 2008 Hyper-V and BitLocker Drive Encryption (http://go.microsoft.com/fwlink/?linkid=123534). Link is dead. -->

## <a name="performance"></a>Производительность

Новый 64-разрядной архитектуре микроядра существуют значительное увеличение производительности Hyper-V из предыдущих платформ виртуализации. Для наилучшей производительности узла узел должен быть установки Server Core Windows Server 2008 или более поздней версии и не должны иметь ролей сервера, отличных от Hyper-V установлена.

Производительность виртуальных машин специально зависит от рабочей нагрузки. Чтобы обеспечить приемлемую производительность Active Directory, проверка конкретных топологиях. Оценка текущей рабочей нагрузки за период времени с помощью такого средства, как надежность и производительность монитора (Perfmon.msc) или [набора средств Microsoft Assessment and Planning (MAP)](https://go.microsoft.com/fwlink/?linkid=137077). Средство MAP также может быть полезен, если вы хотите провести инвентаризацию всех серверов и ролей сервера, которые в настоящее время существуют в вашей сети.

Чтобы получить общее представление о производительности виртуализированных контроллеров домена, следующие тесты производительности были выполнены с [средства Active Directory производительность тестирования (ADTest.exe)](https://go.microsoft.com/fwlink/?linkid=137088).

Упрощенный Directory Access Protocol (LDAP) выполнялись тесты на физический контроллер домена с ADTest.exe, а затем на виртуальной машине, которое было размещено на сервере, который был идентичен физический контроллер домена. Только один логический процессор был использован для физического компьютера, и только один виртуальный процессор был использован для виртуальной машины легко достичь 100-процентное использование ресурсов ЦП. В следующей таблице буквы и числа в скобках после каждого теста указывать на этот конкретный тест ADTest.exe. Как показано в этих данных, производительность контроллера домена виртуализированных был 88 для 98 процентов производительность контроллера физического домена.

<table>
<colgroup>
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
</colgroup>
<thead>
<tr class="header">
<th>Измерения</th>
<th>Тестирование</th>
<th>Физическое движение</th>
<th>виртуальный</th>
<th>дельта</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>Поиск в секунду</p></td>
<td><p>Поиск общего имени в базовую область (L1)</p></td>
<td><p>11508</p></td>
<td><p>10276</p></td>
<td><p>-10.71%</p></td>
</tr>
<tr class="even">
<td><p>Поиск в секунду</p></td>
<td><p>Поиск набора атрибутов в базовую область (L2)</p></td>
<td><p>10123</p></td>
<td><p>9005</p></td>
<td><p>-11.04%</p></td>
</tr>
<tr class="odd">
<td><p>Поиск в секунду</p></td>
<td><p>Поиск для всех атрибутов в базовую область (L3)</p></td>
<td><p>1284</p></td>
<td><p>1242</p></td>
<td><p>-3.27%</p></td>
</tr>
<tr class="even">
<td><p>Поиск в секунду</p></td>
<td><p>Поиск общего имени в поддерева (уровне 6)</p></td>
<td><p>8613</p></td>
<td><p>7904</p></td>
<td><p>-8.23%</p></td>
</tr>
<tr class="odd">
<td><p>Успешной привязки в секунду.</p></td>
<td><p>Выполнить быстрый привязки (B1)</p></td>
<td><p>1438</p></td>
<td><p>1374</p></td>
<td><p>-4.45%</p></td>
</tr>
<tr class="even">
<td><p>Успешной привязки в секунду.</p></td>
<td><p>Выполните простой привязки (B2)</p></td>
<td><p>611</p></td>
<td><p>550</p></td>
<td><p>-9.98%</p></td>
</tr>
<tr class="odd">
<td><p>Успешной привязки в секунду.</p></td>
<td><p>Используйте NTLM для выполнения привязывает (B5)</p></td>
<td><p>1068</p></td>
<td><p>1056</p></td>
<td><p>-1.12%</p></td>
</tr>
<tr class="even">
<td><p>Операции записи в секунду</p></td>
<td><p>Запись нескольких атрибутов (W2)</p></td>
<td><p>6467</p></td>
<td><p>5885</p></td>
<td><p>-9.00%</p></td>
</tr>
</tbody>
</table>

Чтобы обеспечить приемлемую производительность, компоненты интеграции (IC) были установлены, чтобы разрешить гостевой операционной системы для использования «просветления» или низкоуровневой оболочки с поддержкой синтетических драйверов. Во время установки может потребоваться использовать эмулированные драйверы адаптера Drive Electronics Интегрированной или сети. В производственной среде необходимо заменить эти эмулированные драйверы синтетических драйверов для повышения производительности.

При отслеживании производительности виртуальных машин с помощью надежности и производительности Manager (Perfmon.msc), на виртуальной машине информацию о ЦП не будет точным, из-за того, который виртуальный ЦП запланировано в физическом процессоре. Если вы хотите получить информацию о ЦП для виртуальной машины, на котором выполняется на сервере Hyper-V, используйте счетчики логического процессора низкоуровневой оболочки Hyper-V в разделу узла.

Дополнительные сведения о производительности настройке AD DS и Hyper-V, см. в разделе [производительности настройке рекомендации для Windows Server 2016](../../../../administration/performance-tuning/index.md).
<!-- Updated to 2016 perf guidance -->

Кроме того не планируется использовать разностный диск VHD на виртуальной машине, настроенный в качестве контроллера домена, так как разностный диск VHD может снизить производительность. Дополнительные сведения о типах дисков Hyper-V, в том числе разностных дисков, см. в разделе [мастера создания виртуального жесткого диска](http://go.microsoft.com/fwlink/?linkid=137279).
<!-- Couldn't find an equivalent WS 2016 Hyper-V article. -->

Дополнительные сведения о Доменных службах Active Directory в виртуальных средах размещения, см. в разделе [которые следует учитывать при размещении контроллеров домена Active Directory в виртуальных средах размещения](https://go.microsoft.com/fwlink/?linkid=141292) в базе знаний Майкрософт.

## <a name="deployment-considerations-for-virtualized-domain-controllers"></a>Вопросы развертывания для виртуализированных контроллеров домена

Существует ряд общих рекомендаций виртуальной машины, которых следует избегать при развертывании контроллеров домена и особые рекомендации по синхронизации времени и хранения.

## <a name="virtualization-deployment-practices-to-avoid"></a>Виртуализация развертывания нерекомендуемые методы

Платформы виртуализации, таких как Hyper-V, предлагают ряд компонентов, которые делают управление, обслуживание, резервное копирование и перенос компьютеров проще. Тем не менее следующие распространенные приемы и возможности не следует учитывать для виртуальных контроллеров домена.

   - Чтобы обеспечить надежность операций записи Active Directory, не следует развертывать виртуального контроллера домена в файлы базы данных (базы данных Active Directory (NTDS. Дерево КАТАЛОГОВ), журналы и SYSVOL) на виртуальных дисках интегрированной среды разработки. Вместо этого создать второй виртуальный жесткий ДИСК подключен к контроллеру SCSI и убедитесь, что базы данных, журналов и SYSVOL размещаются на диск SCSI виртуальной машины во время установки контроллера домена.  
   - Не следует реализовывать разностного диска виртуальные жесткие диски (VHD) на виртуальной машине, который настраивается в качестве контроллера домена. Это делает слишком легко вернуться к предыдущей версии, и она также снижает производительность. Дополнительные сведения о типах виртуального жесткого диска, см. в разделе [мастера создания виртуального жесткого диска](https://go.microsoft.com/fwlink/?linkid=137279).  
   - Не следует развертывать новые Active Directory — домены и леса на копию операционной системы Windows Server, который сначала не подготовлен с помощью программы подготовки системы (Sysprep). Дополнительные сведения о запуске Sysprep см. в разделе [Обзор Sysprep (System Preparation)](https://docs.microsoft.com/windows-hardware/manufacture/desktop/sysprep--system-preparation--overview)

      > [!WARNING]
      > Запустите программу Sysprep на контроллере домена не поддерживается.

   - Чтобы избежать потенциальных последовательности обновления ситуации отката номер (USN), не используйте копии VHD-файл, который представляет контроллер домена уже развернутых развертывание дополнительных контроллеров домена. Дополнительные сведения об откате USN см. в разделе [USN и откат USN](#usn-and-usn-rollback).
      - Windows Server 2012 и более поздних версий позволяет администраторам для клонирования образов контроллера домена, если подготовлена должным образом, когда им требуется развертывание дополнительных контроллеров домена
   - Не используйте функцию экспорта Hyper-V для экспорта виртуальной машины, на котором работает контроллер домена.
      - В Windows Server 2012 и более поздних экспорта и импорта гостевой виртуальный контроллер домена обрабатывается как непринудительное восстановление, так как он обнаруживает изменение ИД создания, и она не настроена для клонирования.
      - Убедитесь, что Гость, который вы экспортировали больше не используется.
  - Вы можете использовать репликации Hyper-V сохранять копию второго неактивного контроллера домена. При запуске реплицированных образа, необходимо также для выполнения правильной очистки для этой же причине не с помощью источника после экспорта образ гостевой контроллера домена.

## <a name="physical-to-virtual-migration"></a>Перенос физических в виртуальные

System Center Virtual Machine Manager (VMM) 2008 обеспечивает единообразное управление физических компьютеров и виртуальных машин. Он также предоставляет возможность переносить физического компьютера в виртуальную машину. Этот процесс известен как преобразование физических в виртуальные машины (преобразование P2V). Во время преобразования P2V, новой виртуальной машины и физический контроллер домена переноса не выполняется в то же время, чтобы избежать ситуации отката USN, как описано в разделе [USN и откат USN](#usn-and-usn-rollback).

Следует выполнять преобразования P2V, в автономном режиме, что данные каталога обеспечивает согласованность при контроллер домена снова включен. Параметр автономного режима, используется предлагаются и рекомендациями, приведенными в мастер преобразования физических серверов. Описание разницу между оперативном режиме и в автономном режиме, см. в разделе [P2V: Преобразование физических компьютеров в виртуальные машины в VMM](https://go.microsoft.com/fwlink/?linkid=155072). Во время преобразования P2V виртуальной машины не должен быть подключен к сети. Сетевой адаптер виртуальной машины должен быть включен только в том случае, после процесса преобразования P2V, завершения и проверки. На этом этапе погаснут физического исходного компьютера. Не подключайте исходный физический компьютер обратно в сеть снова перед переформатировать жесткий диск.

> [!NOTE]
> Существуют более безопасные параметры, для создания новых виртуальных контроллеров домена, которые не выполняются риск создания отката номера последовательного обновления. Вы можете настроить новый виртуальный контроллер домена по продвижению регулярных, переходе от установки с носителя (IfM), а также с помощью клонирования контроллера домена, если у вас уже есть по крайней мере один виртуальный контроллер домена.
Это также помогает избежать проблем с оборудованием или проблем, связанных с платформы в результате преобразования P2V гостевые виртуальные машины могут возникнуть.

> [!WARNING]
> Для предотвращения проблем с репликацией Active Directory, убедитесь, что только один экземпляр (физический или виртуальный) в данном домене контроллер существует в данной сети в любой момент времени.
> Чтобы снизить вероятность старые копии, что проблема:
> 
> - Когда новый виртуальный контроллер домена работает под управлением, изменить пароль учетной записи компьютера, который дважды с использованием: netdom resetpwd/Server: < домен >...
> - Экспортировать и импортировать новый виртуальный гость принудительно становится новый ИД создания а следовательно вызов базы данных по идентификатору.
> 

## <a name="using-p2v-migration-to-create-test-environments"></a>С помощью P2V-миграции для создания тестовых сред

P2V-миграции с помощью VMM можно использовать для создания тестовых сред. Контроллеры домена в рабочей среде можно перенести из физических компьютеров для виртуальных машин для создания тестовой среды без окончательно отключения производственных контроллеров домена. Тем не менее среда тестирования необходимо в другой сети в рабочей среде, если два экземпляра одного контроллера домена должны существовать. Необходимо соблюдать осторожность при создании тестовых сред с P2V migration во избежание откатов USN, которые могут повлиять на вашей тестовой и рабочей средах. Ниже приведен метод, который можно использовать для создания тестовых сред с помощью P2V.

Один контроллер домена в рабочей среде, в каждом домене переносится в тестовую виртуальную машину с помощью P2V в соответствии с рекомендациями, перечисленным в разделе миграции физических в виртуальные. Физических рабочих компьютеров и тестовые виртуальные машины должны находиться в разных сетях, когда они находятся в оперативный режим. Чтобы избежать отката номера последовательного обновления в тестовой среде, все контроллеры домена, которые перемещаются из физических компьютеров в виртуальные машины необходимо перевести в автономный режим. (Это делается путем остановки службы ntds или перезагрузки компьютера в режиме восстановления служб каталогов (DSRM).) После контроллеры домена находятся в автономном режиме, нет новых обновлений должны быть предоставлены в среде. Компьютеры должны остаются в автономном режиме во время миграции P2V; ни один из компьютеров должны быть вернется в оперативный режим, пока не были полностью перенесены все компьютеры. Дополнительные сведения об откате USN см. в разделе USN и откат USN.

Последующие контроллеров домена должны быть повышены до реплик в тестовой среде.

## <a name="time-service"></a>Служба времени

Для виртуальных машин, настроенных как контроллеры домена рекомендуется отключить синхронизации времени системы и гостевой операционной системы в качестве контроллера домена. Это позволяет гостевой контроллер домена для синхронизации времени в иерархии домена.

Чтобы отключить службу синхронизации времени Hyper-V, завершите работу виртуальной Машины и снимите флажок синхронизации времени в службы Integration Services.

> [!NOTE]
> В этом руководстве было недавно обновлено в соответствии с текущей рекомендацию, чтобы синхронизировать время для гостевой контроллер домена из иерархии доменов, а не предыдущей рекомендацией для частично отключить функцию синхронизации времени между узлом контроллер домена, системы и гостя.

## <a name="storage"></a>Хранилище

Чтобы оптимизировать производительность виртуальной машины контроллера домена и обеспечить надежность операций записи Active Directory, используйте следующие рекомендации для хранения операционной системы, Active Directory и VHD-файлы:

   - **Гостевое хранилище**. Store, файл базы данных Active Directory (Ntds.dit), файлы журналов и SYSVOL файлов на виртуальный диск с файлы операционной системы. Создайте второй виртуальный жесткий ДИСК подключен к контроллеру SCSI и хранения базы данных, журналов и SYSVOL на виртуальном диске SCSI виртуальной машины. Виртуальные диски SCSI обеспечивают повышенную производительность по сравнению с виртуального интегрированной среды разработки и поддерживают Forced Unit Access (FUA). FUA гарантирует, что операционная система записывает и считывает данные непосредственно с носителя, минуя все механизмы кэширования.

   > [!NOTE]
   > Если вы планируете использовать Bitlocker для гостевой виртуальный контроллер домена, необходимо убедиться, что дополнительные тома необходимо настраивать для «auto».
   > Дополнительные сведения о настройке автоматической разблокировки можно найти в [Enable BitLockerAutoUnlock](https://docs.microsoft.com/powershell/module/bitlocker/enable-bitlockerautounlock)

   - **Размещать хранилище файлов виртуального жесткого диска**. Рекомендуемые действия. Размещать хранилище адрес рекомендаций хранения VHD-файлов. Для достижения максимальной производительности не храните файлы виртуального жесткого диска на диске, который часто используется другими службами или приложениями, например системный диск, на котором установлена операционная система Windows узла. Store каждого файла виртуального жесткого диска на отдельный раздел из операционной системы и другие файлы виртуального жесткого диска. — Это идеальная для хранения каждого файла виртуального жесткого диска на отдельном физическом диске.  

    Физический диск системы также должен удовлетворять **по крайней мере один** из следующих критериев в соответствии с требованиями Виртуализированная рабочая нагрузка целостности данных:  

      - Система использует диски серверного уровня (SCSI, Fibre Channel).  
      - Система гарантирует, что диски подключены к резервным кэширования адаптер шины (HBA).  
      - Система использует контроллера хранилища (например, систему RAID) в качестве устройства хранения.  
      - Система гарантирует, что power на диск защищен с источником бесперебойного питания (ИБП).  
      - Система гарантирует, что диска кэширование отключается.  

   - **Фиксированный VHD, а не транзитные диски**. Существует много способов настройки хранилища для виртуальных машин. При использовании VHD-файлы виртуальных жестких дисков фиксированного размера более эффективно, чем динамические виртуальные жесткие диски, так как при их создании выделена память для виртуальных жестких дисков фиксированного размера. Транзитные диски, какие виртуальные машины можно использовать для доступа к мультимедиа физического хранилища, еще более оптимизированы для повышения производительности. Транзитные диски по сути, физических дисков или логических номеров (устройств LUN), подключенных к виртуальной машине. Транзитные диски не поддерживают функции создания моментальных снимков. Таким образом транзитные диски являются предпочтительным конфигурация жесткого диска, потому что не рекомендуется использовать моментальные снимки с контроллерами домена.  

Чтобы уменьшить вероятность повреждения данных Active Directory, используйте виртуальные SCSI-контроллеры:

   - Используйте физические диски SCSI (в отличие от дисков IDE/ATA) на серверах Hyper-V, на которых размещены виртуальные контроллеры домена. Если нельзя использовать диски SCSI, убедитесь, что кэширование записи отключено на дисках ATA/IDE, на которых размещены виртуальные контроллеры домена. Дополнительные сведения см. в разделе [1539 идентификатор события — целостности базы данных](https://go.microsoft.com/fwlink/?linkid=162419).
   - Чтобы гарантировать устойчивость Active Directory записывает, базы данных Active Directory, журналов и SYSVOL необходимо поместить на виртуальный диск SCSI. Виртуальные диски SCSI поддерживают Forced Unit Access (FUA). FUA гарантирует, что операционная система записывает и считывает данные непосредственно с носителя, минуя все механизмы кэширования.  

## <a name="operational-considerations-for-virtualized-domain-controllers"></a>Рабочие соображения о виртуализированных контроллеров домена

Контроллеры домена, работающие на виртуальных машинах имеют эксплуатационные ограничения, которые не применяются к контроллерам домена, работающих под управлением на физических компьютерах. При использовании виртуализированного контроллера домена, существуют некоторые функции программного обеспечения виртуализации и рекомендации, которые не следует использовать:

   - Не приостановить, остановить, или хранить сохраненное состояние контроллера домена в виртуальной машине для периодов времени, больше времени, чем время жизни захоронения леса и возобновить в сохраненном или приостановленном состоянии. Это может препятствовать репликации. Узнайте, как определить время жизни захоронения леса, см. в разделе [определить время жизни захоронения леса](https://go.microsoft.com/fwlink/?linkid=137177).  
   - Не копируйте и не клонируйте виртуальные жесткие диски (VHD). Даже при наличии меры защиты, в отношении гостевой виртуальной Машине отдельных виртуальных жестких дисков по-прежнему могут быть скопированы и вызвать откат номера последовательного обновления.
   - Не использовать или не использовать моментальный снимок виртуального контроллера домена. С технической точки зрения поддерживается в Windows Server 2012 и более поздних версиях это не является заменой хорошая стратегия резервного копирования. Существует несколько причин для создания моментальных снимков контроллера домена или восстановление моментальных снимков.
   - Не используйте разностный диск VHD на виртуальной машине, настроенный в качестве контроллера домена. В результате возврат к предыдущей версии слишком просто, и она также снижает производительность.  
   - Не используйте функцию экспорта на виртуальной машине, на котором работает контроллер домена.  
   - Не восстановить контроллер домена или попытка отката содержимого базы данных Active Directory любыми средствами без использования резервной копии поддерживается. Дополнительные сведения см. в разделе [резервное копирование и восстановление рекомендации для виртуализированных контроллеров домена](#backup-and-restore-practices-to-avoid).  

Чтобы помочь защититься от отката обновления последовательности чисел (USN) создаются все эти рекомендации. Дополнительные сведения об откате USN см. в разделе USN и откат USN.

## <a name="backup-and-restore-considerations-for-virtualized-domain-controllers"></a>Резервное копирование и восстановление рекомендации для виртуализированных контроллеров домена

Резервное копирование контроллеров домена является важным требованием для любой среды. Резервное копирование защищает от потери данных в случае сбоя контроллера домена или административных ошибок. При возникновении такого события, необходимые для отката состояния системы контроллера домена до точки во времени до сбоя или ошибки. Поддерживаемый метод восстановления контроллера домена в работоспособное состояние, — использовать Active Directory совместимые с приложением резервного копирования, например архивации данных Windows Server, чтобы восстановить резервную копию состояния системы, которая была создана из текущей установки домена контроллер. Дополнительные сведения об использовании архивации данных Windows Server с доменными службами Active Directory (AD DS) см. в разделе [AD DS архивации и восстановления Пошаговое руководство по использованию](https://go.microsoft.com/fwlink/?LinkId=138501).

С помощью технологии виртуальных машин определенные требования Active Directory восстановить операции взгляд на добавленный значимости. Например если восстановить контроллер домена, используя копию файла виртуального жесткого диска (VHD), пользователю не нужно критические обновления версии базы данных контроллера домена после его восстановления. Репликация будет продолжена с номерами нежелательного отслеживания, приводит к Несогласованная база данных между репликами контроллера домена. В большинстве случаев эта проблема не обнаруживается системой репликации, и ошибки не обнаружены, несмотря на несоответствия между контроллерами домена.

Есть один поддерживаемый способ выполнить резервное копирование и восстановление виртуализированного контроллера домена:

1. Запустите архивации данных Windows Server в гостевой операционной системы.  

С помощью Windows Server 2012 и более новые узлы Hyper-V и гостевых систем резервные копии могут быть поддерживаемых контроллеров домена, с помощью моментальных снимков, гостевой виртуальной Машины экспорта и импорта и также репликации Hyper-V. Все они тем не менее не подходит для создания правильного журнала резервного копирования, с помощью небольшое исключение экспорта гостевой виртуальной Машины.

С Windows Server 2016 Hyper-V имеется поддержка «моментальный снимок рабочей среде», которой на сервере Hyper-V запускает резервное копирование на основе VSS гостя и, когда гостевой ОС выполняется с моментальным снимком, узел извлекает виртуальные жесткие диски и сохраняет их в папку резервной копии.

Это работает с Windows Server 2012 и более поздних, то есть несовместимость с Bitlocker:

- При выполнении привязки VSS снимок, AD хочет выполнить задачу после создания моментального снимка база данных помечается как поступающих из резервной копии, или в случае Подготовка исходного Носителя для RODC, удалите учетные данные из базы данных.
- Если Hyper-V монтирует том помещать для выполнения этой задачи, не существует средств, может разблокировать том для незашифрованный доступ. Поэтому ядро базы данных AD завершается ошибкой доступа к базе данных и завершится сбоем моментального снимка.

> [!NOTE]
> Экранированной виртуальной Машины проекта упомянутых ранее имеет узел Hyper-V, на основе резервной копии, как без целевой-для максимальной защиты данных гостевой виртуальной Машины.

## <a name="backup-and-restore-practices-to-avoid"></a>Резервное копирование и восстановление нерекомендуемые методы

Как уже упоминалось, контроллеры домена, работающие в виртуальные машины имеют ограничения, не применяются к контроллерам домена, работающих под управлением на физических компьютерах. При резервном копировании или восстановлении виртуального контроллера домена, существуют некоторые функции программного обеспечения виртуализации и рекомендации, которые не следует использовать:

   - Не копируйте и не клонируйте VHD-файлы контроллеров домена вместо выполнения обычного резервного копирования. Если VHD-файла он копируется или клонировать, она устареет. Затем Если виртуальный жесткий ДИСК запускается в обычном режиме, будет возникать отката номера последовательного обновления. Следует выполнять соответствующие операции резервного копирования, которые поддерживаются доменными службами Active Directory (AD DS), например с помощью функции архивации данных Windows Server.  
   - Не используйте функции снимка в качестве резервной копии восстановить виртуальную машину, которая была настроена в качестве контроллера домена. Проблемы будет достигнута при репликации при восстановлении виртуальной машины в предыдущее состояние с помощью Windows Server 2008 R2 и более ранних версий. Дополнительные сведения см. в разделе [USN и откат USN](#usn-and-usn-rollback). Несмотря на то, что восстановление контроллера домена только для чтения (RODC) с помощью моментального снимка не вызовет проблем с репликацией, этот метод восстановления по-прежнему не рекомендуется.  

## <a name="restoring-a-virtual-domain-controller"></a>Восстановление виртуального контроллера домена

Чтобы восстановить контроллер домена, если ей не удается, необходимо регулярно архивировать состояние системы. Состояние системы включает в себя файлы данных и журналов Active Directory, реестр, системный том (SYSVOL папка) и различные элементы операционной системы. Это требование не зависит от контроллеров домена с физическими и виртуальными. Процедуры восстановления состояния системы, которые выполняют приложения резервного копирования Active Directory, совместимую предназначены для обеспечения согласованности локальных и реплицированных баз данных Active Directory после завершения процесса восстановления, включая уведомления, чтобы репликация Сбрасывает партнеров ИД вызова. Тем не менее с помощью виртуальных сред размещения и диск или операционной системы, приложений для обработки изображений позволяет администраторам проверку и восстановления проверки, которые обычно возникают, когда состояние системы контроллера домена.

Когда виртуальную машину контроллера домена завершается сбоем и отката (USN) номер последовательности обновления не произошло, есть два поддерживаемых ситуации, при восстановлении виртуальной машины:

   - Если существует допустимое резервную копию состояния системы данных, сделанный до указанного сбоя, можно восстановить с помощью параметра восстановления программы резервного копирования, которая использовалась для создания резервной копии состояния системы. Резервное копирование данных состояния системы должна быть создана с помощью программы архивации данных Active Directory, совместимым в промежутке времени существования отметки полного удаления, который по умолчанию не более чем 180 дней. Сделайте резервные копии контроллеров домена по крайней мере каждые половину захоронения. Инструкции о том, как определить время жизни захоронения, определенных для леса, см. в разделе [определить время жизни захоронения леса](https://go.microsoft.com/fwlink/?linkid=137177).  
   - Если доступна рабочую копию VHD-файл, но доступна копия состояния системы, можно удалить существующую виртуальную машину. Восстановление существующей виртуальной машины с помощью предыдущую копию виртуального жесткого диска, но не забудьте запустить его в режиме восстановления служб каталогов (DSRM) и настройку реестра следует надлежащим образом, как описано в следующем разделе. Перезагрузите контроллер домена в обычном режиме.

Используйте процесс на следующем рисунке, чтобы определить лучший способ восстановления вашей виртуализованного контроллера домена.

![](media\virtualized-domain-controller-architecture\Dd363553.85c97481-7b95-4705-92a7-006e48bc29d0(WS.10).gif)

Для RODC процесс восстановления и решения, которые проще.

![](media\virtualized-domain-controller-architecture\Dd363553.4c5c5eda-df95-4c6b-84e0-d84661434e5d(WS.10).gif)

## <a name="restoring-the-system-state-backup-of-a-virtual-domain-controller"></a>Восстановление резервной копии состояния системы контроллера домена

Если резервной копии состояния системы, допустимый для виртуальной машины контроллера домена, вы можете безопасно восстановить резервную копию, выполнив процедуру восстановления, предписано резервной копии инструмент, который использовался для резервного копирования файла виртуального жесткого диска.

> [!IMPORTANT]
> Чтобы правильно восстановить контроллер домена, необходимо запустить ее в режиме DSRM. Вы не должны допускать контроллер домена запускается в обычном режиме. Если вы упустите возможность введите DSRM, во время запуска системы, отключите виртуальную машину контроллера домена до полностью начала в обычном режиме. Очень важно запустить контроллер домена в режиме DSRM, так как контроллер домена запускается шагом в обычном режиме его USN, даже если контроллер домена отключен от сети. Дополнительные сведения об откате USN см. в разделе USN и откат USN. 

## <a name="to-restore-the-system-state-backup-of-a-virtual-domain-controller"></a>Восстановление резервной копии состояния системы контроллера домена

1. Запустить виртуальную машину контроллера домена и нажмите клавишу F5, чтобы доступ к экрану диспетчера загрузки Windows. Если вам потребуется ввести учетные данные подключения, немедленно, нажмите кнопку **Пауза** кнопку на виртуальной машине, чтобы не производит запуск. Введите свои учетные данные подключения затем нажмите кнопку **воспроизведение** кнопки на виртуальной машине. Щелкните внутри окна виртуальной машины и нажмите клавишу F5.

   Если не отображается на экране диспетчера загрузки Windows и контроллер домена начинает запускается в обычном режиме, отключите виртуальную машину, чтобы помешать его успешному выполнению запуска. Повторите этот шаг столько раз, пока вы не может получить доступ к экран диспетчера загрузки Windows. При отсутствии доступа к DSRM меню восстановления после ошибок Windows. Таким образом выключите виртуальную машину и повторите попытку, если появится меню восстановления после ошибок Windows.

2. В окне диспетчера загрузки Windows нажмите клавишу F8 для доступа к расширенные варианты загрузки.
3. В **Дополнительные варианты загрузки** выберите **режима восстановления служб каталогов**, и нажмите клавишу ВВОД. Контроллер домена запущен в режиме DSRM.
4. Используйте подходящий метод для средство, которое вы использовали для создания резервной копии состояния системы. Если вы использовали архивации данных Windows Server, см. в разделе [выполнение непринудительного восстановления AD DS](https://go.microsoft.com/fwlink/?linkid=132637).

## <a name="restoring-a-virtual-domain-controller-when-an-appropriate-system-state-data-backup-is-not-available"></a>Восстановление виртуального контроллера домена, если соответствующие данные резервном копировании состояния не доступна

Если у вас нет резервной копии данных состояния системы, который предшествовал сбоя виртуальной машины, можно использовать предыдущий файл виртуального жесткого диска для восстановления контроллера домена, на котором выполняется на виртуальной машине. Если вы можете скопируйте виртуальный жесткий ДИСК, таким образом, чтобы при возникновении проблем во время процедуры или пропустите шаг, вы сможете повторить попытку с помощью скопированного виртуального жесткого диска.

> [!IMPORTANT]
> - Не можно использовать следующую процедуру для замены для регулярно планового и запланированное резервное копирование.
> - **Восстановление, выполняемые с помощью следующей процедуры не поддерживаются корпорацией Майкрософт и должен использоваться только в том случае, если нет других вариантов.**
> - Не используйте эту процедуру, если копия виртуального жесткого диска, которые требуется восстановить запускался в обычном режиме любой виртуальной машиной.

## <a name="to-restore-a-previous-version-of-a-virtual-domain-controller-vhd-without-system-state-data-backup"></a>Чтобы восстановить предыдущую версию виртуального контроллера домена виртуального жесткого диска без резервной копии данных состояния системы

1. С помощью предыдущего виртуальный жесткий ДИСК, запустите виртуальный контроллер домена в режиме DSRM, как описано в предыдущем разделе. Не разрешать контроллеру домена для запуска в обычном режиме. Если вы пропустите экран диспетчера загрузки Windows и контроллер домена начинает запускается в обычном режиме, отключите виртуальную машину, чтобы помешать его успешному выполнению запуска. См. в предыдущем разделе подробные инструкции для ввода DSRM.
2. Откройте редактор реестра. Чтобы открыть редактор реестра, нажмите кнопку **запустить**, нажмите кнопку **запуска**, тип **regedit**и нажмите кнопку ОК. Если появится диалоговое окно **контроля учетных записей**, подтвердите, что отображаемое в нем действие именно то, которое требуется, и нажмите кнопку **Да**. В окне редактора реестра разверните следующий путь: **Открываемый раздел HKEY\_ЛОКАЛЬНОГО\_МАШИНЫ\\системы\\CurrentControlSet\\служб\\NTDS\\параметры**. Найдите значение с именем **DSA предыдущее количество восстановить**. Если оно существует, запомните или запишите параметр. Если значение не существует, этот параметр равен значения по умолчанию равно нулю. Не добавляйте значение, если вы не видите одно существует.
3. Щелкните правой кнопкой мыши **параметры** раздел, выберите **New**, а затем нажмите кнопку **DWORD (32-разрядное) значение**.
4. Введите новое имя **база данных восстановлена из резервной копии**, и нажмите клавишу ВВОД.
5. Дважды щелкните значение, которое вы только что создали для открытия **изменение параметра DWORD (32-разрядное) значение** диалоговое окно, а затем введите **1** в **значение** поле. **База данных восстановлена из резервной копии записи** доступен на контроллерах домена под управлением Windows 2000 Server с пакетом обновления 4 (SP4), Windows Server 2003 с обновлениями, которые включены в [по обнаружению от отката номера последовательного обновления в Windows Server 2003, Windows Server 2008 и Windows Server 2008 R2 и](https://go.microsoft.com/fwlink/?linkid=137182) установлен знаний Microsoft Knowledge Base и Windows Server 2008.
6. Перезапустите контроллер домена в обычном режиме.
7. При перезапуске контроллера домена, откройте средство просмотра событий. Чтобы открыть просмотр событий, нажмите кнопку **Пуск**, выберите **Панель управления**, дважды щелкните **Администрирование**, а затем **Просмотр событий**.
8. Разверните **журналы приложений и служб**, а затем нажмите кнопку **службы каталогов** журнала. Убедитесь, что события отображаются в области сведений.
9. Щелкните правой кнопкой мыши **службы каталогов** войдите и нажмите кнопку **найти**. В **найти**, тип **1109**, а затем нажмите кнопку **Найти далее**.
10. Вы увидите хотя бы одну запись 1109 идентификатор события. Если вы не видите эту запись, перейдите к следующему шагу. В противном случае дважды щелкните запись, а затем просмотрите текст, подтверждающее, что обновление было выполнено для InvocationID:

   ```
   Active Directory has been restored from backup media, or has been configured to host an application partition. 
   The invocationID attribute for this directory server has been changed. 
   The highest update sequence number at the time the backup was created is <time>

   InvocationID attribute (old value):<Previous InvocationID value>
   InvocationID attribute (new value):<New InvocationID value>
   Update sequence number:<USN>

   The InvocationID is changed when a directory server is restored from backup media or is configured to host a writeable application directory partition.
   ```

11. Закройте окно просмотра событий.
12. Использование редактора реестра убедитесь, что значение в **DSA предыдущее количество восстановить** равен предыдущее значение, плюс один. Если это не является правильным значением и не удается найти запись для 1109 идентификатор события в средстве просмотра событий, проверьте контроллер домена службы пакетов текущей. Вы не можете эту процедуру еще раз на том же виртуального жесткого диска. Вы можете повторить попытку на копию виртуального жесткого диска или другой виртуальный жесткий ДИСК, который не был запущен в обычном режиме, начинать все с шага 1.
13. Закройте редактор реестра.

## <a name="usn-and-usn-rollback"></a>USN и откат USN

В этом разделе описываются проблемы репликации, которые могут возникнуть в результате неправильный восстановления базы данных Active Directory, с помощью более старой версии виртуальной машины. Дополнительные сведения о процессе репликации Active Directory, см. в разделе [основные понятия репликации Active Directory](../replication/active-directory-replication-concepts.md)

<!-- Replaced this link with 2016 article: [How the Active Directory Replication Model Works](http://go.microsoft.com/fwlink/?linkid=27636) (http://go.microsoft.com/fwlink/?LinkID=27636). -->

## <a name="usns"></a>USN

Active Directory доменные службы (AD DS) использует обновлений порядковые номера (USN) для отслеживания репликации данных между контроллерами домена. При каждом изменении данных в каталоге, номер увеличивается, чтобы указать, что был изменен.

Для каждого раздела каталога, который хранит конечный контроллер домена, USN используются для отслеживания последние исходного обновления узла, который контроллер домена для своей базы данных, а также состояние каждого контроллера домена, хранится реплика раздел каталога. Если контроллеры домена реплицировать изменения друг с другом, они запросить их партнерами репликации изменений USN, превышающие USN последнего изменения, полученные контроллера домена от каждого партнера.

В следующих двух таблицах метаданных репликации содержать USN. Контроллеры доменов источника и назначения их использовать для фильтрации обновлений, необходимых для конечного контроллера домена.

1. **Вектор синхронизации**: Таблица, которая поддерживает конечный контроллер домена для отслеживания источника обновления, полученные из всех исходных контроллеров домена. Когда целевой контроллер запросы на изменение домена для раздела каталога, он предоставляет его вектор синхронизации к исходному контроллеру домена. Исходный контроллер домена затем использует это значение, чтобы отфильтровать обновления, он отправляет на конечный контроллер домена. Исходный контроллер домена отправляет его вектор синхронизации в расположение, по завершении работы успешного цикла репликации, чтобы убедиться, что конечный контроллер домена знает, что его синхронизация с каждой контроллеров домена исходный обновлений и обновлений — на том же уровне, как источник.  
2. **Верхнего предела**: Значение, которое поддерживает конечный контроллер домена для отслеживания самые последние изменения, которые оно получило от конкретного исходного контроллера домена для определенной секции. Верхнего предела предотвращает отправку изменений, к которым по конечный контроллер домена уже получил от его исходного контроллера домена.  

## <a name="directory-database-identity"></a>Идентификатор базы данных каталога

В дополнение к USN контроллеры домена хранить список партнеров по репликации источника базы данных каталогов. Идентификатор базы данных каталога, запущенный на сервере поддерживается отдельно от удостоверения сам объект сервера. Идентификатор базы данных каталога на каждом контроллере домена, сохраняется в **invocationID** атрибута объекта параметров NTDS, который находится по следующему пути Lightweight Directory Access Protocol (LDAP): cn = NTDS Параметры "," cn = ServerName, cn = Servers, cn =*SiteName*, cn = Sites, cn = Configuration, dc =*Корневой_домен_леса*. Идентификатор объекта сервера, сохраняется в **objectGUID** атрибута объекта параметров NTDS. Идентификатор серверного объекта никогда не меняется. Тем не менее удостоверение изменений в базе данных каталога при возникновении процедура восстановления состояния системы на сервере, или при добавлении раздела каталога приложений, затем удаляется и позже, повторно добавляется с сервера. (другая ситуация: при активации его модули записи VSS для секции, содержащей VHD виртуального контроллера домена в Hyper-v экземпляр гостевой ОС в свою очередь активирует свои собственные модули записи VSS (тот же механизм используется резервное копирование и восстановление выше) приводит к другим способом, по которому находится invocationID Кнопка сброса)

Следовательно **invocationID** фактически связывает набор исходящих обновлений на контроллере домена с указанной версией базы данных каталога. Вектор синхронизации и максимальный уровень пометить таблицы используйте **invocationID** и ожидается GUID контроллера домена, соответственно, поэтому этот домен, контроллеры узнать от нужную копию Active Directory в базе данных репликации.

**InvocationID** является значением глобальный уникальный идентификатор (GUID), которое отображается в верхней части выходных данных после выполнения команды **repadmin /showrepl**. Следующий текст представляет пример выходных данных команды:

   ```
   Repadmin: running command /showrepl against full DC local host
   Default-First-Site-Name\VDC1
   DSA Options: IS_GC
   DSA object GUID: 966651f3-a544-461f-9f2c-c30c91d17818
   DSA invocationID: b0d9208b-8eb6-4205-863d-d50801b325a9
   ```

После восстановления AD DS на контроллере домена **invocationID** сбрасывается. В результате этого изменения будет привести к росту трафика репликации, длительность которой задается относительно размера секции реплицируемой

Например предположим, что VDC1 и DC2 являются контроллерами домена в одном домене. На следующем рисунке показана впечатление DC2 о VDC1, когда значение invocationID сбрасывается в случае правильного восстановления.

![](media\virtualized-domain-controller-architecture\Dd363553.ca71fc12-b484-47fb-991c-5a0b7f516366(WS.10).gif)

## <a name="usn-rollback"></a>Откат USN

Откат USN происходит, когда нормального обновления USN обойти и пытается использовать USN, который меньше, чем его последнее обновление контроллера домена. Обнаруживается откат номера последовательного обновления и репликация будет остановлена перед созданием расхождения в лесу, в большинстве случаев. 

Откат USN может быть вызвано различными способами, например, используются старые файлы виртуального жесткого диска (VHD) или преобразования физических в виртуальные (P2V преобразование) выполняется без гарантируя, что физический компьютер останется в автономном режиме без возможности восстановления после преобразования. Принимайте следующие меры предосторожности чтобы убедиться, что не происходит отката номера последовательного обновления:

   - При не под управлением Windows Server 2012 или более поздней версии, не использовать или не использовать моментальный снимок виртуальной машины контроллера домена.
   - Не копируйте файл виртуального жесткого диска контроллера домена.  
   - Если не под управлением Windows Server 2012 или более поздней версии, не экспортировать виртуальную машину, на котором работает контроллер домена.  
   - Не восстановить контроллер домена или попытка отката содержимого базы данных Active Directory с любыми другими способами, чем поддерживаемые решения резервного копирования, например системы архивации данных Windows Server.  

В некоторых случаях отката номера последовательного обновления могут остаться незамеченными. В других случаях он может вызвать другие ошибки репликации. В таких случаях бывает необходимо определить масштаб проблемы и позаботиться об этом своевременно. Сведения о том, как удаление устаревших объектов, которые могут возникнуть в результате отката номера последовательного обновления см. в разделе [объектов устаревшие Active Directory генерируют код события 1988 в Windows Server 2003](https://go.microsoft.com/fwlink/?linkid=137185) в базе знаний Майкрософт.

## <a name="usn-rollback-detection"></a>Обнаружение отката номера последовательного обновления

В большинстве случаев отката номера последовательного обновления без соответствующего сброса из **invocationID** из-за неправильного восстановления обнаруживаются процедуры. Windows Server 2008 предоставляет средства защиты от нежелательного репликации после операции восстановления с контроллером домена, неправильная. Эти средства защиты вызываются, тот факт, что операции неправильного восстановления приводит к низким USN, что представляют собой исходящих изменений, репликации, которые уже получили партнеров.

В Windows Server 2008 и Windows Server 2003 SP1 при изменении целевой контроллер домена запросы с помощью ранее использованных USN, ответом исходного партнера репликации интерпретируется программой конечного контроллера домена для означает, что его репликации метаданные является устаревшим. Это означает, что базы данных Active Directory на исходном контроллере домена произошел возврат к предыдущему состоянию. Например файл виртуального жесткого диска виртуальной машины выполнен откат к предыдущей версии. В этом случае конечный контроллер домена включает в себя следующие меры карантина на контроллере домена, который был определен как после неправильного восстановления.

   - AD DS приостанавливает службу сетевого входа в систему, которая запрещает менять пароли учетных записей учетных записей пользователей и компьютеров. Это действие предотвращает потерю такие изменения, если они встречаются после неправильного восстановления.  
   - AD DS отключает входящую и исходящую репликацию Active Directory.  
   - AD DS создает 2095 идентификатор события в журнал событий службы каталогов, чтобы указать условие.  

Последовательность событий, возникающее при обнаружении отката номера последовательного обновления на VDC2 — конечный контроллер домена, на котором выполняется на виртуальной машине на следующем рисунке. На этом рисунке обнаружение откат USN происходит на контроллере VDC2, когда партнер репликации обнаруживает, что VDC2 отправил значение номера последовательного обновления векторе синхронизации, которая ранее использовалась контроллером домена назначения, который указывает на VDC2 базы данных был откат в время неправильно.

![](media\virtualized-domain-controller-architecture\\Dd363553.373b0504-43fc-40d0-9908-13fdeb7b3f14(WS.10).gif)

Если журнал событий службы каталогов сообщает о 2095 идентификатор события, немедленно выполните следующую процедуру.

## <a name="to-resolve-event-id2095"></a>Чтобы устранить 2095 идентификатор события

1. Изолируйте виртуальной машины, которые записаны ошибки в сети.
2. Попытка определить ли любые изменения, являющийся источником этого контроллера домена и распространяются на другие контроллеры домена. Если событие было результатом моментального снимка или копии виртуальной машины, в которой началось, попробуйте определить время, когда произошло отката номера последовательного обновления. Затем можно установить флажок партнеров репликации данного контроллера домена, чтобы определить, произошла ли репликация с тех пор.

   Для этого можно использовать средство Repadmin. Сведения об использовании Repadmin, см. в разделе [мониторинг и устранение неполадок Active Directory репликации с помощью Repadmin](https://go.microsoft.com/fwlink/?linkid=122830). Если вы не можете определить это самостоятельно, обратитесь в службу [поддержки Майкрософт](https://support.microsoft.com) для получения помощи.

3. Принудительное понижение роли контроллера домена. Это подразумевает, что очистка метаданных контроллера домена и захвате ролей хозяина (известные также как гибкие операции с единым хозяином или FSMO) операций. Дополнительные сведения см. в разделе «Восстановление от отката USN» [как обнаруживать и восстановлению после отката USN в Windows Server 2003, Windows Server 2008 и Windows Server 2008 R2](https://go.microsoft.com/fwlink/?linkid=137182) в базе знаний Майкрософт.
4. Удалите все прежние файлы виртуального жесткого диска для контроллера домена.

## <a name="undetected-usn-rollback"></a>Необнаруженными отката номера последовательного обновления

Откат номера последовательного обновления могут не определяться в одном из двух случаях:

1. VHD-файл подключен на разных виртуальных машинах, которые работают в нескольких расположениях одновременно.  
2. За последний номер USN, контроллер домена получил увеличился USN на восстановленного контроллера домена.  

В первом случае другие контроллеры домена могут реплицироваться с помощью одного из виртуальных машин, и может произойти на любой виртуальной машине без, реплицируемых в другой. Это расхождение леса трудно обнаружить, и это приведет к непредсказуемым directory ответов. Подобная ситуация может возникнуть после P2V-миграции, если физической и виртуальной машины запускаются в той же сети. Это также может произойти, если несколько виртуальных контроллеров домена создаются из же физический контроллер домена и запустите в той же сети.

В случае второй диапазона номера USN применяется для двух разных наборов изменений. Этого не может продолжить продолжительное время. При изменении объекта, который создается в течение этого времени устаревший объект обнаружил и как 1988 идентификатор события в средстве просмотра событий. Ниже показано, как отката номера последовательного обновления могут не определяться в таких обстоятельствах.

![](media\virtualized-domain-controller-architecture\Dd363553.63565fe0-d970-4b4e-b5f3-9c76bc77e2d4(WS.10).gif)

## <a name="read-only-domain-controllers"></a>Контроллеры домена только для чтения

RODC являются контроллерами доменов, содержащих только для чтения копии разделов в базе данных Active Directory. RODC избежать большинства проблем отката номера последовательного обновления, так как они не реплицировать любые изменения на другие контроллеры домена. Тем не менее если из контроллера домена с возможностью записи, воздействия отката номера последовательного обновления реплицируется RODC, RODC снижается также.

Восстановление с помощью моментального снимка RODC не рекомендуется. Восстановите RODC с помощью приложения резервного копирования Active Directory, совместимым. Кроме того как и для записи контроллеров домена, необходимо соблюдать осторожность запрещено в RODC в автономный режим, в течение времени существования отметки полного удаления. Это условие может привести к устаревших объектов на RODC.

Дополнительные сведения о RODC, см. в разделе [планирования контроллера домена только для чтения и руководство по развертыванию](../../deploy/rodc/read-only-domain-controller-updates.md).
