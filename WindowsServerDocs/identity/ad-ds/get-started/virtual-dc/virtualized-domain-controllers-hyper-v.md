---
title: Виртуализация контроллеров домена с помощью Hyper-V
description: Рекомендации, которые необходимо выполнить при виртуализации контроллеров Windows Server домен Active Directory в Hyper-V
author: MicrosoftGuyJFlo
ms.author: joflore
ms.date: 04/19/2018
ms.topic: article
ms.prod: windows-server-threshold
ms.openlocfilehash: 491f4f2e2526e7cff024779ee3ecf9f771e64af4
ms.sourcegitcommit: 23a6e83b688119c9357262b6815c9402c2965472
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/16/2019
ms.locfileid: "69560578"
---
# <a name="virtualizing-domain-controllers-using-hyper-v"></a>Виртуализация контроллеров домена с помощью Hyper-V

> Относится к: Windows Server 2016

Этот раздел будет обновлен, чтобы применить рекомендации к Windows Server 2016. В Windows Server 2012 введено множество улучшений для виртуализированных контроллеров домена (DCs), включая средства защиты для предотвращения отката USN на виртуальных контроллерах доменов и возможности клонирования виртуальных контроллеров доменов. Дополнительные сведения об этих улучшениях см. [в статье Введение в виртуализацию домен Active Directory Services (AD DS) (уровень 100)](../../introduction-to-active-directory-domain-services-ad-ds-virtualization-level-100.md).

Hyper-V объединяет разные роли сервера на одном физическом компьютере. В этом разделе описывается работа контроллеров домена в качестве 32-разрядных или 64-разрядных гостевых операционных систем.

## <a name="planning-to-virtualize-domain-controllers"></a>Планирование виртуализации контроллеров домена

В этом разделе описываются требования к оборудованию для сервера Hyper-v, способы предотвращения отдельных точек отказа, выбор подходящего типа конфигурации для серверов и виртуальных машин Hyper-V, а также решения по обеспечению безопасности и производительности.

## <a name="hyper-v-requirements"></a>Требования к Hyper-V

Для установки и использования роли Hyper-V необходимо следующее:

   - **Процессор x64**
      - Hyper-V доступен в 64-разрядных версиях Windows Server 2008 или более поздней версии.  
   - **Виртуализация с аппаратной поддержкой**
      - Эта функция доступна в процессорах, которые включают в себя вариант виртуализации, в частности, технологию виртуализации Intel (Intel VT) или AMD (AMD-V).  
   - **Защита выполнения аппаратных данных (DEP)**
      - Оборудование DEP должно быть доступно и включено. В частности, необходимо включить разрядность Intel XD Bit (выполнение отключения) или AMD NX bit (без выполнения бита).  

## <a name="avoid-creating-single-points-of-failure"></a>Избегайте создания одиночных точек отказа

Следует попытаться избежать создания потенциальных точек отказа при планировании развертывания виртуального контроллера домена. Можно избежать появления потенциальных одиночных точек отказа, реализовав избыточность системы. Например, примите во внимание следующие рекомендации, при которых учитывайте возможность увеличения стоимости администрирования.

1. Запустите по меньшей мере два виртуализированных контроллера домена на каждом домене на разных узлах виртуализации, что снижает риск потери всех контроллеров домена в случае сбоя одного узла виртуализации.  
2. Как и для других технологий, изменить оборудование (используя разные процессоры, системные платы, сетевые адаптеры или другое оборудование), на которых работают контроллеры домена. Оборудование диверсификатион ограничивает ущерб, который может быть вызван неисправностью, относящейся к конфигурации поставщика, драйверу или одному устройству или типу оборудования.  
3. Если это возможно, контроллеры домена должны работать на оборудовании, расположенном в разных регионах мира. Это помогает снизить влияние сбоя или сбоя, влияющего на сайт, на котором размещаются контроллеры домена.  
4. Сохраняйте физические контроллеры домена в каждом домене. Это снижает риск сбоя платформы виртуализации, который влияет на все ведущие системы, использующие эту платформу.  

## <a name="security-considerations"></a>Замечания по безопасности

Главный компьютер, на котором работают виртуальные контроллеры домена, должен управляться так же внимательно, как и доступный для записи контроллер домена, даже если этот компьютер является только компьютером, присоединенным к домену или рабочей группой. Это важный аспект безопасности. Неуправляемый узел уязвим для атаки с повышенными правами доступа, что происходит, когда злоумышленник получает доступ и системные права, которые не были авторизованы или законно назначены. Злонамеренный пользователь может использовать этот тип атаки для компрометации всех виртуальных машин, доменов и лесов, на которых размещается этот компьютер.

При планировании виртуализации контроллеров домена обязательно учитывайте следующие соображения безопасности.

   - Локальный администратор компьютера, на котором размещены виртуальные контроллеры домена с возможностью записи, должен считаться эквивалентным учетным данным администратора домена по умолчанию для всех доменов и лесов, к которым принадлежат эти контроллеры домена.  
   - Рекомендуемая конфигурация, чтобы избежать проблем с безопасностью и производительностью, — это узел, на котором работает установка Server Core Windows Server 2008 или более поздней версии, без приложений, отличных от Hyper-V. Эта конфигурация ограничивает количество приложений и служб, установленных на сервере, что приведет к повышению производительности и снижению количества приложений и служб, которые могут быть использованы злоумышленниками для атаки на компьютер или сеть. Воздействие этого типа конфигурации называется сниженной уязвимостью. В филиалах или в других расположениях, которые не могут быть надежно защищены, рекомендуется использовать контроллер домена только для чтения (RODC). Если существует отдельная сеть управления, рекомендуется, чтобы узел был подключен только к сети управления.  
   - BitLocker можно использовать с контроллерами домена, так как в Windows Server 2016 можно использовать функцию виртуального доверенного платформенного модуля, чтобы также предоставить материал гостевого ключа для разблокировки системного тома.
   - [Защищенная структура и экранированные виртуальные машины](/it-server/WindowsServerDocs/virtualization/guarded-fabric-shielded-vm/guarded-fabric-and-shielded-vms.md) могут предоставлять дополнительные элементы управления для защиты контроллеров домена.

Сведения о RODC см. в [статье Планирование и развертывание контроллера домена только для чтения](../../deploy/rodc/read-only-domain-controller-updates.md).

Дополнительные сведения о защите контроллеров домена см. в статье [рекомендации по обеспечению безопасности при установке Active Directory](../../plan/security-best-practices/best-practices-for-securing-active-directory.md).

## <a name="security-boundaries-for-different-host-and-guest-configurations"></a>Границы безопасности для различных конфигураций узла и гостя

Использование виртуальных машин позволяет использовать множество различных конфигураций контроллеров домена. Тщательное внимание должно быть уделено способу, которым виртуальные машины влияют на границы и отношения доверия в топологии Active Directory. В следующей таблице описаны возможные конфигурации Active Directory контроллера домена и узла (сервера Hyper-V) и его гостевых компьютеров (виртуальных машин, работающих на сервере Hyper-V).

|Мachine|Конфигурация 1|Configuration 2|
|-------|---------------|---------------|
|Hyper-V|Компьютер рабочей группы или рядового компьютера|Компьютер рабочей группы или рядового компьютера|
|Гость|Контроллер домена|Компьютер рабочей группы или рядового компьютера|

![](media/virtualized-domain-controller-architecture/Dd363553.f44706fd-317e-4f0b-9578-4243f4db225f(WS.10).gif)

   - Администратор на главном компьютере имеет тот же доступ, что и администратор домена для гостей контроллера домена с возможностью записи и должен рассматриваться как таковой. В случае гостевого контроллера RODC администратор главного компьютера имеет тот же доступ, что и локальный администратор на гостевом контроллере домена только для чтения.   
   - Контроллер домена в виртуальной машине имеет права администратора на узле, если узел присоединен к тому же домену. Пользователи-злоумышленники могут нарушить безопасность всех виртуальных машин, если он впервые получит доступ к виртуальной машине 1. Это называется вектором атаки. При наличии контроллеров домена для нескольких доменов или лесов эти домены должны иметь централизованное администрирование, в котором администратор одного домена является доверенным во всех доменах.  
   - Возможность атаки с виртуальной машины 1 существует, даже если виртуальная машина 1 установлена как контроллер домена только для чтения. Несмотря на то, что администратор RODC явно не имеет прав администратора домена, RODC можно использовать для отправки политик на главный компьютер. Эти политики могут включать сценарии запуска. В случае успешного выполнения этой операции главный компьютер может быть скомпрометирован, и его можно использовать для компрометации других виртуальных машин на главном компьютере.  

## <a name="security-of-vhd-files"></a>Безопасность VHD-файлов

VHD-файл виртуального контроллера домена эквивалентен физическому жесткому диску физического контроллера домена. Таким образом, он должен быть защищен с учетом того же объема, который защищает жесткий диск физического контроллера домена. Убедитесь, что доступ к VHD-файлам контроллера домена разрешен только надежным и доверенным администраторам.

## <a name="rodcs"></a>RODC

Одно из преимуществ контроллеров RODC — возможность размещать их в тех местах, где физическая безопасность не может быть гарантирована, например в филиалах. Вы можете использовать шифрование диска BitLocker Windows для защиты VHD-файлов (не в том, в каких именно файловых системах) на узле путем кражи физического диска. 

## <a name="performance"></a>Производительность

Новая архитектура микроядер 64-bit позволяет значительно повысить производительность Hyper-V с предыдущих платформ виртуализации. Для оптимальной производительности узла узел должен быть установлен в качестве ядра сервера Windows Server 2008 или более поздней версии и не должен иметь ролей сервера, отличных от установленных Hyper-V.

Производительность виртуальных машин зависит от рабочей нагрузки. Чтобы гарантировать удовлетворительную производительность Active Directory, проверьте конкретные топологии. Оцените текущую рабочую нагрузку за определенный период времени с помощью такого средства, как монитор надежности и производительности (Perfmon. msc) или [набор средств оценки и планирования (Map) Microsoft](https://go.microsoft.com/fwlink/?linkid=137077). Средство MAP также может быть полезным, если вы хотите взять на себя инвентаризацию всех серверов и ролей сервера, которые в настоящее время существуют в сети.

Чтобы получить общее представление о производительности виртуализированных контроллеров домена, следующие тесты производительности были выполнены с помощью [средства тестирования производительности Active Directory (адтест. exe)](https://go.microsoft.com/fwlink/?linkid=137088).

Тесты LDAP были запущены на физическом контроллере домена с помощью Адтест. exe, а затем на виртуальной машине, размещенной на сервере, который идентичен физическому контроллеру домена. Для физического компьютера использовался только один логический процессор, и для виртуальной машины можно было использовать только один виртуальный процессор, чтобы легко достичь 100% использования ЦП. В следующей таблице буква и число в круглых скобках после каждого теста указывают на конкретный тест в Адтест. exe. Как показывают эти данные, производительность виртуализированного контроллера домена была 88 98% от физической производительности контроллера домена.

<table>
<colgroup>
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
</colgroup>
<thead>
<tr class="header">
<th>Размеры</th>
<th>Тест</th>
<th>Физическое движение</th>
<th>Виртуализаци</th>
<th>Изменений</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>Поисков/с</p></td>
<td><p>Поиск общего имени в базовой области (L1)</p></td>
<td><p>11508</p></td>
<td><p>10276</p></td>
<td><p>-10,71%</p></td>
</tr>
<tr class="even">
<td><p>Поисков/с</p></td>
<td><p>Поиск набора атрибутов в базовой области (L2)</p></td>
<td><p>10123</p></td>
<td><p>9005</p></td>
<td><p>-11,04%</p></td>
</tr>
<tr class="odd">
<td><p>Поисков/с</p></td>
<td><p>Поиск всех атрибутов в базовой области (L3)</p></td>
<td><p>1284</p></td>
<td><p>1242</p></td>
<td><p>-3,27%</p></td>
</tr>
<tr class="even">
<td><p>Поисков/с</p></td>
<td><p>Поиск общего имени в области поддерева ("6")</p></td>
<td><p>8613</p></td>
<td><p>7904</p></td>
<td><p>-8,23%</p></td>
</tr>
<tr class="odd">
<td><p>Успешных привязок/с</p></td>
<td><p>Выполнение быстрых привязок (B1)</p></td>
<td><p>1438</p></td>
<td><p>1374</p></td>
<td><p>-4,45%</p></td>
</tr>
<tr class="even">
<td><p>Успешных привязок/с</p></td>
<td><p>Выполнение простых привязок (B2)</p></td>
<td><p>611</p></td>
<td><p>550</p></td>
<td><p>-9,98%</p></td>
</tr>
<tr class="odd">
<td><p>Успешных привязок/с</p></td>
<td><p>Использование NTLM для выполнения привязок (B5)</p></td>
<td><p>1068</p></td>
<td><p>1056</p></td>
<td><p>-1,12%</p></td>
</tr>
<tr class="even">
<td><p>Операций записи в секунду</p></td>
<td><p>Запись нескольких атрибутов (W2)</p></td>
<td><p>6467</p></td>
<td><p>5885</p></td>
<td><p>-9,00%</p></td>
</tr>
</tbody>
</table>

Чтобы обеспечить удовлетворительную производительность, были установлены интеграционные компоненты (IC), позволяющие гостевой операционной системе использовать просветлений или синтетические драйверы, поддерживающие гипервизоры. В процессе установки может потребоваться использовать эмулированные интегрированные накопители (IDE) или драйверы сетевых адаптеров. В рабочих средах следует заменить эти эмулированные драйверы на синтетические, чтобы повысить производительность.

При наблюдении за производительностью виртуальных машин с надежностью и диспетчером производительности (Perfmon. msc) на виртуальной машине сведения о ЦП не будут полностью точными в результате того, как виртуальный ЦП будет запланирован на физическом процессоре. Если требуется получить сведения о ЦП для виртуальной машины, работающей на сервере Hyper-V, используйте счетчики логического процессора гипервизора Hyper-V в разделе узла.

Дополнительные сведения о настройке производительности как AD DS, так и Hyper-V см. в статье [рекомендации по настройке производительности для Windows Server 2016](../../../../administration/performance-tuning/index.md).

Кроме того, не планируйте использовать виртуальный жесткий диск разностного диска на виртуальной машине, настроенной в качестве контроллера домена, так как виртуальный жесткий диск разностного диска может снизить производительность. Дополнительные сведения о типах дисков Hyper-V, включая разностные диски, см. в разделе [Мастер создания виртуальных жестких дисков](http://go.microsoft.com/fwlink/?linkid=137279).

Дополнительные сведения о AD DS в виртуальных средах размещения см. в разделе [факторы, которые следует учитывать при размещении Active Directory контроллеров домена в виртуальных средах размещения](https://go.microsoft.com/fwlink/?linkid=141292) в базе знаний Майкрософт.

## <a name="deployment-considerations-for-virtualized-domain-controllers"></a>Рекомендации по развертыванию виртуальных контроллеров домена

Существует несколько распространенных методов работы с виртуальными машинами, которые следует избегать при развертывании контроллеров домена, а также специальные рекомендации по синхронизации времени и хранению.

## <a name="virtualization-deployment-practices-to-avoid"></a>Рекомендации по развертыванию виртуализации, чтобы избежать

Платформы виртуализации, такие как Hyper-V, предлагают ряд удобных функций, облегчающих управление, обслуживание, резервное копирование и миграцию компьютеров. Однако следующие общие рекомендации и функции развертывания не должны использоваться для виртуальных контроллеров домена.

- Чтобы обеспечить устойчивость Active Directory записи, не следует развертывать файлы базы данных виртуального контроллера домена (база данных Active Directory (NTDS. DIT), журналы и SYSVOL на виртуальных дисках IDE. Вместо этого создайте второй виртуальный жесткий диск, подключенный к виртуальному контроллеру SCSI, и убедитесь, что база данных, журналы и SYSVOL помещаются на диск SCSI виртуальной машины во время установки контроллера домена.  
- Не реализуйте виртуальные жесткие диски разностного диска (VHD) на виртуальной машине, настраиваемой в качестве контроллера домена. Это значительно упрощает возврат к предыдущей версии, а также снижает производительность. Дополнительные сведения о типах ВИРТУАЛЬНЫХ жестких дисков см. в разделе [Мастер создания виртуального жесткого диска](https://go.microsoft.com/fwlink/?linkid=137279).  
- Не развертывайте новые домены Active Directory и леса на копии операционной системы Windows Server, которая не была предварительно подготовлена с помощью средства подготовки системы (Sysprep). Дополнительные сведения о запуске Sysprep см. в статье [Обзор Sysprep (подготовка системы)](https://docs.microsoft.com/windows-hardware/manufacture/desktop/sysprep--system-preparation--overview) .

   > [!WARNING]
   > Запуск Sysprep на контроллере домена не поддерживается.

- Чтобы предотвратить возможную ситуацию отката последовательности обновлений (USN), не используйте копии VHD-файла, представляющего уже развернутый контроллер домена, для развертывания дополнительных контроллеров домена. Дополнительные сведения об откате USN см. в разделе [USN и откат USN](#usn-and-usn-rollback).
   - Windows Server 2012 и более поздние версии позволяют администраторам клонировать образы контроллеров домена, если они правильно подготовлены, если требуется развернуть дополнительные контроллеры домена.
- Не используйте функцию экспорта Hyper-V для экспорта виртуальной машины, на которой работает контроллер домена.
  - В Windows Server 2012 и более поздних версиях экспорт и Импорт виртуальной машины контроллера домена выполняется как неполномочное восстановление, так как оно обнаруживает изменение идентификатора поколения и не настроено для клонирования.
  - Убедитесь, что вы не используете гостевой пользователь, который вы уже экспортировали.
    - Репликацию Hyper-V можно использовать для сохранения второй неактивной копии контроллера домена. Если вы запускаете реплицированный образ, вам также потребуется выполнить правильную очистку по той же причине, что и при экспорте гостевого образа контроллера домена.

## <a name="physical-to-virtual-migration"></a>Перенос физического компьютера в виртуальную

System Center Virtual Machine Manager (VMM) 2008 обеспечивает унифицированное управление физическими компьютерами и виртуальными машинами. Он также обеспечивает возможность миграции физического компьютера на виртуальную машину. Этот процесс называется преобразованием физического компьютера в виртуальную машину (P2V-преобразование). Во время преобразования P2V Новая виртуальная машина и перемещаемый контроллер домена не должны выполняться одновременно, чтобы избежать ситуации отката USN, как описано в статье [откат USN и USN](#usn-and-usn-rollback).

Необходимо выполнить преобразование P2V с помощью автономного режима, чтобы данные каталога были единообразно, когда контроллер домена снова включен. Параметр автономного режима предлагается и рекомендуется в мастере преобразования физического сервера. Описание различий между интерактивным режимом и автономным режимом см [. в разделе P2V: Преобразование физических компьютеров в виртуальные машины в VMM](https://go.microsoft.com/fwlink/?linkid=155072). Во время преобразования P2V виртуальная машина не должна быть подключена к сети. Сетевой адаптер виртуальной машины должен быть включен только после завершения процесса преобразования P2V и проверки. На этом этапе физический исходный компьютер будет отключен. Не перенесите физический исходный компьютер обратно в сеть перед переформатированием жесткого диска.

> [!NOTE]
> Существуют более безопасные варианты создания виртуальных контроллеров домена, которые не загружают риски при создании отката USN. Вы можете настроить новый виртуальный контроллер домена, используя регулярное повышение, продвижение с носителя, а также клонирование контроллеров домена, если у вас уже есть по крайней мере один виртуальный DC.
Это также помогает избежать проблем с оборудованием или проблемами, связанными с неисправностью виртуальной машины с преобразованием P2V.

> [!WARNING]
> Чтобы предотвратить проблемы с репликацией Active Directory, убедитесь, что в любой момент времени существует только один экземпляр (физический или виртуальный) определенного контроллера домена в данной сети.
> Можно снизить вероятность возникновения проблемы со старым клоном:
> 
> - После запуска нового виртуального контроллера домена измените пароль учетной записи компьютера дважды с помощью команды netdom ресетпвд/Server: < > контроллера домена...
> - Экспортируйте и импортируйте новый виртуальный гостевой компьютер, чтобы он был новым ИДЕНТИФИКАТОРом поколения и, следовательно, ИДЕНТИФИКАТОРом вызова базы данных.
> 

## <a name="using-p2v-migration-to-create-test-environments"></a>Использование P2V Migration для создания тестовых сред

Для создания тестовых сред можно использовать P2V-миграцию с помощью VMM. Вы можете перенести рабочие контроллеры домена с физических компьютеров на виртуальные машины, чтобы создать тестовую среду без окончательного отключения рабочих контроллеров домена. Однако тестовая среда должна находиться в другой сети из рабочей среды, если существуют два экземпляра одного и того же контроллера домена. Необходимо соблюдать осторожность при создании тестовых сред с помощью P2V Migration, чтобы избежать отката USN, который может повлиять на тестовую и рабочую среды. Ниже приведен метод, который можно использовать для создания тестовых сред с P2V.

Один из рабочих контроллеров домена, переданный из каждого домена, переносится на тестовую виртуальную машину с помощью P2V в соответствии с рекомендациями, указанными в разделе о миграции физического компьютера в виртуальный. Физические рабочие машины и тестовые виртуальные машины должны находиться в разных сетях, когда они возвращаются в оперативный режим. Чтобы избежать отката USN в тестовой среде, все контроллеры домена, которые должны быть перенесены из физических компьютеров в виртуальные машины, необходимо перевести в автономный режим. (Это можно сделать, запустив службу NTDS или перезапустив компьютер в режиме восстановления служб каталогов (DSRM).) После отключения контроллеров домена новые обновления не будут добавлены в среду. Во время миграции P2V компьютеры должны оставаться в автономном режиме. ни один из компьютеров не должен быть переведен в режим «в сети», пока все компьютеры не будут полностью перенесены. Дополнительные сведения о откате USN см. в статье откат USN и USN.

Последующие тестовые контроллеры домена следует повышать в качестве реплик в тестовой среде.

## <a name="time-service"></a>Служба времени

Для виртуальных машин, которые настроены в качестве контроллеров домена, рекомендуется отключить синхронизацию времени между основной системой и гостевой операционной системой, действующей в качестве контроллера домена. Это позволяет гостевому контроллеру домена синхронизировать время из иерархии доменов.

Чтобы отключить поставщик синхронизации времени Hyper-V, завершите работу виртуальной машины и снимите флажок Синхронизация времени в разделе Integration Services.

> [!NOTE]
> Это руководство недавно обновлялось, чтобы отразить текущую рекомендацию по синхронизации времени для гостевого контроллера домена только из иерархии домена, а не из предыдущей рекомендации по частичному отключению синхронизации времени между узлом. системный и гостевой контроллер домена.

## <a name="storage"></a>Служба хранилища

Чтобы оптимизировать производительность виртуальной машины контроллера домена и обеспечить устойчивость Active Directory записи, используйте следующие рекомендации по хранению файлов операционной системы, Active Directory и VHD:

- **Гостевое хранилище**. Храните файл базы данных Active Directory (Ntds. dit), файлы журнала и файлы SYSVOL на отдельном виртуальном диске из файлов операционной системы. Создайте второй виртуальный жесткий диск, подключенный к виртуальному контроллеру SCSI, и сохраните базу данных, журналы и SYSVOL на виртуальном диске SCSI виртуальной машины. Виртуальные диски SCSI обеспечивают повышенную производительность по сравнению с виртуальной интегрированной средой разработки и поддерживают принудительный доступ к единицам (Фуа). Фуа гарантирует, что операционная система записывает и считывает данные непосредственно из мультимедиа, минуя все механизмы кэширования.

  > [!NOTE]
  > Если вы планируете использовать BitLocker для гостевых виртуальных контроллеров домена, необходимо убедиться, что для дополнительных томов настроено автоматическое разблокирование.
  > Дополнительные сведения о настройке автоматического разблокировки можно найти в статье [Enable-битлоккераутаунлокк](https://docs.microsoft.com/powershell/module/bitlocker/enable-bitlockerautounlock) .

- **Размещение хранилища VHD-файлов**. Проектирован Рекомендации по хранилищу узла адрес хранения VHD-файлов. Для максимальной производительности не храните VHD-файлы на диске, который часто используется другими службами или приложениями, например системным диском, на котором установлена операционная система Windows. Храните каждый файл виртуального жесткого диска в отдельном разделе из операционной системы узла и других VHD-файлов. Идеальная конфигурация — хранить каждый VHD-файл на отдельном физическом диске.  

  Физическая дисковая система узла также должна удовлетворять **по крайней мере один** из следующих критериев, чтобы удовлетворить требования целостности данных виртуализованной рабочей нагрузки:  

   - Система использует диски серверного класса (SCSI, Fibre Channel).  
   - Система гарантирует, что диски будут подключены к адаптеру шины хоста, поддерживающего зарезервированное значение аккумулятора (HBA).  
   - В качестве устройства хранения в системе используется контроллер хранилища (например, RAID-система).  
   - Система гарантирует, что питание диска будет защищено источником бесперебойного питания (ИБП).  
   - Система гарантирует, что функция кэширования записи на диск отключена.  

- **Фиксированный виртуальный жесткий диск и транзитные диски**. Существует множество способов настройки хранилища для виртуальных машин. При использовании VHD-файлов фиксированный размер VHD более эффективен, чем динамические виртуальные жесткие диски, так как память для виртуальных жестких дисков фиксированного размера выделяется при их создании. Транзитные диски, которые виртуальные машины могут использовать для доступа к физическим носителям, еще более оптимизированы для повышения производительности. Сквозные диски по сути являются физическими дисками или номерами логических устройств (LUN), подключенными к виртуальной машине. Транзитные диски не поддерживают функцию создания моментальных снимков. Таким образом, сквозные диски являются предпочтительной конфигурацией жесткого диска, так как использовать моментальные снимки с контроллерами домена не рекомендуется.  

Чтобы снизить вероятность повреждения данных Active Directory, используйте виртуальные SCSI Controllers:

   - Используйте физические диски SCSI (в отличие от дисков IDE/ATA) на серверах Hyper-V, на которых размещаются виртуальные контроллеры домена. Если вы не можете использовать диски SCSI, убедитесь, что кэширование записи отключено на дисках ATA/IDE, на которых размещаются виртуальные контроллеры домена. Дополнительные сведения см. в описании [события с идентификатором 1539 — целостность базы данных](https://go.microsoft.com/fwlink/?linkid=162419).
   - Чтобы гарантировать устойчивость Active Directory записи, Active Directory базу данных, журналы и SYSVOL должны быть помещены на виртуальный диск SCSI. Виртуальные диски SCSI поддерживают принудительный доступ к единицам (Фуа). Фуа гарантирует, что операционная система записывает и считывает данные непосредственно из мультимедиа, минуя все механизмы кэширования.  

## <a name="operational-considerations-for-virtualized-domain-controllers"></a>Замечания по эксплуатации виртуальных контроллеров домена

Контроллеры домена, работающие на виртуальных машинах, имеют операционные ограничения, которые не применяются к контроллерам домена, работающим на физических компьютерах. При использовании виртуализованного контроллера домена существуют некоторые функции и методы по виртуализации, которые не следует использовать.

   - Не приостанавливать, останавливать или сохранять сохраненное состояние контроллера домена на виртуальной машине в течение времени, превышающего время существования захоронения леса, а затем возобновлять работу из приостановленного или сохраненного состояния. Это может помешать репликации. Сведения о том, как определить время существования захоронения для леса, см. в разделе [Определение времени жизни захоронения для леса](https://go.microsoft.com/fwlink/?linkid=137177).  
   - Не копируйте и не клонировать виртуальные жесткие диски (VHD). Даже в случае с защитой гостевой виртуальной машины отдельные виртуальные жесткие диски по-прежнему могут копироваться и приводить к откату USN.
   - Не создавать и не использовать моментальный снимок виртуального контроллера домена. Она технически поддерживается в Windows Server 2012 и более поздних версиях, она не является заменой хорошей стратегии резервного копирования. Существует несколько причин для создания моментальных снимков контроллера домена или восстановления их.
   - Не используйте виртуальный жесткий диск разностного диска на виртуальной машине, настроенной в качестве контроллера домена. Это значительно упрощает возврат к предыдущей версии, а также снижает производительность.  
   - Не используйте функцию экспорта на виртуальной машине, на которой работает контроллер домена.  
   - Не восстанавливайте контроллер домена или попытайтесь выполнить откат содержимого базы данных Active Directory любыми другими способами, кроме использования поддерживаемой резервной копии. Дополнительные сведения см. в статье [рекомендации по резервному копированию и восстановлению для виртуализированных контроллеров домена](#backup-and-restore-practices-to-avoid).  

Все эти рекомендации позволяют избежать возможного отката номера последовательного обновления (USN). Дополнительные сведения о откате USN см. в статье откат USN и USN.

## <a name="backup-and-restore-considerations-for-virtualized-domain-controllers"></a>Рекомендации по резервному копированию и восстановлению для виртуализированных контроллеров домена

Резервное копирование контроллеров домена является критически важным требованием для любой среды. Резервные копии защищают от потери данных в случае сбоя контроллера домена или административной ошибки. При возникновении такого события необходимо выполнить откат состояния системы контроллера домена до точки во времени до сбоя или ошибки. Поддерживаемый метод восстановления контроллера домена до работоспособного состояния заключается в использовании приложения резервного копирования, совместимого с Active Directory, такого как cистема архивации данных Windows Server, для восстановления резервной копии состояния системы, созданной из текущей установки домена. контроллера. Дополнительные сведения об использовании cистема архивации данных Windows Server со службами домен Active Directory (AD DS) см. в статье Пошаговое описание [резервного копирования и восстановления AD DS](https://go.microsoft.com/fwlink/?LinkId=138501).

При использовании технологии виртуальных машин некоторые требования к Active Directory операций восстановления принимаются по мере добавления значимости. Например, если вы восстанавливаете контроллер домена с помощью копии файла виртуального жесткого диска (VHD), вы обходите критически важный шаг обновления версии базы данных контроллера домена после его восстановления. Репликация будет продолжена с недопустимыми номерами отслеживания, что приведет к несогласованности базы данных между репликами контроллера домена. В большинстве случаев эта проблема не обнаруживается системой репликации и не сообщает об ошибках, несмотря на несоответствия между контроллерами домена.

Существует один поддерживаемый способ выполнения резервного копирования и восстановления виртуального контроллера домена.

1. Запустите cистема архивации данных Windows Server в гостевой операционной системе.  

С Windows Server 2012 и новыми узлами и гостями Hyper-V можно использовать поддерживаемые резервные копии контроллеров домена с помощью моментальных снимков, экспорта и импорта гостевой виртуальной машины, а также репликации Hyper-V. Все это, тем не менее, не подходит для создания надлежащего журнала резервного копирования с незначительным исключением экспорта гостевой виртуальной машины.

В Windows Server 2016 Hyper-V существует поддержка "рабочих моментальных снимков", где сервер Hyper-V запускает резервное копирование гостевых систем на основе VSS и когда гостевая система выполняется с моментальным снимком, узел извлекает виртуальные жесткие диски и сохраняет их в расположении резервной копии.

Хотя это работает с Windows Server 2012 и более поздних версий, существует несовместимость с BitLocker:

- При выполнении прикрепления к VSS AD хочет выполнить задачу после создания моментального снимка, чтобы пометить базу данных как поступающие от резервной копии, или в случае подготовки источника IFM для RODC удалите учетные данные из базы данных.
- Когда Hyper-V подключает том снапшоттед для этой задачи, нет возможности разблокировать том для незашифрованного доступа. Поэтому ядро СУБД Active Directory не получает доступ к базе данных и в конечном итоге завершается сбоем моментального снимка.

> [!NOTE]
> Упомянутый ранее проект экранированной виртуальной машины содержит резервную копию, управляемую узлом Hyper-V, как Нецелевая для максимальной защиты данных гостевой виртуальной машины.

## <a name="backup-and-restore-practices-to-avoid"></a>Рекомендации по резервному копированию и восстановлению, чтобы избежать

Как уже упоминалось, контроллеры домена, работающие на виртуальных машинах, имеют ограничения, которые не применяются к контроллерам домена, работающим на физических компьютерах. При резервном копировании или восстановлении виртуального контроллера домена существуют некоторые функции и методы виртуализации, которые не следует использовать.

   - Не следует копировать или клонировать VHD-файлы контроллеров домена вместо регулярного резервного копирования. Если VHD-файл скопирован или клонирован, он становится устаревшим. Затем, если виртуальный жесткий диск запускается в нормальном режиме, будет выполнен откат USN. Необходимо выполнить соответствующие операции резервного копирования, которые поддерживаются службами домен Active Directory (AD DS), например с помощью функции cистема архивации данных Windows Server.  
   - Не используйте функцию Snapshot в качестве резервной копии для восстановления виртуальной машины, настроенной в качестве контроллера домена. При восстановлении из виртуальной машины в более раннее состояние с Windows Server 2008 R2 и более старыми возникнут проблемы с репликацией. Дополнительные сведения см. в разделе [USN и откат USN](#usn-and-usn-rollback). Несмотря на то, что использование моментального снимка для восстановления контроллера домена только для чтения (RODC) не приведет к проблемам репликации, этот метод восстановления по-прежнему не рекомендуется.  

## <a name="restoring-a-virtual-domain-controller"></a>Восстановление виртуального контроллера домена

Чтобы восстановить контроллер домена при сбое, необходимо регулярно выполнять резервное копирование состояния системы. Состояние системы включает Active Directory файлы данных и журналов, реестр, системный том (папка SYSVOL) и различные элементы операционной системы. Это требование одинаково для физических и виртуальных контроллеров домена. Процедуры восстановления состояния системы, выполняемые Active Directory совместимыми приложениями резервного копирования, предназначены для обеспечения согласованности локальных и реплицированных баз данных Active Directory после процесса восстановления, включая уведомление для репликации. Партнеры по сбросу идентификатора вызова. Тем не менее, использование виртуальных сред размещения и приложений для работы с образами дисков или операционных систем позволяет администраторам обходить проверку и проверки, обычно возникающие при восстановлении состояния системы контроллера домена.

При сбое виртуальной машины контроллера домена и откате номера последовательного обновления (USN) существуют две поддерживаемые ситуации для восстановления виртуальной машины:

   - Если допустимая резервная копия данных о состоянии системы, которая является причиной ошибки, существует, можно восстановить состояние системы с помощью параметра восстановления программы резервного копирования, который использовался для создания резервной копии. Резервная копия данных о состоянии системы должна быть создана с помощью служебной программы резервного копирования, совместимой с Active Directory, в пределах периода времени жизни захоронения, который по умолчанию не превышает 180 дней. Необходимо выполнять резервное копирование контроллеров домена по крайней мере каждые половину времени жизни захоронения. Инструкции по определению времени существования захоронения для леса см. [в разделе Определение времени существования захоронения для леса](https://go.microsoft.com/fwlink/?linkid=137177).  
   - Если Рабочая копия VHD-файла доступна, но резервная копия состояния системы не доступна, можно удалить существующую виртуальную машину. Восстановите существующую виртуальную машину, используя предыдущую копию виртуального жесткого диска, но не забудьте запустить ее в режиме восстановления служб каталогов (DSRM) и правильно настроить реестр, как описано в следующем разделе. Затем перезапустите контроллер домена в нормальном режиме.

Используйте процесс, описанный на следующем рисунке, чтобы определить оптимальный способ восстановления виртуального контроллера домена.

![](media/virtualized-domain-controller-architecture/Dd363553.85c97481-7b95-4705-92a7-006e48bc29d0(WS.10).gif)

Для контроллеров RODC процесс восстановления и решения проще.

![](media/virtualized-domain-controller-architecture/Dd363553.4c5c5eda-df95-4c6b-84e0-d84661434e5d(WS.10).gif)

## <a name="restoring-the-system-state-backup-of-a-virtual-domain-controller"></a>Восстановление резервной копии состояния системы виртуального контроллера домена

Если для виртуальной машины контроллера домена существует допустимая резервная копия состояния системы, можно безопасно восстановить резервную копию, следуя процедуре восстановления, заданной средством резервного копирования, которое использовалось для резервного копирования VHD-файла.

> [!IMPORTANT]
> Чтобы правильно восстановить контроллер домена, необходимо запустить его в режиме DSRM. Не следует разрешать запуск контроллера домена в нормальном режиме. Если вы не пропустили возможность входа в систему DSRM во время запуска системы, отключите виртуальную машину контроллера домена, прежде чем ее можно будет полностью запустить в нормальном режиме. Очень важно запустить контроллер домена в режиме DSRM, так как запуск контроллера домена в нормальный режим приводит к увеличению его USN, даже если контроллер домена отключен от сети. Дополнительные сведения о откате USN см. в статье откат USN и USN. 

## <a name="to-restore-the-system-state-backup-of-a-virtual-domain-controller"></a>Восстановление резервной копии состояния системы виртуального контроллера домена

1. Запустите виртуальную машину контроллера домена и нажмите клавишу F5, чтобы открыть экран диспетчера загрузки Windows. Если необходимо ввести учетные данные подключения, немедленно нажмите кнопку **Пауза** на виртуальной машине, чтобы не начинать работу. Затем введите учетные данные подключения и нажмите кнопку **Воспроизведение** на виртуальной машине. Щелкните внутри окна виртуальной машины, а затем нажмите клавишу F5.

   Если вы не видите экран диспетчера загрузки Windows, а контроллер домена запускается в нормальном режиме, выключите виртуальную машину, чтобы предотвратить ее завершение. Повторите этот шаг столько раз, сколько необходимо, пока вы не сможете получить доступ к экрану диспетчера загрузки Windows. Доступ к DSRM из меню восстановления ошибок Windows невозможен. Поэтому выключите виртуальную машину и повторите попытку, если появится меню восстановления ошибок Windows.

2. На экране диспетчера загрузки Windows нажмите клавишу F8, чтобы получить доступ к дополнительным параметрам загрузки.
3. На экране **Дополнительные параметры загрузки** выберите **режим восстановления служб каталогов**и нажмите клавишу ВВОД. Это приведет к запуску контроллера домена в режиме DSRM.
4. Используйте соответствующий метод восстановления для средства, которое использовалось для создания резервной копии состояния системы. Если вы использовали cистема архивации данных Windows Server, см. раздел [выполнение неполномочного восстановления AD DS](https://go.microsoft.com/fwlink/?linkid=132637).

## <a name="restoring-a-virtual-domain-controller-when-an-appropriate-system-state-data-backup-is-not-available"></a>Восстановление виртуального контроллера домена, если соответствующая резервная копия данных о состоянии системы недоступна

Если у вас нет резервной копии данных о состоянии системы, которая содержит дату сбоя виртуальной машины, можно использовать предыдущий VHD-файл для восстановления контроллера домена, работающего на виртуальной машине. Если вы можете сделать это, создайте копию виртуального жесткого диска, чтобы при возникновении проблемы во время процедуры или при пропуске шага вы можете повторить попытку, используя скопированный виртуальный жесткий диск.

> [!IMPORTANT]
> - Не следует использовать следующую процедуру в качестве замены регулярно запланированных и запланированных резервных копий.
> - **Операции восстановления, выполняемые со следующей процедурой, не поддерживаются корпорацией Майкрософт и должны использоваться только при отсутствии других альтернативных вариантов.**
> - Не используйте эту процедуру, если копия VHD, которую вы собираетесь восстановить, была запущена в нормальном режиме любой виртуальной машины.

## <a name="to-restore-a-previous-version-of-a-virtual-domain-controller-vhd-without-system-state-data-backup"></a>Восстановление предыдущей версии виртуального жесткого диска контроллера домена без резервного копирования данных о состоянии системы

1. Используя предыдущий виртуальный жесткий диск, запустите виртуальный контроллер домена в режиме DSRM, как описано в предыдущем разделе. Не разрешите запуск контроллера домена в нормальном режиме. Если вы пропустили экран диспетчера загрузки Windows и начнете работу контроллера домена в нормальном режиме, выключите виртуальную машину, чтобы предотвратить ее завершение. Подробные инструкции по входу в режиме DSRM см. в предыдущем разделе.
2. Откройте редактор реестра. Чтобы открыть редактор реестра, нажмите кнопку **Пуск**, выберите команду **выполнить**, введите regedit и нажмите кнопку ОК. Если появится диалоговое окно **контроля учетных записей**, подтвердите, что отображаемое в нем действие именно то, которое требуется, и нажмите кнопку **Да**. В редакторе реестра разверните следующий путь: **ПараметрыNTDS\_локальныхмашин\\System\\CurrentControlSet Services.\\\\\_\\** Найдите значение с именем **DSA Previous Restore**. Если это так, запишите значение параметра. Если значение отсутствует, параметр равен значению по умолчанию, что равно нулю. Не добавляйте значение, если оно не отображается.
3. Щелкните правой кнопкой мыши раздел **Параметры** , выберите команду **создать**, а затем выберите **значение DWORD (32-бит)** .
4. Введите новую **базу данных имен, восстановленную из резервной копии**, и нажмите клавишу ВВОД.
5. Дважды щелкните только что созданное значение, чтобы открыть диалоговое окно **изменение значения DWORD (32-bit)** , а затем введите **1** в поле **значение** . Параметр **база данных, восстановленный из резервной копии** , доступен на контроллерах домена под Windows 2000 Server с пакетом обновления 4 (SP4), windows Server 2003 с обновлениями, включенными в [процесс обнаружения и восстановления после отката USN в Windows Server 2003, Windows Server 2008 и Windows Server 2008 R2](https://go.microsoft.com/fwlink/?linkid=137182) в базе знаний Майкрософт установлены и Windows server 2008.
6. Перезапустите контроллер домена в нормальном режиме.
7. После перезапуска контроллера домена откройте Просмотр событий. Чтобы открыть просмотр событий, нажмите кнопку **Пуск**, выберите **Панель управления**, дважды щелкните **Администрирование**, а затем **Просмотр событий**.
8. Разверните **журналы приложений и служб**, а затем щелкните журнал **служб каталогов** . Убедитесь, что события отображаются в области сведений.
9. Щелкните правой кнопкой мыши журнал **службы каталогов** и выберите пункт **найти**. В окне **найти**введите **1109**и нажмите кнопку **Найти далее**.
10. Вы должны увидеть по крайней мере запись с ИДЕНТИФИКАТОРом события 1109. Если эта запись не отображается, перейдите к следующему шагу. В противном случае дважды щелкните запись, а затем просмотрите текст, подтверждающий, что обновление было внесено в InvocationID:

    ```
    Active Directory has been restored from backup media, or has been configured to host an application partition. 
    The invocationID attribute for this directory server has been changed. 
    The highest update sequence number at the time the backup was created is <time>

    InvocationID attribute (old value):<Previous InvocationID value>
    InvocationID attribute (new value):<New InvocationID value>
    Update sequence number:<USN>

    The InvocationID is changed when a directory server is restored from backup media or is configured to host a writeable application directory partition.
    ```

11. Закройте окно просмотра событий.
12. Используйте редактор реестра, чтобы убедиться, что значение в поле **число предыдущих восстановлений DSA** равно предыдущему значению плюс один. Если это неверное значение, и в Просмотр событий не удается найти запись для события с ИДЕНТИФИКАТОРом 1109, убедитесь, что пакеты обновления контроллера домена являются актуальными. Эту процедуру нельзя повторить на том же виртуальном жестком диске. Вы можете повторить попытку, используя копию виртуального жесткого диска или другой виртуальный жесткий диск, который не был запущен в нормальном режиме, начиная с шага 1.
13. Закройте редактор реестра.

## <a name="usn-and-usn-rollback"></a>Откат USN и USN

В этом разделе описаны проблемы репликации, которые могут возникнуть в результате неправильного восстановления базы данных Active Directory с использованием более старой версии виртуальной машины. Дополнительные сведения о процессе репликации Active Directory см. в разделе [Основные понятия Active Directory репликации](../replication/active-directory-replication-concepts.md) .

## <a name="usns"></a>USN

Домен Active Directory Services (AD DS) использует порядковые номера обновления (USN) для наблюдения за репликацией данных между контроллерами домена. Каждый раз при внесении изменений в данные в каталоге USN увеличивается, чтобы указать, что было внесено изменение.

Для каждого раздела каталога, хранящегося в конечном контроллере домена, USN используются для наблюдения за последним исходным обновлением, которое контроллер домена ввел в свою базу данных, а также состояние каждого контроллера домена, на котором хранится реплика раздел каталога. Когда контроллеры домена реплицируют изменения друг на друга, они запрашивают у своих партнеров по репликации изменения с USN, превышающие USN последнего изменения, полученного от каждого участника контроллером домена.

Следующие две таблицы метаданных репликации содержат USN. Исходные и конечные контроллеры домена используют их для фильтрации обновлений, необходимых для целевого контроллера домена.

1. **Вектор синхронизации**: Таблица, которую обслуживающий конечный контроллер домена отслеживает исходные обновления, получаемые от всех исходных контроллеров домена. Когда конечный контроллер домена запрашивает изменения для раздела каталога, он предоставляет актуальный вектор к исходному контроллеру домена. Затем исходный контроллер домена использует это значение для фильтрации обновлений, отправляемых на конечный контроллер домена. Исходный контроллер домена отправляет собственный вектор синхронизации в место назначения при завершении успешного цикла репликации, чтобы убедиться, что конечный контроллер домена знает, что он синхронизирован с каждым контроллером домена. исходные обновления и обновления находятся на том же уровне, что и источник.  
2. **Верхний знак воды**: Значение, которое сохраняется в целевом контроллере домена для наблюдения за последними изменениями, полученными от определенного исходного контроллера домена для определенного раздела. Верхняя метка наводы предотвращает отправку исходного контроллера домена изменений, которые уже были получены конечным контроллером домена.  

## <a name="directory-database-identity"></a>Удостоверение базы данных каталога

Кроме USN, контроллеры домена отслеживают базу данных каталогов исходных партнеров репликации. Удостоверение базы данных каталога, работающей на сервере, сохраняется отдельно от идентификатора самого объекта сервера. Удостоверение базы данных каталога на каждом контроллере домена хранится в атрибуте **invocationID** объекта NTDS Settings, который находится в следующем пути LDAP: CN = NTDS Settings, CN = ServerName, CN = Servers, CN =*SiteName*, CN = Sites, CN = Configuration, DC =*фореструтдомаин*. Удостоверение объекта сервера хранится в атрибуте **objectGUID** объекта Settings NTDS. Идентификатор объекта сервера никогда не изменяется. Однако идентификатор базы данных каталога изменяется при возникновении на сервере процедуры восстановления состояния системы или при добавлении раздела каталога приложений, а затем удаляется и повторно добавляется с сервера. (другой сценарий. когда экземпляр HyperV активирует модули записи VSS в разделе, содержащем виртуальный жесткий диск виртуального контроллера домена, гостевая служба, в свою очередь, активирует собственные модули записи VSS (тот же механизм, который используется для резервного копирования и восстановления выше), что приводит к тому, что invocationID перезапуск

Следовательно, **invocationID** эффективно связывает набор исходных обновлений на контроллере домена с определенной версией базы данных каталога. В таблицах с высоким приоритетом и высокой наметкой настольных устройств используется идентификатор GUID **invocationID** и DC соответственно, чтобы контроллеры домена могли понять, из какой копии Active Directoryной базы данных поступают сведения о репликации.

**InvocationID** — это значение глобального уникального идентификатора (GUID), отображаемое в верхней части выходных данных после выполнения команды **repadmin/шоврепл**. Следующий текст представляет пример выходных данных команды:

   ```
   Repadmin: running command /showrepl against full DC local host
   Default-First-Site-Name\VDC1
   DSA Options: IS_GC
   DSA object GUID: 966651f3-a544-461f-9f2c-c30c91d17818
   DSA invocationID: b0d9208b-8eb6-4205-863d-d50801b325a9
   ```

Когда AD DS правильно восстанавливается на контроллере домена, **invocationID** сбрасывается. В результате этого изменения будет возникать увеличение трафика репликации — время, относительное относительно размера реплицируемой секции.

Например, предположим, что VDC1 и DC2 являются двумя контроллерами домена в одном домене. На следующем рисунке показано восприятие DC2 о VDC1, когда значение invocationID сбрасывается в надлежащей ситуации восстановления.

![](media/virtualized-domain-controller-architecture/Dd363553.ca71fc12-b484-47fb-991c-5a0b7f516366(WS.10).gif)

## <a name="usn-rollback"></a>Откат USN

Откат USN происходит, когда обычные обновления USN обрабатываются, и контроллер домена пытается использовать USN, который ниже последнего обновления. В большинстве случаев будет обнаружен откат USN, и репликация будет остановлена до создания расхождения в лесу. 

Откат USN может быть вызван многими способами, например при использовании старых файлов виртуального жесткого диска (VHD) или преобразования физического компьютера в виртуальную машину (P2V), не гарантируя, что физический компьютер не будет постоянно оставаться вне сети после преобразования. Выполните следующие меры предосторожности, чтобы убедиться, что откат USN не выполняется.

   - Если не используется Windows Server 2012 или более поздней версии, не следует использовать моментальный снимок виртуальной машины контроллера домена.
   - Не копируйте VHD-файл контроллера домена.  
   - Если не используется Windows Server 2012 или более поздней версии, не экспортируйте виртуальную машину, на которой работает контроллер домена.  
   - Не восстанавливайте контроллер домена или попытайтесь выполнить откат содержимого базы данных Active Directory любым другим способом, отличным от поддерживаемого решения резервного копирования, например cистема архивации данных Windows Server.  

В некоторых случаях откат USN может быть незамеченным. В других случаях это может привести к другим ошибкам репликации. В таких случаях необходимо вычислить степень проблемы и своевременно принять ее. Сведения об удалении устаревших объектов, которые могут возникнуть в результате отката USN, см. в разделе [устаревшие Active Directory объекты создание события с идентификатором 1988 в Windows Server 2003](https://go.microsoft.com/fwlink/?linkid=137185) в базе знаний Майкрософт.

## <a name="usn-rollback-detection"></a>Обнаружение отката USN

В большинстве случаев откат USN без соответствующего сброса **invocationID** , вызванный неправильными процедурами восстановления, не обнаружен. Windows Server 2008 обеспечивает защиту от неверной репликации после неправильной операции восстановления контроллера домена. Эти защиты активируются тем фактом, что неправильное восстановление приводит к снижению USN, представляющим исходные изменения, которые партнеры репликации уже получили.

В Windows Server 2008 и Windows Server 2003 с пакетом обновления 1 (SP1), когда конечный контроллер домена запрашивает изменения с помощью ранее использованного USN, ответ от его исходного партнера репликации интерпретируется конечным контроллером домена, что означает, что его репликация Метаданные устарели. Это означает, что база данных Active Directory на исходном контроллере домена была возвращена в предыдущее состояние. Например, был выполнен откат VHD-файла виртуальной машины к предыдущей версии. В этом случае конечный контроллер домена инициирует следующие меры карантина на контроллере домена, который был идентифицирован как неправильное восстановление:

   - AD DS приостанавливает работу службы сетевого входа в систему, которая предотвращает изменение паролей учетных записей и учетных записей компьютеров. Это действие предотвращает потерю таких изменений, если они происходят после неправильного восстановления.  
   - AD DS отключает репликацию входящих и исходящих Active Directory.  
   - AD DS создает событие с ИДЕНТИФИКАТОРом 2095 в журнале событий службы каталогов для указания условия.  

На следующем рисунке показана последовательность событий, возникающих при обнаружении отката USN в VDC2, на целевом контроллере домена, который выполняется на виртуальной машине. На этом рисунке обнаружение отката USN выполняется в VDC2, когда партнер по репликации обнаруживает, что VDC2 отправил значение USN, которое ранее было замечено целевым контроллером домена. Это означает, что был выполнен откат базы данных VDC2's. в неправильном времени.

![](media/virtualized-domain-controller-architecture/Dd363553.373b0504-43fc-40d0-9908-13fdeb7b3f14(WS.10).gif)

Если журнал событий службы каталогов сообщает о событии с ИДЕНТИФИКАТОРом 2095, выполните следующую процедуру немедленно.

## <a name="to-resolve-event-id2095"></a>Разрешение идентификатора события 2095

1. Изолируйте виртуальную машину, которая записала ошибку из сети.
2. Попробуйте определить, поступили ли какие либо изменения с этого контроллера домена и распространены на другие контроллеры домена. Если событие было результатом запуска моментального снимка или копии виртуальной машины, попробуйте определить время отката USN. Затем можно проверить партнеров репликации этого контроллера домена, чтобы определить, выполнялась ли репликация с того же момента.

   Это определение можно выполнить с помощью средства Repadmin. Сведения об использовании repadmin см. в разделе [мониторинг и устранение неполадок Active Directory репликации с помощью repadmin](https://go.microsoft.com/fwlink/?linkid=122830). Если вы не можете определить это самостоятельно, обратитесь за помощью к [Служба поддержки Майкрософт](https://support.microsoft.com) .

3. Принудительное понижение роли контроллера домена. Это включает в себя очистку метаданных контроллера домена и получение хозяина операций (также известных как гибкие роли с одним хозяином операций или FSMO). Дополнительные сведения см. в подразделе «Восстановление из отката USN» статьи [Обнаружение и восстановление после отката USN в Windows server 2003, Windows server 2008 и Windows server 2008 R2](https://go.microsoft.com/fwlink/?linkid=137182) в базе знаний Майкрософт.
4. Удалите все старые VHD-файлы для контроллера домена.

## <a name="undetected-usn-rollback"></a>Необнаруженный откат USN

Откат USN может не обнаруживаться в одном из двух случаев:

1. VHD-файл присоединяется к разным виртуальным машинам, работающим в нескольких расположениях одновременно.  
2. USN на восстановленном контроллере домена увеличился после последнего USN, полученного другим контроллером домена.  

В первом случае другие контроллеры домена могут реплицироваться на одну из виртуальных машин, и изменения могут возникать на любой виртуальной машине без репликации в другой. Это расхождение леса сложно обнаружить, и это приведет к непредсказуемым ответам на каталог. Такая ситуация может возникать после миграции P2V, если в одной сети работают как физическая, так и виртуальная машина. Это также может произойти, если несколько виртуальных контроллеров домена создаются с одного физического контроллера домена, а затем выполняются в одной сети.

Во втором случае диапазон USN применяется к двум разным наборам изменений. Это может продолжаться в течение длительных периодов без обнаружения. Всякий раз при изменении объекта, созданного во время этого времени, в Просмотр событий обнаруживается и сообщается как событие с ИДЕНТИФИКАТОРом 1988. На следующем рисунке показано, как откат USN может не обнаруживаться в подобных обстоятельствах.

![](media/virtualized-domain-controller-architecture/Dd363553.63565fe0-d970-4b4e-b5f3-9c76bc77e2d4(WS.10).gif)

## <a name="read-only-domain-controllers"></a>Контроллеры домена только для чтения

RODC — это контроллеры домена, на которых размещаются копии секций, доступные только для чтения, в базе данных Active Directory. Контроллеры RODC позволяют избежать большинства проблем отката USN, поскольку они не реплицируют никаких изменений на другие контроллеры домена. Однако если RODC реплицируется с контроллера домена, доступного для записи, который был затронут откатом USN, также затронет RODC.

Восстановление RODC с помощью моментального снимка не рекомендуется. Восстановите RODC с помощью приложения резервного копирования, совместимого с Active Directory. Кроме того, как и в случае с записываемыми контроллерами домена, необходимо соблюдать осторожность, чтобы не допустить автономной работы RODC в течение времени существования захоронения. Это условие может привести к появлению устаревших объектов на контроллере домена только для чтения.

Дополнительные сведения о RODC см. в [статье Планирование и развертывание контроллера домена только для чтения](../../deploy/rodc/read-only-domain-controller-updates.md).
