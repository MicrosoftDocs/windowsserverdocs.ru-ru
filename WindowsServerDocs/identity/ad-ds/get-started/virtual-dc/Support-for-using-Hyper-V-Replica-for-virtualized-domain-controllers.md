---
ms.assetid: 45a65504-70b5-46ea-b2e0-db45263fabaa
title: "Поддержка использования реплики Hyper-V для виртуализированных контроллеров домена"
description: 
author: billmath
ms.author: billmath
manager: femila
ms.date: 05/31/2017
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: identity-adds
ms.openlocfilehash: 0444198196ed08a22aba92a0f59cc6e7a2518a2e
ms.sourcegitcommit: db290fa07e9d50686667bfba3969e20377548504
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/12/2017
---
# <a name="support-for-using-hyper-v-replica-for-virtualized-domain-controllers"></a>Поддержка использования реплики Hyper-V для виртуализированных контроллеров домена

>Область применения: Windows Server 2016, Windows Server 2012 R2, Windows Server 2012

В этом разделе поясняется поддержка использования реплики Hyper-V для репликации виртуальной машины (VM), которая работает в качестве контроллера домена (DC). Реплика Hyper-V — это новая возможность Hyper-V, начиная с Windows Server 2012, который предоставляет встроенный механизм репликации на уровне виртуальных Машин.  
  
Реплика Hyper-V асинхронно реплицирует выбранные виртуальные машины с основного узла Hyper-V на узел реплики Hyper-V по локальной или ГЛОБАЛЬНОЙ сети. После завершения начальной репликации последующие изменения реплицируются с интервалом, заданным администратором.  
  
Отработка отказа может быть запланированной или незапланированной. Запланированная отработка отказа инициируется администратором для основной виртуальной машины, а все нереплицированные изменения копируются на виртуальную Машину реплики для предотвращения потери данных. Незапланированная отработка отказа инициируется на виртуальной Машине реплики в ответ на непредвиденный сбой основной виртуальной машины. Из-за отсутствия возможности передать изменения на основной виртуальной Машины, возможно, не были реплицированы еще возможна потеря данных.  
  
Дополнительные сведения о реплике Hyper-V см. в разделе [Обзор реплики Hyper-V](https://technet.microsoft.com/library/jj134172.aspx) и [развертывание реплики Hyper-V](https://technet.microsoft.com/library/jj134207.aspx).  
  
> [!NOTE]  
> Реплика Hyper-V может выполняться только на Windows Server Hyper-V, не версии Hyper-V, работающей в Windows 8.  
  
## <a name="windows-server-2012-domain-controllers-required"></a>Требуется контроллер домена Windows Server 2012  
Windows Server 2012 Hyper-V также появился ИД создания виртуальной Машины (VMGenID). ИД создания виртуальной машины предоставляет способ низкоуровневой оболочке средство взаимодействия с гостевой ОС при внесении существенных изменений. Например низкоуровневая оболочка может сообщить виртуализированному контроллеру домена произошло что восстановление из моментального снимка (технология Hyper-V моментальный снимок восстановления, не резервного копирования и восстановления). AD DS в Windows Server 2012 поддерживают технологию виртуальных Машин VMGenID и используют ее для обнаружения при выполнении операций низкоуровневой оболочки, таких как восстановление моментального снимка, что обеспечивает более высокий уровень защиты.  
  
> [!NOTE]  
> Чтобы усилить AD DS на контроллеры домена Windows Server 2012 предоставляет указанные меры обеспечения безопасности с ИД создания виртуальной машины; Контроллеры домена под управлением всех предыдущих выпусков Windows Server могут возникать проблемы, например, откат номера последовательного обновления, который может возникнуть при восстановлении виртуализированного контроллера домена с использованием неподдерживаемого механизма, такого как восстановление моментального снимка. Дополнительные сведения об этих мерах безопасности и условиях их активации см. в разделе [архитектура виртуализованных контроллеров доменов](https://technet.microsoft.com/library/jj574118.aspx).  
  
В случае отработки отказа реплики Hyper-V (запланированная или незапланированная), Windows Server 2012 виртуализированных DC обнаруживает Сброс VMGenID, что приводит к активации указанных выше мер безопасности. Операции Active Directory перейдите в обычном режиме. Реплика виртуальных Машин выполняется вместо основной виртуальной Машины.  
  
> [!NOTE]  
> Учитывая, что теперь существует теперь двух экземпляров одного удостоверения контроллера домена, существует вероятность для основного экземпляра и реплицированного экземпляра для запуска. Реплики Hyper-V снабжена управляющими механизмами, предотвращающими основной и реплика виртуальные машины не запускаются одновременно, но, возможно для их запуск в то же время в случае обрыва канала связи между ними после репликации виртуальной машины. Маловероятно виртуальные контроллеры домена под управлением Windows Server 2012 предусмотрены меры безопасности для защиты Доменных службах Active Directory, не выбирайте в виртуализированных контроллерах домена под управлением более ранних версий Windows Server.  
  
При использовании реплики Hyper-V, убедитесь, что выполнены рекомендации для [виртуальных контроллеров домена под управлением Hyper-V](https://technet.microsoft.com/library/virtual_active_directory_domain_controller_virtualization_hyperv(v=WS.10).aspx). В этом разделе рассматриваются, например, рекомендации по хранению файлов Active Directory на виртуальных дисках SCSI, что позволяет гарантировать сохранность данных.  
  
## <a name="supported-and-unsupported-scenarios"></a>Поддерживаемые и неподдерживаемые сценарии  
Для незапланированной отработки отказа и тестированию отработки отказа поддерживаются только виртуальные машины под управлением Windows Server 2012. Даже при запланированной отработки отказа Windows Server 2012 рекомендуется виртуализованного контроллера домена чтобы снизить риски в случае, когда администратор непреднамеренно запускает основной виртуальной Машины и реплицированную виртуальную Машину в то же время.  
  
Виртуальные машины под управлением более ранних версий Windows Server поддерживаются для запланированной отработки отказа, но не поддерживаются для незапланированной отработки отказа в связи с риском отката номера последовательного обновления. Дополнительные сведения об откате USN см. в разделе [USN и откат USN](https://technet.microsoft.com/library/d2cae85b-41ac-497f-8cd1-5fbaa6740ffe(v=ws.10)).  
  
> [!NOTE]  
> Существует без требований к режиму работы для домена или леса; существует только требования к операционной системе для контроллеров домена, работающих в качестве виртуальных машин, которые реплицируются с использованием реплики Hyper-V. Виртуальные машины можно развернуть в лесу, содержащем другие физические или виртуальные контроллеры домена, которые под управлением более ранних версий Windows Server и может не также реплицироваться с помощью реплики Hyper-V.  
  
Данное заявление о поддержке основано на тестах, проведенных в лесе с одним домена, однако конфигурации леса с несколькими доменами также поддерживаются. Для этих тестов виртуализированные контроллеры домена DC1 и DC2 являются партнерами репликации по Active Directory на том же сайте, размещенном на сервере под управлением Hyper-V в Windows Server 2012. Гостевой виртуальной Машины, где выполняется DC2 имеет включена реплика Hyper-V. Сервер-реплика размещается в другом географически удаленном центре обработки данных. Чтобы упростить восприятие приведенных ниже процедур тестового случая, виртуальная машина, работающая на сервере-реплике называется DC2-Rec (хотя на практике она сохраняет имя исходной виртуальной машины).  
  
### <a name="windows-server-2012"></a>Windows Server 2012  
В следующей таблице поясняется поддержка виртуализированных контроллеров домена под управлением Windows Server 2012 и тестовых случаев.  
  
|||  
|-|-|  
|Плановую отработку отказа|Незапланированная отработка отказа|  
|Поддерживается|Поддерживается|  
|Тестовый случай:<br /><br />-DC1 и DC2 под управлением Windows Server 2012.<br /><br />-DC2 отключен, и отработка отказа выполняется на DC2-Rec. Отработка отказа может быть запланированной или незапланированной.<br /><br />-После запуска DC2-Rec проверяет, совпадает ли значение VMGenID в его базе данных значение из драйвера виртуальной машины, сохраненным сервером реплики Hyper-V.<br /><br />— В результате DC2-Rec активирует меры безопасности виртуализации; Другими словами он сбрасывает свой InvocationID, отменяет свой пул относительных ИДЕНТИФИКАТОРОВ и задает требование начальной синхронизации, прежде чем делать предположение о роли хозяина операций. Дополнительные сведения о требовании начальной синхронизации см. в разделе.<br /><br />-DC2-Rec сохраняет новое значение VMGenID в своей базе данных и фиксирует все последующие обновления в контексте нового InvocationID.<br /><br />-Из-за сброса InvocationID DC1 объединит все AD изменения, внесенные DC2-Rec, даже в случае отката по времени, таким образом, все обновления AD выполняется на DC2-Rec после отработки отказа выполняется безопасное схождение|Данный тестовый случай аналогичен случаю для запланированной отработки отказа, со следующими исключениями:<br /><br />-Всех Рекламных обновления, полученные на DC2, но еще не реплицированные AD на партнера репликации до выполнения отработки отказа, будут утеряны.<br /><br />-AD обновлений, полученные на DC2 после точки восстановления, которые были реплицированы Active Directory на DC1 будут реплицированы с DC1 обратно на DC2-Rec.|  
  
### <a name="windows-server-2008-r2-and-earlier-versions"></a>Windows Server 2008 R2 и более ранних версий  
В следующей таблице поясняется поддержка виртуализированных контроллеров домена под управлением Windows Server 2008 R2 и более ранних версий.  
  
|||  
|-|-|  
|Плановую отработку отказа|Незапланированная отработка отказа|  
|Поддерживается, но не рекомендуется, так как контроллеры домена под управлением этих версий Windows Server, не поддерживают VMGenID или использование соответствующих мер. Поэтому они подвержены риску отката номера последовательного обновления. Дополнительные сведения см. в разделе [USN и откат USN](https://technet.microsoft.com/en-us/library/d2cae85b-41ac-497f-8cd1-5fbaa6740ffe(v=ws.10)).|Не поддерживается **Примечание:** Незапланированная отработка отказа поддерживается только где откат USN не представляет угрозу, например единственного контроллера домена в лесу (использовать такую конфигурацию не рекомендуется).|  
|Тестовый случай:<br /><br />-DC1 и DC2 под управлением Windows Server 2008 R2.<br /><br />-DC2 отключен, и на DC2-Rec выполняется запланированная отработка отказа. Все данные на DC2 реплицируются на DC2-Rec до завершения работы.<br /><br />-После запуска DC2-Rec возобновляет репликацию с DC1, используя то же значение invocationID, что и DC2.|Н/Д|  
  


