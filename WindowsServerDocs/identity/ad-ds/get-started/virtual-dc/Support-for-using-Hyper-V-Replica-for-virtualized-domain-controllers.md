---
ms.assetid: 45a65504-70b5-46ea-b2e0-db45263fabaa
title: Поддержка использования реплики Hyper-V для виртуализированных контроллеров домена
author: iainfoulds
ms.author: daveba
manager: daveba
ms.date: 05/31/2017
ms.topic: article
ms.openlocfilehash: 0a8d59da05f7dbf675114c96ceac5e755b06a66a
ms.sourcegitcommit: b115e5edc545571b6ff4f42082cc3ed965815ea4
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/30/2020
ms.locfileid: "93071056"
---
# <a name="support-for-using-hyper-v-replica-for-virtualized-domain-controllers"></a>Поддержка использования реплики Hyper-V для виртуализированных контроллеров домена

> Область применения. Windows Server 2016, Windows Server 2012 R2, Windows Server 2012

В данном разделе поясняется поддержка использования реплики Hyper-V для репликации виртуальной машины, которая работает в качестве контроллера домена. Реплика Hyper-V — это новый компонент Hyper-V, появившийся в Windows Server 2012, который предоставляет встроенный механизм репликации на уровне виртуальных машин.

Реплика Hyper-V асинхронно реплицирует выбранные виртуальные машины с основного узла Hyper-V на узел реплики Hyper-V по каналам локальной или глобальной сети. После завершения начальной репликации последующие изменения реплицируются с интервалом, заданным администратором.

Отработка отказа может быть как запланированной, так и незапланированной. Запланированная отработка отказа инициируется администратором для основной виртуальной машины, а все нереплицированные изменения копируются в виртуальную машину реплики для предотвращения потери данных. Незапланированная отработка отказа инициируется в виртуальной машине реплики при реагировании на непредвиденный сбой основной виртуальной машины. Потеря данных может произойти из-за отсутствия возможности передать изменения на основной виртуальной машине, которые, возможно, еще не были реплицированы.

Дополнительные сведения о Hyper-V Replica см. в разделе [Обзор Hyper-V Replica](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/jj134172(v=ws.11)) и [Развертывание Hyper-V Replica](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/jj134207(v=ws.11)).

> [!NOTE]
> Реплика Hyper-V может выполняться только в Windows Server Hyper-V, в версии Hyper-V под управлением Windows 8 этот компонент не работает.

## <a name="windows-server-2012-or-newer-domain-controllers-required"></a>Требуются контроллеры домена Windows Server 2012 или более поздней версии

Windows Server 2012 Hyper-V представил VM-GenerationID (Вмженид). ИД создания виртуальной машины предоставляет низкоуровневой оболочке средство взаимодействия с гостевой ОС при внесении существенных изменений. Например, низкоуровневая оболочка может сообщить виртуализированному контроллеру домена, что было выполнено восстановление из моментального снимка (технология восстановления моментальных снимков Hyper-V, а не резервных копий). AD DS в Windows Server 2012 и более новых версиях осведомлены о технологии виртуальных машин Вмженид и использует ее для обнаружения выполнения операций гипервизора, таких как восстановление моментальных снимков, что позволяет ИТ-специалистам лучше защищать себя.

> [!NOTE]
> Эти меры безопасности, полученные из Вмженид, обеспечивают только AD DS контроллеров доменов Windows Server 2012 или более поздней версии. Контроллеры доменов, на которых работают все предыдущие выпуски Windows Server, подвержены таким проблемам, как откат USN, который может произойти при восстановлении виртуального контроллера домена с помощью неподдерживаемого механизма, такого как восстановление моментальных снимков. Дополнительные сведения об этих мерах безопасности и условиях их активации см. в разделе [Архитектура виртуализированных контроллеров доменов](./virtualized-domain-controller-architecture.md).

Если происходит отработка отказа реплики Hyper-V (запланированная или незапланированная), виртуализированный контроллер домена обнаруживает Вмженид сброс, активируя вышеупомянутые функции безопасности. После этого операции Active Directory продолжают выполняться в обычном режиме. Виртуальная машина реплики выполняется вместо основной виртуальной машины.

> [!NOTE]
> Учитывая наличие двух экземпляров одного удостоверения контроллера домена, существует вероятность одновременного выполнения как основного, так и реплицированного экземпляра. Хотя реплика Hyper-V снабжена управляющими механизмами, предотвращающими одновременное выполнение основной виртуальной машины и виртуальной машины реплики, такая ситуация все же возможна в случае обрыва канала связи между ними после репликации виртуальной машины. Если такая маловероятная ситуация все же возникнет, в виртуализированных контроллерах домена под управлением Windows Server 2012 предусмотрены специальные меры безопасности для защиты доменных служб Active Directory, в виртуализированных контроллерах домена, работающих под управлением предыдущих версий Windows Server, такие меры отсутствуют.

При использовании Hyper-V Replica убедитесь, что выполнены рекомендации для [работающих виртуальных контроллеров доменов на Hyper-V](/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/dd363553(v=ws.10)). Среди прочего, в этом разделе рассматриваются рекомендации по хранению файлов Active Directory на виртуальных дисках SCSI, что позволяет гарантировать сохранность данных.

## <a name="supported-and-unsupported-scenarios"></a>Поддерживаемые и неподдерживаемые сценарии

Для внеплановой отработки отказа и тестирования отработки отказа поддерживаются только виртуальные машины под управлением Windows Server 2012 или более поздней версии. Даже для плановой отработки отказа рекомендуется использовать Windows Server 2012 или более поздней версии для виртуального контроллера домена, чтобы снизить риски в том случае, если администратор случайно запустит как основную виртуальную машину, так и реплицированную виртуальную машину одновременно.

Виртуальные машины под управлением предыдущих версий Windows Server поддерживаются для запланированной отработки отказа, однако не поддерживаются для незапланированной отработки отказа в связи с риском отката номера последовательного обновления. Дополнительные сведения об откате USN см. в разделе [USN и откат USN](/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/dd363553(v=ws.10)).

> [!NOTE]
> Требования к режиму работы для домена или леса отсутствуют, имеются требования только требования к операционной системе для контроллеров домена, работающих в качестве виртуальных машин, которые реплицируются с использованием реплики Hyper-V. Виртуальные машины можно развернуть в лесу, содержащем другие физические или виртуальные контроллеры домена, которые работают под управлением предыдущих версий Windows Server и также могут как реплицироваться, так и не реплицироваться с помощью реплики Hyper-V.

Данное заявление о поддержке основано на тестах, проведенных в лесе с одним доменом, однако конфигурации леса с несколькими доменами также поддерживаются. Для этих тестов виртуализированные контроллеры домена DC1 и DC2 являются партнерами репликации Active Directory на одном сайте, размещенном на сервере, где выполняется Hyper-V в Windows Server 2012. В операционной системе виртуальной машины, где выполняется DC2, включена реплика Hyper-V. Сервер-реплика размещается в другом географически удаленном центре обработки данных. Чтобы упростить восприятие приведенных ниже процедур тестового случая, для виртуальной машины, выполняемой на сервере-реплике, используется имя DC2-Rec (хотя на практике она сохраняет имя исходной виртуальной машины).

### <a name="windows-server-2012"></a>Windows Server 2012

В следующей таблице поясняется поддержка виртуализированных контроллеров домена, работающих под управлением Windows Server 2012, и тестовых случаев.

| Выполняет плановую отработку отказа. | Незапланированная отработка отказа |
|--|--|
| Поддерживается | Поддерживается |
| Тестовый случай:<p>— DC1 и DC2 работают под управлением Windows Server 2012.<p>-DC2 завершает работу и отработка отказа выполняется на DC2-REC. Отработка отказа может быть запланированной или незапланированной.<p>-После запуска DC2-Rec проверяет, совпадает ли значение Вмженид в его базе данных со значением из драйвера виртуальной машины, сохраненного на сервере реплики Hyper-V.<p>В результате DC2-Rec инициирует защиту виртуализации; Иными словами, он сбрасывает свой InvocationID, удаляет пул RID и устанавливает начальное требование к синхронизации, прежде чем будет предпринимать роль хозяина операций. Дополнительные сведения о требовании начальной синхронизации см. в разделе .<p>-DC2-Rec сохраняет новое значение Вмженид в своей базе данных и фиксирует все последующие обновления в контексте нового InvocationID.<p>В результате сброса InvocationID DC1 будет объединять все изменения AD, появившиеся DC2-Rec даже в случае отката времени, что означает, что все обновления AD, выполненные на DC2-Rec после отработки отказа, безопасно сходятся. | Данный тестовый случай аналогичен случаю для запланированной отработки отказа, за исключением следующего:<p>— Все обновления AD, полученные на DC2, но еще не реплицированные AD на партнера репликации до тех пор, пока не будет потеряно событие отработки отказа.<p>— Обновления AD, полученные на DC2 после момента точки восстановления, реплицированной AD на DC1, будут реплицированы с DC1 обратно на DC2-REC. |

### <a name="windows-server-2008-r2-and-earlier-versions"></a>Windows Server 2008 R2 и более ранних версий

В следующей таблице поясняется поддержка виртуализированных контроллеров домена, работающих под управлением Windows Server 2008 R2 и более ранних версий.

| Выполняет плановую отработку отказа. | Незапланированная отработка отказа |
|--|--|
| Поддерживается, но не рекомендуется, так как контроллеры домена, работающие под управлением этих версий Windows Server, не поддерживают VMGenID или использование соответствующих мер безопасности. Поэтому они подвержены риску отката номера последовательного обновления. Дополнительные сведения см. в разделе [USN и откат USN](/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/dd363553(v=ws.10)). | Не поддерживается<p>**Примечание.** Будет поддерживаться внеплановая отработка отказа, где откат USN не является риском, например, одним контроллером домена в лесу (Нерекомендуемая конфигурация). |
| Тестовый случай:<p>— DC1 и DC2 работают под управлением Windows Server 2008 R2.<p>-DC2 завершает работу, а плановая отработка отказа выполняется на DC2-REC. Все данные на DC2 реплицируются на DC2-Rec до завершения завершения работы.<p>-После запуска DC2-Rec будет возобновлена репликация на DC1 с использованием того же invocationID, что и DC2. | Н/Д |
