---
ms.assetid: b146f47e-3081-4c8e-bf68-d0f993564db2
title: "Развертывание виртуализированных контроллеров домена и конфигурации"
description: 
author: billmath
ms.author: billmath
manager: femila
ms.date: 05/31/2017
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: identity-adds
ms.openlocfilehash: dcb377cef003458bcdf2e4b3564167cee4310020
ms.sourcegitcommit: db290fa07e9d50686667bfba3969e20377548504
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/12/2017
---
# <a name="virtualized-domain-controller-deployment-and-configuration"></a>Развертывание виртуализированных контроллеров домена и конфигурации

>Область применения: Windows Server 2016, Windows Server 2012 R2, Windows Server 2012

Содержание раздела  
  
-   [Рекомендации по установке](../../../ad-ds/get-started/virtual-dc/Virtualized-Domain-Controller-Deployment-and-Configuration.md#BKMK_InstallConsiderations)  
  
    Это включает в себя требования к платформе и другие важные ограничения.  
  
-   [Виртуализированных домена при клонировании контроллера](../../../ad-ds/get-started/virtual-dc/Virtualized-Domain-Controller-Deployment-and-Configuration.md#BKMK_VDCCloning)  
  
    Этот раздел содержит подробное описание всего Виртуализированный контроллер домена процесса клонирования.  
  
-   [Восстановление виртуализированного контроллера домена безопасном](../../../ad-ds/get-started/virtual-dc/Virtualized-Domain-Controller-Deployment-and-Configuration.md#BKMK_VDCSafeRestore)  
  
    Этот раздел содержит подробное описание проверок, выполняемых во время безопасного восстановления виртуализованных домена контроллера.  
  
## <a name="BKMK_InstallConsiderations"></a>Рекомендации по установке  
Нет специальные роли или установки компонента для виртуализированных контроллеров домена; все контроллеры домена автоматически получают возможности клонирования и безопасного восстановления. Невозможно удалить или отключить их.  
  
Для использования контроллеров домена Windows Server 2012 требуется схема Windows Server 2012 AD доменных служб Active Directory версии 56 или выше и режим работы леса основному режиму Windows Server 2003 или более поздней версии.  
  
Как доступный для записи только для чтения контроллерами домена и поддерживают все функции виртуализированного контроллера домена, включая глобальные каталоги и роли FSMO.  
  
> [!IMPORTANT]  
> Время начала клонирования владелец роли FSMO эмулятора PDC необходимо online.  
  
### <a name="BKMK_PlatformReqs"></a>Требования к платформе  
Виртуализированный контроллер домена предъявляет:  
  
-   Роль FSMO эмулятора PDC, размещенные на Контроллере домена Windows Server 2012  
  
-   Эмулятор PDC доступен во время выполнения операций клонирования  
  
Клонирования и безопасного восстановления требуется:  
  
-   Windows Server 2012, в виртуализированных гостевых систем  
  
-   Платформа узла виртуализации, поддерживающая ИД создания Виртуальной машины (VMGID)  
  
Просмотрите приведенную ниже таблицу для продукты для виртуализации и узнать, поддерживают ли они виртуализированные контроллеры домена и ИД создания виртуальной Машины.  
  
|||  
|-|-|  
|**Продукт виртуализации**|**Поддерживает виртуализированные контроллеры домена и VMGID**|  
|**Сервер Microsoft Windows Server 2012 с компонентом Hyper-V**|Да|  
|**Microsoft Windows Server 2012 Hyper-V Server**|Да|  
|**Microsoft Windows 8 с компонентом клиента Hyper-V**|Да|  
|**Windows Server 2008 R2 и Windows Server 2008**|Нет|  
|**Решения виртуализации сторонних разработчиков**|Обратитесь к поставщику|  
  
Хотя корпорация Майкрософт поддерживает Windows 7 Virtual PC, Virtual PC 2007, Virtual PC 2004 и Virtual Server 2005, они не могут запускать 64-разрядные Гости и не поддерживают ИД создания виртуальной Машины.  
  
Справку по сторонним продуктам виртуализации и их поддержка защиты виртуализированные контроллеры домена обратитесь к их поставщику напрямую.  
  
Дополнительные сведения см. в политике поддержки для [программного обеспечения корпорации Майкрософт под управлением программного обеспечения виртуализации оборудования сторонних производителей](https://support.microsoft.com/kb/897615).  
  
### <a name="critical-caveats"></a>Важные замечания  
Виртуализированные контроллеры домена *не* поддерживают безопасное восстановление следующих:  
  
-   Файлы VHD и VHDX, вручную скопированные поверх существующих файлов VHD.  
  
-   Файлы VHD и VHDX, восстановленные с помощью программы резервного копирования файлов или целых дисков.  
  
> [!NOTE]  
> Файлы VHDX появились Windows Server 2012 Hyper-V.  
  
Ни одна из этих операций распространяются семантику ИД создания виртуальной Машины и поэтому не изменяет ИД создания Виртуальной машины. Восстановление контроллеров домена с помощью этих методов может либо привести к откату номера последовательного обновления и поместить в карантин контроллера домена или появлению устаревших объектов и потребности выполнения очистки на уровне леса.  
  
> [!WARNING]  
> Восстановление виртуализированного контроллера домена безопасном не является заменой резервных копий состояния системы и AD DS корзины.  
>   
> После восстановления снимка, сведения о нереплицированных ранее изменениях, имевших место на этом контроллере домена после создания моментального снимка, будут утеряны окончательно. Безопасное восстановление проводится автоматических непринудительного восстановления, чтобы предотвратить случайный карантин контроллера домена *только*.  
  
Дополнительные сведения о сигнальных пакетах номера последовательного обновления и устаревших объектах см. в разделе [операциями устранения неполадок Active Directory, завершающимися с ошибкой 8606: «задано недостаточно атрибутов для создания объекта»](https://support.microsoft.com/kb/2028495).  
  
## <a name="BKMK_VDCCloning"></a>Виртуализированных домена при клонировании контроллера  
Существует несколько этапов и клонирование Виртуализированный контроллер домена, независимо от того, с помощью графических средств или Windows PowerShell. На высоком уровне можно выделить три этапа:  
  
**Подготовка среды**  
  
-   Шаг 1: Проверка поддержки ИД создания Виртуальной машины и клонирования  
  
-   Шаг 2: Убедитесь, что роль эмулятора PDC размещается на контроллере домена под управлением Windows Server 2012, что он подключен к сети и доступен по клонированного контроллера домена во время операции клонирования.  
  
**Подготовка исходного контроллера домена**  
  
-   Шаг 3: Авторизация исходного контроллера домена для клонирования  
  
-   Шаг 4: Удаление несовместимых служб или программ или добавление их в файл CustomDCCloneAllowList.xml.  
  
-   Шаг 5: Создание DCCloneConfig.xml  
  
-   Шаг 6: Перевод исходного контроллера домена в автономный режим  
  
**Создание клонированного контроллера домена**  
  
-   Шаг 7: Копирование или экспорт исходной виртуальной Машины и добавление XML, если не сделано.  
  
-   Шаг 8: Создание новой виртуальной машины из копии  
  
-   Шаг 9: Запуск новой виртуальной машины для начала клонирования.  
  
Существует не различается в операции при использовании графических средств, таких как консоль управления Hyper-V или средства командной строки, таких как Windows PowerShell, поэтому шаги перечислены всего один раз для обоих интерфейсов. В этом разделе приведены примеры Windows PowerShell для вы можете изучить в сквозном режиме автоматизации процесса клонирования; они не требуются для всех действий. Нет никаких графических средств управления для визуализированных контроллеров домена в состав Windows Server 2012.  
  
Существует несколько мест в процедуре, где вы можете выбрать способ создания клонированного компьютера, а также как добавить файлы xml; Эти этапы указаны ниже. В остальном процесс выполняется.  
  
Далее показаны виртуализированных домена процесс клонирования контроллера, где домен уже существует.  
  
![Развертывание виртуализированного контроллера домена](media/Virtualized-Domain-Controller-Deployment-and-Configuration/ADDS_VDC_CloningProcessFlow.png)  
  
### <a name="step-1---validate-the-hypervisor"></a>Шаг 1 - Проверка низкоуровневой оболочки  
Убедитесь, что исходный контроллер домена выполняется в поддерживаемой низкоуровневой оболочке, изучите документацию поставщика. Виртуализированные контроллеры домена не привязаны к низкоуровневой оболочке и не требуют Hyper-V.  
  
Если в качестве низкоуровневой оболочки используется Microsoft Hyper-V, убедитесь, что он под управлением Windows Server 2012. Это можно проверить с помощью диспетчера устройств  
  
Откройте **Devmgmt.msc** и просмотрите **системные устройства** наличие установленных драйверов и устройств Microsoft Hyper-V. Для виртуализированного контроллера домена требуется системное устройство **Microsoft Hyper-V Generation Counter** (драйвер: vmgencounter.sys).  
  
![Развертывание виртуализированного контроллера домена](media/Virtualized-Domain-Controller-Deployment-and-Configuration/ADDS_VDC_HyperVVMGenIDCounter.png)  
  
### <a name="step-2---verify-the-pdce-fsmo-role"></a>Шаг 2 - проверить роль PDCE FSMO  
Прежде чем пытаться клонировать контроллер домена, необходимо проверить, что контроллер домена, где основной FSMO эмулятора контроллер домена работает под управлением Windows Server 2012. Эмулятор PDC (PDCE) необходим по нескольким причинам:  
  
1.  PDCE создает специальную **клонируемые контроллеры домена** группы и задает для нее разрешение на корневого домена, чтобы позволить контроллеру домена клонирование самого себя.  
  
2.  Клонирующий контроллер домена обращается к PDCE напрямую, используя протокол DRSUAPI RPC, чтобы создать объекты-компьютеры для клонированного контроллера домена.  
  
    > [!NOTE]  
    > Windows Server 2012 расширяет возможности имеющегося удаленного протокола службы репликации каталогов (DRS) (UUID **E3514235-4B06-11D1-AB04-00C04FC2DCD2**) для него новый метод RPC **IDL_DRSAddCloneDC** (Opnum **28**). **IDL_DRSAddCloneDC** метод создает новый объект контроллера домена, копируя атрибуты из имеющегося объекта контролера домена.  
    >   
    > Состояния контроллера домена включают объекты компьютера, сервера, Параметры NTDS, FRS, DFSR и подключение, сохраняемые для каждого контроллера домена. При дублировании объекта этот метод RPC заменяет все ссылки на исходный контроллер домена соответствующими объектами нового контроллера домена. Вызывающий объект должен иметь управления доступом правой доменных служб Active Directory-Clone-Domain-Controller в контексте именования домена.  
    >   
    > Этот новый метод всегда должен иметь прямой доступ к эмулятору PDC контроллера домена вызывающей стороны.  
    >   
    > Поскольку этот метод RPC является новым, программное обеспечение анализа сети требуются обновленные средства синтаксического анализа, чтобы включить поля для нового Opnum 28 в существующий UUID E3514235-4B06 - 11D 1-AB04-00C04FC2DCD2. В противном случае вы не сможете анализировать данный трафик.  
    >   
    > Дополнительные сведения см. в разделе [4.1.29 IDL_DRSAddCloneDC (Opnum 28)](https://msdn.microsoft.com/en-us/library/hh554213(v=prot.13).aspx).  
  
***Это также означает при использовании неполностью маршрутизируемых сетей клонирования виртуализированного контроллера домена требуются сегменты сети с доступом к PDCE***. Это можно переместить клонированный контроллер домена в другую сеть после клонирования — как физический контроллер домена — при условии, что вы тщательно Обновите информацию логического сайта Доменных.  
  
> [!IMPORTANT]  
> При клонировании домена, который содержит только один контроллер домена, необходимо убедиться, что исходный контроллер домена вернется в оперативный режим перед началом копирования. Домен в рабочей среде всегда должен содержать не менее двух контроллеров домена.  
  
#### <a name="active-directory-users-and-computers-method"></a>Active Directory-пользователи и компьютеры метод  
  
1.  Используя оснастку Dsa.msc, щелкните правой кнопкой мыши домен и выберите **Хозяева операций**. Запомните контроллер домена, указанный на вкладке PDC и закройте диалоговое окно.  
  
2.  Щелкните правой кнопкой мыши объект-компьютер этого контроллера домена и нажмите кнопку **свойства**, а затем проверьте информацию об операционной системе.  
  
#### <a name="windows-powershell-method"></a>Метод с Windows PowerShell  
Вы можете совместить следующие командлеты модуля Windows PowerShell Active Directory, чтобы возвратить версию эмулятора PDC:  
  
```  
Get-adddomaincontroller  
Get-adcomputer  
```  
  
Если домен не указан, эти командлеты используют домен того компьютера, где запущена.  
  
Следующая команда возвращает сведения о PDCE и операционной системы:  
  
```  
get-adcomputer(Get-ADDomainController -Discover -Service "PrimaryDC").name -property * | format-list dnshostname,operatingsystem,operatingsystemversion  
```  
  
Приведенный ниже пример показывает задание имени домена и фильтрацию возвращенных свойств перед конвейером Windows PowerShell:  
  
![Развертывание виртуализированного контроллера домена](media/Virtualized-Domain-Controller-Deployment-and-Configuration/ADDS_VDC_PDCOSInfo.png)  
  
### <a name="step-3---authorize-a-source-dc"></a>Шаг 3 - авторизация исходного контроллера домена  
Исходный контроллер домена должен иметь право управления доступом (автомобиль) **разрешить контроллеру домена клонировать себя** в именования домена. По умолчанию известная группа **клонируемые контроллеры домена** имеет такое разрешение и не содержит членов. PDCE создает эту группу, когда роль переносится FSMO на контроллер домена Windows Server 2012.  
  
#### <a name="active-directory-administrative-center-method"></a>Метод для центра администрирования Active Directory  
  
1.  Запустите Dsac.exe и перейдите к исходному контроллеру домена, а затем откройте страницу сведений.  
  
2.  В **входит в состав** добавьте **клонируемые контроллеры домена** для этого домена.  
  
#### <a name="windows-powershell-method"></a>Метод с Windows PowerShell  
Можете совместить следующие командлеты модуля Windows PowerShell Active Directory **get-adcomputer** и **-adgroupmember** добавить контроллер домена в **клонируемые контроллеры домена** группы:  
  
```  
Get-adcomputer <dc name> | %{add-adgroupmember "cloneable domain controllers" $_.samaccountname}  
```  
  
Для экземпляра эта команда добавляет DC1 сервера в группу, не требуя указывать различающееся имя члена группы:  
  
![Развертывание виртуализированного контроллера домена](media/Virtualized-Domain-Controller-Deployment-and-Configuration/ADDS_VDC_AddDcToGroup.png)  
  
#### <a name="rebuilding-default-permissions"></a>Повторное создание разрешений по умолчанию  
Если удалить разрешение из заголовка домена, клонирование завершается со сбоем. Вы можете воссоздать разрешение с помощью центра администрирования Active Directory или Windows PowerShell.  
  
##### <a name="active-directory-administrative-center-method"></a>Метод для центра администрирования Active Directory  
  
1.  Откройте **Центр администрирования Active Directory**, щелкните заголовок домена правой кнопкой мыши, выберите команду **свойства**, нажмите кнопку **расширения** щелкните **безопасности**и нажмите кнопку **Дополнительно**. Нажмите кнопку **только этот объект**.  
  
2.  Нажмите кнопку **добавить**в разделе **введите имена выбираемых объектов**, введите имя группы **клонируемые контроллеры домена.**  
  
3.  В списке разрешения, нажмите кнопку **разрешить контроллеру домена клонировать себя**, а затем нажмите кнопку **ОК**.  
  
> [!NOTE]  
> Можно также удалить разрешение по умолчанию и добавить отдельные контроллеры домена. Это, скорее всего, к проблемам с текущим обслуживанием, если новые администраторы не уведомлены о такой настройке. Изменение параметров по умолчанию не повышает уровень безопасности и не рекомендуется.  
  
##### <a name="windows-powershell-method"></a>Метод с Windows PowerShell  
Используйте следующие команды в командной строке консоли Windows PowerShell администратора с повышенными правами. Эти команды определяют имя домена и добавляют разрешения по умолчанию по:  
  
```  
import-module activedirectory  
cd ad:  
$domainNC = get-addomain  
$dcgroup = get-adgroup "Cloneable Domain Controllers"  
$sid1 = (get-adgroup $dcgroup).sid  
$acl = get-acl $domainNC  
$objectguid = new-object Guid 3e0f7e18-2c7a-4c10-ba82-4d926db99a3e  
$ace1 = new-object System.DirectoryServices.ActiveDirectoryAccessRule $sid1,"ExtendedRight","Allow",$objectguid  
$acl.AddAccessRule($ace1)  
set-acl -aclobject $acl $domainNC  
cd c:  
```  
  
Кроме того, запустите образец [FixVDCPermissions.ps1](../../../ad-ds/reference/virtual-dc/Virtualized-Domain-Controller-Technical-Reference-Appendix.md#BKMK_FixPDCPerms) в консоли Windows PowerShell, где запускается консоль администратора с повышенными правами на контроллере домена в требуемом домене. Он устанавливает разрешения автоматически. Этот пример находится в приложении данного модуля.  
  
### <a name="step-4---remove-incompatible-applications-or-services-if-not-using-customdccloneallowlistxml"></a>Шаг 4. Удаление несовместимых приложений или служб (если не используется CustomDCCloneAllowList.xml)  
Любые программы или службы, которые были возвращены Get-ADDCCloningExcludedApplicationList - *и не добавлены в CustomDCCloneAllowList.xml* -перед копированием необходимо удалить. Удаление приложения или службы — это рекомендуемый метод.  
  
> [!WARNING]  
> Любые несовместимые программы или службы, которые не были удалены или добавлены в customdccloneallowlist.XML, препятствуют выполнению клонирования.  
  
Используйте командлет Get-AdComputerServiceAccount, чтобы найти в домене автономные управляемые учетные записи служб (MSAs) и если данный компьютер использует какие-либо из них. Если установлен любой учетной записи Майкрософт, используйте командлет Uninstall-ADServiceAccount для удаления локально установленной учетной записи службы. После перевода исходного контроллера домена автономно в шаге 6, вы можете повторно добавить учетную запись Майкрософт, с помощью Install-ADServiceAccount, если сервер не вернется в оперативный режим. Дополнительные сведения см. в разделе [Uninstall-ADServiceAccount](https://technet.microsoft.com/en-us/library/hh852310).  
  
> [!IMPORTANT]  
> В Windows Server 2012 групповые управляемые учетные автономные управляемые учетные записи служб, - впервые появились в Windows Server 2008 R2 - были заменены. Группа управляемые учетные записи службы поддерживают клонирование.  
  
### <a name="step-5---create-dccloneconfigxml"></a>Шаг 5 — Создание DCCloneConfig.xml  
Файл DcCloneConfig.xml требуется для клонирования контроллеров домена. Его содержимое позволяет указать уникальные сведения, такие как новое имя компьютера и IP-адрес.  
  
Файл CustomDCCloneAllowList.xml необязателен, если только вы не устанавливаете приложения и потенциально несовместимые службы Windows на исходном контроллере домена. Этих файлов требуется точное именования, форматирования и размещения; в противном случае клонирование завершается сбоем.  
  
По этой причине следует всегда использовать командлеты Windows PowerShell для создания XML-файлы и поместить их в правильное расположение.  
  
#### <a name="generating-with-new-addccloneconfigfile"></a>Создание с помощью New-ADDCCloneConfigFile  
Модуль Windows PowerShell для Active Directory содержит новый командлет в Windows Server 2012:  
  
```  
New-ADDCCloneConfigFile  
```  
  
Выполните командлет на исходном контроллере домена, который хотите клонировать. Командлет поддерживает несколько аргументов и при использовании всегда тестирует компьютер и среду, где она запущена, если не указан аргумент - offline.  
  
||||  
|-|-|-|  
|**ActiveDirectory**<br /><br />**Командлет**|**Аргументы**|**Объяснение**|  
|**New-ADDCCloneConfigFile**|*<no argument specified>*|Создает пустой файл DcCloneConfig.xml в рабочем каталоге DSA (по умолчанию: % systemroot%\ntds)|  
||-CloneComputerName|Указывает имя компьютера клонированного контроллера домена. Тип данных — строка.|  
||-Path|Указывает папку для создания DcCloneConfig.xml. Если не указан, выполняет запись в рабочий каталог DSA (по умолчанию: % systemroot%\ntds). Тип данных — строка.|  
||-SiteName|Указывает имя логического сайта AD для присоединения во время создания учетной записи клонированного компьютера. Тип данных — строка.|  
||-IPv4-адрес|Указывает статический IPv4-адрес клонированного компьютера. Тип данных — строка.|  
||-IPv4SubnetMask|Указывает маску подсети для статического IPv4 клонированного компьютера. Тип данных — строка.|  
||-IPv4DefaultGateway|Указывает статический адрес шлюза по умолчанию IPv4 клонированного компьютера. Тип данных — строка.|  
||-IPv4DNSResolver|Указывает статический IPv4 DNS-записи клонированного компьютера в список с разделителями запятыми. Тип данных — массив. Можно задать до четырех записей.|  
||-PreferredWINSServer|Указывает статический IPv4-адрес основного WINS-сервера. Тип данных — строка.|  
||-AlternateWINSServer|Указывает статический IPv4-адрес дополнительного WINS-сервера. Тип данных — строка.|  
||-IPv6DNSResolver|Указывает статический IPv6 DNS-записи клонированного компьютера в список с разделителями запятыми. Существует способа указать статическую информацию Ipv6 при клонировании виртуализированного контроллера домена. Тип данных — массив.|  
||-Автономный режим|Не выполняет проверочные тесты и перезаписывает любой имеющийся файл dccloneconfig.xml. Не имеет параметров. Дополнительные сведения см. в разделе [выполнение New-ADDCCloneConfigFile в автономном режиме](../../../ad-ds/Introduction-to-Active-Directory-Domain-Services-AD-DS-Virtualization-Level-100.md#BKMK_OfflineMode).|  
||*— Статические*|Требуется при указании аргументов статического IP IPv4SubnetMask, IPv4SubnetMask или IPv4DefaultGateway. Не имеет параметров.|  
  
Тесты, выполняемые при работе в:  
  
-   Эмулятор PDC работает в Windows Server 2012 или более поздней версии  
  
-   Исходный контроллер домена является членом группы клонируемые контроллеры домена  
  
-   Исходный контроллер домена не содержит никаких исключенных приложений или служб  
  
-   Исходный контроллер домена уже не содержит файл DcCloneConfig.xml по указанному пути  
  
![Развертывание виртуализированного контроллера домена](media/Virtualized-Domain-Controller-Deployment-and-Configuration/ADDS_VDC_PSNewDCCloneConfig.png)  
  
### <a name="step-6---take-the-source-domain-controller-offline"></a>Шаг 6 - перевод исходного контроллера домена в автономный режим  
Вы не можете скопировать выполняющийся исходный контроллер домена; он должен быть корректного завершения работы. Не клонируйте контроллер домена, отключившегося при сбое питания.  
  
#### <a name="graphical-method"></a>Графический интерфейс  
Используйте кнопку завершения работы в выполняемом контроллере домена или кнопку завершения работы в диспетчере Hyper-V.  
  
![Развертывание виртуализированного контроллера домена](media/Virtualized-Domain-Controller-Deployment-and-Configuration/ADDS_VDC_Shutdown.png)  
  
![Развертывание виртуализированного контроллера домена](media/Virtualized-Domain-Controller-Deployment-and-Configuration/ADDS_VDC_HyperVShutdown.png)  
  
#### <a name="windows-powershell-method"></a>Метод с Windows PowerShell  
Вы можете завершить работу виртуальной машины, с помощью одного из следующих командлетов:  
  
```  
Stop-computer  
Stop-vm  
```  
  
STOP-computer — это командлет, поддерживающий завершение работы компьютеров без учета виртуализации он аналогичен устаревшей служебной Shutdown.exe. STOP-vm — это новый командлет в модуле Windows PowerShell Windows Server 2012 Hyper-V и она эквивалентна Электропитание в диспетчере Hyper-V. Второй командлет удобно использовать в лабораторных средах, где контроллер домена часто работает в частной виртуализированной сети.  
  
![Развертывание виртуализированного контроллера домена](media/Virtualized-Domain-Controller-Deployment-and-Configuration/ADDS_VDC_StopComputer2.png)  
  
![Развертывание виртуализированного контроллера домена](media/Virtualized-Domain-Controller-Deployment-and-Configuration/ADDS_VDC_StopVM.png)  
  
### <a name="step-7---copy-disks"></a>Шаг 7. копирование дисков  
На этапе копирование необходимо принять решение административного характера:  
  
-   Копирование дисков вручную без использования Hyper-V  
  
-   Экспорт виртуальной Машины с помощью Hyper-V  
  
-   Экспорт объединенных дисков с помощью Hyper-V  
  
Необходимо скопировать все диски виртуальной машины, не только системный диск. Если исходный контроллер домена использует разностные диски и вы планируете переместить клонированный контроллер домена на другой узел Hyper-V, необходимо экспортировать.  
  
Рекомендуется копировать диски вручную, если исходный контроллер домена имеет только *один* диска. Экспорт/Импорт рекомендуется для виртуальных машин с *несколько* дисками или другими сложными настройками виртуализированного оборудования, например несколько сетевых адаптеров.  
  
Если ручного копирования файлов удалите все моментальные снимки до копирования. При экспорте виртуальной Машины, удалите моментальные снимки перед экспортом или удалить их из новой виртуальной Машины после импорта.  
  
> [!WARNING]  
> Снимки представляют собой разностные диски, которые могут возвращать контроллер домена в предыдущее состояние. Если клонировать контроллер домена и затем восстановить его снимок до клонирования, вы появятся дублирующиеся контроллеры домена в лесу. Не имеет смысла хранение полученных ранее снимков на только что клонированном контроллере домена.  
  
#### <a name="manually-copying-disks"></a>Копирование дисков вручную  
  
##### <a name="hyper-v-manager-method"></a>Метод для диспетчера Hyper-V  
Чтобы определить, какие диски сопоставлены с исходным контроллером домена, используйте оснастку диспетчера Hyper-V. Используйте параметр "Проверить", чтобы проверить ли контроллер домена использует разностные диски (что требует копирования родительского диска также).  
  
![Развертывание виртуализированного контроллера домена](media/Virtualized-Domain-Controller-Deployment-and-Configuration/ADDS_VDC_HyperVInspect.png)  
  
Чтобы удалить моментальные снимки, выберите виртуальную Машину и удалите поддерево снимков.  
  
![Развертывание виртуализированного контроллера домена](media/Virtualized-Domain-Controller-Deployment-and-Configuration/ADDS_VDC_HyperVDeleteSnapshot.gif)  
  
Затем можно вручную скопировать файлы VHD или VHDX с помощью проводника, Xcopy.exe или Robocopy.exe. Специальные действия, не требуются. Рекомендуется изменять имена файлов даже при перемещении в другую папку.  
  
> [!NOTE]  
> Если копирование осуществляется между главными компьютерами по локальной сети (1 ГБ или более поздней версии), **Xcopy.exe /J** позволяет копировать файлы VHD/VHDX значительно быстрее, чем в любом другом средстве, за счет существенно более интенсивного использования пропускной способности.  
  
##### <a name="windows-powershell-method"></a>Метод с Windows PowerShell  
Чтобы определить диски с помощью Windows PowerShell, используйте модули Hyper-V  
  
```  
Get-vmidecontroller  
Get-vmscsicontroller  
Get-vmfibrechannelhba  
Get-vmharddiskdrive  
```  
  
Например, можно возвратить все жесткие диски IDE из виртуальной Машины с именем **DC2** с помощью следующего примера:  
  
![Развертывание виртуализированного контроллера домена](media/Virtualized-Domain-Controller-Deployment-and-Configuration/ADDS_VDC_ReturnIDE.png)  
  
Если путь к диску указывает на файл AVHD или AVHDX, это моментальный снимок. Чтобы удалить моментальные снимки, связанные с диска и объединить все в реальный файл VHD или VHDX, используйте командлеты:  
  
```  
Get-VMSnapshot  
Remove-VMSnapshot  
```  
  
Например чтобы удалить все снимки из виртуальной Машины с именем DC2-SOURCECLONE:  
  
![Развертывание виртуализированного контроллера домена](media/Virtualized-Domain-Controller-Deployment-and-Configuration/ADDS_VDC_DelSnapshots.png)  
  
Чтобы скопировать файлы с помощью Windows PowerShell, используйте следующий командлет:  
  
```  
Copy-Item  
```  
  
Совместите с командлетами виртуальной Машины в конвейерах, чтобы упростить автоматизацию. Конвейер — это канал между несколькими командлетами для обмена данными. Например чтобы скопировать диск автономного исходного контроллера домена с именем DC2-SOURCECLONE на новый диск c:\temp\copy.vhd без необходимости зная точный путь к системному диску под названием:  
  
```  
Get-VMIdeController dc2-sourceclone | Get-VMHardDiskDrive | select-Object {copy-item -path $_.path -destination c:\temp\copy.vhd}  
```  
  
![Развертывание виртуализированного контроллера домена](media/Virtualized-Domain-Controller-Deployment-and-Configuration/ADDS_VDC_PSCopyDrive.png)  
  
> [!IMPORTANT]  
> Вам не удается использовать транзитные диски в клонирования, как они не используют не файл виртуального диска вместо фактического жесткого диска.  
  
> [!NOTE]  
> Дополнительные сведения о других операциях Windows PowerShell с конвейерами см. в разделе [конвейерная передача и конвейер в Windows PowerShell](https://technet.microsoft.com/en-us/library/ee176927.aspx).  
  
#### <a name="exporting-the-vm"></a>Экспорт виртуальной Машины  
В качестве альтернативы копированию дисков вы можете экспортировать всю виртуальную Машину Hyper-V как копия. При экспорте автоматически создается папка с именем для этой виртуальной Машины, содержащая все диски и сведения о конфигурации.  
  
![Развертывание виртуализированного контроллера домена](media/Virtualized-Domain-Controller-Deployment-and-Configuration/ADDS_VDC_HyperVExport.png)  
  
##### <a name="hyper-v-manager-method"></a>Метод для диспетчера Hyper-V  
Для экспорта виртуальной Машины с помощью диспетчера Hyper-V.  
  
1.  Щелкните правой кнопкой мыши исходный контроллер домена и нажмите кнопку **Экспорт**.  
  
2.  Выберите существующую папку в качестве контейнера экспорта.  
  
3.  Дождитесь столбец состояния остановить показ **Экспорт**.  
  
##### <a name="windows-powershell-method"></a>Метод с Windows PowerShell  
Чтобы экспортировать виртуальную Машину с помощью модуля Windows PowerShell Hyper-V, используйте командлет:  
  
```  
Export-vm  
```  
  
Например для экспорта виртуальной Машины с именем DC2-SOURCECLONE в папку C:\VM:  
  
![Развертывание виртуализированного контроллера домена](media/Virtualized-Domain-Controller-Deployment-and-Configuration/ADDS_VDC_PSExport.png)  
  
> [!NOTE]  
> Windows Server 2012 Hyper-V поддерживает новые экспорта и импорта возможности, выходящие за рамки данного материала. Дополнительные сведения в разделе TechNet.  
  
#### <a name="exporting-merged-disks-using-hyper-v"></a>Экспорт объединенных дисков с помощью Hyper-V  
Последний вариант — использовать параметры слияния и преобразования дисков в Hyper-V. Они позволяют создать копию имеющейся структуры диска — даже при включении в нее файлов снимков AVHD/AVHDX — в виде одного нового диска. Как и сценарий ручного копирования дисков этот способ предназначен в основном для простых виртуальных машин, использующих только на одном диске, например C:\\. Единственное его преимущество является то, что, в отличие от копирования вручную, вам не нужно предварительно удалять моментальные снимки. Данная операция неизбежно будет выполняться дольше простого удаления снимков и копирования дисков.  
  
##### <a name="hyper-v-manager-method"></a>Метод для диспетчера Hyper-V  
Чтобы создать объединенный диск с помощью диспетчера Hyper-V:  
  
1.  Нажмите кнопку **изменить диск**.  
  
2.  Найдите дочерний диск нижнего уровня. Например если вы используете разностный диск, дочерним диском является наименьшее дочерних. Если виртуальная машина содержит моментальный снимок (или несколько из них), выбранные в настоящий момент моментальный снимок является дочерним диском нижнего уровня.  
  
3.  Выберите **слияния** параметр, чтобы создать отдельный диск из структуры всего родительских и дочерних элементов.  
  
4.  Выберите новый виртуальный жесткий диск и укажите путь. При этом имеющиеся существующие VHD-или VHDX-файлы в новый отдельный портативный блок, не подвержен риску восстановления предыдущих снимков.  
  
##### <a name="windows-powershell-method"></a>Метод с Windows PowerShell  
Чтобы создать объединенный диск из комплексного набора родительских элементов с помощью модуля Hyper-V Windows PowerShell, используйте командлет:  
  
```  
Convert-vm  
```  
  
Например для экспорта всей цепочки снимков дисков виртуальной Машины (на этот раз без разностных дисков) и родительского диска в новый отдельный диск с именем DC4-CLONED.VHDX. VHDX:  
  
![Развертывание виртуализированного контроллера домена](media/Virtualized-Domain-Controller-Deployment-and-Configuration/ADDS_VDC_PSConvertVhd.png)  
  
#### <a name="BKMK_Offline"></a>Добавление XML в автономный системный диск  
Если вы скопировали Dccloneconfig.xml на работающий исходный контроллер домена, теперь необходимо скопировать обновленный файл dccloneconfig.xml на автономный скопированный/экспортированный системный диск. В зависимости от приложения ранее обнаружил Get-addccloningexcludedapplicationlist может потребоваться скопировать файл CustomDCCloneAllowList.xml на диск.  
  
Файл DcCloneConfig.xml может находиться в следующих расположениях:  
  
1.  Рабочая папка DSA  
  
2.  %windir%\NTDS  
  
3.  Носитель съемных чтения и записи, в порядке букв диска  
  
Эти пути не настраиваются. После начала клонирования проверяет эти расположения в указанном порядке и использует первый DcCloneConfig.xml найденный файл независимо от содержимого других папок.  
  
Файл CustomDCCloneAllowList.xml может находиться в следующих расположениях:  
  
1.  HKey_Local_Machine\System\CurrentControlSet\Services\NTDS\Parameters  
  
    AllowListFolder (*REG_SZ*)  
  
2.  Рабочая папка DSA  
  
3.  %windir%\NTDS  
  
4.  Носитель съемных чтения и записи, в порядке букв диска  
  
Можно запустить New-ADDCCloneConfigFile с **-автономного** аргумент (также называется автономным режимом), чтобы создать файл DcCloneConfig.xml и поместить его в подходящее расположение. В следующих примерах запустить New-ADDCCloneConfigFile в автономном режиме.  
  
Чтобы создать клонированный контроллер домена с именем CloneDC1 в автономном режиме на сайте «REDMOND» со статическим адресом IPv4, введите:  
  
```  
New-ADDCCloneConfigFile -Offline -CloneComputerName CloneDC1 -SiteName REDMOND -IPv4Address "10.0.0.2" -IPv4DNSResolver "10.0.0.1" -IPv4SubnetMask "255.255.0.0" -IPv4DefaultGateway "10.0.0.1" -Static -Path F:\Windows\NTDS  
```  
  
Чтобы создать клонированный контроллер домена с именем Clone2 в автономном режиме со статическим адресом IPv4 и статическими параметрами IPv6, введите:  
  
```  
New-ADDCCloneConfigFile -Offline -IPv4Address "10.0.0.2" -IPv4DNSResolver "10.0.0.1" -IPv4SubnetMask "255.255.0.0" -Static -IPv6DNSResolver "2002:4898:e0:31fc:d61:2b0a:c9c9:2ccc" -CloneComputerName "Clone2" -PreferredWINSServer "10.0.0.1" -AlternateWINSServer "10.0.0.3" -Path F:\Windows\NTDS  
```  
  
Чтобы создать клонированный контроллер домена в автономном режиме со статическим адресом IPv4 и динамическими параметрами IPv6, а также указать несколько DNS-серверов для параметров распознавателя DNS, введите:  
  
```  
New-ADDCCloneConfigFile -Offline -IPv4Address "10.0.0.10" -IPv4SubnetMask "255.255.0.0" -IPv4DefaultGateway "10.0.0.1" -IPv4DNSResolver @( "10.0.0.1","10.0.0.2" ) -Static -IPv6DNSResolver "2002:4898:e0:31fc:d61:2b0a:c9c9:2ccc" -Path F:\Windows\NTDS   
```  
  
Чтобы создать клонированный контроллер домена с именем Clone1 в автономном режиме с динамическим адресом IPv4 и статическими параметрами IPv6, введите:  
  
```  
New-ADDCCloneConfigFile -Offline -Static -IPv6DNSResolver "2002:4898:e0:31fc:d61:2b0a:c9c9:2ccc" -CloneComputerName "Clone1" -PreferredWINSServer "10.0.0.1" -AlternateWINSServer "10.0.0.3" -SiteName "REDMOND" -Path F:\Windows\NTDS  
```  
  
Чтобы создать клонированный контроллер домена в автономном режиме с динамическим адресом IPv4 и динамическими параметрами IPv6, введите следующую команду:  
  
```  
New-ADDCCloneConfigFile -Offline -IPv4DNSResolver "10.0.0.1" -IPv6DNSResolver "2002:4898:e0:31fc:d61:2b0a:c9c9:2ccc" -Path F:\Windows\NTDS  
  
```  
  
##### <a name="windows-explorer-method"></a>Метод для проводника Windows  
Windows Server 2012 теперь предоставляет графические средства для подключения файлов VHD и VHDX. Это необходимо установить возможности рабочего стола в Windows Server 2012.  
  
1.  Щелкните только что скопированный файл VHD или VHDX, содержащий системный диск исходного контроллера домена или папку рабочего каталога DSA, а затем нажмите кнопку **подключить** из **средства работы с образами дисков** меню.  
  
2.  На подключенном диске скопируйте файлы XML в подходящее расположение. Может быть выдано разрешений для папки.  
  
3.  Щелкните подключенный диск и нажмите кнопку **извлечь** из **средств диска** меню.  
  
![Развертывание виртуализированного контроллера домена](media/Virtualized-Domain-Controller-Deployment-and-Configuration/ADDS_VDC_HyperVClickMountedDrive.png)  
  
![Развертывание виртуализированного контроллера домена](media/Virtualized-Domain-Controller-Deployment-and-Configuration/ADDS_VDC_HyperVDetailsMountedDrive.gif)  
  
![Развертывание виртуализированного контроллера домена](media/Virtualized-Domain-Controller-Deployment-and-Configuration/ADDS_VDC_HyperVEjectMountedDrive.gif)  
  
##### <a name="windows-powershell-method"></a>Метод с Windows PowerShell  
Кроме того вы можете подключить автономный диск и скопировать файл XML с помощью командлетов Windows PowerShell:  
  
```  
mount-vhd  
get-disk  
get-partition  
get-volume  
Add-PartitionAccessPath  
Copy-Item  
```  
  
Это позволяет полный контроль над этим процессом. Например, диск может быть подключен с определенной буквой диска, скопировать файл и отключить диск.  
  
```  
mount-vhd <disk path> -passthru -nodriveletter | get-disk | get -partition | get-volume | get-partition | where {$_.partition number -eq 2} | Add-PartitionAccessPath -accesspath <drive letter>  
  
copy-item <xml file path><destination path>\dccloneconfig.xml  
  
dismount-vhd <disk path>  
```  
  
Например:  
  
![Развертывание виртуализированного контроллера домена](media/Virtualized-Domain-Controller-Deployment-and-Configuration/ADDS_VDC_PSMountVHD.png)  
  
Кроме того, можно использовать новый **Mount-DiskImage** командлет для подключения файла VHD (или ISO).  
  
### <a name="step-8---create-the-new-virtual-machine"></a>Шаг 8 — Создание новой виртуальной машины  
Последний этап конфигурации перед началом процесса клонирования является создание новой виртуальной Машины, использующей диски из скопированного исходного контроллера домена. В зависимости от решений, принятых при выполнении этапов копирования дисков у вас есть два варианта:  
  
1.  Сопоставление новой виртуальной Машины с копированным диском  
  
2.  Импорт экспортированной виртуальной Машины  
  
#### <a name="associating-a-new-vm-with-copied-disks"></a>Сопоставление новой виртуальной Машины с Копированными дисками  
Если вы скопировали системный диск вручную, необходимо создать новую виртуальную машину, использующую скопированный диск. Низкоуровневая оболочка автоматически задает ИД создания Виртуальной машины при создании новой виртуальной Машины; вносить изменения конфигурации не требуется на узле виртуальных Машин или Hyper-V.  
  
![Развертывание виртуализированного контроллера домена](media/Virtualized-Domain-Controller-Deployment-and-Configuration/ADDS_VDC_HyperVConnectVHD.gif)  
  
##### <a name="hyper-v-manager-method"></a>Метод для диспетчера Hyper-V  
  
1.  Создание новой виртуальной машины.  
  
2.  Укажите имя виртуальной Машины, память и сети.  
  
3.  На странице подключить виртуальный жесткий диск укажите скопированный системный диск.  
  
4.  Следуйте указаниям мастера для создания виртуальной Машины.  
  
При наличии нескольких дисков, сетевых адаптеров или других настраиваемых компонентов настройте их перед запуском контроллера домена. Метод копирования дисков «Экспорт-Импорт» рекомендуется для сложных виртуальных машин.  
  
##### <a name="windows-powershell-method"></a>Метод с Windows PowerShell  
Можно использовать модуль Windows PowerShell Hyper-V для автоматизации процесса создания виртуальной Машины Windows Server 2012 с помощью следующего командлета:  
  
```  
New-VM  
```  
  
Например, здесь виртуальная машина DC4-CLONEDFROMDC2 создается, с помощью 1 ГБ ОЗУ, загружается из файла c:\vm\dc4-systemdrive-clonedfromdc2.vhd и использует виртуальную сеть 10.0:  
  
![Развертывание виртуализированного контроллера домена](media/Virtualized-Domain-Controller-Deployment-and-Configuration/ADDS_VDC_PSNewVM.png)  
  
#### <a name="import-vm"></a>Импорт виртуальной Машины  
Если ранее вы экспортировали виртуальную Машину, теперь нужно импортировать ее обратно в качестве копии. Экспортированный файл XML используется для воссоздания компьютера с помощью все предыдущие параметры, диски, сетей и параметры памяти.  
  
Если вы планируете создать несколько копий из одной экспортированной виртуальной Машины, сделайте нужное число копий экспортированной виртуальной Машины. Затем используйте функцию импорта для каждой из копий.  
  
> [!IMPORTANT]  
> Очень важно использовать **копирования** вариант, при экспорте сохраняются все сведения из источника; Импорт сервера с **переместить** или **на месте** при выполнении на сервере узла Hyper-V приведет к информационному конфликту.  
  
##### <a name="hyper-v-manager-method"></a>Метод для диспетчера Hyper-V  
Чтобы импортировать с помощью оснастки диспетчера Hyper-V:  
  
1.  Нажмите кнопку **Импорт виртуальной машины**  
  
2.  На **найдите папку** выберите файл определения экспортированной виртуальной Машины, используя кнопку "Обзор"  
  
3.  На **выбора виртуальной машины** щелкните исходный компьютер.  
  
4.  На **Выбор типа импорта** щелкните **копировать виртуальную машину (создать новый уникальный идентификатор)**, нажмите кнопку **Готово**.  
  
5.  Переименуйте импортированную виртуальную Машину, если импорт выполняется на одном узле Hyper-V; он будет иметь имя, совпадающее с именем экспортированный исходный контроллер домена.  
  
![Развертывание виртуализированного контроллера домена](media/Virtualized-Domain-Controller-Deployment-and-Configuration/ADDS_VDC_HyperVImportLocateFolder.png)  
  
![Развертывание виртуализированного контроллера домена](media/Virtualized-Domain-Controller-Deployment-and-Configuration/ADDS_VDC_HyperVImportSelectVM.png)  
  
![Развертывание виртуализированного контроллера домена](media/Virtualized-Domain-Controller-Deployment-and-Configuration/ADDS_VDC_HyperVImportChooseType.gif)  
  
Не забудьте удалить все импортированные снимки с помощью оснастки управления Hyper-V:  
  
![Развертывание виртуализированного контроллера домена](media/Virtualized-Domain-Controller-Deployment-and-Configuration/ADDS_VDC_HyperVImportDelSnap.gif)  
  
> [!WARNING]  
> Удаление импортированных снимков имеет большое значение; Если применено, они принесут клонированного контроллера домена в состояние предыдущего — и, возможно, активного — контроллера домена, что приводит к сбою репликации, дублированию информации об IP и другим неполадкам.  
  
##### <a name="windows-powershell-method"></a>Метод с Windows PowerShell  
Можно использовать модуль Windows PowerShell Hyper-V для автоматизации процесса импорта виртуальной Машины Windows Server 2012 с помощью следующих командлетов:  
  
```  
Import-VM  
Rename-VM  
```  
  
Например, здесь экспортированная виртуальная машина DC2-CLONED импортируется с помощью автоматически определенного файла XML, а затем ей сразу же назначается новое имя DC5-CLONEDFROMDC2:  
  
![Развертывание виртуализированного контроллера домена](media/Virtualized-Domain-Controller-Deployment-and-Configuration/ADDS_VDC_PSImportVM.png)  
  
Не забудьте удалить все импортированные снимки с помощью следующих командлетов:  
  
```  
Get-VMSnapshot  
Remove-VMSnapshot  
```  
  
Например:  
  
![Развертывание виртуализированного контроллера домена](media/Virtualized-Domain-Controller-Deployment-and-Configuration/ADDS_VDC_PSGetVMSnap.png)  
  
> [!WARNING]  
> Убедитесь, что при импорте компьютера статические MAC-адреса были не назначены исходного контроллера домена. Если клонируется исходный компьютер со статическим MAC, скопированные компьютеры не правильно отправить или принимать сетевой трафик. Если это так, задайте новый уникальный статический или динамический MAC-адрес. Можно определить, использует ли виртуальная машина статический MAC-адрес с помощью команды:  
>   
> **Get-VM - VMName**   
>  ***тест vm* | Get-VMNetworkAdapter | fl \ ***  
  
### <a name="step-9---clone-the-new-virtual-machine"></a>Шаг 9 - клонирование новой виртуальной машины  
При необходимости перед началом клонирования перезапустите автономный клонированный исходный контроллер домена. Убедитесь, что эмулятор основного контроллера домена находится в сети, в любом случае.  
  
Для начала клонирования просто запустите новую виртуальную машину. Процесс инициализируется автоматически, и контроллер домена автоматически перезапускается после завершения клонирования.  
  
> [!IMPORTANT]  
> Не рекомендуется отключать контроллеры домена, отключен в течение продолжительного периода времени, а если клон присоединяет на одном узле его исходный контроллер домена, начальной внутрисайтовой и топологии межсайтовой репликации может занять больше времени для сборки, если исходный контроллер домена находится в автономном режиме.  
  
При использовании Windows PowerShell для запуска виртуальной Машины Hyper-V модуле доступен новый командлет:  
  
```  
Start-VM  
```  
  
Например:  
  
![Развертывание виртуализированного контроллера домена](media/Virtualized-Domain-Controller-Deployment-and-Configuration/ADDS_VDC_PSStartVM.png)  
  
Когда компьютер перезагружается после завершения клонирования, он становится контроллером домена, и вы можете выполнить Обычный вход для проверки правильности работы. При наличии ошибок сервер настраивается на запуск в режиме восстановления служб каталогов для проведения проверки.  
  
## <a name="BKMK_VDCSafeRestore"></a>Меры безопасности виртуализации  
В отличие от клонирования виртуализированного контроллера домена, меры безопасности виртуализации Windows Server 2012 не требуют настройки. Они работают без постороннего вмешательства до тех пор, пока выполнить простые условия:  
  
-   Низкоуровневая оболочка поддерживает ИД создания Виртуальной машины  
  
-   Имеется допустимый партнерский контроллер домена, восстановленный контроллер домена может непринудительно реплицировать изменения.  
  
### <a name="validate-the-hypervisor"></a>Проверка низкоуровневой оболочки  
Убедитесь, что исходный контроллер домена выполняется в поддерживаемой низкоуровневой оболочке, изучите документацию поставщика. Виртуализированные контроллеры домена не привязаны к низкоуровневой оболочке и не требуют Hyper-V.  
  
См. в предыдущем [требования к платформе](../../../ad-ds/get-started/virtual-dc/../../../ad-ds/get-started/virtual-dc/../../../ad-ds/get-started/virtual-dc/../../../ad-ds/get-started/virtual-dc/Virtualized-Domain-Controller-Deployment-and-Configuration.md#BKMK_PlatformReqs) раздел об известной поддержке ИД создания Виртуальной машины.  
  
Если вы перемещаете виртуальные машины с исходной низкоуровневой оболочки в другую целевую низкоуровневую оболочку, меры безопасности виртуализации могут или не активироваться в зависимости от того, поддерживает ли низкоуровневая ИД создания Виртуальной машины, как описано в следующей таблице.  
  
|Исходная низкоуровневая оболочка|Целевая низкоуровневая оболочка|Результат|  
|---------------------|---------------------|----------|  
|Поддерживает ИД создания виртуальной Машины|Не поддерживает ИД создания Виртуальной машины|Меры безопасности не активируются (если имеется файл DCCloneConfigFile.xml, контроллер домена загружается в режиме восстановления служб Каталогов)|  
|Не поддерживает ИД создания Виртуальной машины|Поддерживает ИД создания виртуальной Машины|Меры безопасности активируются|  
|Поддерживает ИД создания виртуальной Машины|Поддерживает ИД создания виртуальной Машины|Меры безопасности не активируются, так как определение виртуальной Машины не изменился, а значит ИД создания Виртуальной машины остался прежним|  
  
### <a name="validate-the-replication-topology"></a>Проверка топологии репликации  
Меры безопасности виртуализации инициируют непринудительное репликацию входящего трафика для разницы репликации Active Directory, а также непринудительную повторную синхронизацию всего содержимого SYSVOL. Это гарантирует, что контроллер домена возвращается из моментального снимка полнофункциональным и согласованным с остальной частью среды.  
  
Эта новая возможность имеет несколько требований и ограничений:  
  
-   Восстановленный контроллер домена должен быть возможность установить связь для записи контроллера домена  
  
-   Не следует одновременно восстанавливать все контроллеры домена в домене  
  
-   Любые изменения, имевшие место на восстановленном контроллере домена, еще не реплицированы исходящих с момента получения моментального снимка теряются навсегда.  
  
Хотя такие сценарии рассматриваются в разделе об устранении неполадок, ниже приведены сведения убедитесь, что вы не создаете топология, которая может вызвать проблемы.  
  
#### <a name="writable-domain-controller-availability"></a>Доступность контроллера домена с возможностью записи  
В случае восстановления контроллер домена должны иметь подключение к контроллеру домена с возможностью записи; контроллер домена только для чтения не может отправлять разницу по обновлениям. Топология скорее всего, это уже, как для записи контроллеру домена всегда требуется доступный для записи партнер. Если все контроллеры домена восстанавливаются одновременно, ни один из них можно найти подходящий источник. То же самое происходит, если контроллеры домена с возможностью отключены для проведения обслуживания или в противном случае недоступны по сети.  
  
#### <a name="simultaneous-restore"></a>Одновременное восстановление  
Не восстанавливайте одновременно все контроллеры домена в одном домене. В случае восстановления всех моментальных снимков, репликация Active Directory работает нормально, однако репликация SYSVOL прерывается. Архитектура восстановления для FRS и DFSR требует установки их экземпляра реплики в режиме непринудительную синхронизацию. Если все контроллеры домена восстанавливаются одновременно и каждый контроллер домена помечает себя в качестве заслуживающим доверия для SYSVOL, все они попытаются синхронизировать групповые политики и скрипты с партнера; в этот момент Однако все партнеры также будут не заслуживающий доверия.  
  
> [!IMPORTANT]  
> Если все контроллеры домена восстанавливаются одновременно, используйте следующие статьи, чтобы задать один контроллер домена — обычно это эмулятор PDC — как заслуживающую доверия, чтобы другие контроллеры домена могли вернуться к нормальной работе:  
>   
> [Использование раздела реестра BurFlags для повторной инициализации службы репликации файлов наборов реплик](https://support.microsoft.com/kb/290762)  
>   
> [Принудительное выполнения заслуживающей и не заслуживающей доверия синхронизации для SYSVOL, реплицированного DFSR (как «D4/D2» для FRS)](https://support.microsoft.com/kb/2218556)  
  
> [!WARNING]  
> Не запускайте все контроллеры домена в лесу или домене на одном узле низкоуровневой оболочки. Создает единую точку отказа, нарушающая работу Доменных службах Active Directory, Exchange, SQL и других операций корпоративного уровня при каждом переходе низкоуровневой оболочки в автономном режиме. Это ничем не отличается от использования одного контроллера домена для всего домена или леса. Несколько контроллеров домена на нескольких платформах помогают обеспечить избыточность и отказоустойчивость.  
  
#### <a name="post-snapshot-replication"></a>Репликация после получения моментального снимка  
Не восстанавливайте моментальные снимки, пока всех изменений локального характера, внесенных после создания моментального снимка были реплицированы исходящих подключений. Все изначальные изменения будут утеряны навсегда, если другие контроллеры домена была еще не получили их посредством репликации.  
  
Используйте Repadmin.exe, чтобы отобразить все нереплицированные исходящие изменения между контроллером домена и его партнерами:  
  
1.  Имена и идентификаторы GUID объекта DSA с для возврата партнеров контроллера домена:  
  
    ```  
    Repadmin.exe /showrepl <DC Name of the partner> /repsto  
    ```  
  
2.  Возврата ожидающей входящей репликации с партнерского контроллера домена к контроллеру домена, которые нужно восстановить:  
  
    ```  
    Repadmin.exe /showchanges < Name of partner DC><DSA Object GUID of the domain controller being restored><naming context to compare>  
    ```  
  
Кроме того, можно просто просмотреть число нереплицированных изменений:  
  
```  
Repadmin.exe /showchanges <Name of partner DC><DSA Object GUID of the domain controller being restored><naming context to compare> /statistics  
```  
  
Например (выходные данные изменены для облегчения восприятия, важные записи ***выделены курсивом***), здесь вы отображаете партнерства репликации контроллера домена dc4:  
  
```  
C:\>repadmin.exe /showrepl dc4.corp.contoso.com /repsto  
  
Default-First-Site-Name\DC4  
DSA Options: IS_GC  
Site Options: (none)  
DSA object GUID: 5d083398-4bd3-48a4-a80d-fb2ebafb984f  
DSA invocationID: 730fafec-b6d4-4911-88f2-5b64e48fc2f1  
  
==== OUTBOUND NEIGHBORS FOR CHANGE NOTIFICATIONS ============  
  
DC=corp,DC=contoso,DC=com  
    Default-First-Site-Name\DC3 via RPC  
        DSA object GUID: f62978a8-fcf7-40b5-ac00-40aa9c4f5ad3  
        Last attempt @ 2011-11-11 15:04:12 was successful.  
    Default-First-Site-Name\DC2 via RPC  
        DSA object GUID: 3019137e-d223-4b62-baaa-e241a0c46a11  
        Last attempt @ 2011-11-11 15:04:15 was successful.  
```  
  
Теперь вы знаете, что он осуществляет репликацию с DC2 и DC3. После этого вы отображаете список изменений, которые DC2 он по-прежнему не получил с DC4 и видите одну новую группу:  
  
```  
C:\>repadmin /showchanges dc2.corp.contoso.com 5d083398-4bd3-48a4-a80d-fb2ebafb984f dc=corp,dc=contoso,dc=com  
  
==== SOURCE DSA: (null) ====  
Objects returned: 1  
(0) add CN=newgroup4,CN=Users,DC=corp,DC=contoso,DC=com  
    1> parentGUID: 55fc995a-04f4-4774-b076-d6a48ac1af99  
    1> objectGUID: 96b848a2-df1d-433c-a645-956cfbf44086  
    2> objectClass: top; group  
    1> instanceType: 0x4 = ( WRITE )  
    1> whenCreated: 11/11/2011 3:03:57 PM Eastern Standard Time  
```  
  
Вы бы также проверили другого партнера, чтобы убедиться, что он еще не реплицирован.  
  
Кроме того, если вы объектов, которые не были реплицированы, и только волнуют, что все объекты были реплицированы, можно использовать **/statistics** параметр:  
  
```  
C:\>repadmin /showchanges dc2.corp.contoso.com 5d083398-4bd3-48a4-a80d-fb2ebafb984f dc=corp,dc=contoso,dc=com /statistics  
  
***********************************************  
********* Grand total *************************  
Packets:              1  
Objects:              1Object Additions:     1Object Modifications: 0Object Deletions:     0Object Moves:         0Attributes:           12Values:               13  
```  
  
> [!IMPORTANT]  
> Протестируйте всех доступных для записи партнеров, при наличии любых сбоев или невыполненной репликации. Поскольку по крайней мере для одного схождение выполнено, можно восстанавливать снимок, как транзитивная репликация в конечном счете согласовывает другие серверы.  
>   
> Обязательно запомните все ошибки репликации показанные с параметром/showchanges и не продолжайте работу до их исправления.  
  
### <a name="windows-powershell-snapshot-cmdlets"></a>Командлеты Windows PowerShell моментального снимка  
Следующие командлеты модуля Windows PowerShell Hyper-V предоставляют возможности моментальный снимок в Windows Server 2012:  
  
```  
Checkpoint-VM  
Export-VMSnapshot  
Get-VMSnapshot  
Remove-VMSnapshot  
Rename-VMSnapshot  
Restore-VMSnapshot  
```  
  


