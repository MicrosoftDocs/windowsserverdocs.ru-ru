---
ms.assetid: 3acaa977-ed63-4e38-ac81-229908c47208
title: Способ обработки файлов cookie сервера LDA
description: ''
author: MicrosoftGuyJFlo
ms.author: joflore
manager: mtillman
ms.date: 05/31/2017
ms.topic: article
ms.prod: windows-server
ms.technology: identity-adds
ms.openlocfilehash: ca63fa9504765b0376eb671b4decd67de7768f15
ms.sourcegitcommit: 083ff9bed4867604dfe1cb42914550da05093d25
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/14/2020
ms.locfileid: "75948889"
---
# <a name="how-ldap-server-cookies-are-handled"></a>Способ обработки файлов cookie сервера LDA

>Область применения: Windows Server 2016, Windows Server 2012 R2, Windows Server 2012

В LDAP результатом выполнения некоторых запросов являются большие наборы данных. Такие запросы связаны с возникновением определенных трудностей в Windows Server.  
  
Сбор и формирование больших наборов результатов является трудоемким процессом. Многие атрибуты должны быть преобразованы из внутреннего представления в представление подключения LDAP. Для большинства атрибутов преобразование из внутреннего, часто двоичного формата, должно быть выполнено в текстовый формат UTF-8 в период ответа LDAP.  
  
Еще одна проблема заключается в том, что наборы результатов с десятками тысяч объектов достигают огромных размеров в несколько сотен мегабайт. Для них требуются большое виртуальное адресное пространство. Кроме того, передача по сети является проблематичной, поскольку, если в ходе передачи происходит прерывание сеанса TCP, все усилия окажутся напрасными  
  
Эти проблемы с емкостью и логистическими проблемами привели к созданию расширения LDAP, известного как «страничный запрос», разработчикам Microsoft LDAP. Это расширение использует элемент управления LDAP для разделения одного большого запроса на блоки небольших наборов результатов. Он стал стандартом RFC [2696](http://www.ietf.org/rfc/rfc2696).  
  
## <a name="cookie-handling-on-client"></a>Обработка файлов cookie в клиенте  
В методе страничного запроса используется размер страницы, заданный клиентом или [политикой LDAP](https://support.microsoft.com/kb/315071/en-us) ("макспажесизе"). Клиент всегда должен включать разбиение по страницам путем отправки элемента управления LDAP.  

  
При работе с запросом с большим количеством результатов в определенный момент достигается максимальное разрешенное количество объектов. Сервер LDAP упаковывает ответное сообщение и добавляет файл cookie, который содержит сведения, необходимые для продолжения поиска позднее.  
  
Клиентское приложение должно обрабатывать файл cookie как непрозрачный большой двоичный объект. Клиент может получить количество объектов в ответе и продолжить поиск на основе наличия файла cookie. Клиент продолжает поиск, отправляя повторный запрос к серверу LDAP с теми же параметрами, такими как базовый объект и фильтр, и включает значение файла cookie, которое было возвращено в предыдущем ответе.  
  
Если число объектов не заполнено страницей, запрос LDAP завершается, а ответ не содержит страничных файлов cookie. Если сервер не вернул файлы cookie, клиент должен считать страничный поиск успешно завершенным.  
  
Если сервер вернул ошибку, клиент должен считать страничный поиск неудачным. Повторная попытка поиска приведет к перезапуску поиска с первой страницы.  
  
## <a name="server-side-cookie-handling"></a>Обработка файлов cookie на стороне сервера  
Windows Server возвращает клиенту файлы cookie и иногда сохраняет на сервере информацию, относящуюся к этим файлам. Данные хранятся на сервере в кэше, и к ним могут применяться определенные ограничения.  
  
В этом случае файлы cookie, отправленные сервером клиенту, также используются сервером для просмотра сведений из кэша на сервере. Когда клиент продолжает страничный поиск, Windows Server будет использовать файлы cookie клиента, а также все связанные сведения из кэша cookie. Если по какой-либо причине серверу не удается найти сведения о связанных файлах cookie в кэше сервера, поиск прекращается и клиенту возвращается ошибка.  
  
## <a name="how-the-cookie-pool-is-managed"></a>Управление пулом файлов cookie  
Очевидно, что сервер LDAP обслуживает несколько клиентов одновременно. Кроме того, несколько клиентов могут одновременно запустить запросы, требующие использования кэша cookie сервера. Поэтому в реализации Windows Server существует функция отслеживания использования пула файлов cookie и действуют ограничения, за счет которых пул файлов cookie не потребляет слишком много ресурсов. Администраторы задают ограничения, используя следующие параметры политики LDAP. Значения параметров по умолчанию и описания  
  
**MinResultSets: 4**  
  
Если количество записей в кэше cookie сервера не превышает значение MinResultSets, сервер LDAP не будет принимать во внимание значение максимального размера пула.  
  
**MaxResultSetSize: 262 144 байт**  
  
Общий размер кэша файлов cookie на сервере не должен превышать максимальное значение MaxResultSetSize в байтах. Если значение превышено, файлы cookie, начиная с самого старого, будут удаляться до тех пор, пока размер пула не станет меньше значения MaxResultSetSize или меньше размера файлов cookie MinResultSets, находящихся в пуле. Это значит, что при использовании параметров по умолчанию сервер LDAP считает нормальным пул размером 450 КБ, если в нем хранится только 3 файла cookie.  
  
**MaxResultSetsPerConn: 10**  
  
Для каждого LDAP-подключения в пуле сервер LDAP не допускает количество файлов cookie, превышающее значение MaxResultSetsPerConn.  
  
## <a name="handling-deleted-cookies"></a>Обработка удаленных файлов cookie  
Удаление сведений файла cookie из кэша сервера LDAP не приводит к незамедлительной ошибке приложений. Приложения могут перезапустить страничный поиск с начала и выполнить его при следующей попытке. Некоторые приложения располагают подобным механизмом повтора для дополнительной надежности.  
  
Некоторые приложения могут выполнять станичный поиск и никогда не завершать его. В этом случае записи остаются в кэше cookie на сервере LDAP, который обрабатывается с помощью механизма, указанного в разделе 4. Важно освободить память на сервере для активных поисков LDAP.  
  
Что происходит, если такой файл cookie удаляется, а клиент продолжает поиск с дескриптором этого файла cookie? Сервер LDAP не найдет файл cookie в кэше cookie сервера и вернет ошибку для запроса. Ответ на ошибку будет выглядеть следующим образом.  
  
```  
00000057: LdapErr: DSID-xxxxxxxx, comment: Error processing control, data 0, v1db1  
```  
  
> [!NOTE]  
> Шестнадцатеричное значение "ДСИД" будет зависеть от версии сборки двоичных файлов сервера LDAP.  
  
## <a name="reporting-on-the-cookie-pool"></a>Отчеты о пуле файлов cookie  
LDAP-сервер может регистрировать события с помощью категории "16-интерфейс LDAP" в [ключе диагностики NTDS](https://support.microsoft.com/kb/314980/en-us). Если для этой категории задано значение "2", можно получить следующие события:  
  
```  
Log Name:      Directory Service  
Source:        Microsoft-Windows-ActiveDirectory_DomainService  
Event ID:      2898  
Task Category: LDAP Interface  
Level:         Information  
Description:  
Internal event: The LDAP server has reached the limit of the number of Result Sets it will maintain for a single connection.  A stored Result Set will be discarded.  This will result in a client being unable to continue a paged LDAP search.  
Maximum number of Result Sets allowed per LDAP connection:  
10  
Current number of Result Sets for this LDAP connection:  
11  
  
User Action  
The client should consider a more efficient search filter.  The limit for Maximum Result Sets per Connection may also be increased.  
  
```  
  
```  
Log Name:      Directory Service  
Source:        Microsoft-Windows-ActiveDirectory_DomainService  
Event ID:      2899  
Task Category: LDAP Interface  
Level:         Information  
Description:  
Internal event: The LDAP server has exceeded the limit of the LDAP Maximum Result Set Size. A stored Result Set will be discarded.  This will result in a client being unable to continue a paged LDAP search.   
  
Number of result sets currently stored:   
4   
Current Result Set Size:   
263504   
Maximum Result Set Size:   
262144   
Size of single Result Set being discarded:   
40876   
User Action   
The client should consider a more efficient search filter.  The limit for Maximum Result Set Size may also be increased.  
  
```  
  
События указывают, что хранимый файл cookie был удален. Это НЕ значит, что клиент видел ошибку LDAP ошибку. Это значит, что сервер LDAP достиг административных ограничений для кэша.  В некоторых случаях в клиенте LDAP может быть отменен страничный поиск и ошибка никогда не возникнет.  
  
## <a name="monitoring-the-cookie-pool"></a>Мониторинг пула файлов cookie  
Если в вашем домене никогда не возникают ошибки поиска LDAP, отслеживать пул файлов cookie поиска страниц сервера LDAP не потребуется. Если в среде отображаются ошибки, связанные со страничным поиском LDAP, может возникнуть проблема ограничения заданного администратором размера пула файлов cookie.  
  
События 2898 и 2899 являются единственными способами, позволяющими узнать о достижении сервером LDAP ограничений, установленных администратором. При возникновении ошибок запросов LDAP, связанных с указанной выше ошибкой обработки элемента, необходимо просмотреть ограничения на увеличение в одном или нескольких параметрах политики LDAP, упомянутых в разделе 4, в зависимости от того, какое событие происходит.  
  
Если на контроллере домена или сервере LDAP отображается событие 2898, в качестве значения MaxResultSetsPerConn рекомендуется задать 25. Более 25 параллельных страничных поисков в одном соединении LDAP является нетипичным. Если событие 2898 сохраняется, рекомендуется изучить клиентское приложение LDAP, в котором возникает ошибка. Можно предположить, что оно каким-либо образом зависает при получении дополнительных результатов, оставляет файл cookie в режиме ожидания и перезапускает новый запрос. Поэтому, чтобы узнать, будет ли приложение в определенный момент иметь достаточно файлов cookie, можно также увеличить значение MaxResultSetsPerConn (изначально задано 25). Если на контроллерах домена регистрируются события 2899, следует предпринять другие меры. Если контроллер домена или сервер LDAP работает на компьютере с достаточным объемом памяти (несколько ГБ свободной памяти), в качестве значения параметра MaxResultsetSize на сервере LDAP рекомендуется задать значение, не превышающее 250 МБ. Это ограничение является достаточным для хранения больших объемов страничных поисков LDAP даже в очень крупных каталогах.  
  
Если события 2899 с пулом 250 МБ или больше сохраняются, скорее всего, существует много клиентов с большим количеством возвращаемых объектов с частым выполнением запросов. Данные, которые можно собрать с помощью [группы сборщиков данных Active Directory](https://blogs.technet.com/b/askds/archive/2010/06/08/son-of-spa-ad-data-collector-sets-in-win2008-and-beyond.aspx) , могут помочь найти повторяющиеся страничные запросы, в которых серверы LDAP заняты. Все эти запросы отображаются с рядом "возвращенных записей", которые соответствуют размеру используемой страницы.  
  
По возможности следует ознакомиться со структурой приложения и реализовать другой подход с более низкой частотой, объемом данных и (или) меньшим количеством экземпляров клиента, запрашивая эти данные. В случае с приложениями, для которых есть доступ к исходному коду, это пошаговое описание [создания эффективных приложений с поддержкой AD](https://msdn.microsoft.com/library/ms808539.aspx) поможет понять оптимальный способ доступа приложений к AD.  
  
Если поведение запроса не может быть изменено, один из подходов также добавляет более реплицируемые экземпляры контекстов именования, необходимые для повторного распределения клиентов и постепенно уменьшая нагрузку на отдельные серверы LDAP.  
  


