---
ms.assetid: 3acaa977-ed63-4e38-ac81-229908c47208
title: "Способ обработки файлов cookie сервера LDAP"
description: 
author: billmath
ms.author: billmath
manager: femila
ms.date: 05/31/2017
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: identity-adds
ms.openlocfilehash: 89369cb1e52a315520062ca5ecc96b66ac3e2bfc
ms.sourcegitcommit: db290fa07e9d50686667bfba3969e20377548504
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/12/2017
---
# <a name="how-ldap-server-cookies-are-handled"></a>Способ обработки файлов cookie сервера LDAP

>Область применения: Windows Server 2016, Windows Server 2012 R2, Windows Server 2012

В LDAP результатом выполнения некоторых запросов в больших результирующих наборы данных. Такие запросы связаны с возникновением определенных трудностей Windows Server.  
  
Сбор и создания этих наборов результатов большой — значительная работа. Многие атрибуты должны быть преобразованы из внутреннего представления в представление подключения LDAP. Для большинства атрибутов преобразование из внутреннего, часто двоичного формата, должно быть выполнено в текстовый формат UTF-8 в период ответа LDAP.  
  
Еще одна проблема заключается в том, что наборы результатов с десятками тысяч объектов достигают огромных размеров легко несколько сотен мегабайт. Них требуются большое виртуальное адресное пространство, и Кроме того, передача по сети проблематичной все усилия окажутся теряется, когда происходит прерывание сеанса TCP во время передачи.  
  
Эти емкости проблемы и передачей, привели разработчиков Microsoft LDAP к созданию расширения LDAP, называется «Страничный запрос». Это расширение использует элемент управления LDAP для разделения одного большого запроса на блоки небольших наборов результатов. Оно стало стандартом RFC [RFC 2696](http://www.ietf.org/rfc/rfc2696).  
  
## <a name="cookie-handling-on-client"></a>Обработка файлов cookie в клиента  
Метод страничного запроса использует размер страницы, заданный либо клиентом, либо с помощью [политики LDAP](https://support.microsoft.com/kb/315071/en-us) («MaxPageSize»). Клиент всегда должен включать разбиение по страницам путем отправки элемента управления LDAP.  

  
При работе с запросом с большим количеством результатов в определенный момент максимальное разрешенное количество объектов достигнуто. Сервер LDAP упаковывает ответное сообщение и добавляет файл cookie, который содержит сведения, необходимые для продолжения поиска позднее.  
  
Клиентское приложение должно обрабатывать файл cookie как непрозрачный большой двоичный объект. Клиент может получить количество объектов в ответе и продолжить поиск на основе наличия файла cookie. Клиент продолжает поиск, отправляя запрос к серверу LDAP с теми же параметрами, такими как базовый объект и фильтр и включает значение файла cookie, которое было возвращено в предыдущем ответе.  
  
Если количество объектов не заполняет страницу, LDAP-запрос будет завершен, и ответ будет содержать файлы cookie не страниц. Если сервер вернул не файлов cookie, клиент должен считать страничный поиск успешно завершенным.  
  
Если сервер вернул ошибку, клиент должен считать страничный поиск неудачным. Повторная попытка поиска приведет к перезапуску поиска с первой страницы.  
  
## <a name="server-side-cookie-handling"></a>Обработка файлов Cookie на стороне сервера  
Windows Server возвращает клиенту файлы cookie и иногда сохраняет информацию, относящуюся к этим файлам на сервере. Эта информация хранится на сервере в кэше и регулируется определенные ограничения.  
  
В этом случае файлы cookie, отправленных сервером клиенту также используются сервером для просмотра сведений из кэша на сервере. Когда клиент продолжает страничный поиск, Windows Server будет использовать в кэше cookie сервера файлы cookie клиента, а также все связанные сведения для продолжения поиска. Если серверу не удается найти сведения о связанных файлах cookie в кэше сервера из-за какой-либо причине, поиск прекращается и клиенту возвращается ошибка.  
  
## <a name="how-the-cookie-pool-is-managed"></a>Управление пулом файлов cookie  
Очевидно, что сервер LDAP обслуживает несколько клиентов одновременно, а также несколько клиентов одновременно можно запустить запросы, требующие использования кэша cookie сервера. Таким образом реализации Windows Server существует функция отслеживания использования пула файлов cookie и действуют ограничения месте, пул файлов cookie не потребляет слишком много ресурсов. Можно задать ограничения администратором с помощью следующих параметров политики LDAP. Значения по умолчанию и описания  
  
**MinResultSets: 4**  
  
Сервер LDAP не рассмотрим максимального размера пула упомянутых выше, если не превышает MinResultSets записей в кэше cookie сервера.  
  
**MaxResultSetSize: 262 144 байт**  
  
Размер кэша общее количество файлов cookie на сервере не должен превышать максимальное значение MaxResultSetSize в байтах. В этом случае файлы cookie, начиная с самого старого, удаляются, пока пул меньше, чем байт MaxResultSetSize или меньше размера файлов cookie MinResultSets, в пуле. Это означает, что с помощью параметров по умолчанию сервер LDAP считает пул размером 450 КБ OK, если имеется только 3 файла Cookie хранятся.  
  
**Значение MaxResultSetsPerConn: 10**  
  
Сервер LDAP не допускает превышающее значение MaxResultSetsPerConn файлы cookie для каждого LDAP-подключения в пуле.  
  
## <a name="handling-deleted-cookies"></a>Обработка удаленных файлов cookie  
Удаление сведений файла cookie из кэша сервера LDAP не приводит к незамедлительной ошибке приложений во всех случаях. Приложения могут перезапустить страничный поиск с начала и выполнить его при следующей попытке. Некоторые приложения располагают подобным механизмом повтора для дополнительной надежности.  
  
Некоторые приложения могут выполнять поиск страницы и никогда не завершать его. В этом случае остаются записей на сервере LDAP кэша файлов cookie, который обрабатывается с помощью механизма, указанного в разделе 4. Это важно, чтобы освободить память на сервере для активных поисков LDAP.  
  
Что произойдет, если такой файл cookie удаляется на сервере, а клиент продолжает поиск с дескриптором этого файла cookie? Сервер LDAP не найдет файл cookie на сервере кэша cookie и вернет ошибку для запроса, ответ на ошибку будет выглядеть следующим образом:  
  
```  
00000057: LdapErr: DSID-xxxxxxxx, comment: Error processing control, data 0, v1db1  
```  
  
> [!NOTE]  
> Шестнадцатеричное значение за «DSID» будет зависеть от версии сборки двоичных файлов сервера LDAP.  
  
## <a name="reporting-on-the-cookie-pool"></a>Отчеты о пуле файлов cookie  
LDAP-сервер имеет возможность регистрировать события по категории «16 Ldap Interface» в [диагностики NTDS](https://support.microsoft.com/kb/314980/en-us). Если этой категории задано значение «2», можно получить следующие события.  
  
```  
Log Name:      Directory Service  
Source:        Microsoft-Windows-ActiveDirectory_DomainService  
Event ID:      2898  
Task Category: LDAP Interface  
Level:         Information  
Description:  
Internal event: The LDAP server has reached the limit of the number of Result Sets it will maintain for a single connection.  A stored Result Set will be discarded.  This will result in a client being unable to continue a paged LDAP search.  
Maximum number of Result Sets allowed per LDAP connection:  
10  
Current number of Result Sets for this LDAP connection:  
11  
  
User Action  
The client should consider a more efficient search filter.  The limit for Maximum Result Sets per Connection may also be increased.  
  
```  
  
```  
Log Name:      Directory Service  
Source:        Microsoft-Windows-ActiveDirectory_DomainService  
Event ID:      2899  
Task Category: LDAP Interface  
Level:         Information  
Description:  
Internal event: The LDAP server has exceeded the limit of the LDAP Maximum Result Set Size. A stored Result Set will be discarded.  This will result in a client being unable to continue a paged LDAP search.   
  
Number of result sets currently stored:   
4   
Current Result Set Size:   
263504   
Maximum Result Set Size:   
262144   
Size of single Result Set being discarded:   
40876   
User Action   
The client should consider a more efficient search filter.  The limit for Maximum Result Set Size may also be increased.  
  
```  
  
События указывают, что хранимый файл cookie был удален. Это не означает, что клиент видел ошибку LDAP ошибку, но только в том, что сервер LDAP достиг административных ограничений для кэша.  В некоторых случаях LDAP-клиента может быть отменен страничный поиск и никогда не возникнет ошибка.  
  
## <a name="monitoring-the-cookie-pool"></a>Мониторинг пула файлов cookie  
Если в вашем домене никогда не возникают ошибки поиска LDAP, отслеживать пул файлов cookie поиска страниц сервера LDAP может не потребуется. Если вы видите страничным поиском в вашей среде ошибок, связанных с LDAP, может возникнуть проблема с ограничениями администратора пула файлов cookie.  
  
События 2898 и 2899 являются единственными способами, позволяющими узнать о достижении сервером LDAP ограничений, установленных администратором. При возникновении ошибок запросов LDAP, связанных с указанной выше ошибкой обработки элемента, необходимо просмотреть ограничения на увеличение в один или несколько параметров политики LDAP, упомянутых в разделе 4, в зависимости от того, какое событие происходит.  
  
Если на вашей контроллера домена или сервере LDAP отображается событие 2898 сохраняется, рекомендуется задать значение MaxResultSetsPerConn 25. Более 25 параллельных страничных поисков в одном соединении LDAP является нетипичным. Если событие 2898 сохраняется, рекомендуется изучить клиентское приложение LDAP, в котором возникает ошибка. Предположить, что он каким-либо образом зависает при получении дополнительных результатов, оставляет файл cookie в состоянии ожидания и перезапускает новый запрос. Поэтому, чтобы узнать, является ли приложение в определенный момент иметь достаточно файлов cookie в своих целях, можно также увеличить значение MaxResultSetsPerConn 25 при отображении на контроллерах домена регистрируются события 2899, следует другой. Если ваш контроллер домена или сервер LDAP работает на компьютере с достаточным объемом памяти (несколько ГБ свободной памяти), рекомендуется задать MaxResultsetSize на сервере LDAP, чтобы > = 250 МБ. Это ограничение является достаточным для хранения больших объемов страничных поисков LDAP даже в очень крупных каталогах.  
  
Если события 2899 с пулом 250 МБ или больше сохраняются скорее всего, наличие много клиентов с большим количеством возвращаемых объектов, запрос в частым выполнением запросов. Данные, собираемые с [Active Directory сборщиков данных](http://blogs.technet.com/b/askds/archive/2010/06/08/son-of-spa-ad-data-collector-sets-in-win2008-and-beyond.aspx) можно занят помогут найти повторяющиеся страничные запросы, LDAP-сервера. Эти запросы будут отображаться с количеством «Вернул записей», соответствующим размеру страницы.  
  
Если это возможно следует просмотреть структуру приложения и применить другой подход с более низкой интенсивностью, тома данных или меньшим количеством экземпляров клиента, запрос эти данные. В случае приложений, к которым имеют доступ к исходному коду, данное руководство [созданию эффективных приложений AD-Enabled](https://msdn.microsoft.com/en-us/library/ms808539.aspx) поможет определить оптимальный способ доступа приложений к AD.  
  
Если поведение запроса изменить нельзя, одним из решений является добавление дополнительных реплицированных экземпляров контекстов именования, распределение клиентов и в конечном итоге снижение нагрузки на отдельные серверы LDAP.  
  


