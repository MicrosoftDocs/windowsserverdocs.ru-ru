---
title: Восстановление леса AD. Определение способа восстановления леса
ms.author: joflore
author: MicrosoftGuyJFlo
manager: mtillman
ms.date: 08/09/2018
ms.topic: article
ms.prod: windows-server
ms.assetid: 5a291f65-794e-4fc3-996e-094c5845a383
ms.technology: identity-adds
ms.openlocfilehash: fea55dc5551198f7bc06afb2ec38077398b9cf77
ms.sourcegitcommit: b00d7c8968c4adc8f699dbee694afe6ed36bc9de
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/08/2020
ms.locfileid: "80824057"
---
# <a name="determine-how-to-recover-the-forest"></a>Определение способа восстановления леса

>Область применения: Windows Server 2016, Windows Server 2012 и 2012 R2, Windows Server 2008 и 2008 R2

Восстановление всего Active Directory леса предполагает восстановление из резервной копии или переустановку домен Active Directory служб (AD DS) на каждом контроллере домена в лесу. При восстановлении леса каждый домен в лесу восстанавливает состояние во время последнего надежного резервного копирования. Следовательно, операция восстановления приведет к утрате по крайней мере следующих Active Directory данных:

- Все объекты (например, пользователи и компьютеры), добавленные после последней доверенной резервной копии
- Все обновления, внесенные в существующие объекты с момента последнего доверенного резервного копирования
- Все изменения, внесенные в раздел конфигурации или в секцию схемы в AD DS (например, изменения схемы) с момента последней доверенной резервной копии

Для каждого домена в лесу должен быть известен пароль учетной записи администратора домена. Желательно, чтобы это пароль встроенной учетной записи администратора. Чтобы выполнить восстановление состояния системы контроллера домена, необходимо также иметь пароль DSRM. Как правило, рекомендуется архивировать учетную запись администратора и журнал паролей DSRM в надежном месте до тех пор, пока резервные копии действительны, то есть в течение времени существования захоронения или в течение времени существования удаленного объекта, если включена Active Directory корзина. Можно также синхронизировать пароль DSRM с учетной записью пользователя домена, чтобы упростить его запоминание. Дополнительные сведения см. в статье базы знаний [961320](https://support.microsoft.com/kb/961320). Синхронизация учетной записи DSRM должна выполняться заранее с восстановлением леса в рамках подготовки.

> [!NOTE]
> Учетная запись администратора является членом встроенной группы администраторов по умолчанию, как и группы администраторов домена и Администраторы предприятия. Эта группа полностью контролирует все контроллеры домена в домене.

## <a name="determining-which-backups-to-use"></a>Определение резервных копий для использования

Регулярно создавайте резервные копии по крайней мере двух записываемых контроллеров домена, чтобы можно было выбрать несколько резервных копий. Обратите внимание, что нельзя использовать резервную копию контроллера домена только для чтения (RODC) для восстановления контроллера, поддерживающего запись. Рекомендуется восстановить контроллеры домена с помощью резервных копий, которые выполнялись несколько дней до возникновения сбоя. В общем случае необходимо определить компромисс между актуальностью и надежностью восстановленных данных. Выбор более свежей резервной копии позволяет восстановить более полезные данные, но может увеличить риск повторного введения опасной информации в восстановленный лес.

Восстановление резервных копий состояния системы зависит от исходной операционной системы и сервера резервной копии. Например, не следует восстанавливать резервную копию состояния системы на другой сервер. В этом случае может отобразиться следующее предупреждение:

"Указанная резервная копия отличается от сервера текущей. Не рекомендуется выполнять восстановление состояния системы с резервной копией на альтернативном сервере, так как сервер может стать непригодным для использования. Вы действительно хотите использовать эту резервную копию для восстановления текущего сервера? "

Если необходимо восстановить Active Directory на другое оборудование, создайте полные резервные копии сервера и запланируйте выполнение полного восстановления сервера.

> [!IMPORTANT]
> Начиная с Windows Server 2008, восстановление резервной копии состояния системы в новую установку Windows Server на новом оборудовании или на том же оборудовании не поддерживается. Если Windows Server переустановлен на том же оборудовании, как мы рекомендуем в этом разделе, можно восстановить контроллер домена в следующем порядке:
>
> 1. Выполните полное восстановление сервера, чтобы восстановить операционную систему и все файлы и приложения.
> 2. Выполните восстановление состояния системы с помощью WBADMIN. exe, чтобы пометить SYSVOL как полномочный.
>
> Дополнительные сведения см. в статье базы знаний Майкрософт [249694](https://support.microsoft.com/kb/249694).

Если время возникновения сбоя неизвестно, проверьте дополнительные сведения о том, как определить резервные копии, в которых хранится Последнее состояние леса. Этот подход является менее предпочтительным. Поэтому настоятельно рекомендуется хранить подробные журналы состояния работоспособности AD DS на ежедневной основе, чтобы при сбое в масштабе леса можно было определить примерное время сбоя. Чтобы обеспечить более быстрое восстановление, следует также создать локальную копию резервных копий.

Если Active Directory корзина включена, время жизни резервной копии равно значению **делетедобжектлифетиме** или значению **томбстонелифетиме** (в зависимости от того, какое значение меньше). Дополнительные сведения см. в статье Пошаговое [Active Directory корзины](https://go.microsoft.com/fwlink/?LinkId=178657) (https://go.microsoft.com/fwlink/?LinkId=178657).

В качестве альтернативы можно также использовать средство Active Directory Database Mount Tool (Dsamain. exe) и средство LDAP, например LDP. exe или Active Directory пользователи и компьютеры, чтобы указать, какая резервная копия имеет Последнее состояние в качестве безопасного состояния леса. Средство Active Directory Database Mount Tool, которое входит в состав операционных систем Windows Server 2008 и более поздних версий, предоставляет Active Directory данные, которые хранятся в резервных копиях или моментальных снимках как LDAP-сервер. Затем для просмотра данных можно использовать средство LDAP. Этот подход имеет преимущество не требует перезапуска контроллера домена в режиме восстановления служб каталогов (DSRM) для проверки содержимого резервной копии AD DS.

Дополнительные сведения об использовании средства монтирования баз данных Active Directory см. в разделе [пошаговое описание инструмента для подключения к базе данных Active Directory](https://technet.microsoft.com/library/cc753609\(WS.10\).aspx).

Для создания моментальных снимков Active Directory базы данных можно также использовать команду **ntdsutil snapshot** . Планируя задачу для периодического создания моментальных снимков, можно получить дополнительные копии Active Directory базы данных с течением времени. Эти копии можно использовать, чтобы лучше определить время сбоя в масштабе леса, а затем выбрать наиболее подходящую резервную копию для восстановления. Чтобы создать моментальные снимки, используйте версию **ntdsutil** , входящую в состав windows Server 2008 или средства удаленного администрирования сервера (RSAT) для Windows Vista или более поздней версии. Целевой контроллер домена может работать под управлением любой версии Windows Server. Дополнительные сведения об использовании команды **ntdsutil snapshot** см. в разделе [snapshot](https://technet.microsoft.com/library/cc731620\(WS.10\).aspx).

## <a name="determining-which-domain-controllers-to-restore"></a>Определение контроллеров домена для восстановления

Простота процесса восстановления является важным фактором при принятии решения о том, какой контроллер домена поддается восстановлению. Рекомендуется использовать выделенный контроллер домена для каждого домена, который является предпочитаемым КОНТРОЛЛЕРом домена для восстановления. Выделенный контроллер домена для восстановления упрощает планирование и выполнение восстановления леса, так как используется та же конфигурация источника, которая использовалась для выполнения тестов восстановления. Вы можете создать скрипт восстановления и не конкурировать с различными конфигурациями, например, если контроллер домена содержит роли хозяина операций или нет, а также является ли он ГЛОБАЛЬным или DNS-сервером.

> [!NOTE]
> Хотя не рекомендуется восстанавливать владельца роли хозяина операций в целях простоты, некоторые организации могут восстановить одно из них для других преимуществ. Например, восстановление хозяина RID может помочь предотвратить проблемы с управлением идентификаторами RID во время восстановления.  

Выберите контроллер домена, который наилучшим образом соответствует следующим критериям:

- Доступный для записи контроллер домена. Это обязательный аргумент.

- Контроллер домена под управлением Windows Server 2012 в качестве виртуальной машины в гипервизоре, поддерживающей VM-GenerationID. Этот контроллер домена можно использовать в качестве источника для клонирования.
- Контроллер домена, доступный как физически, так и в виртуальной сети, и лучше всего расположен в центре обработки данных. Таким образом, можно легко изолировать его от сети во время восстановления леса.
- Контроллер домена с хорошей полной резервной копией сервера. Хорошая резервная копия — это резервная копия, которая может быть успешно восстановлена, заняла несколько дней до сбоя и содержит как можно больше полезных данных.
- КОНТРОЛЛЕР домена, который был сервером системы доменных имен (DNS) до сбоя. Это экономит время, необходимое для переустановки DNS.
- Если вы также используете службы развертывания Windows, выберите контроллер домена, который не настроен для использования сетевой разблокировки BitLocker. В этом случае сетевая разблокировка BitLocker не поддерживается для первого контроллера домена, который восстанавливается из резервной копии во время восстановления леса.

   Сетевая разблокировка BitLocker в качестве *единственного* предохранителя ключа *не может* использоваться на контроллерах домена, где развернуты службы развертывания Windows (WDS), поскольку это приводит к ситуации, когда первый контроллер домена требует Active Directory и WDS для разблокировки. Но перед восстановлением первого контроллера домена Active Directory еще не доступен для WDS, поэтому он не может разблокировать.

   Чтобы определить, настроен ли контроллер домена для использования сетевой разблокировки BitLocker, убедитесь, что сертификат сетевой разблокировки указан в следующем разделе реестра:

   HKEY_LOCAL_MACHINESoftwarePoliciesMicrosoftSystemCertificatesFVE_NKP

Поддержание процедур безопасности при обработке или восстановлении файлов резервных копий, содержащих Active Directory. Срочность, сопровождающая восстановление леса, может случайно привести к непреднамеренному рассмотрению рекомендаций по обеспечению безопасности. Дополнительные сведения см. в разделе «Установка стратегии резервного копирования и восстановления контроллеров домена» в [рекомендуемом руководстве по обеспечению безопасности Active Directory установки и повседневных операций. часть II](https://technet.microsoft.com/library/bb727066.aspx).

## <a name="identify-the-current-forest-structure-and-dc-functions"></a>Указание текущей структуры леса и функций контроллера домена

Определите текущую структуру леса, определив все домены в лесу. Создайте список всех контроллеров домена в каждом домене, в частности контроллерах домена с резервными копиями и виртуализированными контроллерами домена, которые могут быть источником для клонирования. Наиболее важным является список контроллеров домена корня леса, так как сначала необходимо восстановить этот домен. После восстановления корневого домена леса можно получить список других доменов, контроллеров домена и сайтов в лесу с помощью оснасток Active Directory.

Подготовьте таблицу, в которой показаны функции каждого контроллера домена в домене, как показано в следующем примере. Это позволит вернуться к конфигурации после сбоя в лесу после восстановления.

|Имя контроллера домена|Операционная система|FSMO|Сборка мусора|Контроллер домена только для чтения|Резервное копирование|DNS|Основные серверные компоненты|Виртуальная машина|Виртуальная машина — Женид|  
|-------------|----------------------|----------|--------|----------|------------|---------|-----------------|--------|---------------|  
|DC_1|Windows Server 2012|Хозяин схемы, хозяин именования доменов|Да|Нет|Да|Нет|Нет|Да|Да|  
|DC_2|Windows Server 2012|Нет|Да|Нет|Да|Да|Нет|Да|Да|  
|DC_3|Windows Server 2012|Хозяин инфраструктуры|Нет|Нет|Нет|Да|Да|Да|Да|  
|DC_4|Windows Server 2012|Эмулятор основного контроллера домена, хозяин RID|Да|Нет|Нет|Нет|Нет|Да|Нет|  
|DC_5|Windows Server 2012|Нет|Нет|Нет|Да|Да|Нет|Да|Да|  
|RODC_1|Windows Server 2008 R2|Нет|Да|Да|Да|Да|Да|Да|Нет|  
|RODC_2|Windows Server 2008|Нет|Да|Да|Нет|Да|Да|Да|Нет|  

Для каждого домена в лесу необходимо выбрать один доступный для записи контроллер домена, имеющий надежную резервную копию базы данных Active Directory для этого домена. Будьте внимательны при выборе резервной копии для восстановления контроллера домена. Если день и причина сбоя приблизительно известны, Общая рекомендация заключается в использовании резервной копии, которая была сделана за несколько дней до этой даты.
  
В этом примере есть четыре кандидата для резервного копирования: DC_1, DC_2, DC_4 и DC_5. Из этих кандидатов резервного копирования вы восстанавливаете только одно. Рекомендуемый контроллер домена DC_5 по следующим причинам.  

- Он удовлетворяет требованиям к использованию в качестве источника для виртуализованного клонирования контроллеров домена, т. е. он работает под управлением Windows Server 2012 в качестве виртуального контроллера домена в гипервизоре, поддерживающем VM-GenerationID, запускает программное обеспечение, для которого разрешено клонирование (или которое может быть удалено, если его невозможно клонировать). После восстановления роль эмулятора основного контроллера домена будет захвачена на этом сервере и может быть добавлена в группу клонированных контроллеров доменов для домена.  
- Он выполняет полную установку Windows Server 2012. Контроллер домена, на котором установлена установка Server Core, может быть менее удобен для восстановления.  
- Это DNS-сервер. Поэтому переустановка DNS не требуется.  

> [!NOTE]
> Поскольку DC_5 не является сервером глобального каталога, он также имеет преимущество в том, что глобальный каталог не нужно удалять после восстановления. Но независимо от того, является ли контроллер домена сервером глобального каталога, не является деЦисиве фактором, поскольку начиная с Windows Server 2012, все контроллеры домена по умолчанию являются серверами глобального каталога, а после восстановления в рамках процесса восстановления леса рекомендуется удалять и добавлять глобальный каталог.  

## <a name="recover-the-forest-in-isolation"></a>Восстановление леса в режиме изоляции

Предпочтительный сценарий — завершить работу всех контроллеров, которые могут быть записаны, прежде чем первый восстановленный контроллер домена вернется в рабочую среду. Это гарантирует, что все опасные данные не реплицируются обратно в восстановленный лес. Особенно важно завершить работу всех владельцев ролей хозяина операций.  

> [!NOTE]
> В некоторых случаях вы можете переместить первый контроллер домена, который планируется восстановить для каждого домена в изолированную сеть, и разрешить другим контроллерам домена оставаться в сети, чтобы свести к минимуму время простоя системы. Например, если выполняется восстановление после сбоя обновления схемы, можно выбрать сохранение контроллеров домена, работающих в рабочей сети, при выполнении шагов восстановления в режиме изоляции.

Если вы используете виртуализированные контроллеры домена, их можно переместить в виртуальную сеть, изолированную от рабочей сети, в которой будет выполняться восстановление. Перемещение виртуализированных контроллеров домена в отдельную сеть дает два преимущества:  

- Восстановленные контроллеры домена препятствуют повторному возникновению проблемы, которая привела к восстановлению леса, поскольку они изолированы.  
- Виртуализованное клонирование контроллеров домена может быть выполнено в отдельной сети, чтобы можно было запустить и проверить критическое количество контроллеров домена, прежде чем они будут возвращены в рабочую сеть.

Если вы используете контроллеры домена на физическом оборудовании, отключите сетевой кабель первого контроллера домена, который планируется восстановить, в корневом домене леса. Если возможно, также отключите сетевые кабели всех остальных контроллеров домена. Это предотвращает репликацию контроллеров домена, если они случайно запускаются в процессе восстановления леса.  

В большом лесу, распределенном по нескольким расположениям, может быть трудно гарантировать, что все записываемые контроллеры домена будут выключены. По этой причине шаги восстановления, такие как сброс учетной записи компьютера и учетной записи KRBTGT, помимо очистки метаданных, предназначены для того, чтобы гарантировать, что восстановленные записываемые контроллеры домена не реплицируются с опасными для записи контроллерами домена (если некоторые из них остаются в сети леса).  
  
Однако только при автономном доступе к записываемым контроллерам домена можно гарантировать, что репликация не выполняется. Поэтому по возможности следует развертывать технологию удаленного управления, которая может помочь при завершении работы и физической изоляции доступных для записи контроллеров домена во время восстановления леса.  
  
Контроллеры RODC могут продолжать работу, пока доступные для записи контроллеры домена находятся в автономном режиме. Ни один другой контроллер домена не будет напрямую реплицировать изменения с любого контроллера домена только для чтения (особенно без изменений контейнера схемы или конфигурации), так что они не будут иметь тот же риск, что и записываемые контроллеры домена во время восстановления. После восстановления и подключения всех доступных для записи контроллеров домена следует перестроить все контроллеры RODC.  
  
Контроллеры RODC будут по-прежнему разрешать доступ к локальным ресурсам, кэшированным на соответствующих сайтах, в то время как операции восстановления будут выполняться параллельно. Локальные ресурсы, которые не кэшируются на RODC, будут иметь запросы на проверку подлинности, перенаправляемые на доступный для записи контроллер домена. Эти запросы завершатся ошибкой, так как доступные для записи контроллеры домена находятся в автономном режиме. Некоторые операции, такие как изменение пароля, также не будут работать до тех пор, пока не будет восстановлен доступный для записи контроллер домена.  
  
Если вы используете архитектуру сети типа "звезда", вы можете сначала сосредоточиться на восстановлении доступных для записи контроллеров домена на центральных сайтах. Позже можно перестроить Контроллеры RODC на удаленных сайтах.  
  
## <a name="next-steps"></a>Следующие шаги

- [Восстановление леса AD — необходимые условия](AD-Forest-Recovery-Prerequisties.md)  
- [Восстановление леса AD — Девисинг план восстановления пользовательского леса](AD-Forest-Recovery-Devising-a-Plan.md)  
- [Восстановление леса AD. обнаружение проблемы](AD-Forest-Recovery-Identify-the-Problem.md)
- [Восстановление леса AD. Определение способа восстановления](AD-Forest-Recovery-Determine-how-to-Recover.md)
- [Восстановление леса AD — выполнение начального восстановления](AD-Forest-Recovery-Perform-initial-recovery.md)  
- [Восстановление леса AD — процедуры](AD-Forest-Recovery-Procedures.md)  
- [Восстановление леса AD — часто задаваемые вопросы](AD-Forest-Recovery-FAQ.md)  
- [Восстановление леса Active Directory. Восстановление одного домена в лесу с несколькими доменами](AD-Forest-Recovery-Single-Domain-in-Multidomain-Recovery.md)  
- [Восстановление леса Active Directory — восстановление леса с контроллерами домена Windows Server 2003](AD-Forest-Recovery-Windows-Server-2003.md)  
