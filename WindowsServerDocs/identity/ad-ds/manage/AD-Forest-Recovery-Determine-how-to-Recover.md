---
title: Восстановление леса AD — определить, как выполнить восстановление леса
description: ''
ms.author: joflore
author: MicrosoftGuyJFlo
manager: mtillman
ms.date: 08/09/2018
ms.topic: article
ms.prod: windows-server-threshold
ms.assetid: 5a291f65-794e-4fc3-996e-094c5845a383
ms.technology: identity-adds
ms.openlocfilehash: 30d23d977b4d7cd320d78ff340120df7013dee4c
ms.sourcegitcommit: 0d0b32c8986ba7db9536e0b8648d4ddf9b03e452
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2019
ms.locfileid: "59817735"
---
# <a name="determine-how-to-recover-the-forest"></a>Определить, как выполнить восстановление леса

>Область применения. Windows Server 2016, Windows Server 2012 и 2012 R2, Windows Server 2008 и 2008 R2

Восстановление всего леса Active Directory включает в себя восстановлением его из резервной копии или повторная установка доменных служб Active Directory (AD DS) на каждом контроллере домена (DC) в лесу. Восстановление леса восстанавливает каждого домена в лесу в состояние на момент последнего резервного копирования надежных. Следовательно операция восстановления приведет к потере по крайней мере следующие данные Active Directory:

- Все объекты (например, пользователи и компьютеры), которые были добавлены после последнего резервного копирования надежных
- Все обновления, внесенные в существующие объекты с момента последнего доверенные резервного копирования
- Все изменения, внесенные в раздел конфигурации или раздела схемы в Доменных службах Active Directory (например, изменения схемы) с момента последнего резервного копирования надежных

Для каждого домена в лесу должен быть известен пароль учетной записи администратора домена. Лучше всего это будет пароль встроенной учетной записи администратора. Также необходимо знать пароль DSRM для выполнения восстановления состояния системы контроллера домена. В общем случае рекомендуется архивации учетной записи администратора и журнал DSRM пароль в надежном месте для до тех пор, пока резервные копии являются допустимыми, то есть внутри время существования отметки полного удаления или временем существования удаленных объектов периода, если Active Directory корзины Ячейки включена. Вы также можете синхронизировать Пароль DSRM с учетной записью пользователя домена для повышения его легче запомнить. Дополнительные сведения см. в статье базы Знаний [961320](https://support.microsoft.com/kb/961320). Синхронизация учетной записи DSRM должны выполняться до восстановления леса, в ходе подготовки.

> [!NOTE]
> Учетная запись администратора является членом встроенной группы администраторов по умолчанию, как представляют собой группы "Администраторы домена" и "Администраторы предприятия". Эта группа имеет полный контроль над все контроллеры домена в домене.

## <a name="determining-which-backups-to-use"></a>Определить, какие резервные копии для использования

По крайней мере два для записи контроллеров домена для каждого домена регулярно создавайте резервные копии, у вас есть несколько резервных копий на выбор. Обратите внимание на то, что нельзя использовать для восстановления Контроллера домена для записи резервной копии контроллера домена только для чтения (RODC). Мы рекомендуем восстановить контроллеров домена с помощью резервных копий, созданных на несколько дней до возникновения сбоя. Как правило необходимо определить баланс между recentness и safeness восстановленные данные. Выбор последней резервной копии восстанавливает более полезных данных, но это может увеличить риск повторного добавления опасных данных в восстановленной лес.

Восстановление резервных копий состояния системы зависит от исходной операционной системы и сервера резервного копирования. Например не следует восстанавливать резервную копию состояния системы на другой сервер. В этом случае может появиться следующее предупреждение:

«Указанной резервной копии — с другого сервера, отличный от текущего. Не рекомендуется выполнять восстановление состояния системы во время резервного копирования на другой сервер, так как сервер может стать непригодным для использования. Уверены, что вы хотите использовать эту резервную копию для восстановления на текущем сервере?»

Если необходимо выполнить восстановление на различном оборудовании Active Directory, создайте резервные копии всего сервера и план для выполнения восстановления всего сервера.

> [!IMPORTANT]
> Начиная с Windows Server 2008, не поддерживается для восстановления резервной копии состояния системы в новую установку Windows Server, на новое оборудование или том же оборудовании. В случае переустановки Windows Server на том же оборудовании, согласно рекомендациям данного руководства, можно восстановить контроллер домена в следующем порядке:
>
> 1. Выполните восстановление всего сервера для восстановления операционной системы и всех файлов и приложений.
> 2. Выполните восстановление состояния системы с помощью wbadmin.exe, чтобы пометить SYSVOL как заслуживающие доверия.
>
> Дополнительные сведения см. в статье базы Знаний Майкрософт в статье [249694](https://support.microsoft.com/kb/249694).

Если в момент возникновения сбоя неизвестен, дальнейший анализ для идентификации резервных копий, которые содержат последние безопасного состояния леса. Этот подход является менее предпочтительным. Таким образом мы настоятельно рекомендуем сохранять подробные журналы о состоянии работоспособности AD DS на ежедневной основе, поэтому, если происходит ошибка леса, можно определить приблизительное время сбоя. Также следует сохранить локальную копию резервных копий, чтобы включить более быстрое восстановление.

Если включена Корзина Active Directory, время существования резервного копирования равно **deletedObjectLifetime** значение или **tombstoneLifetime** значение, какое значение меньше. Дополнительные сведения см. в разделе [Active Directory Bin Пошаговое руководство по использованию корзины](https://go.microsoft.com/fwlink/?LinkId=178657) (https://go.microsoft.com/fwlink/?LinkId=178657).

В качестве альтернативы можно также использовать средство подключения баз данных Active Directory (Dsamain.exe) и средство Lightweight Directory Access Protocol (LDAP), например Ldp.exe или Active Directory — пользователи и компьютеры, чтобы определить, какую резервную копию последнего безопасного состояния лес. Средство подключения базы данных Active Directory, которое входит в Windows Server 2008 и более поздних операционных системах Windows Server, предоставляет доступ к данным Active Directory, которые хранятся в резервные копии или моментальные снимки как LDAP-серверу. Затем можно использовать инструмент LDAP для просмотра данных. Этот подход имеет преимущество не требует перезагрузки любого контроллера домена в каталоге восстановления служб режим (DSRM) для просмотра содержимого в резервной копии AD DS.

Дополнительные сведения об использовании средства подключения базы данных Active Directory см. в разделе [базы данных подключения средство Пошаговое руководство по Active Directory](https://technet.microsoft.com/library/cc753609\(WS.10\).aspx).

Можно также использовать **моментального снимка ntdsutil** команду, чтобы создавать моментальные снимки базы данных Active Directory. Запланировав задачу для периодического создания моментальных снимков, можно получить дополнительные копии базы данных Active Directory со временем. Эти копии позволяет точнее определить, когда произошел леса, а затем выберите лучший архив для восстановления. Чтобы создать моментальные снимки, используйте версию **ntdsutil** , поставляемый в комплекте с Windows Server 2008 или удаленного администрирования сервера средства (RSAT) для Windows Vista или более поздней версии. Целевой объект контроллера домена можно запустить любой версии Windows Server. Дополнительные сведения об использовании **моментального снимка ntdsutil** команды, см. в разделе [моментального снимка](https://technet.microsoft.com/library/cc731620\(WS.10\).aspx).

## <a name="determining-which-domain-controllers-to-restore"></a>Определение контроллеров домена для восстановления

Простота процесс восстановления является важным фактором при принятии решения о какой контроллер домена для восстановления. Рекомендуется — выделенный контроллер домена для каждого домена, основной контроллер домена для восстановления. Выделенный восстановления, которые DC облегчает надежно планированием и выполнением восстановления леса, так как используют ту же конфигурацию источника, который был использован для выполнения восстановления тестов. Можно создать сценарий восстановления и не конкурировать с различными конфигурациями, таких как ли контроллер домена являющегося хозяином операций или нет или ли он является сервером глобального Каталога или DNS или нет.

> [!NOTE]
> Хотя не рекомендуется восстановить владельца роли хозяина операций простоты, в некоторых организациях могут начать восстановление одного для других преимуществ. Например восстановление хозяином RID может помочь избежать проблем с управлением идентификаторы RID во время восстановления.  

Выберите контроллер домена, который наилучшим образом удовлетворяет следующим требованиям:

- Контроллер домена, который не защищен от записи. Это обязательно.

- Контроллер домена под управлением Windows Server 2012 как виртуальную машину на гипервизоре, поддерживающем ИД создания виртуальной Машины. Этот контроллер домена может использоваться в качестве источника для клонирования.
- Контроллер домена, который доступен, физически или в виртуальной сети и желательно, расположенных в центре обработки данных. Таким образом, вы сможете легко изолировать его от сети во время восстановления леса.
- Контроллер домена, который имеет хорошее полного резервного копирования сервера. Надежная резервная копия является резервной копией, могут быть восстановлены успешно, была сделана несколько дней до сбоя и содержит как можно более полезных данных.
- Контроллер домена, который был сервером доменных имен (DNS) до сбоя. Это экономит время, необходимое для переустановки DNS.
- При использовании служб развертывания Windows, выберите контроллер домена, который не настроен для использования сетевой разблокировки BitLocker. В этом случае сетевой разблокировки BitLocker не поддерживается для первого контроллера домена, восстановите из резервной копии во время восстановления леса.

   Сетевая разблокировка BitLocker как *только* предохранитель ключа *нельзя* использоваться на контроллерах домена с развернутым служб развертывания Windows (WDS), так как это, поэтому результаты в сценарии которых требует первого контроллера домена Active Directory и WDS работает для разблокировки. Но перед восстановлением первого контроллера домена Active Directory пока недоступна для служб развертывания Windows, поэтому его не удается разблокировать.

   Чтобы определить, если контроллер домена настроен для использования сетевой разблокировки BitLocker, проверьте, что сертификат сетевой разблокировки определяется в следующем разделе реестра:

   HKEY_LOCAL_MACHINESoftwarePoliciesMicrosoftSystemCertificatesFVE_NKP

Ведение процедур системы безопасности при обработке или восстановлении файлов резервных копий, которые включают Active Directory. Срочность, сопровождающий леса восстановления случайно может привести к пропуску рекомендации по обеспечению безопасности. Дополнительные сведения см. в разделе «Установка домена контроллера резервного копирования и восстановления стратегии» в [рекомендации по защите установок Active Directory и Day-to-Day операции: Часть II](https://technet.microsoft.com/library/bb727066.aspx).

## <a name="identify-the-current-forest-structure-and-dc-functions"></a>Определение текущей структуре леса и функции контроллера домена

Определите структуру текущего леса, определяя все домены в лесу. Создайте список всех контроллеров домена в каждом домене, особенно контроллеры доменов, которые имеют резервные копии и виртуализованных контроллеров домена, которые могут быть источником клонирования. Список контроллеров домена для корневого домена леса будет наиболее важным, поскольку вы сначала восстановите этот домен. После восстановления корневого домена леса, с помощью оснастки Active Directory можно получить список других доменов, контроллеры доменов и сайтов в лесу.

Подготовьте таблица, показывающая функции каждый контроллер домена в домене, как показано в следующем примере. Это поможет вам вернуться к конфигурации леса сбоя после восстановления.

|Имя контроллера домена|Операционная система|FSMO|сборка мусора|Контроллер домена только для чтения|Резервное копирование|DNS|Основные серверные компоненты|Виртуальная машина|GenID виртуальной Машины|  
|-------------|----------------------|----------|--------|----------|------------|---------|-----------------|--------|---------------|  
|DC_1|Windows Server 2012|Хозяин схемы, хозяин именования доменов|Да|Нет|Да|Нет|Нет|Да|Да|  
|DC_2|Windows Server 2012|Нет|Да|Нет|Да|Да|Нет|Да|Да|  
|DC_3|Windows Server 2012|Хозяин инфраструктуры|Нет|Нет|Нет|Да|Да|Да|Да|  
|DC_4|Windows Server 2012|Эмулятор основного контроллера домена, хозяине RID|Да|Нет|Нет|Нет|Нет|Да|Нет|  
|DC_5|Windows Server 2012|Нет|Нет|Нет|Да|Да|Нет|Да|Да|  
|RODC_1|Windows Server 2008 R2|Нет|Да|Да|Да|Да|Да|Да|Нет|  
|RODC_2|Windows Server 2008|Нет|Да|Да|Нет|Да|Да|Да|Нет|  

Для каждого домена в лесу определите один доступный для записи контроллер домена, имеющий доверенный резервную копию базы данных Active Directory для этого домена. Соблюдайте осторожность при выборе архив для восстановления контроллера домена. Если известны приблизительно день и причину сбоя, мы рекомендуем использование резервной копии, сделанной на несколько дней до наступления этой даты.
  
В этом примере существует четыре кандидата резервного копирования: DC_1, DC_2, DC_4 и DC_5. Из этих кандидатов резервного копирования восстановления только один. Рекомендуемые контроллер домена является DC_5 по следующим причинам:  

- Он удовлетворяет требованиям для применения в качестве источника для виртуализированных клонирование контроллера домена, является, он запускает Windows Server 2012, так как виртуальный контроллер домена на гипервизоре, поддерживающем ИД создания виртуальной Машины, выполняется программное обеспечение, которое может быть клонированный (или, можно удалить, если не может быть клона (г). После восстановления роль эмулятора основного контроллера домена будет быть получены, сервера и его могут добавляться в группу клонируемые контроллеры домена для домена.  
- Выполняется полная установка Windows Server 2012. Контроллер домена, работающий в конфигурации установки основных серверных компонентов может быть очень удобно в качестве целевого объекта для восстановления.  
- Это DNS-сервер. Таким образом DNS не нужно устанавливать еще раз.  

> [!NOTE]
> Поскольку DC_5 не является сервером глобального каталога, он также имеет преимущество в том, что глобального каталога необходимо удалить после завершения восстановления. Но ли контроллер домена является сервером глобального каталога не является определяющим фактором, поскольку начиная с Windows Server 2012, все контроллеры домена, серверы глобального каталога по умолчанию и удаление и добавление глобального каталога, после восстановления рекомендуется использовать в рамках леса в любом случае обработать восстановления.  

## <a name="recover-the-forest-in-isolation"></a>Восстановление леса в изоляции

Оптимальный сценарий —, завершить работу всех контроллеров домена для записи, перед первой восстановленный Контроллер переводится обратно в рабочую среду. Это гарантирует, что все опасные данные не реплицируются обратно в восстановленной леса. Это особенно важно завершить работу всех владельцев роли хозяина операций.  

> [!NOTE]
> Возможны ситуации, где перемещении первого контроллера домена, которые планируется восстановить для каждого домена в изолированной сети, при этом другие контроллеры домена могут оставаться в сети, чтобы свести к минимуму время простоя системы. Например при восстановлении после сбоя схемы обновления, вы можете сохранить контроллеры домена под управлением в рабочей сети, при выполнении действия по восстановлению в изоляции.

Если вы используете виртуализованных контроллеров домена, вы их можно переместить виртуальную сеть, которая изолирована от рабочей сети место выполнения восстановления. Перемещение виртуализованных контроллеров домена в отдельную сеть обеспечивает два преимущества:  

- Восстановленные контроллеры домена не смогут повторения неполадку, вызвавшую восстановление леса, так как они изолированы.  
- Клонирование виртуализированного контроллера домена можно выполняется в отдельной сети, поэтому ряд важных контроллеры домена могут работать под управлением и тестирование, прежде чем они переходят обратно к рабочей сети.

Если контроллеры домена работают под управлением на физическом оборудовании, отключите сетевой кабель первого контроллера домена, который будет восстановлена в корневом домене леса. Если это возможно также отключите сетевой кабель других контроллеров домена. Это предотвращает контроллеры домена репликации, если они случайно запускаются во время восстановления леса.  

В больших леса, которые распределяются по различным местоположениям может быть трудно гарантировать, что все контроллеры домена для записи завершают работу. По этой причине, действия по восстановлению, включая сброс учетной записи компьютера и учетной записи krbtgt, в дополнение к очистке метаданных — спроектировано таким образом, что восстановленные контроллеры домена для записи не реплицируются с опасными для записи контроллеров домена (если некоторые все еще работают в лес).  
  
Тем не менее только путем перевода для записи контроллеров домена в автономный режим вы гарантии, что репликация не возникает. Таким образом когда это возможно, следует развернуть на технологии удаленного управления, которые могут помочь завершать работу и физически изолировать для записи контроллеров домена во время восстановления леса.  
  
RODC можно продолжать работать, пока для записи контроллеры домена находятся в автономном режиме. Другие Контролеры будет непосредственно реплицировать любые изменения из любой RODC — особенно, схемы или конфигурации контейнера изменения не, поэтому они не настолько же риска, что для записи контроллеров домена во время восстановления. После восстановленной и online для записи контроллеров домена, следует перестроить все RODC.  
  
RODC будет разрешить доступ к локальным ресурсам, кэшируемых на своих сайтах во время операции восстановления выполняются в параллельном режиме. Локальные ресурсы, которые не кэшированы на RODC будет иметь запросы на проверку подлинности, перенаправляются для записи контроллера домена. Эти запросы завершатся сбоем, так как для записи контроллеры домена находятся в автономном режиме. Некоторые операции, такие как пароль изменения также не будут работать до восстановления для записи контроллеров домена.  
  
Если вы используете концентратор и спица сетевой архитектуры, вы можете сначала сосредоточиться на восстановление для записи контроллеров домена на сайтах центра. Позже то можно перестроить RODC в удаленных сайтах.  
  
## <a name="next-steps"></a>Следующие шаги

- [Восстановление леса AD — предварительные требования](AD-Forest-Recovery-Prerequisties.md)  
- [Восстановление леса AD — составить план восстановления пользовательских леса](AD-Forest-Recovery-Devising-a-Plan.md)  
- [Восстановление леса AD — определить проблему](AD-Forest-Recovery-Identify-the-Problem.md)
- [Восстановление леса AD — определить способ восстановления](AD-Forest-Recovery-Determine-how-to-Recover.md)
- [Восстановление леса AD - начального восстановления](AD-Forest-Recovery-Perform-initial-recovery.md)  
- [Восстановление леса AD - процедуры](AD-Forest-Recovery-Procedures.md)  
- [Восстановление леса AD — часто задаваемые вопросы](AD-Forest-Recovery-FAQ.md)  
- [Восстановление леса AD — восстановление одного домена в лесу Multidomain](AD-Forest-Recovery-Single-Domain-in-Multidomain-Recovery.md)  
- [Восстановление леса AD - восстановление леса с контроллерами домена Windows Server 2003](AD-Forest-Recovery-Windows-Server-2003.md)  
