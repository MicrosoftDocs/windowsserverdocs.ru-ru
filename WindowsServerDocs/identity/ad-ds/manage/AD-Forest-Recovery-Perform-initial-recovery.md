---
title: Восстановление леса AD — выполнение начального восстановления
ms.author: joflore
author: MicrosoftGuyJFlo
manager: mtillman
ms.date: 08/09/2018
ms.topic: article
ms.assetid: 5a291f65-794e-4fc3-996e-094c5845a383
ms.openlocfilehash: 62b90acb6d6ccdf266926ec32ca797a257f0798b
ms.sourcegitcommit: dfa48f77b751dbc34409aced628eb2f17c912f08
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/07/2020
ms.locfileid: "87969881"
---
# <a name="perform-initial-recovery"></a>Выполнить начальное восстановление

>Область применения: Windows Server 2016, Windows Server 2012 и 2012 R2, Windows Server 2008 и 2008 R2

В этом разделе содержатся следующие шаги:

- [Восстановление первого записываемого контроллера домена в каждом домене](#restore-the-first-writeable-domain-controller-in-each-domain)
- [Повторно подключите каждый восстановленный доступный для записи контроллер домена к сети](#reconnect-each-restored-writeable-domain-controller-to-a-common-network)
- [Добавление глобального каталога к контроллеру домена в корневом домене леса](#add-the-global-catalog-to-a-domain-controller-in-the-forest-root-domain)

## <a name="restore-the-first-writeable-domain-controller-in-each-domain"></a>Восстановление первого записываемого контроллера домена в каждом домене

Начиная с записываемого контроллера домена в корневом домене леса, выполните действия, описанные в этом разделе, чтобы восстановить первый контроллер домена. Корневой домен леса важен, так как он хранит администраторов схемы и группы администраторов предприятия. Он также помогает поддерживать иерархию доверия в лесу. Кроме того, корневой домен леса обычно содержит корневой DNS-сервер для пространства имен DNS леса. Таким образом, Active Directoryная зона DNS для этого домена содержит записи ресурсов псевдонима (CNAME) для всех остальных контроллеров домена в лесу (которые необходимы для репликации) и записи ресурсов DNS глобального каталога.

После восстановления корневого домена леса повторите те же действия, чтобы восстановить оставшиеся домены в лесу. Можно одновременно восстановить несколько доменов. Однако всегда восстанавливайте родительский домен перед восстановлением дочернего домена, чтобы предотвратить разрыв в иерархии доверия или разрешение DNS-имен.

Для каждого восстанавливаемого домена восстановите только один доступный для записи контроллер домена из резервной копии. Это самая важная часть восстановления, так как на контроллере домена должна быть база данных, на которую не повлияла проблема, вызванная сбоем леса. Важно иметь надежную резервную копию, которая тщательно тестируется, прежде чем она будет добавлена в рабочую среду.

Затем выполните следующие действия. Процедуры для выполнения определенных действий приведены в [процедурах восстановления в лесах Active Directory](AD-Forest-Recovery-Procedures.md).

1. Если планируется восстановление физического сервера, убедитесь, что сетевой кабель целевого контроллера домена не подключен и поэтому не подключен к рабочей сети. Для виртуальной машины можно удалить сетевой адаптер или использовать сетевой адаптер, подключенный к другой сети, где можно протестировать процесс восстановления, изолированный от рабочей сети.

2. Так как это первый доступный для записи контроллер домена в домене, необходимо выполнить неполномочное восстановление AD DS и полномочного восстановления SYSVOL. Операцию восстановления необходимо выполнить с помощью приложения резервного копирования и восстановления с учетом Active Directory, например cистема архивации данных Windows Server (то есть не следует восстанавливать контроллер домена с помощью неподдерживаемых методов, таких как восстановление моментального снимка виртуальной машины).
   - Полномочное восстановление SYSVOL необходимо, так как после восстановления после аварии должна быть запущена репликация реплицированной папки SYSVOL. Все последующие контроллеры домена, добавленные в домен, должны повторно синхронизировать свою папку SYSVOL с копией папки, выбранной для последующего доверия, прежде чем можно будет объявить эту папку.

   > [!CAUTION]
   > Выполнение полномочной (или основной) операции восстановления SYSVOL только для первого контроллера домена, который будет восстановлен в корневом домене леса. Неправильное выполнение основных операций восстановления SYSVOL на других контроллерах домена приводит к конфликтам репликации данных SYSVOL.

   - Существует два варианта выполнения неполномочного восстановления AD DS и полномочного восстановления SYSVOL:
   - Выполните полное восстановление сервера и выполните принудительную синхронизацию SYSVOL. Подробные инструкции см. [в разделе Выполнение полного восстановления сервера](AD-Forest-Recovery-Perform-a-Full-Recovery.md) и [выполнение полномочной синхронизации SYSVOL с репликацией DFSR](AD-Forest-Recovery-Authoritative-Recovery-SYSVOL.md).
   - Выполните полное восстановление сервера с последующим восстановлением состояния системы. При выборе этого варианта необходимо заранее создать резервные копии обоих типов: полное резервное копирование сервера и резервная копия состояния системы. Подробные инструкции см. [в разделе Выполнение полного восстановления сервера](AD-Forest-Recovery-Perform-a-Full-Recovery.md) и [выполнение неполномочного восстановления служб домен Active Directory](AD-Forest-Recovery-Nonauthoritative-Restore.md).

3. После восстановления и перезапуска контроллера домена, доступного для записи, убедитесь, что ошибка не повлияла на данные на контроллере домена. Если данные контроллера домена повреждены, повторите шаг 2 с другой резервной копией.
   - Если в восстановленном контроллере домена размещается роль хозяина операций, может потребоваться добавить следующую запись реестра, чтобы избежать AD DS недоступности до завершения репликации записываемого раздела каталога:

      **Хклм\систем\куррентконтролсет\сервицес\нтдс\параметерс\репл выполнять начальные синхронизации**

      Создайте запись с типом данных **REG_DWORD** и значением **0**. После восстановления леса можно сбросить значение этой записи равным **1**, что требует, чтобы контроллер домена, который перезагружается и содержит роли хозяина операций, успешно AD DS входящей и исходящей репликации с известными партнерами реплики, прежде чем объявить себя контроллером домена и начнет предоставлять службы клиентам. Дополнительные сведения о требованиях к начальной синхронизации см. в статье базы знаний [305476](https://support.microsoft.com/kb/305476).

      Переходите к следующим шагам только после восстановления и проверки данных и перед присоединением этого компьютера к рабочей сети.

4. Если вы подозреваете, что сбой в масштабе леса связан с вторжением в сеть или вредоносной атакой, сбросьте пароли учетной записи для всех учетных записей администраторов, включая членов групп "Администраторы предприятия", "Администраторы домена", "Администраторы схемы", "Операторы сервера", "Операторы учетных записей" и т. д. Сброс паролей административных учетных записей должен быть выполнен до установки дополнительных контроллеров домена на следующем этапе восстановления леса.
5. На первом восстановленном КОНТРОЛЛЕРе домена в корневом домене леса необходимо захватить все роли хозяина операций на уровне домена и леса. Для присвоения ролей хозяина операций на уровне леса требуются учетные данные администраторов предприятия и администраторов схемы.

     В каждом дочернем домене прихватите роли хозяина операций на уровне домена. Несмотря на то, что роли хозяина операций могут быть сохранены только на восстановленном контроллере домена, эти роли гарантируют, какой контроллер домена будет размещается на этом этапе в процессе восстановления леса. В рамках процесса, выполняемого после восстановления, можно по мере необходимости распространять роли хозяина операций. Дополнительные сведения о присвоении ролей хозяина операций см. в разделе [присвоение роли хозяина операций](AD-forest-recovery-seizing-operations-master-role.md). Рекомендации по месту размещения ролей хозяина операций см. в разделе [что такое хозяева операций?](/previous-versions/windows/it-pro/windows-server-2003/cc779716(v=ws.10)).

6. Очистите метаданные всех других доступных для записи контроллеров домена в корневом домене леса, которые не восстанавливаются из резервной копии (все доступные для записи контроллеры домена, за исключением первого контроллера домена). При использовании версии Active Directory пользователей и компьютеров или Active Directory сайтов и служб, которые входят в состав Windows Server 2008 или более поздней версии или RSAT для Windows Vista или более поздней версии, очистка метаданных выполняется автоматически при удалении объекта контроллера домена. Кроме того, объект сервера и объект компьютера для удаленного контроллера домена также удаляются автоматически. Дополнительные сведения см. в разделе [Очистка метаданных удаленных контроллеров домена, доступных для записи](AD-Forest-Recovery-Cleaning-Metadata.md).

     Очистка метаданных предотвращает возможное дублирование объектов NTDS Settings, если AD DS установлен на контроллере домена на другом сайте. Потенциально это также может сохранить процесс создания связей репликации, если сами контроллеры домена могут отсутствовать в процессе проверки согласованности знаний. Более того, в рамках очистки метаданных записи ресурсов DNS локатора контроллера домена для всех остальных контроллеров домена будут удалены из DNS.

     До тех пор пока метаданные всех других контроллеров домена не будут удалены, этот контроллер домена, если он был хозяином RID перед восстановлением, не будет считать роль хозяина RID и, таким образом, не сможет выдавать новые идентификаторы RID. Вы можете увидеть событие с ИДЕНТИФИКАТОРом 16650 в системном журнале в Просмотр событий указывающие на ошибку, но после очистки метаданных вы должны увидеть событие с ИДЕНТИФИКАТОРом 16648.

7. Если у вас есть зоны DNS, которые хранятся в AD DS, убедитесь, что на восстановленном контроллере домена установлена и запущена служба локального DNS-сервера. Если этот контроллер домена не является DNS-сервером до сбоя леса, необходимо установить и настроить DNS-сервер.

    > [!NOTE]
    > Если восстановленный контроллер домена работает под управлением Windows Server 2008, необходимо установить исправление в статье базы знаний [975654](https://support.microsoft.com/kb/975654) или временно подключить сервер к изолированной сети, чтобы установить DNS-сервер. Это исправление не требуется для других версий Windows Server.

     В корневом домене леса настройте восстановленный контроллер домена с собственным IP-адресом (или адресом замыкания на себя, например 127.0.0.1) в качестве предпочитаемого DNS-сервера. Этот параметр можно настроить в свойствах TCP/IP адаптера локальной сети (LAN). Это первый DNS-сервер в лесу. Дополнительные сведения см. [в разделе Настройка TCP/IP для использования DNS](/previous-versions/windows/it-pro/windows-server-2003/cc779716(v=ws.10)).

     В каждом дочернем домене настройте восстановленный контроллер домена с помощью IP-адреса первого DNS-сервера в корневом домене леса в качестве предпочитаемого DNS-сервера. Этот параметр можно настроить в свойствах TCP/IP адаптера локальной сети. Дополнительные сведения см. [в разделе Настройка TCP/IP для использования DNS](/previous-versions/windows/it-pro/windows-server-2003/cc779716(v=ws.10)).

     В доменных зонах _msdcs и DNS удалите записи NS контроллеров домена, которые больше не существуют после очистки метаданных. Проверьте, удалены ли SRV-записи очищенных контроллеров домена. Чтобы ускорить удаление записи SRV DNS, выполните:

    ```
    nltest.exe /dsderegdns:server.domain.tld
    ```

8. Увеличьте значение доступного пула RID на 100 000. Дополнительные сведения см. [в разделе повышение значения доступных ПУЛОВ RID](AD-Forest-Recovery-Raise-RID-Pool.md). Если есть основания полагать, что создание пула RID на 100 000 недостаточно для конкретной ситуации, следует определить наименьшее увеличение, которое еще можно использовать. Идентификаторы RID — это ограниченный ресурс, который не следует использовать.

     Если новые субъекты безопасности были созданы в домене после резервного копирования, используемого для восстановления, эти субъекты безопасности могут иметь права доступа к определенным объектам. Эти субъекты безопасности больше не существуют после восстановления, так как восстановление восстановлено до резервной копии. Однако их права доступа могут по-прежнему существовать. Если доступный пул RID не вызывается после восстановления, новые объекты пользователя, созданные после восстановления леса, могут получить идентичные идентификаторы безопасности (SID) и иметь доступ к этим объектам, которые изначально не предназначались.

     Для иллюстрации рассмотрим пример нового сотрудника с именем Amy, упомянутого во введении. Объект пользователя для Amy больше не существует после операции восстановления, так как он был создан после резервного копирования, использованного для восстановления домена. Однако все права доступа, назначенные этому объекту пользователя, могут сохраняться после операции восстановления. Если идентификатор безопасности для этого объекта пользователя переназначается новому объекту после операции восстановления, новый объект получает эти права доступа.

9. Делает недействительным текущий пул RID. Текущий пул RID становится недействительным после восстановления состояния системы. Но если восстановление состояния системы не выполнялось, текущий пул RID необходимо сделать недействительным, чтобы предотвратить повторное выдачу идентификаторов RID из пула RID, назначенного на момент создания резервной копии. Дополнительные сведения см. [в разделе аннулирование текущего пула RID](AD-Forest-Recovery-Invaildate-RID-Pool.md).

    > [!NOTE]
    > В первый раз при попытке создать объект с идентификатором безопасности после аннулирования пула RID возникнет ошибка. Попытка создать объект запускает запрос нового пула RID. Повторная попытка операции завершится с ошибкой, так как будет выделен новый пул RID.

10. Дважды сбросьте пароль учетной записи компьютера для этого контроллера домена. Дополнительные сведения см. [в разделе Сброс пароля учетной записи компьютера контроллера домена](AD-Forest-Recovery-Reset-Computer-Account-DC.md).

11. Дважды сбросьте пароль KRBTGT. Дополнительные сведения см. [в разделе Сброс пароля KRBTGT](AD-Forest-Recovery-Resetting-the-krbtgt-password.md).

     Поскольку журнал паролей KRBTGT состоит из двух паролей, необходимо дважды сбросить пароли, чтобы удалить из журнала паролей исходный пароль (неудачный).

    > [!NOTE]
    > Если восстановление леса в ответ на нарушение безопасности, можно также сбросить пароли доверия. Дополнительные сведения см. [в разделе Сброс пароля доверия с одной стороны доверия](AD-Forest-Recovery-Reset-Trust.md).

12. Если лес содержит несколько доменов и восстановленный контроллер домена был сервером глобального каталога до сбоя, снимите флажок **глобальный каталог** в свойствах NTDS Settings, чтобы удалить глобальный каталог из контроллера домена. Исключением из этого правила является общий случай использования леса только с одним доменом. В этом случае не требуется удалять глобальный каталог. Дополнительные сведения см. [в разделе Удаление глобального каталога](AD-Forest-Recovery-Remove-GC.md).

     Восстановление глобального каталога из резервной копии, которая более новая, чем другие резервные копии, используемые для восстановления контроллеров домена в других доменах, может привести к появлению устаревших объектов. Рассмотрим следующий пример. В домене A DC1 восстанавливается из резервной копии, полученной во время T1. В домене B, DC2 восстанавливается из резервной копии глобального каталога, которая была создана во время T2. Предположим, что T2 является более новым, чем T1, и некоторые объекты были созданы между T1 и T2. После восстановления этих контроллеров, DC2, который является глобальным каталогом, содержит более новые данные для частичной реплики домена A, чем сам домен A. DC2, в данном случае, хранит устаревшие объекты, так как эти объекты отсутствуют на компьютере DC1.

     Наличие устаревших объектов может привести к проблемам. Например, сообщения электронной почты могут не доставляться пользователю, чей объект-пользователь перемещен между доменами. После перевода устаревшего контроллера домена или сервера глобального каталога в режим «в сети» оба экземпляра объекта пользователя отображаются в глобальном каталоге. Оба объекта имеют одинаковый адрес электронной почты; Поэтому доставка сообщений электронной почты невозможна.

     Вторая проблема заключается в том, что учетная запись пользователя, которая больше не существует, может по-прежнему отображаться в глобальном списке адресов. Третья проблема заключается в том, что универсальная группа, которая больше не существует, может по-прежнему отображаться в маркере доступа пользователя.

     Если вы восстановите контроллер домена, который был глобальным каталогом (случайно или из-за того, что вы доверяете одиночные резервной копии), мы рекомендуем запретить возникновение всех устаревших объектов, отключив глобальный каталог вскоре после завершения операции восстановления. Отключение флага глобального каталога приведет к тому, что компьютер будет потеряет все его частичные реплики (секции) и релегатинг себя к обычному состоянию контроллера домена.

13. Настройка службы времени Windows. В корневом домене леса Настройте эмулятор основного контроллера домена для синхронизации времени из внешнего источника времени. Дополнительные сведения см. в статье [Настройка службы времени Windows в эмуляторе основного контроллера домена в корневом домене леса](/previous-versions/windows/it-pro/windows-server-2008-r2-and-2008/cc731191%28v=ws.10%29).

## <a name="reconnect-each-restored-writeable-domain-controller-to-a-common-network"></a>Повторно подключите каждый восстановленный доступный для записи контроллер домена к общей сети

На этом этапе необходимо восстановить один контроллер домена (и выполнить шаги по восстановлению) в корневом домене леса и в каждом из оставшихся доменов. Присоедините эти контроллеры домена к общей сети, изолированной от остальной части среды, и выполните следующие действия, чтобы проверить работоспособность и репликацию леса.

> [!NOTE]
> При присоединении физических контроллеров домена к изолированной сети может потребоваться изменить их IP-адреса. В результате IP-адреса записей DNS будут неправильными. Поскольку сервер глобального каталога недоступен, безопасные динамические обновления для DNS завершатся ошибкой. В этом случае виртуальные контроллеры домена являются более выгодными, так как они могут быть присоединены к новой виртуальной сети без изменения их IP-адресов. Это одна из причин, по которой виртуальные контроллеры домена рекомендуется восстанавливать в процессе восстановления леса.

После проверки подключите контроллеры домена к рабочей сети и выполните действия, чтобы проверить работоспособность репликации леса.

- Чтобы устранить разрешение имен, создайте записи делегирования DNS и настройте пересылку DNS и корневые ссылки по мере необходимости. Выполните **команду repadmin/реплсум** , чтобы проверить репликацию между контроллерами домена.
- Если восстановленные контроллеры домена не являются прямыми партнерами по репликации, восстановление репликации будет выполняться гораздо быстрее, создавая временные объекты соединения между ними.
- Для проверки очистки метаданных выполните **команду repadmin/виевлист \\ ***, чтобы получить список всех контроллеров домена в лесу. Выполните команду **nltest/дклист:** *<\> domain* , чтобы получить список всех контроллеров домена в домене.
- Чтобы проверить работоспособность контроллера домена и DNS, запустите DCDiag/v, чтобы сообщить об ошибках на всех контроллерах домена в лесу.

## <a name="add-the-global-catalog-to-a-domain-controller-in-the-forest-root-domain"></a>Добавление глобального каталога к контроллеру домена в корневом домене леса

Глобальный каталог требуется по следующим причинам.

- Включение входа для пользователей.
- Включение службы сетевого входа в систему, работающей на контроллерах домена в каждом дочернем домене, для регистрации и удаления записей на DNS-сервере в корневом домене.

Хотя предпочтительнее, что корневой контроллер домена леса становится глобальным каталогом, можно выбрать любой из восстановленных контроллеров, чтобы стать глобальным каталогом.

> [!NOTE]
> Контроллер домена не будет объявлен как сервер глобального каталога, пока не завершит полную синхронизацию всех разделов каталога в лесу. Поэтому контроллеру домена следует принудительно выполнить репликацию с каждым из восстановленных контроллеров домена в лесу.
>
> Отслеживайте журнал событий службы каталогов в Просмотр событий для события с ИДЕНТИФИКАТОРом 1119, которое указывает на то, что этот контроллер домена является сервером глобального каталога, или убедитесь, что следующий раздел реестра имеет значение 1:
>
> **Повышение уровня каталога Хклм\систем\куррентконтролсет\сервицес\нтдс\параметерс\глобал завершено**

Дополнительные сведения см. [в разделе Добавление глобального каталога](AD-Forest-Recovery-Add-GC.md).

На этом этапе у вас должен быть стабильный лес с одним КОНТРОЛЛЕРом домена для каждого домена и одним глобальным каталогом в лесу. Необходимо создать новую резервную копию каждого из контроллеров домена, которые были только что восстановлены. Теперь можно приступить к повторному развертыванию других контроллеров домена в лесу, установив AD DS.

## <a name="next-steps"></a>Next Steps

- [Восстановление леса AD — необходимые условия](AD-Forest-Recovery-Prerequisties.md)
- [Восстановление леса AD — Девисинг план восстановления пользовательского леса](AD-Forest-Recovery-Devising-a-Plan.md)
- [Восстановление леса AD. обнаружение проблемы](AD-Forest-Recovery-Identify-the-Problem.md)
- [Восстановление леса AD. Определение способа восстановления](AD-Forest-Recovery-Determine-how-to-Recover.md)
- [Восстановление леса AD — выполнение начального восстановления](AD-Forest-Recovery-Perform-initial-recovery.md)
- [Восстановление леса AD — процедуры](AD-Forest-Recovery-Procedures.md)
- [Восстановление леса AD — часто задаваемые вопросы](AD-Forest-Recovery-FAQ.md)
- [Восстановление леса Active Directory. Восстановление одного домена в лесу с несколькими доменами](AD-Forest-Recovery-Single-Domain-in-Multidomain-Recovery.md)
- [Восстановление леса Active Directory — восстановление леса с контроллерами домена Windows Server 2003](AD-Forest-Recovery-Windows-Server-2003.md)
