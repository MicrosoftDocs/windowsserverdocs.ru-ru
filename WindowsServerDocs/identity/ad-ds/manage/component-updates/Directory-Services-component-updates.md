---
ms.assetid: 8a3cf2ae-2511-4eea-afd5-a43179a78613
title: Обновления компонентов служб каталогов
description: ''
author: MicrosoftGuyJFlo
ms.author: joflore
manager: mtillman
ms.date: 05/31/2017
ms.topic: article
ms.prod: windows-server
ms.technology: identity-adds
ms.openlocfilehash: d79f31572bc30d0f4fa3af45671c58b799e40f02
ms.sourcegitcommit: 6aff3d88ff22ea141a6ea6572a5ad8dd6321f199
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/27/2019
ms.locfileid: "71390020"
---
# <a name="directory-services-component-updates"></a>Обновления компонентов служб каталогов

>Область применения. Windows Server 2016, Windows Server 2012 R2, Windows Server 2012

**Автор**: Джастин Тернер, старший инженер по расширению поддержки с группой Windows  
  
> [!NOTE]  
> Этот материал создан инженером службы поддержки клиентов Майкрософт и предназначен для опытных администраторов и архитекторов систем, которым нужны более глубокие технические сведения о функциях и решениях в Windows Server 2012 R2, а не обычная информация, доступная в статьях на сайте TechNet. Однако он не был отредактирован согласно требованиям сайта, поэтому некоторые формулировки могут быть не такими выверенными, как на станицах TechNet.  
  
На этом занятии объясняются обновления компонентов служб каталогов в Windows Server 2012 R2.  
  
## <a name="what-you-will-learn"></a>Тема обучения  
Объясните следующие новые обновления компонентов служб каталогов:  
  
-   Объясните следующие новые обновления компонентов служб каталогов:  
  
    -   [Режимы работы домена и леса](../../../ad-ds/manage/component-updates/Directory-Services-component-updates.md#BKMK_FL)  
  
    -   [Устаревание NTFRS](../../../ad-ds/manage/component-updates/Directory-Services-component-updates.md#BKMK_NTFRS)  
  
    -   [Изменения в оптимизаторе запросов LDAP](../../../ad-ds/manage/component-updates/Directory-Services-component-updates.md#BKMK_LDAPQuery)  
  
    -   [Улучшения, связанные с событием 1644](../../../ad-ds/manage/component-updates/Directory-Services-component-updates.md#BKMK_1644)  
  
    -   [Повышение пропускной способности репликации Active Directory](../../../ad-ds/manage/component-updates/Directory-Services-component-updates.md#BKMK_ADRepl)  
  
## <a name="BKMK_FL"></a>Режимы работы домена и леса  
  
### <a name="overview"></a>Обзор  
В этом разделе приведены краткие сведения об изменениях в функциональном уровне домена и леса.  
  
### <a name="new-dfl-and-ffl"></a>Новые ДФЛ и FFL  
В выпуске имеются новые режимы работы домена и леса:  
  
-   Режим работы леса: Windows Server 2012 R2  
  
-   Функциональный уровень домена: Windows Server 2012 R2  
  
### <a name="the-windows-server-2012-r2-domain-functional-level-enables-support-for-the-following"></a>Режим работы домена Windows Server 2012 R2 обеспечивает поддержку следующих возможностей:  
  
1.  Защита на стороне контроллера домена для *защищенных пользователей*  
  
    *Защищенные пользователи* , выполняющие проверку подлинности в домене Windows Server 2012 R2, **больше не**могут:  
  
    -   Аутентификация с помощью проверки подлинности NTLM  
  
    -   Использование наборов шифров DES или RC4 в предварительной проверке подлинности Kerberos  
  
    -   Делегировано с неограниченным или ограниченным делегированием  
  
    -   Продлите пользовательские билеты (TGT) за период времени жизни в 4 часа  
  
2.  Политики проверки подлинности  
  
    Новые политики Active Directory на основе леса, которые можно применять к учетным записям в доменах Windows Server 2012 R2, чтобы контролировать, на каких узлах может входить учетная запись, и применять условия управления доступом для проверки подлинности служб, работающих в качестве учетной записи.  
  
3.  Приемники команд политик проверки подлинности  
  
    Новый объект Active Directory на основе леса, который может создать связь между пользователем, управляемой службой и учетными записями компьютеров, которые будут использоваться для классификации учетных записей для политик проверки подлинности или изоляции проверки подлинности.  
  
Дополнительные сведения см. в разделе Настройка защищенных учетных записей.  
  
Помимо описанных выше функций, режим работы домена Windows Server 2012 R2 гарантирует, что любой контроллер домена в домене будет работать под управлением Windows Server 2012 R2.  
Функциональный уровень леса Windows Server 2012 R2 не предоставляет новых возможностей, но гарантирует, что любой новый домен, созданный в лесу, будет автоматически работать на функциональном уровне домена Windows Server 2012 R2.  
  
### <a name="minimum-dfl-enforced-on-new-domain-creation"></a>Минимальный ДФЛ принудительно применен при создании нового домена  
Windows Server 2008 ДФЛ — это минимальный функциональный уровень, поддерживаемый при создании нового домена.  
  
> [!NOTE]  
> Прекращение работы службы FRS достигается путем удаления возможности установить новый домен с функциональным уровнем домена ниже Windows Server 2008 с диспетчер сервера или с помощью Windows PowerShell.  
  
### <a name="lowering-the-forest-and-domain-functional-levels"></a>Понижение функциональных уровней леса и домена  
Режим работы леса и домена по умолчанию установлен на Windows Server 2012 R2 в новом домене и новом лесу, но может быть сокращен с помощью Windows PowerShell.  
  
Чтобы повысить или уменьшить режим работы леса с помощью Windows PowerShell, используйте командлет **Set-адфорестмоде** .  
  
**Чтобы установить режим contoso.com FFL в Windows Server 2008, выполните следующие действия.**  
  
```sql  
Set-ADForestMode -ForestMode Windows2008Forest -Identity contoso.com  
```  
  
Чтобы повысить или уменьшить режим работы домена с помощью Windows PowerShell, используйте командлет Set-Аддомаинмоде.  
  
**Чтобы установить режим contoso.com ДФЛ в Windows Server 2008, выполните следующие действия.**  
  
```powershell  
Set-ADDomainMode -DomainMode Windows2008Domain -Identity contoso.com  
```  
  
Повышение роли контроллера домена, работающего под Windows Server 2012 R2, в качестве дополнительной реплики в существующем домене, на котором работает 2003 ДФЛ.  
  
Создание нового домена в существующем лесу  
  
![обновления служб каталогов](media/Directory-Services-component-updates/GTR_ADDS_FFL.gif)  
  
### <a name="adprep"></a>ADPREP  
В этом выпуске нет новых операций леса или домена.  
  
Эти LDF файлы содержат изменения схемы для **службы регистрации устройств**.  
  
1.  Sch59  
  
2.  Sch61  
  
3.  Sch62  
  
4.  Sch63  
  
5.  Sch64  
  
6.  Sch65  
  
7.  Sch67  
  
**Рабочие папки:**  
  
1.  Sch66  
  
**MSODS**  
  
1.  Sch60  
  
**Политики аутентификации и приемники команд**  
  
1.  Sch68  
  
2.  Sch69  
  
## <a name="BKMK_NTFRS"></a>Устаревшая версия NTFRS  
  
### <a name="overview"></a>Обзор  
Служба FRS не является устаревшей в Windows Server 2012 R2.  Прекращение использования FRS достигается путем применения минимального режима работы домена (ДФЛ) Windows Server 2008.  Эта Принудительная защита доступна только в том случае, если новый домен создается с помощью диспетчер сервера или Windows PowerShell.  
  
Используйте параметр-Домаинмоде с командлетами Install-Аддсфорест или Install-Аддсдомаин, чтобы указать режим работы домена.  Поддерживаемые значения для этого параметра могут быть допустимым целым числом или соответствующим перечислимым строковым значением. Например, чтобы установить уровень режима домена Windows Server 2008 R2, можно указать значение 4 или "Win2008R2".  При выполнении этих командлетов с сервера 2012 R2 допустимые значения включают в себя параметры для Windows Server 2008 (3, Win2008) Windows Server 2008 R2 (4, Win2008R2) Windows Server 2012 (5, Win2012) и Windows Server 2012 R2 (6, Win2012R2). Режим работы домена не может быть ниже режима работы леса, но может быть выше него.  Поскольку служба FRS не является устаревшей в этом выпуске, Windows Server 2003 (2, Win2003) не является распознаваемым параметром с этими командлетами при выполнении из Windows Server 2012 R2.  
  
![обновления служб каталогов](media/Directory-Services-component-updates/GTR_ADDS_PS_Install2003DFL.gif)  
  
![обновления служб каталогов](media/Directory-Services-component-updates/GTR_ADDS_PS_InstallDFL2.gif)  
  
## <a name="BKMK_LDAPQuery"></a>Изменения оптимизатора запросов LDAP  
  
### <a name="overview"></a>Обзор  
Алгоритм оптимизатора запросов LDAP был повторно вычислен и оптимизирован.  Результатом является повышение производительности при поиске LDAP и время поиска LDAP сложных запросов.  
  
> [!NOTE]
> <strong>От разработчика:</strong>улучшена производительность поиска с помощью улучшений в сопоставлении запросов LDAP с ESE.  Фильтры LDAP за пределами определенного уровня сложности предотвращают выбор оптимизированного индекса, что приводит к значительному снижению производительности (вы можете обрабатывать или более). Это изменение изменяет способ выбора индексов для запросов LDAP, чтобы избежать этой проблемы.  
> 
> [!NOTE]
> Полное реконструкции алгоритма оптимизатора запросов LDAP, в результате чего:  
> 
> -   Увеличение времени поиска  
> -   Преимущества повышения эффективности позволяют контроллерам домена делать больше  
> -   Меньше вызовов поддержки, касающихся проблем с производительностью AD  
> -   Переход на Windows Server 2008 R2 (KB 2862304)  
  
### <a name="background"></a>Фон  
Возможность поиска Active Directory является основной службой, предоставляемой контроллерами домена.  Другие службы и бизнес-приложения полагаются на Active Directory Поиск.  Если эта функция недоступна, выполнение бизнес-операций может прекратиться до остановки.  Как основная и интенсивно используемая служба, необходимо, чтобы контроллеры домена эффективно обрабатывали трафик поиска LDAP.  Алгоритм оптимизатора запросов LDAP пытается эффективно выполнять поиск LDAP с помощью сопоставления фильтров поиска LDAP с результирующим набором, который может быть удовлетворен с помощью записей, уже индексированных в базе данных.  Этот алгоритм был повторно вычислен и оптимизирован.  Результатом является повышение производительности при поиске LDAP и время поиска LDAP сложных запросов.  
  
### <a name="details-of-change"></a>Сведения об изменении  
Поиск LDAP содержит:  
  
-   Расположение (заголовок NC, подразделение, объект) в иерархии для начала поиска  
  
-   Фильтр поиска  
  
-   Список возвращаемых атрибутов  
  
Процесс поиска можно суммировать следующим образом:  
  
1.  Упростите фильтр поиска, если это возможно.  
  
2.  Выберите набор ключей индекса, которые будут возвращать наименьший охватываемый набор.  
  
3.  Выполните одну или несколько пересечения ключей индекса, чтобы уменьшить охваченный набор.  
  
4.  Для каждой записи в охваченном наборе следует оценить критерии фильтра, а также безопасность. Если фильтр имеет значение TRUE и доступ предоставлен, то верните эту запись клиенту.  
  
Процедура оптимизации запросов LDAP изменяет шаги 2 и 3, чтобы уменьшить размер охваченного набора. В частности, текущая реализация выбирает повторяющиеся ключи индекса и выполняет избыточные пересечения.  
  
### <a name="comparison-between-old-and-new-algorithm"></a>Сравнение старого и нового алгоритма  
Целью неэффективного поиска LDAP в этом примере является контроллер домена Windows Server 2012.  Поиск завершается примерно за 44 секунд в результате неудачного поиска более эффективного индекса.  
  
```  
adfind -b dc=blue,dc=contoso,dc=com -f "(| (& (|(cn=justintu) (postalcode=80304) (userprincipalname=justintu@blue.contoso.com)) (|(objectclass=person) (cn=justintu)) ) (&(cn=justintu)(objectclass=person)))" -stats >>adfind.txt  
  
Using server: WINSRV-DC1.blue.contoso.com:389  
  
<removed search results>  
  
Statistics  
=====  
Elapsed Time: 44640 (ms)  
Returned 324 entries of 553896 visited - (0.06%)  
  
Used Filter:  
 ( |  ( &  ( |  (cn=justintu)  (postalCode=80304)  (userPrincipalName=justintu@blue.contoso.com) )  ( |  (objectClass=person)  (cn=justintu) ) )  ( &  (cn=justintu)  (objectClass=person) ) )   
  
Used Indices:  
 DNT_index:516615:N  
  
Pages Referenced          : 4619650  
Pages Read From Disk      : 973  
Pages Pre-read From Disk  : 180898  
Pages Dirtied             : 0  
Pages Re-Dirtied          : 0  
Log Records Generated     : 0  
Log Record Bytes Generated: 0  
```  
  
### <a name="sample-results-using-the-new-algorithm"></a>Примеры результатов с использованием нового алгоритма  
В этом примере повторяется тот же поиск, который указан выше, но нацелен на контроллер домена Windows Server 2012 R2.  Тот же поиск завершается менее чем через секунду из-за улучшений в алгоритме оптимизатора запросов LDAP.  
  
```  
adfind -b dc=blue,dc=contoso,dc=com -f "(| (& (|(cn=justintu) (postalcode=80304) (userprincipalname=dhunt@blue.contoso.com)) (|(objectclass=person) (cn=justintu)) ) (&(cn=justintu)(objectclass=person)))" -stats >>adfindBLUE.txt  
  
Using server: winblueDC1.blue.contoso.com:389  
  
.<removed search results>  
  
Statistics  
=====  
Elapsed Time: 672 (ms)  
Returned 324 entries of 648 visited - (50.00%)  
  
Used Filter:  
 ( |  ( &  ( |  (cn=justintu)  (postalCode=80304)  (userPrincipalName=justintu@blue.contoso.com) )  ( |  (objectClass=person)  (cn=justintu) ) )  ( &  (cn=justintu)  (objectClass=person) ) )   
  
Used Indices:  
 idx_userPrincipalName:648:N  
 idx_postalCode:323:N  
 idx_cn:1:N  
  
Pages Referenced          : 15350  
Pages Read From Disk      : 176  
Pages Pre-read From Disk  : 2  
Pages Dirtied             : 0  
Pages Re-Dirtied          : 0  
Log Records Generated     : 0  
Log Record Bytes Generated: 0  
```  
  
-   Если не удается оптимизировать дерево:  
  
    -   Например: выражение в дереве находится в неиндексированном столбце  
  
    -   Запись списка индексов, которые препятствуют оптимизации  
  
    -   Предоставляется через трассировку ETW и событие с ИДЕНТИФИКАТОРом 1644  
  
        ![обновления служб каталогов](media/Directory-Services-component-updates/GTR_ADDS_Event1644.gif)  
  
### <a name="BKMK_EnableStats"></a>Включение контроля статистики в LDP  
  
1.  Откройте LDP. exe и подключитесь к контроллеру домена и привяжите его к нему.  
  
2.  В меню **Параметры** выберите пункт **элементы управления**.  
  
3.  В диалоговом окне элементы управления разверните **предопределенное** раскрывающееся меню Загрузка, выберите пункт **Поиск статистики** , а затем нажмите кнопку **ОК**.  
  
    ![обновления служб каталогов](media/Directory-Services-component-updates/GTR_ADDS_Controls.gif)  
  
4.  В меню **Обзор** выберите пункт **Поиск** .  
  
5.  В диалоговом окне Поиск нажмите кнопку **Параметры** .  
  
6.  Убедитесь, что в диалоговом окне Параметры поиска установлен флажок **Расширенный** , и нажмите кнопку **ОК**.  
  
    ![обновления служб каталогов](media/Directory-Services-component-updates/GTR_ADDS_SearchOptions.gif)  
  
### <a name="try-this-use-ldp-to-return-query-statistics"></a>Попробуйте следующее: Использование LDP для возврата статистики запросов  
Выполните следующие действия на контроллере домена или в присоединенном к домену клиенте или сервере с установленными инструментами AD DS.  Повторите следующие действия, предназначенные для контроллера домена Windows Server 2012 и контроллера домена Windows Server 2012 R2.  
  
1.  Просмотрите статью [«Создание более эффективных приложений с поддержкой Microsoft Active Directory»](https://msdn.microsoft.com/library/ms808539.aspx) и вернитесь к ней по мере необходимости.  
  
2.  С помощью LDP включите статистику поиска (см. раздел [Включение контроля статистики в LDP](../../../ad-ds/manage/component-updates/../../../ad-ds/manage/component-updates/../../../ad-ds/manage/component-updates/../../../ad-ds/manage/component-updates/../../../ad-ds/manage/component-updates/../../../ad-ds/manage/component-updates/Directory-Services-component-updates.md#BKMK_EnableStats)).  
  
3.  Выполните несколько поисков LDAP и просмотрите статистические данные в верхней части результатов.  Вы повторяйте тот же поиск в других действиях, чтобы задокументировать их в текстовом файле блокнота.  
  
4.  Выполнение поиска LDAP, который оптимизатор запросов должен иметь возможность оптимизировать из-за индексов атрибутов  
  
5.  Попытка создать поиск, который занимает много времени (возможно, потребуется увеличить **предельное время** , чтобы поиск не выполнялся в течение времени ожидания).  
  
### <a name="additional-resources"></a>Дополнительные ресурсы  
[Что такое Active Directory Поиск?](https://technet.microsoft.com/library/cc783845(v=ws.10).aspx)  
  
[Как работает поиск Active Directory](https://technet.microsoft.com/library/cc755809(v=WS.10).aspx)  
  
[Создание более эффективных приложений с поддержкой Active Directory Майкрософт](https://msdn.microsoft.com/library/ms808539.aspx)  
  
[951581](https://support.microsoft.com/kb/951581) . запросы LDAP выполняются медленнее, чем ожидалось в службе каталогов AD или LDS, и регистрируется событие с идентификатором 1644.  
  
## <a name="BKMK_1644"></a>усовершенствования событий 1644  
  
### <a name="overview"></a>Обзор  
Это обновление добавляет дополнительную статистику результатов поиска LDAP к событию с ИДЕНТИФИКАТОРом 1644, чтобы помочь в устранении неполадок.  Кроме того, имеется новое значение реестра, которое можно использовать для включения ведения журнала в пороговое значение на основе времени.  Эти улучшения стали доступны в Windows Server 2012 и Windows Server 2008 R2 с пакетом обновления 1 (SP1) через KB [2800945](https://support.microsoft.com/kb/2800945) и будут доступны для Windows Server 2008 с пакетом обновления 2 (SP2).  
  
> [!NOTE]  
> -   Дополнительная статистика поиска LDAP добавляется в событие с ИДЕНТИФИКАТОРом 1644, чтобы помочь в устранении неэффективного или дорогостоящего поиска LDAP.  
> -   Теперь можно указать пороговое значение времени поиска (например, Событие журнала 1644 для поисков, требующих больше 100 мс), вместо указания дорогостоящих и неэффективных пороговых значений результатов поиска  
  
### <a name="background"></a>Фон  
При устранении неполадок, связанных с производительностью Active Directory, очевидно, что операция поиска LDAP может стать причиной проблемы.  Вы решили включить ведение журнала, чтобы видеть дорогостоящие или неэффективные запросы LDAP, обрабатываемые контроллером домена.  Чтобы включить ведение журнала, необходимо задать значение поля "диагностическая диагностика" и при необходимости указать пороговые или неэффективные значения для результатов поиска.  При включении уровня ведения журнала для полей со значением 5 любой поиск, соответствующий этим критериям, записывается в журнал событий служб каталогов с событием с ИДЕНТИФИКАТОРом 1644.  
  
Событие содержит:  
  
-   IP-адрес и порт клиента  
  
-   Начальный узел  
  
-   Filter  
  
-   Область поиска  
  
-   Выбор атрибута  
  
-   Серверные элементы управления  
  
-   Просмотренные записи  
  
-   Возвращенные записи  
  
Однако в событии отсутствуют ключевые данные, например время, затраченное на операцию поиска и использованный индекс (если таковой имеется).  
  
#### <a name="additional-search-statistics-added-to-event-1644"></a>Дополнительная статистика поиска, добавленная в событие 1644  
  
-   Использованные индексы  
  
-   Страницы, на которые имеются ссылки  
  
-   Страницы, считанные с диска  
  
-   Страницы, считанные с диска  
  
-   Очистка страниц изменена  
  
-   Изменено "грязных" страниц  
  
-   Время поиска  
  
-   Атрибуты, препятствующие оптимизации  
  
#### <a name="new-time-based-threshold-registry-value-for-event-1644-logging"></a>Новое значение порогового значения реестра на основе времени для ведения журнала событий 1644  
Вместо того чтобы задавать дорогостоящие и неэффективные пороговые значения результатов поиска, можно указать пороговое значение времени поиска.  Если нужно заносить в журнал все результаты поиска, которые заняли 50 мс или более поздней версии, следует указать 50 десятичное/32 шестнадцатеричное число (в дополнение к настройке поля для проектирования).  
  
```  
Windows Registry Editor Version 5.00  
[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\NTDS\Parameters]  
"Search Time Threshold (msecs)"=dword:00000032  
```  
  
#### <a name="comparison-of-the-old-and-new-event-id-1644"></a>Сравнение старого и нового событий с ИДЕНТИФИКАТОРом 1644  
ИСХОДНОГО  
  
![обновления служб каталогов](media/Directory-Services-component-updates/GTR_ADDS_Event1644_2012.gif)  
  
НОВИНКА  
  
![обновления служб каталогов](media/Directory-Services-component-updates/GTR_ADDS_Event1644_2012R2.gif)  
  
#### <a name="try-this-use-the-event-log-to-return-query-statistics"></a>Попробуйте следующее: Использование журнала событий для возврата статистики запросов  
  
1.  Повторите следующие действия, предназначенные для контроллера домена Windows Server 2012 и контроллера домена Windows Server 2012 R2. Обратите внимание на событие с ИДЕНТИФИКАТОРом 1644s на обоих контроллерах домена после каждого поиска.  
  
2.  С помощью Regedit включите ведение журнала событий 1644, используя пороговое значение на основе времени для контроллера домена Windows Server 2012 R2 и старый метод на контроллере домена Windows Server 2012.  
  
3.  Выполните несколько поисков LDAP, превышающих пороговое значение, и просмотрите статистические данные в верхней части результатов.  Используйте приведенные выше запросы LDAP и повторите те же самые операции поиска.  
  
4.  Выполните поиск LDAP, который оптимизатор запросов не сможет оптимизировать, так как один или несколько атрибутов не индексируются.  
  
## <a name="BKMK_ADRepl"></a>Повышение пропускной способности репликации Active Directory  
  
### <a name="overview"></a>Обзор  
Репликация Active Directory использует RPC для транспорта репликации. По умолчанию RPC использует буфер передачи 8 КБ и размер пакета 5 КБ. Это оказывает чистого влияния на то, что отправляющий экземпляр передает три пакета (приблизительно 15 000 данных), а затем приходится ждать приема сетевого пути перед отправкой. Учитывая время 3 мсного обмена данными, самая высокая пропускная способность составит около 40Mbps, даже для сетей с 1Gbps или 10 Гбит/с.  
  
> [!NOTE]  
> -   Это обновление корректирует максимальную пропускную способность репликации Active Directory с 40Mbps до 600 Мбит/с.  
>   
>     -   Он увеличивает размер буфера отправки RPC, что сокращает число полных круговых путей.  
> -   Этот результат будет наиболее заметным в высокоскоростной сети с высоким уровнем задержки.  
  
Это обновление увеличивает максимальную пропускную способность до 600 Мбит/с, изменяя размер буфера отправки RPC с 8 КБ на 256 КБ.  Это изменение позволяет увеличить размер окна TCP за пределами 8 КБ, уменьшая количество круговых путей в сети.  
  
> [!NOTE]  
> Нет настраиваемых параметров для изменения этого поведения.  
  
### <a name="additional-resources"></a>Дополнительные ресурсы  
[Как работает модель репликации Active Directory](https://technet.microsoft.com/library/cc772726(v=WS.10).aspx)  
  


