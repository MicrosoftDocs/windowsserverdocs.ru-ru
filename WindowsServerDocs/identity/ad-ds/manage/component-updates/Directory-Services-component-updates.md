---
ms.assetid: 8a3cf2ae-2511-4eea-afd5-a43179a78613
title: Обновления компонентов служб каталогов
description: ''
author: MicrosoftGuyJFlo
ms.author: joflore
manager: mtillman
ms.date: 05/31/2017
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: identity-adds
ms.openlocfilehash: fe27b61abe196a2148ced18806be904ebd555fcc
ms.sourcegitcommit: eaf071249b6eb6b1a758b38579a2d87710abfb54
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/31/2019
ms.locfileid: "66442891"
---
# <a name="directory-services-component-updates"></a>Обновления компонентов служб каталогов

>Область применения. Windows Server 2016, Windows Server 2012 R2, Windows Server 2012

**Автор**: Джастин Тернер, старший инженер по улучшению поддержки с группой Windows  
  
> [!NOTE]  
> Этот материал создан инженером службы поддержки клиентов Майкрософт и предназначен для опытных администраторов и архитекторов систем, которым нужны более глубокие технические сведения о функциях и решениях в Windows Server 2012 R2, а не обычная информация, доступная в статьях на сайте TechNet. Однако он не был отредактирован согласно требованиям сайта, поэтому некоторые формулировки могут быть не такими выверенными, как на станицах TechNet.  
  
Данном занятии объясняется обновления компонентов служб каталогов в Windows Server 2012 R2.  
  
## <a name="what-you-will-learn"></a>Тема обучения  
Описаны следующие новые обновления компонентов служб каталогов:  
  
-   Описаны следующие новые обновления компонентов служб каталогов:  
  
    -   [Режимы работы домена и леса](../../../ad-ds/manage/component-updates/Directory-Services-component-updates.md#BKMK_FL)  
  
    -   [Устаревание NTFRS](../../../ad-ds/manage/component-updates/Directory-Services-component-updates.md#BKMK_NTFRS)  
  
    -   [Изменения в оптимизаторе запросов LDAP](../../../ad-ds/manage/component-updates/Directory-Services-component-updates.md#BKMK_LDAPQuery)  
  
    -   [Улучшения, связанные с событием 1644](../../../ad-ds/manage/component-updates/Directory-Services-component-updates.md#BKMK_1644)  
  
    -   [Повышение пропускной способности репликации Active Directory](../../../ad-ds/manage/component-updates/Directory-Services-component-updates.md#BKMK_ADRepl)  
  
## <a name="BKMK_FL"></a>Режимы работы домена и леса  
  
### <a name="overview"></a>Обзор  
Раздел содержит краткое введение в функциональное изменения уровня домена и леса.  
  
### <a name="new-dfl-and-ffl"></a>Новый DFL и FFL  
С выпуском существует новый функциональные уровни домена и леса.  
  
-   Режим работы леса: Windows Server 2012 R2  
  
-   Режим работы домена: Windows Server 2012 R2  
  
### <a name="the-windows-server-2012-r2-domain-functional-level-enables-support-for-the-following"></a>Windows Server 2012 R2 режим работы домена включает поддержку в следующих целях:  
  
1.  Средства защиты со стороны контроллера домена для *защищенных пользователей*  
  
    *Пользователям, защищенным* проверка подлинности в домене Windows Server 2012 R2 можно **больше не**:  
  
    -   Проверка подлинности с помощью проверки подлинности NTLM  
  
    -   Использовать DES или наборы шифров RC4 в предварительной проверке подлинности Kerberos  
  
    -   Делегироваться в ограниченное и неограниченное делегирование  
  
    -   Выполнять продление пользовательских билетов (TGT) вне пределов продолжительности начальной 4 часов  
  
2.  Политики проверки подлинности  
  
    На основе нового леса Active Directory политики, которые могут применяться к учетным записям в доменах Windows Server 2012 R2 для управления какие узлы учетной записи можно вход из и применить условия контроля доступа для проверки подлинности к службам, работающим в качестве учетной записи  
  
3.  Приемники команд политик проверки подлинности  
  
    На основе нового леса Active Directory объект можно создать связь между пользователем, управляемой службы и учетные записи компьютеров, будет использоваться для классификации учетных записей для политики проверки подлинности или для проверки подлинности изоляции.  
  
См. в разделе How to Configure Protected Accounts, Дополнительные сведения.  
  
Помимо выше функций режим работы домена Windows Server 2012 R2 гарантирует, что любой контроллер домена в домене выполняется Windows Server 2012 R2.  
Режим работы леса Windows Server 2012 R2 не предоставляет новых возможностей, но это гарантирует, что любой домен, созданный в лесу, будет автоматически работать в режиме работы домена Windows Server 2012 R2.  
  
### <a name="minimum-dfl-enforced-on-new-domain-creation"></a>Минимальное DFL, применяются к созданию нового домена  
Windows Server 2008 DFL имеет минимальный уровень работы, поддерживаемый на создание нового домена.  
  
> [!NOTE]  
> Об использовании FRS достигается путем удаления возможность установки нового домена с помощью режима работы домена ниже, чем Windows Server 2008 с помощью диспетчера серверов или с помощью Windows PowerShell.  
  
### <a name="lowering-the-forest-and-domain-functional-levels"></a>Понижение режимы работы леса и домена  
Режимы работы леса и домена заданы до Windows Server 2012 R2 по умолчанию на создание нового домена и нового леса, но может быть понижено с помощью Windows PowerShell.  
  
Чтобы повысить или понизить режим работы леса, с помощью Windows PowerShell, используйте **Set-ADForestMode** командлета.  
  
**Установка contoso.com FFL режима Windows Server 2008:**  
  
```sql  
Set-ADForestMode -ForestMode Windows2008Forest -Identity contoso.com  
```  
  
Чтобы повысить или понизить режим работы домена, с помощью Windows PowerShell, используйте командлет Set-ADDomainMode.  
  
**Для задания contoso.com Работающий в режиме Windows Server 2008:**  
  
```powershell  
Set-ADDomainMode -DomainMode Windows2008Domain -Identity contoso.com  
```  
  
Повышения роли контроллера домена под управлением Windows Server 2012 R2, как дополнительную реплику в существующем домене под управлением 2003 DFL работает.  
  
Создание нового домена в существующем лесу  
  
![обновления служб каталогов](media/Directory-Services-component-updates/GTR_ADDS_FFL.gif)  
  
### <a name="adprep"></a>ADPREP  
Не существует новый лес или домен операции в этом выпуске.  
  
Эти LDF-файлы содержат изменения схемы для **службы регистрации устройств**.  
  
1.  Sch59  
  
2.  Sch61  
  
3.  Sch62  
  
4.  Sch63  
  
5.  Sch64  
  
6.  Sch65  
  
7.  Sch67  
  
**Рабочие папки:**  
  
1.  Sch66  
  
**MSODS:**  
  
1.  Sch60  
  
**Политики проверки подлинности и приемники команд**  
  
1.  Sch68  
  
2.  Sch69  
  
## <a name="BKMK_NTFRS"></a>Устаревание NTFRS  
  
### <a name="overview"></a>Обзор  
FRS устарела в Windows Server 2012 R2.  Об использовании FRS осуществляется с применением минимального режима работы домена (DFL) Windows Server 2008.  Такое требование присутствует только в том случае, если новый домен создается с помощью диспетчера серверов или Windows PowerShell.  
  
Параметр - DomainMode используется с Install-ADDSForest или командлетов Install-ADDSDomain для указать режим работы домена.  Поддерживаемые значения для этого параметра может быть допустимым целым числом или соответствующее значение обходимой строки. Например чтобы задать уровень режим домена до Windows Server 2008 R2, можно указать либо значение 4, либо «Win2008R2».  При выполнении этих командлетов из Server 2012 R2 допустимые значения включают такие агенты для Windows Server 2008 (3, Win2008) Windows Server 2008 R2 (4, Win2008R2) Windows Server 2012 (5, Win2012) и Windows Server 2012 R2 (6, Win2012R2). Режим работы домена не может быть ниже режима работы леса, но может быть выше него.  Так как FRS является устаревшим в этом выпуске Windows Server 2003 (2, Win2003) не является распознанным параметром с этими командлетами, при выполнении из Windows Server 2012 R2.  
  
![обновления служб каталогов](media/Directory-Services-component-updates/GTR_ADDS_PS_Install2003DFL.gif)  
  
![обновления служб каталогов](media/Directory-Services-component-updates/GTR_ADDS_PS_InstallDFL2.gif)  
  
## <a name="BKMK_LDAPQuery"></a>Изменения в оптимизаторе запросов LDAP  
  
### <a name="overview"></a>Обзор  
Алгоритм оптимизатор запросов LDAP была повторно и дополнительно оптимизировать.  Результатом является повышение производительности поиска LDAP и Сокращение времени поиска для сложных запросов.  
  
> [!NOTE]
> <strong>От разработчика:</strong>улучшения производительности операций поиска благодаря улучшениям в сопоставление LDAP запроса к запросу ESE.  Фильтры LDAP за пределы определенного уровня сложности предотвратить выбор оптимизированного индекса, в результате чего значительно уменьшить производительность (1000 x или более). Это изменение изменяет порядок, в котором мы выбираем индексы для запросов LDAP избежать этой проблемы.  
> 
> [!NOTE]
> Полный пересмотренную алгоритм оптимизатор запросов LDAP, в результате чего:  
> 
> -   Сокращение времени поиска  
> -   Повышения эффективности позволяют контроллерам домена расширить  
> -   Меньше обращений в службу поддержки в отношении производительности AD выдает  
> -   Назад, входящая в Windows Server 2008 R2 (2862304 КБ)  
  
### <a name="background"></a>Фон  
Возможность поиска Active Directory является базовой службой, предоставляемые контроллеров домена.  Другие службы и бизнес-приложения зависят от поиск Active Directory.  Бизнес-операций может прекратить к сбою, если эта функция недоступна.  Как core и часто используемые службы крайне важно, что контроллеры домена обрабатывают трафик поиска LDAP эффективно.  Алгоритм оптимизатор запросов LDAP пытается осуществить поиск LDAP максимально эффективным путем сопоставления фильтры поиска LDAP в результирующий набор, который может быть выполнено с помощью записей, уже проиндексированы в базе данных.  Этот алгоритм был вычислен повторно и дополнительно оптимизировать.  Результатом является повышение производительности поиска LDAP и Сокращение времени поиска для сложных запросов.  
  
### <a name="details-of-change"></a>Сведения об изменении  
Поиск LDAP содержит:  
  
-   Расположение (заголовке контекста Именования, Подразделения, объект) в иерархии, чтобы начать поиск  
  
-   Фильтр поиска  
  
-   Список возвращаемых атрибутов  
  
Процесс поиска можно интерпретировать следующим образом:  
  
1.  По возможности Упростите фильтра поиска.  
  
2.  Выберите набор ключей индекса, возвращает наименьший набор закрытый.  
  
3.  Выполнение пересечения один или несколько ключей индекса, для уменьшения охватываемый набора.  
  
4.  Для каждой записи в наборе охватываемый оценки критерия фильтра, а также безопасность. Если фильтр имеет значение TRUE, доступ предоставляется клиенту возвращается данной записи.  
  
Оптимизации работы запросов LDAP изменяет шаги 2 и 3, чтобы уменьшить размер набора закрытый. В частности текущая реализация выбирается повторяющихся ключей индекса и выполняется избыточных пересечения.  
  
### <a name="comparison-between-old-and-new-algorithm"></a>Сравнение старых и новых алгоритм  
Цель неэффективным поиска LDAP в этом примере является контроллером домена Windows Server 2012.  Поиск будет завершен через приблизительно 44 секунды, в результате не удастся найти более эффективный индекс.  
  
```  
adfind -b dc=blue,dc=contoso,dc=com -f "(| (& (|(cn=justintu) (postalcode=80304) (userprincipalname=justintu@blue.contoso.com)) (|(objectclass=person) (cn=justintu)) ) (&(cn=justintu)(objectclass=person)))" -stats >>adfind.txt  
  
Using server: WINSRV-DC1.blue.contoso.com:389  
  
<removed search results>  
  
Statistics  
=====  
Elapsed Time: 44640 (ms)  
Returned 324 entries of 553896 visited - (0.06%)  
  
Used Filter:  
 ( |  ( &  ( |  (cn=justintu)  (postalCode=80304)  (userPrincipalName=justintu@blue.contoso.com) )  ( |  (objectClass=person)  (cn=justintu) ) )  ( &  (cn=justintu)  (objectClass=person) ) )   
  
Used Indices:  
 DNT_index:516615:N  
  
Pages Referenced          : 4619650  
Pages Read From Disk      : 973  
Pages Pre-read From Disk  : 180898  
Pages Dirtied             : 0  
Pages Re-Dirtied          : 0  
Log Records Generated     : 0  
Log Record Bytes Generated: 0  
```  
  
### <a name="sample-results-using-the-new-algorithm"></a>Образец результатов, используя новый алгоритм  
В этом примере повторяется поиск точного соответствия же как описано выше, но предназначено контроллер домена Windows Server 2012 R2.  Тот же поиск завершается менее чем за секунду из-за улучшения в алгоритме оптимизатор запросов LDAP.  
  
```  
adfind -b dc=blue,dc=contoso,dc=com -f "(| (& (|(cn=justintu) (postalcode=80304) (userprincipalname=dhunt@blue.contoso.com)) (|(objectclass=person) (cn=justintu)) ) (&(cn=justintu)(objectclass=person)))" -stats >>adfindBLUE.txt  
  
Using server: winblueDC1.blue.contoso.com:389  
  
.<removed search results>  
  
Statistics  
=====  
Elapsed Time: 672 (ms)  
Returned 324 entries of 648 visited - (50.00%)  
  
Used Filter:  
 ( |  ( &  ( |  (cn=justintu)  (postalCode=80304)  (userPrincipalName=justintu@blue.contoso.com) )  ( |  (objectClass=person)  (cn=justintu) ) )  ( &  (cn=justintu)  (objectClass=person) ) )   
  
Used Indices:  
 idx_userPrincipalName:648:N  
 idx_postalCode:323:N  
 idx_cn:1:N  
  
Pages Referenced          : 15350  
Pages Read From Disk      : 176  
Pages Pre-read From Disk  : 2  
Pages Dirtied             : 0  
Pages Re-Dirtied          : 0  
Log Records Generated     : 0  
Log Record Bytes Generated: 0  
```  
  
-   Если не удается оптимизировать дерева:  
  
    -   Например: выражение в дереве был для столбца не проиндексированы  
  
    -   Запись списка индексов, которые препятствуют оптимизации  
  
    -   Реализуются с помощью отслеживания ETW и событие с кодом 1644  
  
        ![обновления служб каталогов](media/Directory-Services-component-updates/GTR_ADDS_Event1644.gif)  
  
### <a name="BKMK_EnableStats"></a>Чтобы включить элемент управления статистики в LDP  
  
1.  Откройте LDP.exe и подключение и привязку к контроллеру домена.  
  
2.  На **параметры** меню, щелкните **элементов управления**.  
  
3.  В диалоговом окне элементы управления разверните **Load Predefined** раскрывающееся меню, щелкните **Статистика поиска** и нажмите кнопку **ОК**.  
  
    ![обновления служб каталогов](media/Directory-Services-component-updates/GTR_ADDS_Controls.gif)  
  
4.  На **Обзор** меню, нажмите кнопку **поиска**  
  
5.  В диалоговом окне поиска выберите **параметры** кнопки.  
  
6.  Убедитесь, **Extended** флажок на диалоговое окно параметров поиска и выберите **ОК**.  
  
    ![обновления служб каталогов](media/Directory-Services-component-updates/GTR_ADDS_SearchOptions.gif)  
  
### <a name="try-this-use-ldp-to-return-query-statistics"></a>Попробуйте выполните следующее: Использование LDP для возврата статистики запросов  
На контроллере домена или присоединенных к домену клиента или сервера с установленными средствами AD DS, сделайте следующее.  Повторите следующие вашим контроллером домена Windows Server 2012 и вашим контроллером домена Windows Server 2012 R2.  
  
1.  Просмотрите [«Создание более эффективных Microsoft AD включена приложений»](https://msdn.microsoft.com/library/ms808539.aspx) статьи и обращаться к ней при необходимости.  
  
2.  С помощью программы LDP, включить статистику поиска (см. в разделе [для включения управления статистики в LDP](../../../ad-ds/manage/component-updates/../../../ad-ds/manage/component-updates/../../../ad-ds/manage/component-updates/../../../ad-ds/manage/component-updates/../../../ad-ds/manage/component-updates/../../../ad-ds/manage/component-updates/Directory-Services-component-updates.md#BKMK_EnableStats))  
  
3.  Провести несколько поисков LDAP и просмотрите статистические сведения в верхней части результатов.  Необходимо будет повторить тот же поиск в других действий поэтому описать их в текстовый файл блокнота.  
  
4.  Выполните поиск LDAP, оптимизатор запросов должен иметь возможность оптимизировать из-за атрибуты индексов  
  
5.  Пытайтесь создать поиск, который занимает много времени для завершения (может потребоваться увеличить **предельное время** параметр, чтобы поиск время ожидания не истекает).  
  
### <a name="additional-resources"></a>Дополнительные ресурсы  
[Что такое поиск Active Directory?](https://technet.microsoft.com/library/cc783845(v=ws.10).aspx)  
  
[Способ поиска работы в Active Directory](https://technet.microsoft.com/library/cc755809(v=WS.10).aspx)  
  
[Создание более эффективно Microsoft Active Directory-приложения](https://msdn.microsoft.com/library/ms808539.aspx)  
  
[951581](https://support.microsoft.com/kb/951581) LDAP-запросы выполняются медленнее, чем ожидалось в AD или службы каталогов LDS/ADAM и с кодом 1644 событие может регистрироваться  
  
## <a name="BKMK_1644"></a>С событием 1644  
  
### <a name="overview"></a>Обзор  
Это обновление добавляет дополнительные Статистика по результатам поиска LDAP событие с кодом 1644 для облегчения устранения неполадок.  Кроме того имеется новое значение реестра, который может использоваться для включения ведения журнала на основе времени порогового значения.  Эти усовершенствования стали доступными в Windows Server 2012 и Windows Server 2008 R2 SP1 с помощью базы Знаний [2800945](https://support.microsoft.com/kb/2800945) и будут доступны для Windows Server 2008 SP2.  
  
> [!NOTE]  
> -   Событие с кодом 1644 для устранения неисправностей неэффективным или дорогостоящих поисков LDAP добавляются дополнительные статистические данные поиска LDAP  
> -   Теперь можно указать пороговое значение времени поиска (например) Событие журнала 1644 для поиска, больше времени, чем 100 мс) вместо указания дороже и Inefficient поиска результатов пороговых значений  
  
### <a name="background"></a>Фон  
Во время устранения проблем производительности Active Directory, становится ясно, что действие поиска LDAP может причиной проблемы.  Вы решили включить ведение журнала, могут получить значительные затраты или неэффективно LDAP-запросах, обрабатываемых контроллером домена.  Чтобы включить ведение журнала, необходимо задать значение Чой диагностики и при необходимости можно указать пороговые значения результатов поиска дорогостоящие / неэффективным.  При включении поле Engineering, уровень ведения журнала значение 5, любой поиска, который соответствует этому критерию регистрируется в журнале событий служб каталогов с событием с кодом 1644.  
  
Событие содержит:  
  
-   Клиент IP-адрес и порт  
  
-   Начальный узел  
  
-   Filter  
  
-   Область поиска  
  
-   Выбор атрибутов  
  
-   Серверные элементы управления  
  
-   Посещенных страниц  
  
-   Возвращаемых элементов  
  
Тем не менее, данные ключа отсутствует из события, такие как время, затраченное на операцию поиска и что (если таковые имеются) индекс был использован.  
  
#### <a name="additional-search-statistics-added-to-event-1644"></a>Дополнительные статистические данные, добавляемые событие 1644  
  
-   Используемые индексы  
  
-   Ссылки на страницы  
  
-   Страниц, считанных с диска  
  
-   Страницы Невостребованных прочитанных заранее с диска  
  
-   Чистые страницы изменения  
  
-   "Грязных" страниц, измененных  
  
-   Время поиска  
  
-   Атрибуты, не позволяя оптимизировать  
  
#### <a name="new-time-based-threshold-registry-value-for-event-1644-logging"></a>Новое значение реестра пороговое значение на основе времени для ведения журнала событий 1644  
Вместо указания дороже и Inefficient поиска результат пороговые значения, можно указать пороговое значение времени поиска.  Если вы желаемую в журнал все результаты поиска, которые принимали превышает 50 мс или более поздней версии, следует указать десятичное 50 / 32 шестнадцатеричных (в дополнение к установке Чой значения).  
  
```  
Windows Registry Editor Version 5.00  
[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\NTDS\Parameters]  
"Search Time Threshold (msecs)"=dword:00000032  
```  
  
#### <a name="comparison-of-the-old-and-new-event-id-1644"></a>Сравнение старое и новое событие с кодом 1644  
СТАРЫЙ  
  
![обновления служб каталогов](media/Directory-Services-component-updates/GTR_ADDS_Event1644_2012.gif)  
  
НОВИНКА  
  
![обновления служб каталогов](media/Directory-Services-component-updates/GTR_ADDS_Event1644_2012R2.gif)  
  
#### <a name="try-this-use-the-event-log-to-return-query-statistics"></a>Попробуйте выполните следующее: Использование журнала событий для возврата статистики запросов  
  
1.  Повторите следующие вашим контроллером домена Windows Server 2012 и вашим контроллером домена Windows Server 2012 R2. Просмотрите события 1644s идентификатор на обоих контроллерах домена после каждой операции поиска.  
  
2.  С помощью regedit, включите ведение журнала событий с кодом 1644, используя пороговое значение на основе времени на контроллере домена Windows Server 2012 R2 и старый метод на контроллере домена Windows Server 2012.  
  
3.  Проведите несколько поисков LDAP, которые превышают пороговое значение и просмотрите статистические сведения в верхней части результатов.  Использовать запросы LDAP, записанный ранее и повторите и поиск выполняется.  
  
4.  Выполните поиск LDAP, оптимизатор запросов не позволит оптимизировать так, как один или несколько атрибутов не индексируются.  
  
## <a name="BKMK_ADRepl"></a>Повышение пропускной способности Active Directory репликации  
  
### <a name="overview"></a>Обзор  
Репликация AD использует RPC для транспорта репликации. По умолчанию использует протокол RPC, в буфер передачи 8K и увеличение размера пакета 5 КБ. Это приводит к net где отправляющий экземпляр будет передавать три пакеты (примерно 15 КБ стоит данных) и затем дождаться сети цикла приема-передачи перед отправкой дополнительные. При условии, что мс времени кругового пути, высокая пропускная способность составит около 40Mbps, даже в 1 Гбит/с или 10 Гбит/с сетями.  
  
> [!NOTE]  
> -   Это обновление корректирует максимальный репликации AD пропускную способность от 40Mbps до приблизительно 600 Мбит/с.  
>   
>     -   Он увеличивает размер буфера отправки RPC, что уменьшает число сетевых циклов  
> -   Результат будет наиболее заметно на высокой скорости, высокой задержки сети.  
  
Обновления увеличить максимальную пропускную способность до приблизительно 600 Мбит/с, изменив размер буфера отправки RPC с 8 КБ до 256 КБ.  Это изменение позволяет размер окна TCP превышать 8 КБ, уменьшая число сетевых круговых путей.  
  
> [!NOTE]  
> Отсутствуют настраиваемые параметры для изменения этого поведения.  
  
### <a name="additional-resources"></a>Дополнительные ресурсы  
[Как работает модель репликации Active Directory](https://technet.microsoft.com/library/cc772726(v=WS.10).aspx)  
  


