---
ms.assetid: 8a3cf2ae-2511-4eea-afd5-a43179a78613
title: "Обновления компонентов служб каталогов"
description: 
author: billmath
ms.author: billmath
manager: femila
ms.date: 05/31/2017
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: identity-adds
ms.openlocfilehash: ac42591450038240ced273555fb01e66b1ff5546
ms.sourcegitcommit: db290fa07e9d50686667bfba3969e20377548504
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/12/2017
---
# <a name="directory-services-component-updates"></a>Обновления компонентов служб каталогов

>Область применения: Windows Server 2016, Windows Server 2012 R2, Windows Server 2012

**Автор**: Джастин Тернер, старший инженер по улучшению поддержки с группой Windows  
  
> [!NOTE]  
> Этот материал создан инженером поддержки клиентов Майкрософт и предназначен для опытных администраторов и архитекторов систем, которым нужны более глубокие технические сведения о функциях и решениях в Windows Server 2012 R2, чем обычно предоставляют разделов на TechNet. Однако он не проходил же редактирования этапах, поэтому некоторые формулировки могут быть то, что обычно станицах на сайте TechNet.  
  
Урока Описание обновления компонентов служб каталогов в Windows Server 2012 R2.  
  
## <a name="what-you-will-learn"></a>Тема обучения  
Объясните следующие новые обновления компонентов служб каталогов:  
  
-   Объясните следующие новые обновления компонентов служб каталогов:  
  
    -   [Режимы работы домена и леса](../../../ad-ds/manage/component-updates/Directory-Services-component-updates.md#BKMK_FL)  
  
    -   [Устаревание NTFRS](../../../ad-ds/manage/component-updates/Directory-Services-component-updates.md#BKMK_NTFRS)  
  
    -   [Изменения в оптимизаторе запросов LDAP](../../../ad-ds/manage/component-updates/Directory-Services-component-updates.md#BKMK_LDAPQuery)  
  
    -   [Событием 1644](../../../ad-ds/manage/component-updates/Directory-Services-component-updates.md#BKMK_1644)  
  
    -   [Повышение пропускной способности Active Directory репликации](../../../ad-ds/manage/component-updates/Directory-Services-component-updates.md#BKMK_ADRepl)  
  
## <a name="BKMK_FL"></a>Режимы работы домена и леса  
  
### <a name="overview"></a>Обзор  
В разделе приводится краткое описание функциональные изменения уровня домена и леса.  
  
### <a name="new-dfl-and-ffl"></a>Новый DFL и FFL  
С выпуском существует новые режимы работы домена и леса.  
  
-   Режим работы леса: Windows Server 2012 R2  
  
-   Режим работы домена: Windows Server 2012 R2  
  
### <a name="the-windows-server-2012-r2-domain-functional-level-enables-support-for-the-following"></a>Windows Server 2012 R2 режим работы домена включает поддержку следующих:  
  
1.  Меры защиты стороне контроллера домена для *защищенных пользователей*  
  
    *Защищенные пользователи* проверки подлинности на домене Windows Server 2012 R2 можно **больше не**:  
  
    -   Проверки подлинности с помощью проверки подлинности NTLM  
  
    -   Используйте DES или наборы шифров RC4 в предварительной проверке подлинности Kerberos  
  
    -   Делегироваться в рамках неограниченного или ограниченного делегирования  
  
    -   Выполнять продление пользовательских билетов (TGT) за время существования начальной 4 часа  
  
2.  Политики проверки подлинности  
  
    Политики на основе нового леса Active Directory, которые могут применяться к учетным записям в доменах Windows Server 2012 R2, чтобы управлять тем, какие узлы учетную запись можно входа и применить условия контроля доступа для проверки подлинности для службы, запущенные от имени учетной записи  
  
3.  Приемники команд политик проверки подлинности  
  
    Новый лес Active Directory объекта на основе которого можно создать связь между пользователем, управляемых служб и учетные записи компьютеров используются для классификации учетных записей политики проверки подлинности или для проверки подлинности изоляции.  
  
В разделе Настройка защищенных учетных записей для получения дополнительных сведений.  
  
В дополнение к возможностям выше режим работы домена Windows Server 2012 R2 гарантирует, что любой контроллер домена в домене работает под управлением Windows Server 2012 R2.  
Режим работы леса Windows Server 2012 R2 не предоставляет новых возможностей, но это гарантирует, что любой домен, созданный в лесу, будут автоматически работать в режиме работы домена Windows Server 2012 R2.  
  
### <a name="minimum-dfl-enforced-on-new-domain-creation"></a>Минимальное значение, принудительно применить к созданию нового домена  
Режиме работы ЛЕСА Windows Server 2008 является минимальным функциональный уровень поддерживается для создания нового домена.  
  
> [!NOTE]  
> Не рекомендуется к использованию FRS достигается путем удаления возможность установить новый домен с режимом работы ниже, чем Windows Server 2008 с помощью диспетчера серверов или с помощью Windows PowerShell.  
  
### <a name="lowering-the-forest-and-domain-functional-levels"></a>Понижение функциональные уровни леса и домена  
Режимы работы леса и домена устанавливаются на Windows Server 2012 R2 по умолчанию для создания новых доменов и новый лес, но снижено с помощью Windows PowerShell.  
  
Чтобы повысить или понизить режим работы леса с помощью Windows PowerShell, используйте **Set-ADForestMode** командлета.  
  
**Чтобы задать contoso.com FFL режим Windows Server 2008:**  
  
```sql  
Set-ADForestMode -ForestMode Windows2008Forest -Identity contoso.com  
```  
  
Чтобы повысить или понизить режим работы домена, с помощью Windows PowerShell, используйте командлет Set-ADDomainMode.  
  
**Чтобы задать contoso.com DFL режим Windows Server 2008:**  
  
```powershell  
Set-ADDomainMode -DomainMode Windows2008Domain -Identity contoso.com  
```  
  
Повышение роли контроллера домена под управлением Windows Server 2012 R2 как дополнительные реплики в существующем домене под управлением Windows Server 2003 DFL работает.  
  
Созданию нового домена в существующем лесу  
  
![обновления служб каталогов](media/Directory-Services-component-updates/GTR_ADDS_FFL.gif)  
  
### <a name="adprep"></a>ПРОГРАММА ADPREP  
Не существует нового леса или домена операций, в этом выпуске.  
  
Эти LDF-файлов содержат изменения схемы для **службы регистрации устройств**.  
  
1.  Sch59  
  
2.  Sch61  
  
3.  Sch62  
  
4.  Sch63  
  
5.  Sch64  
  
6.  Sch65  
  
7.  Sch67  
  
**Рабочие папки:**  
  
1.  Sch66  
  
**MSODS:**  
  
1.  Sch60  
  
**Политики проверки подлинности и приемники команд**  
  
1.  Sch68  
  
2.  Sch69  
  
## <a name="BKMK_NTFRS"></a>Устаревание NTFRS  
  
### <a name="overview"></a>Обзор  
FRS устарела в Windows Server 2012 R2.  Не рекомендуется к использованию FRS достигается путем применения минимальный режим работы домена (DFL) Windows Server 2008.  Такое требование присутствует только в том случае, если создается новый домен, с помощью диспетчера сервера или Windows PowerShell.  
  
Используется параметр - DomainMode с Install-ADDSForest или Install-ADDSDomain командлеты для указания режима работы домена.  Поддерживаются значения для этого параметра может быть допустимое целое число или соответствующее значение перечисления строку. Например чтобы задать режим домена на Windows Server 2008 R2, можно указать значения 4 или «Win2008R2».  При выполнении эти командлеты из Server 2012 R2 допустимые значения относятся устройства для Windows Server 2008 (3 Win2008) Windows Server 2008 R2 (4 Win2008R2) Windows Server 2012 (5, Win2012) и Windows Server 2012 R2 (6, Win2012R2). Режим работы домена не может быть ниже режима работы леса, но может быть выше.  Поскольку в этом выпуске Windows Server 2003 (2 Win2003) устарела FRS не распознанный параметром с помощью этих командлетов, при выполнении с Windows Server 2012 R2.  
  
![обновления служб каталогов](media/Directory-Services-component-updates/GTR_ADDS_PS_Install2003DFL.gif)  
  
![обновления служб каталогов](media/Directory-Services-component-updates/GTR_ADDS_PS_InstallDFL2.gif)  
  
## <a name="BKMK_LDAPQuery"></a>Изменения в оптимизаторе запросов LDAP  
  
### <a name="overview"></a>Обзор  
Алгоритм оптимизаторе запросов LDAP была повторной оценке и дальнейшей оптимизации.  Результатом является повышение производительности поиска LDAP и Сокращение времени поиска для сложных запросов.  
  
> [!NOTE]  
> **У разработчика:**запроса улучшения в производительности операций поиска благодаря улучшениям в сопоставлении с LDAP для запроса ESE.  Фильтры LDAP за пределы уровень сложности запретить выбор оптимизированного индекса, в результате существенно снижать производительность (1000 x или больше). Это изменение изменяет способ, в котором мы выбрать индексов для запросов LDAP избежать этой проблемы.  
  
> [!NOTE]  
> Полный переделку, связанную с алгоритм оптимизаторе запросов LDAP, из-за которой:  
>   
> -   Сокращение времени поиска  
> -   Разрешить повышения эффективности контроллеры домена делать многое другое  
> -   Меньше обращений в службу поддержки проблем с производительностью отношении AD  
> -   Назад, входящая в Windows Server 2008 R2 (KB 2862304)  
  
### <a name="background"></a>Фон  
Возможность поиска в Active Directory является основной службы, предоставляемые контроллеров домена.  Другие службы и бизнес-приложений зависит от поиск Active Directory.  К остановке может прекратить бизнес-операции, если эта функция недоступна.  Как основной и служба нагрузкой крайне важно эффективно обрабатывать трафик поиска LDAP контроллеров домена.  Алгоритм оптимизаторе запросов LDAP пытается повысить эффективность поисков LDAP, сопоставляя фильтры поиска LDAP для результирующий набор, который может быть выполнено с помощью записей, уже проиндексированы в базе данных.  Этот алгоритм был повторной оценке и дальнейшей оптимизации.  Результатом является повышение производительности поиска LDAP и Сокращение времени поиска для сложных запросов.  
  
### <a name="details-of-change"></a>Сведения об изменении  
Поиск LDAP содержит:  
  
-   Расположение (именования, Подразделение, Object) в иерархии, чтобы начать поиск  
  
-   Фильтр поиска  
  
-   Список атрибутов, возвращаемых  
  
Процесс поиска можно представить следующим образом:  
  
1.  Если это возможно Упростите фильтр поиска.  
  
2.  Выберите набор ключей индекса, будет возвращать охватываемого наименьший набор.  
  
3.  Выполните пересечения один или несколько ключей индекса, чтобы уменьшить зарегистрированное набор.  
  
4.  Для каждой записи в наборе охватываемого Оцените выражение фильтра, а также безопасности. Если фильтр имеет значение TRUE, и предоставлен доступ, возвращается этой записи клиента.  
  
Работа оптимизации запроса LDAP изменяет шаги 2 и 3, чтобы уменьшить размер охватываемого set. В частности текущая реализация выбирает повторяющиеся индексируются ключи и выполняет избыточных пересечения.  
  
### <a name="comparison-between-old-and-new-algorithm"></a>Сравнение между старой и новой алгоритма  
Цель неэффективным поиска LDAP в этом примере является контроллером домена Windows Server 2012.  Поиск завершается за около 44 секунд, в результате невозможность найти эффективнее индекс.  
  
```  
adfind -b dc=blue,dc=contoso,dc=com -f "(| (& (|(cn=justintu) (postalcode=80304) (userprincipalname=justintu@blue.contoso.com)) (|(objectclass=person) (cn=justintu)) ) (&(cn=justintu)(objectclass=person)))" -stats >>adfind.txt  
  
Using server: WINSRV-DC1.blue.contoso.com:389  
  
<removed search results>  
  
Statistics  
=====  
Elapsed Time: 44640 (ms)  
Returned 324 entries of 553896 visited - (0.06%)  
  
Used Filter:  
 ( |  ( &  ( |  (cn=justintu)  (postalCode=80304)  (userPrincipalName=justintu@blue.contoso.com) )  ( |  (objectClass=person)  (cn=justintu) ) )  ( &  (cn=justintu)  (objectClass=person) ) )   
  
Used Indices:  
 DNT_index:516615:N  
  
Pages Referenced          : 4619650  
Pages Read From Disk      : 973  
Pages Pre-read From Disk  : 180898  
Pages Dirtied             : 0  
Pages Re-Dirtied          : 0  
Log Records Generated     : 0  
Log Record Bytes Generated: 0  
```  
  
### <a name="sample-results-using-the-new-algorithm"></a>Пример результатов с помощью нового алгоритма  
В этом примере повторяет же искомого выше, но предназначенной для контроллера домена Windows Server 2012 R2.  Тот же поиск завершается за меньше, чем второй Благодаря усовершенствованию алгоритм оптимизаторе запросов LDAP.  
  
```  
adfind -b dc=blue,dc=contoso,dc=com -f "(| (& (|(cn=justintu) (postalcode=80304) (userprincipalname=dhunt@blue.contoso.com)) (|(objectclass=person) (cn=justintu)) ) (&(cn=justintu)(objectclass=person)))" -stats >>adfindBLUE.txt  
  
Using server: winblueDC1.blue.contoso.com:389  
  
.<removed search results>  
  
Statistics  
=====  
Elapsed Time: 672 (ms)  
Returned 324 entries of 648 visited - (50.00%)  
  
Used Filter:  
 ( |  ( &  ( |  (cn=justintu)  (postalCode=80304)  (userPrincipalName=justintu@blue.contoso.com) )  ( |  (objectClass=person)  (cn=justintu) ) )  ( &  (cn=justintu)  (objectClass=person) ) )   
  
Used Indices:  
 idx_userPrincipalName:648:N  
 idx_postalCode:323:N  
 idx_cn:1:N  
  
Pages Referenced          : 15350  
Pages Read From Disk      : 176  
Pages Pre-read From Disk  : 2  
Pages Dirtied             : 0  
Pages Re-Dirtied          : 0  
Log Records Generated     : 0  
Log Record Bytes Generated: 0  
```  
  
-   Если не удается оптимизировать дерева:  
  
    -   Например: выражения в дереве превысила неиндексированных столбец  
  
    -   Запишите список индексов, которые не позволяют оптимизации  
  
    -   Через трассировки событий Windows и событие с кодом 1644 раскрыты  
  
        ![обновления служб каталогов](media/Directory-Services-component-updates/GTR_ADDS_Event1644.gif)  
  
### <a name="BKMK_EnableStats"></a>Чтобы включить управления статистику в LDP  
  
1.  Откройте LDP.exe и подключение и привязку к контроллеру домена.  
  
2.  На **параметры** меню, нажмите кнопку **элементов управления**.  
  
3.  В диалоговом окне "элементы управления" разверните **предопределенные нагрузки** раскрывающемся меню выберите **Статистика поиска** и нажмите кнопку **ОК**.  
  
    ![обновления служб каталогов](media/Directory-Services-component-updates/GTR_ADDS_Controls.gif)  
  
4.  На **Обзор** меню, нажмите кнопку **поиска**  
  
5.  В диалоговом окне поиска выберите **параметры** кнопки.  
  
6.  Убедитесь, **Extended** флажок на диалоговое окно "Параметры поиска" и выберите **ОК**.  
  
    ![обновления служб каталогов](media/Directory-Services-component-updates/GTR_ADDS_SearchOptions.gif)  
  
### <a name="try-this-use-ldp-to-return-query-statistics"></a>Выполните следующие действия: Использование LDP для возврата Статистика запросов  
Для выполнения следующих на контроллере домена или с присоединенных к домену клиента или сервера с установленными средствами AD DS.  Повторите следующие предназначено для вашего контроллера домена Windows Server 2012, а ваш контроллеров Доменов Windows Server 2012 R2.  
  
1.  Просмотрите [«Создание более эффективно Microsoft AD приложения, использующие»](https://msdn.microsoft.com/library/ms808539.aspx) статьи и обращаться к его при необходимости.  
  
2.  С помощью программы LDP, включить Статистика поиска (см. [для включения управления статистику в LDP](../../../ad-ds/manage/component-updates/../../../ad-ds/manage/component-updates/../../../ad-ds/manage/component-updates/../../../ad-ds/manage/component-updates/../../../ad-ds/manage/component-updates/../../../ad-ds/manage/component-updates/Directory-Services-component-updates.md#BKMK_EnableStats))  
  
3.  Проведение несколько поисков LDAP и просмотрите статистические данные в верхней части результаты.  Будет повторяться в других же поиска действий поэтому обозначить их в текстовый файл блокнота.  
  
4.  Выполните поиск LDAP, который оптимизаторе запросов должны иметь возможность оптимизировать из-за атрибуты индексов  
  
5.  Попытка поиска с помощью занимает много времени для завершения создания (может потребоваться увеличить **ограничение по времени** чтобы поиск времени ожидания).  
  
### <a name="additional-resources"></a>Дополнительные ресурсы  
[Что такое поиск Active Directory?](https://technet.microsoft.com/library/cc783845(v=ws.10).aspx)  
  
[Способ работы поиска в Active Directory](https://technet.microsoft.com/library/cc755809(v=WS.10).aspx)  
  
[Создание более эффективно Microsoft Active Directory-приложения](https://msdn.microsoft.com/library/ms808539.aspx)  
  
[951581](https://support.microsoft.com/kb/951581) запросы LDAP выполняются медленнее, чем ожидалось в AD или службы каталогов LDS или ADAM и кодом 1644 событий может быть занесено  
  
## <a name="BKMK_1644"></a>Событием 1644  
  
### <a name="overview"></a>Обзор  
Это обновление добавляет дополнительные Статистика по результатам поиска LDAP в событие с кодом 1644 для облегчения поиска и устранения неполадок.  Кроме того существует новый параметр реестра, который можно использовать, чтобы включить ведение журнала на пороговое значение, основанные на времени.  Эти улучшения, которые стали доступны в Windows Server 2012 и Windows Server 2008 R2 SP1 через КБ [2800945](https://support.microsoft.com/kb/2800945) и будут доступны для Windows Server 2008 с SP2.  
  
> [!NOTE]  
> -   Событие с кодом 1644, чтобы упростить устранение неполадок малоэффективно и дорого поисков LDAP добавляются Дополнительная статистика поиска LDAP  
> -   Теперь можно указать пороговое значение времени поиска (например,). Журнал событий 1644 для поиска больше времени, чем 100 мс) вместо указания Expensive и Inefficient поиска результат пороговые значения  
  
### <a name="background"></a>Фон  
При устранении неполадок производительности Active Directory стала очевидной, что операции поиска LDAP может быть причиной проблемы.  Вы решили включить ведение журнала, чтобы вы могли видеть дорогих или неэффективным запросов LDAP, обрабатываемых контроллером домена.  Чтобы включить ведение журнала, необходимо задать значение поля Engineering диагностики и при необходимости можно указать пороговые значения результаты поиска дорогостоящих / неэффективным.  После включения Field Engineering, уровень ведения журнала в значение 5, любого поиска, который удовлетворяет следующим критериям заносятся в журнал событий служб каталогов в событии с кодом 1644.  
  
Событие содержит:  
  
-   Клиент IP и порт  
  
-   Начальный узел  
  
-   Фильтр  
  
-   Область поиска  
  
-   Выбор атрибутов  
  
-   Элементы управления  
  
-   Посещенных страниц  
  
-   Возвращаемых элементов  
  
Тем не менее, данные ключа отсутствует из события, такие как количество времени, затраченное на операцию поиска и что (если таковые имеются) индекс был использован.  
  
#### <a name="additional-search-statistics-added-to-event-1644"></a>Статистика дополнительные поиска добавлена в событие 1644  
  
-   Используемые индексов  
  
-   Ссылки на страницы  
  
-   Чтение страниц с диска  
  
-   Страницы Невостребованных прочитанных заранее с диска  
  
-   Изменения чистой страницы  
  
-   Измененные страницы изменения  
  
-   Время поиска  
  
-   Атрибуты, предотвращая оптимизации  
  
#### <a name="new-time-based-threshold-registry-value-for-event-1644-logging"></a>Новое значение реестра на основе времени пороговое значение для записи в журнал событие 1644  
Вместо указания Expensive и Inefficient поиска результат пороговые значения, можно указать пороговое значение времени поиска.  При нежелательна в журнал все результаты поиска, предпринимаемые 50 ms или более поздней версии, вам следует указать десятичное 50 / 32 шестнадцатеричный (в дополнение к Field Engineering значение).  
  
```  
Windows Registry Editor Version 5.00  
[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\NTDS\Parameters]  
"Search Time Threshold (msecs)"=dword:00000032  
```  
  
#### <a name="comparison-of-the-old-and-new-event-id-1644"></a>Сравнение старое и новое событие кодом 1644  
СТАРЫЙ  
  
![обновления служб каталогов](media/Directory-Services-component-updates/GTR_ADDS_Event1644_2012.gif)  
  
Новые функции  
  
![обновления служб каталогов](media/Directory-Services-component-updates/GTR_ADDS_Event1644_2012R2.gif)  
  
#### <a name="try-this-use-the-event-log-to-return-query-statistics"></a>Выполните следующие действия: Используйте журнал событий для возврата Статистика запросов  
  
1.  Повторите следующие предназначено для вашего контроллера домена Windows Server 2012, а ваш контроллеров Доменов Windows Server 2012 R2. Понаблюдайте за 1644s ИД событий на обоих контроллерах домена, после каждого поиска.  
  
2.  В редакторе реестра ведения журнала событие с кодом 1644 использовать пороговое значение, основанные на времени на контроллеров Доменов Windows Server 2012 R2, а старый метод на контроллере домена Windows Server 2012.  
  
3.  Выполните несколько поисков LDAP, превышает пороговое значение и посмотрите, статистические данные в верхней части результаты.  Используйте описанные ранее запросы LDAP и повторите же поисковые запросы.  
  
4.  Выполните поиск LDAP, который оптимизаторе запросов не удалось повысить, потому что один или несколько атрибутов не индексируются.  
  
## <a name="BKMK_ADRepl"></a>Повышение пропускной способности Active Directory репликации  
  
### <a name="overview"></a>Обзор  
Репликация AD использует RPC для его транспорт репликации. По умолчанию RPC использует буфера передачи 8 КБ и размер пакета 5 КБ. Это имеет результирующий эффект, где будет передавать три пакеты (приблизительно 15K стоит данных) и затем дождаться сети кругового пути перед отправкой дополнительные отправляющий экземпляр. При условии 3ms время обмена данными, высокая пропускная способность будет вокруг 40Mbps даже на 1 Гбит/с или 10 Гбит/с сети.  
  
> [!NOTE]  
> -   Это обновление настраивает максимальную производительность репликации AD повысилась с 40 до приблизительно 600 Мбит/с.  
>   
>     -   Увеличивает размер буфера отправки RPC, что уменьшает количество сетевых циклами  
> -   Результат будет более заметная на высокой скорости сети высокой задержкой.  
  
Обновления увеличить максимальную пропускную способность до приблизительно 600 Мбит/с, изменив размер буфера отправки RPC с 8 КБ до 256 КБ.  Это изменение позволяет размер окна TCP увеличение 8 КБ, сократив число сети обходов.  
  
> [!NOTE]  
> Не предусмотрены настраиваемые параметры для изменения этого поведения.  
  
### <a name="additional-resources"></a>Дополнительные ресурсы  
[Как работает модель репликации Active Directory](https://technet.microsoft.com/library/cc772726(v=WS.10).aspx)  
  


