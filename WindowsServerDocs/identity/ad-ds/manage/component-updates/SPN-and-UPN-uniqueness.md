---
ms.assetid: 40bc24b1-2e7d-4e77-bd0f-794743250888
title: Уникальность имен участников-служб и участников-пользователей
description: ''
author: MicrosoftGuyJFlo
ms.author: joflore
manager: mtillman
ms.date: 05/31/2017
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: identity-adds
ms.openlocfilehash: 13259f7f12a37c4ceb8bdd2e35ae2fe131ec35cf
ms.sourcegitcommit: eaf071249b6eb6b1a758b38579a2d87710abfb54
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/31/2019
ms.locfileid: "66442813"
---
# <a name="spn-and-upn-uniqueness"></a>Уникальность имен участников-служб и участников-пользователей

>Область применения. Windows Server 2016, Windows Server 2012 R2, Windows Server 2012

**Автор**: Джастин Тернер, старший инженер по улучшению поддержки с группой Windows  
  
> [!NOTE]  
> Этот материал создан инженером службы поддержки клиентов Майкрософт и предназначен для опытных администраторов и архитекторов систем, которым нужны более глубокие технические сведения о функциях и решениях в Windows Server 2012 R2, а не обычная информация, доступная в статьях на сайте TechNet. Однако он не был отредактирован согласно требованиям сайта, поэтому некоторые формулировки могут быть не такими выверенными, как на станицах TechNet.  
  
## <a name="overview"></a>Обзор  
Контроллеры домена под управлением Windows Server 2012 R2 блок создания повторяющиеся имена участников-служб (SPN) и имена участников-пользователей (UPN). Сюда входят, если для восстановления или восстановления удаленного объекта или переименование объекта на английском языке.  
  
### <a name="background"></a>Фон  
Повторяющиеся участника имена служб (SPN) часто возникают и привести к сбою проверки подлинности и может привести к чрезмерной загрузки ЦП LSASS. Отсутствует метод готовую для блокировки, добавив повторяющееся имя участника-службы или имя участника-пользователя. *  
  
Повторяющиеся значения имени участника-пользователя прервать синхронизации между локальной AD и Office 365.  
  
*Setspn.exe обычно используется для создания новых имен участников-служб и функционально была встроена в версии, выпущенной с Windows Server 2008, который добавляет проверку повторяющихся значений.  
  
**Таблицы SEQ таблицы \\ \* ARABIC 1: Уникальность имени участника-пользователя и имя участника-службы**  
  
|Компонент|Примечание|  
|-----------|-----------|  
|Уникальность имени участника-пользователя|Повторяющиеся имена участников-пользователей break синхронизации локальных учетных записей AD с Windows Azure AD-based services, например Office 365.|  
|Уникальность имени участника-службы|Для использования протокола Kerberos требуется имена участников-служб для взаимной проверки подлинности.  Повторяющиеся имена участников-служб привести к сбою проверки подлинности.|  
  
Дополнительные сведения о требованиях к уникальность имен участников-пользователей и имена участников-служб см. в разделе [ограничения уникальности](https://msdn.microsoft.com/library/dn392337.aspx).  
  
## <a name="symptoms"></a>Симптомы  
Коды ошибок 8467 или 8468 или их hex, символьные строковые эквиваленты регистрируются или в различных на экране понятному и в событие 2974 — идентификатор в журнал событий служб каталогов. Чтобы создать повторяющееся имя участника-пользователя или имя участника-службы он блокируется только при следующих условиях:  
  
-   Запись обрабатывается контроллером домена Windows Server 2012 R2  
  
**Таблицы SEQ таблицы \\ \* ARABIC 2: Коды ошибок уникальность имени участника-пользователя и имя участника-службы**  
  
|Decimal|Hex|Символические|Строка|  
|-----------|-------|------------|----------|  
|8467|21C7|ERROR_DS_SPN_VALUE_NOT_UNIQUE_IN_FOREST|Сбой операции, так как значение имени участника-службы, предоставленное для добавления или изменения не является уникальным на уровне леса.|  
|8648|21C8|ERROR_DS_UPN_VALUE_NOT_UNIQUE_IN_FOREST|Сбой операции, так как значение имени участника-пользователя, указанное для добавления или изменения не является уникальным на уровне леса.|  
  
## <a name="new-user-creation-fails-if-upn-is-not-unique"></a>Создание нового пользователя завершается неудачей, если имя участника-пользователя не является уникальным  
  
### <a name="dsamsc"></a>DSA.msc  
Имя входа пользователя, которую вы выбрали уже используется в этой организации. Выберите другое имя и повторите попытку.  
  
![Уникальность имен участников-служб и участников-пользователей](media/SPN-and-UPN-uniqueness/GTR_ADDS_Fig01_DupUPN.gif)  
  
Измените существующую учетную запись:  
  
Имя входа пользователя уже существует на предприятии. Задать новую, либо путем изменения префикса или выбрав другой суффикс из списка.  
  
![Уникальность имен участников-служб и участников-пользователей](media/SPN-and-UPN-uniqueness/GTR_ADDS_Fig02_DupUPNMod.gif)  
  
### <a name="active-directory-administrative-center-dsacexe"></a>Центр администрирования Active Directory (DSAC.exe)  
Это обеспечит следующую ошибку при попытке создать нового пользователя в центр администрирования Active Directory с помощью имени участника-пользователя, который уже существует.  
  
![Уникальность имен участников-служб и участников-пользователей](media/SPN-and-UPN-uniqueness/GTR_ADDS_Fig03_DupUPNADAC.gif)  
  
**Рис. SEQ Figure \\ \* ARABIC 1 ошибка отображается в центре администрирования AD, когда создание нового пользователя завершается сбоем из-за повторяющихся имени участника-пользователя**  
  
### <a name="event-2974-source-activedirectorydomainservice"></a>Событие 2974 — источник: ActiveDirectory_DomainService  
![Уникальность имен участников-служб и участников-пользователей](media/SPN-and-UPN-uniqueness/GTR_ADDS_Fig04_Event2974.gif)  
  
**Рис. SEQ Figure \\ \* ARABIC 2 2974 идентификатор события с ошибкой 8648**  
  
Событие 2974 — содержит значение, которое был заблокирован и список одного или нескольких объектов (до 10), которые уже содержат это значение.  На рисунке ниже, вы увидите, что значение атрибута имени участника-пользователя **<em>dhunt@blue.contoso.com</em>** уже существует на четыре других объектов.  Так как это новая функция в Windows Server 2012 R2, случайное Создание повторяющееся имя участника-пользователя и имена участников-служб в смешанной среде будет выполняться при контроллеры домена низкого уровня обработки попытка записи.  
  
![Уникальность имен участников-служб и участников-пользователей](media/SPN-and-UPN-uniqueness/GTR_ADDS_Fig05_Event2974ShowAllDups.gif)  
  
**Рис. SEQ Figure \\ \* событие 2974 ARABIC 3, отображены все объекты, содержащий повторяющееся имя участника-пользователя**  
  
> [!TIP]  
> Просмотрите события 2974s идентификатор регулярно до:  
>   
> -   идентифицировать попытки создать повторяющееся имя участника-пользователя или имена участников-служб  
> -   Определите объекты, которые уже содержат повторяющиеся значения  
  
8648 = «Сбой операции, поскольку имя участника-пользователя для добавления или изменения указан уникальный леса.»  
  
### <a name="setspn"></a>SetSPN:  
Setspn.exe имел имя участника-службы повторяющихся встроенные к нему с момента выпуска Windows Server 2008, при использовании **«-S»** параметр.  Вы можете обойти обнаружение дубликатов имени участника-службы с помощью **«-A»** тем не менее параметр.  Создание повторяющихся SPN блокируется при разработке для Windows Server 2012 R2 контроллера домена с помощью SetSPN с параметром - A.  Сообщение об ошибке, отображаемое при использовании параметра -S одинаков: «Повторяющееся имя участника-службы найден, операция прервана!»  
  
### <a name="adsiedit"></a>ADSIEDIT:  
  
```  
Operation failed. Error code: 0x21c8  
The operation failed because UPN value provided for addition/modification is not unique forest-wide.  
000021C8: AtrErr: DSID-03200BBA, #1: 0: 000021C8: DSID-03200BBA, problem 1005 (CONSTRAINT_ATT_TYPE), data 0, Att 90290 (userPrincipalName)  
```  
  
![Уникальность имен участников-служб и участников-пользователей](media/SPN-and-UPN-uniqueness/GTR_ADDS_Fig06_ADSI21c8.gif)  
  
**Рис. SEQ Figure \\ \* ARABIC 4 ошибка сообщения, отображаемого в ADSIEdit, при блокировке появлением повторяющееся имя участника-пользователя**  
  
### <a name="windows-powershell"></a>Windows PowerShell  
Windows Server 2012 R2:  
  
![Уникальность имен участников-служб и участников-пользователей](media/SPN-and-UPN-uniqueness/GTR_ADDS_Fig07_SetADUser2012.gif)  
  
PS выполнение из Server 2012, предназначенных для контроллера домена Windows Server 2012 R2.  
  
![Уникальность имен участников-служб и участников-пользователей](media/SPN-and-UPN-uniqueness/GTR_ADDS_Fig08_SetADUser2012R2.gif)  
  
DSAC.exe под управлением Windows Server 2012, предназначенных для контроллера домена Windows Server 2012 R2:  
  
![Уникальность имен участников-служб и участников-пользователей](media/SPN-and-UPN-uniqueness/GTR_ADDS_Fig09_UserCreateError.gif)  
  
**Рис. SEQ Figure \\ \* ошибка при создании пользователя ARABIC 5 DSAC на не - Windows Server 2012 R2 при ориентировании на Windows Server 2012 R2 DC**  
  
![Уникальность имен участников-служб и участников-пользователей](media/SPN-and-UPN-uniqueness/GTR_ADDS_Fig10_UserModError.gif)  
  
**Рис. SEQ Figure \\ \* ошибка изменения пользователя ARABIC 6 DSAC на не - Windows Server 2012 R2 при ориентировании на Windows Server 2012 R2 DC**  
  
### <a name="restore-of-an-object-that-would-result-in-a-duplicate-upn-fails"></a>Происходит сбой восстановления объекта, который приведет к появлению повторяющихся имени участника-пользователя:  
![Уникальность имен участников-служб и участников-пользователей](media/SPN-and-UPN-uniqueness/GTR_ADDS_Fig11_RestoreDupUPN.gif)  
  
![Уникальность имен участников-служб и участников-пользователей](media/SPN-and-UPN-uniqueness/GTR_ADDS_Fig12_RestoreDupUPNError.gif)  
  
Событие не регистрируется в том случае, когда объект не удается восстановить из-за повторяющихся имени участника-пользователя или имя участника-службы.  
  
Имя участника-пользователя объекта должно быть уникальным для ее для восстановления.  
  
1.  Определить имя участника-пользователя, который существует в объекте в корзину  
  
2.  Определите все объекты, которые имеют одинаковое значение  
  
3.  Удалите повторяющиеся UPN(s)  
  
### <a name="identify-the-conflicting-upn-on-the-deleted-objectusing-repadminexe"></a>Определить конфликтующие имени участника-пользователя на удаленные objectUsing repadmin.exe  
  
```  
Repadmin /showattr DCName "DN of deleted objects container" /subtree /filter:"(msDS-LastKnownRDN=<NAME>)" /deleted /atts:userprincipalname  
```  
  
```  
repadmin /showattr DCName "CN=Deleted Objects,DC=blue,DC=contoso,DC=com" /subtree /filter:"(msDS-LastKnownRDN=Dianne Hunt2)" /deleted /atts:userprincipalname  
  
C:\>repadmin /showattr winbluedc1 "cn=deleted objects,dc=blue,dc=contoso,dc=com" /subtree /filter:"(msds-lastknownrdn=Dianne Hunt2)" /deleted /atts:userprincipalname  
DN: CN=Dianne Hunt2\0ADEL:dd3ab8a4-3005-4f2f-814f-d6fc54a1a1c0,CN=Deleted Object  
s,DC=blue,DC=contoso,DC=com  
    1> userPrincipalName: dhunt@blue.contoso.com  
```  
  
### <a name="to-identify-all-objects-with-the-same-upnusing-repadminexe"></a>Для определения всех объектов с тем же именем участника-: с помощью Repadmin.exe  
  
```  
repadmin /showattr WinBlueDC1 "DC=blue,DC=contoso,DC=com" /subtree /filter:"(userPrincipalName=dhunt@blue.contoso.com)" /deleted /atts:DN  
  
C:\>repadmin /showattr winbluedc1 "dc=blue,dc=contoso,dc=com" /subtree /filter:"(userPrincipalName=dhunt@blue.contoso.com)" /deleted /atts:DN  
DN: CN=Administrator,CN=Users,DC=blue,DC=contoso,DC=com  
DN: CN=xouser1,CN=Users,DC=blue,DC=contoso,DC=com  
DN: CN=xouser10,CN=Users,DC=blue,DC=contoso,DC=com  
DN: CN=xouser100,CN=Users,DC=blue,DC=contoso,DC=com  
DN: CN=Dianne Hunt,OU=Marketing,DC=blue,DC=contoso,DC=com  
DN: CN=Dianne Hunt2\0ADEL:dd3ab8a4-3005-4f2f-814f-d6fc54a1a1c0,CN=Deleted Objects,DC=blue,DC=contoso,DC=com  
```  
  
> [!TIP]  
> Не документированный ранее **/ deleted** параметр в repadmin.exe используется для включения удаленных объектов в результирующем наборе  
  
### <a name="using-global-search"></a>С помощью глобального поиска  
  
-   Откройте Центр администрирования Active Directory и перейдите к **глобального поиска**  
  
-   Выберите **преобразовать в LDAP** "переключатель"  
  
-   Тип **(userPrincipalName =*ConflictingUPN*)**  
  
    -   Замените ***ConflictingUPN*** с фактическое имя участника-пользователя, который вызывает конфликт  
  
-   Выберите **применить**  
  
![Уникальность имен участников-служб и участников-пользователей](media/SPN-and-UPN-uniqueness/GTR_ADDS_Fig13_GlobalSearch.gif)  
  
### <a name="using-windows-powershell"></a>Использование Windows PowerShell  
  
```  
Get-ADObject -LdapFilter "(userPrincipalName=dhunt@blue.contoso.com)" -IncludeDeletedObjects -SearchBase "DC=blue,DC=Contoso,DC=com" -SearchScope Subtree -Server winbluedc1.blue.contoso.com  
```  
  
![Уникальность имен участников-служб и участников-пользователей](media/SPN-and-UPN-uniqueness/GTR_ADDS_Fig13_GlobalSearchPS.gif)  
  
Если объект необходимо восстановить, вы должны удалит повторяющиеся имена участников-пользователей из других объектов.  Только один объект достаточно простым, чтобы удалить дубликат с помощью средства ADSIEdit.  Если существует несколько объектов с дубликатами, Windows PowerShell может быть лучшего средства для использования.  
  
Значение NULL, если атрибут UserPrincipalName, с помощью Windows PowerShell:  
  
![Уникальность имен участников-служб и участников-пользователей](media/SPN-and-UPN-uniqueness/GTR_ADDS_Fig15_NullUPN.gif)  
  
> [!NOTE]  
> Атрибут userPrincipalName является однозначным, поэтому эта процедура удаляется только повторяющееся имя участника-пользователя.  
  
### <a name="duplicate-spn"></a>Повторяющееся имя участника-службы  
![Уникальность имен участников-служб и участников-пользователей](media/SPN-and-UPN-uniqueness/GTR_ADDS_Fig16_DupSPN.gif)  
  
**Рис. SEQ Figure \\ \* ARABIC 8 ошибка сообщения, отображаемого в ADSIEdit, при блокировке появлением повторяющееся имя участника-службы**  
  
В журнал событий служб каталогов **ActiveDirectory_DomainService** событие с Идентификатором **2974**.  
  
```  
Operation failed. Error code: 0x21c7  
The operation failed   
The attribute value provided is not unique in the forest or partition. Attribute:  
servicePrincipalName Value=<SPN>  
<Object DN> Winerror: 8467  
```  
  
![Уникальность имен участников-служб и участников-пользователей](media/SPN-and-UPN-uniqueness/GTR_ADDS_Fig17_DupSPN2974.gif)  
  
**Рис. SEQ Figure \\ \* ARABIC 9 ошибка при блокировании Создание повторяющееся имя участника-службы**  
  
### <a name="workflow"></a>Рабочий процесс  
  
-   **Если контроллер домена глобального Каталога ==**  
  
    -   Вызов не offbox обязательным, запрос может быть удовлетворено локально  
  
    -   ***Регистр имени участника-пользователя***  
  
        -   Локальный индекс имени участника-пользователя леса запросов для предоставленного имени участника-пользователя (*userPrincipalName; глобальный указатель*)  
  
            -   Если возвращены записи == 0 "->" выручка записи  
  
            -   Если возвращены записи! = 0 "->" происходит сбой записи  
  
                -   Запись в журнал  
  
                -   Также возвращает расширенное сообщение об ошибке:  
  
                    -   **8648:**  
  
                        *ERROR_DS_UPN_VALUE_NOT_UNIQUE_IN_FOREST*  
  
    -   ***Регистр имени участника-службы***  
  
        -   Локальный индекс имени участника-службы уровня леса запросов для предоставленного имени участника-службы (*servicePrincipalName; глобальный указатель*)  
  
            -   Если возвращены записи == 0 "->" выручка записи  
  
            -   Если возвращены записи! = 0 "->" происходит сбой записи  
  
                -   Запись в журнал  
  
                -   Также возвращает расширенное сообщение об ошибке:  
  
                    -   **8647:**  
  
                        **ERROR_DS_SPN_VALUE_NOT_UNIQUE_IN_FOREST**  
  
-   **Если контроллер домена! = GC**  
  
    -   Вызов Offbox **желательно** , но не критично, т. е. Это правило без гарантии уникальности проверяет  
  
        -   Проверка продолжается от локального информационного дерева КАТАЛОГА, только в том случае, если сборщик Мусора не удается найти  
  
        -   Чтобы указать, например запись в журнал  
  
    -   ***Регистр имени участника-пользователя***  
  
        -   Отправить запрос LDAP к ближайшей сборки Мусора? Индекс имени участника-пользователя леса запросов сборщика Мусора для предоставленного имени участника-пользователя (*userPrincipalName; глобальный указатель*)  
  
            -   Если возвращены записи == 0 "->" выручка записи  
  
            -   Если возвращены записи! = 0 "->" происходит сбой записи  
  
                -   Запись в журнал  
  
                -   Также возвращает расширенное сообщение об ошибке:  
  
                    -   **8648:**  
  
                        *ERROR_DS_UPN_VALUE_NOT_UNIQUE_IN_FOREST*  
  
    -   ***Регистр имени участника-службы***  
  
        -   Отправить запрос LDAP к ближайшей сборки Мусора? Индекс имени участника-службы запросов сборщика Мусора леса для предоставленного имени участника-службы (*servicePrincipalName; глобальный указатель*)  
  
            -   Если возвращены записи == 0 "->" выручка записи  
  
            -   Если возвращены записи! = 0 "->" происходит сбой записи  
  
                -   Запись в журнал  
  
                -   Также возвращает расширенное сообщение об ошибке:  
  
                    -   **8647:**  
  
                        *ERROR_DS_SPN_VALUE_NOT_UNIQUE_IN_FOREST*  
  
Когда повторно анимированных удаленные объекты, значения имени участника-службы или имя участника-пользователя, присутствующие проверяются на уникальность. Если найден дубликат, запрос отклоняется.  
  
-   Для изменения атрибутов, определенных как DNS-имя узла, и т.д. имя учетной записи SAM, после внесения изменений, имена участников-служб, обновляются соответствующим образом. В процессе будут удалены устаревшие имена участников-служб и создания новых имен участников-служб и добавлен в базу данных. Приведены изменения реквизитов атрибут, по которым запускается этот путь.  
  
    -   ATT_DNS_HOST_NAME  
  
    -   ATT_MS_DS_ADDITIONAL_DNS_HOST_NAME  
  
    -   ATT_SAM_ACCOUNT_NAME  
  
    -   ATT_MS_DS_ADDITIONAL_SAM_ACCOUNT_NAME  
  
    -   ATT_SERVER_REFERENCE_BL  
  
    -   ATT_USER_ACCOUNT_CONTROL  
  
Если любой из новое значение имени участника-службы является дубликатом, мы не изменение. Приведенного выше списка важные атрибуты являются ATT_DNS_HOST_NAME (имя компьютера) и ATT_SAM_ACCOUNT_NAME (имя учетной записи SAM).  
  
### <a name="try-this-exploring-spn-and-upn-uniqueness"></a>Попробуйте выполните следующее: Изучение уникальность  
Это первое из нескольких "**попробовать сделать это**" действий в модуле.  Руководство по отдельную лабораторную среду для этого модуля не существует.  **Попробовать сделать это** действия являются по сути действий свободной формы, которые позволяют изучить материалы занятие в лабораторной среде.  У вас параметр, выполнив в командной строке или выходить за пределы скрипта и придумать собственных действий.  
  
> [!NOTE]  
> -   Это первое из нескольких "**попробовать сделать это**" действия.  
> -   Руководство по отдельную лабораторную среду для этого модуля не существует.  
> -   **Попробовать сделать это** действия являются по сути действий свободной формы, которые позволяют изучить материалы занятие в лабораторной среде.  
> -   У вас параметр, выполнив в командной строке или выходить за пределы скрипта и придумать собственных действий.  
> -   Хотя не все разделы имеют **попробовать сделать это** строке, вы по-прежнему рекомендуется изучить содержимое занятие в лабораторной среде, где это необходимо.  
  
Поэкспериментируйте с уникальность.  Выполните эти запросы или выполните собственный.  
  
1.  Создание новых пользователей с помощью имени участника-пользователя  
  
2.  Создание учетных записей с помощью имен участников-служб  
  
3.  Создание нового пользователя с помощью имени участника-пользователя ранее уже определен, либо измените существующую учетную запись имени участника-пользователя.  Повторите эту операцию для имени участника-службы на другую учетную запись  
  
    1.  Учетная запись пользователя с UPN используется заполнение  
  
        1.  С помощью центра администрирования PowerShell, ADSIEDIT или Active Directory (DSAC.exe)  
  
    2.  Заполнение существующую учетную запись с помощью имени субъекта-службы уже используется  
  
        1.  С помощью Windows PowerShell, SetSPN или ADSIEDIT  
  
4.  Просмотрите ошибки  
  
**(Необязательно)**  
  
1.  Уточните преподавателя аудитории, что это ОК, чтобы включить *[Корзина AD](https://technet.microsoft.com/library/jj574144.aspx#BKMK_EnableRecycleBin)* в центр администрирования Active Directory.  Если Да, перейти к следующему шагу.  
  
2.  Заполнение имени участника-пользователя для учетной записи пользователя  
  
3.  Удаление учетной записи  
  
4.  Заполнение другую учетную запись с помощью имени участника-пользователя, как удаленная учетная запись  
  
5.  Попытка использовать графический пользовательский Интерфейс корзины Bin, чтобы восстановить учетную запись  
  
6.  Представьте, что вы только что были выведены ошибки, которые вы видите на предыдущем шаге.  (и не быть История действия, которые вы только что выполнили) Задача — для завершения восстановления учетной записи.  См. в разделе, например шаги книги.  
  


