---
ms.assetid: 40bc24b1-2e7d-4e77-bd0f-794743250888
title: "Уникальность имен участников-СЛУЖБ и имя участника-пользователя"
description: 
author: billmath
ms.author: billmath
manager: femila
ms.date: 05/31/2017
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: identity-adds
ms.openlocfilehash: 81d686c81082ad29384585d541c1304d654e1924
ms.sourcegitcommit: db290fa07e9d50686667bfba3969e20377548504
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/12/2017
---
# <a name="spn-and-upn-uniqueness"></a>Уникальность имен участников-СЛУЖБ и имя участника-пользователя

>Область применения: Windows Server 2016, Windows Server 2012 R2, Windows Server 2012

**Автор**: Джастин Тернер, старший инженер по улучшению поддержки с группой Windows  
  
> [!NOTE]  
> Этот материал создан инженером поддержки клиентов Майкрософт и предназначен для опытных администраторов и архитекторов систем, которым нужны более глубокие технические сведения о функциях и решениях в Windows Server 2012 R2, чем обычно предоставляют разделов на TechNet. Однако он не проходил же редактирования этапах, поэтому некоторые формулировки могут быть то, что обычно станицах на сайте TechNet.  
  
## <a name="overview"></a>Обзор  
Контроллеры домена под управлением Windows Server 2012 R2 блокировать создание повторяющиеся имена участников-служб (SPN) и имена участников-пользователей (UPN). Это относится и к восстановления или восстановление удаленного объекта или переименование объекта приведет дубликат.  
  
### <a name="background"></a>Фон  
Дублирующиеся имена (Субъекта-службы) часто возникает и привести к сбою проверки подлинности и может привести к чрезмерного использования Процессора LSASS. Не существует в поле метода, чтобы запретить добавление дубликат имени участника-службы или имя участника-пользователя. *  
  
Повторяющиеся значения имя участника-пользователя к нарушению синхронизации между локальной AD и Office 365.  
  
*Setspn.exe обычно используется для создания нового имена участников-служб и функционально был создан в версии, выпущенной с Windows Server 2008, который добавляет проверку на наличие дубликатов.  
  
**Таблица SEQ Table \\\ * ARABIC 1: уникальность имени участника-пользователя и имя участника-службы**  
  
|Функция|Комментарий|  
|-----------|-----------|  
|Уникальность имени участника-пользователя|Повторяющиеся имена участников-пользователей разрыва синхронизации локальные учетные записи AD с AD под управлением служб Windows Azure, такие как Office 365.|  
|Уникальность имени участника-службы|Имена участников-служб требуется Kerberos для взаимной проверки подлинности.  Повторяющиеся имена участников-служб привести к сбою проверки подлинности.|  
  
Дополнительные сведения о требованиях к уникальность имен участников-пользователей и имен субъектов-служб см. в разделе [ограничения уникальности](https://msdn.microsoft.com/library/dn392337.aspx).  
  
## <a name="symptoms"></a>Симптомы  
Коды ошибок 8467 или 8468 или их hex, символические эквиваленты строку, в журнале и в различных на экране диалоги и в событие 2974 идентификатор в журнале событий служб каталогов. Попытка создать дубликат имени участника-пользователя или имя участника-службы блокируется только при следующих условиях:  
  
-   Запись обрабатывается с контроллера домена Windows Server 2012 R2  
  
**Таблица SEQ Table \\\ * ARABIC 2: коды ошибок уникальность имени участника-пользователя и имя участника-службы**  
  
|Десятичный|Hex|Символьные|Строка|  
|-----------|-------|------------|----------|  
|8467|21C 7|ERROR_DS_SPN_VALUE_NOT_UNIQUE_IN_FOREST|Произошел сбой операции, так как значение параметра имя субъекта-службы для добавления или изменения не уникальный на уровне леса.|  
|8648|21C 8|ERROR_DS_UPN_VALUE_NOT_UNIQUE_IN_FOREST|Произошел сбой операции, поскольку имя участника-пользователя значение, указанное для добавления или изменения не уникальный на уровне леса.|  
  
## <a name="new-user-creation-fails-if-upn-is-not-unique"></a>Создание нового пользователя завершается сбоем, если имя участника-пользователя, не является уникальным  
  
### <a name="dsamsc"></a>DSA.msc  
Имя входа пользователя, который вы выбрали уже используется на данном предприятии. Выберите другое имя для входа в систему, а затем повторите попытку.  
  
![Уникальность имен участников-СЛУЖБ и имя участника-пользователя](media/SPN-and-UPN-uniqueness/GTR_ADDS_Fig01_DupUPN.gif)  
  
Изменение существующей учетной записи:  
  
Имя входа пользователя уже существует на предприятии. Укажите новое, либо путем изменения префикс или выбрав другой суффикс из списка.  
  
![Уникальность имен участников-СЛУЖБ и имя участника-пользователя](media/SPN-and-UPN-uniqueness/GTR_ADDS_Fig02_DupUPNMod.gif)  
  
### <a name="active-directory-administrative-center-dsacexe"></a>Центр администрирования Active Directory (DSAC.exe)  
Попытка создать нового пользователя в центр администрирования Active Directory с помощью имени участника-пользователя, который уже существует, получится следующая ошибка.  
  
![Уникальность имен участников-СЛУЖБ и имя участника-пользователя](media/SPN-and-UPN-uniqueness/GTR_ADDS_Fig03_DupUPNADAC.gif)  
  
**Рис. SEQ Figure \\\ * ARABIC 1 ошибки отображаются в центре администрирования AD, при сбое создания новых пользователей из-за повторяющихся имя участника-пользователя**  
  
### <a name="event-2974-source-activedirectorydomainservice"></a>Событие 2974 источника: ActiveDirectory_DomainService  
![Уникальность имен участников-СЛУЖБ и имя участника-пользователя](media/SPN-and-UPN-uniqueness/GTR_ADDS_Fig04_Event2974.gif)  
  
**Рис. SEQ Figure \\\ * ARABIC 2 2974 идентификатор события с ошибкой 8648**  
  
Событие 2974 перечислены значения, который был заблокирован и список объектов одного или нескольких (до 10), уже содержащие это значение.  На следующем рисунке, вы увидите, что значение атрибута имени участника-пользователя *** dhunt@blue.contoso.com *** на четыре объекта уже существует.  Так как это новая функция в Windows Server 2012 R2, случайное Создание дубликат имени участника-пользователя и имена участников-служб в смешанной среде, по-прежнему будет возникать при попытки записи обработать нижнего уровня контроллеров домена.  
  
![Уникальность имен участников-СЛУЖБ и имя участника-пользователя](media/SPN-and-UPN-uniqueness/GTR_ADDS_Fig05_Event2974ShowAllDups.gif)  
  
**Рис. SEQ Figure \\\ * ARABIC 3 событие 2974, показывает все объекты, содержащие дубликат имени участника-пользователя**  
  
> [!TIP]  
> Просмотрите событие с ИД 2974s регулярно в:  
>   
> -   Определите попытается создать дубликат имени участника-пользователя или имена участников-служб  
> -   Определите объекты, которые уже содержат дубликаты  
  
8648 = «Операция не удалась, поскольку значение имени участника-пользователя, указанное для добавления или изменения не является уникальным на уровне леса.»  
  
### <a name="setspn"></a>SetSPN:  
Setspn.exe наблюдалось SPN повторяющихся встроенных к нему с момента выпуска Windows Server 2008, при использовании **«-S»** параметр.  Дубликат имени участника-службы обнаружения можно обойти с помощью **»-A»** Однако вариант.  Создание повторяющихся имен субъектов-служб будет заблокирована при нацеливании на Windows Server 2012 R2 контроллера домена с помощью SetSPN с параметром -.  Сообщение об ошибке будет таким же, как при использовании параметра -S отображается: «Дубликат имени участника-службы найден, вызвавшей прерывание операции!»  
  
### <a name="adsiedit"></a>ADSIEDIT:  
  
```  
Operation failed. Error code: 0x21c8  
The operation failed because UPN value provided for addition/modification is not unique forest-wide.  
000021C8: AtrErr: DSID-03200BBA, #1: 0: 000021C8: DSID-03200BBA, problem 1005 (CONSTRAINT_ATT_TYPE), data 0, Att 90290 (userPrincipalName)  
```  
  
![Уникальность имен участников-СЛУЖБ и имя участника-пользователя](media/SPN-and-UPN-uniqueness/GTR_ADDS_Fig06_ADSI21c8.gif)  
  
**Рис. SEQ Figure \\\ * ARABIC 4 сообщение появляется в ADSIEdit при блокировке Добавление дубликат имени участника-пользователя**  
  
### <a name="windows-powershell"></a>Windows PowerShell  
Windows Server 2012 R2:  
  
![Уникальность имен участников-СЛУЖБ и имя участника-пользователя](media/SPN-and-UPN-uniqueness/GTR_ADDS_Fig07_SetADUser2012.gif)  
  
PS запуске из Server 2012, предназначенные для контроллера домена Windows Server 2012 R2:  
  
![Уникальность имен участников-СЛУЖБ и имя участника-пользователя](media/SPN-and-UPN-uniqueness/GTR_ADDS_Fig08_SetADUser2012R2.gif)  
  
DSAC.exe под управлением Windows Server 2012, предназначенные для контроллера домена Windows Server 2012 R2:  
  
![Уникальность имен участников-СЛУЖБ и имя участника-пользователя](media/SPN-and-UPN-uniqueness/GTR_ADDS_Fig09_UserCreateError.gif)  
  
**Рис. SEQ Figure \\\ * Ошибка создания пользователя ARABIC 5 DSAC на не — Windows Server 2012 R2 при предназначенные для Windows Server 2012 R2, контроллера домена**  
  
![Уникальность имен участников-СЛУЖБ и имя участника-пользователя](media/SPN-and-UPN-uniqueness/GTR_ADDS_Fig10_UserModError.gif)  
  
**Рис. SEQ Figure \\\ * Ошибка изменения пользователя ARABIC 6 DSAC на не — Windows Server 2012 R2 при предназначенные для Windows Server 2012 R2, контроллера домена**  
  
### <a name="restore-of-an-object-that-would-result-in-a-duplicate-upn-fails"></a>Не удается выполнить восстановление объекта, которое приведет дубликат имени участника-пользователя:  
![Уникальность имен участников-СЛУЖБ и имя участника-пользователя](media/SPN-and-UPN-uniqueness/GTR_ADDS_Fig11_RestoreDupUPN.gif)  
  
![Уникальность имен участников-СЛУЖБ и имя участника-пользователя](media/SPN-and-UPN-uniqueness/GTR_ADDS_Fig12_RestoreDupUPNError.gif)  
  
Событие не регистрируется в том случае, если объект не удается восстановить из-за повторяющихся имя участника-пользователя или имя участника-службы.  
  
Имя участника-пользователя объекта, должно быть уникальным для его для восстановления.  
  
1.  Определить имя участника-пользователя, который существует на объект в корзину  
  
2.  Определите все объекты, которые имеют одинаковое значение  
  
3.  Удалите дублирующиеся UPN(s)  
  
### <a name="identify-the-conflicting-upn-on-the-deleted-objectusing-repadminexe"></a>Определить конфликтующие имя участника-пользователя на repadmin.exe удаленные objectUsing  
  
```  
Repadmin /showattr DCName "DN of deleted objects container" /subtree /filter:"(msDS-LastKnownRDN=<NAME>)" /deleted /atts:userprincipalname  
```  
  
```  
repadmin /showattr DCName "CN=Deleted Objects,DC=blue,DC=contoso,DC=com" /subtree /filter:"(msDS-LastKnownRDN=Dianne Hunt2)" /deleted /atts:userprincipalname  
  
C:\>repadmin /showattr winbluedc1 "cn=deleted objects,dc=blue,dc=contoso,dc=com" /subtree /filter:"(msds-lastknownrdn=Dianne Hunt2)" /deleted /atts:userprincipalname  
DN: CN=Dianne Hunt2\0ADEL:dd3ab8a4-3005-4f2f-814f-d6fc54a1a1c0,CN=Deleted Object  
s,DC=blue,DC=contoso,DC=com  
    1> userPrincipalName: dhunt@blue.contoso.com  
```  
  
### <a name="to-identify-all-objects-with-the-same-upnusing-repadminexe"></a>Для идентификации всех объектов с помощью того же имени участника-пользователя: с помощью Repadmin.exe  
  
```  
repadmin /showattr WinBlueDC1 "DC=blue,DC=contoso,DC=com" /subtree /filter:"(userPrincipalName=dhunt@blue.contoso.com)" /deleted /atts:DN  
  
C:\>repadmin /showattr winbluedc1 "dc=blue,dc=contoso,dc=com" /subtree /filter:"(userPrincipalName=dhunt@blue.contoso.com)" /deleted /atts:DN  
DN: CN=Administrator,CN=Users,DC=blue,DC=contoso,DC=com  
DN: CN=xouser1,CN=Users,DC=blue,DC=contoso,DC=com  
DN: CN=xouser10,CN=Users,DC=blue,DC=contoso,DC=com  
DN: CN=xouser100,CN=Users,DC=blue,DC=contoso,DC=com  
DN: CN=Dianne Hunt,OU=Marketing,DC=blue,DC=contoso,DC=com  
DN: CN=Dianne Hunt2\0ADEL:dd3ab8a4-3005-4f2f-814f-d6fc54a1a1c0,CN=Deleted Objects,DC=blue,DC=contoso,DC=com  
```  
  
> [!TIP]  
> Ранее недокументированные **/ удален** в repadmin.exe параметр используется для включения удаленные объекты в набор результатов  
  
### <a name="using-global-search"></a>С помощью глобального поиска  
  
-   Откройте Центр администрирования Active Directory и перейдите к **глобального поиска**  
  
-   Выберите **преобразовать в LDAP** переключатель  
  
-   Тип * *(userPrincipalName =*ConflictingUPN*) **  
  
    -   Замените ***ConflictingUPN*** с фактическое имя участника-пользователя, конфликтным  
  
-   Выберите **применения**  
  
![Уникальность имен участников-СЛУЖБ и имя участника-пользователя](media/SPN-and-UPN-uniqueness/GTR_ADDS_Fig13_GlobalSearch.gif)  
  
### <a name="using-windows-powershell"></a>С помощью Windows PowerShell  
  
```  
Get-ADObject -LdapFilter "(userPrincipalName=dhunt@blue.contoso.com)" -IncludeDeletedObjects -SearchBase "DC=blue,DC=Contoso,DC=com" -SearchScope Subtree -Server winbluedc1.blue.contoso.com  
```  
  
![Уникальность имен участников-СЛУЖБ и имя участника-пользователя](media/SPN-and-UPN-uniqueness/GTR_ADDS_Fig13_GlobalSearchPS.gif)  
  
Если объект необходимо восстановить, должны удаления повторяющихся имен участников-пользователей с другими объектами.  Он очень проста удалить дубликат с помощью средства ADSIEdit только один объект.  Если существует несколько объектов с дубликаты, Windows PowerShell может быть средство лучше использовать.  
  
Обнулить атрибут UserPrincipalName, с помощью Windows PowerShell:  
  
![Уникальность имен участников-СЛУЖБ и имя участника-пользователя](media/SPN-and-UPN-uniqueness/GTR_ADDS_Fig15_NullUPN.gif)  
  
> [!NOTE]  
> Атрибут userPrincipalName является однозначного атрибута, поэтому эта процедура будет только удалить дубликат имени участника-пользователя.  
  
### <a name="duplicate-spn"></a>Повторяющееся имя участника-службы  
![Уникальность имен участников-СЛУЖБ и имя участника-пользователя](media/SPN-and-UPN-uniqueness/GTR_ADDS_Fig16_DupSPN.gif)  
  
**Рис. SEQ Figure \\\ * ARABIC 8 сообщение появляется в ADSIEdit при блокировке Добавление повторяющихся имен субъектов-служб**  
  
Записанные в журнал событий служб каталогов **ActiveDirectory_DomainService** событие с Идентификатором **2974**.  
  
```  
Operation failed. Error code: 0x21c7  
The operation failed   
The attribute value provided is not unique in the forest or partition. Attribute:  
servicePrincipalName Value=<SPN>  
<Object DN> Winerror: 8467  
```  
  
![Уникальность имен участников-СЛУЖБ и имя участника-пользователя](media/SPN-and-UPN-uniqueness/GTR_ADDS_Fig17_DupSPN2974.gif)  
  
**Рис. SEQ Figure \\\ * ARABIC 9 ошибка, зарегистрированная при блокировке Создание повторяющихся имен субъектов-служб**  
  
### <a name="workflow"></a>Рабочий процесс  
  
-   **Если контроллер домена == глобального Каталога**  
  
    -   Вызов не offbox необходимые запроса, можно удовлетворить локально  
  
    -   ***Случай имя участника-пользователя***  
  
        -   Локальный индекс UPN леса запроса для предоставленных имя участника-пользователя (*userPrincipalName; глобального индекс*)  
  
            -   Если возвращено записей == 0 -> доход от записи  
  
            -   Если возвращено записей! = 0 "->" Сбой записи  
  
                -   Событие регистрируется  
  
                -   Также возвращает расширенное сообщение об ошибке:  
  
                    -   **8648:**  
  
                        *ERROR_DS_UPN_VALUE_NOT_UNIQUE_IN_FOREST*  
  
    -   ***Регистр имени участника-службы***  
  
        -   Локальный индекс SPN леса запроса для предоставленных имя участника-службы (*servicePrincipalName; глобального индекс*)  
  
            -   Если возвращено записей == 0 -> доход от записи  
  
            -   Если возвращено записей! = 0 "->" Сбой записи  
  
                -   Событие регистрируется  
  
                -   Также возвращает расширенное сообщение об ошибке:  
  
                    -   **8647:**  
  
                        **ERROR_DS_SPN_VALUE_NOT_UNIQUE_IN_FOREST**  
  
-   **Если контроллер домена! = глобального Каталога**  
  
    -   Вызов Offbox **желательно** , но не критическая ошибка, т. е. Это проверка уникальности усилия  
  
        -   Проверка продолжается от локального DIT только в том случае, если не удается найти сборку Мусора  
  
        -   Событие регистрируется для указания таких  
  
    -   ***Случай имя участника-пользователя***  
  
        -   Отправить запрос LDAP к ближайшего глобального Каталога? Индекс UPN леса запроса сборщика Мусора для предоставленных имя участника-пользователя (*userPrincipalName; глобального индекс*)  
  
            -   Если возвращено записей == 0 -> доход от записи  
  
            -   Если возвращено записей! = 0 "->" Сбой записи  
  
                -   Событие регистрируется  
  
                -   Также возвращает расширенное сообщение об ошибке:  
  
                    -   **8648:**  
  
                        *ERROR_DS_UPN_VALUE_NOT_UNIQUE_IN_FOREST*  
  
    -   ***Регистр имени участника-службы***  
  
        -   Отправить запрос LDAP к ближайшего глобального Каталога? Индекс SPN леса запроса сборщика Мусора для предоставленных имя участника-службы (*servicePrincipalName; глобального индекс*)  
  
            -   Если возвращено записей == 0 -> доход от записи  
  
            -   Если возвращено записей! = 0 "->" Сбой записи  
  
                -   Событие регистрируется  
  
                -   Также возвращает расширенное сообщение об ошибке:  
  
                    -   **8647:**  
  
                        *ERROR_DS_SPN_VALUE_NOT_UNIQUE_IN_FOREST*  
  
Когда повторно анимированные удаленные объекты, присутствуют значения имя участника-службы или имя участника-пользователя проверяется уникальность имен. Если найден копию, запрос завершится ошибкой.  
  
-   Для изменения атрибутов, определенные как имя узла DNS и т.д имя учетной записи SAM, когда вносится изменение, имена участников-служб обновляются соответствующим образом. В процессе устаревшие имена участников-служб будут удалены и новые имена участников-служб, сформированного и добавляются в базу данных. Ниже перечислены изменения необходимых атрибутов, по которым активируется этот путь  
  
    -   ATT_DNS_HOST_NAME  
  
    -   ATT_MS_DS_ADDITIONAL_DNS_HOST_NAME  
  
    -   ATT_SAM_ACCOUNT_NAME  
  
    -   ATT_MS_DS_ADDITIONAL_SAM_ACCOUNT_NAME  
  
    -   ATT_SERVER_REFERENCE_BL  
  
    -   ATT_USER_ACCOUNT_CONTROL  
  
Если какие-либо нового значения имя участника-службы является дубликатом, происходит сбой изменения. Выше списка важные атрибуты, ATT_DNS_HOST_NAME (имя компьютера) и ATT_SAM_ACCOUNT_NAME (имя учетной записи SAM).  
  
### <a name="try-this-exploring-spn-and-upn-uniqueness"></a>Выполните следующие действия: Уникальность изучить имя участника-службы и имя участника-пользователя  
Это первое из нескольких «**попробуйте это**«действия в модуле.  Не существует отдельный руководство для этого модуля.  **Попробуйте это** действий, по сути произвольной формы действия, позволяющие изучить материал урок в лабораторной среде.  Параметр, выполнив в командной строке или выходить за пределы сценария и придумывают собственных действий.  
  
> [!NOTE]  
> -   Это первое из нескольких «**попробуйте это**» действий.  
> -   Не существует отдельный руководство для этого модуля.  
> -   **Попробуйте это** действий, по сути произвольной формы действия, позволяющие изучить материал урок в лабораторной среде.  
> -   Параметр, выполнив в командной строке или выходить за пределы сценария и придумывают собственных действий.  
> -   А не во всех разделах **попробуйте это** строки, вы, по-прежнему рекомендуется для изучения урок содержимого в лабораторной среде, где это применимо.  
  
Поэкспериментируйте с уникальность имен участников-СЛУЖБ и имя участника-пользователя.  Следуйте этим инструкциям или завершить собственный.  
  
1.  Создание новых пользователей с помощью имени участника-пользователя  
  
2.  Создайте учетные записи с имена участников-служб  
  
3.  Создание нового пользователя с имя участника-пользователя уже ранее определенные, либо измените имя участника-пользователя существующую учетную запись.  Сделайте то же самое для имени участника-службы на другую учетную запись  
  
    1.  Заполнение с имя участника-пользователя, уже существующей учетной записи  
  
        1.  Через Центр администрирования Active Directory, PowerShell или ADSIEDIT (DSAC.exe)  
  
    2.  Заполнить с помощью имени участника-службы, уже существующую учетную запись  
  
        1.  С помощью Windows PowerShell, средства ADSIEDIT или SetSPN  
  
4.  Просмотрите ошибки  
  
**(Необязательно)**  
  
1.  Проверить с помощью класса преподаватель его ОК, чтобы включить * [Корзина AD](https://technet.microsoft.com/library/jj574144.aspx#BKMK_EnableRecycleBin) * в центре администрирования Active Directory.  Если Да, перейти к следующему шагу.  
  
2.  Заполнение имя участника-пользователя для учетной записи пользователя  
  
3.  Удаление учетной записи  
  
4.  Заполнение другую учетную запись с имя участника-пользователя, как удаленную учетную запись  
  
5.  Попытка восстановить с помощью графического интерфейса пользователя Bin утилизировать учетной записи  
  
6.  Представьте, что вы просто были представлены ошибки, которые будут отображаться в предыдущем шаге.  (а не имеют журнал действий, которые вы выполнили) Задача — для завершения восстановления учетной записи.  В разделе книги, например шаги.  
  


