---
ms.assetid: b11f7a65-ec7b-4c11-8dc4-d7cabb54cd94
title: Устранение неполадок репликации Active Directory
author: MicrosoftGuyJFlo
ms.author: joflore
manager: mtillman
ms.date: 05/31/2017
ms.topic: article
ms.openlocfilehash: 630ba90cd2e5c00753b707754d32530b38c8db8d
ms.sourcegitcommit: dfa48f77b751dbc34409aced628eb2f17c912f08
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/07/2020
ms.locfileid: "87941623"
---
# <a name="troubleshooting-active-directory-replication-problems"></a>Устранение неполадок репликации Active Directory

>Область применения. Windows Server 2016, Windows Server 2012 R2, Windows Server 2012

Active Directory проблемы репликации могут иметь несколько различных источников. Например, проблемы системы доменных имен (DNS), проблемы с сетью или проблемы безопасности могут привести к сбою Active Directory репликации.

Оставшаяся часть этого раздела посвящена средствам и общей методологии для устранения ошибок Active Directory репликации. В следующих подразделах рассматриваются признаки, причины и способы устранения конкретных ошибок репликации.

## <a name="introduction-and-resources-for-troubleshooting-active-directory-replication"></a>Общие сведения и ресурсы для устранения неполадок Active Directory репликации

Сбой входящей или исходящей репликации приводит к тому, что Active Directory объекты, представляющие топологию репликации, расписание репликации, контроллеры домена, пользователей, компьютеры, пароли, группы безопасности, членство в группах и групповая политика, будут несогласованными между контроллерами домена. Несогласованность каталогов и репликация приводят к сбоям или несогласованным результатам, в зависимости от контроллера домена, к которому обращается операция, и может помешать приложению групповая политика и разрешения на управление доступом. Домен Active Directory службы (AD DS) зависят от сетевого подключения, разрешения имен, проверки подлинности и авторизации, базы данных каталога, топологии репликации и механизма репликации. Если основная причина проблемы репликации не очевидна, определение причины из множества возможных причин требует систематического исключения вероятных причин.

Сведения об инструментах, основанных на пользовательском интерфейсе, для отслеживания репликации и диагностики ошибок см. в разделе [состояние репликации Active Directory Tool](https://www.microsoft.com/download/details.aspx?id=30005) .

Полный документ, в котором описывается, как можно использовать средство Repadmin для устранения неполадок Active Directory репликации. см. раздел [мониторинг и устранение неполадок Active Directory репликации с помощью repadmin](https://go.microsoft.com/fwlink/?LinkId=122830).

Сведения о том, как работает репликация Active Directory, см. в следующих технических справочниках:

- [Технический справочник по модели репликации Active Directory](https://go.microsoft.com/fwlink/?LinkId=65958)
- [Технический справочник по топологии репликации Active Directory](https://go.microsoft.com/fwlink/?LinkId=93578)

## <a name="event-and-tool-solution-recommendations"></a>Рекомендации по решению для событий и средств

В идеале события Red (Error) и Yellow (Warning) в журнале событий службы каталогов предполагают определенное ограничение, вызывающее сбой репликации на исходном или целевом контроллере домена. Если в сообщении о событии предлагаются шаги для решения, попробуйте выполнить действия, описанные в этом событии. Средство Repadmin и другие средства диагностики также предоставляют сведения, которые могут помочь при устранении сбоев репликации.

Подробные сведения об использовании средства Repadmin для устранения неполадок, связанных с репликацией, см. в разделе [мониторинг и устранение неполадок Active Directory репликации с помощью repadmin](https://go.microsoft.com/fwlink/?LinkId=122830).

## <a name="ruling-out-intentional-disruptions-or-hardware-failures"></a>Исключение намеренных нарушений или сбоев оборудования

Иногда ошибки репликации возникают из-за преднамеренных нарушений. Например, при устранении неполадок, связанных с репликацией Active Directory, необходимо сначала поочередно отменять подключения и сбои оборудования или обновления.

### <a name="intentional-disconnections"></a>Намеренные отключения

Если контроллер домена, который попытается выполнить репликацию с помощью контроллера домена, который был создан на промежуточном сайте и в настоящее время ожидает развертывания на окончательном рабочем сайте (удаленном сайте, таком как филиал), сообщает об ошибках репликации, можно учитывать эти ошибки репликации. Чтобы не разделять контроллер домена от топологии репликации для расширенных периодов, что вызывает непрерывные ошибки до повторного подключения контроллера домена, рассмотрите возможность добавления таких компьютеров изначально в качестве рядовых серверов и использования метода установки с носителя для установки служб домен Active Directory Services (AD DS). Программу командной строки Ntdsutil можно использовать для создания установочного носителя, который можно хранить на съемных носителях (компакт-диск, DVD-диск или другой носитель) и поставлять на конечный сайт. Затем можно использовать установочный носитель для установки AD DS на контроллерах домена на сайте без использования репликации.

### <a name="hardware-failures-or-upgradestitle"></a>Сбои оборудования или обновления</title>

Если проблемы с репликацией возникают в результате сбоя оборудования (например, из-за сбоя материнской платы, дисковой подсистемы или жесткого диска), сообщите владельцу сервера о том, что проблему с оборудованием можно устранить.

Периодическое обновление оборудования также может привести к невозможности обслуживания контроллеров домена. Убедитесь, что владельцы сервера имеют хорошую систему связи с такими простоями заранее.

### <a name="firewall-configuration"></a>Настройка брандмауэра

По умолчанию Active Directory репликация удаленных вызовов процедур (RPC) выполняется динамически через доступный порт через сопоставитель конечных точек RPC (RPCSS) через порт 135. Убедитесь, что брандмауэр Windows в расширенной безопасности и другие брандмауэры настроены правильно, чтобы разрешить репликацию. Сведения об указании порта для параметров репликации Active Directory и портов см. [в статье 224196 базы знаний Майкрософт](https://go.microsoft.com/fwlink/?LinkId=22578).

Дополнительные сведения о портах, которые Active Directory репликации, см. в разделе [Active Directory средства и параметры репликации](https://go.microsoft.com/fwlink/?LinkId=123774).

Сведения об управлении репликацией Active Directory через брандмауэры см. в разделе [Active Directory репликация через брандмауэры](https://go.microsoft.com/fwlink/?LinkId=123775).

## <a name="responding-to-failure-of-an-outdated-server-running-windows-2000-server"></a>Реагирование на сбой устаревшего сервера под Windows 2000 Server

Если контроллер домена под Windows 2000 Server не работает дольше, чем число дней в течение времени существования захоронения, решение всегда будет таким же:

1. Переместите сервер из корпоративной сети в частную сеть.
2. Либо принудительно удалите Active Directory, либо переустановите операционную систему.
3. Удалите метаданные сервера из Active Directory, чтобы объект сервера не реанимированным.

Для очистки метаданных сервера в большинстве операционных систем Windows можно использовать сценарий. Сведения об использовании этого скрипта см. в разделе [Удаление метаданных контроллера домен Active Directory](https://go.microsoft.com/fwlink/?LinkID=123599).

По умолчанию удаленные объекты NTDS Settings реанимированным автоматически в течение 14 дней. Поэтому, если не удалить метаданные сервера (используйте Ntdsutil или сценарий, упомянутый ранее для выполнения очистки метаданных), метаданные сервера будут восстановлены в каталоге, в котором будут предложены попытки репликации. В этом случае ошибки будут регистрироваться постоянно в результате невозможности репликации с отсутствующим контроллером домена.

## <a name="root-causes"></a>Основные причины

При истечении преднамеренных отключений, сбоев оборудования и устаревших контроллеров домена Windows 2000, в оставшейся части проблем репликации почти всегда есть одна из следующих причин:

- Подключение к сети. возможно, сетевое подключение недоступно или параметры сети настроены неправильно.
- Разрешение имен. нестандартные настройки DNS являются распространенной причиной сбоев репликации.
- Проверка подлинности и авторизация. проблемы проверки подлинности и авторизации приводят к ошибкам "отказано в доступе", когда контроллер домена пытается подключиться к участнику репликации.
- База данных каталогов (хранилище). возможно, база данных каталогов не может быстро обрабатывать транзакции, чтобы поддерживать время ожидания репликации.
- Модуль репликации. Если расписания межсайтовой репликации слишком короткие, очереди репликации могут быть слишком большими для обработки в течение времени, необходимого для расписания исходящей репликации. В этом случае репликация некоторых изменений может быть остановлена неограниченное время, достаточно долго для превышения времени существования захоронения.
- Топология репликации. контроллеры домена должны иметь межсайтовые ссылки в AD DS, которые сопоставляются с сетями глобальной сети (WAN) или виртуальными частными сетями (VPN). При создании объектов в AD DS для топологии репликации, которая не поддерживается реальной топологией сайта вашей сети, репликация, для которой требуется неправильно настроенная топология, завершается сбоем.

## <a name="general-approach-to-fixing-problems"></a>Общий подход к устранению проблем

Используйте следующий общий подход к устранению проблем репликации:

1. Отслеживайте работоспособность репликации ежедневно или используйте Repadmin.exe для получения состояния репликации ежедневно.
2. Попытайтесь своевременно устранить все ошибки, используя методы, описанные в сообщениях о событиях и данном руководством. Если программное обеспечение может вызвать проблему, удалите его, прежде чем продолжить работу с другими решениями.
3. Если проблема, вызывающая сбой репликации, не может быть устранена какими-либо известными методами, удалите AD DS с сервера, а затем переустановите AD DS. Дополнительные сведения о переустановке AD DS см. в разделе [списание контроллера домена](https://go.microsoft.com/fwlink/?LinkId=128290).
4. Если AD DS не удается удалить в обычном режиме, когда сервер подключен к сети, используйте один из следующих методов для устранения проблемы.

   - Принудительное удаление AD DS в режиме восстановления служб каталогов (DSRM), очистка метаданных сервера, а затем переустановка AD DS.
   - Переустановите операционную систему и перестройте контроллер домена.

Дополнительные сведения о принудительном удалении AD DS см. [в разделе Принудительное удаление контроллера домена](https://go.microsoft.com/fwlink/?LinkId=128291).

## <a name="using-repadmin-to-retrieve-replication-statustitle"></a>Использование средства Repadmin для получения сведений о состоянии репликации</title>

Состояние репликации — это важный способ оценить состояние службы каталогов. Если репликация работает без ошибок, то вы узнаете, что контроллеры домена находятся в сети. Вы также узнаете, что работают следующие системы и службы:


- Инфраструктура DNS
- Протокол проверки подлинности Kerberos
- Служба времени Windows (W32time)
- Удаленный вызов процедур (RPC)
- Сетевое подключение

Используйте средство Repadmin для мониторинга состояния репликации ежедневно, выполнив команду, которая оценивает состояние репликации всех контроллеров домена в лесу. Процедура создает CSV-файл, который можно открыть в Microsoft Excel, и отфильтровать ошибки репликации.

Для получения состояния репликации всех контроллеров домена в лесу можно использовать следующую процедуру.

Требования

Для выполнения данной процедуры требуется как минимум членство в группе **Администраторы предприятия** или в эквивалентной группе.

Средства:

- Repadmin.exe
- Excel (Microsoft Office)

### <a name="to-generate-a-repadmin-showrepl-spreadsheet-for-domain-controllers"></a>Создание электронной таблицы repadmin/шоврепл для контроллеров домена

1. Откройте командную строку от имени администратора: в меню Пуск щелкните правой кнопкой мыши пункт Командная строка и выберите команду Запуск от имени администратора. Если откроется диалоговое окно Контроль учетных записей пользователей, укажите учетные данные администратора предприятия, если это необходимо, а затем нажмите кнопку продолжить.
2. В командной строке введите следующую команду и нажмите клавишу ВВОД:`repadmin /showrepl * /csv > showrepl.csv`
3. Откройте Excel.
4. Нажмите кнопку Office, нажмите кнопку Открыть, перейдите к showrepl.csv, а затем нажмите кнопку Открыть.
5. Скройте или удалите столбец A, а также столбец Тип транспорта следующим образом:
6. Выберите столбец, который необходимо скрыть или удалить.

   - Чтобы скрыть столбец, щелкните правой кнопкой мыши столбец и выберите команду Скрыть.
   - Чтобы удалить столбец, щелкните правой кнопкой мыши выбранный столбец и выберите команду Удалить.

7. Выберите строку 1 под строкой заголовка столбца. На вкладке Вид нажмите кнопку Закрепить области, а затем нажмите кнопку закрепить верхнюю строку.
8. Выделите всю электронную таблицу. На вкладке Данные нажмите кнопку Фильтр.
9. В столбце время последнего успешного выполнения щелкните стрелку вниз и выберите Сортировать по возрастанию.
10. В столбце Исходный контроллер домена щелкните стрелку вниз, выберите Текстовые фильтры, а затем щелкните настраиваемый фильтр.
11. В диалоговом окне Пользовательский автофильтр в разделе Показывать строки, где щелкните не содержит. В соседнем текстовом поле введите <userInput>Del</userInput> , чтобы удалить из раздела Просмотр результатов для удаленных контроллеров домена.
12. Повторите шаг 11 для столбца время последнего сбоя, но используйте значение не равно, а затем введите значение 0.
13. Устранение ошибок репликации.

Для каждого контроллера домена в лесу в электронной таблице отображается исходный партнер репликации, время последней репликации и время последнего сбоя репликации для каждого контекста именования (раздела каталога). С помощью автофильтра в Excel можно просматривать работоспособность репликации только для рабочих контроллеров домена, только для неудачных контроллеров домена или контроллеров домена, которые являются минимальными или наиболее актуальными. Кроме того, можно увидеть, что партнеры репликации успешно реплицируются.

## <a name="replication-problems-and-resolutions"></a>Проблемы и способы решения репликации

Проблемы репликации регистрируются в сообщениях о событиях и в различных сообщениях об ошибках, происходящих при попытке приложения или службы выполнить операцию. В идеале эти сообщения собираются приложением мониторинга или при получении состояния репликации.

Большинство проблем репликации определяются в сообщениях о событиях, регистрируемых в журнале событий службы каталогов. Проблемы репликации также могут быть идентифицированы в виде сообщений об ошибках в выходных данных команды <system>repadmin/шоврепл</system> .

### <a name="repadmin-showrepl-error-messages-that-indicate-replication-problems"></a>repadmin/шоврепл сообщения об ошибках, указывающие на проблемы репликации

Чтобы выявление проблем репликации Active Directory, используйте команду <system>repadmin/шоврепл</system> , как описано в предыдущем разделе. В следующей таблице показаны сообщения об ошибках, создаваемые этой командой вместе с корневыми причинами ошибок и ссылки на разделы, содержащие решения для ошибок.

|Ошибка repadmin|Причина|Решение|
| --- | --- | --- |
|Время, прошедшее с момента последней репликации с этим сервером, превысило время существования захоронения.|Контроллер домена не прошел входящую репликацию с именованным исходным контроллером домена, достаточно долго, чтобы удаление было отменено, реплицировано и собрано сборщиком мусора из AD DS.|Событие с идентификатором 2042: прошло слишком много времени с момента репликации этого компьютера|
|Нет входящих соседей.|Если в разделе "Входящие соседи" в выходных данных, созданном с помощью repadmin/шоврепл, не отображаются элементы, контроллер домена не смог установить связи репликации с другим контроллером домена.|Устранение проблем подключения при репликации (событие с идентификатором 1925)|
|Отказано в доступе".|Между двумя контроллерами домена существует связь репликации, но в результате сбоя проверки подлинности репликация не может быть выполнена должным образом.|Устранение проблем с безопасностью при репликации|
|Последняя попытка в <Дата и время сбоя> с неправильным именем конечной учетной записи.|Эта проблема может быть связана с проблемами подключения, DNS или проверкой подлинности. Если это ошибка DNS, локальный контроллер домена не может разрешить DNS-имя своего партнера по репликации на основе глобального уникального идентификатора (GUID).|Устранение неполадок при поиске DNS-сервера репликации (идентификаторы событий 1925, 2087, 2088) устранение проблем безопасности репликации устранение проблем с подключением репликации (ИД события 1925)|
|Ошибка LDAP 49.|Возможно, учетная запись компьютера контроллера домена не синхронизирована с центр распространения ключей (KDC).|Устранение проблем с безопасностью при репликации|
|Не удается открыть подключение LDAP к локальному узлу|Средству администрирования не удалось связаться AD DS.|Устранение проблем поиска в DNS при репликации (события с идентификаторами 1925, 2087, 2088)|
|Active Directoryная репликация была прервана.|Ход выполнения входящей репликации был прерван запросом репликации с более высоким приоритетом, например запросом, созданным вручную с помощью команды repadmin/Sync.|Дождитесь завершения репликации. Это информационное сообщение указывает на нормальную работу.|
|Репликация опубликована, ожидание.| Контроллер домена опубликовал запрос на репликацию и ожидает ответа. Репликация выполняется из этого источника.|Дождитесь завершения репликации. Это информационное сообщение указывает на нормальную работу.|

В следующей таблице перечислены распространенные события, которые могут указывать на проблемы с Active Directory репликацией, а также основные причины проблем и ссылки на разделы, содержащие решения для проблем.

|Идентификатор события и источник|Первопричина|Решение|
| --- | --- | --- |
|1311 NTDS KCC|Сведения о конфигурации репликации в AD DS неточно отображают физическую топологию сети.|Устранение проблем топологии репликации (событие с идентификатором 1311)|
|1388. Репликация NTDS|Ограниченная согласованность репликации не действует, и устаревший объект реплицируется на контроллер домена.|Устранение проблем с устаревшими объектами при репликации (события с идентификаторами 1388, 1988 2042)|
|1925 NTDS KCC|Попытка установить канал репликации для раздела каталога, доступного для записи, завершилась ошибкой. Это событие может иметь различные причины в зависимости от ошибки.| Устранение проблем с подключением репликации (ИД события 1925) устранение неполадок при поиске DNS-сервера репликации (идентификаторы событий 1925, 2087, 2088)|
|1988. Репликация NTDS|Локальный контроллер домена попытался реплицировать объект с исходного контроллера домена, который отсутствует на локальном контроллере домена, так как он был удален и уже собран сборщиком мусора. Репликация не продолжается для этого раздела каталога с этим партнером до устранения ситуации.|Устранение проблем с устаревшими объектами при репликации (события с идентификаторами 1388, 1988 2042)|
|2042. Репликация NTDS|Репликация этого партнера не выполнялась в течение времени существования захоронения, и репликация не может быть продолжена.|Устранение проблем с устаревшими объектами при репликации (события с идентификаторами 1388, 1988 2042)|
|2087. Репликация NTDS|AD DS не удалось разрешить имя узла DNS исходного контроллера домена в IP-адрес, и репликация не удалась.|Устранение проблем поиска в DNS при репликации (события с идентификаторами 1925, 2087, 2088)|
|2088. Репликация NTDS |AD DS не удалось разрешить имя узла DNS исходного контроллера домена в IP-адрес, но репликация была успешной.|Устранение проблем поиска в DNS при репликации (события с идентификаторами 1925, 2087, 2088)|
|5805 Net Logon|Учетной записи компьютера не удалось выполнить проверку подлинности, которая обычно вызвана несколькими экземплярами одного и того же имени компьютера или именем компьютера, которые не реплицируются на каждый контроллер домена.|Устранение проблем с безопасностью при репликации|

Дополнительные сведения о концепциях репликации см. в разделе [Active Directory технологии репликации](https://go.microsoft.com/fwlink/?LinkId=41950).

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения, включая статьи о поддержке, относящиеся к кодам ошибок, см. в статье поддержка: [Устранение распространенных ошибок репликации Active Directory](https://support.microsoft.com/help/3108513)
