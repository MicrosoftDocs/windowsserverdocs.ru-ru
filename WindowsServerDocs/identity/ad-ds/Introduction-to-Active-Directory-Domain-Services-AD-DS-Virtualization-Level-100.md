---
title: Безопасная виртуализация домен Active Directory служб (AD DS)
description: Откат USN и надежная виртуализация Active Directory
ms.topic: article
ms.prod: windows-server
author: MicrosoftGuyJFlo
ms.author: joflore
manager: mtillman
ms.date: 03/22/2019
ms.technology: identity-adds
ms.assetid: 7a3114c8-bda8-49bb-83a8-4e04340ab221
ms.openlocfilehash: 67e35a47467b1f5f66bfd073c6f9db06094ea3f9
ms.sourcegitcommit: 6aff3d88ff22ea141a6ea6572a5ad8dd6321f199
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/27/2019
ms.locfileid: "71391030"
---
# <a name="safely-virtualizing-active-directory-domain-services-ad-ds"></a>Безопасная виртуализация домен Active Directory служб (AD DS)

>Область применения. Windows Server

Начиная с Windows Server 2012, AD DS обеспечивает более высокую поддержку виртуализации контроллеров домена, представляя возможности, защищенные с помощью виртуализации. В этой статье объясняется роль USN и Инвокатионидс в репликации контроллера домена и обсуждаются некоторые потенциальные проблемы, которые могут возникнуть.

## <a name="update-sequence-number-and-invocationid"></a>Порядковый номер обновления и InvocationID

Виртуальные среды представляют особую трудность для распределенных рабочих потоков, зависящих от логической схемы репликации по времени. Например, репликация AD DS использует равномерно увеличивающееся значение (которое называется USN, или номер последовательного обновления), назначенное транзакциям в каждом контроллере домена. Каждому экземпляру базы данных контроллера домена также присваивается удостоверение, называемое InvocationID. InvocationID контроллера домена и его номер последовательного обновления вместе служат уникальным идентификатором, который связан с каждой транзакцией записи, выполняемой на каждом контроллере домена, и должны быть уникальны в пределах леса.

Репликация AD DS использует InvocationID и номер последовательного обновления на каждом контроллере домена, чтобы определить, какие изменения необходимо повторить на других контроллерах домена. Если откат контроллера домена выполняется за пределами осведомленности контроллера домена, а USN используется повторно для совершенно другой транзакции, репликация не будет согласована, так как другие контроллеры домена считают, что они уже получили обновления. связан с повторно используемым USN в контексте этого InvocationID.

Например, следующая иллюстрация показывает последовательность событий, происходящих в ОС Windows Server 2008 R2 и более ранних версиях, когда обнаруживается откат номера последовательного обновления на VDC2 — целевом контроллере домена, работающем на виртуальной машине. На этом рисунке обнаружение отката USN выполняется в VDC2, когда участник репликации обнаруживает, что VDC2 отправил значение USN, которое ранее было замечено партнером репликации, что указывает на то, что база данных VDC2's была возвращена вовремя. неправильно.

![Последовательность событий при обнаружении отката USN](../media/Introduction-to-Active-Directory-Domain-Services--AD-DS--Virtualization--Level-100-/ADDS_Exampleofhowreplicationcanbecomeinconsistent.png)

Виртуальная машина позволяет администраторам гипервизора легко выполнять откат USN контроллера домена (его логических часов), например, применение моментального снимка за пределами сведений об контроллере домена. Дополнительные сведения о номере последовательного обновления и его откате, включая другую иллюстрацию, демонстрирующую невыявленные экземпляры отката номера последовательного обновления, см. в разделе [Номер последовательного обновления и его откат](https://technet.microsoft.com/library/virtual_active_directory_domain_controller_virtualization_hyperv(WS.10).aspx#usn_and_usn_rollback).

Начиная с Windows Server 2012, AD DS виртуальные контроллеры домена, размещенные на платформах низкоуровневой оболочки, которые предоставляют идентификатор, именуемый ИДЕНТИФИКАТОРом создания виртуальной машины, могут обнаруживать и применять необходимые меры обеспечения безопасности для защиты среды AD DS, если выполняется откат виртуальной машины. назад по времени применения моментального снимка виртуальной машины. Структура ИД создания виртуальной машины использует независимый механизм поставщика гипервизора для предоставления этого идентификатора в пространстве адресов гостевой виртуальной машины, поэтому безопасная виртуализация обеспечивается любым гипервизором, который поддерживает ИД создания виртуальной машины. С помощью этого идентификатора службы и приложения, работающие на виртуальной машине, могут определить, выполнялся ли откат виртуальной машины.

## <a name="effects-of-usn-rollback"></a>Влияние отката USN

При откате USN изменения объектов и атрибутов не являются входящими, реплицированными конечными контроллерами домена, которые ранее видели USN.

Так как эти конечные контроллеры домена считают, что они актуальны, ошибки репликации не регистрируются в журналах событий службы каталогов или средствами мониторинга и диагностики.

Откат USN может повлиять на репликацию любого объекта или атрибута в любой секции. Наиболее часто наблюдаемым побочным действием является то, что учетные записи пользователей и компьютеров, созданные на контроллере домена отката, не существуют на одном или нескольких участниках репликации. Или обновления паролей, созданные на контроллере домена отката, не существуют на партнерах репликации.

Откат USN может препятствовать репликации любого типа объектов Active Directory секции. К этим типам объектов относятся следующие.

* Топология и расписание репликации Active Directory
* Наличие контроллеров домена в лесу и ролей, которые эти контроллеры домена удерживает
* Существование разделов домена и приложения в лесу
* Существование групп безопасности и их текущих членств в группах
* Регистрация записей DNS в зонах DNS, интегрированных в Active Directory

Размер отверстия USN может представлять сотни, тысячи или даже десятки тысяч изменений для пользователей, компьютеров, доверий, паролей и групп безопасности. Отверстие USN определяется разницей между самым высоким USN-номером, существовавшим при создании восстановленной резервной копии состояния системы, и числом исходных изменений, созданных на контроллере домена с откатом до того, как он был переведен в режим «вне сети».

## <a name="detecting-a-usn-rollback"></a>Обнаружение отката USN

Поскольку откат USN трудно обнаружить, контроллер домена регистрирует событие 2095, когда исходный контроллер домена отправляет ранее подтвержденный USN-номер на конечный контроллер домена без соответствующего изменения в ИДЕНТИФИКАТОРе вызова.

Чтобы предотвратить создание уникальных исходящих обновлений Active Directory на неправильном восстановленном контроллере домена, служба сетевого входа в систему приостанавливается. Если служба сетевого входа в систему приостановлена, учетные записи пользователей и компьютеров не могут изменить пароль на контроллере домена, который не будет выполнять репликацию таких изменений. Аналогичным образом при обновлении объектов в Active Directory средства администрирования Active Directory будут использовать работоспособный контроллер домена.

На контроллере домена сообщения о событиях, аналогичные приведенным ниже, записываются при соблюдении следующих условий.

* Исходный контроллер домена отправляет ранее подтвержденный USN-номер на конечный контроллер домена.
* В ИДЕНТИФИКАТОРе вызова нет соответствующих изменений.

Эти события могут регистрироваться в журнале событий службы каталогов. Однако они могут быть перезаписаны до того, как они будут наблюдать администратором.

Если вы подозреваете, что откат USN выполнен, но не видите соответствующее событие в журналах событий, проверьте запись DSA, которая не доступна для записи в реестре. Эта запись предоставляет судебное свидетельство о том, что выполнен откат USN.

```
HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\NTDS\Parameters
Registry entry: Dsa Not Writable
Value: 0x4
```

> [!WARNING]
> Удаление или изменение значения записи реестра "DSA без записи на диск" приводит к неработоспособному состоянию контроллера домена отката. Поэтому такие изменения не поддерживаются. В частности, изменение значения удаляет поведение карантина, добавленное кодом обнаружения отката USN. Разделы Active Directory на контроллере домена ROLLBACK будут постоянно непротиворечивыми с прямыми и транзитивными партнерами репликации в одном лесу Active Directory.

Дополнительные сведения об этом разделе реестра и действиях по его устранению можно найти в статье о поддержке [Active Directory Replication Error 8456 или 8457: "Источник | Целевой сервер в настоящее время отвергает запросы на репликацию "](https://support.microsoft.com/help/2023007/active-directory-replication-error-8456-or-8457-the-source-destination).

## <a name="virtualization-based-safeguards"></a>Меры защиты на основе виртуализации

Во время установки контроллера домена AD DS изначально сохраняет идентификатор виртуальной машины как часть атрибута msDS-GenerationID на объекте компьютера контроллера домена в своей базе данных (часто это называется деревом сведений о каталоге или DIT). ИД создания виртуальной машины независимо отслеживается драйвером Windows на виртуальной машине.

Когда администратор восстанавливает машину из предыдущего снимка, текущее значение ИД создания виртуальной машины от драйвера виртуальной машины сравнивается со значением в DIT.

Если значения отличаются, InvocationID сбрасывается, а пул относительного идентификатора отклоняется, чтобы предотвратить повторное использование номера последовательного обновления. Если значения совпадают, транзакция проводится в обычном режиме.

Службы AD DS также сравнивают текущее значение ИД создания виртуальной машины от виртуальной машины со значением в DIT при каждой перезагрузке контроллера домена. Если значения отличаются, службы сбрасывают InvocationID, отклоняют пул относительного идентификатора и записывают в DIT новое значение. Кроме того, службы синхронизируют папку SYSVOL недоверенным методом, чтобы завершить безопасное восстановление. Это позволяет мерам безопасности расширить применение снимков на отключенных виртуальных машинах. Эти меры безопасности, появившиеся в Windows Server 2012, позволяют администраторам AD DS воспользоваться преимуществами уникальных преимуществ развертывания контроллеров домена в виртуализованной среде и управления ими.

На следующем рисунке показано, как применяются меры безопасности виртуализации при обнаружении одного отката USN на виртуальном контроллере домена под управлением Windows Server 2012 в гипервизоре, поддерживающем VM-GenerationID.

![Меры безопасности, применяемые при обнаружении одного и того же отката USN](../media/Introduction-to-Active-Directory-Domain-Services--AD-DS--Virtualization--Level-100-/ADDS_VDC_Exampleofhowsafeguardswork.gif)

В этом случае, когда гипервизор обнаруживает изменение ИД создания виртуальной машины, срабатывают средства безопасности виртуализации, включая сброс кода обращения виртуализованного контроллера домена (с A на B в предыдущем примере) и обновление ИД создания виртуальной машины, сохраненного на виртуальной машине, для обеспечения соответствия новому значению (G2), которое хранит гипервизор. Меры безопасности обеспечивают выполнение репликации на обоих контроллерах доменов.

В Windows Server 2012 AD DS использует защиту виртуальных контроллеров домена, размещенных на низкоуровневых оболочках GenerationID, и гарантирует случайное применение моментальных снимков или других таких механизмов, поддерживающих гипервизор, которые могут откатить виртуальную машину. состояние компьютера не нарушает AD DSную среду (предотвращая проблемы репликации, такие как пузырьковые или устаревшие объекты).

Восстановление контроллера домена путем применения моментального снимка виртуальной машины не рекомендуется в качестве альтернативного механизма резервного копирования контроллера домена. Мы рекомендуем и дальше использовать систему архивации данных Windows Server или другие решения для архивации на базе устройств записи VSS.

> [!CAUTION]
> Если контроллер домена в рабочей среде случайно вернулся к моментальному снимку, рекомендуется обратиться к поставщикам приложений и служб, размещенных на этой виртуальной машине, и получить рекомендации по проверке состояния этих программ после Восстановление моментального снимка.

Дополнительные сведения см. в разделе [Virtualized domain controller safe restore architecture](../ad-ds/get-started/virtual-dc/Virtualized-Domain-Controller-Architecture.md#BKMK_SafeRestoreArch).

## <a name="recovering-from-a-usn-rollback"></a>Восстановление после отката USN

Существует два подхода к восстановлению после отката USN:

* Удаление контроллера домена из домена
* Восстановление состояния системы для хорошей резервной копии

### <a name="remove-the-domain-controller-from-the-domain"></a>Удаление контроллера домена из домена

1. Удалите Active Directory с контроллера домена, чтобы принудительно использовать изолированный сервер.
2. Завершите работу пониженного сервера.
3. На работоспособном контроллере домена очистите метаданные пониженного контроллера домена.
4. Если неверно восстановленный контроллер домена размещает роли хозяина операций, перенесите эти роли на работоспособный контроллер домена.
5. Перезапустите сервер пониженной роли.
6. При необходимости снова установите Active Directory на автономном сервере.
7. Если контроллер домена ранее был глобальным каталогом, настройте контроллер домена в качестве глобального каталога.
8. Если контроллер домена ранее размещал роли хозяина операций, передайте роли хозяина операций в контроллер домена.

### <a name="restore-the-system-state-of-a-good-backup"></a>Восстановление состояния системы для хорошей резервной копии

Оцените, существуют ли для этого контроллера домена Допустимые резервные копии состояния системы. Если допустимая резервная копия состояния системы была создана до того, как контроллер домена был неверно восстановлен, а резервная копия содержит последние изменения, внесенные на контроллере домена, восстановите состояние системы из последней резервной копии.

Моментальный снимок также можно использовать в качестве источника резервной копии. Кроме того, можно задать для базы данных новый идентификатор вызова, используя процедуру, описанную в разделе [восстановление виртуального контроллера домена, если соответствующая резервная копия данных о состоянии системы недоступна](https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/dd363553%28v%3dws.10%29#restoring-a-virtual-domain-controller-when-an-appropriate-system-state-data-backup-is-not-available) .

## <a name="next-steps"></a>Следующие шаги

* Дополнительные сведения о диагностике виртуализованных контроллеров доменов см. в разделе [Диагностика виртуализованных контроллеров доменов](../ad-ds/manage/virtual-dc/Virtualized-Domain-Controller-Troubleshooting.md).
* [Подробные сведения о службе времени Windows (W32Time)](../../networking/windows-time-service/windows-time-service-top.md)
