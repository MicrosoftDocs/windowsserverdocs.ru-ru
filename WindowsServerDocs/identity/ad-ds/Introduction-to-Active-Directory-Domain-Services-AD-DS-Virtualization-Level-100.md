---
ms.assetid: 7a3114c8-bda8-49bb-83a8-4e04340ab221
title: Знакомство с виртуализацией доменных служб Active Directory (уровень 100)
description: ''
author: MicrosoftGuyJFlo
ms.author: joflore
manager: mtillman
ms.date: 05/31/2017
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: identity-adds
ms.openlocfilehash: b818ba5a58db38bdb3c0f630a8d9d2daa1494403
ms.sourcegitcommit: 0d0b32c8986ba7db9536e0b8648d4ddf9b03e452
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2019
ms.locfileid: "59878095"
---
# <a name="introduction-to-active-directory-domain-services-ad-ds-virtualization-level-100"></a>Знакомство с виртуализацией доменных служб Active Directory (уровень 100)

>Область применения. Windows Server 2016, Windows Server 2012 R2, Windows Server 2012

Виртуализация сред доменных служб Active Directory продолжается многие годы. Начиная с Windows Server 2012, AD DS предоставляют лучшую поддержку виртуализации контроллеров доменов благодаря возможностям безопасной виртуализации.

## <a name="safe-virtualization-of-domain-controllers"></a>Безопасная виртуализация контроллеров доменов

Виртуальные среды представляют особую трудность для распределенных рабочих потоков, зависящих от логической схемы репликации по времени. Например, репликация AD DS использует равномерно увеличивающееся значение (которое называется USN, или номер последовательного обновления), назначенное транзакциям в каждом контроллере домена. Экземпляр базы данных на каждом контроллере домена присваивается удостоверение, под названием InvocationID. InvocationID контроллера домена и его номер последовательного обновления вместе служат уникальным идентификатором, который связан с каждой транзакцией записи, выполняемой на каждом контроллере домена, и должны быть уникальны в пределах леса.

Репликация AD DS использует InvocationID и номер последовательного обновления на каждом контроллере домена, чтобы определить, какие изменения необходимо повторить на других контроллерах домена. Если контроллер домена является временем откат за пределами информированности контроллера домена, повторном использовании USN для абсолютно другой транзакции репликация не будет осуществляться, так как другие контроллеры домена будут считать, что они уже получили обновления связанный с повторно использованным номером последовательного обновления в контексте данного InvocationID.

Например, следующая иллюстрация показывает последовательность событий, происходящих в ОС Windows Server 2008 R2 и более ранних версиях, когда обнаруживается откат номера последовательного обновления на VDC2 — целевом контроллере домена, работающем на виртуальной машине. На этом рисунке обнаружение откат USN происходит на контроллере VDC2, когда партнер репликации обнаруживает, что VDC2 отправил значение номера последовательного обновления векторе синхронизации, которая ранее использовалась партнер по репликации, который указывает, что VDC2 элемента отката базы данных времени неправильно.

![Введение в AD DS](../media/Introduction-to-Active-Directory-Domain-Services--AD-DS--Virtualization--Level-100-/ADDS_Exampleofhowreplicationcanbecomeinconsistent.png)

Виртуальной машины (VM) облегчает администраторам гипервизора откат домена USN контроллера (его логических часов), например, применение моментального снимка за пределами информированности контроллера домена. Дополнительные сведения о номере последовательного обновления и его откате, включая другую иллюстрацию, демонстрирующую невыявленные экземпляры отката номера последовательного обновления, см. в разделе [Номер последовательного обновления и его откат](https://technet.microsoft.com/library/virtual_active_directory_domain_controller_virtualization_hyperv(WS.10).aspx#usn_and_usn_rollback).

Начиная с Windows Server 2012, контроллеры виртуального домена AD DS, размещенные на платформах гипервизоров, которые предоставляют идентификатор ИД создания виртуальной Машины могут определять и применять необходимые меры безопасности для защиты среды AD DS, если откат виртуальной машины назад во времени путем применения снимка виртуальной Машины. Структура ИД создания виртуальной машины использует независимый механизм поставщика гипервизора для предоставления этого идентификатора в пространстве адресов гостевой виртуальной машины, поэтому безопасная виртуализация обеспечивается любым гипервизором, который поддерживает ИД создания виртуальной машины. С помощью этого идентификатора службы и приложения, работающие на виртуальной машине, могут определить, выполнялся ли откат виртуальной машины.

### <a name="BKMK_HowSafeguardsWork"></a>Как работают эти меры безопасности виртуализации?
Во время установки контроллера домена AD DS изначально сохраняют идентификатор ИД создания виртуальной Машины как часть атрибута msDS-GenerationID объекта-компьютера контроллера домена в своей базе данных (часто называют информационным деревом каталога, или DIT). ИД создания виртуальной машины независимо отслеживается драйвером Windows на виртуальной машине.

Когда администратор восстанавливает машину из предыдущего снимка, текущее значение ИД создания виртуальной машины от драйвера виртуальной машины сравнивается со значением в DIT.

Если значения отличаются, InvocationID сбрасывается, а пул относительного идентификатора отклоняется, чтобы предотвратить повторное использование номера последовательного обновления. Если значения совпадают, транзакция проводится в обычном режиме.

Службы AD DS также сравнивают текущее значение ИД создания виртуальной машины от виртуальной машины со значением в DIT при каждой перезагрузке контроллера домена. Если значения отличаются, службы сбрасывают InvocationID, отклоняют пул относительного идентификатора и записывают в DIT новое значение. Кроме того, службы синхронизируют папку SYSVOL недоверенным методом, чтобы завершить безопасное восстановление. Это позволяет мерам безопасности расширить применение снимков на отключенных виртуальных машинах. Эти меры безопасности, появившиеся в Windows Server 2012 Разрешить администраторам AD DS пользоваться уникальными преимуществами развертывания и управления контроллерами доменов в виртуализованной среде.

Ниже показано, как применяются меры безопасности виртуализации при обнаружении отката того же номера последовательного обновления на виртуализованном контроллере домена под управлением Windows Server 2012 на гипервизоре, поддерживающем ИД создания виртуальной Машины.

![Введение в AD DS](../media/Introduction-to-Active-Directory-Domain-Services--AD-DS--Virtualization--Level-100-/ADDS_VDC_Exampleofhowsafeguardswork.gif)

В этом случае, когда гипервизор обнаруживает изменение ИД создания виртуальной машины, срабатывают средства безопасности виртуализации, включая сброс кода обращения виртуализованного контроллера домена (с A на B в предыдущем примере) и обновление ИД создания виртуальной машины, сохраненного на виртуальной машине, для обеспечения соответствия новому значению (G2), которое хранит гипервизор. Меры безопасности обеспечивают выполнение репликации на обоих контроллерах доменов.

С Windows Server 2012 AD DS применяют меры безопасности на контроллерах домена, размещенных на виртуальной Машине гипервизорах и гарантирует, что случайном применении снимков или других гипервизором механизмов, которые удалось откат виртуальной состояние компьютера не нарушит среды AD DS (путем предотвращения проблем репликации, таких как номера последовательного обновления или замедление объектов). Однако восстановление контроллера домена с помощью снимка виртуальной машины не рекомендуется применять в качестве альтернативного механизма архивации контроллера домена. Мы рекомендуем и дальше использовать систему архивации данных Windows Server или другие решения для архивации на базе устройств записи VSS.

> [!CAUTION]
> Если контроллер домена в рабочей среде был случайно восстановлен до моментального снимка, рекомендуется проконсультироваться с поставщиками для приложений и служб, размещенных на этой виртуальной машине, рекомендации по проверке состояния этих программ после восстановление моментального снимка.

Дополнительные сведения см. в разделе [Virtualized domain controller safe restore architecture](../ad-ds/get-started/virtual-dc/Virtualized-Domain-Controller-Architecture.md#BKMK_SafeRestoreArch).

## <a name="virtualized_dc_cloning"></a>Клонирование виртуализированного контроллера домена
Начиная с Windows Server 2012, администраторы могут легко и безопасно развертывать реплики контроллеров доменов путем копирования существующего виртуального контроллера домена. В виртуальной среде администраторам больше не нужно постоянно развертывать образ сервера, созданный с помощью sysprep.exe, повышать уровень сервера до контроллера домена и выполнять дополнительные требования конфигурации для развертывания каждой реплики контроллера домена.

> [!NOTE]
> Всем этим процедурам необходимо следовать только для развертывания первого контроллера в домене, в частности использовать sysprep.exe для подготовки виртуального жесткого диска сервера, повышения уровня сервера до контроллера домена и выполнения дополнительных требований конфигурации. В сценарии аварийного восстановления используйте последнюю версию архивации сервера для восстановления первого контроллера в домене.

### <a name="scenarios-that-benefit-from-virtual-domain-controller-cloning"></a>Сценарии, для которых удобно клонировать виртуальный контроллер домена

-   Быстрое развертывание дополнительных контроллеров домена в новом домене

-   Быстрое возобновление непрерывной работы во время аварийного восстановления путем восстановления емкости AD DS посредством быстрого развертывания контроллеров доменов с помощью клонирования

-   Оптимизация развертывания частного облака путем гибкой подготовки контроллеров доменов к повышенным требованиям масштабирования

-   Быстрая подготовка тестовой среды для развертывания и тестирования новых компонентов и возможностей до реализации в рабочей среде

-   Быстрое увеличение емкости в филиалах путем клонирования существующих контроллеров доменов в таких филиалах

При быстром развертывании большого количества контроллеров доменов продолжайте следовать существующим процедурам проверки работоспособности каждого контроллера домена после завершения установки. Развертывайте контроллеры доменов партиями разумного объема, чтобы после завершения установки вы могли проверить работоспособность каждой партии. Рекомендованный размер партии – 10. Дополнительные сведения см. в разделе [Этапы развертывания клона виртуализованного контроллера домена](../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/Introduction-to-Active-Directory-Domain-Services-AD-DS-Virtualization-Level-100.md#steps_deploy_vdc).

### <a name="clear-separation-of-responsibilities"></a>Четкое разделение ответственности
Авторизацию на клонирование виртуализованных контроллеров доменов контролирует администратор AD DS. Чтобы администраторы гипервизоров могли развертывать дополнительные контроллеры доменов путем копирования виртуальных контроллеров доменов, администратор AD DS должен выбрать и авторизовать контроллер домена, а затем выполнить подготовительные шаги, чтобы сделать его источником клонирования.

Так как подготовка виртуальной машины обычно входит в сферу ответственности администратора гипервизора, такие администраторы могут подготавливать реплики виртуальных машин контроллеров доменов путем копирования виртуализованных контроллеров доменов, которые администратор AD DS авторизовал и подготовил для клонирования.

> [!WARNING]
> Любой пользователь, которому разрешается администрировать гипервизор, размещающий контроллер домена, должен подвергаться проверке и иметь высокий уровень доверия в среде.

### <a name="how-does-virtual-domain-controller-cloning-work"></a>Принцип действия клонирования виртуального контроллера домена
Процесс клонирования включает создание копии VHD существующего контроллера домена (или, для более сложных конфигураций — виртуальной Машины контроллера домена), ее авторизацию для клонирования в AD DS и создание файла конфигурации клона. Это сокращает количество шагов и время, необходимое для развертывания реплики виртуального контроллера домена, за счет того, что задачи развертывания не требуется повторять.

Клонированный контроллер домена использует следующие условия, чтобы установить, что он является копией другого контроллера домена.

1.  Предоставляемый виртуальной машиной ИД создания виртуальной машины отличается от одноименного параметра, хранящегося в DIT.

    > [!NOTE]
    > Платформа гипервизора должна поддерживать ИД создания виртуальной Машины (Windows Server 2012 Hyper-V поддерживает VM-Generation ID).

2.  Наличие файла DCCloneConfig.xml в одном из следующих расположений:

    -   Каталог, где находится DIT

    -   %windir%\NTDS

    -   Корневой каталог съемного носителя

Если условия выполнены, контроллер домена запускает процесс клонирования, чтобы подготовить себя в качестве реплики контроллера домена.

Клонированный контроллер домена использует контекст безопасности исходного контроллера домена (контроллер домена, копией которого он является) для связи с держателем роли хозяина операций эмулятора Windows Server 2012 основного контроллера домена (PDC) (также называется гибкие операции с единым хозяином или FSMO). Эмулятор основного контроллера домена должны работать под управлением Windows Server 2012, но его не должны быть запущены в низкоуровневой оболочке.

> [!NOTE]
> Если у вас есть расширение схемы с атрибутами, ссылающимися на исходный контроллер домена, и атрибут находится на одном из объектов (объекте-компьютере, объекте параметров NTDS), скопированных для создания клона, этот атрибут не будет скопирован или обновлен, чтобы ссылаться на клонированный контроллер домена.

Убедившись, что запрошенный контроллер домена авторизован для клонирования, эмулятор основного контроллера домена создаст новый идентификатор машины, включая новую учетную запись, ИД безопасности, имя и пароль, которые идентифицируют эту машину как реплику контроллера домена, а затем отправит эти сведения клону. Затем клонированный контроллер домена подготовит файлы базы данных AD DS к работе в качестве реплики и очистит область машины.

Дополнительные сведения см. в разделе [Virtualized domain controller cloning architecture](../ad-ds/get-started/virtual-dc/Virtualized-Domain-Controller-Architecture.md#BKMK_CloneArch).

### <a name="cloning-components"></a>Компоненты клонирования
Компоненты клонирования включают командлеты в модуле Active Directory для Windows PowerShell и связанные XML-файлы.

-   **New-ADDCCloneConfigFile** «этот командлет создает и размещает файл DCCloneConfig.xml в надлежащем расположении, чтобы обеспечить его доступность для запуска клонирования. Он также выполняет проверку необходимых компонентов, чтобы гарантировать успешное клонирование. Командлет включен в модуль Active Directory для Windows PowerShell. Его можно запускать локально на виртуализованном контроллере домена, который готовится для клонирования, или удаленно с помощью параметра -offline. Вы можете указать параметры клонированного контроллера домена, такие как имя, сайт и IP-адрес.

    Выполняется следующая проверка необходимых компонентов.

    > [!NOTE]
    > Проверка не выполняется, когда «используется параметр offline. Дополнительные сведения см. в статье [Выполнение New-ADDCCloneConfigFile в автономном режиме](../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/Introduction-to-Active-Directory-Domain-Services-AD-DS-Virtualization-Level-100.md#BKMK_OfflineMode).

    -   Подготавливаемый контроллер домена авторизован для клонирования (является членом группы **Клонируемые контроллеры домена**).

    -   Эмулятор PDC работает Windows Server 2012.

    -   Любые программы или службы, перечисленные в выходных данных командлета **Get-ADDCCloningExcludedApplicationList** , включены в CustomDCCloneAllowList.xml (поясняется более подробно в конце этого списка компонентов для клонирования).

-   **DCCloneConfig.xml** "для успешного клонирования виртуализованного контроллера домена, этот файл должен находиться в каталоге, где находится DIT *%windir%\NTDS*, или в корневом каталоге съемного носителя. Этот файл является одним из триггеров для определения и инициации клонирования, а также позволяет указать параметры конфигурации для клонированного контроллера домена.

    Схема и образец файла для файла DCCloneConfig.xml хранятся на всех компьютерах Windows Server 2012 в:

    -   %windir%\system32\DCCloneConfigSchema.xsd

    -   %windir%\system32\SampleDCCloneConfig.xml

    Для создания файла DCCloneConfig.xml рекомендуется использовать командлет New-ADDCCloneConfigFile. Хотя для создания этого файла можно также использовать схематичный файл с XML-редактором, изменение вручную увеличивает вероятность ошибки. Изменять файл следует с помощью XML-редакторов, таких как Visual Studio, [XML Notepad](https://www.microsoft.com/download/details.aspx?displaylang=en&id=7973)или сторонние приложения (не используйте Notepad).

-   **Get-ADDCCloningExcludedApplicationList** «этот командлет выполняется на исходном контроллере домена до начала процесса клонирования, чтобы определить, какие службы или установленные программы не входят в список поддерживаемых по умолчанию, DefaultDCCloneAllowList.xml или включения, определяемых пользователем именованный файл CustomDCCloneAllowList.xml и следовательно не были учтены для клонирования.

    Этот командлет ищет на исходном контроллере домена службы в диспетчере служб и установленные программы, перечисленные в папке **HKLM\Software\Microsoft\Windows\CurrentVersion\Uninstall** , которые не указаны в списке по умолчанию (DefaultDCCloneAllowList.xml) или в пользовательском списке включения (файл CustomDCCloneAllowList.xml), если он указан. Список приложений и служб, возвращенный работающим командлетом, является разницей между содержимым файла DefaultDCCloneAllowList.xml или CustomDCCloneAllowList.xml и списком, созданным во время выполнения на основании программ, установленных на исходном контроллере домена. Службы и программы из Get-ADDCCloningExcludedApplicationList можно добавить в файл CustomDCCloneAllowList.xml, если вы считаете, что их можно безопасно клонировать. Чтобы определить безопасность клонирования службы или установленной программы, оцените следующие условия.

    -   Влияет ли на службу или установленную программу идентификатор машины, например имя, ИД безопасности, пароль и тому подобное?

    -   Хранит ли служба или установленная программа локально на компьютере какие-либо данные, которые могут снизить ее работоспособность на клоне?

    Чтобы определить безопасность клонирования службы или установленной программы, следует проконсультироваться с поставщиком приложения.

    > [!NOTE]
    > Перед подготовкой дополнительных служб или программ в файле CustomDCCloneAllowList.xml убедитесь, что у вас есть необходимая лицензия на копирование программного обеспечения, содержащегося на этой виртуальной машине.

    Если приложения не подлежат клонированию, удалите их с исходного контроллера домена до создания клонированного носителя. Если приложение отображается в выходных данных командлета, но не включено в файл CustomDCCloneAllowList.xml, клонирование будет невозможно. Чтобы гарантировать успешное клонирование, выходные данные командлета не должны содержать никаких служб или программ. Другими словами, приложение должно быть либо включено в файл CustomDCCloneAllowList.xml, либо удалено с исходного контроллера домена.

    В следующей таблице поясняются параметры работающего командлета Get-ADDCCloningExcludedApplicationList.

    |||
    |-|-|
    |Аргумент|Объяснение|
    |*<no argument specified>*|Отображает на консоли список служб или программ, которые не были учтены для клонирования. Если файл CustomDCCloneAllowList.XML уже существует в любом допустимом расположении, аргумент использует этот файл для отображения оставшихся служб и программ (которых может и не быть, если списки совпадают).|
    |-GenerateXml|Создает файл CustomDCCloneAllowList.XML, заполненный службами и программами, перечисленными в консоли.|
    |-Force|Перезаписывает существующий файл CustomDCCloneAllowList.XML.|
    |-Path|Путь папки для создания CustomDCCloneAllowList.XML.|

-   **DefaultDCCloneAllowList.xml** "Этот файл присутствует по умолчанию в каждой ОС Windows Server 2012 домена контроллера in *%windir%\system32*. В нем перечислены службы и установленные программы, которые можно безопасно клонировать по умолчанию. Изменять расположение или содержимое этого файла нельзя, иначе клонирование будет невозможно.

-   **CustomDCCloneAllowList.xml** «Если у вас есть службы или установленные программы, которые находятся на вашем исходном контроллере домена, которые не входят в список файла DefaultDCCloneAllowList.xml их должен быть включен в этом файл. Чтобы найти службы или установленные программы, которые не перечислены в файле DefaultDCCloneAllowList.xml, запустите командлет **Get-ADDCCloningExcludedApplicationList** . Следует использовать **«GenerateXml** аргумент для создания XML-файле.

    Процесс клонирования по порядку проверяет следующие расположения и использует первый найденный XML-файл вне зависимости от содержимого других папок.

    1.  Следующий раздел реестра:

        ```
        HKey_Local_Machine\System\CurrentControlSet\Services\NTDS\Parameters
        AllowListFolder (REG_SZ)
        ```

    2.  Рабочая папка DSA

    3.  %systemroot%\NTDS

    4.  Съемные носители с возможностью чтения и записи в порядке букв дисков; в корне диска

### <a name="deployment-scenarios"></a>Сценарии развертывания
Поддерживаются следующие сценарии клонирования виртуального контроллера домена.

-   Развертывание клонированного контроллера домена путем копирования файла виртуального жесткого диска (vhd) исходного контроллера домена.

-   Развертывание клонированного контроллера домена путем копирования виртуальной машины исходного контроллера домена с помощью семантики экспорта/импорта, предоставленной гипервизором.

> [!NOTE]
> Действия, описанные в разделе [этапы развертывания клона виртуализованного контроллера домена](../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/Introduction-to-Active-Directory-Domain-Services-AD-DS-Virtualization-Level-100.md#steps_deploy_vdc) описывают копирование виртуальной машины с помощью функции экспорта/импорта Windows Server 2012 Hyper-V.

## <a name="steps_deploy_vdc"></a>Этапы развертывания клонированного виртуализованного контроллера домена

-   [Предварительные требования](../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/Introduction-to-Active-Directory-Domain-Services-AD-DS-Virtualization-Level-100.md#prerequisites)

-   [Шаг 1. Предоставление исходному виртуализованному контроллеру домена разрешение на клонирование](../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/Introduction-to-Active-Directory-Domain-Services-AD-DS-Virtualization-Level-100.md#bkmk4_grant_source)

-   [Шаг 2. Выполните командлет Get-ADDCCloningExcludedApplicationList](../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/Introduction-to-Active-Directory-Domain-Services-AD-DS-Virtualization-Level-100.md#bkmk6_run_get-addccloningexcludedapplicationlist_cmdlet)

-   [Шаг 3. Запустите New-ADDCCloneConfigFile](../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/Introduction-to-Active-Directory-Domain-Services-AD-DS-Virtualization-Level-100.md#bkmk5_create_insert_dccloneconfig)

-   [Шаг 4. Экспорт и последующий импорт виртуальной машины исходного контроллера домена](../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/Introduction-to-Active-Directory-Domain-Services-AD-DS-Virtualization-Level-100.md#bkmk7_export_import_vm_sourcedc)

### <a name="prerequisites"></a>Предварительные требования

-   Для выполнения шагов в следующих процедурах вам необходимо быть членом группы "Администраторы домена" или иметь аналогичные предоставленные разрешения.

-   Команды Windows PowerShell, используемых в этом руководстве необходимо запустить из командной строки с повышенными правами. Чтобы сделать это, щелкните правой кнопкой мыши **Windows PowerShell** значок, а затем щелкните **Запуск от имени администратора**.

-   Сервер Windows Server 2012 с установленной ролью сервера Hyper-V (**HyperV1**).

-   Второй сервер Windows Server 2012 с установленной ролью сервера Hyper-V (**HyperV2**).

    > [!NOTE]
    > -   Если вы используете другой гипервизор, проконсультируйтесь с поставщиком гипервизора, чтобы узнать, поддерживает ли гипервизор ИД создания виртуальной машины. Если гипервизор не поддерживает ИД создания виртуальной машины и вы предоставили файл DCCloneConfig.xml, новая виртуальная машина загрузится в режиме восстановления службы каталогов (DSRM).
    > -   Чтобы повысить доступность служб AD DS, в данном руководстве рекомендуется (и даются соответствующие инструкции) использовать два разных узла Hyper-V, которые помогут предотвратить возможный сбой. Однако для клонирования виртуального контроллера домена не нужно иметь два узла Hyper-V.
    > -   Вы должны быть членом локальной группы администраторов на каждом сервере Hyper-V (**HyperV1** и **HyperV2**).
    > -   Чтобы успешно импортировать и экспортировать файл VHD с помощью Hyper-V, присвойте виртуальным сетевым коммутаторам на обоих узлах Hyper-V одинаковые имена. Например, если имя виртуального сетевого коммутатора **HyperV1** — VNet, виртуальный сетевой коммутатор на **HyperV2** должен также называться VNet.
    > -   Если у двух узлов Hyper-V (**HyperV1** и **HyperV2**) разные процессоры, выключите виртуальную машину (**VirtualDC1**), которую вы планируете экспортировать, щелкните правой кнопкой мыши виртуальную машину, щелкните **Параметры**, затем **Процессор** и в разделе **Совместимость процессоров** выберите **Перенос на физический компьютер с другой версией процессора** и щелкните **ОК**.

-   Развернутые Windows Server 2012 контроллера домена (виртуализованный или физический), на котором размещена роль эмулятора основного контроллера домена (**DC1**). Чтобы узнать, расположена ли роль эмулятора основного контроллера домена на контроллере домена Windows Server 2012, выполните следующую команду Windows PowerShell:

    ```
    Get-ADComputer (Get-ADDomainController "Discover "Service "PrimaryDC").name "Property operatingsystemversion | fl
    ```

    Значение OperatingSystemVersion должно возвращаться как версия 6.2. При необходимости можно перенести роль эмулятора основного контроллера домена к контроллеру домена под управлением Windows Server 2012. Дополнительные сведения см. в разделе [Использование Ntdsutil.exe для переноса или изменения размера ролей FSMO в контроллере домена](https://support.microsoft.com/kb/255504).

-   Развернутые Windows Server 2012 гостевой виртуализованный контроллер домена (**VirtualDC1**), находится в том же домене, что и контроллер домена Windows Server 2012, где находится роль эмулятора основного контроллера домена (**DC1**). Это будет исходный контроллер домена, используемый для клонирования. Гостевой виртуальный контроллер домена будет размещаться на сервере Windows Server 2012 Hyper-V (**HyperV1**).

    > [!NOTE]
    > -   Для успешного клонирования исходный контроллер домена, используемый для создания клона, не может быть из контроллера домена, уровень разрешений которого был понижен с момента создания носителя исходного VHD.
    > -   Выключите исходный контроллер домена до копирования виртуальной машины или ее VHD.
    > -   Не следует клонировать VHD или восстанавливать снимок, который старше значения времени жизни отметки полного удаления (или значения времени жизни удаленного объекта, если включена корзина Active Directory). Если вы копируете VHD существующего контроллера домена, убедитесь, что файл VHD не старше, чем значение времени жизни отметки полного удаления (по умолчанию 60 дней). Не следует копировать VHD работающего контроллера домена для создания носителя клона.

    Извлеките любой виртуальный дисковод гибких дисков (VFD), который может присутствовать на исходном контроллере домена. Это может вызвать проблему общего доступа при попытке импорта новой виртуальной машины.

    Только контроллеры доменов Windows Server 2012, размещенные на гипервизоре виртуальной Машины может использоваться в качестве источника для клонирования. Контроллер домена источника Windows Server 2012, используемый для клонирования, должен быть в работоспособном состоянии. Чтобы определить состояние исходного контроллера домена, выполните команду [dcdiag](https://technet.microsoft.com/library/cc731968(WS.10).aspx). Чтобы лучше понять выходные данные, возвращаемые командой dcdiag, см. в разделе [что делает DCDIAG... сделать? ](http://blogs.technet.com/b/askds/archive/2011/03/22/what-does-dcdiag-actually-do.aspx).

    Если исходный контроллер домена является DNS-сервером, клонированный контроллер домена также будет DNS-сервером. Следует выбрать DNS-сервер, который содержит только зоны, интегрированные с Active Directory.

    Параметры клиента службы DNS не клонируются, но их можно указать в файле DCCloneConfig.xml. Если они не указаны, клонированный контроллер домена будет указывать сам на себя как на основной DNS-сервер по умолчанию. У клонированного контроллера домена не будет делегирования DNS. Администратор родительской зоны DNS при необходимости должен обновить делегирование DNS для клонированного контроллера домена.

    > [!WARNING]
    > Меры безопасности виртуализации не распространяются на службы Active Directory облегченного доступа к каталогам (AD LDS). Поэтому не следует пытаться клонировать контроллер домена AD DS, который содержит экземпляр AD LDS, путем добавления этого экземпляра AD LDS в файл CustomDCCloneAllowList.xml. Так как служба AD LDS не поддерживает ИД создания виртуальной машины, клонирование контроллера домена с AD LDS может вызвать отклонения набора конфигурации этого AD LDS, вызванные откатом номера последовательного обновления.

    Клонирование следующих ролей сервера не поддерживается.

    -   Протокол DHCP

    -   Службы сертификатов Active Directory (AD CS)

    -   Службы Active Directory облегченного доступа к каталогам (AD LDS)

### <a name="bkmk4_grant_source"></a>Шаг 1. Предоставление исходному виртуализованному контроллеру домена разрешение на клонирование
В ходе этой процедуры вы предоставляете исходному контроллеру домена разрешение на клонирование, с помощью **центра администрирования Active Directory** добавляя исходный контроллер домена в группу **Клонируемые контроллеры домена**.

##### <a name="to-grant-the-source-virtualized-domain-controller-the-permission-to-be-cloned"></a>Предоставление исходному виртуализованному контроллеру домена разрешения на клонирование

1.  На любом контроллере домена, который находится в том же домене, что и подготавливаемый к клонированию контроллер домена (**VirtualDC1**), откройте **центр администрирования Active Directory** (ADAC), найдите объект виртуализованного контроллера домена (контроллеры доменов обычно расположены в контейнере **Domain Controllers** центра администрирования Active Directory), щелкните его правой кнопкой мыши, выберите **Добавить в группу** и в разделе **Введите имена выбираемых объектов** введите **Cloneable Domain Controllers** , а затем нажмите **ОК**.

    Обновление членства в группе, выполненное на этом шаге, необходимо реплицировать в эмуляторе PDC до начала клонирования. Если **клонируемые контроллеры домена** группа не найдена, роль эмулятора основного контроллера домена не могут размещаться на контроллере домена под управлением Windows Server 2012.

    > [!NOTE]
    > Чтобы открыть центр администрирования Active Directory на контроллере домена Windows Server 2012, откройте Windows PowerShell и введите **dsac.exe**.

![Введение в AD DS](../media/Introduction-to-Active-Directory-Domain-Services--AD-DS--Virtualization--Level-100-/PowerShellLogoSmall.gif)Windows PowerShell эквивалентные команды ***

Следующий командлет Windows PowerShell выполняет ту же функцию, что и предыдущая процедура.


    Add-ADGroupMember "Identity "CN=Cloneable Domain Controllers,CN=Users, DC=Fabrikam,DC=Com" "Member "CN=VirtualDC1,OU=Domain Controllers,DC=Fabrikam,DC=com"


### <a name="bkmk6_run_get-addccloningexcludedapplicationlist_cmdlet"></a>Шаг 2. Выполните командлет Get-ADDCCloningExcludedApplicationList
В этой процедуре запустите командлет `Get-ADDCCloningExcludedApplicationList` на исходном виртуализованном контроллере домена, чтобы выявить любые программы или службы, которые не включены в клонирование. Командлет Get-ADDCCloningExcludedApplicationList необходимо запустить до командлета New-ADDCCloneConfigFile, потому что если New-ADDCCloneConfigFile обнаружит исключенное приложение, он не создаст файл DCCloneConfig.xml.

##### <a name="to-identify-applications-or-services-that-run-on-a-source-domain-controller-which-have-not-been-evaluated-for-cloning"></a>Выявление приложений или служб, работающих на исходном контроллере домена и не включенных в клонирование

1.  На исходном контроллере домена (**VirtualDC1**) последовательно щелкните **диспетчер серверов**, **Служебные программы** и **Модуль Active Directory для Windows PowerShell**, а затем введите следующую команду.


    Get-ADDCCloningExcludedApplicationList


2.  Обсудите список возвращенных служб и установленных программ с поставщиком программного обеспечения, чтобы выяснить, можно ли их безопасно клонировать. Если приложения или службы в списке нельзя безопасно клонировать, их необходимо удалить с исходного контроллера домена, иначе при клонировании произойдет сбой.

3.  Для набора служб и установленных программ, которые были определены с возможностью безопасного клонирования, выполните команду еще раз с **«GenerateXML** Чтобы подготовить эти службы и программы в **CustomDCCloneAllowList.xml**  файл.


    Get-ADDCCloningExcludedApplicationList -GenerateXml


### <a name="bkmk5_create_insert_dccloneconfig"></a>Шаг 3. Запустить New-ADDCCloneConfigFile
Запустите New-ADDCCloneConfigFile на исходном контроллере домена и при необходимости укажите параметры конфигурации для клонированного контроллера домена, такие как имя, IP-адрес и распознаватель DNS.

Например, чтобы создать клонированный контроллер домена с именем VirtualDC2 и статическим адресом IPv4, введите следующее.


    New-ADDCCloneConfigFile "Static -IPv4Address "10.0.0.2" -IPv4DNSResolver "10.0.0.1" -IPv4SubnetMask "255.255.255.0" -CloneComputerName "VirtualDC2" -IPv4DefaultGateway "10.0.0.3" -SiteName "REDMOND"

> [!NOTE]
> Клонированный контроллер домена будет расположен на том же сайте, что и исходный, если другой сайт не указан в файле DCCloneConfig.xml. Рекомендуется указать подходящий сайт для контроллера домена в файле DCCloneConfig.xml на основе его IP-адреса.

Имя компьютера можно не задавать. Если вы не укажете его, уникальное имя будет присвоено на основании следующего алгоритма.

-   Префикс — первые 8 символов имени компьютера исходного контроллера домена. Например, имя исходного компьютера SourceComputer сокращается в префиксе до SourceCo.

-   Уникальный суффикс имени в формате «"CL*nnnn*» добавляется к строке префикса где *nnnn* является следующее доступное значение диапазона 0001 – 9999, которое PDC определяет сейчас не используется. Например, если "0047" является следующим доступным числом в разрешенном диапазоне, то вместе с префиксом имени компьютера из предыдущего примера SourceCo используемым для клона именем будет SourceCo-CL0047.

> [!NOTE]
> Для успешной работы командлета New-ADDCCloneConfigFile требуется сервер глобального каталога. Членство исходного контроллера домена в **клонируемые контроллеры домена** группы должно быть отражено на сборщик Мусора. Сервер глобального каталога не обязательно должен быть тем же контроллером домена, что и эмулятор основного контроллера домена, но лучше, чтобы они находились на одном объекте. Если глобальный Каталог недоступен, команда завершается с ошибкой «сервер неработоспособен.» Дополнительные сведения см. в разделе [Virtualized Domain Controller Troubleshooting](../ad-ds/manage/virtual-dc/Virtualized-Domain-Controller-Troubleshooting.md).

Чтобы создать клонированный контроллер домена с именем Clone1 и статическими параметрами IPv4, а также указать основной и дополнительный WINS-серверы, введите следующее.


    New-ADDCCloneConfigFile "CloneComputerName "Clone1" "Static -IPv4Address "10.0.0.5" "IPv4DNSResolver "10.0.0.1" "IPv4SubnetMask "255.255.0.0" "PreferredWinsServer "10.0.0.1" "AlternateWinsServer "10.0.0.2"


> [!NOTE]
> Если вы указываете WINS-серверы, должны быть указаны **«PreferredWINSServer** и **«AlternateWINSServer**. Если вы укажете только один из этих аргументов, клонирование завершится с кодом ошибки 0x80041005, который будет записан в dcpromo.log.

Чтобы создать клонированный контроллер домена с именем Clone2 и динамическими параметрами IPv4, введите следующее.


    New-ADDCCloneConfigFile -CloneComputerName "Clone2" -IPv4DNSResolver "10.0.0.1" 


> [!NOTE]
> В этом случае в среде должен присутствовать DHCP-сервер, к которому клон может получить доступ и от которого может получить IP-адрес, а также другие сетевые параметры.

Чтобы создать клонированный контроллер домена с именем Clone2 и динамическими параметрами IPv4, а также указать основной и дополнительный WINS-серверы, введите следующее.


    New-ADDCCloneConfigFile -CloneComputerName "Clone2" -IPv4DNSResolver "10.0.0.1" -SiteName "REDMOND" "PreferredWinsServer "10.0.0.1" "AlternateWinsServer "10.0.0.2"


Чтобы создать клонированный контроллер домена с динамическими параметрами IPv6, введите следующее.


    New-ADDCCloneConfigFile -IPv6DNSResolver "2002:4898:e0:31fc:d61:2b0a:c9c9:2ccc"


Чтобы создать клонированный контроллер домена со статическими параметрами IPv6, введите следующее.


    New-ADDCCloneConfigFile "Static -IPv6DNSResolver "2002:4898:e0:31fc:d61:2b0a:c9c9:2ccc"


> [!NOTE]
> При настройке параметров IPv6, единственное различие между статическими и динамическими параметрами является включение **-статический** переключения. Включение **-статический** коммутатора делает требуется указать по крайней мере один **IPv6DNSResolver**. Ожидается, что статический адрес IPv6 следует настраивать через автоматическую конфигурацию адреса без учета состояния (SLAAC) с префиксами, присвоенными маршрутизатором. В случае динамического IPv6 распознаватели DNS не являются обязательными, но предполагается, что клон можно связаться с сервером с поддержкой IPv6 DHCP в подсети для получения IPv6-адрес и сведения о конфигурации DNS.

#### <a name="BKMK_OfflineMode"></a>Выполнение New-ADDCCloneConfigFile в автономном режиме
Если у вас есть несколько подготовленных для клонирования копий носителя исходного контроллера домена (то есть исходный контроллер домена авторизован на клонирование, командлет Get-ADDCCloningExcludedApplicationList выполнен и так далее) и вы хотите указать разные параметры для каждой копии носителя, можно выполнить New-ADDCCloneConfigFile в автономном режиме. Это эффективнее, чем готовить каждую виртуальную машину отдельно, например импортируя каждую копию.

В этом случае Администраторы домена могут подключать автономный диск и использовать средства удаленного администрирования сервера (RSAT) для выполнения командлета New-ADDCCloneConfigFile с аргумент - offline для добавления XML-файлов, что позволяет фабрики по принципу автоматизации с помощью нового Параметры Windows PowerShell, включенные в Windows Server 2012. Дополнительные сведения о том, как подключать автономный диск для запуска командлета New-ADDCCloneConfigFile в автономном режиме, см. в разделе [Adding XML to the Offline System Disk](../ad-ds/get-started/virtual-dc/Virtualized-Domain-Controller-Deployment-and-Configuration.md#BKMK_Offline).

Сначала необходимо запустить командлет локально на исходном контроллере домена, чтобы убедиться, что проверка необходимых компонентов выполнена успешно. Проверка необходимых компонентов не проводится в автономном режиме, так как командлеты могли бы быть запущены с машины, которая находится в другом домене, или присоединенного к домену компьютера. Запущенный локально командлет создаст файл DCCloneConfig.xml. Локально созданный DCCloneConfig.xml можно удалить, если вы планируете использовать далее автономный режим.

Чтобы создать клонированный контроллер домена с именем CloneDC1 в автономном режиме, на сайте REDMOND» со статическим адресом IPv4, тип:


    New-ADDCCloneConfigFile -Offline -CloneComputerName CloneDC1 -SiteName REDMOND -IPv4Address "10.0.0.2" -IPv4DNSResolver "10.0.0.1" -IPv4SubnetMask "255.255.0.0" -IPv4DefaultGateway "10.0.0.1" -Static -Path F:\Windows\NTDS


Чтобы создать клонированный контроллер домена с именем Clone2 в автономном режиме со статическим адресом IPv4 и статическими параметрами IPv6, введите следующее.


    New-ADDCCloneConfigFile -Offline -IPv4Address "10.0.0.2" -IPv4DNSResolver "10.0.0.1" -IPv4SubnetMask "255.255.0.0" -Static -IPv6DNSResolver "2002:4898:e0:31fc:d61:2b0a:c9c9:2ccc" -CloneComputerName "Clone2" -PreferredWINSServer "10.0.0.1" -AlternateWINSServer "10.0.0.3" -Path F:\Windows\NTDS


Чтобы создать клонированный контроллер домена с именем Clone2 в автономном режиме со статическим IPv4 и динамическими параметрами IPv6, а также указать несколько DNS-серверов для параметров распознавателя DNS, введите следующее.


    New-ADDCCloneConfigFile -Offline -IPv4Address "10.0.0.10" -IPv4SubnetMask "255.255.0.0" -IPv4DefaultGateway "10.0.0.1" -IPv4DNSResolver @( "10.0.0.1","10.0.0.2" ) -Static -IPv6DNSResolver "2002:4898:e0:31fc:d61:2b0a:c9c9:2ccc" -Path F:\Windows\NTDS 


Чтобы создать клонированный контроллер домена с именем Clone1 в автономном режиме с динамическим адресом IPv4 и статическими параметрами IPv6, введите следующее.


    New-ADDCCloneConfigFile -Offline -Static -IPv6DNSResolver "2002:4898:e0:31fc:d61:2b0a:c9c9:2ccc" -CloneComputerName "Clone1" -PreferredWINSServer "10.0.0.1" -AlternateWINSServer "10.0.0.3" -SiteName "REDMOND" -Path F:\Windows\NTDS


Чтобы создать клонированный контроллер домена в автономном режиме с динамическим адресом IPv4 и динамическими параметрами IPv6, введите следующую команду:


    New-ADDCCloneConfigFile -Offline -IPv4DNSResolver "10.0.0.1" -IPv6DNSResolver "2002:4898:e0:31fc:d61:2b0a:c9c9:2ccc" -Path F:\Windows\NTDS


### <a name="bkmk7_export_import_vm_sourcedc"></a>Шаг 4. Экспорт и последующий импорт виртуальной машины исходного контроллера домена
В этой процедуре необходимо экспортировать виртуальную машину исходного виртуализованного контроллера домена и затем импортировать виртуальную машину. В результате в вашем домене будет создан клонированный виртуализованный контроллер домена.

Вы должны быть членом локальной группы администраторов на каждом узле Hyper-V. Если для каждого сервера используются разные учетные данные, выполните командлеты Windows PowerShell, чтобы экспортировать и импортировать виртуальную машину в различных сеансах Windows PowerShell.

Если существуют снимки исходного контроллера домена, их необходимо удалить перед экспортом такого контроллера домена, так как виртуальная машина не будет импортирована, если параметры процессора снимка несовместимы с конечным узлом Hyper-V. Если параметры процессоров исходного и конечного узлов Hyper-V совместимы, вы можете экспортировать и копировать источник без предварительного удаления снимков. Тем не менее после импорта снимки необходимо удалить с клона виртуальной машины перед его запуском.

##### <a name="to-copy-a-virtual-domain-controller-by-exporting-and-then-importing-the-virtualized-source-domain-controller"></a>Копирование виртуального контроллера домена путем экспортирования и последующего импортирования виртуализованного исходного контроллера домена

1.  На **HyperV1** выключите исходный контроллер домена (**VirtualDC1**).

    ![Введение в AD DS](../media/Introduction-to-Active-Directory-Domain-Services--AD-DS--Virtualization--Level-100-/PowerShellLogoSmall.gif)Windows PowerShell эквивалентные команды ***

    STOP-VM-Name HyperV1 VirtualDC1 - ComputerName


2.  На **HyperV1** удалите снимки, а затем экспортируйте исходный контроллер домена (VirtualDC1) в каталог c:\CloneDCs.

> [!NOTE]
> Необходимо удалить все связанные снимки, так как при каждом создании снимка создается новый AVHD-файл, который действует как диск сохранения разницы. Это создает цепной эффект. Если вы создали снимки и вставили файл DCCLoneConfig.xml в VHD, вы можете создать клон из более старой версии DIT или вставить файл конфигурации в неверный файл VHD. При удалении снимка все эти AVHD объединяются в основной VHD.

![Введение в AD DS](../media/Introduction-to-Active-Directory-Domain-Services--AD-DS--Virtualization--Level-100-/PowerShellLogoSmall.gif)Windows PowerShell эквивалентные команды ***


    Get-VMSnapshot VirtualDC1 | Remove-VMSnapshot -IncludeAllChildSnapshots
    Export-VM -Name VirtualDC1 -ComputerName HyperV1 -Path c:\CloneDCs\VirtualDC1


3.  Скопируйте папку **virtualdc1** в каталог c:\Import на **HyperV2**.

4.  На **HyperV2**с помощью **диспетчера Hyper-V**импортируйте виртуальную машину (используйте **мастер импорта виртуальной машины** в **диспетчере Hyper-V**) из папки **c:\Import\virtualdc1** и удалите все связанные **снимки**.

При импорте виртуальной машины используйте параметр **Копировать виртуальную машину (создать новый уникальный идентификатор)** .

![Введение в AD DS](../media/Introduction-to-Active-Directory-Domain-Services--AD-DS--Virtualization--Level-100-/PowerShellLogoSmall.gif)Windows PowerShell эквивалентные команды ***

    $path = Get-ChildItem "C:\CloneDCs\VirtualDC1\VirtualDC1\Virtual Machines"
    $vm = Import-VM -Path $path.fullname -Copy -GenerateNewId
    Rename-VM $vm VirtualDC2


Чтобы создать несколько клонированных контроллеров доменов из одного исходного, сделайте следующее.

  -   Пользовательский интерфейс: в **мастере импорта виртуальной машины** укажите новые расположения для **папки конфигурации виртуальной машины**, **хранилища снимков**, **папки Smart Paging**и другое **расположение** для виртуальных жестких дисков виртуальной машины.

  -   Windows PowerShell: укажите новые расположения для виртуальной машины с помощью следующих параметров для `Import-VM` командлета:

        $path = get-ChildItem «C:\CloneDCs\VirtualDC1\VirtualDC1\Virtual машины» Import-VM-путь $path.fullname - копирования - SnapshotFilePath - VhdDestinationPath - ComputerName HyperV2 «path» - GenerateNewId «path» - SmartPagingFilePath «path» - VirtualMachinePath «путь»


> [!NOTE]
> Рекомендуемый размер партии для одновременного создания нескольких клонированных контроллеров доменов — 10 штук. Максимальное количество ограничено максимальным числом исходящих подключений репликаций, которое по умолчанию составляет 16 для репликации распределенной файловой системы DFS и 10 для службы репликации файлов (FRS). Не следует развертывать больше рекомендованного числа клонированных контроллеров доменов одновременно, если только вы не протестировали тщательно такое количество в своей среде.

5.  На **HyperV1**перезапустите исходный контроллер домена (**VirtualDC1**), чтобы снова подключить его.

![Введение в AD DS](../media/Introduction-to-Active-Directory-Domain-Services--AD-DS--Virtualization--Level-100-/PowerShellLogoSmall.gif)Windows PowerShell эквивалентные команды ***

    Start-VM -Name VirtualDC1 -ComputerName HyperV1


6.  На **HyperV2**запустите виртуальную машину (**VirtualDC2**), чтобы подключить ее как клонированный контроллер домена.

![Введение в AD DS](../media/Introduction-to-Active-Directory-Domain-Services--AD-DS--Virtualization--Level-100-/PowerShellLogoSmall.gif)Windows PowerShell эквивалентные команды ***


    Start-VM -Name VirtualDC2 -ComputerName HyperV2

> [!NOTE]
> Для успешного клонирования должен работать эмулятор основного контроллера домена. Если он был выключен, убедитесь, что он запустился и выполнил начальную синхронизацию, а следовательно, осведомлен о своей роли эмулятора основного контроллера домена. Дополнительные сведения см. в [статье базы знаний Майкрософт 305476](https://support.microsoft.com/kb/305476).

После завершения клонирования проверьте имя компьютера, чтобы убедиться, что клонирование прошло успешно. Убедитесь, что виртуальная машина не запустилась в режиме восстановления службы каталогов. Если при попытке войти в систему отображается сообщение о том, что серверы входа в систему недоступны, попробуйте войти в режиме восстановления службы каталогов. Если клонирование контроллера домена прошло неудачно и он загрузился в режиме восстановления службы каталогов, проверьте журналы в просмотре событий и журналы dcpromo в папке %systemroot%/debug.

Клонированный контроллер домена будет членом группы **Клонируемые контроллеры домена**, потому что копирует членство исходного контроллера домена. Мы рекомендуем оставить группу **Клонируемые контроллеры домена** пустой, пока вы не будете готовы к клонированию. Следует также удалить члены после завершения клонирования.

Если на исходном контроллере домена хранятся носители архивации, клонированный контроллер домена также будет содержать их. Вы можете выполнить `wbadmin get versions` , чтобы отобразить носители архивации на клонированном контроллере домена. Член группы администраторов домена должен удалить носители архивации на клонированном контроллере домена, чтобы предотвратить случайное восстановление с их помощью. Дополнительные сведения о том, как удалять архивацию состояния системы с помощью wbadmin.exe, см. в разделе [Wbadmin delete systemstatebackup](https://technet.microsoft.com/library/cc742081(v=WS.10).aspx).

## <a name="troubleshooting"></a>Устранение неполадок
Если клонированный контроллер домена (**VirtualDC2**) запускается в режиме восстановления службы каталогов, при следующей загрузке он сам не возвращается в нормальный режим. Чтобы войти на контроллер домена, запущенный в режиме восстановления службы каталогов, используйте **.\Administrator** и укажите пароль DSRM.

Устраните причину ошибки клонирования и убедитесь, что в журнале dcpromo.log не указано, что повтор клонирования невозможен. Если повторное клонирование невозможно, безопасно извлеките носитель. Если повторное клонирование возможно, необходимо удалить флажок загрузки в режиме восстановления службы каталогов, чтобы попробовать клонировать заново.

1.  Откройте Windows Server 2012 с помощью командной строки с повышенными (щелкните правой кнопкой Windows Server 2012 и выберите Запуск от имени администратора), а затем введите **msconfig**.

2.  На вкладке **Загрузка** в разделе **Параметры загрузки**снимите флажок **Безопасный режим** (он уже выделен с параметром **Исправление Active Directory включено**).

3.  Щелкните **ОК** и выполните перезагрузку, когда система предложит это.

Дополнительные сведения о диагностике виртуализованных контроллеров доменов см. в разделе [Диагностика виртуализованных контроллеров доменов](../ad-ds/manage/virtual-dc/Virtualized-Domain-Controller-Troubleshooting.md).


