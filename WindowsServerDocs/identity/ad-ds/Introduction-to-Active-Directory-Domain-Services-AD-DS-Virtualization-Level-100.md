---
title: Безопасная виртуализация доменных служб Active Directory (AD DS)
description: Откат USN и безопасная виртуализация Active Directory
ms.topic: article
author: iainfoulds
ms.author: iainfou
manager: daveba
ms.date: 03/22/2019
ms.assetid: 7a3114c8-bda8-49bb-83a8-4e04340ab221
ms.openlocfilehash: fbacb87d99bf5b396e119028e15e8a4aa0c9ef53
ms.sourcegitcommit: 1dc35d221eff7f079d9209d92f14fb630f955bca
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/26/2020
ms.locfileid: "88940984"
---
# <a name="safely-virtualizing-active-directory-domain-services-ad-ds"></a>Безопасная виртуализация доменных служб Active Directory (AD DS)

>Область применения. Windows Server

Начиная с Windows Server 2012, службы AD DS поддерживают виртуализацию контроллеров доменов, предоставляя возможности безопасной виртуализации. В этой статье объясняется роль USN и InvocationID в репликации контроллера домена и обсуждаются некоторые возможные проблемы.

## <a name="update-sequence-number-and-invocationid"></a>Порядковый номер обновления и InvocationID

Виртуальные среды представляют особую трудность для распределенных рабочих потоков, зависящих от логической схемы репликации по времени. Например, репликация AD DS использует равномерно увеличивающееся значение (которое называется USN, или номер последовательного обновления), назначенное транзакциям в каждом контроллере домена. Каждый экземпляр базы данных контроллера домена также получает идентификатор InvocationID. InvocationID контроллера домена и его номер последовательного обновления вместе служат уникальным идентификатором, который связан с каждой транзакцией записи, выполняемой на каждом контроллере домена, и должны быть уникальны в пределах леса.

Репликация AD DS использует InvocationID и номер последовательного обновления на каждом контроллере домена, чтобы определить, какие изменения необходимо повторить на других контроллерах домена. При откате контроллера домена к временной точке за пределами информированности контроллера домена и повторном использовании USN для абсолютно другой транзакции репликация не будет осуществляться, так как другие контроллеры доменов будут считать, что уже получили обновления, связанные с повторно использованным порядковым номером обновления в контексте того же InvocationID.

Например, следующая иллюстрация показывает последовательность событий, происходящих в ОС Windows Server 2008 R2 и более ранних версиях, когда обнаруживается откат номера последовательного обновления на VDC2 — целевом контроллере домена, работающем на виртуальной машине. В этом примере откат порядкового номера обновления обнаруживается на контроллере VDC2, когда партнер репликации замечает, что VDC2 отправил в векторе синхронизации то же значение порядкового номера обновления, которое этот партнер репликации уже отправлял ранее, что указывает на неправильный откат базы данных контроллера VDC2.

![Последовательность событий при обнаружении отката USN](../media/Introduction-to-Active-Directory-Domain-Services--AD-DS--Virtualization--Level-100-/ADDS_Exampleofhowreplicationcanbecomeinconsistent.png)

Виртуальная машина помогает администраторам гипервизора выполнять откат USN контроллера домена (логических часов), например, путем применения снимка за пределами информированности контроллера домена. Дополнительные сведения о номере последовательного обновления и его откате, включая другую иллюстрацию, демонстрирующую невыявленные экземпляры отката номера последовательного обновления, см. в разделе [Номер последовательного обновления и его откат](/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/dd363553(v=ws.10)#usn_and_usn_rollback).

Начиная с Windows Server 2012, виртуальные контроллеры доменов AD DS, размещенные на платформах гипервизоров, которые предоставляют идентификатор VM-Generation, могут применять меры безопасности для защиты среды AD DS, если откат виртуальной машины был своевременно выполнен путем применения снимка виртуальной машины. Структура ИД создания виртуальной машины использует независимый механизм поставщика гипервизора для предоставления этого идентификатора в пространстве адресов гостевой виртуальной машины, поэтому безопасная виртуализация обеспечивается любым гипервизором, который поддерживает ИД создания виртуальной машины. С помощью этого идентификатора службы и приложения, работающие на виртуальной машине, могут определить, выполнялся ли откат виртуальной машины.

## <a name="effects-of-usn-rollback"></a>Влияние отката USN

При откате USN изменения объектов и атрибутов не реплицируются на целевые контроллеры домена, которые ранее уже получали USN.

Так как эти целевые контроллеры домена считают себя обновленными, средства мониторинга и диагностики не фиксируют ошибки репликации в журналах событий службы каталогов.

Откат USN может повлиять на репликацию любого объекта или атрибута в любой секции. Самым распространенным побочным эффектом является отсутствие в одном или нескольких партнерах репликации тех учетных записей пользователей и компьютеров, которые создаются в восстановленном контроллере домена. Может случиться и так, что обновления паролей, созданные на восстановленном контроллере домена, не передаются в партнеры репликации.

Откат USN может помешать репликации объектов Active Directory любого типа в любой секции. Вот некоторые примеры таких типов объектов:

* топология и расписание репликации Active Directory;
* наличие контроллеров домена в лесу и ролей на этих контроллерах домена;
* наличие секций домена и приложений в лесу;
* наличие групп безопасности и участников в этих группах;
* регистрация записей DNS в зонах DNS, которые интегрированы с Active Directory.

Брешь в USN может означать сотни, тысячи или даже десятки тысяч изменений в данных о пользователях, компьютерах, отношениях доверия, паролях и группах безопасности. Размер бреши в USN определяется разницей между самым высоким значением USN, которое существовало на момент создания резервной копии состояния системы, и количеством исходящих изменений, примененных в контроллере домена до его отключения, из-за которого был выполнен откат.

## <a name="detecting-a-usn-rollback"></a>Обнаружение отката USN

Так как откат USN довольно трудно обнаружить, контроллер домена регистрирует событие 2095, когда исходный контроллер домена отправляет ранее подтвержденное значение USN на целевой контроллер домена без соответствующего изменения в invocationID.

Чтобы предотвратить создание уникальных исходящих обновлений Active Directory на неправильно восстановленном контроллере домена, приостанавливается работа службы сетевого входа в систему. Когда служба сетевого входа в систему приостановлена, учетные записи пользователей и компьютеров не могут изменять пароль на том контроллере домена, который не выполняет репликацию таких изменений. Аналогичным образом, при обновлении объектов в Active Directory средства администрирования Active Directory будут предпочитать работоспособный контроллер домена.

В контроллере домена создаются сообщения о событиях, которые представлены ниже, когда соблюдаются следующие условия:

* исходный контроллер домена отправляет ранее подтвержденное значение USN в целевой контроллер домена;
* отсутствуют соответствующие изменения в значении InvocationID.

Такие события могут регистрироваться в журнале событий службы каталогов. Но они могут быть перезаписаны до того, как их заметит администратор.

Если вы подозреваете, что произошел откат USN, но не видите в журналах соответствующих событий, проверьте в реестре наличие записи DSA Not Writable (Запись DSA невозможна). Эта запись служит доказательством того, что случился откат USN.

```
HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\NTDS\Parameters
Registry entry: Dsa Not Writable
Value: 0x4
```

> [!WARNING]
> Если вы вручную удалите или измените запись реестра DSA Not Writable (Запись DSA невозможна), контроллер домена перейдет в невосстановимое и неподдерживаемое состояние. Такие изменения считаются неподдерживаемыми. В частности, изменение этого значения отменяет состояние карантина, которое создается по коду обнаружения отката USN. Разделы Active Directory на восстановленном контроллере домена будут невосстановимо рассогласованными с прямыми и транзитивными партнерами репликации в лесу Active Directory.

См. сведения об этом разделе реестра и действиях по устранению этой проблемы в описании [ошибок репликации 8456 и 8457, когда исходный или конечный сервер отклоняет запросы на репликацию](https://support.microsoft.com/help/2023007/active-directory-replication-error-8456-or-8457-the-source-destination).

## <a name="virtualization-based-safeguards"></a>Меры безопасности на основе виртуализации

Во время установки контроллера домена службы AD DS изначально сохраняют идентификатор VM-GenerationID в составе атрибута msDS-GenerationID на объекте компьютера контроллера домена в локальной базе данных (которую часто называют информационным деревом каталога). ИД создания виртуальной машины независимо отслеживается драйвером Windows на виртуальной машине.

Когда администратор восстанавливает машину из предыдущего снимка, текущее значение ИД создания виртуальной машины от драйвера виртуальной машины сравнивается со значением в DIT.

Если значения отличаются, InvocationID сбрасывается, а пул относительного идентификатора отклоняется, чтобы предотвратить повторное использование номера последовательного обновления. Если значения совпадают, транзакция проводится в обычном режиме.

Службы AD DS также сравнивают текущее значение ИД создания виртуальной машины от виртуальной машины со значением в DIT при каждой перезагрузке контроллера домена. Если значения отличаются, службы сбрасывают InvocationID, отклоняют пул относительного идентификатора и записывают в DIT новое значение. Кроме того, службы синхронизируют папку SYSVOL недоверенным методом, чтобы завершить безопасное восстановление. Это позволяет мерам безопасности расширить применение снимков на отключенных виртуальных машинах. Эти меры безопасности, добавленные в Windows Server 2012, позволяют администраторам AD DS пользоваться уникальными преимуществами развертывания и администрирования контроллеров доменов в виртуализованной среде.

Следующая иллюстрация показывает, как применяются меры безопасности виртуализации при обнаружении отката того же USN на виртуализованном контроллере домена, который работает под управлением Windows Server 2012 на гипервизоре с поддержкой VM-GenerationID.

![Меры безопасности, которые применяются при обнаружении отката USN](../media/Introduction-to-Active-Directory-Domain-Services--AD-DS--Virtualization--Level-100-/ADDS_VDC_Exampleofhowsafeguardswork.gif)

В этом случае, когда гипервизор обнаруживает изменение ИД создания виртуальной машины, срабатывают средства безопасности виртуализации, включая сброс кода обращения виртуализованного контроллера домена (с A на B в предыдущем примере) и обновление ИД создания виртуальной машины, сохраненного на виртуальной машине, для обеспечения соответствия новому значению (G2), которое хранит гипервизор. Меры безопасности обеспечивают выполнение репликации на обоих контроллерах доменов.

Начиная с Windows Server 2012, службы AD DS применяют меры безопасности на виртуальных контроллерах доменов, размещенных на гипервизорах с поддержкой VM-GenerationID, и исключают возможность нарушения среды AD DS при случайном применении снимков или других механизмов гипервизора, которые могут откатить состояние виртуальной машины (путем предотвращения проблем с репликацией из-за неправильных USN или устаревших объектов).

Восстановление контроллера домена с помощью снимка виртуальной машины не рекомендуется применять в качестве альтернативного механизма резервного копирования контроллера домена. Мы рекомендуем и дальше использовать систему архивации данных Windows Server или другие решения для архивации на базе устройств записи VSS.

> [!CAUTION]
> Если контроллер домена в рабочей среде был случайно восстановлен с помощью моментального снимка, мы рекомендуем проконсультироваться с поставщиками приложений и служб, размещенных на этой виртуальной машине, чтобы получить указания по проверке состояния этих программ после такого восстановления.

Дополнительные сведения см. в разделе [Virtualized domain controller safe restore architecture](../ad-ds/get-started/virtual-dc/Virtualized-Domain-Controller-Architecture.md#BKMK_SafeRestoreArch).

## <a name="recovering-from-a-usn-rollback"></a>Восстановление после отката USN

Есть два подхода к восстановлению после отката USN:

* удаление контроллера домена из домена;
* восстановление состояния системы из хорошей резервной копии.

### <a name="remove-the-domain-controller-from-the-domain"></a>Удаление контроллера домена из домена

1. Удалите Active Directory с контроллера домена, чтобы он считал себя автономным сервером.
2. Завершите работу сервера, исключенного из домена.
3. На работоспособном контроллере домена очистите метаданные исключенного контроллера домена.
4. Если неправильно восстановленный контроллер домена размещал роли хозяина операций, перенесите эти роли на работоспособный контроллер домена.
5. Перезапустите сервер, исключенный из домена.
6. При необходимости снова установите Active Directory на этом автономном сервере.
7. Если контроллер домена ранее выполнял функции глобального каталога, настройте на нем эту функцию.
8. Если контроллер домена ранее размещал роли хозяина операций, перенесите эти роли обратно на контроллер домена.

### <a name="restore-the-system-state-of-a-good-backup"></a>Восстановление состояния системы из хорошей резервной копии

Выясните, существуют ли для этого контроллера домена хорошие резервные копии состояния системы. Если допустимая резервная копия состояния системы была создана до момента неправильного восстановления контроллера домена, и она содержит свежие изменения, внесенные в этом контроллере домена, восстановите состояние системы из последней резервной копии.

Также вы можете использовать моментальный снимок в качестве источника резервной копии. Можно также присвоить базе данных новый invocationID, [восстановив виртуальный контроллер домена без резервной копии состояния системы](/previous-versions/windows/it-pro/windows-server-2008-r2-and-2008/dd363553%28v%3dws.10%29#restoring-a-virtual-domain-controller-when-an-appropriate-system-state-data-backup-is-not-available).

## <a name="next-steps"></a>Дальнейшие действия

* Дополнительные сведения об устранении неполадок виртуализированных контроллеров домена см. в разделе [Virtualized Domain Controller Troubleshooting](../ad-ds/manage/virtual-dc/Virtualized-Domain-Controller-Troubleshooting.md).
* [См. сведения о службе времени Windows (W32time)](../../networking/windows-time-service/windows-time-service-top.md)
