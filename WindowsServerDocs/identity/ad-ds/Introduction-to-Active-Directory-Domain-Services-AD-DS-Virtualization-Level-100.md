---
ms.assetid: 7a3114c8-bda8-49bb-83a8-4e04340ab221
title: "Знакомство с виртуализацией службы (AD DS) домена Active Directory (уровень 100)"
description: 
author: billmath
ms.author: billmath
manager: femila
ms.date: 05/31/2017
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: identity-adds
ms.openlocfilehash: 3c7fdc2e20bc4a27f2555af54f396a15f664d6c7
ms.sourcegitcommit: db290fa07e9d50686667bfba3969e20377548504
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/12/2017
---
# <a name="introduction-to-active-directory-domain-services-ad-ds-virtualization-level-100"></a>Знакомство с виртуализацией службы (AD DS) домена Active Directory (уровень 100)

>Область применения: Windows Server 2016, Windows Server 2012 R2, Windows Server 2012

Виртуализация сред доменных служб Active Directory (AD DS) были текущих в течение нескольких лет. Начиная с Windows Server 2012, AD DS предоставляют лучшую поддержку виртуализации контроллеров доменов благодаря возможностям безопасной виртуализации и быстрого развертывания виртуальных контроллеров доменов посредством клонирования. Эти новые возможности виртуализации обеспечивают отличную поддержку общедоступных и частных облаков, гибридных сред где некоторые части AD DS находятся локально и в облаке, а также инфраструктур AD DS, которые полностью размещаются локальными.

**В этом документе**

-   [Безопасная виртуализация контроллеров домена](../ad-ds/Introduction-to-Active-Directory-Domain-Services-AD-DS-Virtualization-Level-100.md#safe_virt_dc)

-   [Клонирование виртуализированного контроллера домена](../ad-ds/Introduction-to-Active-Directory-Domain-Services-AD-DS-Virtualization-Level-100.md#virtualized_dc_cloning)

-   [Этапы развертывания клонированного виртуализованного контроллера домена](../ad-ds/Introduction-to-Active-Directory-Domain-Services-AD-DS-Virtualization-Level-100.md#steps_deploy_vdc)

-   [Устранение неполадок](../ad-ds/Introduction-to-Active-Directory-Domain-Services-AD-DS-Virtualization-Level-100.md#troubleshooting)

## <a name="safe_virt_dc"></a>Безопасная виртуализация контроллеров домена
Виртуальные среды представляют особую трудность для распределенных рабочих потоков, зависящих от схемы логических репликации. Например, репликация AD DS использует равномерно увеличивающееся значение (называется USN, или номер последовательного обновления) назначенное транзакциям в каждом контроллере домена. Экземпляр базы данных для каждого контроллера домена также получает идентификатор под названием InvocationID. InvocationID контроллера домена и его номер последовательного обновления вместе служат уникальный идентификатор, связанный с каждой транзакцией записи, выполняемой на каждом контроллере домена и должно быть уникальным в пределах леса.

Репликация AD DS использует InvocationID и номер последовательного обновления на каждом контроллере домена, чтобы определить, какие изменения необходимо быть реплицированы на другие контроллеры домена. Если откате контроллера домена к временной точке за пределами информированности контроллера домена, USN для абсолютно другой транзакции репликация не будет осуществляться, так как другие контроллеры доменов будут считать, что уже получили обновления, связанные с повторно использованным номером последовательного обновления в контексте данного InvocationID.

Например Следующая иллюстрация показывает последовательность событий, которая возникает в Windows Server 2008 R2 и более ранних операционных систем при обнаружении отката номера последовательного обновления на VDC2 конечного контроллера домена, на котором работает на виртуальной машине. В этом примере откат номера последовательного обновления происходит на контроллере VDC2, когда партнер по репликации регистрирует, что VDC2 отправил значение номера последовательного обновления синхронизации, которое уже отправлял ранее Этот партнер по репликации, которое указывает, что VDC2 отката базы данных времени неправильно.

![Введение в Доменных службах Active Directory](../media/Introduction-to-Active-Directory-Domain-Services--AD-DS--Virtualization--Level-100-/ADDS_Exampleofhowreplicationcanbecomeinconsistent.png)

Виртуальной машины (VM) облегчает администраторам гипервизора откат домена контроллера номеров последовательного обновления (его логических часов) благодаря, например, применению снимка за пределами информированности контроллера домена. Дополнительные сведения о номера последовательного обновления и ЕГО откате, включая другую иллюстрацию, демонстрирующую невыявленные экземпляры отката номера последовательного обновления в разделе [USN и откат USN](https://technet.microsoft.com/library/virtual_active_directory_domain_controller_virtualization_hyperv(WS.10).aspx#usn_and_usn_rollback).

Начиная с Windows Server 2012, контроллеры виртуального домена AD DS, размещенные на платформах гипервизоров, которые предоставляют идентификатор ИД VM-Generation можно определять и применять необходимые меры безопасности для защиты среды AD DS, если виртуальная машина выполняется откат времени путем применения снимка виртуальной Машины. Структура VM-GenerationID использует независимый механизм поставщика гипервизора для предоставления этого идентификатора в пространстве адресов гостевой виртуальной машины, поэтому безопасная виртуализация обеспечивается любым гипервизором, который поддерживает VM-GenerationID. Этот идентификатор можно выборочные службами и приложениями, которые выполняются на виртуальной машине для обнаружения, если виртуальная машина был выполнен откат времени.

### <a name="BKMK_HowSafeguardsWork"></a>Принцип работы мер безопасности виртуализации
Во время установки контроллера домена AD DS изначально сохраняют идентификатор ИД создания виртуальной Машины как части атрибута msDS-GenerationID объекта-компьютера контроллера домена в своей базе данных (часто называют информационным деревом каталога, или DIT). ИД создания виртуальной Машины независимо отслеживается драйвером Windows на виртуальной машине.

Когда администратор восстанавливает машину из предыдущего снимка, текущее значение ИД создания виртуальной Машины из драйвера виртуальной машины сравнивается со значением в DIT.

Если значения отличаются, invocationID сбрасывается, а пул относительного идентификатора отклоняется, чтобы предотвратить использование номера последовательного обновления повторно. Если значения совпадают, транзакция проводится в обычном режиме.

AD DS также сравнивают текущее значение ИД создания виртуальной Машины из виртуальной машины со значением в DIT при каждом контроллере домена после перезагрузки и, если отличаются, службы сбрасывают invocationID, отклоняют пул относительного идентификатора и записывают в DIT новое значение. Он также непринудительно синхронизируют папку SYSVOL, чтобы завершить безопасное восстановление. Это позволяет мерам безопасности расширить применение снимков на отключенных виртуальных машинах. Эти меры безопасности, появившиеся в Windows Server 2012 позволяют администраторам AD DS, чтобы воспользоваться преимуществами уникальные преимущества развертывания и управления контроллерами доменов в виртуализованной среде.

На следующем рисунке показано, как применяются меры безопасности виртуализации при обнаружении отката того же номера последовательного обновления на виртуализованном контроллере домена под управлением Windows Server 2012 на гипервизоре, поддерживающем VM-GenerationID.

![Введение в Доменных службах Active Directory](../media/Introduction-to-Active-Directory-Domain-Services--AD-DS--Virtualization--Level-100-/ADDS_VDC_Exampleofhowsafeguardswork.gif)

В этом случае когда гипервизор обнаруживает изменение VM-GenerationID, срабатывают средства безопасности виртуализации, включая сброс InvocationID виртуализованного контроллера домена (с A на B в предыдущем примере) и обновление VM-GenerationID, сохраненного на виртуальной Машине, для соответствия новому значению (G2), которое хранит гипервизор. Меры безопасности обеспечивают выполнение репликации на обоих контроллерах доменов.

С Windows Server 2012 AD DS применяют меры безопасности на контроллерах домена, размещенных на гипервизорах VM-GenerationID и гарантирует, что случайном применении снимков или других гипервизором механизмов, которые могут отката состояние виртуальной машины не нарушит среды AD DS (путем предотвращения проблем репликации, таких как номера последовательного обновления или замедление объектов). Однако восстановление контроллера домена путем применения снимка виртуальной машины не рекомендуется в качестве альтернативного механизма архивации контроллера домена. Рекомендуется продолжать использовать архивации данных Windows Server или другие решения на основе записи VSS для архивации.

> [!CAUTION]
> Если контроллер домена в рабочей среде был случайно восстановлен с помощью снимка, рекомендуется что проконсультироваться с поставщиками приложений и служб, размещенных на этой виртуальной машине, руководство по проверке состояния этих программ после моментальный снимок восстановления.

Дополнительные сведения см. в разделе [архитектура виртуализированных контроллеров доменов безопасного восстановления](../ad-ds/get-started/virtual-dc/Virtualized-Domain-Controller-Architecture.md#BKMK_SafeRestoreArch).

## <a name="virtualized_dc_cloning"></a>Клонирование виртуализированного контроллера домена
Начиная с Windows Server 2012, администраторы могут легко и безопасно развертывать реплики контроллеров доменов путем копирования существующего виртуального контроллера домена. В виртуальной среде администраторам больше не нужно постоянно развертывать образ сервера, подготовленного с помощью sysprep.exe, повышать уровень сервера до контроллера домена и затем выполнять дополнительные требования конфигурации для развертывания каждой реплики контроллера домена.

> [!NOTE]
> Необходимо следовать процедурам развертывание первого контроллера домена в домене, в частности использовать sysprep.exe для подготовки сервера виртуального жесткого диска (VHD), повышать уровень сервера до контроллера домена и выполнения дополнительных требований конфигурации. В сценарии аварийного восстановления используйте последнюю версию архивации сервера для восстановления первого контроллера домена в домене.

### <a name="scenarios-that-benefit-from-virtual-domain-controller-cloning"></a>Сценарии, которые выигрывают от клонирования виртуального контроллера домена

-   Быстрое развертывание дополнительных контроллеров домена в новом домене

-   Быстрое возобновление непрерывной работы во время аварийного восстановления путем восстановления емкости AD DS посредством быстрого развертывания контроллеров домена с помощью клонирования

-   Оптимизация развертывания частного облака путем гибкой подготовки контроллеров доменов к повышенным требованиям масштабирования

-   Быстрая подготовка тестовой среды для развертывания и тестирования новых компонентов и возможностей до реализации в рабочей среде

-   Быстрое увеличение емкости в филиалах путем клонирования существующих контроллеров домена в офисах филиалов

При быстром развертывании большого количества контроллеров домена, продолжайте следовать существующим процедурам проверки работоспособности каждого контроллера домена после завершения установки. Развертывайте контроллеры доменов партиями разумного, чтобы вы могли проверить работоспособность после завершения каждого пакета установки. Рекомендованный размер партии – 10. Дополнительные сведения см. в разделе [этапы развертывания клонированного виртуализованного контроллера домена](../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/Introduction-to-Active-Directory-Domain-Services-AD-DS-Virtualization-Level-100.md#steps_deploy_vdc).

### <a name="clear-separation-of-responsibilities"></a>Четкое разделение ответственности
— Авторизацию на клонирование виртуализованных контроллеров доменов контролирует администратор AD DS. Чтобы Администраторы гипервизоров могли развертывать дополнительные контроллеры доменов путем копирования виртуальных контроллеров домена администратор AD DS должен выбрать и авторизовать контроллер домена, а затем выполнить подготовительные шаги, чтобы сделать его источником клонирования.

Подготовка виртуальной машины обычно в сферу ответственности администратора гипервизора, такие администраторы могут подготавливать реплики виртуальных машин контроллеров доменов путем копирования виртуализованных контроллеров доменов, авторизовал и подготовил для клонирования администратор AD DS.

> [!WARNING]
> Любой пользователь разрешается администрировать гипервизор, размещающий контроллер домена должен быть высокой доверенные и проверялась в среде.

### <a name="how-does-virtual-domain-controller-cloning-work"></a>Принцип работы клонирования виртуального контроллера домена
Процесс клонирования включает создание копии VHD существующего контроллера домена (или в более сложных конфигураций — виртуальной Машины контроллера домена), ее авторизацию для клонирования в AD DS и создание файла конфигурации клона. Это сокращает количество шагов и время, необходимое для развертывания реплики виртуального контроллера домена, в противном случае устраняя повторяющихся задач развертывания.

Клонированный контроллер домена использует следующие условия, чтобы обнаружить, что он является копией другого контроллера домена:

1.  Значение идентификатора VM-Generation, указанное для виртуальной машины отличается от значения идентификатора VM-Generation, хранящегося в DIT.

    > [!NOTE]
    > Платформа гипервизора должна поддерживать ИД VM-Generation (Windows Server 2012 Hyper-V поддерживает VM-Generation ID).

2.  Наличие файла с именем DCCloneConfig.xml в одном из следующих расположений:

    -   Каталог, где находится DIT

    -   %windir%\NTDS

    -   Корне съемного носителя

Если условия выполнены, оно проходит процесс клонирования, чтобы подготовить себя в качестве реплики контроллера домена.

Клонированный контроллер домена использует контекст безопасности исходного контроллера домена (контроллер домена, копией которого он является) для связи с Windows Server 2012 основного контроллера домена (PDC) эмулятора операций держателем роли хозяина (известные также как гибкие операции с единым хозяином или FSMO). Эмулятор основного контроллера домена должны работать под управлением Windows Server 2012, но он может не работать в низкоуровневой оболочке.

> [!NOTE]
> Если у вас есть расширение схемы с атрибутами, ссылающимися на исходный контроллер домена и атрибут находится на одном из объектов, скопированных (объекте-компьютере, объекте параметров NTDS) для создания клона, этот атрибут не будет скопирован или обновлен, чтобы ссылаться на клонированный контроллер домена.

Убедившись, что запрошенный контроллер домена авторизован для клонирования, эмулятор основного контроллера домена создаст новый идентификатор машины, включая новую учетную запись, ИД безопасности, имя и пароль, которые идентифицируют эту машину как реплику контроллера домена и отправит эти сведения клону. Клонированный контроллер домена подготовит файлы базы данных AD DS к работе в качестве реплики и его очистит область машины.

Дополнительные сведения см. в разделе [виртуализованных контроллеров доменов, архитектура клонирования](../ad-ds/get-started/virtual-dc/Virtualized-Domain-Controller-Architecture.md#BKMK_CloneArch).

### <a name="cloning-components"></a>Компоненты клонирования
Компоненты клонирования включают командлеты в модуле Active Directory для Windows PowerShell и связанные XML-файлы.

-   **New-ADDCCloneConfigFile** «этот командлет создает и размещает DCCloneConfig.xml в надлежащем расположении, чтобы он был доступен для запуска клонирования. Он также выполняет проверки предварительных требований, чтобы гарантировать успешное клонирование. Она включена в модуль Active Directory для Windows PowerShell. Его можно запускать локально на виртуализованном контроллере домена, который готовится для клонирования, или его можно запускать удаленно с помощью параметра - offline. Можно указать параметры для клонированного контроллера домена, такие как его имя, сайт и IP-адрес.

    Ниже перечислены необходимые предварительные проверки, выполняемые его

    > [!NOTE]
    > Проверка не выполняется при «автономного используется. Дополнительные сведения см. в разделе [выполнения New-ADDCCloneConfigFile в автономном режиме](../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/Introduction-to-Active-Directory-Domain-Services-AD-DS-Virtualization-Level-100.md#BKMK_OfflineMode).

    -   Подготавливаемый контроллер домена авторизован для клонирования (является членом **клонируемые контроллеры домена** группы)

    -   Эмулятор основного контроллера домена работает под управлением Windows Server 2012.

    -   Любые программы или службы, перечисленные в выполнения **Get-ADDCCloningExcludedApplicationList** включены в CustomDCCloneAllowList.xml (поясняется более подробно в конце этого списка компонентов для клонирования).

-   **DCCloneConfig.xml** » для успешного клонирования виртуализованного контроллера домена, этот файл должен находиться в каталоге, где находится DIT *%windir%\NTDS*, или в корневом каталоге съемного носителя. Этот файл является одним из триггеров для определения и инициации клонирования, он также предоставляет средства для определения параметров конфигурации для клонированного контроллера домена.

    Схема и образец файла DCCloneConfig.xml хранятся на всех компьютерах Windows Server 2012:

    -   %windir%\system32\DCCloneConfigSchema.xsd

    -   %windir%\system32\SampleDCCloneConfig.XML

    Рекомендуется использовать командлет New-ADDCCloneConfigFile, чтобы создать файл DCCloneConfig.xml. Несмотря на то, что для создания этого файла можно также использовать файл схемы с XML-редактором, изменение вручную увеличивает вероятность ошибки. Если изменить файл, она должна выполняться с помощью XML-редакторов, таких как Visual Studio [XML Notepad](https://www.microsoft.com/download/details.aspx?displaylang=en&id=7973), или сторонние приложения (нельзя использовать Блокнот).

-   **Get-ADDCCloningExcludedApplicationList** «этот командлет запускается на исходном контроллере домена перед началом процесса клонирования, чтобы определить, какие службы или установленные программы не входят в список поддерживаемых по умолчанию, DefaultDCCloneAllowList.xml или определяемый пользователем список включения указанный файл CustomDCCloneAllowList.xml и следовательно, не были учтены при анализе клонирования.

    Этот командлет ищет исходного контроллера домена для служб в диспетчере служб и установленные программы, перечисленные в разделе **HKLM\Software\Microsoft\Windows\CurrentVersion\Uninstall**, которые не указаны в (DefaultDCCloneAllowList.xml) списка по умолчанию или, если он указан, в список включения пользовательских (CustomDCCloneAllowList.xml file). Список приложений и служб, возвращаемое при выполнении командлета — различие между что уже предоставляются в DefaultDCCloneAllowList.xml или CustomDCCloneAllowList.xml файл и список, который создается во время выполнения зависимости от установленных на исходном контроллере домена. Выходные данные службы и программы из Get-ADDCCloningExcludedApplicationList можно добавить в файл CustomDCCloneAllowList.xml, если вы обнаружите, что службы и программы можно безопасно клонировать. Чтобы определить, если безопасность клонирования службы или установленной программы, Оцените следующие условия:

    -   — Служба или установленная программа затронутые идентификатор машины, такие как имя, ИД безопасности, пароль и т. д?

    -   Хранит служба или установленная программа любой локально на компьютере, могут снизить ее работоспособность на клоне?

    Следует проконсультироваться с поставщиком программного обеспечения, приложения, чтобы определить, если службы или установленной программы может быть безопасно клонировать.

    > [!NOTE]
    > Перед подготовкой дополнительных служб или программ в файле CustomDCCloneAllowList.xml, проверьте наличие необходимая лицензия на копирование программного обеспечения, содержащегося на этой виртуальной машине.

    Если приложения не подлежат клонированию, удалите их с исходного контроллера домена до создания клонированного носителя. Если приложение отображается в выходных данных командлета, но не включаются в файл CustomDCCloneAllowList.xml, клонирование будет невозможно. Чтобы гарантировать успешное клонирование, выходные данные командлета не должны содержать никаких служб или программ. Другими словами приложение следует либо включено в файл CustomDCCloneAllowList.xml или удалить из исходного контроллера домена.

    В таблице ниже описываются параметры для выполнения Get-ADDCCloningExcludedApplicationList.

    |||
    |-|-|
    |Аргумент|Объяснение|
    |*<no argument specified>*|Отображает список служб или программ в консоли, которые не были учтены для клонирования. Если уже CustomDCCloneAllowList.XML во всех допустимых расположениях, он использует этот файл для отображает оставшихся служб и программ (которых может не быть, если списки совпадают).|
    |-GenerateXml|Создает файл CustomDCCloneAllowList.XML, заполненный службами и программами, перечисленными в консоли.|
    |-Force|Перезаписывает существующий файл CustomDCCloneAllowList.XML.|
    |-Path|Путь к папке для создания CustomDCCloneAllowList.XML.|

-   **DefaultDCCloneAllowList.xml** "Этот файл присутствует по умолчанию в каждом Windows Server 2012 домена контроллера в  %windir%\system32 В нем перечислены службы и установленные программы, которые можно безопасно клонировать по умолчанию. Изменять расположение или содержимое этого файла нельзя, иначе клонирование будет невозможно.

-   **CustomDCCloneAllowList.xml** «Если у вас есть службы или установленные программы, размещенные на вашем исходном контроллере домена, которые входят в файле DefaultDCCloneAllowList.xml, эти службы и программы должна включаться в этот файл. Чтобы найти службы или установленные программы, которые не перечислены в файле DefaultDCCloneAllowList.xml, запустите **Get-ADDCCloningExcludedApplicationList** командлета. Следует использовать **» GenerateXml** аргумент для создания XML-файл.

    Процесс клонирования проверяет следующие расположения в порядке, для этого файла и использует первый найденный, вне зависимости от содержимого других папок XML-файл.

    1.  Следующий раздел реестра:

        ```
        HKey_Local_Machine\System\CurrentControlSet\Services\NTDS\Parameters
        AllowListFolder (REG_SZ)
        ```

    2.  Рабочая папка DSA

    3.  %systemroot%\NTDS

    4.  Носитель съемных чтения и записи, в порядке букв диска

### <a name="deployment-scenarios"></a>Сценарии развертывания
Следующие сценарии поддерживаются для клонирования виртуального контроллера домена:

-   Развертывание клонированного контроллера домена путем создания копии файла виртуального жесткого диска (vhd) исходного контроллера домена.

-   Развертывание клонированного контроллера домена путем копирования виртуальной машины исходного контроллера домена, с помощью семантики экспорта/импорта, предоставленной гипервизором.

> [!NOTE]
> Действия, описанные в разделе [этапы развертывания клонированного виртуализованного контроллера домена](../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/Introduction-to-Active-Directory-Domain-Services-AD-DS-Virtualization-Level-100.md#steps_deploy_vdc) описывают копирование виртуальной машины, с помощью функции экспорта/импорта Windows Server 2012 Hyper-V.

## <a name="steps_deploy_vdc"></a>Этапы развертывания клонированного виртуализованного контроллера домена

-   [Предварительные требования](../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/Introduction-to-Active-Directory-Domain-Services-AD-DS-Virtualization-Level-100.md#prerequisites)

-   [Шаг 1: Предоставление исходному виртуализованному контроллеру домена разрешения на клонирование](../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/Introduction-to-Active-Directory-Domain-Services-AD-DS-Virtualization-Level-100.md#bkmk4_grant_source)

-   [Шаг 2: Запуск Get-ADDCCloningExcludedApplicationList командлета](../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/Introduction-to-Active-Directory-Domain-Services-AD-DS-Virtualization-Level-100.md#bkmk6_run_get-addccloningexcludedapplicationlist_cmdlet)

-   [Шаг 3: Запуск New-ADDCCloneConfigFile](../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/Introduction-to-Active-Directory-Domain-Services-AD-DS-Virtualization-Level-100.md#bkmk5_create_insert_dccloneconfig)

-   [Шаг 4: Экспорт и затем импортировать виртуальную машину от исходного контроллера домена](../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/../ad-ds/Introduction-to-Active-Directory-Domain-Services-AD-DS-Virtualization-Level-100.md#bkmk7_export_import_vm_sourcedc)

### <a name="prerequisites"></a>Предварительные требования

-   Для выполнения шагов в следующих процедурах, необходимо быть членом группы "Администраторы домена" или иметь аналогичные предоставленные разрешения к нему.

-   Команды Windows PowerShell, используемых в этом руководстве необходимо запустить из командной строки с повышенными привилегиями. Чтобы сделать это, щелкните правой кнопкой мыши **Windows PowerShell**, а затем **Запуск от имени администратора**.

-   Сервер Windows Server 2012 с установленной ролью сервера Hyper-V (**HyperV1**).

-   Второй сервер Windows Server 2012 с установленной ролью сервера Hyper-V (**HyperV2**).

    > [!NOTE]
    > -   Если вы используете другой гипервизор, проконсультируйтесь с поставщиком гипервизора, чтобы узнать, поддерживает ли гипервизор ИД VM-Generation. Если гипервизор не поддерживает ИД VM-Generation и вы предоставили файл DCCloneConfig.xml, Новая виртуальная машина загрузится в режиме восстановления служб каталогов (DSRM).
    > -   Чтобы повысить доступность служб AD DS, в этом руководстве рекомендует и инструкции, используя два разных узла Hyper-V, которые помогут предотвратить возможный сбой. Тем не менее двух узлов Hyper-V для выполнения клонирования виртуального контроллера домена необязательно.
    > -   Вы должны быть членом локальной группы администраторов на каждом сервере Hyper-V (**HyperV1** и **HyperV2**).
    > -   Чтобы успешно импортировать и экспортировать файл VHD с помощью Hyper-V, виртуальным сетевым коммутаторам на обоих узлах Hyper-V должен иметь то же имя. Например, если у вас есть имя виртуального сетевого коммутатора **HyperV1** называться VNet, а затем должна быть виртуальный сетевой коммутатор на **HyperV2** называться VNet.
    > -   Если два узла Hyper-V (**HyperV1** и **HyperV2**) имеют разные процессоры, выключите виртуальную машину (**VirtualDC1**), вы планируете экспортировать, щелкните правой кнопкой мыши виртуальную Машину, щелкните **параметры**, нажмите кнопку **процессора**и в разделе **совместимость процессоров** выберите **выполнить перенос на физический компьютер с другой версией процессора** и нажмите кнопку **ОК**.

-   Развернутые Windows Server 2012 контроллера домена (виртуализованный или физический), на котором находится роль эмулятора основного контроллера домена (**DC1**). Чтобы проверить, ли роль эмулятора PDC размещается на контроллере домена Windows Server 2012, выполните следующую команду Windows PowerShell:

    ```
    Get-ADComputer (Get-ADDomainController "Discover "Service "PrimaryDC").name "Property operatingsystemversion | fl
    ```

    Значение OperatingSystemVersion должно возвращаться как версия 6.2. При необходимости, можно перенести роль эмулятора основного контроллера домена на контроллере домена под управлением Windows Server 2012. Дополнительные сведения см. в разделе [использование Ntdsutil.exe для переноса или изменения размера ролей FSMO в контроллере домена](https://support.microsoft.com/kb/255504).

-   Развернутые Windows Server 2012 гостевой виртуализованный контроллер домена (**VirtualDC1**), находится в том же домене, контроллер домена Windows Server 2012, где находится роль эмулятора основного контроллера домена (**DC1**). Это будет исходный контроллер домена, используемый для клонирования. Гостевой виртуальный контроллер домена будет размещаться на сервере Windows Server 2012 Hyper-V (**HyperV1**).

    > [!NOTE]
    > -   Для успешного клонирования исходный контроллер домена, который используется для создания клона, не может быть из контроллера домена, который был понижен с момента создания носителя исходного VHD.
    > -   Выключите исходный контроллер домена до копирования виртуальной Машины или ее VHD.
    > -   Не следует клонировать VHD или восстанавливать снимок, который старше значения времени жизни отметки полного удаления (или значения времени жизни удаленного объекта, если включена Корзина Active Directory). Если вы копируете VHD существующего контроллера домена, убедитесь, что файл VHD не старше, чем значение времени жизни отметки полного удаления (по умолчанию 60 дней). Не следует копировать VHD работающего контроллера домена для создания носителя клона.

    Извлеките любой виртуальный дисковод гибких дисков (VFD) на исходном, возможно, контроллер домена. Это может вызвать проблему общего доступа при попытке импорта новой виртуальной Машины.

    Только контроллеры домена Windows Server 2012, размещенные на гипервизоре VM-GenerationID можно использовать в качестве источника для клонирования. Контроллер домена источника Windows Server 2012, используемый для клонирования должен находиться в работоспособном состоянии. Чтобы определить состояние исходного контроллера домена, выполните команду [dcdiag](https://technet.microsoft.com/library/cc731968(WS.10).aspx). Чтобы лучше понять выходные данные, возвращаемые командой dcdiag, изучите раздел [что делает DCDIAG... сделать?](http://blogs.technet.com/b/askds/archive/2011/03/22/what-does-dcdiag-actually-do.aspx).

    Если исходный контроллер домена является DNS-сервером, клонированный контроллер домена также будет DNS-сервера. Следует выбирать, содержит только интегрированный с Active Directory зоны DNS-сервера.

    Параметры клиента службы DNS не клонируются, но их можно указать в файле DCCloneConfig.xml. Если они не указаны, клонированный контроллер домена будет указывать сам на себя как предпочитаемый DNS-сервер по умолчанию. Клонированный контроллер домена не будет делегирования DNS. Администратор родительской зоны DNS должен обновить делегирование DNS для клонированного контроллера домена при необходимости.

    > [!WARNING]
    > Меры безопасности виртуализации не распространяются на службы Active Directory облегченного доступа к каталогам (AD LDS). Поэтому не следует пытаться клонировать контроллер домена AD DS, который содержит экземпляр AD LDS, путем добавления этого экземпляра AD LDS в файл CustomDCCloneAllowList.xml. Так как AD LDS не учитывать идентификатор VM-Generation, клонирование контроллера домена с AD LDS может вызвать расхождение вызванные откатом номера последовательного обновления этого AD LDS набора конфигурации.

    Для клонирования не поддерживаются следующие роли сервера:

    -   Протокол DHCP (DHCP)

    -   Службы сертификатов Active Directory (AD CS)

    -   Службы Active Directory облегченного доступа к каталогам (AD LDS)

### <a name="bkmk4_grant_source"></a>Шаг 1: Предоставление исходному виртуализованному контроллеру домена разрешения на клонирование
В этой процедуры вы предоставляете исходному контроллеру домена разрешение на клонирование, с помощью **Центр администрирования Active Directory** Добавление исходный контроллер домена в **клонируемые контроллеры домена** группы.

##### <a name="to-grant-the-source-virtualized-domain-controller-the-permission-to-be-cloned"></a>Предоставление исходному виртуализованному контроллеру домена разрешения на клонирование

1.  На любом контроллере домена в том же домене, что и контроллер домена, который готовится для клонирования (**VirtualDC1**), откройте **Центр администрирования Active Directory** (ADAC), найдите объект контроллера домена виртуализированных (контроллеры домена обычно находятся в папке **контроллеры домена** контейнера в центр администрирования Active Directory), щелкните его правой кнопкой мыши, выберите **добавить в группу** и в разделе **введите имена выбираемых объектов** тип **клонируемые контроллеры домена** и нажмите кнопку **ОК**.

    Обновление членства в группе, выполненное на этом шаге необходимо реплицировать в эмуляторе PDC до начала клонирования. Если **клонируемые контроллеры домена** группа не найдена, роль эмулятора основного контроллера домена не может размещаться на контроллере домена под управлением Windows Server 2012.

    > [!NOTE]
    > Чтобы открыть центр администрирования Active Directory на контроллере домена Windows Server 2012, откройте Windows PowerShell и введите **dsac.exe**.

![Введение в Доменных службах Active Directory](../media/Introduction-to-Active-Directory-Domain-Services--AD-DS--Virtualization--Level-100-/PowerShellLogoSmall.gif)Windows PowerShell эквивалентные команды ***

Следующий командлет Windows PowerShell выполняет ту же функцию, что и предыдущая процедура.


    Add-ADGroupMember "Identity "CN=Cloneable Domain Controllers,CN=Users, DC=Fabrikam,DC=Com" "Member "CN=VirtualDC1,OU=Domain Controllers,DC=Fabrikam,DC=com"


### <a name="bkmk6_run_get-addccloningexcludedapplicationlist_cmdlet"></a>Шаг 2: Запуск Get-ADDCCloningExcludedApplicationList командлета
В этой процедуре запустите `Get-ADDCCloningExcludedApplicationList`командлет на исходном Виртуализированный контроллер домена, чтобы выявить любые программы или службы, которые не включены в клонирование. Необходимо запустить командлет Get-ADDCCloningExcludedApplicationList до командлета New-ADDCCloneConfigFile, так как если командлет New-ADDCCloneConfigFile обнаружит исключенное приложение, он не создаст файл DCCloneConfig.xml.

##### <a name="to-identify-applications-or-services-that-run-on-a-source-domain-controller-which-have-not-been-evaluated-for-cloning"></a>Выявление приложений или служб, работающих на исходном контроллере домена, которые не были учтены для клонирования

1.  На исходном контроллере домена (**VirtualDC1**), нажмите кнопку **диспетчера сервера**, нажмите кнопку **средства**, нажмите кнопку **модуль Active Directory для Windows PowerShell** и введите следующую команду:


    Get-ADDCCloningExcludedApplicationList


2.  Обсудите список возвращенных служб и установленных программ с поставщиком программного обеспечения, чтобы определить, является ли их можно безопасно клонировать. Если приложения или службы в списке нельзя безопасно клонировать, их необходимо удалить с исходного контроллера домена, иначе клонирование будет невозможно.

3.  Набор служб и установленные программы, которые были определены безопасно клонировать, выполните команду еще раз, используя **» GenerateXML** Чтобы подготовить эти службы и программы в **CustomDCCloneAllowList.xml** файла.


    Get-ADDCCloningExcludedApplicationList - GenerateXml


### <a name="bkmk5_create_insert_dccloneconfig"></a>Шаг 3: Запуск New-ADDCCloneConfigFile
Запустите New-ADDCCloneConfigFile на исходном контроллере домена и при необходимости укажите параметры конфигурации для клонированного контроллера домена, такие как имя, IP-адрес и распознаватель DNS.

Например чтобы создать клонированный контроллер домена с именем VirtualDC2 и статическим адресом IPv4, введите следующую команду:


    New-ADDCCloneConfigFile "Static -IPv4Address "10.0.0.2" -IPv4DNSResolver "10.0.0.1" -IPv4SubnetMask "255.255.255.0" -CloneComputerName "VirtualDC2" -IPv4DefaultGateway "10.0.0.3" -SiteName "REDMOND"

> [!NOTE]
> Клонированный контроллер домена будет расположен на том же сайте, что исходный контроллер домена, если другой сайт указан в файле DCCloneConfig.xml. Рекомендуется указать подходящий сайт в файле DCCloneConfig.xml для клонированного контроллера домена, на основе IP-адреса.

Имя компьютера является необязательным. Если вы не укажете его, уникальное имя будет присвоено на основании следующего алгоритма.

-   Префикс — первые 8 символов имени компьютера контроллера домена источника. Например имя исходного компьютера SourceComputer усекается до строку префикса SourceCo.

-   Уникальный суффикс имени в формате «» CL*nnnn*"добавляется к строке префикса где *nnnn*является следующее доступное значение из 0001-9999 которое PDC определяет в настоящее время не используется. Например если 0047 является следующим доступным числом в разрешенном диапазоне, с помощью префиксом имени компьютера из предыдущего примера sourceco используемым для клона именем будет использоваться SourceCo-cl0047.

> [!NOTE]
> Для успешной работы командлета New-ADDCCloneConfigFile требуется сервер глобального каталога (GC). Членство исходного контроллера домена в **клонируемые контроллеры домена** группы должно быть отражено на сервере глобального Каталога. Сервер глобального Каталога не обязательно тем же контроллером домена, роль эмулятора основного контроллера домена, но желательно использовать он должен находиться в том же сайте. Если сервер глобального Каталога недоступен, команда завершается с ошибкой «сервер неработоспособен.» Дополнительные сведения см. в разделе [Диагностика виртуализованного контроллера домена](../ad-ds/manage/virtual-dc/Virtualized-Domain-Controller-Troubleshooting.md).

Чтобы создать клонированный контроллер домена с именем Clone1 и статическими параметрами IPv4, а также указать основной и дополнительный WINS-серверы, введите:


    New-ADDCCloneConfigFile "CloneComputerName "Clone1" "Static -IPv4Address "10.0.0.5" "IPv4DNSResolver "10.0.0.1" "IPv4SubnetMask "255.255.0.0" "PreferredWinsServer "10.0.0.1" "AlternateWinsServer "10.0.0.2"


> [!NOTE]
> Если вы указываете WINS-серверы, необходимо указать и **» PreferredWINSServer** и **» AlternateWINSServer**. Если вы укажете только один из этих аргументов, клонирование завершится с ошибкой кодом 0x80041005 в dcpromo.log.

Чтобы создать клонированный контроллер домена с именем clone2 и динамическими параметрами IPv4, введите следующую команду:


    New-ADDCCloneConfigFile -CloneComputerName "Clone2" -IPv4DNSResolver "10.0.0.1" 


> [!NOTE]
> В этом случае должно существовать DHCP-сервера в среде, что клона можно получить доступ и получать IP-адрес и другие сетевые параметры.

Чтобы создать клонированный контроллер домена с именем clone2 и динамическими параметрами IPv4, а также указать основной и дополнительный WINS-серверы, введите:


    New-ADDCCloneConfigFile -CloneComputerName "Clone2" -IPv4DNSResolver "10.0.0.1" -SiteName "REDMOND" "PreferredWinsServer "10.0.0.1" "AlternateWinsServer "10.0.0.2"


Чтобы создать клонированный контроллер домена с динамическими параметрами IPv6, введите следующую команду:


    New-ADDCCloneConfigFile -IPv6DNSResolver "2002:4898:e0:31fc:d61:2b0a:c9c9:2ccc"


Чтобы создать клонированный контроллер домена со статическими параметрами IPv6, введите следующую команду:


    New-ADDCCloneConfigFile "Static -IPv6DNSResolver "2002:4898:e0:31fc:d61:2b0a:c9c9:2ccc"


> [!NOTE]
> Указывая параметры IPv6 единственной разницей между статическими и динамическими параметрами является включение **-статический** переключения. Включение **-статический** коммутатора делает требуется указать по крайней мере один **IPv6DNSResolver**. Ожидается, что статический адрес IPv6 следует настраивать через автоматическую конфигурацию адреса без учета состояния (SLAAC) с префиксами, присвоенными маршрутизатором. В случае динамического IPv6 распознаватели DNS не являются обязательными, но ожидается, что клона можно связаться с поддержкой IPv6 DHCP-сервера в подсети, чтобы получить адрес IPv6 и сведения о конфигурации DNS.

#### <a name="BKMK_OfflineMode"></a>Выполнение New-ADDCCloneConfigFile в автономном режиме
Если у вас есть несколько копий носителя исходного контроллера домена, подготовленных для клонирования (то есть исходный контроллер домена авторизован для клонирования, командлет Get-ADDCCloningExcludedApplicationList выполнения и т. д) и вы хотите указать разные параметры для каждой копии носителя, можно выполнить New-ADDCCloneConfigFile в автономном режиме. Это может быть эффективнее, чем готовить каждую виртуальную Машину, к примеру, импортируя каждую копию отдельно.

В этом случае Администраторы домена могут подключить автономный диск и использовать средства удаленного администрирования сервера (RSAT) для запуска командлета New-ADDCCloneConfigFile с аргумент - offline для добавления XML-файлов, что обеспечивает близкую к заводской автоматизацию благодаря новым параметрам Windows PowerShell, включенным в Windows Server 2012. Дополнительные сведения о том, как подключать автономный диск для запуска командлета New-ADDCCloneConfigFile в автономном режиме см. в разделе [Добавление XML в автономный системный диск](../ad-ds/get-started/virtual-dc/Virtualized-Domain-Controller-Deployment-and-Configuration.md#BKMK_Offline).

Сначала следует запустить командлет локально на исходном носителе, чтобы убедиться, что проверка необходимых компонентов выполнена успешно. Проверка необходимых компонентов не проводится в автономном режиме, так как командлеты могли быть запущены с машины, которая не может быть из того же домена или на компьютере, присоединенном к домену. После выполнения командлета локально, он будет создан файл DCCloneConfig.xml. Вы можете удалить файл DCCloneConfig.xml, создается локально, если вы планируете использовать далее автономный режим.

Чтобы создать клонированный контроллер домена с именем CloneDC1 в автономном режиме на сайте REDMOND» со статическим адресом IPv4, введите:


    New-ADDCCloneConfigFile -Offline -CloneComputerName CloneDC1 -SiteName REDMOND -IPv4Address "10.0.0.2" -IPv4DNSResolver "10.0.0.1" -IPv4SubnetMask "255.255.0.0" -IPv4DefaultGateway "10.0.0.1" -Static -Path F:\Windows\NTDS


Чтобы создать клонированный контроллер домена с именем Clone2 в автономном режиме со статическим адресом IPv4 и статическими параметрами IPv6, введите:


    New-ADDCCloneConfigFile -Offline -IPv4Address "10.0.0.2" -IPv4DNSResolver "10.0.0.1" -IPv4SubnetMask "255.255.0.0" -Static -IPv6DNSResolver "2002:4898:e0:31fc:d61:2b0a:c9c9:2ccc" -CloneComputerName "Clone2" -PreferredWINSServer "10.0.0.1" -AlternateWINSServer "10.0.0.3" -Path F:\Windows\NTDS


Чтобы создать клонированный контроллер домена в автономном режиме со статическим адресом IPv4 и динамическими параметрами IPv6, а также указать несколько DNS-серверов для параметров распознавателя DNS, введите:


    New-ADDCCloneConfigFile -Offline -IPv4Address "10.0.0.10" -IPv4SubnetMask "255.255.0.0" -IPv4DefaultGateway "10.0.0.1" -IPv4DNSResolver @( "10.0.0.1","10.0.0.2" ) -Static -IPv6DNSResolver "2002:4898:e0:31fc:d61:2b0a:c9c9:2ccc" -Path F:\Windows\NTDS 


Чтобы создать клонированный контроллер домена с именем Clone1 в автономном режиме с динамическим адресом IPv4 и статическими параметрами IPv6, введите:


    New-ADDCCloneConfigFile -Offline -Static -IPv6DNSResolver "2002:4898:e0:31fc:d61:2b0a:c9c9:2ccc" -CloneComputerName "Clone1" -PreferredWINSServer "10.0.0.1" -AlternateWINSServer "10.0.0.3" -SiteName "REDMOND" -Path F:\Windows\NTDS


Чтобы создать клонированный контроллер домена в автономном режиме с динамическим адресом IPv4 и динамическими параметрами IPv6, введите следующую команду:


    New-ADDCCloneConfigFile -Offline -IPv4DNSResolver "10.0.0.1" -IPv6DNSResolver "2002:4898:e0:31fc:d61:2b0a:c9c9:2ccc" -Path F:\Windows\NTDS


### <a name="bkmk7_export_import_vm_sourcedc"></a>Шаг 4: Экспорт и затем импортировать виртуальную машину от исходного контроллера домена
В этой процедуре необходимо экспортировать виртуальную машину исходного виртуализованного контроллера домена, а затем Импорт виртуальной машины. Это действие создает клона виртуализованного контроллера домена в домене.

Необходимо быть членом локальной группы администраторов на каждом узле Hyper-V. Если вы используете другие учетные данные для каждого сервера, запустите командлеты Windows PowerShell для экспорта и импорта виртуальной Машины в различных сеансах Windows PowerShell.

Если существуют снимки исходного контроллера домена, их необходимо удалить перед исходного контроллера домена, так как виртуальная машина не будет импортирована, если параметры процессора, которые несовместимы с конечным узлом hyper-v моментального снимка. Если параметры процессора совместимы исходного и конечного узлов hyper-v, можно экспортировать и копировать источник без предварительного удаления снимков. После импорта, однако снимки необходимо удалить с клона виртуальной Машины перед его запуском.

##### <a name="to-copy-a-virtual-domain-controller-by-exporting-and-then-importing-the-virtualized-source-domain-controller"></a>Копирование виртуального контроллера домена путем экспортирования и последующего импортирования виртуализованного исходного контроллера домена

1.  На **HyperV1**, выключите исходный контроллер домена (**VirtualDC1**).

    ![Введение в Доменных службах Active Directory](../media/Introduction-to-Active-Directory-Domain-Services--AD-DS--Virtualization--Level-100-/PowerShellLogoSmall.gif)Windows PowerShell эквивалентные команды ***

    Stop-VM-имя - ComputerName HyperV1 VirtualDC1


2.  На **HyperV1**удалите снимки, а затем экспортируйте исходный контроллер домена (VirtualDC1) в каталог c:\CloneDCs.

> [!NOTE]
> Необходимо удалить все связанные снимки, так как каждый раз, когда моментальный снимок, создается новый AVHD-файл, который действует как диск сохранения разницы. Это создает цепной эффект. Если вы создали снимки и вставили файл DCCLoneConfig.xml в VHD, могут оказаться создать клон из более старой версии DIT или вставить файл конфигурации в неверный файл VHD. Удаление моментального снимка объединяет все эти AVHD объединяются в основной VHD.

![Введение в Доменных службах Active Directory](../media/Introduction-to-Active-Directory-Domain-Services--AD-DS--Virtualization--Level-100-/PowerShellLogoSmall.gif)Windows PowerShell эквивалентные команды ***


    Get-VMSnapshot VirtualDC1 | Remove-VMSnapshot -IncludeAllChildSnapshots
    Export-VM -Name VirtualDC1 -ComputerName HyperV1 -Path c:\CloneDCs\VirtualDC1


3.  Скопируйте папку **virtualdc1** каталог c:\Import **HyperV2**.

4.  На **HyperV2**, с использованием **диспетчера Hyper-V**, импорта виртуальной машины (с помощью **импорта виртуальной машины** мастера в **диспетчера Hyper-V**) из папки **c:\Import\virtualdc1** и удалите все связанные **моментальные снимки**.

Используйте **копировать виртуальную машину (создать новый уникальный идентификатор)** при импорте виртуальной машины.

![Введение в Доменных службах Active Directory](../media/Introduction-to-Active-Directory-Domain-Services--AD-DS--Virtualization--Level-100-/PowerShellLogoSmall.gif)Windows PowerShell эквивалентные команды ***

    $path = Get-ChildItem "C:\CloneDCs\VirtualDC1\VirtualDC1\Virtual Machines"
    $vm = Import-VM -Path $path.fullname -Copy -GenerateNewId
    Rename-VM $vm VirtualDC2


Чтобы создать несколько клонированных контроллеров домена из одного исходного контроллера домена:

  -   Пользовательский Интерфейс: в **Импорт виртуальной машины** мастера, укажите новые расположения для **папки конфигурации виртуальной машины**, **хранилища моментальных снимков**, **папки Smart Paging**и другое **расположение** для виртуальных жестких дисков для виртуальной машины.

  -   Windows PowerShell: укажите новые расположения для виртуальной машины с помощью следующих параметров для `Import-VM`командлета:

        $path = Get-ChildItem «C:\CloneDCs\VirtualDC1\VirtualDC1\Virtual компьютеры» Import-VM-$path.fullname путь-путь» - VirtualMachinePath - SmartPagingFilePath «пути» копирования - SnapshotFilePath - VhdDestinationPath - ComputerName HyperV2 «пути» - GenerateNewId «пути»»


> [!NOTE]
> Рекомендуемый размер партии для одновременного создания нескольких клонированных контроллеров доменов — 10. Максимальное количество ограничено максимальным числом исходящих подключений репликаций, которое по умолчанию составляет 16 для репликации распределенной файловой системы (DFSR) и 10 для службы репликации файлов (FRS). Не следует развертывать больше, чем рекомендуемое число клонированных контроллеров доменов одновременно, пока для вашей среды протестировали тщательно такое количество.

5.  На **HyperV1**, перезапустите исходный контроллер домена (**(VirtualDC1**), чтобы снова подключить его.

![Введение в Доменных службах Active Directory](../media/Introduction-to-Active-Directory-Domain-Services--AD-DS--Virtualization--Level-100-/PowerShellLogoSmall.gif)Windows PowerShell эквивалентные команды ***

    Start-VM -Name VirtualDC1 -ComputerName HyperV1


6.  На **HyperV2**, запустите виртуальную машину (**VirtualDC2**), чтобы подключить ее как клонированный контроллер домена в домене.

![Введение в Доменных службах Active Directory](../media/Introduction-to-Active-Directory-Domain-Services--AD-DS--Virtualization--Level-100-/PowerShellLogoSmall.gif)Windows PowerShell эквивалентные команды ***


    Start-VM -Name VirtualDC2 -ComputerName HyperV2

> [!NOTE]
> Для успешного клонирования должен работать эмулятор основного контроллера домена. Если он был выключен, убедитесь, что он запустился и выполнил начальную синхронизацию, поэтому он, осведомлен о своей роли эмулятора основного контроллера домена. Дополнительные сведения см. в разделе Microsoft [статье БАЗЫ знаний 305476](https://support.microsoft.com/kb/305476).

После завершения клонирования Проверьте имя компьютера, чтобы убедиться, что клонирование прошло успешно. Убедитесь, что виртуальная машина не запустилась в режиме восстановления служб каталогов (DSRM). При попытке войти в систему и сообщение об ошибке, указывающее, что серверы входа в систему недоступны, попробуйте войти в режиме DSRM. Если не удалось клонируйте контроллер домена загружается в режиме DSRM, проверьте журналы в просмотре событий и журналы dcpromo в папке %systemroot%/debug.

Клонированный контроллер домена будет членом **клонируемые контроллеры домена** группы, потому что копирует членство исходного контроллера домена. Рекомендуется, следует оставить **клонируемые контроллеры домена** пустой, пока вы готовы к клонированию, следует также удалить члены после завершения операции клонирования.

Если исходный контроллер домена хранятся носители архивации, клонированный контроллер домена также будет хранить резервного носителя. Можно запустить `wbadmin get versions`чтобы отобразить носители архивации на клонированном контроллере домена. Является членом группы администраторов домена должен удалить носители архивации на клонированном контроллере домена, чтобы предотвратить случайное восстановление. Дополнительные сведения о том, как удалять архивацию состояния системы с помощью wbadmin.exe см. в разделе [Wbadmin delete systemstatebackup](https://technet.microsoft.com/library/cc742081(v=WS.10).aspx).

## <a name="troubleshooting"></a>Устранение неполадок
Если клонированный контроллер домена (**VirtualDC2**) запускается в режиме восстановления служб каталогов (DSRM), он не возвращается в обычный режим самостоятельно при следующей перезагрузке. Чтобы войти на контроллер домена, запущенный в режиме DSRM, используйте **. \Administrator** и укажите пароль DSRM.

Устраните причину ошибки клонирования и убедитесь, что dcpromo.log не указано, что клонирование невозможно повторно. Если клонирование невозможно повторно, безопасно Извлеките носитель. Если повторное клонирование возможно, необходимо удалить флаг загрузки режима восстановления служб Каталогов, чтобы повторить попытку клонирования.

1.  Откройте Windows Server 2012 с помощью команд с повышенными привилегиями (справа выберите Windows Server 2012 и выбрать команду "Запуск от имени администратора), а затем введите **msconfig**.

2.  На **загрузки** в разделе **параметры загрузки**, снимите **безопасной загрузки** (он уже выделен с параметром **исправление Active Directory включено**).

3.  Нажмите кнопку **ОК** и выполните перезагрузку.

Дополнительные сведения о диагностике виртуализованных контроллеров доменов, в разделе [Диагностика виртуализованного контроллера домена](../ad-ds/manage/virtual-dc/Virtualized-Domain-Controller-Troubleshooting.md).


