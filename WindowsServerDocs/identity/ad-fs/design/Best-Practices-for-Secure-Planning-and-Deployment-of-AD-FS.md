---
ms.assetid: 963a3d37-d5f1-4153-b8d5-2537038863cb
title: "Рекомендации по безопасному планированию и развертыванию AD FS"
description: 
author: billmath
ms.author: billmath
manager: femila
ms.date: 05/31/2017
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: identity-adfs
ms.openlocfilehash: ed8c36d4bec455879ffd00ad40b72fd5e90484ab
ms.sourcegitcommit: db290fa07e9d50686667bfba3969e20377548504
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/12/2017
---
# <a name="best-practices-for-secure-planning-and-deployment-of-ad-fs"></a>Рекомендации по безопасному планированию и развертыванию AD FS

>Область применения: Windows Server 2016, Windows Server 2012 R2, Windows Server 2012

Этот раздел содержит рекомендации для планирования и оценке безопасности при проектировании развертывания служб федерации Active Directory (AD FS). Этот раздел является отправной точкой для анализа и оценки аспектов, влияющих на общую безопасность использования Служб федерации Active Directory. Сведения в этом разделе, предназначена для дополняют и расширяют существующие планирования безопасности и другие рекомендации разработки.  
  
## <a name="core-security-best-practices-for-ad-fs"></a>Основные рекомендации по безопасности AD FS  
Следующие базовые рекомендации являются общими для всех установок AD FS которой требуется расширить или усовершенствовать безопасность системы или развертывания.  
  
-   **Используйте мастер настройки безопасности для применения рекомендаций по безопасности AD FS конкретных серверов федерации и прокси-сервера федерации компьютеров**  
  
    Мастер настройки безопасности (SCW) — это средство, который предустанавливается на Windows Server 2008, Windows Server 2008 R2 и Windows Server 2012 компьютеров. Его можно использовать для применения рекомендаций, которые могут помочь снизить вероятность атак для сервера, на основе ролей сервера, которые вы устанавливаете безопасности.  
  
    При установке AD FS программа установки создает роли расширения файлов, которые можно использовать вместе с Мастером для создания политики безопасности, которая будет применяться к конкретной службы федерации Active Directory серверной роли (серверу федерации или прокси-сервера федерации), выбранной во время установки.  
  
    Каждый устанавливаемый файл расширения роли представляет тип роли и подроли, для которой настроен каждый компьютер. Следующие файлы расширения роли установлены в каталоге C:WindowsADFSScw:  
  
    -   Farm.xml  
  
    -   SQLFarm.xml  
  
    -   StandAlone.xml  
  
    -   Proxy.xml (этот файл присутствует, только в том случае, если компьютер настроен в роли прокси-сервера федерации).  
  
    Для применения расширений роли AD FS в мастере конфигурации безопасности, выполните следующие действия в порядке.  
  
    1.  Установите AD FS и выберите соответствующую серверную роль для этого компьютера. Дополнительные сведения см. в разделе [установки службы роли прокси-сервера службы федерации](../../ad-fs/deployment/Install-the-Federation-Service-Proxy-Role-Service.md) в руководстве по развертыванию AD FS.  
  
    2.  Зарегистрируйте соответствующий файл расширения роли с помощью командной строки Scwcmd. См. в следующей таблице подробные сведения об использовании этого инструмента в роли, для которой настроен ваш компьютер.  
  
    3.  Убедитесь, что команда выполнена успешно, изучив файл SCWRegister_log.xml, который находится в каталоге WindowssecurityMsscwLogs.  
  
    Необходимо выполнить следующие действия для каждого сервера федерации или прокси-серверов федерации для применения политик безопасности AD FS мастера конфигурации.  
  
    Следующей таблице объясняется, как зарегистрировать соответствующее расширение роли мастера настройки безопасности на основе роли сервера AD FS, выбранной на компьютере, где установлена служба AD FS.  
  
    |Роль сервера AD FS|Используемая база данных конфигурации AD FS|В командной строке введите следующую команду:|  
    |---------------------|-------------------------------------|---------------------------------------------------|  
    |Изолированный сервер федерации|Внутренняя база данных Windows|`scwcmd register /kbname:ADFS2Standalone /kbfile:"WindowsADFSscwStandAlone.xml"`|  
    |Объединенный в ферму сервер федерации|Внутренняя база данных Windows|`scwcmd register /kbname:ADFS2Standalone /kbfile:"WindowsADFSscwFarm.xml"`|  
    |Объединенный в ферму сервер федерации|SQL Server|`scwcmd register /kbname:ADFS2Standalone /kbfile:"WindowsADFSscwSQLFarm.xml"`|  
    |Прокси-сервера федерации|Н/Д|`scwcmd register /kbname:ADFS2Standalone /kbfile:"WindowsADFSscwProxy.xml"`|  
  
    Дополнительные сведения о базах данных, которые можно использовать с AD FS см. в разделе [роль базы данных конфигурации AD FS](../../ad-fs/technical-reference/The-Role-of-the-AD-FS-Configuration-Database.md).  
  
-   **Используйте обнаружение воспроизведения токена в ситуациях, где безопасность имеет первостепенное значение, например, когда киосками.**  
    Обнаружение воспроизведения токена — это компонент AD FS, которая гарантирует, что обнаружение на воспроизведение токена, адресованных службе федерации, и запрос будет отклонен. Обнаружение воспроизведения токенов включено по умолчанию. Он работает как для пассивного профиля WS-Federation и для профиля WebSSO разметки языка SAML (Security Assertion), гарантируя, что один токен никогда не используется несколько раз.  
  
    При запуске службы федерации начинает создаваться кэш выполняемых запросов токена, он удовлетворяет. Со временем при добавлении в кэш последующих запросов токена многократное возможность обнаружить любые попытки воспроизведение токена несколько раз для службы федерации. Если обнаружение воспроизведения токенов отключено, а затем принимается решение о необходимости снова включить, помните, что службе федерации, по-прежнему принимать токены в течение определенного времени, возможно, был использован ранее, пока кэш воспроизведения был разрешен достаточно времени для перестроит свое содержимое. Дополнительные сведения см. в разделе [роль базы данных конфигурации AD FS](../../ad-fs/technical-reference/The-Role-of-the-AD-FS-Configuration-Database.md).  
  
-   **Используйте шифрование токенов, особенно в том случае, если вы используете вспомогательным разрешением артефактов SAML.**  
  
    Шифрование токенов, настоятельно рекомендуется по соображениям безопасности и защиты от потенциальных атак в середине (MITM), которые может быть использован для развертывания Служб федерации Active Directory. Использование шифрования может иметь незначительно повлиять во всей, но в целом не следует заметят задержки и во многих развертываниях преимущества для большей безопасности превышают неудобства от снижения производительности сервера.  
  
    Для включения шифрования токенов сначала настройте или добавьте сертификат шифрования для отношений доверия с проверяющей стороной. Можно настроить сертификат шифрования можно при создании с проверяющей стороной доверия или более поздней версии. Чтобы добавить сертификат шифрования существующие доверия проверяющей стороны, можно задать сертификат для использования на **шифрования** вкладку в свойства доверия, с помощью оснастки Служб федерации Active Directory. Чтобы указать сертификат для существующего отношения доверия, с помощью командлетов AD FS, используйте параметр EncryptionCertificate какого-либо **Set-ClaimsProviderTrust** или **Set-RelyingPartyTrust** командлетов. Чтобы установить сертификат для службы федерации будет использоваться при расшифровке токенов, используйте **Set-ADFSCertificate** командлет и укажите «`Token-Encryption`» для *CertificateType* параметра. Включение и отключение шифрования для определенной проверяющей стороны отношений доверия можно сделать с помощью *EncryptClaims* параметр **Set-RelyingPartyTrust** командлета.  
  
-   **Использование расширенной защиты для проверки подлинности**  
  
    Чтобы обеспечить безопасность развертывания, можно настроить и использовать расширенную защиту для проверки подлинности с помощью AD FS. Этот параметр определяет уровень расширенной защиты для проверки подлинности, поддерживаемых сервером федерации.  
  
    Расширенная защита для проверки подлинности обеспечивает защиту от атак в середине (MITM), в которых злоумышленник перехватывает клиентские учетные данные и пересылает их на сервер. Защита от таких атак становится возможной через канал привязки токена (CBT), который может быть либо требуется, разрешенного или не требуется на сервере при установке связи с клиентами.  
  
    Для включения функции расширенной защиты, используйте **ExtendedProtectionTokenCheck** параметр на **Set-ADFSProperties** командлета. В следующей таблице приводятся возможные значения этого параметра и уровень безопасности, обеспечиваемый этими значениями.  
  
    |Значение параметра|Уровень безопасности|Параметр защиты|  
    |-------------------|------------------|----------------------|  
    |Требуется|Сервер полностью защищен.|Расширенная защита активирована и требуется всегда.|  
    |Разрешить|Сервер частично защищен.|Расширенная защита активирована, где соответствующих системах установлены исправления для поддержки этой функции.|  
    |Нет|Сервер не защищен.|Расширенная защита не активирована.|  
  
-   **При использовании ведения журнала и трассировки, необходимо обеспечить сохранность конфиденциальной.**  
  
    Службы федерации Active Directory не по умолчанию предоставляет и не отслеживает сведениями (PII) в рамках службы федерации или нормальной работы. Если ведение журнала событий и трассировки отладки включены в AD FS, тем не менее, в зависимости от политики утверждений, настроить некоторые утверждений типы и связанные значения могут содержать личные сведения, которые будут фиксироваться в событий Служб федерации Active Directory или журналы трассировки.  
  
    Таким образом контроль доступа в конфигурации AD FS и файлах журнала настоятельно рекомендуется. Если не хотите, чтобы эти сведения, которые должны быть видимы, необходимо отключить ведение или отфильтровывать ЛИЧНЫЕ или конфиденциальные данные в журналах, прежде чем использовать их совместно с другими пользователями.  
  
    Следующие советы помогут избежать случайного предоставления содержимого файла журнала.  
  
    -   Убедитесь, что журнал событий Служб федерации Active Directory и файлы журнала трассировки защищены списками управления доступом (ACL), ограничивающих доступ только доверенным администраторам, которым требуется доступ к ним.  
  
    -   Не копируйте и не архивируйте файлы журнала, используя файловые расширения или пути, которые можно легко обслуживались с использованием веб-запроса. Например расширения имени XML-файла не является безопасным подходом. Руководство по администрированию Internet Information Services (IIS), чтобы просмотреть список расширений, которые могут обрабатываться можно проверить.  
  
    -   При пересмотре пути к файлу журнала, не забудьте указать абсолютный путь к местоположению файла журнала, которое должно находиться за пределами каталога веб-узла виртуального корневого открытый для предотвращения доступа третьим лицам через веб-браузер.  

-   **AD FS Extranet Lockout защиты**  
    
    В случае атаки в форме запросы на проверку подлинности с помощью паролей invalid(bad), проходящие через прокси веб-приложения блокировки экстрасети AD FS позволяет защитить пользователей от блокировки учетной записи службы федерации Active Directory. Помимо защиты пользователей от AD FS блокировка учетной записи, блокировка экстрасети AD FS также обеспечивает защиту от атак подбора пароля.  Дополнительные сведения см. [защиты блокировки экстрасети AD FS](../../ad-fs/operations/Configure-AD-FS-Extranet-Lockout-Protection.md).  
  
## <a name="sql-serverspecific-security-best-practices-for-ad-fs"></a>SQL Server — рекомендации безопасности для служб AD FS  
Следующие рекомендации по безопасности, характерные для использования Microsoft SQL Server® или внутренней базы данных Windows (WID), при использовании для управления данными в AD FS разработке и развертыванию этих технологий базы данных.  
  
> [!NOTE]  
> Эти рекомендации предназначены для расширения, но не заменяют инструкции по обеспечению безопасности SQL Server. Дополнительные сведения о планировании безопасной установки SQL Server см. в разделе [вопросов безопасности для безопасной установки SQL](https://go.microsoft.com/fwlink/?LinkID=139831) (https://go.microsoft.com/fwlink/?LinkID=139831).  
  
-   **Всегда развертывайте SQL Server за брандмауэром в физически безопасной сетевой среде.**  
  
    Установка SQL Server должен быть никогда не предъявляется непосредственно к Интернету. Только те компьютеры, которые находятся внутри центра обработки данных должен иметь возможность Установка SQL server, поддерживающий AD FS. Дополнительные сведения см. в разделе [безопасности контрольный список](https://go.microsoft.com/fwlink/?LinkID=189229) (https://go.microsoft.com/fwlink/?LinkID=189229).  
  
-   **Запустите SQL Server с учетной записью службы, вместо того чтобы использовать учетные записи по умолчанию встроенных системных служб.**  
  
    По умолчанию SQL Server часто устанавливается и настраивается для использования одной из поддерживаемых встроенных системных учетных записей, таких как LocalSystem или NetworkService. Для повышения безопасности установки SQL Server для AD FS, везде, где можно использовать отдельной учетной записи службы для доступа к службе SQL Server и включить проверку подлинности Kerberos, регистрируя имя участника безопасности (SPN) данной учетной записи в развертывании Active Directory. Это обеспечивает взаимную аутентификацию клиента и сервера. Без регистрации имени участника-службы для отдельной учетной записи службы SQL Server будет использовать проверку подлинности на основе NTLM для Windows, подразумевающую аутентификацию только клиента.  
  
-   **Минимизация контактной зоны сервера SQL Server.**  
  
    Включите только те конечные точки SQL Server, которые необходимы. По умолчанию SQL Server предоставляет одну встроенную конечную точку TCP, не могут быть удалены. Для служб AD FS, необходимо включить эту конечную точку TCP для проверки подлинности Kerberos. Чтобы просмотреть текущий конечные точки TCP и узнать, если для установки SQL добавлены дополнительные пользовательские TCP-порты, можно использовать «ВЫБЕРИТЕ * FROM sys.tcp_endpoints» запроса инструкции в сеансе Transact-SQL (T-SQL). Дополнительные сведения о конфигурации конечных точек SQL Server см. в разделе [Практическое руководство: Настройка ядра СУБД для прослушивания нескольких TCP-портов](https://go.microsoft.com/fwlink/?LinkID=189231) (https://go.microsoft.com/fwlink/?LinkID=189231).  
  
-   **Старайтесь не использовать проверку подлинности на основе SQL.**  
  
    Чтобы избежать необходимости передавать пароли в виде обычного текста по сети или сохранять пароли в параметрах конфигурации, используйте проверку подлинности Windows только с установкой SQL Server. Проверка подлинности SQL Server является устаревшим режимом аутентификации. Хранение учетных данных входа язык структурированных запросов (SQL) (пользователь имена и пароли SQL) при использовании проверки подлинности SQL Server не рекомендуется. Дополнительные сведения см. в разделе [режимы проверки подлинности](https://go.microsoft.com/fwlink/?LinkID=189232) (https://go.microsoft.com/fwlink/?LinkID=189232).  
  
-   **Внимательно проанализируйте необходимость обеспечения дополнительной безопасности каналов в установке SQL.**  
  
    Даже если реализована аутентификация Kerberos, SQL Server поддержки интерфейс поставщика безопасности (SSPI) не обеспечивает безопасность на уровне каналов. Однако для установок, в которых серверы безопасно размещены в защищенной брандмауэром сети, шифрование обмена данными SQL не является обязательным.  
  
    Несмотря на то, что шифрование является ценным инструментом обеспечения безопасности, его следует учитывать не для всех данных и подключений. При выборе нужно ли реализовывать шифрование, рассмотрим, как пользователи получают доступ к данным. Если пользователям доступ к данным через общедоступную сеть, шифрование данных может потребоваться для повышения безопасности. Тем не менее если все подключения к данным SQL с помощью AD FS включает безопасной конфигурации интрасети, шифрование не требуется. При использовании шифрования необходимо также реализовывать стратегию обслуживания паролей, ключей и сертификатов.  
  
    Если существует вероятность могут наблюдаться данных SQL или незаконно по сети, используйте безопасность протокола IP (IPsec) или Secure Sockets Layer (SSL) для защиты подключений SQL. Однако это может быть негативно повлиять на производительность сервера SQL Server, что может повлиять на или ограничить производительности Служб федерации Active Directory, в некоторых ситуациях. Например производительность AD FS изданию токенов может снижаться, если поиск атрибутов в хранилище атрибутов SQL является важной частью процесса издания токена. Вы может устранить угрозу злоумышленных действий создав мощный периметр безопасности SQL. Например оптимальным решением для обеспечения безопасности установки SQL Server — убедитесь, что он остается недоступным для пользователей и компьютеров и что он остается доступен только для пользователей или компьютеров в вашей среде центра обработки данных.  
  
    Дополнительные сведения см. в разделе [шифрование подключений к SQL Server](https://go.microsoft.com/fwlink/?LinkID=189234) или [шифрование SQL Server](https://go.microsoft.com/fwlink/?LinkID=189233).  
  
-   **Настройте безопасный доступ, воспользовавшись хранимыми процедурами для выполнения всех SQL операций поиска с AD FS SQL хранящихся данных.**  
  
    Для повышения качества обслуживания и изоляции данных, можно создать хранимые процедуры для всех команд поиска хранилищ атрибутов. Можно создать роль базы данных, в которой будут предоставлены разрешения на выполнение хранимых процедур. Назначьте этой роли баз данных удостоверение службы AD FS Windows. Служба AD FS Windows не сможет выполнить любые другие инструкции SQL, кроме соответствующих хранимых процедур, которые используются для поиска атрибутов. Блокирование доступа к базе данных SQL Server, таким образом снижает риск атаки повышение прав доступа.  
  
## <a name="see-also"></a>См. также:
[Руководство по разработке служб AD FS в Windows Server 2012](AD-FS-Design-Guide-in-Windows-Server-2012.md)
