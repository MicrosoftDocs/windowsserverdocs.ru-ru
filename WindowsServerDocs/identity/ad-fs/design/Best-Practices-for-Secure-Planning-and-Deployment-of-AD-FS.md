---
ms.assetid: 963a3d37-d5f1-4153-b8d5-2537038863cb
title: Рекомендации по безопасному планированию и развертыванию AD FS
description: ''
author: billmath
ms.author: billmath
manager: femila
ms.date: 05/31/2017
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: identity-adfs
ms.openlocfilehash: 95f9fd468df39525a2fe7d18647f399214486bbb
ms.sourcegitcommit: afb0602767de64a76aaf9ce6a60d2f0e78efb78b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/20/2019
ms.locfileid: "67280600"
---
# <a name="best-practices-for-secure-planning-and-deployment-of-ad-fs"></a>Рекомендации по безопасному планированию и развертыванию AD FS


В этом разделе представлены сведения рекомендации помогут вам в планировании и оценке безопасности при разработке развертывания служб федерации Active Directory (AD FS). В этом разделе является отправной точкой для анализа и оценки аспектов, влияющих на общую безопасность использования AD FS. Сведения в этом разделе дополняют и расширяют существующие рекомендации по планированию безопасности и другие передовые практики в области разработки.  
  
## <a name="core-security-best-practices-for-ad-fs"></a>Ключевые рекомендации по безопасности AD FS  
Следующие базовые рекомендации являются общими для всех вариантов установки AD FS и где вы хотите расширить или усовершенствовать безопасность системы или развертывания:  

-   **Защита AD FS в качестве системы «Уровня 0»** 

    AD FS является, по существу, система проверки подлинности.  Таким образом он должен рассматриваться как системы «Уровня 0» как и другие системные идентификации в сети.  [Документация Microsoft](https://docs.microsoft.com/windows-server/identity/securing-privileged-access/securing-privileged-access-reference-material) Подробнее о модель разделения администрирования Active Directory. 


-   **Используйте мастер настройки безопасности для применения к серверам федерации и компьютерами прокси-серверов федерации AD FS-рекомендации по безопасности**  
  
    Мастер настройки безопасности (SCW) — это средство, который предустанавливается на Windows Server 2008, Windows Server 2008 R2 и Windows Server 2012 компьютеров. Его можно использовать для применения рекомендаций безопасности с целью уменьшения поверхности атаки на сервер на основе устанавливаемых серверных ролей.  
  
    При установке AD FS программа установки создает файлы расширения роли, которые можно использовать вместе с мастером для создания политики безопасности, которая будет применяться к конкретной серверной роли AD FS (серверу федерации или прокси-серверу федерации), выбранной во время установки.  
  
    Каждый устанавливаемый файл расширения роли представляет тип роли и подроли, для которой настроен каждый компьютер. Следующие файлы расширения роли установлены в каталоге C:WindowsADFSScw:  
  
    -   Farm.xml  
  
    -   SQLFarm.xml  
  
    -   StandAlone.xml  
  
    -   Proxy.xml (Этот файл присутствует, только если компьютер настроен для работы в роли прокси-сервера федерации).  
  
    Для применения расширений роли AD FS в мастере конфигурации безопасности выполните следующие действия в указанной последовательности.  
  
    1.  Установите AD FS и выберите соответствующую серверную роль для компьютера. Дополнительные сведения см. в разделе [Установка роли прокси-сервера для службы федерации](../../ad-fs/deployment/Install-the-Federation-Service-Proxy-Role-Service.md) в руководстве по развертыванию AD FS.  
  
    2.  Зарегистрируйте соответствующий файл расширения роли, используя средство командной строки Scwcmd. См. подробные сведения об использовании этого инструмента в роли, для которой настроен ваш компьютер, в следующей таблице.  
  
    3.  Убедитесь, что команда выполнена успешно, изучив файл SCWRegister_log.xml, который находится в каталоге WindowssecurityMsscwLogs.  
  
    Эти действия необходимо выполнить на каждом компьютере сервера федерации или прокси-сервера федерации, к которому требуется применить политики безопасности мастера конфигурации безопасности AD FS.  
  
    В следующей таблице объясняется, как зарегистрировать соответствующее расширение роли мастера конфигурации безопасности в зависимости от серверной роли AD FS, выбранной на компьютере, где установлена служба AD FS.  
  
    |Серверная роль AD FS|Используемая база данных конфигурации AD FS|Введите в командной строке следующую команду:|  
    |---------------------|-------------------------------------|---------------------------------------------------|  
    |Изолированный сервер федерации|Внутренняя база данных Windows|`scwcmd register /kbname:ADFS2Standalone /kbfile:"WindowsADFSscwStandAlone.xml"`|  
    |Объединенный в ферму сервер федерации|Внутренняя база данных Windows|`scwcmd register /kbname:ADFS2Standalone /kbfile:"WindowsADFSscwFarm.xml"`|  
    |Объединенный в ферму сервер федерации|SQL Server|`scwcmd register /kbname:ADFS2Standalone /kbfile:"WindowsADFSscwSQLFarm.xml"`|  
    |Прокси-сервер федерации|Н/Д|`scwcmd register /kbname:ADFS2Standalone /kbfile:"WindowsADFSscwProxy.xml"`|  
  
    Дополнительные сведения о базах данных, которые можно использовать с AD FS, см. в разделе [Роль базы данных конфигурации AD FS](../../ad-fs/technical-reference/The-Role-of-the-AD-FS-Configuration-Database.md).  
  
-   **Используйте обнаружение воспроизведения токена в ситуациях, где безопасность имеет первостепенное значение, например, при использовании киоски.**  
    Обнаружение воспроизведения токенов входит в состав AD FS, которая гарантирует, что любая попытка воспроизведения запрос маркера, который выполняется в службу федерации обнаруживается, и их отмену. Обнаружение воспроизведения токенов включено по умолчанию. Эта функция работает как для пассивного профиля WS-Federation, так и для профиля WebSSO (SAML). Один токен никогда не используется несколько раз.  
  
    При запуске службы федерации начинает создаваться кэш выполняемых запросов токена. Со временем, по мере добавления в кэш последующих запросов токена, способность службы федерации обнаруживать запросы на многократное воспроизведение токена совершенствуется. Если обнаружение воспроизведения токенов отключено, а затем принимается решение о необходимости снова включить эту функцию, помните, что служба федерации будет по-прежнему принимать токены в течение ранее заданного периода времени до тех пор, пока кэш воспроизведения не перестроит свое содержимое, на что требуется определенное время. Дополнительные сведения см. в разделе [Роль базы данных конфигурации AD FS](../../ad-fs/technical-reference/The-Role-of-the-AD-FS-Configuration-Database.md).  
  
-   **Используйте шифрование токенов, особенно в том случае, если вы используете вспомогательным разрешением артефактов SAML.**  
  
    Шифрование маркеров настоятельно рекомендуется для повышения безопасности и защиты от потенциальных атак man-in--middle (MITM), которые может быть попытка развертывания AD FS. Использование шифрования токенов может незначительно повлиять на пропускную способность, однако в большинстве случаев пользователи не заметят задержки. Во многих развертываниях преимущества такого подхода с точки зрения безопасности намного превышают неудобства от снижения производительности сервера.  
  
    Для включения шифрования токенов сначала настройте или добавьте сертификат шифрования для отношений доверия с проверяющей стороной. Настроить сертификат шифрования можно при создании отношений доверия с проверяющей стороной или позже. Чтобы добавить сертификат шифрования для существующих доверия с проверяющей стороной, можно задать сертификат для использования на **шифрования** вкладку в свойства отношений доверия при использовании оснастки AD FS. Чтобы указать сертификат для существующего отношения доверия, используя командлеты AD FS, используйте параметр EncryptionCertificate либо **Set-ClaimsProviderTrust** или **Set-RelyingPartyTrust** командлетов. Чтобы установить сертификат для службы федерации для использования при расшифровке токенов, используйте **Set-ADFSCertificate** командлет и укажите "`Token-Encryption`" для *CertificateType* параметра. Включение и отключение шифрования для конкретных отношений доверия с проверяющей стороной осуществляется с помощью параметра *EncryptClaims* командлета **Set-RelyingPartyTrust**.  
  
-   **Использование расширенной защиты для проверки подлинности**  
  
    Чтобы обеспечить безопасность развертывания, можно задать и использовать расширенную защиту для проверки подлинности с помощью AD FS. Этот параметр указывает уровень расширенной защиты для проверки подлинности, поддерживаемые сервером федерации.  
  
    Расширенная защита аутентификации обеспечивает защиту от атак типа "злоумышленник в середине", когда злоумышленник перехватывает клиентские учетные данные и пересылает их на сервер. Защита от таких атак становится возможной благодаря токену привязки канала (CBT), который может требоваться или не требоваться сервером либо разрешаться им при установке связи с клиентами.  
  
    Для включения функции расширенной защиты воспользуйтесь параметром **ExtendedProtectionTokenCheck** командлета **Set-ADFSProperties**. В следующей таблице приводятся возможные значения этого параметра и уровень безопасности, обеспечиваемый этими значениями.  
  
    |Значение параметра|Уровень "Безопасность"|Параметр защиты|  
    |-------------------|------------------|----------------------|  
    |Требуется|Сервер полностью защищен.|Расширенная защита активирована и требуется всегда.|  
    |Разрешить|Сервер частично защищен.|Расширенная защита активирована, если в соответствующих системах установлены исправления для поддержки этой функции|  
    |Нет|Сервер не защищен.|Расширенная защита не активирована.|  
  
-   **Если вы используете, ведение журналов и трассировка, гарантировать конфиденциальность конфиденциальную информацию.**  
  
    AD FS, по умолчанию предоставляет и не отслеживает персональные данные (PII) непосредственно как часть службы федерации или нормальной работы. Если ведение журнала событий и трассировки отладки включены в AD FS, тем не менее, в зависимости от политики утверждений, настроить некоторые утверждения типов и их связанные значения могут содержать личные сведения могут регистрироваться в AD FS события или журналы трассировки.  
  
    Таким образом надлежащее управление доступом к конфигурации AD FS и файлы журналов настоятельно рекомендуется. Если эти сведения не должны быть видимы, необходимо отключить ведение журнала или отфильтровывать личные или конфиденциальные данные в журналах до того, как они будут предоставлены в общий доступ другим пользователям.  
  
    Следующие советы помогут избежать случайного предоставления содержимого файла журнала.  
  
    -   Убедитесь, что журнал событий AD FS и файлы журнала трассировки защищены списками управления доступом (ACL), которые предоставляют доступ только для доверенных администраторов, которым требуется доступ к ним.  
  
    -   Не копируйте и не архивируйте файлы журнала, используя файловые расширения или пути, доступные при обработке веб-запросов. Так, использование расширения имени XML-файла не является безопасным подходом. См. список небезопасных расширений в руководстве по администрированию служб IIS.  
  
    -   При пересмотре пути к файлу журнала не забудьте указать абсолютный путь к местоположению файла журнала, которое должно находиться за пределами общедоступного виртуального корневого каталога веб-узла. В противном случае он будет доступен третьим лицам через веб-браузер.  

-   **AD FS обратимо экстрасети и экстрасети AD FS смарт-блокировка защиты**  
    
    В случае атаки в виде запросов проверки подлинности с помощью invalid(bad) паролей, которые были переданы через прокси веб-приложения блокировка экстрасети AD FS позволяет защитить пользователей от блокировки учетной записи службы федерации Active Directory. В дополнение к защите пользователей от AD FS блокировку учетной записи, блокировка экстрасети AD FS также обеспечивает защиту от атак подбора пароля.  
    
    Блокировка экстрасети обратимо для AD FS на Windows Server 2012 R2 см. в разделе [AD FS обратимо защиты блокировки экстрасетей](../../ad-fs/operations/Configure-AD-FS-Extranet-Soft-Lockout-Protection.md).  

     Смарт-экстрасети для служб AD FS в Windows Server 2016 см. в разделе [AD FS смарт-защиты блокировки экстрасетей](../../ad-fs/operations/Configure-AD-FS-Extranet-Smart-Lockout-Protection.md).  
  
## <a name="sql-serverspecific-security-best-practices-for-ad-fs"></a>Рекомендации безопасности SQL Server для AD FS  
Следующие рекомендации по безопасности относятся только к Microsoft SQL Server® или внутреннюю базу данных Windows (WID), если эти технологии базы данных используются для управления данными в AD FS проектирования и развертывания.  
  
> [!NOTE]  
> Эти рекомендации дополняют, но не заменяют инструкции по обеспечению безопасности SQL Server. Дополнительные сведения о планировании безопасной установки SQL Server, см. в разделе [вопросы безопасности для безопасной установки SQL](https://go.microsoft.com/fwlink/?LinkID=139831) (https://go.microsoft.com/fwlink/?LinkID=139831).  
  
-   **Всегда развертывайте SQL Server за брандмауэром в физически безопасной сетевой среде.**  
  
    Ни в коем случае не делайте установку SQL Server доступной непосредственно в Интернете. Только компьютеры, которые находятся внутри центра обработки данных должен иметь доступ к вашей установки SQL server, который поддерживает AD FS. Дополнительные сведения см. в разделе [безопасности контрольный список](https://go.microsoft.com/fwlink/?LinkID=189229) (https://go.microsoft.com/fwlink/?LinkID=189229).  
  
-   **Запустите SQL Server под учетной записью службы, вместо того чтобы использовать учетные записи служб по умолчанию встроенные системы.**  
  
    По умолчанию SQL Server часто устанавливается и настраивается для использования одной из поддерживаемых встроенных системных учетных записей, таких как LocalSystem или NetworkService. Для повышения безопасности установки SQL Server для AD FS, везде, где можно использовать отдельный учетная запись службы для доступа к службе SQL Server и активируйте аутентификацию Kerberos, регистрируя имя участника безопасности (SPN) этой учетной записи в вашей Развертывание Active Directory. Это обеспечивает взаимную аутентификацию клиента и сервера. Без регистрации имени участника безопасности для отдельной учетной записи службы SQL Server будет использовать аутентификацию NTLM для Windows, подразумевающую аутентификацию только клиента.  
  
-   **Минимизируйте контактную зону SQL Server.**  
  
    Активируйте только те конечные точки SQL Server, которые совершенно необходимы для работы. По умолчанию SQL Server предоставляет одну встроенную конечную точку TCP, удалить которую невозможно. Для AD FS следует включить эту конечную точку TCP для проверки подлинности Kerberos. Воспользуйтесь инструкцией запроса SELECT * FROM sys.tcp_endpoints в сеансе Transact-SQL (T-SQL), чтобы проанализировать существующие конечные точки TCP и узнать, добавлены ли дополнительные пользовательские TCP-порты в установку SQL. Дополнительные сведения о конфигурации конечных точек SQL Server, см. в разделе [How To: Настройка ядра СУБД на прослушивание нескольких портов TCP](https://go.microsoft.com/fwlink/?LinkID=189231) (https://go.microsoft.com/fwlink/?LinkID=189231).  
  
-   **Старайтесь не использовать проверку подлинности на основе SQL.**  
  
    Используйте в установке SQL Server только аутентификацию Windows, чтобы избежать необходимости передавать пароли в виде обычного текста по сети или сохранять их в параметрах конфигурации. Аутентификация SQL Server является устаревшим режимом аутентификации. Не рекомендуется сохранять учетные данные SQL для входа в систему (имена пользователей и пароли SQL) при использовании аутентификации SQL Server. Дополнительные сведения см. в разделе [режимов проверки подлинности](https://go.microsoft.com/fwlink/?LinkID=189232) (https://go.microsoft.com/fwlink/?LinkID=189232).  
  
-   **Внимательно проанализируйте необходимость обеспечения дополнительной безопасности каналов в установке SQL.**  
  
    Даже если реализована аутентификация Kerberos, интерфейс поставщика поддержки безопасности (SSPI) SQL не обеспечивает безопасность на уровне каналов. Однако для установок, в которых серверы безопасно размещены в защищенной брандмауэром сети, шифрование обмена данными SQL не является обязательным.  
  
    Несмотря на то что шифрование является ценным инструментом обеспечения безопасности, это не универсальное решение для всех данных и подключений. При принятии решения о том, нужно ли реализовывать шифрование, оцените, как пользователи будут осуществлять доступ к данным. Если пользователи осуществляют доступ к данным по публичной сети, для повышения уровня безопасности может потребоваться шифрование данных. Тем не менее если весь доступ данным SQL с помощью AD FS осуществляется по безопасной конфигурации интрасети, шифрование может оказаться обязательным. При использовании шифрования необходимо также реализовывать стратегию обслуживания паролей, ключей и сертификатов.  
  
    Если существует вероятность просмотра данных SQL или совершения с ними злоумышленных действий по сети, используйте протоколы безопасности IPsec или SSL для защиты подключений SQL. Тем не менее это может иметь отрицательное воздействие на производительность SQL Server, что может повлиять на или ограничить производительности AD FS в некоторых ситуациях. Например AD FS производительность при выдаче токенов может снижаться, если поиск атрибутов из хранилища атрибутов SQL критически важны для выдачи маркера. Устранить угрозу злоумышленных действий с SQL можно, создав мощный периметр безопасности. Так, оптимальным решением для обеспечения безопасности установки SQL Server является гарантия недоступности установки интернет-пользователям и компьютерам. Установка должна быть доступна только пользователям и компьютерам в среде ЦОД соответствующей организации.  
  
    Дополнительные сведения см. в разделе [шифрование соединений с SQL Server](https://go.microsoft.com/fwlink/?LinkID=189234) или [шифрование SQL Server](https://go.microsoft.com/fwlink/?LinkID=189233).  
  
-   **Настройте безопасный доступ с помощью хранимых процедур для выполнения всех операций поиска с AD FS SQL хранимых данных.**  
  
    Для повышения качества обслуживания и изоляции данных можно создать хранимые процедуры для всех команд поиска хранилищ атрибутов. Можно создать роль базы данных, которой будут предоставлены разрешения на выполнение хранимых процедур. Назначьте удостоверение службы службы Windows AD FS для этой роли базы данных. Службы AD FS Windows не может быть возможность запускать любые другие инструкции SQL, кроме соответствующих хранимых процедур, которые используются для поиска атрибутов. Блокирование доступа к базе данных SQL Server указанным способом снижает риск атаки в результате повышения уровня доступа.  
  
## <a name="see-also"></a>См. также
[Руководство по разработке служб федерации Active Directory в Windows Server 2012](AD-FS-Design-Guide-in-Windows-Server-2012.md)
