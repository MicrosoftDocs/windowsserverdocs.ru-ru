---
ms.assetid: e983d2ab-4153-41e7-b243-12cf7d71a552
title: "Ферма серверов федерации с использованием SQL Server"
description: 
author: billmath
ms.author: billmath
manager: femila
ms.date: 05/31/2017
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: identity-adfs
ms.openlocfilehash: 2333f79c733415833b1d54afc8c385700ac5581e
ms.sourcegitcommit: db290fa07e9d50686667bfba3969e20377548504
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/12/2017
---
# <a name="federation-server-farm-using-sql-server"></a>Ферма серверов федерации с использованием SQL Server

>Область применения: Windows Server 2016, Windows Server 2012 R2

Данная топология для служб федерации Active Directory \(AD FS\) отличается от фермы серверов федерации с использованием топологии развертывания \(WID\) внутренней базы данных Windows, в том, что она не реплицирует данные для каждого сервера федерации в ферме. Вместо этого все серверы федерации в ферме можно чтения и записи данных в общей базы данных, который хранится на сервере под управлением Microsoft SQL Server, который находится в корпоративной сети.  
  
> [!IMPORTANT]  
> Если вы хотите создать ферму AD FS и использовать SQL Server для хранения данных конфигурации, можно использовать SQL Server 2008 и более поздние версии, включая SQL Server 2012 и SQL Server 2014.  
  
## <a name="deployment-considerations"></a>Рекомендации по развертыванию  
В этом разделе приведены основные аспекты, которые об целевая аудитория, преимущества и ограничения, связанные с этой топологии развертывания.  
  
### <a name="who-should-use-this-topology"></a>Кому следует использовать эту топологию?  
  
-   Больших организациях с более 100 отношений доверия, которые необходимо предоставить доступ в рамках единого входа на \(SSO\) федеративных приложений или служб и их внутренних пользователей, так и для внешних пользователей  
  
-   Организациям, уже используется SQL Server и хотите воспользоваться преимуществами их существующих средств и опыта  
  
### <a name="what-are-the-benefits-of-using-this-topology"></a>В чем заключаются преимущества использования этой топологии?  
  
-   Поддержка отношения доверия с большим количеством \(more than 100\)  
  
-   Поддержка обнаружение воспроизведения токенов \(a security feature\) и разрешение артефактов \ (часть \(SAML\) Security Assertion Markup Language 2.0 protocol\)  
  
-   Поддержка всеми преимуществами SQL Server, например зеркального отображения, средства отказоустойчивой кластеризации, отчетов и управления  
  
### <a name="what-are-the-limitations-of-using-this-topology"></a>Что такое ограничений использования этой топологии  
  
-   В этой топологии не обеспечивают избыточность базы данных по умолчанию. Несмотря на то, что ферме серверов федерации с топологией WID автоматически реплицирует базы данных WID, на каждый сервер федерации в ферме, ферма серверов федерации с топологией SQL Server содержит только одну копию базы данных  
  
> [!NOTE]  
> SQL Server поддерживает многие другие данные и параметры избыточности приложения, в том числе отказоустойчивой кластеризации, зеркального отображения базы данных и различных типов репликации SQL Server.  
  
Отдела информационных технологий \(IT\) использует зеркального отображения базы данных SQL Server в режиме \(synchronous\) сценарии высокой безопасности и отказоустойчивой кластеризации для обеспечения поддержки сценарии высокой доступности для экземпляра SQL Server. \(Peer\-to\-peer\) транзакций SQL Server и репликации слиянием не проводила тестирование группы разработчиков AD FS в корпорации Майкрософт. Дополнительные сведения о SQL Server см. в разделе [Обзор решений высокой доступности](https://go.microsoft.com/fwlink/?LinkId=179853) или [выбора соответствующих типов репликации](https://go.microsoft.com/fwlink/?LinkId=214648).  
  
### <a name="supported-sql-server-versions"></a>Поддерживаемые версии SQL Server  
Следующие версии SQL server поддерживаются с помощью AD FS в Windows Server 2012 R2:  
  
-   SQL Server 2008 \ / R2  
  
-   SQL Server 2012  
  
-   SQL Server 2014 г.  
  
## <a name="server-placement-and-network-layout-recommendations"></a>Рекомендации для макета сервера размещения и сети  
Как ферма серверов федерации с топологией WID, все серверы федерации в ферме настроены для использования одного имени кластера \(DNS\) доменных имен \ (представляет имя службы федерации) и IP-адрес одного кластера в составе конфигурации кластера балансировки сетевой нагрузки \(NLB\). Это помогает узле балансировки сетевой Нагрузки распределения клиентских запросов между отдельными серверами федерации. Прокси-серверы федерации можно использовать для клиентских запросов прокси-сервера федерации в ферму серверов федерации.  
  
На следующем рисунке показано, как вымышленная компания Contoso Pharmaceuticals развернуть его фермы серверов федерации с топологией SQL Server в корпоративной сети. В нем также показано, как эту компанию настроены сети периметра с доступом к DNS-сервера, дополнительные узла балансировки сетевой Нагрузки, использующий же \(fs.contoso.com\) кластера DNS имя, используемое на кластера балансировки сетевой Нагрузки корпоративной сети, и двух веб-прокси приложения \(wap1 and wap2\).  
  
![Ферма серверов с использованием SQL](media/SQLFarmADFSBlue.gif)  
  
Дополнительные сведения о том, как настроить сетевую среду для использования с серверами федерации или прокси приложения см. в разделе «Требования к разрешению имен» статьи [требования AD FS](AD-FS-Requirements.md) и [планирование инфраструктуры прокси-сервера приложений Web (WAP)](https://technet.microsoft.com/library/dn383648.aspx).  
  
## <a name="high-availability-options-for-sql-server-farms"></a>Параметры высокой доступности для ферм SQL Server  
В Windows Server 2012 R2 службы федерации Active Directory существует, новые параметры для поддержки высокой доступности в фермы AD FS с помощью SQL Server.  
  
-   Поддержка групп доступности SQL Server AlwaysOn  
  
-   Поддержка географически высокой доступности с помощью репликации слиянием SQL Server  
  
В этом разделе описывается каждый из этих параметров, какие проблемы с их помощью решаются соответственно, а также некоторые основные вопросы для решить, какие варианты развертывания.  
  
> [!NOTE]  
> Фермы AD FS, использующих \(WID\) внутренней базы данных Windows обеспечивают избыточность основных данных с доступом для чтения и записи на узле сервера федерации основной и доступ только для чтения на дополнительных узлов.  Это может использоваться в географически локальной или в географически распределенном топологии.  
>   
> При использовании внутренней базы данных Windows, необходимо учитывать следующие ограничения.  
>   
> -   На ферме внутренней базы данных Windows с ограничением 30 серверов федерации, при наличии 100 доверия с проверяющей стороной.  
> -   На ферме внутренней базы данных Windows не поддерживает разрешение обнаружения или артефактов воспроизведения токена \ (входит \(SAML\) protocol\ Security Assertion Markup Language).  
  
Следующая таблица содержит сводные с использованием фермы внутренней базы данных Windows.  
  
||||  
|-|-|-|  
||1 \-100 отношений доверия RP|Больше 100 отношений доверия RP|  
|1 \-30 AD FS узлов|Поддерживается внутренней базы данных Windows|Не поддерживается с использованием WID \-необходимые SQL|  
|Узлы более чем 30 AD FS|Не поддерживается с использованием WID \-необходимые SQL|Не поддерживается с использованием WID \-необходимые SQL|  
  
### <a name="alwayson-availability-groups"></a>Группы доступности AlwaysOn  
**Обзор**  
  
Группы доступности AlwaysOn были представлены в SQL Server 2012 и предоставляет новый способ для создания экземпляра SQL Server высокой доступности.  Группы доступности AlwaysOn объединить элементы кластеризацию и зеркальное отображение базы данных для обеспечения избыточности и отказоустойчивости на уровне экземпляра SQL и на уровне базы данных.  В отличие от предыдущего параметра высокой доступности, группы доступности AlwaysOn не требуют общего хранилища данных \ (или сетевой область хранения) на уровне базы данных.  
  
Группы обеспечения доступности состоит из основного реплики \ (набор основных databases\ для чтения и записи) и от одного до четырех доступности реплик \ (наборов соответствующих вторичных databases\).  Группа доступности поддерживает один для чтения и записи копия \ (основной replica\) и от одного до четырех доступности только для чтения реплики.  Каждой реплики доступности должны располагаться в другом узле одного кластера \(WSFC\) отказоустойчивой кластеризации Windows Server.  Дополнительные сведения о группах доступности AlwaysOn см. [\(SQL Server\) Обзор групп доступности AlwaysOn](https://technet.microsoft.com/library/ff877884.aspx).  
  
С точки зрения из узлов фермы AD FS SQL Server, группы доступности AlwaysOn заменяет один экземпляр SQL Server в качестве политики \ или базы данных артефактов.  Прослушивателя группы доступности — какие клиентом \ (AD FS безопасности маркера служба\текущих) использует для подключения к SQL Server.  
  
На следующей схеме показаны фермы серверов AD FS SQL с группой обеспечения доступности AlwaysOn.  
  
![Ферма серверов с использованием SQL](media/alwaysonavailabilitygroups.jpg)  
  
> [!NOTE]  
> Группы доступности AlwaysOn требуется, что экземпляры SQL Server находятся на узлах \(WSFC\) отказоустойчивой кластеризации Windows Server.  
  
> [!NOTE]  
> Только один доступности реплики может действовать как целевого объекта автоматической отработки отказа, остальные три будет зависеть от вручную отработки отказа.  
  
**Рекомендации по развертыванию ключа**  
  
Если вы планируете использовать группы доступности AlwaysOn в сочетании с репликации слиянием SQL Server, следует принять во внимание проблемы, описанные в разделе «Развертывание ключ рекомендации по использованию AD FS с помощью репликации слиянием SQL Server» ниже.  В частности при сбое группы доступности AlwaysOn, который содержит базу данных, которая является подписчиком репликации подписка репликации завершается ошибкой. Чтобы возобновить репликацию, администратор репликации необходимо вручную перенастроить подписчика.  См. в описании конкретной проблемы в SQL Server [подписчиков репликации и группы доступности AlwaysOn \(SQL Server\)](https://technet.microsoft.com/library/hh882436.aspx) и в целом поддерживают инструкции для групп обеспечения доступности AlwaysOn с параметры репликации в [репликации, отслеживания изменений, сбора изменений данных и группы доступности AlwaysOn \(SQL Server\)](https://technet.microsoft.com/library/hh403414.aspx).  
  
**Настройка AD FS для использования группы обеспечения доступности AlwaysOn**  
  
Настройка ферму AD FS с помощью группы доступности AlwaysOn требует небольшие изменения процедуры развертывания Служб федерации Active Directory:  
  
1.  Необходимо создать баз данных, которые вы хотите создать резервную копию, прежде чем настраивать группы обеспечения доступности AlwaysOn.  AD FS создает баз данных как часть установки и начальной настройки первого узла службы федерации для фермы AD FS SQL Server.  Как часть конфигурации AD FS, необходимо указать строку подключения SQL, вам потребуется настроить первый узел фермы AD FS для прямого подключения к экземпляру SQL \ (это только temporary\).   Конкретные инструкции по настройке фермы AD FS, включая настройку узле фермы AD FS с помощью строки подключения SQL server, в разделе [Настройка сервера федерации](../../ad-fs/deployment/Configure-a-Federation-Server.md).  
  
2.  После создания базы данных AD FS их необходимо назначить группы доступности AlwaysOn и создания общих TCPIP прослушивателя, с помощью средства SQL Server и обработки в [Создание и Настройка групп доступности \(SQL Server\)](https://technet.microsoft.com/library/ff878265.aspx).  
  
3.  Наконец используйте PowerShell для изменения свойств службы федерации Active Directory для обновления строка подключения SQL для использования адрес DNS-прослушивателя группы доступности AlwaysOn.  
  
    Пример команд PSH обновления строки подключения SQL для базы данных AD FS политики:  
  
    ```  
    PS:\>$temp= Get-WmiObject -namespace root/ADFS -class SecurityTokenService  
    PS:\>$temp.ConfigurationdatabaseConnectionstring=”data source=<SQLCluster\SQLInstance>; initial catalog=adfsconfiguration;integrated security=true”  
    PS:\>$temp.put()  
  
    ```  
  
4.  Пример команд PSH обновления строки подключения SQL для базы данных AD FS политики:  
  
    ```  
    PS:\> Set-AdfsProperties –artifactdbconnection ”Data source=<SQLCluster\SQLInstance >;Initial Catalog=AdfsArtifactStore;Integrated Security=True”  
    ```  
  
### <a name="sql-server-merge-replication"></a>Репликации слиянием SQL Server  
Также появился в SQL Server 2012, репликации слиянием обеспечивает избыточность данных политики службы федерации Active Directory со следующими характеристиками:  
  
-   Чтение и запись возможности на всех узлах \ (не только primary\)  
  
-   Небольших объемов данных, реплицируются асинхронно, чтобы избежать задержки в систему  
  
На следующей схеме показаны географически избыточных фермы AD FS SQL Server с помощью репликации слиянием \ (издателя 1, 2 subscribers\):  
  
![Ферма серверов с использованием SQL](media/ADFSSQLGeoRedundancy3.png)  
  
**Особенности развертывания ключа с помощью Служб федерации Active Directory с помощью репликации слиянием SQL Server \ (Обратите внимание номера в схеме above\)**  
  
-   База данных распространителя не поддерживается для использования с группы доступности AlwaysOn или зеркального отображения базы данных.  В разделе положения о поддержке для групп обеспечения доступности AlwaysOn с параметры репликации в SQL Server [репликации, отслеживания изменений, сбора изменений данных и группы доступности AlwaysOn \(SQL Server\)](https://technet.microsoft.com/library/hh403414.aspx).  
  
-   При сбое группы доступности AlwaysOn, который содержит базу данных, которая является подписчиком репликации подписка репликации завершается ошибкой. Чтобы возобновить репликацию, администратор репликации необходимо вручную перенастроить подписчика.  См. в описании конкретной проблемы в SQL Server [подписчиков репликации и группы доступности AlwaysOn \(SQL Server\)](https://technet.microsoft.com/library/hh882436.aspx) и в целом поддерживают инструкции для групп обеспечения доступности AlwaysOn с параметры репликации [репликации, отслеживания изменений, сбора изменений данных и группы доступности AlwaysOn \(SQL Server\)](https://technet.microsoft.com/library/hh403414.aspx).  
  
Более подробные инструкции о том, как настроить AD FS для использования репликации слиянием SQL Server см. в разделе [Настройка географической избыточности с помощью репликации SQL Server](https://technet.microsoft.com/en-us/library/dn632406.aspx).  
  
## <a name="see-also"></a>См. также:  
[Планирование топологии развертывания AD FS](Plan-Your-AD-FS-Deployment-Topology.md)  
[Руководство по разработке служб AD FS в Windows Server 2012 R2](AD-FS-Design-Guide-in-Windows-Server-2012-R2.md)  
  

