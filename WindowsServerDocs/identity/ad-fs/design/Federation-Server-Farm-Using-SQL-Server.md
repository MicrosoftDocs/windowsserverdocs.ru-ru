---
ms.assetid: e983d2ab-4153-41e7-b243-12cf7d71a552
title: Ферма серверов федерации с использованием SQL Server
description: ''
author: billmath
ms.author: billmath
manager: femila
ms.date: 05/31/2017
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: identity-adfs
ms.openlocfilehash: 585d0195b096056ba769f4e9a08d5c4d2156b96a
ms.sourcegitcommit: 0b5fd4dc4148b92480db04e4dc22e139dcff8582
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/24/2019
ms.locfileid: "66191448"
---
# <a name="federation-server-farm-using-sql-server"></a>Ферма серверов федерации с использованием SQL Server

Эта топология для служб федерации Active Directory \(AD FS\) отличается от фермы серверов федерации с использованием внутренней базы данных Windows \(WID\) топологии развертывания, в который он не реплицирует данные для Каждый сервер федерации в ферме. Вместо этого все серверы федерации в ферме можно чтения и записи данных в единую базу данных, которая хранится на сервере под управлением Microsoft SQL Server, который находится в корпоративной сети.  
  
> [!IMPORTANT]  
> Если вы хотите создать ферму AD FS и использовать SQL Server для хранения данных конфигурации, можно использовать SQL Server 2008 и более поздние версии, включая SQL Server 2012 и SQL Server 2014.  
  
## <a name="deployment-considerations"></a>Вопросы развертывания  
В этом разделе описываются различные вопросы о целевая аудитория, преимущества и ограничения, связанные с этой топологии развертывания.  
  
### <a name="who-should-use-this-topology"></a>Для кого предназначена эта топология?  
  
-   Крупные организации с более чем 100 отношений доверия, необходимо предоставить как внутренних пользователей, так и внешним пользователям единый вход\-на \(SSO\) доступ к федеративному приложению или служб  
  
-   Организациям, уже SQL Server и хотите воспользоваться преимуществами их существующие средства и знания  
  
### <a name="what-are-the-benefits-of-using-this-topology"></a>Каковы преимущества использования этой топологии?  
  
-   Поддержка большого количества отношений доверия \(более чем 100\)  
  
-   Поддержка для обнаружения воспроизведения маркеров \(средство безопасности\) и разрешение артефактов \(частью Security Assertion Markup Language \(SAML\) 2.0 протокола\)  
  
-   Средства поддержки для все преимущества SQL Server, такие как зеркальное отображение базы данных, отказоустойчивая кластеризация, отчетов и управления  
  
### <a name="what-are-the-limitations-of-using-this-topology"></a>Что такое ограничение на использование этой топологии  
  
-   Эта топология не обеспечения избыточности базы данных по умолчанию. Несмотря на то, что ферма серверов федерации с топологией WID автоматически реплицирует базе данных WID на каждом сервере федерации в ферме, фермы серверов федерации с топологией SQL Server содержит только одну копию базы данных  
  
> [!NOTE]  
> SQL Server поддерживает множество разные данные и параметры избыточности приложения, включая отказоустойчивая кластеризация, зеркальное отображение базы данных и несколько различных типов репликации SQL Server.  
  
В области информационных технологий Майкрософт \(ИТ\) отдел использует зеркальное отображение базы данных SQL Server в высокой\-безопасности \(синхронной\) режим и отказоустойчивой кластеризации для обеспечения высокого\- Поддержка доступности для экземпляра SQL Server. Транзакций SQL Server \(однорангового\-для\-однорангового\) и репликации слиянием не были проверены командой разработчиков AD FS в корпорации Microsoft. Дополнительные сведения о SQL Server, см. в разделе [Обзор решений высокой доступности](https://go.microsoft.com/fwlink/?LinkId=179853) или [выбрав соответствующий тип репликации](https://go.microsoft.com/fwlink/?LinkId=214648).  
  
### <a name="supported-sql-server-versions"></a>Поддерживаемые версии SQL Server  
С AD FS в Windows Server 2012 R2 поддерживаются следующие версии SQL server:  
  
-   SQL Server 2008 \/ R2  
  
-   SQL Server 2012  
  
-   SQL Server 2014  
  
## <a name="server-placement-and-network-layout-recommendations"></a>Рекомендации макета для размещения и сети сервера  
Как и в ферму серверов федерации с топологией WID, все серверы федерации в ферме настроено использование одного кластера доменных имен \(DNS\) имя \(, представляющее имя службы федерации\)и IP-адрес одного кластера в процессе балансировки сетевой нагрузки \(балансировки сетевой Нагрузки\) конфигурации кластера. Благодаря этому узел балансировки сетевой Нагрузки распределения клиентских запросов между отдельными серверами федерации. Прокси-сервера федерации может использоваться для клиентских запросов прокси-сервера к ферме серверов федерации.  
  
Ниже показано, как вымышленная компания Contoso Pharmaceuticals развернуть его фермы серверов федерации с топологией SQL Server в корпоративной сети. Также показано, как эту компанию настроить сети периметра с доступом к DNS-сервер, дополнительный узел балансировки сетевой Нагрузки, который использует DNS-именем кластера \(fs.contoso.com\) , используемый в кластере NLB корпоративной сети и с помощью двух веб- прокси приложений \(wap1 и wap2\).  
  
![Ферма серверов с использованием SQL](media/SQLFarmADFSBlue.gif)  
  
Дополнительные сведения о том, как настроить сетевую среду для использования с серверами федерации и прокси веб-приложений см. в разделе «Требования к разрешению имен» статьи [требований AD FS](AD-FS-Requirements.md) и [плана веб-узла Инфраструктуры прокси-сервера приложения (WAP)](https://technet.microsoft.com/library/dn383648.aspx).  
  
## <a name="high-availability-options-for-sql-server-farms"></a>Возможности обеспечения высокой доступности для фермы серверов SQL  
В Windows Server 2012 R2 AD FS являются два новых параметра для поддержки высокой доступности на фермах AD FS, с помощью SQL Server.  
  
-   Поддержка групп доступности AlwaysOn SQL Server  
  
-   Поддержка географически распределенных высокого уровня доступности с помощью репликации слиянием SQL Server  
  
В этом разделе описан каждый из этих вариантов, какие проблемы, которые решают соответственно и некоторые ключевые соображения относительно решить, какие параметры следует развернуть.  
  
> [!NOTE]  
> AD FS ферм, использующих внутреннюю базу данных Windows \(WID\) обеспечения избыточности данных с помощью чтения\/доступ на запись на узле сервера первичного федерации и чтение\-доступ только на вторичных узлах.  Это может использоваться в географически локального или географически распределенной топологии.  
>   
> При использовании внутренней базы данных Windows необходимо учитывать следующие ограничения.  
>   
> -   Фермы внутренней базы данных Windows имеет ограничение в 30 серверов федерации, при наличии 100 или меньше доверия с проверяющей стороной.  
> -   Фермы внутренней базы данных Windows не поддерживает разрешение артефактов для обнаружения и повторного использования токенов \(частью Security Assertion Markup Language \(SAML\) протокола\).  
  
Ниже представлена сводка по использованию ферме внутренней базы данных Windows.  
  
||||  
|-|-|-|  
||1 \- 100 отношениями доверия RP|Более чем 100 отношениями доверия RP|  
|1 \- узлов 30 AD FS|Поддерживается внутренней базы данных Windows|Не поддерживается с использованием WID \- SQL требуется|  
|Узлы более чем 30 AD FS|Не поддерживается с использованием WID \- SQL требуется|Не поддерживается с использованием WID \- SQL требуется|  
  
### <a name="alwayson-availability-groups"></a>Группы доступности AlwaysOn  
**Обзор набора средств Visual Studio для Unity**  
  
Группы доступности AlwaysOn появились в SQL Server 2012 и укажите новый способ создания экземпляра SQL Server высокой доступности.  Группы доступности AlwaysOn объединить элементы кластеризацию и зеркальное отображение базы данных для обеспечения избыточности и отработки отказа на уровне экземпляра SQL, так и на уровне базы данных.  В отличие от предыдущих высокого уровня доступности, группы доступности AlwaysOn не требуется общее хранилище \(или сеть хранения данных\) на уровне базы данных.  
  
Группа доступности состоит из первичной реплики \(набор чтения\-записи базы данных-источники\) и от одной до четырех реплик доступности \(наборов соответствующих вторичных баз данных\).  Группа доступности поддерживает одного чтения\-запись копии \(первичной\), чтения и не более четырех\-только реплики доступности.  Все реплики доступности должны располагаться на разных узлах одной отказоустойчивой кластеризации Windows Server \(WSFC\) кластера.  Дополнительные сведения о доступности AlwaysOn группы см. в разделе [Обзор групп доступности AlwaysOn \(SQL Server\)](https://technet.microsoft.com/library/ff877884.aspx).  
  
С точки зрения из узлов фермы AD FS SQL Server, группы доступности AlwaysOn заменяет один экземпляр SQL Server в качестве политики \/ артефактов базы данных.  Прослушиватель группы доступности — какие клиент \(службы маркеров безопасности AD FS\) использует для подключения к SQL.  
  
На следующей схеме показана фермы серверов AD FS SQL с группой доступности AlwaysOn.  
  
![Ферма серверов с использованием SQL](media/alwaysonavailabilitygroups.jpg)  
  
> [!NOTE]  
> Группы доступности AlwaysOn требуют, что экземпляры SQL Server находятся на отказоустойчивой кластеризации Windows Server \(WSFC\) узлов.  
  
> [!NOTE]  
> Только одна реплика доступности может выступать в качестве целевого объекта автоматической отработки отказа, остальные три будет зависеть от таких операций.  
  
**Основные рекомендации по развертыванию**  
  
Если вы планируете использовать группы доступности AlwaysOn в сочетании с репликацией слиянием SQL Server, пожалуйста, обратите внимание, рассмотренных в разделе «Рекомендации по развертыванию ключ по использованию AD FS в репликации слиянием, SQL Server» ниже.  В частности при группы доступности AlwaysOn, содержащей базу данных, которая является подписчиком репликации выполняется отработка отказа, то подписка на репликацию завершится ошибкой. Для восстановления репликации администратор репликации должен вручную перенастроить подписчик.  См. в описании конкретной проблеме в SQL Server [подписчики репликации и группы доступности AlwaysOn \(SQL Server\) ](https://technet.microsoft.com/library/hh882436.aspx) и в целом поддерживают инструкции для групп доступности AlwaysOn с в параметрах репликации [репликация, отслеживание изменений, измененных данных и групп доступности AlwaysOn \(SQL Server\)](https://technet.microsoft.com/library/hh403414.aspx).  
  
**Настройка служб AD FS для использования группы доступности AlwaysOn**  
  
Для настройки фермы AD FS с группами доступности AlwaysOn необходимо небольшое изменение в процедуры развертывания AD FS:  
  
1.  Для резервного копирования баз данных необходимо создать перед настройкой группы доступности AlwaysOn.  AD FS создает баз данных как часть установки и начальной настройки первого узла службы федерации для новой фермы AD FS SQL Server.  Как часть конфигурации AD FS, необходимо указать строку подключения SQL, поэтому вы должны будете настроить первый узел фермы AD FS для прямого подключения к экземпляру SQL \(это временный\).   Конкретные рекомендации по настройке фермы AD FS, включая настройку узла фермы AD FS со строкой подключения SQL server, см. в разделе [Configure a Federation Server](../../ad-fs/deployment/Configure-a-Federation-Server.md).  
  
2.  После создания базы данных AD FS, включать их в группы доступности AlwaysOn и создайте общие TCPIP прослушиватель, используя средства SQL Server и обработки в [Создание и Настройка групп доступности \(SQL Server\) ](https://technet.microsoft.com/library/ff878265.aspx).  
  
3.  Наконец можно используйте PowerShell для изменения свойств службы федерации Active Directory, чтобы обновить строки подключения SQL для использования DNS-адрес прослушивателя группы доступности AlwaysOn.  
  
    Пример команды PSH, чтобы обновить строку подключения SQL для базы данных конфигурации AD FS:  
  
    ```  
    PS:\>$temp= Get-WmiObject -namespace root/ADFS -class SecurityTokenService  
    PS:\>$temp.ConfigurationdatabaseConnectionstring=”data source=<SQLCluster\SQLInstance>; initial catalog=adfsconfiguration;integrated security=true”  
    PS:\>$temp.put()  
  
    ```  
  
4.  Пример PSH команды, чтобы обновить строку подключения SQL для базы данных службы AD FS артефакта разрешения:  
  
    ```  
    PS:\> Set-AdfsProperties –artifactdbconnection ”Data source=<SQLCluster\SQLInstance >;Initial Catalog=AdfsArtifactStore;Integrated Security=True”  
    ```  
  
### <a name="sql-server-merge-replication"></a>Репликация слиянием SQL Server  
Кроме того, появились в SQL Server 2012, репликация слиянием позволяет для обеспечения избыточности данных политики AD FS со следующими характеристиками:  
  
-   Чтение и запись возможность на всех узлах \(не только основной\)  
  
-   Меньшее количество данных, реплицируются асинхронно во избежание внесения задержки в систему  
  
На следующей схеме показана гео-избыточное фермы AD FS SQL Server с помощью репликации слиянием \(1 издателя, подписчиков 2\):  
  
![Ферма серверов с использованием SQL](media/ADFSSQLGeoRedundancy3.png)  
  
**Рекомендации по развертыванию ключ по использованию AD FS с помощью репликации слиянием SQL Server \(Обратите внимание, номера на схеме выше\)**  
  
-   База данных распространителя не поддерживается для использования с группами доступности AlwaysOn или зеркальное отображение базы данных.  См. в разделе SQL Server поддерживают инструкции для групп доступности AlwaysOn с параметрами репликации в [репликация, отслеживание изменений, измененных данных и групп доступности AlwaysOn \(SQL Server\)](https://technet.microsoft.com/library/hh403414.aspx).  
  
-   При группы доступности AlwaysOn, содержащей базу данных, которая является подписчиком репликации выполняется отработка отказа, то подписка на репликацию завершится ошибкой. Для восстановления репликации администратор репликации должен вручную перенастроить подписчик.  См. в описании конкретной проблеме в SQL Server [подписчики репликации и группы доступности AlwaysOn \(SQL Server\) ](https://technet.microsoft.com/library/hh882436.aspx) и в целом поддерживают инструкции для групп доступности AlwaysOn с параметры репликации [репликация, отслеживание изменений, измененных данных и групп доступности AlwaysOn \(SQL Server\)](https://technet.microsoft.com/library/hh403414.aspx).  
  
Более подробные инструкции по настройке AD FS для использования репликации слиянием SQL Server, см. в разделе [установки географической избыточности с помощью репликации SQL Server](https://technet.microsoft.com/library/dn632406.aspx).  
  
## <a name="see-also"></a>См. также  
[Планирование топологии развертывания для служб федерации Active Directory](Plan-Your-AD-FS-Deployment-Topology.md)  
[Руководство по разработке служб федерации Active Directory в Windows Server 2012 R2](AD-FS-Design-Guide-in-Windows-Server-2012-R2.md)  
  

