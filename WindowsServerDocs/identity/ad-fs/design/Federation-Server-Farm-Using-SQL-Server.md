---
ms.assetid: e983d2ab-4153-41e7-b243-12cf7d71a552
title: Ферма серверов федерации с использованием SQL Server
author: billmath
ms.author: billmath
manager: femila
ms.date: 05/31/2017
ms.topic: article
ms.prod: windows-server
ms.technology: identity-adfs
ms.openlocfilehash: 9d4231ce533f2892fd2110c85ef503836a70ce34
ms.sourcegitcommit: d5e27c1f2f168a71ae272bebf8f50e1b3ccbcca3
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/23/2020
ms.locfileid: "86966836"
---
# <a name="federation-server-farm-using-sql-server"></a>Ферма серверов федерации с использованием SQL Server

Эта топология для службы федерации Active Directory (AD FS) \( AD FS \) отличается от фермы серверов федерации с использованием топологии развертывания внутренней базы данных \( WID Windows \) в том, что она не реплицирует данные на каждый сервер федерации в ферме. Вместо этого все серверы федерации в ферме могут считывать и записывать данные в общую базу данных, которая хранится на сервере, работающем Microsoft SQL Server, расположенном в корпоративной сети.  
  
> [!IMPORTANT]  
> Если вы хотите создать ферму AD FS и использовать SQL Server для хранения данных конфигурации, можно использовать SQL Server 2008 и более поздних версий, включая SQL Server 2012 и SQL Server 2014.  
  
## <a name="deployment-considerations"></a>Рекомендации по развертыванию  
В этом разделе описываются различные вопросы о предполагаемой аудитории, преимуществах и ограничениях, связанных с этой топологией развертывания.  
  
### <a name="who-should-use-this-topology"></a>Кто должен использовать эту топологию?  
  
-   Крупные организации с более чем 100 доверительными отношениями, которые должны предоставить внутренним пользователям и внешним пользователям единый вход единого входа к \- \( \) федеративным приложениям или службам.  
  
-   Организации, которые уже используют SQL Server и хотят воспользоваться преимуществами существующих средств и знаний  
  
### <a name="what-are-the-benefits-of-using-this-topology"></a>Каковы преимущества использования этой топологии?  
  
-   Поддержка большего числа отношений доверия \( более 100\)  
  
-   Поддержка обнаружения маркеров. \( компонент безопасности \) и разрешение артефактов \( в язык разметки зявлений системы безопасности (SAML) \( \) протокол SAML 2,0\)  
  
-   Поддержка полных преимуществ SQL Server, таких как зеркальное отображение баз данных, отказоустойчивая кластеризация, отчеты и средства управления  
  
### <a name="what-are-the-limitations-of-using-this-topology"></a>Каковы ограничения использования этой топологии?  
  
-   Эта топология не обеспечивает избыточность базы данных по умолчанию. Хотя ферма серверов федерации с топологией WID автоматически реплицирует базу данных WID на каждом сервере федерации в ферме, ферма серверов федерации с топологией SQL Server содержит только одну копию базы данных.  
  
> [!NOTE]  
> SQL Server поддерживает множество различных параметров обеспечения избыточности данных и приложений, включая отказоустойчивую кластеризацию, зеркальное отображение базы данных и несколько различных типов репликации SQL Server.  
  
ИТ-отдел корпорации \( Майкрософт \) использует SQL Server зеркальное отображение базы данных в \- \( синхронном \) режиме высокой безопасности и отказоустойчивой кластеризации, чтобы обеспечить поддержку высокого уровня \- доступности для экземпляра SQL Server. SQL Server транзакционный одноранговый \( узел \- \- \) и репликация слиянием не тестировались группой разработчиков AD FS корпорации Майкрософт. Дополнительные сведения о SQL Server см. в разделе [Общие сведения о решениях высокого уровня доступности](https://go.microsoft.com/fwlink/?LinkId=179853) или [выборе подходящего типа репликации](https://go.microsoft.com/fwlink/?LinkId=214648).  
  
### <a name="supported-sql-server-versions"></a>Поддерживаемые версии SQL Server  
В AD FS в Windows Server 2012 R2 поддерживаются следующие версии SQL Server:  
  
-   SQL Server 2008 \/ R2  
  
-   SQL Server 2012  
  
-   SQL Server 2014  
  
## <a name="server-placement-and-network-layout-recommendations"></a>Рекомендации по размещению и макету сети сервера  
Аналогично ферме серверов федерации с топологией WID, все серверы федерации в ферме настроены на использование одного \( DNS-имени кластера, \) \( которое представляет имя служба федерации \) и один IP-адрес кластера в составе конфигурации кластера балансировки сетевой нагрузки \( \) . Это помогает узлу балансировки сетевой нагрузки распределять запросы клиентов на отдельные серверы федерации. Прокси-серверы федерации можно использовать для клиентских запросов к ферме серверов федерации.  
  
На следующем рисунке показано, как вымышленная компания Contoso Pharmaceuticals развернула свою ферму серверов федерации с топологией SQL Server в корпоративной сети. В нем также показано, как компания настроила сеть периметра с доступом к DNS-серверу, дополнительный узел балансировки сетевой нагрузки, использующий то же DNS-имя кластера \( FS.contoso.com \) , которое используется в КЛАСТЕРе балансировки сетевой нагрузки корпоративной сети, а также два прокси-приложения \( wap1 и WAP2 \) .  
  
![ферма серверов, использующая SQL](media/SQLFarmADFSBlue.gif)  
  
Дополнительные сведения о настройке сетевой среды для использования с серверами федерации или прокси веб-приложений см. в подразделе "требования к разрешению имен" статьи [AD FS требования](AD-FS-Requirements.md) и [Планирование инфраструктуры прокси-службы веб приложения (WAP)](/previous-versions/orphan-topics/ws.11/dn383648(v=ws.11)).  
  
## <a name="high-availability-options-for-sql-server-farms"></a>Параметры высокого уровня доступности для ферм SQL Server  
В Windows Server 2012 R2 AD FS есть два новых варианта поддержки высокого уровня доступности в фермах AD FS с помощью SQL Server.  
  
-   Поддержка SQL Server группы доступности AlwaysOn  
  
-   Поддержка географически распределенного высокого уровня доступности с помощью SQL Server репликации слиянием  
  
В этом разделе описаны все эти параметры, проблемы, которые они должны решить, а также некоторые ключевые моменты, связанные с выбором вариантов развертывания.  
  
> [!NOTE]  
> AD FS ферм, использующих внутреннюю базу данных Windows \( WID, \) обеспечивают базовую избыточность данных с \/ доступом на чтение для записи на основном узле сервера федерации и \- доступ только для чтения на вторичных узлах.Его можно использовать в географически локальной или географически распределенной топологии.  
>   
> При использовании WID учитывайте следующие ограничения.  
>   
> -   Ферма WID имеет ограничение в 30 серверов федерации, если у вас 100 или меньше отношений доверия проверяющей стороны.  
> -   Ферма WID не поддерживает определение воспроизведения маркеров или разрешение артефактов \( в \( \) протоколе язык разметки зявлений системы безопасности (SAML) SAML \) .  
  
Следующая таблица содержит сводку по использованию фермы WID.  
  
||||  
|-|-|-|  
||1 \- 100 доверия RP|Более 100 доверий RP|  
|1 \- 30 AD FS узлов|Поддерживается для WID|Не поддерживается при использовании WID \- SQL обязательно|  
|Более 30 AD FS узлов|Не поддерживается при использовании WID \- SQL обязательно|Не поддерживается при использовании WID \- SQL обязательно|  
  
### <a name="alwayson-availability-groups"></a>Группы доступности AlwaysOn  
**Обзор**  
  
Группы доступности AlwaysOn появились в SQL Server 2012 и предоставляют новый способ создания экземпляра SQL Server высокой доступности.Группы доступности AlwaysOn объединяют элементы кластеризации и зеркального отображения базы данных для обеспечения избыточности и отработки отказа на уровне экземпляра SQL и на уровне базы данных.В отличие от предыдущих вариантов высокого уровня доступности, группам доступности AlwaysOn не требуется общее хранилище \( или сеть хранения \) на уровне базы данных.  
  
Группа доступности состоит из первичной реплики \( , набора операций чтения \- и записи базы данных-источника с \) одной до четырех наборов реплик доступности \( соответствующих баз данных-получателей \) .Группа доступности поддерживает одну \- копию \( первичной реплики \) и одну до четырех доступных только для чтения \- реплик доступности.Каждая реплика доступности должна находиться на отдельном узле кластера WSFC отказоустойчивого кластера Windows Server \( \) .Дополнительные сведения о группах доступности AlwaysOn см. в статье [Общие сведения о группы доступности AlwaysOn \( \) SQL Server](/sql/database-engine/availability-groups/windows/overview-of-always-on-availability-groups-sql-server?view=sql-server-ver15).  
  
С точки зрения узлов фермы AD FS SQL Server группа доступности AlwaysOn заменяет один экземпляр SQL Server в качестве \/ базы данных артефакта политики.Прослушиватель группы доступности — это клиент \( , который служба маркеров безопасности AD FS \) использует для подключения к SQL.  
  
На следующей схеме показана ферма SQL Server AD FS с группой доступности AlwaysOn.  
  
![ферма серверов, использующая SQL](media/alwaysonavailabilitygroups.jpg)  
  
> [!NOTE]  
> Для групп доступности AlwaysOn требуется, чтобы экземпляры SQL Server находились на узлах WSFC отказоустойчивого кластера Windows Server \( \) .  
  
> [!NOTE]  
> Только одна реплика доступности может действовать как цель автоматической отработки отказа, остальные три будут полагаться на отработку отказа вручную.  
  
**Основные рекомендации по развертыванию**  
  
Если вы планируете использовать группы доступности AlwaysOn в сочетании с SQL Server репликацией слиянием, обратите внимание на проблемы, описанные в разделе "ключевые аспекты развертывания для использования AD FS с SQL Server репликации слиянием" ниже.В частности, при отработки отказа группы доступности AlwaysOn, содержащей базу данных, которая является подписчиком репликации, происходит сбой подписки на репликацию. Для восстановления репликации администратор репликации должен вручную перенастроить подписчик.См. SQL Server описание конкретной проблемы на [подписчиках репликации и группы доступности AlwaysOn \( SQL Server \) ](/sql/database-engine/availability-groups/windows/replication-subscribers-and-always-on-availability-groups-sql-server?view=sql-server-ver15) и общие инструкции по поддержке групп доступности AlwaysOn с параметрами репликации при [репликации, отслеживание изменений, системы отслеживания измененных данных и \( группы доступности AlwaysOn \) SQL Server](/sql/database-engine/availability-groups/windows/replicate-track-change-data-capture-always-on-availability?view=sql-server-ver15).  
  
**Настройка AD FS для использования группы доступности AlwaysOn**  
  
Настройка фермы AD FS с группами доступности AlwaysOn требует внесения незначительных изменений в процедуру развертывания AD FS.  
  
1.  Прежде чем можно будет настроить группы доступности AlwaysOn, необходимо создать базы данных, для которых требуется создать резервную копию.AD FS создает свои базы данных в процессе установки и первоначальной настройки первого узла службы федерации новой фермы SQL Server AD FS.В рамках конфигурации AD FS необходимо указать строку подключения SQL, поэтому необходимо настроить первый узел фермы AD FS для подключения к экземпляру SQL напрямую \( . это временная возможность \) . Конкретные рекомендации по настройке фермы AD FS, включая настройку узла фермы AD FS со строкой подключения SQL Server, см. в разделе [Настройка сервера федерации](../../ad-fs/deployment/Configure-a-Federation-Server.md).  
  
2.  После создания AD FS баз данных назначьте их группам доступности AlwaysOn и создайте общий прослушиватель TCPIP, используя средства SQL Server и процесс [создания и настройки групп доступности \( SQL Server \) ](/sql/database-engine/availability-groups/windows/creation-and-configuration-of-availability-groups-sql-server?view=sql-server-ver15).  
  
3.  Наконец, с помощью PowerShell можно изменить свойства AD FS, чтобы обновить строку подключения SQL для использования DNS-адреса прослушивателя группы доступности AlwaysOn.  
  
    Пример команды КОМАНДНОМ PSH для обновления строки подключения SQL для базы данных конфигурации AD FS:  
  
    ```  
    PS:\>$temp= Get-WmiObject -namespace root/ADFS -class SecurityTokenService  
    PS:\>$temp.ConfigurationdatabaseConnectionstring="data source=<SQLCluster\SQLInstance>; initial catalog=adfsconfiguration;integrated security=true"  
    PS:\>$temp.put()  
  
    ```  
  
4.  Пример команды КОМАНДНОМ PSH для обновления строки подключения SQL для базы данных службы разрешения артефактов AD FS:  
  
    ```  
    PS:\> Set-AdfsProperties –artifactdbconnection "Data source=<SQLCluster\SQLInstance >;Initial Catalog=AdfsArtifactStore;Integrated Security=True"  
    ```  
  
### <a name="sql-server-merge-replication"></a>SQL Server репликация слиянием  
Кроме того, в SQL Server 2012 репликация слиянием обеспечивает избыточность данных политики AD FS со следующими характеристиками:  
  
-   Возможность чтения и записи на всех узлах \( , а не только в первичной\)  
  
-   Меньшие объемы данных, реплицируемых асинхронно во избежание задержки системы  
  
На следующей схеме показаны географически избыточные AD FS фермы SQL Server с издателем репликации слиянием \( 1, два подписчика \) :  
  
![ферма серверов, использующая SQL](media/ADFSSQLGeoRedundancy3.png)  
  
**Основные рекомендации по развертыванию для использования AD FS с SQL Server \( в приведенной выше диаграмме числа заметок о репликации слиянием\)**  
  
-   База данных распространителя не поддерживается для использования с группы доступности AlwaysOn или зеркальным отображением базы данных.См. инструкции по SQL Server поддержки для групп доступности AlwaysOn с параметрами репликации при [репликации, отслеживание изменений, системы отслеживания измененных данных и группы доступности AlwaysOn \( SQL Server \) ](/sql/database-engine/availability-groups/windows/replicate-track-change-data-capture-always-on-availability?view=sql-server-ver15).  
  
-   Если в группе доступности AlwaysOn, содержащей базу данных, которая является подписчиком репликации, произошел сбой, то подписка на репликацию завершится ошибкой. Для восстановления репликации администратор репликации должен вручную перенастроить подписчик.См. SQL Server описание конкретной проблемы на [подписчиках репликации и группы доступности AlwaysOn \( SQL Server \) ](/sql/database-engine/availability-groups/windows/replication-subscribers-and-always-on-availability-groups-sql-server?view=sql-server-ver15) и общие инструкции по поддержке групп доступности AlwaysOn с параметрами репликации [репликацией, отслеживание изменений, отслеживание измененных данных и \( группы доступности AlwaysOn \) SQL Server](/sql/database-engine/availability-groups/windows/replicate-track-change-data-capture-always-on-availability?view=sql-server-ver15).  
  
Более подробные инструкции по настройке AD FS для использования SQL Server репликации слиянием см. в статье [Настройка географической избыточности с помощью репликация SQL Server](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/dn632406(v=ws.11)).  
  
## <a name="see-also"></a>См. также  
[Планирование топологии развертывания для служб федерации Active Directory](Plan-Your-AD-FS-Deployment-Topology.md)  
[Руководство по разработке служб федерации Active Directory в Windows Server 2012 R2](AD-FS-Design-Guide-in-Windows-Server-2012-R2.md)  
  
