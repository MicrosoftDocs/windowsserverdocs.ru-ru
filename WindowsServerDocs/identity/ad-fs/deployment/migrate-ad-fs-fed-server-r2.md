---
title: "Перенос сервера AD FS 2.0 федерации"
description: "Сведения о миграции сервер AD FS в Windows Server 2012 R2."
author: billmath
ms.author: billmath
manager: femila
ms.date: 07/10/2017
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: identity-adfs
ms.openlocfilehash: bef24f79cfa92dfeca1846501f14ebf6d8231f0d
ms.sourcegitcommit: db290fa07e9d50686667bfba3969e20377548504
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/12/2017
---
# <a name="migrate-the-ad-fs-20-federation-server-to-ad-fs-on-windows-server-2012-r2"></a>Перенос сервера AD FS 2.0 федерации для Служб федерации Active Directory в Windows Server 2012 R2

Чтобы перенести сервер федерации AD FS, принадлежащий фермы AD FS с одним узлом, ферме WIF или ферме SQL Server в Windows Server 2012 R2, необходимо выполнить следующие задачи:  
  
1.  [Экспорт и резервное копирование данных конфигурации AD FS](migrate-ad-fs-fed-server-r2.md#export-and-backup-the-ad-fs-configuration-data)  
  
2.  [Создание фермы серверов федерации Windows Server 2012 R2](migrate-ad-fs-fed-server-r2.md#create-a-windows-server-2012-r2-federation-server-farm)  
  
3.  [Импорт исходных данных конфигурации в ферму Windows Server 2012 R2 AD FS](migrate-ad-fs-fed-server-r2.md#import-the-original-configuration-data-into-the-windows-server-2012-r2-ad-fs-farm)  
  
##  <a name="export-and-backup-the-ad-fs-configuration-data"></a>Экспорт и резервное копирование данных конфигурации AD FS  
 Чтобы экспортировать параметры конфигурации AD FS, выполните следующие процедуры:  
  
###  <a name="to-export-service-settings"></a>Экспорт параметров службы  
  
1.  Убедитесь, что есть доступ к следующим сертификатам и их закрытым ключам в PFX-файл.  
  
    -   SSL-сертификат, используемый фермой серверов федерации, которые требуется перенести  
  
    -   Сертификату взаимодействия служб (если он отличается от SSL-сертификата), используемый фермой серверов федерации, которые требуется перенести  
  
    -   Все сторонних подписи или шифрования и расшифровки маркера сертификаты, используемые фермой серверов федерации, которые требуется перенести  
  
Чтобы найти SSL-сертификат, откройте Internet Information Services (IIS) управления консоли, выберите команду **веб-сайт по умолчанию** в левой области щелкните **привязки...** в **действие** , найдите и выберите https-привязки, нажмите кнопку **изменить**, а затем нажмите кнопку **представление**.  
  
Необходимо экспортировать сертификат SSL, используемый службой федерации и его закрытый ключ в PFX-файл. Дополнительные сведения см. в разделе [Экспорт части сертификата аутентификации сервера с закрытым ключом](export-the-private-key-portion-of-a-server-authentication-certificate.md).  
  
> [!NOTE]
>  Если вы планируете развернуть службу регистрации устройств в ходе запуска AD FS в Windows Server 2012 R2, необходимо получить новый SSL-сертификат. Дополнительные сведения см. в разделе [регистрация SSL-сертификата для AD FS](enroll-an-ssl-certificate-for-ad-fs.md) и [Настройка сервера федерации с использованием службы регистрации устройств](configure-a-federation-server-with-device-registration-service.md).  
  
Чтобы просмотреть сертификат для подписи маркера, маркеров и сертификаты взаимодействия служб, которые используются, выполните следующую команду Windows PowerShell для создания списка всех сертификатов, используемых в файл:  
  
``` powershell
Get-ADFSCertificate | Out-File “.\certificates.txt”  
 ```  
  
2.  Экспортируйте свойства службы федерации AD FS, такие как имя службы федерации, отображаемое имя службы федерации и идентификатор службы федерации в файл.  
  
Чтобы экспортировать свойства службы федерации, откройте Windows PowerShell и выполните следующую команду: 

``` powershell
Get-ADFSProperties | Out-File “.\properties.txt”`.  
``` 

Выходной файл будет содержать следующие важные значения конфигурации:  
 
|**Имя свойства службы федерации, возвращенное командой Get-ADFSProperties**|**Имя свойства службы федерации в консоли управления AD FS**|
|-----|-----|  
|Имя узла|Имя службы федерации|  
|Идентификатор|Идентификатор службы федерации|  
|Отображаемое имя|Отображаемое имя службы федерации|  
  
3.  Создайте резервную копию файла конфигурации приложения. Вместе с другими параметрами этот файл содержит строку подключения к базе данных политик.  
  
Чтобы создать резервную копию файла конфигурации приложения, необходимо вручную скопировать `%programfiles%\Active Directory Federation Services 2.0\Microsoft.IdentityServer.Servicehost.exe.config` надежное расположение на резервном сервере.  
  
> [!NOTE]
>  Запишите строку подключения к базе данных в этот файл, расположенный сразу после «policystore connectionstring =». Если строка подключения указывает на базу данных SQL Server, то это значение понадобится при восстановлении исходной конфигурации AD FS на сервере федерации.  
>   
>  Ниже приводится пример строки подключения к внутренней базы данных Windows: `“Data Source=\\.\pipe\mssql$microsoft##ssee\sql\query;Initial Catalog=AdfsConfiguration;Integrated Security=True"`. Ниже приводится пример строки подключения к SQL Server: `"Data Source=databasehostname;Integrated Security=True"`.  
  
4.  Запишите удостоверение учетной записи службы федерации AD FS и пароль этой учетной записи.  
  
Чтобы найти значение удостоверения, просмотрите **вход в систему** столбец **AD Windows служб федерации Active Directory 2.0** в **службы** Запишите это значение.  
  
> [!NOTE]
>  Для автономной службы федерации использовать встроенную учетную запись СЕТЕВОЙ службы.  В этом случае не нужно иметь пароль.  
  
5.  Экспортируйте список задействованных конечных точек AD FS в файл.  
  
Чтобы сделать это, откройте Windows PowerShell и выполните следующую команду: 

``` powershell
Get-ADFSEndpoint | Out-File “.\endpoints.txt”`.  
``` 

6.  Экспортируйте все пользовательские описания утверждений в файл.  
  
Чтобы сделать это, откройте Windows PowerShell и выполните следующую команду: 

``` powershell
Get-ADFSClaimDescription | Out-File “.\claimtypes.txt”`.  
 ```

7.  Если у вас есть особые параметры, например useRelayStateForIdpInitiatedSignOn, настроенные в файле web.config, обязательно сохраните резервную копию файла web.config для справки. Этот файл можно скопировать из каталога, сопоставленного виртуальному пути **«/ adfs/ls»** в службах IIS. По умолчанию он находится в **%systemdrive%\inetpub\adfs\ls** каталога.  
  
###  <a name="to-export-claims-provider-trusts-and-relying-party-trusts"></a>Чтобы экспортировать отношения доверия с поставщиком утверждений и отношений доверия с проверяющей стороной  
  
1.  Для экспорта AD FS отношения доверия поставщика утверждений и отношения доверия проверяющей стороны, необходимо выполнить вход от имени администратора (тем не менее, не администратора домена) на федерации и запустите следующую команду Windows PowerShell сценарий, который находится в **мультимедиа, server_support/adfs** установочном компакт-диске Windows Server 2012 R2: `export-federationconfiguration.ps1`.  
  
> [!IMPORTANT]
>  Сценарий экспорта принимает следующие параметры:  
>   
>  -   Export-FederationConfiguration.ps1-Path < string\ > [-ComputerName < string\ >] [-Credential < pscredential\ >] [-Force] [-CertificatePassword < securestring\ >]  
> -   Export-FederationConfiguration.ps1-Path < string\ > [-ComputerName < string\ >] [-Credential < pscredential\ >] [-Force] [-CertificatePassword < securestring\ >] [-RelyingPartyTrustIdentifier < string [] >] [-ClaimsProviderTrustIdentifier < string [] >]  
> -   Export-FederationConfiguration.ps1-Path < string\ > [-ComputerName < string\ >] [-Credential < pscredential\ >] [-Force] [-CertificatePassword < securestring\ >] [-RelyingPartyTrustName < string [] >] [-ClaimsProviderTrustName < string [] >]  
>   
>  **-RelyingPartyTrustIdentifier < string [] >** — командлет экспортирует только те отношения доверия проверяющей стороны, идентификаторы которых указаны в массиве строк. Значение по умолчанию — экспортируется ни ОДНО отношение доверия с проверяющей стороной. Если указан ни один из RelyingPartyTrustIdentifier, ClaimsProviderTrustIdentifier, RelyingPartyTrustName и ClaimsProviderTrustName, сценарий экспортирует все отношения доверия с проверяющей стороной и отношения доверия с поставщиком утверждений.  
>   
>  **-ClaimsProviderTrustIdentifier < string [] >** — командлет экспортирует только те отношения доверия поставщика утверждений, идентификаторы которых указаны в массиве строк. По умолчанию есть не экспортируется ни ОДНО отношение доверия с поставщиком утверждений.  
>   
>  **-RelyingPartyTrustName < string [] >** — командлет экспортирует только те отношения доверия проверяющей стороны, имена которых указаны в массиве строк. Значение по умолчанию — экспортируется ни ОДНО отношение доверия с проверяющей стороной.  
>   
>  **-ClaimsProviderTrustName < string [] >** — командлет экспортирует только те отношения доверия поставщика утверждений, имена которых указаны в массиве строк. По умолчанию есть не экспортируется ни ОДНО отношение доверия с поставщиком утверждений.  
>   
>  **-Path < string\ >** -путь к папке, которая будет содержать экспортируемые файлы.  
>   
>  **-ComputerName < string\ >** -имя узла сервера STS. По умолчанию используется локальный компьютер. При переносе AD FS 2.0 или AD FS в Windows Server 2012 на AD FS в Windows Server 2012 R2 это имя узла сервера AD FS прежних версий.  
>   
>  **-Credential < PSCredential\ >** -Указывает учетную запись пользователя, имеющую разрешение на выполнение этого действия. По умолчанию используется текущий пользователь.  
>   
>  **-Принудительно** — запрещает вывод запросов на подтверждение для пользователя.  
>   
>  **-CertificatePassword < SecureString\ >** — определяет пароль для закрытых ключей сертификатов Служб федерации Active Directory. Если не указано, сценарий выведет запрос на ввод пароля требуется экспортировать сертификат AD FS с закрытым ключом.  
>   
>  **Входные данные**: нет  
>   
>  **Выходные данные**: string — этот командлет возвращает путь к папке экспорта. Можно передать методу Import-FederationConfiguration возвращенный объект.  
  
###  <a name="to-back-up-custom-attribute-stores"></a>Резервное копирование хранилищ настраиваемых атрибутов  
  
1.  Кроме того, необходимо вручную экспортировать все хранилища настраиваемых атрибутов, которые вы хотите сохранить в новой ферме AD FS в Windows Server 2012 R2.  
  
> [!NOTE]
>  В Windows Server 2012 R2 AD FS требуются пользовательские хранилища атрибутов на основе .NET Framework 4.0 или выше. Следуйте инструкциям в [Microsoft .NET Framework 4.5](https://www.microsoft.com/download/details.aspx?id=30653) для установки и установки .net Framework 4.5.  
  
Сведения о хранилищах настраиваемых атрибутов можно найти в используемых ролью AD FS, выполнив следующую команду Windows PowerShell: 

``` powershell
Get-ADFSAttributeStore
```  

Действия по обновлению или переносу пользовательских хранилищ атрибутов могут быть разными.  
  
2.  Необходимо вручную экспортировать все DLL-файлы хранилища настраиваемых атрибутов, которые вы хотите сохранить в новой ферме AD FS в Windows Server 2012 R2. Действия по обновлению или переносу DLL-файлы пользовательских хранилищ атрибутов могут быть разными.  
  
##  <a name="create-a-windows-server-2012-r2-federation-server-farm"></a>Создание фермы серверов федерации Windows Server 2012 R2  
  
1.  Установка операционной системы Windows Server 2012 R2 на компьютере, который вы хотите работать в качестве сервера федерации, а затем добавьте роль сервера AD FS. Дополнительные сведения см. в разделе [установки службы роли AD FS](install-the-ad-fs-role-service.md). Затем настройте новую службу федерации при помощи мастера конфигурации федерации служб Active Directory или через Windows PowerShell. Дополнительные сведения см. в разделе «Настройка первого сервера федерации в ферме серверов федерации» в [Настройка сервера федерации](configure-a-federation-server.md).  

При выполнении этого шага вы выполните следующие действия:  
  
-   Для настройки службы федерации необходимо иметь привилегии администратора домена.  
  
-   Необходимо использовать то же имя службы федерации (имя фермы), которое использовалось в AD FS 2.0 или AD FS в Windows Server 2012. Если вы не использовать то же имя службы федерации, сертификаты, резервные копии которых не будет функционировать в службе федерации Windows Server 2012 R2, которую вы настраиваете.  
  
-   Укажите, является ли это ферма серверов федерации WID или SQL Server. Если это SQL-фермы, укажите расположение базы данных SQL Server и имя экземпляра.  
  
-   Необходимо указать pfx-файл, содержащий SSL-сертификат проверки подлинности сервера, резервная копия которой была создана при подготовке процесса миграции AD FS.  
  
-   Необходимо указать то же удостоверение учетной записи службы, которое использовалось в AD FS 2.0 или AD FS в ферме Windows Server 2012.  
  
2.  После настройки первого узла можно добавить дополнительные узлы в новую ферму. Дополнительные сведения см. в разделе «Добавление сервера федерации в существующую ферму серверов федерации» в [Настройка сервера федерации](configure-a-federation-server.md).  
  
##  <a name="import-the-original-configuration-data-into-the-windows-server-2012-r2-ad-fs-farm"></a>Импорт исходных данных конфигурации в ферму Windows Server 2012 R2 AD FS  
 Теперь, когда у вас есть ферма серверов федерации AD FS в Windows Server 2012 R2, можно импортировать исходные данные конфигурации AD FS.  
  
1.  Импортируйте и настройте другие пользовательские сертификаты Служб федерации Active Directory, включая внешние сертификаты для подписи маркера и маркер шифрования или расшифровки сертификаты, а сертификат взаимодействия служб, если он отличается от SSL-сертификат.  
  
В консоли управления AD FS выберите **сертификаты**. Проверьте сертификаты для шифрования и расшифровки и подписи токенов связи, службы, сопоставляя каждое значение со значениями, экспортированными в файл certificates.txt при подготовке к миграции.  
  
Чтобы изменить сертификаты шифрования маркеров или для подписи маркера самозаверяющие сертификаты по умолчанию на внешние сертификаты, сначала необходимо отключить функцию автоматического сертификатов смены, включенный по умолчанию. Чтобы сделать это, можно использовать следующую команду Windows PowerShell:  
  
``` powershell 
Set-ADFSProperties –AutoCertificateRollover $false  
```  
  
2.  Настройте все пользовательские параметры служб AD FS, например AutoCertificateRollover или SSO lifetime, с помощью командлета Set-AdfsProperties.  
  
3.  Чтобы импортировать доверия с проверяющей стороной AD FS и отношения доверия с поставщиком утверждений, вы должны войти качестве администратора (но не администратора домена) на федерации и запустите следующую команду Windows PowerShell сценарий, который находится в папке \support\adfs установочного компакт-диска Windows Server 2012 R2:  
  
``` powershell 
import-federationconfiguration.ps1  
```  
  
> [!IMPORTANT]
>  Этот сценарий импорта принимает следующие параметры:  
>   
>  -  Импорт FederationConfiguration.ps1-Path < string\ > [-ComputerName < string\ >] [-Credential < pscredential\ >] [-Force] [-LogPath < string\ >] [-CertificatePassword < securestring\ >]  
> -   Импорт FederationConfiguration.ps1-Path < string\ > [-ComputerName < string\ >] [-Credential < pscredential\ >] [-Force] [-LogPath < string\ >] [-CertificatePassword < securestring\ >] [-RelyingPartyTrustIdentifier < string [] >] [-ClaimsProviderTrustIdentifier < string [] >  
> -   Импорт FederationConfiguration.ps1-Path < string\ > [-ComputerName < string\ >] [-Credential < pscredential\ >] [-Force] [-LogPath < string\ >] [-CertificatePassword < securestring\ >] [-RelyingPartyTrustName < string [] >] [-ClaimsProviderTrustName < string [] >]  
>   
>  **-RelyingPartyTrustIdentifier < string [] >** — командлет импортирует только те отношения доверия проверяющей стороны, идентификаторы которых указаны в массиве строк. Значение по умолчанию — импортируется ни ОДНО отношение доверия с проверяющей стороной. Если указан ни один из RelyingPartyTrustIdentifier, ClaimsProviderTrustIdentifier, RelyingPartyTrustName и ClaimsProviderTrustName, сценарий импортирует все отношения доверия с проверяющей стороной и отношения доверия с поставщиком утверждений.  
>   
>  **-ClaimsProviderTrustIdentifier < string [] >** — командлет импортирует только те отношения доверия поставщика утверждений, идентификаторы которых указаны в массиве строк. Значение по умолчанию — импортируется ни ОДНО отношение доверия с поставщиком утверждений.  
>   
>  **-RelyingPartyTrustName < string [] >** — командлет импортирует только те отношения доверия проверяющей стороны, имена которых указаны в массиве строк. Значение по умолчанию — импортируется ни ОДНО отношение доверия с проверяющей стороной.  
>   
>  **-ClaimsProviderTrustName < string [] >** — командлет импортирует только те отношения доверия поставщика утверждений, имена которых указаны в массиве строк. Значение по умолчанию — импортируется ни ОДНО отношение доверия с поставщиком утверждений.  
>   
>  **-Path < string\ >** -путь к папке, содержащей импортируемые файлы конфигурации.  
>   
>  **-LogPath < string\ >** -путь к папке, содержащей импортируемый файл журнала. В этой папке будет создан файл журнала с именем «import.log».  
>   
>  **-ComputerName < string\ >** -имя узла сервера STS. По умолчанию используется локальный компьютер. При переносе AD FS 2.0 или AD FS в Windows Server 2012 на AD FS в Windows Server 2012 R2 для этого параметра должно быть присвоено имя узла сервера AD FS прежних версий.  
>   
>  **-Credential < PSCredential\ >**-Указывает учетную запись пользователя, имеющую разрешение на выполнение этого действия. По умолчанию используется текущий пользователь.  
>   
>  **-Принудительно** — запрещает вывод запросов на подтверждение для пользователя.  
>   
>  **-CertificatePassword < SecureString\ >** — определяет пароль для импорта закрытых ключей сертификатов Служб федерации Active Directory. Если не указано, сценарий выведет запрос на ввод пароля необходимости импортировать сертификат AD FS с закрытым ключом.  
>   
>  **Входные данные:** string — Эта команда принимает путь к папке импорта в качестве входных данных. Этой команде можно передать параметр Export-FederationConfiguration.  
>   
>  **Выходные данные:** None.  
  
Пробелы после строки свойства WSFedEndpoint отношения доверия с проверяющей стороной могут вызвать ошибку сценария импорта. В этом случае вручную удалите пробелы из файла перед импортом. Например эти записи вызывать ошибки:  
  
    ```  
    <URI N="WSFedEndpoint">https://127.0.0.1:444 /</URI>  
    ```  
  
    ```  
    <URI N="WSFedEndpoint">https://myapp.cloudapp.net:83 /</URI>  
    ```  
  
     They must be edited to:  
  
    ```  
    <URI N="WSFedEndpoint">https://127.0.0.1:444/</URI>  
    ```  
  
    ```  
    <URI N="WSFedEndpoint">https://myapp.cloudapp.net:83/</URI>  
    ```  
> [!IMPORTANT]
>  Если у вас есть все правила настраиваемых утверждений (которые отличаются от правил AD FS по умолчанию) в отношении доверия поставщика утверждений Active Directory исходной системы, они не будут перенесены с помощью сценариев. Это так, как Windows Server 2012 R2 содержит новые значения по умолчанию. Все пользовательские правила необходимо объединить путем добавления их вручную в отношение доверия поставщика утверждений Active Directory в новой ферме Windows Server 2012 R2.  
  
4.  Настройте все пользовательские параметры конечных точек AD FS. В консоли управления AD FS выберите **конечные точки**. Проверьте задействованные конечные точки AD FS по списку задействованных конечных точек AD FS, который был экспортирован в файл при подготовке к миграции AD FS.  
  
     \ - И -  
  
     Настройте все пользовательские описания утверждений. В консоли управления AD FS выберите **описания утверждений**. Сверьте список описаний утверждений AD FS со списком описаний утверждений, который был экспортирован в файл при подготовке к миграции AD FS. Добавьте все пользовательские описания утверждений содержащиеся в вашем файле, но не включены в список по умолчанию в AD FS. Обратите внимание, что свойство утверждения identifier на консоли управления соответствует свойству claimtype в файле.  
  
5.  Установите и настройте все сохраненные пользовательские хранилища атрибутов. От имени администратора убедитесь, что все двоичные файлы хранилищ настраиваемых атрибутов обновление для .NET Framework 4.0 или более поздней версии, прежде чем ссылаться на них в настройках AD FS.  
  
6.  Настройте свойства служб, которые соответствуют параметрам файл web.config прежних версий в.  
  
    -   Если **useRelayStateForIdpInitiatedSignOn** был добавлен **web.config** файла в AD FS 2.0 или AD FS в ферме Windows Sever 2012, необходимо настроить следующие свойства службы в AD FS в ферме Windows Server 2012 R2:  
  
        -   AD FS в Windows Server 2012 R2 включает в себя **%systemroot%\ADFS\Microsoft.IdentityServer.Servicehost.exe.config** файла. Создайте элемент с таким же синтаксисом, как **web.config** элемент файла: `<useRelayStateForIdpInitiatedSignOn enabled="true" />`. Включите этот элемент в рамках **< microsoft.identityserver.web >** раздел **Microsoft.IdentityServer.Servicehost.exe.config** файла.  
  
    -   Если **< persistIdentityProviderInformation включена = «true & #124; false» lifetimeInDays = «90» enablewhrPersistence = «true & #124; false» / \ >** был добавлен **web.config** файла в AD FS 2.0 или AD FS в ферме Windows Sever 2012, необходимо настроить следующие свойства службы в AD FS в ферме Windows Server 2012 R2:  
  
        1.  В AD FS в Windows Server 2012 R2, выполните следующую команду Windows PowerShell: `Set-AdfsWebConfig –HRDCookieEnabled –HRDCookieLifetime`.  
  
    -   Если **< единого входа включена = «true & #124; false» / \ >** был добавлен **web.config** файл в AD FS 2.0 или AD FS в ферме Windows Sever 2012, задавать дополнительные свойства службы в AD FS в ферме Windows Server 2012 R2 не требуется. Единый вход включен по умолчанию в AD FS в ферме Windows Server 2012 R2.  
  
    -   Если были добавлены параметры localAuthenticationTypes **web.config** файла в AD FS 2.0 или AD FS в ферме Windows Sever 2012, необходимо настроить следующие свойства службы в AD FS в ферме Windows Server 2012 R2:  
  
        -   Параметры Integrated, Forms, TlsClient, Basic Transform list в эквивалентные AD FS в Windows Server 2012 R2 имеет глобальные параметры проверки подлинности политики для поддержки типов проверки подлинности службы и прокси-сервера федерации. Эти параметры можно настроить в AD FS в оснастке управления в разделе **политики проверки подлинности**.  
  
 После импорта исходных данных конфигурации при необходимости можно настроить страницы входа AD FS. Дополнительные сведения см. в разделе [Customizing the AD FS Sign-in Pages](../operations/AD-FS-Customization-in-Windows-Server-2016.md).  
  
## <a name="next-steps"></a>Дальнейшие действия
 [Перенос служб ролей для служб федерации Active Directory в Windows Server 2012 R2](migrate-ad-fs-service-role-to-windows-server-r2.md)   
 [Подготовка к миграции сервера федерации AD FS](prepare-migrate-ad-fs-server-r2.md)   
 [Миграция прокси-сервера федерации AD FS](migrate-fed-server-proxy-r2.md)   
 [Проверка переноса AD FS в Windows Server 2012 R2](verify-ad-fs-migration.md)