---
title: Перенос сервера федерации AD FS 2,0
description: Содержит сведения о миграции AD FS Server на Windows Server 2012 R2.
author: billmath
ms.author: billmath
manager: femila
ms.date: 07/10/2017
ms.topic: article
ms.prod: windows-server
ms.technology: identity-adfs
ms.openlocfilehash: ce88d20e967211b4d5ea4ef98143bfc43c1e433d
ms.sourcegitcommit: d5e27c1f2f168a71ae272bebf8f50e1b3ccbcca3
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/23/2020
ms.locfileid: "86960286"
---
# <a name="migrate-the-ad-fs-20-federation-server-to-ad-fs-on-windows-server-2012-r2"></a>Миграция сервера федерации AD FS 2,0 в AD FS в Windows Server 2012 R2

Чтобы перенести сервер AD FS Федерации, который входит в ферму AD FS с одним узлом, ферму WIF или SQL Server ферму на Windows Server 2012 R2, необходимо выполнить следующие задачи.  
  
1.  [Экспорт данных конфигурации AD FS и создание их резервной копии](migrate-ad-fs-fed-server-r2.md#export-and-backup-the-ad-fs-configuration-data)  
  
2.  [Создание фермы сервера федерации Windows Server 2012 R2](migrate-ad-fs-fed-server-r2.md#create-a-windows-server-2012-r2-federation-server-farm)  
  
3.  [Импорт исходных данных конфигурации в ферму AD FS Windows Server 2012 R2](migrate-ad-fs-fed-server-r2.md#import-the-original-configuration-data-into-the-windows-server-2012-r2-ad-fs-farm)  
  
##  <a name="export-and-backup-the-ad-fs-configuration-data"></a>Экспорт данных конфигурации AD FS и создание их резервной копии  
 Чтобы экспортировать параметры конфигурации AD FS, необходимо выполнить следующие процедуры:  
  
###  <a name="to-export-service-settings"></a>Экспорт параметров службы  
  
1.  Убедитесь, что у вас есть доступ к следующим сертификатам и их закрытым ключам в PFX-файле:  
  
    -   SSL-сертификат, используемый фермой серверов федерации, которую нужно перенести;  
  
    -   сертификат для связи со службой (если он не совпадает с SSL-сертификатом), используемый фермой серверов федерации, которую нужно перенести;  
  
    -   все сертификаты для подписи маркера или сертификаты для шифрования или расшифровки, используемые фермой серверов федерации, которую нужно перенести.  
  
Чтобы найти SSL-сертификат, откройте консоль управления служб IIS, выберите на левой панели элемент **Веб-сайт по умолчанию** , щелкните элемент **Привязки…** на панели **Действие** , найдите и выберите HTTPS-привязки, нажмите **Изменить**, а затем — **Просмотр**.  
  
Вам нужно экспортировать SSL-сертификат, используемый службой федерации, и его закрытый ключ в PFX-файл. Дополнительные сведения см. в разделе [Export the Private Key Portion of a Server Authentication Certificate](export-the-private-key-portion-of-a-server-authentication-certificate.md).  
  
> [!NOTE]
>  Если вы планируете развернуть службу регистрации устройств как часть работы AD FS в Windows Server 2012 R2, необходимо получить новый SSL-сертификат. Дополнительные сведения см. в статье [Регистрация SSL-сертификата для AD FS](enroll-an-ssl-certificate-for-ad-fs.md) и [Настройка сервера федерации с помощью службы регистрации устройств](configure-a-federation-server-with-device-registration-service.md).  
  
Чтобы просмотреть используемые сертификаты для подписи маркеров и для связи со службой, создайте список всех используемых сертификатов в отдельном файле с помощью следующей команды Windows PowerShell:  
  
``` powershell
Get-ADFSCertificate | Out-File “.\certificates.txt”  
 ```  
  
2. Экспортируйте такие свойства службы федерации AD FS, как имя службы федерации, отображаемое имя службы федерации и идентификатор службы федерации в файл.  
  
Чтобы экспортировать свойства службы федерации, откройте Windows PowerShell и выполните следующую команду: 

``` powershell
Get-ADFSProperties | Out-File “.\properties.txt”`.  
``` 

Выходной файл будет содержать следующие важные значения конфигурации:  
 
|**Имя свойства службы федерации, возвращенное командой Get-ADFSProperties**|**Имя свойства службы федерации в консоли управления AD FS**|
|-----|-----|  
|HostName|Имя службы федерации|  
|Идентификатор|Идентификатор службы федерации|  
|DisplayName|Отображаемое имя службы федерации|  
  
3. Создайте резервную копию файла конфигурации приложения. Вместе с другими параметрами этот файл содержит строку подключения к базе данных политик.  
  
Чтобы создать резервную копию файла конфигурации приложения, необходимо вручную скопировать файл `%programfiles%\Active Directory Federation Services 2.0\Microsoft.IdentityServer.Servicehost.exe.config` в надежное расположение на резервном сервере.  
  
> [!NOTE]
>  Запишите строку подключения к базе данных, которая находится в этом файле сразу после строки "policystore connectionstring=". Если эта строка подключения указывает на базу данных SQL Server, то это значение понадобится при восстановлении исходной конфигурации AD FS на сервере федерации.  
>   
>  Ниже приводится пример строки подключения к базе данных WID: `“Data Source=\\.\pipe\mssql$microsoft##ssee\sql\query;Initial Catalog=AdfsConfiguration;Integrated Security=True"`. Следующий пример — строка подключения к базе данных SQL Server: `"Data Source=databasehostname;Integrated Security=True"`.  
  
4. Запишите удостоверение учетной записи службы федерации AD FS и пароль этой учетной записи.  
  
Чтобы найти значение удостоверения, просмотрите столбец **Вход от имени****службы Windows AD FS 2.0** в консоли **Службы**. Запишите это значение.  
  
> [!NOTE]
>  Для автономной службы федерации используется встроенная учетная запись NETWORK SERVICE.  В этом случае пароль не нужен.  
  
5. Экспортируйте список задействованных конечных точек AD FS в файл.  
  
Для этого откройте Windows PowerShell и выполните следующую команду: 

``` powershell
Get-ADFSEndpoint | Out-File “.\endpoints.txt”`.  
``` 

6. Экспортируйте все пользовательские описания утверждений в файл.  
  
Для этого откройте Windows PowerShell и выполните следующую команду: 

``` powershell
Get-ADFSClaimDescription | Out-File “.\claimtypes.txt”`.  
 ```

7. Если в файле web.config настроены особые параметры, например useRelayStateForIdpInitiatedSignOn, обязательно сохраните резервную копию файла web.config для справки. Этот файл можно скопировать из каталога, соответствующего виртуальному пути **"/adfs/ls"** в IIS. По умолчанию он находится в каталоге **%systemdrive%\inetpub\adfs\ls**.  
  
###  <a name="to-export-claims-provider-trusts-and-relying-party-trusts"></a>Экспорт отношений доверия с поставщиком утверждений и отношений доверия с проверяющей стороной  
  
1.  Чтобы экспортировать AD FS доверия поставщиков утверждений и отношения доверия с проверяющей стороной, необходимо войти в систему с учетной записью администратора (но не администратора домена) на сервере федерации и запустить следующий сценарий Windows PowerShell, расположенный в папке **Media/server_support/адфс** установочного компакт-диска Windows Server 2012 R2: `export-federationconfiguration.ps1` .  
  
> [!IMPORTANT]
>  Сценарий экспорта принимает следующие параметры:  
> 
> - Export-FederationConfiguration.ps1-Path <строка \> [-ComputerName <строка \> ] [-Credential <PSCredential \> ] [-Force] [-CertificatePassword <SecureString \> ]  
>   -   Export-FederationConfiguration.ps1-Path <строка \> [-ComputerName <строка \> ] [-Credential <PSCredential \> ] [-Force] [-CertificatePassword <SecureString \> ] [-релингпартитрустидентифиер <строка [] >] [-клаимспровидертрустидентифиер <строка [] >]  
>   -   Export-FederationConfiguration.ps1-Path <строка \> [-ComputerName <строка \> ] [-Credential <PSCredential \> ] [-Force] [-CertificatePassword <SecureString \> ] [-релингпартитрустнаме <строка [] >] [-клаимспровидертрустнаме <строка [] >]  
> 
>   **-RelyingPartyTrustIdentifier <string[]>** — командлет экспортирует только те отношения доверия с проверяющей стороной, идентификаторы которых указаны в массиве строк. Значение по умолчанию NONE, то есть не экспортируется ни одно отношение доверия с проверяющей стороной. Если не указаны параметры RelyingPartyTrustIdentifier, ClaimsProviderTrustIdentifier, RelyingPartyTrustName и ClaimsProviderTrustName, сценарий экспортирует все отношения доверия с проверяющей стороной и отношения доверия с поставщиком утверждений.  
> 
>   **-ClaimsProviderTrustIdentifier <string[]>** — командлет экспортирует только те отношения доверия с поставщиком утверждений, идентификаторы которых указаны в массиве строк. Значение по умолчанию NONE, то есть не экспортируется ни одно отношение доверия с поставщиком утверждений.  
> 
>   **-RelyingPartyTrustName &lt;string[]&gt;** — командлет экспортирует только те отношения доверия с проверяющей стороной, имена которых указаны в массиве строк. Значение по умолчанию NONE, то есть не экспортируется ни одно отношение доверия с проверяющей стороной.  
> 
>   **-ClaimsProviderTrustName <string[]>** — командлет экспортирует только те отношения доверия с поставщиком утверждений, имена которых указаны в массиве строк. Значение по умолчанию NONE, то есть не экспортируется ни одно отношение доверия с поставщиком утверждений.  
> 
>   **-Path <строка \> ** — путь к папке, которая будет содержать экспортированные файлы.  
> 
>   **-ComputerName <строка \> ** — Указывает имя узла сервера STS. По умолчанию это локальный компьютер. При переносе AD FS 2.0 или AD FS в Windows Server 2012 на AD FS в Windows Server 2012 R2 здесь указывается имя компьютера, на котором установлен сервер AD FS прежних версий.  
> 
>   **-Credential <PSCredential \> ** — Указывает учетную запись пользователя, имеющую разрешение на выполнение этого действия. По умолчанию используется текущий пользователь.  
> 
>   **-Force** — запрещает вывод запросов на подтверждение для пользователя.  
> 
>   **-CertificatePassword <SecureString \> ** — Указывает пароль для экспорта закрытых ключей сертификатов AD FS. Если этот параметр не определен, то при необходимости экспортировать сертификат AD FS с закрытым ключом сценарий выведет запрос на ввод пароля.  
> 
>   **Inputs**: None  
> 
>   **Outputs**: string — командлет возвращает путь к папке экспорта. Возвращаемый объект можно передать методу Import-FederationConfiguration.  
  
###  <a name="to-back-up-custom-attribute-stores"></a>Создание резервных копий пользовательских хранилищ атрибутов  
  
1.  Необходимо вручную экспортировать все хранилища настраиваемых атрибутов, которые вы хотите сохранить в новой ферме AD FS в Windows Server 2012 R2.  
  
> [!NOTE]
>  В Windows Server 2012 R2 AD FS требуются пользовательские хранилища атрибутов, основанные на .NET Framework 4,0 или более поздней версии. Чтобы установить и настроить платформу .Net Framework 4.5, выполните инструкции на странице установки [Microsoft .NET Framework 4.5](https://www.microsoft.com/download/details.aspx?id=30653) .  
  
Дополнительные сведения об используемых службами AD FS пользовательских хранилищах атрибутов можно получить, выполнив следующую команду Windows PowerShell: 

``` powershell
Get-ADFSAttributeStore
```  

Действия по обновлению или переносу пользовательских хранилищ атрибутов могут быть разными.  
  
2. Также необходимо вручную экспортировать все DLL-файлы хранилищ настраиваемых атрибутов, которые необходимо сохранить в новой ферме AD FS в Windows Server 2012 R2. Действия по обновлению или переносу DLL-файлов пользовательских хранилищ атрибутов могут быть разными.  
  
##  <a name="create-a-windows-server-2012-r2-federation-server-farm"></a>Создание фермы сервера федерации Windows Server 2012 R2  
  
1.  Установите операционную систему Windows Server 2012 R2 на компьютер, который будет функционировать как сервер федерации, а затем добавьте роль сервера AD FS. Дополнительную информацию см. в статье об [установке службы роли AD FS](install-the-ad-fs-role-service.md). Затем настройте новую службу федерации при помощи мастера настройки служб федерации Active Directory или через Windows PowerShell. Дополнительную информацию см. в разделе, посвященном настройке первого сервера федерации в новой ферме серверов федерации в статье о [настройке сервера федерации](configure-a-federation-server.md).  

При выполнении этого шага необходимо следовать приведенным ниже указаниям:  
  
-   Для настройки службы федерации необходимо иметь привилегии администратора домена.  
  
-   Необходимо использовать то же имя службы федерации (имя фермы), которое использовалось в AD FS 2.0 или AD FS в Windows Server 2012. Если вы не используете одно и то же имя службы федерации, сертификаты, для которых была создана резервная копия, не будут работать в службе Федерации Windows Server 2012 R2, которую вы пытаетесь настроить.  
  
-   Определите, будет ли ферма серверов федерации базироваться на WID или SQL Server. Для SQL-фермы необходимо указать расположение базы данных SQL Server и имя экземпляра.  
  
-   Необходимо указать PFX-файл, содержащий SSL-сертификат проверки подлинности сервера, резервную копию которого вы сохранили при подготовке процесса миграции AD FS.  
  
-   Вы должны указать то же удостоверение учетной записи службы, которое использовалось в AD FS 2.0 или AD FS в ферме Windows Server 2012.  
  
2. После настройки первого узла можно добавить в новую ферму дополнительные узлы. Дополнительную информацию см. в разделе, посвященном добавлению сервера федерации в существующую ферму серверов федерации в статье о [настройке сервера федерации](configure-a-federation-server.md).  
  
##  <a name="import-the-original-configuration-data-into-the-windows-server-2012-r2-ad-fs-farm"></a>Импорт исходных данных конфигурации в ферму AD FS Windows Server 2012 R2  
 Теперь, когда у вас есть AD FS ферма серверов федерации под Windows Server 2012 R2, можно импортировать в нее исходные данные конфигурации AD FS.  
  
1.  Импортируйте и настройте другие пользовательские сертификаты служб федерации Active Directory, в том числе внешние сертификаты для подписания маркеров и сертификаты для шифрования или расшифровки маркеров, а также сертификат для связи со службой, если он не совпадает с SSL-сертификатом.  
  
В консоли управления AD FS выберите пункт **Сертификаты**. Проверьте сертификаты для связи со службой, для шифрования и расшифровки маркера и для подписи маркера путем сверки значений для каждого из них со значениями, экспортированными в файл certificates.txt при подготовке к миграции.  
  
Чтобы заменить самозаверяющие сертификаты для шифрования или для подписи маркера по умолчанию на внешние сертификаты, необходимо предварительно отключить функцию автоматического переключения сертификатов, которая по умолчанию включена. Для этого можно использовать следующую команду Windows PowerShell:  
  
``` powershell 
Set-ADFSProperties –AutoCertificateRollover $false  
```  
  
2. Настройте все пользовательские параметры служб AD FS, например AutoCertificateRollover или SSO lifetime, с помощью командлета Set-AdfsProperties.  
  
3. Чтобы AD FS импортировать отношения доверия с проверяющей стороной и отношения доверия поставщиков утверждений, необходимо войти в систему с учетной записью администратора (но не администратора домена) на сервер федерации и выполнить следующий сценарий Windows PowerShell, расположенный в папке \суппорт\адфс установочного компакт-диска Windows Server 2012 R2:  
  
``` powershell 
import-federationconfiguration.ps1  
```  
  
> [!IMPORTANT]
>  Этот сценарий импорта принимает следующие параметры:  
> 
> - Import-FederationConfiguration.ps1-Path <строка \> [-ComputerName <строка \> ] [-Credential <PSCredential \> ] [-Force] [-logPath <строка \> ] [-CertificatePassword <SecureString \> ]  
>   -   Import-FederationConfiguration.ps1-Path <строка \> [-ComputerName <строка \> ] [-Credential <PSCredential \> ] [-Force] [-logPath <строка \> ] [-CertificatePassword <SecureString \> ] [-релингпартитрустидентифиер <строка [] >] [-клаимспровидертрустидентифиер <String [] >  
>   -   Import-FederationConfiguration.ps1-Path <строка \> [-ComputerName <строка \> ] [-Credential <PSCredential \> ] [-Force] [-logPath <строка \> ] [-CertificatePassword <SecureString \> ] [-релингпартитрустнаме <String [] >] [-клаимспровидертрустнаме <строка [] >]  
> 
>   **-RelyingPartyTrustIdentifier <string[]>** — командлет импортирует только те отношения доверия с проверяющей стороной, идентификаторы которых указаны в массиве строк. Значение по умолчанию NONE, то есть не импортируется ни одно отношение доверия с проверяющей стороной. Если не указаны параметры RelyingPartyTrustIdentifier, ClaimsProviderTrustIdentifier, RelyingPartyTrustName и ClaimsProviderTrustName, сценарий импортирует все отношения доверия с проверяющей стороной и отношения доверия с поставщиком утверждений.  
> 
>   **-ClaimsProviderTrustIdentifier <string[]>** — командлет импортирует только те отношения доверия с поставщиком утверждений, идентификаторы которых указаны в массиве строк. Значение по умолчанию NONE, то есть не импортируется ни одно отношение доверия с поставщиком утверждений.  
> 
>   **-RelyingPartyTrustName &lt;string[]&gt;** — командлет импортирует только те отношения доверия с проверяющей стороной, имена которых указаны в массиве строк. Значение по умолчанию NONE, то есть не импортируется ни одно отношение доверия с проверяющей стороной.  
> 
>   **-ClaimsProviderTrustName <string[]>** — командлет импортирует только те отношения доверия с поставщиком утверждений, имена которых указаны в массиве строк. Значение по умолчанию NONE, то есть не импортируется ни одно отношение доверия с поставщиком утверждений.  
> 
>   **-Path <строка \> ** — путь к папке, содержащей импортируемые файлы конфигурации.  
> 
>   **-LogPath <строка \> ** — путь к папке, которая будет содержать файл журнала импорта. В этой папке будет создан файл с именем import.log.  
> 
>   **-ComputerName <строка \> ** — Указывает имя узла сервера STS. По умолчанию это локальный компьютер. При переносе AD FS 2.0 или AD FS в Windows Server 2012 на AD FS в Windows Server 2012 R2 этот параметр используется для указания имени узла, на котором установлен сервер AD FS прежних версий.  
> 
>   **-Credential <PSCredential \> ** — Указывает учетную запись пользователя, имеющую разрешение на выполнение этого действия. По умолчанию используется текущий пользователь.  
> 
>   **-Force** — запрещает вывод запросов на подтверждение для пользователя.  
> 
>   **-CertificatePassword <SecureString \> ** — Задает пароль для импорта закрытых ключей сертификатов AD FS. Если этот параметр не определен, то при необходимости импортировать сертификат AD FS с закрытым ключом сценарий выведет запрос на ввод пароля.  
> 
>   **Inputs:** string — эта команда принимает в качестве входного значения путь к папке импорта. Этой команде можно передать параметр Export-FederationConfiguration.  
> 
>   **Outputs:** None.  
  
Пробелы после строки свойства WSFedEndpoint отношения доверия с проверяющей стороной могут вызвать ошибку сценария импорта. В этом случае перед импортом вручную удалите пробелы из файла. Ошибки могут вызвать, к примеру, следующие записи:  
  
    ```  
    <URI N="WSFedEndpoint">https://127.0.0.1:444 /</URI>  
    ```  
  
    ```  
    <URI N="WSFedEndpoint">https://myapp.cloudapp.net:83 /</URI>  
    ```  
  
     They must be edited to:  
  
    ```  
    <URI N="WSFedEndpoint">https://127.0.0.1:444/</URI>  
    ```  
  
    ```  
    <URI N="WSFedEndpoint">https://myapp.cloudapp.net:83/</URI>  
    ```  
> [!IMPORTANT]
>  Если в отношении доверия с поставщиком утверждений в Active Directory исходной системы настроены какие-либо пользовательские правила для утверждений (которые отличаются от правил AD FS по умолчанию), они не будут перенесены данными сценариями. Это связано с тем, что в Windows Server 2012 R2 установлены новые значения по умолчанию. Все пользовательские правила должны быть объединены путем их ручного добавления в Active Directory отношения доверия поставщиков утверждений в новой ферме Windows Server 2012 R2.  
  
4. Настройте все пользовательские параметры конечных точек служб федерации Active Directory. В консоли управления AD FS выберите элемент **Конечные точки**. Проверьте задействованные конечные точки AD FS по списку задействованных конечных точек AD FS, который был экспортирован в файл в процессе подготовки к переносу AD FS.  
  
    \-Перетаскивани  
  
    Настройте все пользовательские описания утверждений. В консоли управления AD FS выберите элемент **Описания утверждений**. Сверьте список описаний утверждений AD FS со списком описаний утверждений, который был экспортирован в файл при подготовке к переносу AD FS. Добавьте все пользовательские описания утверждений, содержащиеся в вашем файле, но не включенные в список по умолчанию AD FS. Обратите внимание, что свойство утверждения Identifier на консоли управления соответствует свойству ClaimType в файле.  
  
5. Установите и настройте все сохраненные пользовательские хранилища атрибутов. От имени учетной записи администратора обновите все двоичные файлы пользовательских хранилищ атрибутов до версии платформы .NET Framework 4.0 или более поздней версии прежде, чем ссылаться на них в настройках AD FS.  
  
6. Настройте свойства служб, которые соответствуют параметрам в файле web.config прежних версий.  
  
   -   Если **усерелайстатефоридпинитиатедсигнон** был добавлен в файл **web.config** в AD FS 2,0 или AD FS в ферме Windows Server 2012, то необходимо настроить следующие свойства службы в AD FS в ферме Windows Server 2012 R2:  
  
       -   AD FS в Windows Server 2012 R2 включает файл **% systemroot% \ADFS\Microsoft.IdentityServer.Servicehost.exe.config** . Создайте элемент с тем же синтаксисом, что и элемент **web.config** file: `<useRelayStateForIdpInitiatedSignOn enabled="true" />` . Включите этот элемент в раздел **<Microsoft. identityserver. web>** файла **Microsoft.IdentityServer.Servicehost.exe.config** .  
  
   -   Если **<персистидентитипровидеринформатион Enabled = "true&#124;false" лифетимеиндайс = "90" енаблевхрперсистенце = "true&#124;false"/ \> ** было добавлено в файл **web.config** в AD FS 2,0 или AD FS в ферме Windows Server 2012, то необходимо настроить следующие свойства службы в AD FS в ферме Windows Server 2012 R2:  
  
       1.  В AD FS в Windows Server 2012 R2 выполните следующую команду Windows PowerShell: `Set-AdfsWebConfig –HRDCookieEnabled –HRDCookieLifetime` .  
  
   -   Если **<singleSignOn Enabled = "true&#124;false"/ \> ** был добавлен в файл **web.config** в AD FS 2,0 или AD FS в ферме Windows Server 2012, не нужно задавать какие-либо дополнительные свойства службы в AD FS в ферме Windows Server 2012 R2. Единый вход включен по умолчанию в AD FS в ферме Windows Server 2012 R2.  
  
   -   Если параметры Локалаусентикатионтипес были добавлены в файл **web.config** в AD FS 2,0 или AD FS в ферме windows Server 2012, то необходимо настроить следующие свойства службы в AD FS в ферме windows Server 2012 R2:  
  
       -   Интегрированные, Forms, Тлсклиент, базовый список преобразований в эквивалентные AD FS в Windows Server 2012 R2 имеют глобальные параметры политики проверки подлинности для поддержки типов проверки подлинности службы федерации и прокси-сервера. Эти параметры можно настроить в AD FS в оснастке "Управление" в разделе **Политики проверки подлинности**.  
  
   После импорта исходных данных конфигурации при необходимости можно настроить страницы входа AD FS. Дополнительные сведения см. в статье о [настройке страниц входа AD FS](../operations/ad-fs-customization-in-windows-server.md).  
  
## <a name="next-steps"></a>Дальнейшие шаги
 [Миграция служб ролей службы федерации Active Directory (AD FS) на Windows Server 2012 R2](migrate-ad-fs-service-role-to-windows-server-r2.md)   
 [Подготовка к миграции сервера федерации AD FS](prepare-migrate-ad-fs-server-r2.md)   
 [Перенос прокси-сервера AD FS Федерации](migrate-fed-server-proxy-r2.md)   
 [Проверка переноса AD FS на Windows Server 2012 R2](verify-ad-fs-migration.md)
