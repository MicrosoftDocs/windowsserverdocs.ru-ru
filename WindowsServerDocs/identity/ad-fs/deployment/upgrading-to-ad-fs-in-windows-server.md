---
ms.assetid: 7671e0c9-faf0-40de-808a-62f54645f891
title: Обновление до AD FS в Windows Server 2016
author: billmath
manager: femila
ms.date: 04/09/2018
ms.topic: article
ms.author: billmath
ms.openlocfilehash: 683a9ce88c9809dfecf5669b41758187504634b9
ms.sourcegitcommit: 3181fcb69a368f38e0d66002e8bc6fd9628b1acc
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/30/2020
ms.locfileid: "96330516"
---
# <a name="upgrading-to-ad-fs-in-windows-server-2016-using-a-wid-database"></a>Обновление до AD FS в Windows Server 2016 с помощью базы данных WID


> [!NOTE]
> Начать обновление только с определенного времени, запланированного на завершение. Не рекомендуется держать AD FS в смешанном режиме в течение продолжительного периода времени, так как сохранение AD FS в смешанном режиме может вызвать проблемы с фермой.

## <a name="upgrading-a-windows-server-2012-r2-or-2016-ad-fs-farm-to-windows-server-2019"></a>Обновление фермы AD FS Windows Server 2012 R2 или 2016 до Windows Server 2019
В следующем документе описано, как обновить ферму AD FS до AD FS в Windows Server 2019 при использовании базы данных WID.

### <a name="ad-fs-farm-behavior-levels-fbl"></a>Уровни поведения AD FS фермы (ФБЛ)
В AD FS для Windows Server 2016 был введен уровень поведения фермы (ФБЛ). Это параметр на уровне фермы, определяющий функции, которые может использовать ферма AD FS.

В следующей таблице перечислены значения ФБЛ по версии Windows Server:

| Версия Windows Server  | фбл | Имя базы данных конфигурации AD FS |
| ------------- | ------------- | ------------- |
| 2012 R2  | 1  | адфсконфигуратион |
| 2016  | 3  | AdfsConfigurationV3 |
| 2019  | 4  | AdfsConfigurationV4 |

> [!NOTE]
> При обновлении ФБЛ создается новая база данных конфигурации AD FS.  В таблице выше приведены имена баз данных конфигурации для каждой версии AD FS Windows Server и значения ФБЛ.

### <a name="new-vs-upgraded-farms"></a>Новые и обновленные фермы VS
По умолчанию ФБЛ в новой ферме AD FS соответствует значению для версии Windows Server первого установленного узла фермы.

AD FS сервер более поздней версии можно присоединить к ферме AD FS 2012 R2 или 2016, и ферма будет работать в том же ФБЛ, что и существующие узлы. При наличии нескольких версий Windows Server, работающих в одной ферме со значением ФБЛ самой низкой версии, ферма называется "смешанной". Однако вы не сможете использовать возможности более поздних версий, пока не будет вызвана ФБЛ. С помощью смешанной фермы:

- Администраторы могут добавлять новые серверы федерации Windows Server 2019 в существующую ферму Windows Server 2012 R2 или 2016. В результате ферма находится в смешанном режиме и работает на том же уровне поведения фермы, что и исходная ферма. Чтобы обеспечить согласованное поведение в ферме, нельзя настроить или использовать функции более новых версий Windows Server AD FS.

- Прежде чем можно будет возникать ФБЛ, администраторы должны удалить AD FS узлы предыдущих версий Windows Server из фермы.  Обратите внимание, что в случае фермы WID необходимо, чтобы один из новых серверов федерации Windows Server 2019 был повышен до роли основного узла в ферме.

- После того как все серверы федерации в ферме имеют одну и ту же версию Windows Server, может возникнуть ФБЛ.  В результате все новые AD FS Windows Server 2019 могут быть настроены и использованы.

Учтите, что в режиме смешанной фермы AD FS ферма не поддерживает новые функции и функции, появившиеся в AD FS в Windows Server 2019. Это означает, что Организации, желающие испытать новые функции, не смогут сделать это до тех пор, пока не будет вызвано ФБЛ. Поэтому, если ваша организация планирует протестировать новые функции до создания ФБЛ, для этого потребуется развернуть отдельную ферму.

В оставшейся части документа содержатся инструкции по добавлению сервера федерации Windows Server 2019 в среду Windows Server 2016 или 2012 R2 и последующему порождению ФБЛ в Windows Server 2019. Эти шаги были выполнены в тестовой среде, описанной в схеме архитектуры ниже.

> [!NOTE]
> Прежде чем перейти к AD FS в Windows Server 2019 ФБЛ, необходимо удалить все узлы Windows Server 2016 или 2012 R2. Нельзя просто обновить операционную систему Windows Server 2016 или 2012 R2 до Windows Server 2019 и стать узлом 2019. Его необходимо будет удалить и заменить новым узлом 2019.

> [!NOTE]
> Если Алвайсонаваилабилити группы или репликация слиянием настроены в AD FS, удалите все репликации баз данных ADFS перед обновлением и укажите для всех узлов основную базу данных SQL. После выполнения этой операции Обновите ферму, как описано в статье. После обновления добавьте в новые базы данных Алвайсонаваилабилити группы или репликацию слиянием.

##### <a name="to-upgrade-your-ad-fs-farm-to-windows-server-2019-farm-behavior-level"></a>Обновление AD FS фермы до уровня поведения фермы Windows Server 2019

1. С помощью диспетчер сервера установите роль службы федерации Active Directory (AD FS) на Windows Server 2019.

2. С помощью мастера настройки AD FS присоедините новый сервер Windows Server 2019 к существующей ферме AD FS.

![обновление](media/Upgrading-to-AD-FS-in-Windows-Server-2016/ADFS_Mixed_1.png)

3. На сервере федерации Windows Server 2019 откройте управление AD FS. Обратите внимание, что возможности управления недоступны, так как этот сервер федерации не является сервером-источником.

![обновление](media/Upgrading-to-AD-FS-in-Windows-Server-2016/ADFS_Mixed_3.png)

4. На сервере Windows Server 2019 Откройте командное окно PowerShell с повышенными привилегиями и выполните следующий командлет:

```PowerShell
Set-AdfsSyncProperties -Role PrimaryComputer
```

![обновление](media/Upgrading-to-AD-FS-in-Windows-Server-2016/ADFS_Mixed_4.png)

5. На AD FS сервере, который ранее был настроен как основной, откройте окно командной строки PowerShell с повышенными привилегиями и выполните следующий командлет:

```PowerShell
Set-AdfsSyncProperties -Role SecondaryComputer -PrimaryComputerName {FQDN}
```

![обновление](media/Upgrading-to-AD-FS-in-Windows-Server-2016/ADFS_Mixed_5.png)

6. Теперь на сервере федерации Windows Server 2016 откройте управление AD FS. Обратите внимание, что теперь все возможности администратора отображаются, так как основная роль была перенесена на этот сервер.

![обновление](media/Upgrading-to-AD-FS-in-Windows-Server-2016/ADFS_Mixed_6.png)

7. Если вы обновляете ферму AD FS 2012 R2 до 2016 или 2019, то для обновления фермы требуется, чтобы схема AD была не меньше уровня 85.  Чтобы обновить схему с установочного носителя Windows Server 2016, откройте командную строку и перейдите в каталог суппорт\адпреп. Выполните следующую команду:  `adprep /forestprep`

![обновление](media/Upgrading-to-AD-FS-in-Windows-Server-2016/ADFS_Mixed_7.png)

После завершения выполнения `adprep /domainprep`

> [!NOTE]
> Перед выполнением следующего шага убедитесь, что Windows Server является текущим, запустив Центр обновления Windows из параметров. Продолжайте этот процесс, пока не перестанут требоваться обновления.

![обновление](media/Upgrading-to-AD-FS-in-Windows-Server-2016/ADFS_Mixed_8.png)

8. Теперь на сервере Windows Server 2016 откройте PowerShell и выполните следующий командлет:


> [!NOTE]
> Перед выполнением следующего шага необходимо удалить все серверы 2012 R2 из фермы.

```PowerShell
Invoke-AdfsFarmBehaviorLevelRaise
```

![обновление](media/Upgrading-to-AD-FS-in-Windows-Server-2016/ADFS_Mixed_9.png)

9. При появлении запроса введите Y. Это начнет повышать уровень. После завершения этого процесса вы успешно вызвали ФБЛ.

![обновление](media/Upgrading-to-AD-FS-in-Windows-Server-2016/ADFS_Mixed_10.png)

10. Теперь, если вы переходите к AD FS управления, вы увидите, что добавлены новые возможности для более поздней версии AD FS

![обновление](media/Upgrading-to-AD-FS-in-Windows-Server-2016/ADFS_Mixed_12.png)

11. Аналогичным образом можно использовать командлет PowerShell:  `Get-AdfsFarmInformation` для отображения текущего ФБЛ.

![обновление](media/Upgrading-to-AD-FS-in-Windows-Server-2016/ADFS_Mixed_13.png)

12. Чтобы обновить серверы WAP до последнего уровня, на каждом прокси-сервере необходимо повторно настроить WAP, выполнив следующий командлет PowerShell в окне с повышенными привилегиями:

```PowerShell
$trustcred = Get-Credential -Message "Enter Domain Administrator credentials"
Install-WebApplicationProxy -CertificateThumbprint {SSLCert} -fsname fsname -FederationServiceTrustCredential $trustcred
```

Удалите старые серверы из кластера и обеспечьте только серверы WAP, на которых работает последняя версия сервера, которая была перенастроена ранее, выполнив следующий командлет PowerShell.

```PowerShell
Set-WebApplicationProxyConfiguration -ConnectedServersName WAPServerName1, WAPServerName2
```

Проверьте конфигурацию WAP, выполнив командлет Get-WebApplicationProxyConfiguration. Коннектедсерверснаме будет отражать запуск сервера из предыдущей команды.

```PowerShell
Get-WebApplicationProxyConfiguration
```
> [!NOTE]
> Пропустите следующий шаг, если Конфигуратионверсион — Windows Server 2016. Это правильное значение для прокси веб-приложения на Windows Server 2016/2019.

Чтобы обновить Конфигуратионверсион серверов WAP, выполните следующую команду PowerShell.

```PowerShell
Set-WebApplicationProxyConfiguration -UpgradeConfigurationVersion
```

Это приведет к завершению обновления серверов WAP.


> [!NOTE]
> В AD FS 2019 существует известная ошибка PRT, если выполняется Windows Hello для бизнеса с гибридным доверием сертификатов. Эта ошибка может возникать в журналах событий администратора ADFS: Received invalid Oauth request. The client 'NAME' is forbidden to access the resource with scope 'ugs'. (Получен недопустимый запрос OAuth. Клиенту с именем NAME запрещено обращаться к ресурсу с областью ugs.)
> Чтобы исправить эту ошибку, сделайте следующее:
> 1. Запустите консоль управления AD FS. Щелкните "Службы" > "Описания областей"
> 2. Щелкните правой кнопкой мыши "Описания областей" и выберите "Добавить описание области".
> 3. В поле "Имя" введите ugs и щелкните "Применить" > "ОК2".
> 4. Запустите PowerShell от имени администратора.
> 5. Выполните команду Get-AdfsApplicationPermission. Найдите запись ScopeNames :{openid, aza} с ClientRoleIdentifier. Запишите значение ObjectIdentifier.
> 6. Выполните команду Set-AdfsApplicationPermission -TargetIdentifier <идентификатор объекта, полученный на шаге 5> -AddScope 'ugs'.
> 7. Перезапустите службу ADFS.
> 8. На компьютере клиента сделайте следующее: Перезапустите клиент. Пользователю должно быть предложено подготовить WHFB.
> 9. Если окно подготовки не появляется, необходимо получить журналы трассировки NGC и устранить неполадки.
