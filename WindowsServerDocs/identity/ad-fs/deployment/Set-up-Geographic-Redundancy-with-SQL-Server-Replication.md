---
title: Настройка географической избыточности с помощью Репликация SQL Server
description: ''
author: billmath
manager: femila
ms.date: 05/31/2017
ms.topic: article
ms.prod: windows-server
ms.technology: active-directory-federation-services
ms.author: billmath
ms.assetId: 7b9f9a4f-888c-4358-bacd-3237661b1935
ms.openlocfilehash: 16cf1a237043aa546d4fc24164045aa9f9a1e6ac
ms.sourcegitcommit: 6aff3d88ff22ea141a6ea6572a5ad8dd6321f199
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/27/2019
ms.locfileid: "71359818"
---
# <a name="setup-geographic-redundancy-with-sql-server-replication"></a>Настройка географической избыточности с помощью Репликация SQL Server


> [!IMPORTANT]  
> Если вы хотите создать ферму AD FS и использовать SQL Server для хранения данных конфигурации, можно использовать SQL Server 2008 или более поздней версии.
  
При использовании SQL Server в качестве базы данных конфигурации AD FS можно настроить географию @ no__t-0redundancy для фермы AD FS с помощью SQL Server репликации. Geo @ no__t-0redundancy реплицирует данные между двумя географически отдаленными сайтами, чтобы приложения могли переключаться с одного сайта на другой. Таким образом, в случае сбоя одного сайта все данные конфигурации можно будет получить на втором сайте. Дополнительные сведения см. в разделе "SQL Server географическая избыточность" в [ферме серверов федерации с помощью SQL Server](../design/Federation-Server-Farm-Using-SQL-Server.md).  
  
## <a name="prerequisites"></a>Предварительные требования  
Установите и настройте ферму SQL Server. Дополнительные сведения см. в [https://technet.microsoft.com/evalcenter/hh225126.aspx](https://technet.microsoft.com/evalcenter/hh225126.aspx)разделе. На начальном SQL Server убедитесь, что служба агент SQL Server запущена и настроена на автоматический запуск.  
  
## <a name="create-the-second-replica-sql-server-for-geo-redundancy"></a>Создайте второй SQL Server \(replica @ no__t-1 для Geo @ no__t-2redundancy  
  
1. Установка SQL Server \(for дополнительные сведения см. в разделе [https://technet.microsoft.com/evalcenter/hh225126.aspx](https://technet.microsoft.com/evalcenter/hh225126.aspx). Скопируйте полученные файлы скриптов CreateDB. SQL и SetPermissions. SQL на реплику SQL Server.  
  
2. Убедитесь, что служба агент SQL Server запущена и настроена на автоматический запуск.  
  
3. Выполните **Export @ no__t-1AdfsDeploymentSQLScript** на основном узле AD FS, чтобы создать файлы CreateDB. SQL и SetPermissions. SQL.  Например: `PS:\>Export-AdfsDeploymentSQLScript -DestinationFolder . –ServiceAccountName CONTOSO\gmsa1$`.  
   @no__t 0Set географическая избыточность @ no__t-1
  
4. Скопируйте сценарии на сервер-получатель.  Откройте скрипт CreateDB. SQL в **Management Studio SQL** и нажмите кнопку **выполнить**.
   @no__t 0Set географическая избыточность @ no__t-1

5. Откройте скрипт SetPermissions. SQL в **Management Studio SQL** и нажмите кнопку **выполнить**.
   @no__t 0Set географическая избыточность @ no__t-1 

   

> [!NOTE]
> Кроме того, можно использовать следующую команду из командной строки. 
> 
>    `c:\>sqlcmd –i CreateDB.sql`  
> 
>    `c:\>sqlcmd –i SetPermissions.sql` 
> 
> ## <a name="create-publisher-settings-on-the-initial-sql-server"></a>Создание параметров издателя на начальном SQL Server  
  
1. В SQL Server Management Studio в разделе **репликация**щелкните правой кнопкой мыши элемент **Локальные публикации** и выберите команду **создать публикацию...** 
    @ no__t-4Set up географическая избыточность @ no__t-5 </br>  

2. На экране мастера создания публикаций нажмите кнопку **Далее**.</br>
   @no__t 0Set географическая избыточность @ no__t-1 </br> 
  
3. На странице **распространителя** выберите локальный сервер в качестве распространителя и нажмите кнопку **Далее**.  
   @no__t 0Set географическая избыточность @ no__t-1 </br>   

4. На странице Папка **моментальных снимков** введите \\ \ SQL1\repldata вместо папки по умолчанию. \(Примечание. Может потребоваться создать этот общий ресурс самостоятельно @ no__t-0.  
   @no__t 0Set географическая избыточность @ no__t-1 </br>   
  
5. Выберите **AdfsConfigurationV3** в качестве базы данных публикации и нажмите кнопку **Далее**.  
   @no__t 0Set географическая избыточность @ no__t-1 </br>
  
6. В меню **Тип публикации**выберите пункт **Публикация слиянием** и нажмите кнопку **Далее**.  
   @no__t 0Set географическая избыточность @ no__t-1 </br>
  
7. На **типах подписчиков**выберите **SQL Server 2008 или более поздней версии** и нажмите кнопку **Далее**.  
   @no__t 0Set географическая избыточность @ no__t-1 </br> 

8. На странице **статьи** выберите узел **таблицы** , чтобы выбрать все таблицы, а затем снимите **@ no__t-3check синкпропертиес** Table \(this одну не следует реплицировать @ no__t-5.</br>
   @no__t 0Set географическая избыточность @ no__t-1 </br>    
  
9. На странице **статьи** выберите элемент **определяемые пользователем функции** узел, чтобы выбрать все определяемые пользователем функции, и нажмите кнопку **Далее**.  
   @no__t 0Set географическая избыточность @ no__t-1 </br>    

10. На странице **проблемы с статьей** нажмите кнопку **Далее**.  
    @no__t 0Set географическая избыточность @ no__t-1 </br>   

11. На странице **Фильтрация строк таблицы** нажмите кнопку **Далее**.  
    @no__t 0Set географическая избыточность @ no__t-1 </br>   
12. На странице **Агент моментальных снимков** выберите значения по умолчанию немедленно и 14 дней, нажмите кнопку **Далее**.  
    @no__t 0Set географическая избыточность @ no__t-1 </br>   
    Возможно, потребуется создать учетную запись домена для агента SQL Server. Выполните действия, описанные в разделе [Настройка имени входа SQL для учетной записи домена Contoso @ no__t-1sqlagent](Set-up-Geographic-Redundancy-with-SQL-Server-Replication.md#sqlagent) , чтобы создать имя входа SQL для этого нового пользователя AD и назначить определенные разрешения.  
  
13. На странице **Безопасность агента** щелкните **настройки безопасности** и введите имя_пользователя @ no__t-2password учетной записи домена \(not a GMSA @ no__t-4, СОЗДАННОЙ для агента SQL Server, и нажмите кнопку **ОК**.  Нажмите кнопку **Далее**.  
    @no__t 0Set географическая избыточность @ no__t-1 </br>  

14. На странице **действия мастера** нажмите кнопку **Далее**.   
    @no__t 0Set географическая избыточность @ no__t-1 </br>

15. На странице **Завершение работы мастера** введите имя публикации и нажмите кнопку **Готово**. 
    @no__t 0Set географическая избыточность @ no__t-1 </br>  

16. После создания публикации вы увидите состояние Success (успешно).  Нажмите кнопку **Закрыть**.
    @no__t 0Set географическая избыточность @ no__t-1 </br>  

17. Вернитесь в SQL Server Management Studio, щелкните новую публикацию правой кнопкой мыши и выберите пункт **запустить монитор репликации**.  
    @no__t 0Set географическая избыточность @ no__t-1 </br> 
  
## <a name="create-subscription-settings-on-the-replica-sql-server"></a>Создание параметров подписки на реплике SQL Server  
Убедитесь, что параметры издателя созданы на начальном SQL Server, как описано выше, а затем выполните следующую процедуру.  
  
1. В SQL Server реплики в SQL Server Management Studio в разделе **репликация**щелкните правой кнопкой мыши элемент **Локальные подписки** и выберите **создать подписку...** . @no__t 0Set географическая избыточность @ no__t-1 </br>  

2. На странице **Мастер создания подписки** нажмите кнопку **Далее**.
   @no__t 0Set географическая избыточность @ no__t-1 </br>   
  
3. На странице **Публикация** выберите издателя из раскрывающегося списка.  Разверните узел **AdfsConfigurationV3** и выберите имя созданной ранее публикации и нажмите кнопку **Далее**.  
   @no__t 0Set географическая избыточность @ no__t-1 </br> 
  
4. На странице **расположение агент слияния** выберите **выполнять каждый агент на своем подписчике \(pull Subscriptions @ no__t-3** \(The Default @ no__t-5 и нажмите кнопку **Далее**.  
   @no__t 0Set географическая избыточность @ no__t-1 </br> Это, наряду с типом подписки ниже, определяет логику разрешения конфликтов. @no__t 0For дополнительные сведения см. в разделе [Обнаружение и разрешение конфликтов репликации слиянием](https://technet.microsoft.com/library/ms151191.aspx). </br>
 
5. На странице **Подписчики** выберите **AdfsConfigurationV3** в качестве базы данных подписчика и нажмите кнопку **Далее**.  
   @no__t 0Set географическая избыточность @ no__t-1 </br> 
  
6. На странице **безопасность агент слияния** щелкните.. **.** и введите имя пользователя и пароль учетной записи домена \(not a GMSA @ no__t-3, СОЗДАННОЙ для агента SQL Server, с помощью поля с многоточием и нажмите кнопку **Далее**.
   @no__t 0Set географическая избыточность @ no__t-1 </br> 
  
7. В **расписанию синхронизации**выберите **выполнять непрерывно** и нажмите кнопку **Далее**. 
   @no__t 0Set географическая избыточность @ no__t-1 </br> 
 
8. В меню **инициализация подписок**нажмите кнопку **Далее**.  
   @no__t 0Set географическая избыточность @ no__t-1 </br> 
  
9. В качестве **типа подписки**выберите **клиент** и нажмите кнопку **Далее**.  
  
   Последствия этого описаны [здесь](https://technet.microsoft.com/library/ms151191.aspx) и [здесь](https://technet.microsoft.com/library/ms151170.aspx).  По сути, мы принимаем простое разрешение конфликтов "первым и издателем", и нам не нужно повторно публиковать его на других подписчиках.  
   @no__t 0Set географическая избыточность @ no__t-1 </br>
   
10. На странице **действия мастера** убедитесь, что установлен флажок **создать подписку** , и нажмите кнопку **Далее**. 
    @no__t 0Set географическая избыточность @ no__t-1 </br>

11. На странице **Завершение работы мастера** нажмите кнопку **Готово**. 
    @no__t 0Set географическая избыточность @ no__t-1 </br>

12. После завершения процесса создания подписки вы увидите сообщение success (успешно). Нажмите кнопку **Закрыть**. 
    @no__t 0Set географическая избыточность @ no__t-1 </br>
  
## <a name="verify-the-process-of-initialization-and-replication"></a>Проверка процесса инициализации и репликации  
  
1.  На основном сервере SQL Server щелкните правой кнопкой мыши @ no__t-0click узел **репликации** и выберите пункт **запустить монитор репликации**.  
  
2.  В **мониторе репликации**щелкните публикацию.  
  
3.  На вкладке **все подписки** щелкните правой кнопкой мыши и **Просмотрите сведения**.  
  
    Вы увидите множество записей в разделе **действия** для начальной репликации.  
  
4.  Кроме того, можно просмотреть узел **Агент SQL Server @ no__t-1Jobs** , чтобы увидеть, что задание @ no__t-2S @ no__t-3 запланировано для выполнения операций публикации @ no__t-4subscription.  Отображаются только локальные задания, поэтому не забудьте проверить издателя и подписчика на устранение неполадок.  Right @ no__t-0click задание и выберите **Просмотр журнала** , чтобы просмотреть журнал выполнения и результаты.  
  
## <a name="sqlagent"></a>Настройка имени входа SQL для учетной записи домена CONTOSO @ no__t-1sqlagent  
  
1.  Создайте новое имя входа на первичной и репликовой SQL Server с именем CONTOSO @ no__t-0sqlagent \(the имя нового пользователя домена, созданного и настроенного на странице **Безопасность агента** в процедурах выше. \)  
  
2.  В SQL Server щелкните правой кнопкой мыши @ no__t-0click созданное имя входа и выберите свойства, затем на вкладке **Сопоставление пользователей** сопоставьте это имя входа с базами данных **адфсконфигуратион** и **адфсартифакт** с ролями Public и DB @ no__t-4genevaservice. Также сопоставьте это имя входа с базой данных распространителя и добавьте роль DB @ no__t-0owner для таблиц распространения и адфсконфигуратион.  Это необходимо сделать как для основного, так и для реплики SQL Server. Дополнительные сведения см. в разделе [модель безопасности агента репликации](https://technet.microsoft.com/library/ms151868.aspx).  
  
3.  Предоставьте соответствующей учетной записи домена разрешения на чтение и запись для общей папки, настроенной как распространитель.  Убедитесь, что разрешения на чтение и запись заданы как для разрешений общего ресурса, так и для разрешений локального файла.  
  
## <a name="configure-ad-fs-nodes-to-point-to-the-sql-server-replica-farm"></a>Настройте AD FS node @ no__t-0/no__t-1, чтобы указать на ферму SQL Server реплики.  
Теперь, когда геоизбыточность настроена, узлы AD FS фермы можно настроить так, чтобы они указывали на реплику SQL Server фермы с помощью стандартных возможностей фермы AD FS "присоединения" в пользовательском интерфейсе мастера настройки AD FS или с помощью Windows PowerShell.  
  
При использовании пользовательского интерфейса мастера настройки AD FS выберите **Добавить сервер федерации в ферму серверов федерации**. **Не** выбирайте параметр **создать первый сервер федерации в ферме серверов федерации**.  
  
Если вы используете Windows PowerShell, выполните команду **Add @ no__t-1AdfsFarmNode**. **Не** Запускайте команду **Install @ no__t-2AdfsFarm**.  
  
При появлении запроса укажите узел и имя экземпляра SQL Server реплики, а **не** исходного SQL Server.  
