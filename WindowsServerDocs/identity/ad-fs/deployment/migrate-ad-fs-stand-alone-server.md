---
title: Миграция изолированного сервера федерации AD FS или фермы AD FS с одним узлом
description: Содержит сведения о переносе отдельного сервера AD FS 2,0 с одним узлом на Windows Server 2012
author: billmath
ms.author: billmath
manager: femila
ms.date: 06/28/2017
ms.topic: article
ms.openlocfilehash: 30156083f33b79ec35a4fa62b24064cb7b1202a7
ms.sourcegitcommit: dfa48f77b751dbc34409aced628eb2f17c912f08
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/07/2020
ms.locfileid: "87962768"
---
# <a name="migrate-a-stand-alone-ad-fs-federation-server-or-a-single-node-ad-fs-farm"></a>Миграция изолированного сервера федерации AD FS или фермы AD FS с одним узлом
В этом документе содержатся подробные сведения о переносе изолированного сервера AD FS 2,0 на Windows Server 2012.

## <a name="migrate-a-stand-alone-ad-fs-20-server"></a>Перенос изолированного сервера AD FS 2,0

Используйте следующую процедуру, чтобы перенести сервер AD FS 2,0 в Windows Server 2012.

1.  Проверьте и выполните процедуры, описанные в [Подготовности к миграции изолированного AD FS сервера федерации или AD FS фермы с одним узлом](prepare-to-migrate-a-stand-alone-ad-fs-federation-server.md).

2.  Выполните обновление на месте операционной системы на сервере с Windows Server 2008 R2 или Windows Server 2008 до Windows Server 2012. Дополнительные сведения см. в разделе [Установка Windows Server 2012](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/jj134246(v=ws.11)).

> [!IMPORTANT]
>  В результате обновления ОС конфигурация AD FS на этом сервере была утрачена, а роль сервера AD FS 2.0 — удалена. Вместо этого устанавливается роль сервера AD FS Windows Server 2012, но она не настроена. Необходимо вручную создать исходную конфигурацию AD FS и восстановить остальные параметры AD FS, чтобы завершить миграцию сервера федерации.

3. Создайте исходную конфигурацию AD FS. Создать исходную конфигурацию AD FS можно с использованием следующих методов.

-   Используйте **Мастер настройки сервера федерации AD FS** , чтобы создать новый сервер федерации. Дополнительные сведения см. в разделе [Создание первого сервера федерации на ферме серверов федерации](Create-the-First-Federation-Server-in-a-Federation-Server-Farm.md).

Выполняя действия в мастере, используйте информацию, полученную в ходе подготовки к миграции сервера федерации AD FS, следующим образом.

 |**Вводный параметр мастера конфигурации сервера федерации**|**Используйте следующее значение**|
|-----|-----|
|**SSL-сертификат** на странице **Указание имени службы федерации**|Выберите SSL-сертификат, имя субъекта и отпечаток которого были записаны в ходе подготовки к миграции сервера федерации AD FS.|
|**Учетная запись службы** и **Пароль** на странице **Указание учетной записи службы**|Введите сведения об учетной записи службы, записанные в ходе подготовки к миграции сервера федерации AD FS. **Примечание.**  Если на второй странице мастера выбран вариант автономный сервер федерации, то СЕТЕВая служба автоматически используется в качестве учетной записи службы.|

> [!IMPORTANT]
> Этот метод можно использовать, только если база данных конфигурации AD FS для изолированного сервера федерации или фермы AD FS с одним узлом хранится во внутренней базе данных Windows.
>
>  При использовании SQL Server для хранения базы данных конфигурации AD FS для фермы AD FS с одним узлом необходимо использовать для создания исходной конфигурации AD FS на сервере федерации Windows PowerShell

-   Использование Windows PowerShell

> [!IMPORTANT]
>  При использовании SQL Server для хранения базы данных конфигурации AD FS для изолированного сервера федерации или фермы AD FS с одним узлом следует выбрать Windows PowerShell.

Ниже приводится пример использования Windows PowerShell для создания исходной конфигурации AD FS на сервере федерации в ферме SQL Server с одним узлом.  Откройте модуль Windows PowerShell и выполните следующую команду: `$fscredential = Get-Credential` . Введите имя и пароль учетной записи службы, записанные в ходе подготовки фермы серверов SQL к миграции. Затем выполните следующую команду: `C:\PS> Add-AdfsFarmNode -ServiceAccountCredential $fscredential -SQLConnectionString "Data Source=<Data Source>;Integrated Security=True"` где `Data Source` — значение источника данных в строке подключения к хранилищу политик в следующем файле: `%programfiles%\Active Directory Federation Services 2.0\Microsoft.IdentityServer.Servicehost.exe.config` .

4. Восстановите остальные параметры службы AD FS и отношения доверия. Этот шаг выполняется вручную и позволяет использовать экспортированные файлы и собранные значения при подготовке к миграции AD FS. Подробные инструкции см. в разделе "Восстановление остальной конфигурации фермы AD FS".

> [!NOTE]
>  Этот шаг необходим только при миграции изолированного сервера федерации или фермы внутренней базы данных Windows с одним узлом.  Если сервер федерации использует базу данных SQL Server в качестве хранилища конфигурации, параметры службы и отношения доверия сохраняются в базе данных.

5. Обновите веб-страницы AD FS. Этот шаг выполняется вручную. Если при подготовке к миграции была создана резервная копия настроенных AD FS веб-страниц, используйте данные резервного копирования, чтобы перезаписать AD FS веб-страницы по умолчанию, которые были созданы по умолчанию в каталоге **%системдриве%\инетпуб\адфс\лс** в результате настройки AD FS в Windows Server 2012.

6. Восстановите остальные пользовательские настройки AD FS, например хранилища настраиваемых атрибутов.

## <a name="restoring-the-remaining-ad-fs-farm-configuration"></a>Восстановление остальной конфигурации фермы AD FS

-   Восстановите следующие параметры службы AD FS, создав ферму внутренней базы данных Windows с одним узлом или изолированную службу федерации следующим образом:

    -   На консоли управления AD FS выберите **Служба** и щелкните **Изменить службу федерации…** Проверьте параметры службы федерации, сопоставляя каждое значение со значениями, экспортированными в файл properties.txt при подготовке к миграции.


|**Имя свойства службы федерации, возвращенное командой Get-ADFSProperties**|**служба федерации имя свойства в консоли управления AD FS**|
|-----|-----|
|DisplayName|Отображаемое имя службы федерации|
|HostName|Имя службы федерации|
|Идентификатор|Идентификатор службы федерации|

-   В консоли управления AD FS выберите пункт **Сертификаты**. Проверьте сертификаты взаимодействия служб, расшифровки и подписи токенов, сопоставляя каждое значение со значениями, экспортированными в файл certificates.txt при подготовке к миграции.

Чтобы заменить самозаверяющие сертификаты для шифрования или для подписи маркера по умолчанию на внешние сертификаты, необходимо предварительно отключить функцию автоматического переключения сертификатов, которая по умолчанию включена.  Для этого можно использовать следующую команду Windows PowerShell: `PSH: Set-ADFSProperties –AutoCertificateRollover $false` .

-   В консоли управления AD FS выберите элемент **Конечные точки**. Проверьте задействованные конечные точки AD FS по списку задействованных конечных точек AD FS, который был экспортирован в файл в процессе подготовки к переносу AD FS.

-   В консоли управления AD FS выберите элемент **Описания утверждений**. Сверьте список описаний утверждений AD FS со списком описаний утверждений, который был экспортирован в файл при подготовке к переносу AD FS. Добавьте все пользовательские описания утверждений, содержащиеся в вашем файле, но не включенные в список по умолчанию AD FS.  Обратите внимание, что свойство утверждения Identifier на консоли управления соответствует свойству ClaimType в файле.  Дополнительные сведения о добавлении описаний утверждений см. в разделе [Добавление описания утверждения](../operations/add-a-claim-description.md). Дополнительные сведения см. в разделе "Шаг 1. Экспорт параметров службы" статьи "Подготовка к миграции сервера федерации AD FS 2.0".

-   На консоли управления AD FS выберите **Отношения доверия поставщика утверждений**. Необходимо вручную воссоздать каждое отношение доверия с поставщиком утверждений, используя **мастер добавления отношений доверия с поставщиком утверждений**.  Воспользуйтесь списком отношений доверия с поставщиками утверждений, экспортированным и записанным при подготовке к миграции AD FS. Можно игнорировать отношения доверия с поставщиком утверждений с идентификатором AD AUTHORITY в этом файле, поскольку это отношение доверия с поставщиком утверждений Active Directory, которое является частью конфигурации AD FS по умолчанию.  Тем не менее проверьте все правила настраиваемых утверждений, которые, возможно, были добавлены в отношения доверия Active Directory до миграции. Дополнительные сведения о создании отношений доверия с поставщиком утверждений см. в разделе [Создание отношений доверия с поставщиком утверждений с использованием метаданных федерации](../operations/create-a-claims-provider-trust.md#to-create-a-claims-provider-trust-using-federation-metadata) или [Создание отношений доверия с поставщиком утверждений вручную](../operations/create-a-claims-provider-trust.md#to-create-a-claims-provider-trust-manually).

-   На консоли управления AD FS **выберите отношения доверия с проверяющей стороной**. Необходимо вручную воссоздать каждое отношение доверия с проверяющей стороной, используя **мастер добавления отношений доверия с проверяющей стороной**. Воспользуйтесь списком отношений доверия с проверяющими сторонами, экспортированным и записанным при подготовке к миграции AD FS. Дополнительные сведения о создании отношений доверия с проверяющими сторонами см. в разделе [Создание отношений доверия с проверяющей стороной с использованием метаданных федерации](../operations/create-a-relying-party-trust.md#to-create-a-claims-aware-relying-party-trust-using-federation-metadata) или [Создание отношений доверия с проверяющей стороной вручную](../operations/create-a-relying-party-trust.md#to-create-a-claims-aware-relying-party-trust-manually).

## <a name="next-steps"></a>Next Steps
 [Подготовка к переносу сервера федерации AD FS 2,0](prepare-to-migrate-ad-fs-fed-server.md) [Подготовка к переносу AD FS 2,0 прокси-](prepare-to-migrate-ad-fs-fed-proxy.md) сервер федерации миграция [сервера AD FS 2,0 сервер федерации](migrate-the-ad-fs-fed-server.md) миграция [AD FS 2,0 прокси-сервер](migrate-the-ad-fs-2-fed-server-proxy.md) [AD FS 1,1](migrate-the-ad-fs-web-agent.md)




-
-
