---
title: Подготовка к миграции сервера AD FS 2.0 Federation для AD FS на Windows Server 2012 R2
description: Сведения о подготовке к переносу сервера AD FS на Windows Server 2012 R2.
author: billmath
ms.author: billmath
manager: femila
ms.date: 07/10/2017
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: identity-adfs
ms.openlocfilehash: cb301d0d68f00625ccea8c11d315b9defffe40f3
ms.sourcegitcommit: eaf071249b6eb6b1a758b38579a2d87710abfb54
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/31/2019
ms.locfileid: "66444533"
---
# <a name="prepare-to-migrate-the-ad-fs-20-federation-server-to-ad-fs-on-windows-server-2012-r2"></a>Подготовка к миграции сервера AD FS 2.0 Federation для AD FS на Windows Server 2012 R2

В этом документе описан процесс переноса AD FS 2.0 или фермы серверов федерации Windows Server 2012 в ферму Windows Server 2012 R2 AD FS.  Действия можно использовать с фермами AD FS, использующих WID или SQL Server в качестве основной базы данных.  
  
-   [Схема процесса миграции](prepare-migrate-ad-fs-server-r2.md#migration-process-outline)  
  
-   [Новые возможности AD FS в Windows Server 2012 R2](prepare-migrate-ad-fs-server-r2.md#new-ad-fs-functionality-in-windows-server-2012-r2)  
  
-   [Требования AD FS в Windows Server 2012 R2](prepare-migrate-ad-fs-server-r2.md#ad-fs-requirements-in-windows-server-2012-r2)  
  
-   [Увеличение ограничения в Windows PowerShell](prepare-migrate-ad-fs-server-r2.md#increasing-your-windows-powershell-limits)  
  
-   [Другие задачи и вопросы миграции](prepare-migrate-ad-fs-server-r2.md#other-migration-tasks-and-considerations)  
  
##  <a name="migration-process-outline"></a>Схема процесса миграции

 Для выполнения переноса сервера федерации AD FS в Windows Server 2012 R2 необходимо выполнить следующие действия.  
  
1.  Выполните экспорт, запись и архивацию следующих данных конфигурации в существующей ферме AD FS. Подробные инструкции по выполнению этих задач см. в статье о [переносе сервера федерации AD FS](migrate-ad-fs-fed-server-r2.md).  
  
Следующие параметры переносятся с помощью скриптов, которые находятся в папке \support\adfs на установочном компакт-диске Windows Server 2012 R2:  
  
-   Отношения доверия поставщика утверждений, за исключением пользовательских правил утверждений в отношениях доверия поставщика утверждений Active Directory. Дополнительные сведения см. в статье о [переносе сервера федерации AD FS](migrate-ad-fs-fed-server-r2.md).  
  
-   Отношения доверия с проверяющей стороной.  
  
-   Самозаверяющие сертификаты для подписи маркера и для расшифровки маркера, созданные AD FS.  
  
Перенос следующих пользовательских параметров должен выполняться вручную.  
  
- Параметры службы:  
  
  - Нестандартные сертификаты для подписи маркера и для расшифровки маркера, выпущенные корпоративным или публичным центром сертификации.  
  
  - Сертификат проверки подлинности сервера SSL, используемый AD FS.  
  
  - Сертификат для связи служб, используемый AD FS (по умолчанию такой же, как и сертификат SSL).  
  
    -   Нестандартные значения свойств службы федерации, таких как AutoCertificateRollover или время существования единого входа.  
  
    -   Параметры конечных точек AD FS не по умолчанию и описания утверждений.  
  
-   Пользовательские правила утверждений в отношении доверия поставщика утверждений Active Directory.  
  
    -   Пользовательские страницы входа AD FS.  
  
Дополнительные сведения см. в статье о [переносе сервера федерации AD FS](migrate-ad-fs-fed-server-r2.md).  
  
2. Создайте ферму серверов федерации Windows Server 2012 R2.  
  
3. Выполните импорт исходных данных конфигурации в созданную ферму AD FS под управлением Windows Server 2012 R2.  
  
4. Настройте страницы входа AD FS.  
  
##  <a name="new-ad-fs-functionality-in-windows-server-2012-r2"></a>Новые возможности AD FS в Windows Server 2012 R2  
 Следующие изменения функциональности AD FS в Windows Server 2012 R2 влияние миграции из AD FS 2.0 или AD FS в Windows Server 2012:  
  
**Зависимость от IIS**  
   - Службы AD FS в Windows Server 2012 R2 являются саморазмещаемыми, и им не требуется наличие IIS. В связи с этим изменением обратите внимание на следующее.  
   -   Управление SSL-сертификатами для серверов федерации и прокси-компьютеров в ферме AD FS должно выполняться через Windows PowerShell.  
  
**Изменения в параметры и настройки AD FS страниц входа**  
-   В AD FS в Windows Server 2012 R2 есть несколько изменений, вносящих улучшения входа в систему для администраторов и пользователей. Веб-страницы, размещаемые в IIS и существовавшие в предыдущей версии AD FS, теперь не используются. Веб-страницы входа AD FS размещаются в самой системе AD FS и могут быть настроены в соответствии с предпочтениями пользователя. Список изменений:  
    -   Настройка страницы входа AD FS (можно изменять название компании, логотип, изображение и описание).  
    -   Настройка сообщений об ошибках.  
    -   Настройка обнаружения домашней области AD FS. Присутствуют следующие возможности:  
        -   Настройка использования определенных суффиксов адресов электронной почты в поставщике удостоверений.  
        -   Настройка списка поставщика удостоверений для каждой проверяющей стороны.  
        -   Отключение обнаружения домашней области для интрасетей.  
        -   Создание пользовательских веб-тем.  
  
Подробные инструкции по настройке внешнего вида страниц входа AD FS, см. в разделе [Customizing the AD FS Sign-in Pages](../operations/AD-FS-Customization-in-Windows-Server-2016.md).  
  
При наличии настройки веб-страниц в существующей ферме AD FS, которые требуется перенести на Windows Server 2012 R2, можно повторно создать их как часть процесса миграции, с помощью новых функций настройки в Windows Server 2012 R2.  
  
-   **Другие изменения**  
  
    -   AD FS в Windows Server 2012 R2 основан на Windows Identity Foundation (WIF) 3.5, не WIF 4.5. Таким образом некоторые специальные возможности WIF 4.5 (например, утверждения Kerberos и динамический контроль доступа) не поддерживаются в AD FS в Windows Server 2012 R2.  
  
    -   Служба регистрации устройств (DRS) в Windows Server 2012 R2 работает с портом 443; ClientTLS для проверки подлинности сертификата пользователь работает с портом 49443  
  
        -   В активных клиентах (кроме браузерных), использующих проверку подлинности транспортного режима на основе сертификата и жестко привязанных к использованию порта 443, потребуется изменить программный код, чтобы продолжить использование проверки подлинности пользователя на основе сертификата через порт 49443.  
  
        -   В пассивных приложениях изменений кода не потребуется, так как для проверки подлинности пользователя на основе сертификата AD FS выполняет перенаправление на нужный порт.  
  
        -   Для использования проверки подлинности пользователя на основе сертификата в брандмауэрах, находящихся между клиентом и прокси, должно быть разрешено прохождение трафика через порт 49443.  
  
##  <a name="ad-fs-requirements-in-windows-server-2012-r2"></a>Требования AD FS в Windows Server 2012 R2  
 Чтобы успешно перенести фермы AD FS в Windows Server 2012 R2, должны соответствовать следующим требованиям:  
  
 Для работы AD FS каждый компьютер, необходимо предоставить права федерации должен входить в домен.  
  
 Для AD FS под управлением Windows Server 2012 R2 в функции доменом Active Directory должен выполняться на одном из следующих:  
  
- Windows Server 2012 R2  
  
- Windows Server 2012  
  
- Windows Server 2008 R2  
  
- Windows Server 2008  
  
  Если вы планируете использовать группу управляемой учетной записи службы (gMSA) как учетная запись службы для AD FS, должен быть по крайней мере один контроллер домена в вашей среде, на котором выполняется в операционной системе Windows Server 2012 или Windows Server 2012 R2.  
  
  Если вы планируете развернуть службу регистрации устройств (DRS) для присоединения к рабочему месту AD как часть развертывания AD FS, схему AD DS необходимо обновить до уровня Windows Server 2012 R2. Обновить схему можно тремя способами.  
  
1.  В существующем лесу Active Directory запустите команду adprep/forestprep из папки \support\adprep DVD-диска операционной системы Windows Server 2012 R2 на любой 64-разрядном сервере, на сервере Windows Server 2008 или более поздней версии. В этом случае не нужно устанавливать дополнительные контроллеры домена и обновлять существующие.  
  
Для выполнения команды adprep /forestprep необходимо быть членом группы "Администраторы схемы", "Администраторы предприятия" и "Администраторы домена" для домена, в котором размещается хозяин схемы.  
  
2. В существующем лесу Active Directory Установка контроллера домена под управлением Windows Server 2012 R2. В этом случае команда adprep /forestprep выполняется автоматически в процессе установки контроллера домена.  
  
Во время установки контроллера домена может потребоваться ввести дополнительные учетные данные для выполнения команды adprep /forestprep.  
  
3. Создайте новый лес Active Directory, установив AD DS на сервере под управлением Windows Server 2012 R2. В этом случае не нужно выполнять команду adprep /forestprep, поскольку схема сразу создается со всеми контейнерами и объектами, необходимыми для поддержки службы DRS.  
  
### <a name="sql-server-support-for-ad-fs-in-windows-server-2012-r2"></a>Поддержка SQL Server для AD FS в Windows Server 2012 R2  
 Если вы хотите создать ферму AD FS и использовать SQL Server для хранения данных конфигурации, то можете использовать SQL Server 2008 или более поздние версии, включая SQL Server 2012.  
  
##  <a name="increasing-your-windows-powershell-limits"></a>Увеличение предельных значений для Windows PowerShell  
 Если в ферме AD FS более 1000 отношений доверия поставщика утверждений и отношений доверия с проверяющей стороной или если при попытке запуска средства экспорта или импорта переноса AD FS наблюдается приведенная ниже ошибка, необходимо увеличить предельные значения для Windows PowerShell.  
  
```  
'Exception of type 'System.OutOfMemoryException' was thrown. At E:\dev\ds\security\ADFSv2\Product\Migration\Export-FederationConfiguration.ps1:176 char:21 + $configData = Invoke-Command -ScriptBlock $GetConfig -Argume ...  
```  
  
 Данная ошибка возникает из-за слишком малого предельного значения использования памяти по умолчанию для сеанса Windows PowerShell. Для Windows PowerShell 2.0 объем памяти по умолчанию для сеанса — 150 МБ. Для Windows PowerShell 3.0 объем памяти по умолчанию для сеанса — 1024 МБ. Предельное значение использования памяти по умолчанию для удаленного сеанса Windows PowerShell можно узнать с помощью команды: `Get-Item wsman:localhost\Shell\MaxMemoryPerShellMB`. Предельное значение можно увеличить следующей командой: `Set-Item wsman:localhost\Shell\MaxMemoryPerShellMB 512`.  
  
## <a name="other-migration-tasks-and-considerations"></a>Другие задачи и вопросы миграции  
 Для успешного выполнения переноса фермы AD FS в Windows Server 2012 R2 необходимо учитывать следующее.  
  
-   Сценарии миграции, расположенные в папке \support\adfs на установочном компакт-диске Windows Server 2012 R2 требуют использования того же имя фермы серверов федерации и имя удостоверения учетной записи службы, которая использовалась в старой ферме AD FS, при его переносе в Windows Server 2012 R2.  
  
-   Если нужно выполнить перенос фермы AD FS SQL Server, то следует знать, что в процессе миграции создается новый экземпляр базы данных SQL, в который необходимо импортировать исходные данные конфигурации.  
  
## <a name="next-steps"></a>Следующие шаги
 [Перенос служб ролей для служб федерации Active Directory в Windows Server 2012 R2](migrate-ad-fs-service-role-to-windows-server-r2.md)   
 [Перенос сервера федерации AD FS](migrate-ad-fs-fed-server-r2.md)   
 [Миграция прокси-сервера федерации AD FS](migrate-fed-server-proxy-r2.md)   
 [Проверка переноса AD FS в Windows Server 2012 R2](verify-ad-fs-migration.md)