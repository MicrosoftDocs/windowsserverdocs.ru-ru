---
title: "Подготовка к миграции сервера AD FS 2.0 федерации AD FS на Windows Server 2012 R2"
description: "Содержит сведения о подготовке к миграции сервера AD FS в Windows Server 2012 R2."
author: billmath
ms.author: billmath
manager: femila
ms.date: 07/10/2017
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: identity-adfs
ms.openlocfilehash: 4d0ff53b9118db1dd6ba5af94b3e627bf1597e0c
ms.sourcegitcommit: 03ce78a1624dbd7f4e6abf2ec1ef185b55de29a1
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/12/2017
---
# <a name="prepare-to-migrate-the-ad-fs-20-federation-server-to-ad-fs-on-windows-server-2012-r2"></a>Подготовка к миграции сервера AD FS 2.0 федерации AD FS на Windows Server 2012 R2

В этом документе описан процесс переноса AD FS 2.0 или фермы серверов федерации Windows Server 2012 в ферму Windows Server 2012 R2 AD FS.  Шаги можно использовать с AD FS ферм, использующих WID или SQL Server в качестве основной базы данных.  
  
-   [Схема процесса миграции](prepare-migrate-ad-fs-server-r2.md#migrate-process-outline)  
  
-   [Новые возможности AD FS в Windows Server 2012 R2](prepare-migrate-ad-fs-server-r2.md#new-ad-fs-functionality-in-windows-server-2012-r2)  
  
-   [Требования AD FS в Windows Server 2012 R2](prepare-migrate-ad-fs-server-r2.md#ad-fs-requirements-in-windows-server-2012-r2)  
  
-   [Увеличение предельных значений Windows PowerShell](prepare-migrate-ad-fs-server-r2.md#increasing-your-windows-powershell-limits)  
  
-   [Другие задачи и вопросы миграции](prepare-migrate-ad-fs-server-r2.md#other-migration-tasks-and-considerations)  
  
##  <a name="migration-process-outline"></a>Схема процесса миграции  
 Для выполнения переноса фермы серверов федерации AD FS в Windows Server 2012 R2, необходимо выполнить следующие задачи:  
  
1.  Экспорт, запись и архивацию следующих данных конфигурации в существующей ферме AD FS. Подробные инструкции по выполнению этих задач см. в разделе [миграции сервера федерации AD FS](migrate-ad-fs-fed-server-r2.md).  
  
Следующие параметры переносятся с помощью сценариев, расположенных в папке \support\adfs на установочном компакт-диске Windows Server 2012 R2:  
  
-   Отношения доверия поставщика утверждений, за исключением пользовательских правил утверждений в отношении доверия поставщика утверждений Active Directory. Дополнительные сведения см. в разделе [миграции сервера федерации AD FS](migrate-ad-fs-fed-server-r2.md).  
  
-   Отношения доверия проверяющей стороны.  
  
-   Внутренне созданные AD FS, самозаверяющий сертификат для подписи маркера и расшифровки маркера сертификаты.  
  
Любой из следующих пользовательских параметров необходимо переносить вручную:  
  
 -   Параметры службы:  
  
     -   Нестандартные сертификаты для подписи и расшифровки маркера, выпущенные корпоративным или публичным центром сертификации.  
  
     -   Сертификат проверки подлинности SSL сервера, используемый AD FS.  
  
     -   Сертификата взаимодействия служб, используемый AD FS (по умолчанию это тот же сертификат SSL-сертификата.  
  
      -   Нестандартные значения любого свойства службы федерации, например AutoCertificateRollover или SSO lifetime.  
  
      -   Нестандартные параметры конечных точек AD FS и описания утверждений.  
  
-   Пользовательские правила утверждений в доверия поставщика утверждений Active Directory.  
  
    -   Пользовательские страницы входа AD FS.  
  
Дополнительные сведения см. в разделе [миграции сервера федерации AD FS](migrate-ad-fs-fed-server-r2.md).  
  
2.  Создание фермы серверов федерации Windows Server 2012 R2.  
  
3.  Импорт исходных данных конфигурации в созданную ферму Windows Server 2012 R2 AD FS.  
  
4.  Настройте и пользовательских настроек страниц входа AD FS.  
  
##  <a name="new-ad-fs-functionality-in-windows-server-2012-r2"></a>Новые возможности AD FS в Windows Server 2012 R2  
 Следующие изменения функциональности AD FS в Windows Server 2012 R2 влияние миграции из AD FS 2.0 или AD FS в Windows Server 2012:  
  
**Зависимость от IIS**  
   - AD FS в Windows Server 2012 R2 являются саморазмещаемыми и не требует установки служб IIS. Убедитесь, что вы Обратите внимание на следующее в результате этого изменения:  
   -   Управление SSL-сертификатами для серверов федерации и прокси-компьютеров в ферме AD FS должно выполняться через Windows PowerShell.  
  
**Изменения в параметры и настройки AD FS страниц входа**  
-   В AD FS в Windows Server 2012 R2 существует несколько изменений, предназначенные улучшить процесс входа в систему для администраторов и пользователей. Размещенные в IIS веб-страницы, существовавшие в предыдущей версии AD FS, теперь не используются. Внешний вид AD FS входа в веб-страницы, размещаются в AD FS и могут быть настроены в предпочтениями пользователя. Список изменений:  
    -   Настройка входа в систему в AD FS, включая настройку название компании, логотип, изображение и описание.  
    -   Настройка сообщения об ошибках.  
    -   Настройка служб федерации Active Directory обнаружения домашней области взаимодействия, включая следующие:  
        -   Настройка использования определенных суффиксов электронной почты в поставщике удостоверений.  
        -   Настройка списка поставщика удостоверений по проверяющей стороной.  
        -   Отключение обнаружения домашней области для интрасетей.  
        -   Создание пользовательских веб-тем.  
  
Подробные инструкции по настройке внешнего вида страниц входа AD FS см. в разделе [настройка страниц AD FS Sign-in](../operations/AD-FS-Customization-in-Windows-Server-2016.md).  
  
Если у вас есть настройки веб-страниц в существующей ферме AD FS, которые требуется перенести на Windows Server 2012 R2, вы можете воссоздать их как часть процесса миграции с помощью новых функций настройки в Windows Server 2012 R2.  
  
-   **Другие изменения**  
  
    -   AD FS в Windows Server 2012 R2 основан на Windows Identity Foundation (WIF) 3.5, не на WIF 4.5. Таким образом некоторые компоненты WIF 4.5 (например, утверждения Kerberos и динамический контроль доступа) не поддерживаются в AD FS в Windows Server 2012 R2.  
  
    -   Служба регистрации устройств (DRS) в Windows Server 2012 R2 работает с портом 443; ClientTLS для проверки подлинности сертификата пользователя работает с портом 49443  
  
        -   Для активных, не использующие браузер клиентов, использующих проверку подлинности транспортного режима сертификат, в частности жестко привязанных к использованию порта 443, изменения кода для продолжения требуется использовать проверку подлинности сертификата через порт 49443.  
  
        -   Для приложений, пассивный без изменения не требуются, поскольку AD FS выполняет перенаправление на нужный порт для проверки подлинности сертификата пользователя.  
  
        -   Порты брандмауэра между клиентом и прокси-сервера необходимо разрешить передачу трафика через порт 49443 для пропуска проверки подлинности сертификата пользователя.  
  
##  <a name="ad-fs-requirements-in-windows-server-2012-r2"></a>Требования AD FS в Windows Server 2012 R2  
 Для успешного переноса фермы AD FS в Windows Server 2012 R2, должны соответствовать следующим требованиям:  
  
 AD FS функции каждого компьютера, который вы хотите сделать федерации должен быть присоединен к домену.  
  
 Для служб AD FS под управлением Windows Server 2012 R2 в функции домена Active Directory необходимо выполнить одно из следующих:  
  
-   Windows Server 2012 R2  
  
-   Windows Server 2012  
  
-   Windows Server 2008 R2  
  
-   Windows Server 2008  
  
 Если вы планируете использовать групповой управляемой учетной записи службы (gMSA) в качестве учетной записи службы для служб AD FS, должен быть по крайней мере один контроллер домена в вашей среде, под управлением ОС Windows Server 2012 или Windows Server 2012 R2.  
  
 Если вы планируете развернуть службу регистрации устройств (DRS) для присоединения к рабочему месту AD в рамках развертывания Служб федерации Active Directory, схему AD DS необходимо обновить до уровня Windows Server 2012 R2. Для обновления схемы тремя способами:  
  
1.  В существующем лесу Active Directory, выполнения команды adprep /forestprep из папки \support\adprep операционной системы Windows Server 2012 R2 DVD-диска на любой 64-разрядном сервере, работающем под управлением Windows Server 2008 или более поздней версии. В этом случае не дополнительный контроллер домена должен быть установлен и обновлять существующие контроллеры домена должны быть обновлены.  
  
Для выполнения команды adprep/forestprep, необходимо быть членом группы "Администраторы схемы", "Администраторы предприятия" и группы администраторов домена, который входит хозяин схемы.  
  
2.  В существующем лесу Active Directory установите контроллер домена под управлением Windows Server 2012 R2. В данном случае adprep /forestprep выполняется автоматически в процессе установки контроллера домена.  
  
Во время установки контроллера домена, может потребоваться ввести дополнительные учетные данные для выполнения команды adprep /forestprep.  
  
3.  Создайте новый лес Active Directory, установив AD DS на сервере под управлением Windows Server 2012 R2. В данном случае adprep /forestprep необходимо выполнить, поскольку схема сразу создается со всеми необходимые контейнеры и объекты, для поддержки службы DRS.  
  
### <a name="sql-server-support-for-ad-fs-in-windows-server-2012-r2"></a>Поддержка SQL Server для AD FS в Windows Server 2012 R2  
 Если вы хотите создать ферму AD FS и использовать SQL Server для хранения данных конфигурации, можно использовать SQL Server 2008 и более поздние версии, включая SQL Server 2012.  
  
##  <a name="increasing-your-windows-powershell-limits"></a>Увеличение предельных значений Windows PowerShell  
 При наличии более 1000 отношений доверия поставщика утверждений и доверия с проверяющей стороной в ферме AD FS, или если вы видите следующую ошибку при попытке запуска средства экспорта или импорта переноса AD FS, необходимо увеличить предельные значения для Windows PowerShell:  
  
```  
'Exception of type 'System.OutOfMemoryException' was thrown. At E:\dev\ds\security\ADFSv2\Product\Migration\Export-FederationConfiguration.ps1:176 char:21 + $configData = Invoke-Command -ScriptBlock $GetConfig -Argume ...  
```  
  
 Эта ошибка возникает из-за слишком малого предельный объем памяти по умолчанию сеанс Windows PowerShell. В Windows PowerShell 2.0 объем памяти по умолчанию для сеанса — 150 МБ. В Windows PowerShell 3.0 объем памяти по умолчанию для сеанса составляет 1024 МБ. Вы можете проверить ограничение памяти удаленного сеанса Windows PowerShell, используя следующую команду:`Get-Item wsman:localhost\Shell\MaxMemoryPerShellMB`. Увеличить предел, выполнив следующую команду:`Set-Item wsman:localhost\Shell\MaxMemoryPerShellMB 512`.  
  
## <a name="other-migration-tasks-and-considerations"></a>Другие задачи и вопросы миграции  
 Для успешного переноса фермы AD FS в Windows Server 2012 R2, убедитесь, что учитывать следующее:  
  
-   Сценарии миграции, расположенные в папке \support\adfs на установочном компакт-диске Windows Server 2012 R2 требуют использования того же имя фермы серверов федерации и имени удостоверения учетной записи службы, которые использовались в старой ферме AD FS, при переносе на Windows Server 2012 R2.  
  
-   Если вы хотите выполнить перенос фермы AD FS SQL Server, обратите внимание, что процесс миграции создается новый экземпляр базы данных SQL, в который необходимо импортировать исходные данные конфигурации.  
  
## <a name="next-steps"></a>Дальнейшие действия
 [Перенос служб ролей для служб федерации Active Directory в Windows Server 2012 R2](migrate-ad-fs-service-role-to-windows-server-r2.md)   
 [Перенос сервера федерации AD FS](migrate-ad-fs-fed-server-r2.md)   
 [Миграция прокси-сервера федерации AD FS](migrate-fed-server-proxy-r2.md)   
 [Проверка переноса AD FS в Windows Server 2012 R2](verify-ad-fs-migration.md)