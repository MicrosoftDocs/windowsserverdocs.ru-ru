---
title: Службы федерации Active Directory в Azure | Документация Майкрософт
description: В этом документе вы узнаете, как развернуть AD FS в Azure обеспечить высокую доступность.
services: active-directory
documentationcenter: ''
author: billmath
manager: mtillman
editor: ''
ms.assetid: 692a188c-badc-44aa-ba86-71c0e8074510
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: get-started-article
ms.date: 10/28/2018
ms.subservice: hybrid
ms.author: billmath
ms.custom: H1Hack27Feb2017
ms.openlocfilehash: 588bc3f87c78feccac47d18d31d37be3b1a02d2f
ms.sourcegitcommit: 0d0b32c8986ba7db9536e0b8648d4ddf9b03e452
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2019
ms.locfileid: "59835105"
---
# <a name="deploying-active-directory-federation-services-in-azure"></a>Развертывание служб федерации Active Directory в Azure
AD FS предоставляет упрощенной и безопасной федерации удостоверений и веб-возможности единого входа (SSO). Федерация с Azure AD или O365 дает пользователям возможность проверки подлинности с помощью локальных учетных данных и доступ ко всем ресурсам в облаке. Таким образом, становится важным для высокой доступности инфраструктуры AD FS, чтобы обеспечить доступ к ресурсам в локальной среде и в облаке. Развертывание AD FS в Azure может помочь добиться высокого уровня доступности, необходимые в связи с минимальными усилиями.
Существуют некоторые преимущества развертывания AD FS в Azure, некоторые из них перечислены ниже:

* **Высокий уровень доступности** -с помощью группы доступности Azure, обеспечить высокодоступную инфраструктуру.
* **Легко масштабировать** — требуется больший уровень производительности? Легко перенести на более мощные виртуальные машины, выполнив всего несколько действий в Azure
* **Перекрестная Геоизбыточность** — с помощью Azure Геоизбыточность можно быть уверенным, что инфраструктуры высокой доступности по всему миру
* **Простота управления** — с упрощенным параметрам управления на портале Azure, управление инфраструктурой очень легко и без проблем 

## <a name="design-principles"></a>Принципы проектирования
![Схема развертывания](./media/how-to-connect-fed-azure-adfs/deployment.png)

На приведенной выше схеме показаны рекомендуемая базовая топология, чтобы начать развертывание инфраструктуры AD FS в Azure. Ниже перечислены принципы различных компонентов топологии.

* **Контроллер домена и серверы ADFS**: При наличии менее 1000 пользователей, можно просто установить роль AD FS на контроллерах домена. Если вы не хотите оказания влияния на производительность на контроллерах домена, или при наличии более 1000 пользователей, разверните AD FS на отдельных серверах.
* **Сервер WAP** — бывает необходимо развернуть серверы прокси веб-приложения, таким образом, пользователи могут попасть AD FS, когда они не в локальной сети также.
* **СЕТЬ ПЕРИМЕТРА**: Серверы прокси веб-приложения будут размещены в сети Периметра и разрешен только TCP/443 доступ между DMZ и внутренней подсети.
* **Подсистемы балансировки нагрузки**: Для обеспечения высокой доступности серверов AD FS и прокси веб-приложения, рекомендуется использовать внутренний балансировщик нагрузки для серверов AD FS и Azure Load Balancer для серверов прокси веб-приложения.
* **Группы доступности**: Чтобы обеспечить избыточность развертывания AD FS, рекомендуется сгруппировать две или несколько виртуальных машин в одной группе доступности для аналогичных рабочих нагрузок. Эта конфигурация гарантирует, что во время либо событием планового или внепланового обслуживания, по крайней мере одна виртуальная машина будет доступна
* **Учетные записи хранения**: Рекомендуется иметь две учетные записи хранения. Наличие одной учетной записью может привести к созданию единой точки отказа и может привести к развертывания может стать недоступным нереальный сценарий, где учетная запись хранения выходит из строя. Две учетные записи хранения поможет связать одну учетную запись хранения для каждой строки ошибки.
* **Разделение сети**:  Прокси приложения веб-серверы должны развертываться в отдельной сети DMZ. Можно разделить на две подсети одной виртуальной сети и затем развернуть серверы прокси веб-приложения в изолированной подсети. Кроме того, можно просто настроить параметры группы безопасности сети для каждой подсети и разрешить только требуемый обмен данными между двумя подсетями. Дополнительные сведения приведены в следующем сценарии развертывания

## <a name="steps-to-deploy-ad-fs-in-azure"></a>Инструкции по развертыванию AD FS в Azure
Действия, описанные в этом разделе представляют собой руководство по для развертывания ниже показанной инфраструктуры AD FS в Azure.

### <a name="1-deploying-the-network"></a>1. Развертывание сети
Как описано выше, вы можете либо создать две подсети в одной виртуальной сети или же создать две совершенно разные виртуальные сети (VNet). В этой статье рассматривается развертывание одной виртуальной сети и разделить ее на две подсети. Сейчас это более простой подход, так как два отдельных виртуальных сетей потребует виртуальной сети к шлюзу виртуальной сети для обмена данными.

**1.1. Создание виртуальной сети**

![Создание виртуальной сети](./media/how-to-connect-fed-azure-adfs/deploynetwork1.png)

На портале Azure выберите виртуальную сеть и вы можно развернуть виртуальную сеть и одна подсеть сразу же всего одним щелчком. Подсеть int. также определяется она готова для добавления виртуальных машин.
Следующим шагом является добавление другую подсеть в сеть, т. е. подсеть DMZ. Чтобы создать подсеть DMZ, просто

* Выберите созданную сеть
* В окне свойств выберите подсеть
* В подсети панели нажмите кнопку "Добавить"
* Укажите подсети имя и адрес места сведения, чтобы создать подсеть

![Подсеть](./media/how-to-connect-fed-azure-adfs/deploynetwork2.png)

![Подсеть сети Периметра](./media/how-to-connect-fed-azure-adfs/deploynetwork3.png)

**1.2. Создание сетевых групп безопасности**

Группа безопасности сети (NSG) содержит перечень правил списка управления доступом (ACL), которые разрешают или запрещают сетевой трафик на экземпляры виртуальных Машин в виртуальной сети. Группы безопасности сети можно связать с подсетями или отдельными экземплярами виртуальных Машин в одной из подсетей. Когда NSG связана с подсетью, правила списка управления Доступом применяются ко всем экземплярам виртуальной Машины в этой подсети.
В этом руководстве мы создадим две группы безопасности сети: одной для внутренней сети и сети Периметра. Они будут называться NSG_INT и NSG_DMZ соответственно.

![Создать группу безопасности сети](./media/how-to-connect-fed-azure-adfs/creatensg1.png)

После создания группы безопасности сети будет 0 входящих и 0 исходящих правил. После установки ролей на соответствующих серверах и уже успешно работает, затем правила входящего и исходящего трафика осуществляется согласно требуемому уровню безопасности.

![Инициализация NSG](./media/how-to-connect-fed-azure-adfs/nsgint1.png)

После создания группы Nsg свяжите NSG_INT с подсетью INT и nsg_dmz — с подсетью DMZ. Ниже приведен снимок экрана для примера:

![Настройка группы безопасности сети](./media/how-to-connect-fed-azure-adfs/nsgconfigure1.png)

* Щелкните в подсетях, чтобы открыть панель подсетей
* Выберите подсеть для связывания с NSG. 

После завершения настройки панель подсетей должны выглядеть следующим образом:

![Подсети после NSG](./media/how-to-connect-fed-azure-adfs/nsgconfigure2.png)

**1.3. Создание подключения к локальным**

Нам понадобится подключение к локальным для развертывания контроллера домена (DC) в azure. Azure предлагает различные варианты подключения для подключения вашей локальной инфраструктуры к инфраструктуре Azure.

* Точка сеть
* Виртуальная сеть-сеть
* ExpressRoute

Рекомендуется использовать ExpressRoute. ExpressRoute позволяет создавать частные подключения между центрами обработки данных Azure и инфраструктурой вашей локальной среды или среды для совместного размещения. Подключения ExpressRoute не осуществляются через общедоступный Интернет. Они обеспечивают дополнительные надежность, более высокую скорость, меньшую задержку и безопасности по сравнению с обычными подключениями через Интернет.
Хотя рекомендуется использовать ExpressRoute, вы можете выбрать любой метод подключения, лучше всего подходит для вашей организации. Дополнительные сведения об ExpressRoute и вариантах подключения, с помощью ExpressRoute, [Технический обзор ExpressRoute](https://aka.ms/Azure/ExpressRoute).

### <a name="2-create-storage-accounts"></a>2. Создайте учетные записи хранения
Чтобы обеспечить высокий уровень доступности и избежать зависимости от одной учетной записью, вы можете создать две учетные записи хранения. Разделите виртуальные машины в каждой группе доступности на две группы и назначьте каждой группы отдельную учетную запись хранения.

![Создайте учетные записи хранения](./media/how-to-connect-fed-azure-adfs/storageaccount1.png)

### <a name="3-create-availability-sets"></a>3. Создание группы доступности
Для каждой роли (контроллер домена или AD FS и WAP) создайте группы доступности, будет содержать две виртуальные машины как минимум. Это поможет более высокая доступность для каждой роли. При создании групп доступности, очень важно учесть следующее:

* **Домены сбоя**: Виртуальные машины в одном домене сбоя, используют один источник питания и физический сетевой коммутатор. Рекомендуется использовать не менее 2 доменов сбоя. Значение по умолчанию — 3, и для этого развертывания его можно оставить
* **Домены обновления**: Машины, принадлежащие к одному домену обновления, перезапускаются вместе во время обновления. Требуется не менее 2 доменов обновления. Значение по умолчанию — 5, а для этого развертывания его можно оставить

![Группы доступности](./media/how-to-connect-fed-azure-adfs/availabilityset1.png)

Создайте следующие группы доступности.

| Группа доступности | Роль | Домены сбоя | Домены обновления |
|:---:|:---:|:---:|:--- |
| contosodcset |DC/ADFS |3 |5 |
| contosowapset |WAP |3 |5 |

### <a name="4-deploy-virtual-machines"></a>4. Развертывание виртуальных машин
Следующим шагом является развертывание виртуальных машин, которые будут размещаться разные роли в своей инфраструктуре. Рекомендуется использовать менее двух виртуальных машин в каждой группе доступности. Создайте четыре виртуальные машины для базового развертывания.

| Компьютер | Роль | Подсеть | Группа доступности | Учетная запись хранения | IP-адрес |
|:---:|:---:|:---:|:---:|:---:|:---:|
| contosodc1 |DC/ADFS |INT |contosodcset |contososac1 |Static |
| contosodc2 |DC/ADFS |INT |contosodcset |contososac2 |Static |
| contosowap1 |WAP |СЕТЬ ПЕРИМЕТРА |contosowapset |contososac1 |Static |
| contosowap2 |WAP |СЕТЬ ПЕРИМЕТРА |contosowapset |contososac2 |Static |

Как вы могли заметить, в NSG не был указан. Это обусловлено azure можно использовать группы безопасности сети на уровне подсети. Затем можно управлять машины сетевого трафика с помощью отдельной группы NSG, связанных с либо подсетью или объектом сетевой КАРТЫ. Дополнительные сведения об [что такое группа безопасности сети (NSG)](https://aka.ms/Azure/NSG).
При управлении DNS рекомендуется статический IP-адрес. Можно использовать Azure DNS и вместо этого в записях DNS для домена, ссылки на новые компьютеры по их полные доменные имена Azure.
Панель вашей виртуальной машины должен выглядеть следующим образом после завершения развертывания:

![Виртуальные машины, развернутые](./media/how-to-connect-fed-azure-adfs/virtualmachinesdeployed_noadfs.png)

### <a name="5-configuring-the-domain-controller--ad-fs-servers"></a>5. Настройка контроллера домена и серверы AD FS
 Чтобы проверять подлинность запросов все входящие запросы, AD FS необходимо связаться с контроллером домена. Чтобы сэкономить на дорогостоящем маршруте из Azure на локальный контроллер домена для проверки подлинности, рекомендуется развертывать реплику контроллера домена в Azure. Для достижения высокого уровня доступности, рекомендуется создать группу доступности не менее 2 контроллеров домена.

| Контроллер домена | Роль | Учетная запись хранения |
|:---:|:---:|:---:|
| contosodc1 |Реплика |contososac1 |
| contosodc2 |Реплика |contososac2 |

* Повысить уровень двух серверов в качестве реплик контроллеров домена с помощью DNS
* Настройте серверы AD FS, установив роли AD FS, с помощью диспетчера сервера.

### <a name="6-deploying-internal-load-balancer-ilb"></a>6. Развертывание внутреннего балансировщика нагрузки (ILB)
**6.1. Создание внутреннего балансировщика Нагрузки**

Чтобы развернуть внутренний балансировщик Нагрузки, выберите подсистемы балансировки нагрузки на портале Azure щелкните Добавить (+).

> [!NOTE]
> Если вы не видите **подсистемы балансировки нагрузки** в меню, щелкните **Обзор** в левом нижнем углу портала и прокрутите список, пока не увидите **подсистемы балансировки нагрузки**.  Щелкните желтую звездочку, чтобы добавить его в меню. Теперь выберите значок балансировщика нагрузки, чтобы открыть панель, чтобы приступить к настройке подсистемы балансировки нагрузки.
> 
> 

![Обзор подсистемы балансировки нагрузки](./media/how-to-connect-fed-azure-adfs/browseloadbalancer.png)

* **Имя**: Присвойте любое подходящее имя для подсистемы балансировки нагрузки
* **Схема**: Так как этот балансировщик нагрузки будет размещаться перед серверами AD FS и предназначен для подключения только к внутренней сети, выберите «Внутренняя»
* **Виртуальная сеть**: Выберите виртуальную сеть, где развертывается AD FS
* **Подсети**: Выберите внутреннюю подсеть
* **Назначение IP-адресов**: Static

![Внутренняя Подсистема балансировки нагрузки](./media/how-to-connect-fed-azure-adfs/ilbdeployment1.png)

После нажатия кнопки создания и развертывается внутреннего балансировщика Нагрузки, вы должны увидеть в список подсистем балансировки нагрузки:

![Балансировщики нагрузки поверх внутреннего балансировщика нагрузки](./media/how-to-connect-fed-azure-adfs/ilbdeployment2.png)

Следующим шагом является настройка серверного пула и серверной пробы.

**6.2. Настройка серверного пула внутреннего балансировщика Нагрузки**

Выберите только что созданный внутренний балансировщик Нагрузки на панели подсистемы балансировки нагрузки. Откроется панель параметров. 

1. Выберите на открывшейся панели серверные пулы
2. На панели добавления пула серверной части, щелкните Добавить виртуальную машину
3. Откроется панель, на котором можно выбрать группу доступности
4. Выберите группу доступности AD FS

![Настройка серверного пула внутреннего балансировщика Нагрузки](./media/how-to-connect-fed-azure-adfs/ilbdeployment3.png)

**6.3. Настройка пробы**

На панели параметров внутренней подсистемы балансировки Нагрузки выберите пробы работоспособности.

1. Щелкните на "Добавить"
2. Введите сведения о пробе. **Имя**: Проверять имя b. **Протокол**: HTTP c. **Порт**. 80 (HTTP) d. **Путь**: / adfs/пробы e. **Интервал**: 5 (значение по умолчанию) — это интервал, по которому внутренний балансировщик Нагрузки проверяет компьютеры в серверном пуле f. **Порог состояния неработоспособности ограничение**: 2 (значение по умолчанию) — это предельное число последовательных сбоев проверки после которого внутренний балансировщик Нагрузки объявит виртуальную машину в серверном пуле неотвечающие и прекратит отправлять трафик к нему.

![Настройка пробы внутреннего балансировщика Нагрузки](./media/how-to-connect-fed-azure-adfs/ilbdeployment4.png)

Мы используем/ADFS/Probe конечной точки, которая была создана явно для проверки работоспособности в среде AD FS где невозможны полной проверки путь HTTPS.  Это значительно лучше, чем на выполнение проверки базовый порт 443, который не точно отражает состояние современных развертывания AD FS.  Дополнительные сведения об этом можно найти в https://blogs.technet.microsoft.com/applicationproxyblog/2014/10/17/hardware-load-balancer-health-checks-and-web-application-proxy-ad-fs-2012-r2/.

**6.4. Создание правил балансировки нагрузки**

Чтобы обеспечить эффективную балансировку трафика, внутренний балансировщик Нагрузки должны быть настроены правила балансировки нагрузки. Чтобы создать правило, балансировки нагрузки 

1. Выберите правило балансировки нагрузки на панели "Параметры" внутреннего балансировщика нагрузки
2. Щелкните Добавить на панель правило балансировки нагрузки
3. В панели правило балансировки нагрузки, добавить. **Имя**: Укажите имя для правила b. **Протокол**: Выберите тип TCP. **Порт**. 443 d. **Внутренний порт**: 443 e. **Внутренний пул**: Выберите пул, созданный для более ранних f кластера AD FS. **Проверки**: Выберите пробу, созданную ранее для серверов AD FS

![Настройка внутренней подсистемы балансировки Нагрузки, правила балансировки](./media/how-to-connect-fed-azure-adfs/ilbdeployment5.png)

**6.5. Обновление DNS с подсистемой балансировки Нагрузки**

Перейдите к DNS-сервера и создайте запись CNAME для внутреннего балансировщика Нагрузки. Эта запись должна быть для службы федерации с IP-адрес, указывающий на IP-адрес внутреннего балансировщика нагрузки. Например, если адрес выделенного IP-адреса внутренней подсистемы балансировки Нагрузки — 10.3.0.8, а установленная служба федерации — fs.contoso.com, создайте запись CNAME, содержащую FS.contoso.com и указывающую на 10.3.0.8.
Это позволит гарантировать, что весь обмен данными о fs.contoso.com окончания вверх во внутренний балансировщик Нагрузки и направляются соответствующим образом.

### <a name="7-configuring-the-web-application-proxy-server"></a>7. Настройка веб-приложения прокси-сервера
**7.1. Настройка серверов веб-прокси приложения для получения доступа к серверам AD FS**

Чтобы убедиться, что серверы прокси веб-приложения, могут подключиться к серверам AD FS за внутреннего балансировщика Нагрузки, создайте запись в %systemroot%\system32\drivers\etc\hosts для внутреннего балансировщика Нагрузки. Обратите внимание, что различающееся имя (DN) должно быть имя службы федерации, например fs.contoso.com. И IP-адресов, IP-адреса внутреннего балансировщика Нагрузки (10.3.0.8, как показано в примере).

**7.2. Установка роли прокси веб-приложения**

Убедившись, что серверы прокси веб-приложения, могут подключиться к серверам AD FS за балансировщиком Нагрузки, чего их можно установить серверы прокси веб-приложения. Серверы веб-прокси приложения не должны быть присоединен к домену. Установка роли прокси веб-приложения на двух серверах прокси веб-приложения, выбрав роль удаленного доступа. Диспетчер серверов поможет завершить установку WAP.
Дополнительные сведения о развертывании WAP [Установка и настройка сервера прокси-сервера веб-приложений](https://technet.microsoft.com/library/dn383662.aspx).

### <a name="8--deploying-the-internet-facing-public-load-balancer"></a>8.  Развертывание (общедоступной) подсистемы балансировки нагрузки для Интернета
**8.1.  Создание общедоступного балансировщика нагрузки (общедоступного)**

На портале Azure выберите подсистемы балансировки нагрузки и нажмите кнопку Добавить. На панели подсистемы балансировки нагрузки создать введите следующие сведения

1. **Имя**: Имя для балансировщика нагрузки
2. **Схема**: Открытый — этот параметр сообщает Azure, что этого балансировщика нагрузки необходим общедоступный адрес.
3. **IP-адрес**: Создание нового IP-адреса (динамический)

![Балансировщик нагрузки для Интернета](./media/how-to-connect-fed-azure-adfs/elbdeployment1.png)

После развертывания Подсистема балансировки нагрузки будет отображаться в списке подсистемы балансировки нагрузки.

![Список подсистемы балансировки нагрузки](./media/how-to-connect-fed-azure-adfs/elbdeployment2.png)

**8.2. Назначить общедоступный IP-адрес DNS-метки**

Щелкните только что созданную запись балансировщика нагрузки на панели подсистемы балансировки нагрузки, чтобы открыть панель для настройки. Выполните следующие действия для настройки метки DNS для общедоступного IP-адреса:

1. Щелкните общедоступный IP-адрес. Откроется панель для общедоступного IP-адреса и его параметров
2. Щелкните конфигурацию
3. Укажите метку DNS. Это станет общедоступной метки DNS, которому можно получить доступ из любого места, например contosofs.westus.cloudapp.azure.com. Можно добавить запись в внешняя служба DNS для службы федерации (например, fs.contoso.com), которому сопоставляется на DNS-метку внешнего балансировщика нагрузки (contosofs.westus.cloudapp.azure.com).

![Настройка балансировщика нагрузки для Интернета](./media/how-to-connect-fed-azure-adfs/elbdeployment3.png) 

![Настройка балансировщика нагрузки (DNS) для Интернета](./media/how-to-connect-fed-azure-adfs/elbdeployment4.png)

**8.3. Настройка серверного пула для балансировщика нагрузки с выходом в Интернет (общедоступного)** 

Выполните те же действия, и при создании внутреннего балансировщика нагрузки, чтобы настроить серверный пул с выходом в Интернет (общедоступного) Load Balancer уровня как группы доступности для серверов WAP. Например contosowapset.

![Настройка серверного пула для балансировщика нагрузки с выходом в Интернет](./media/how-to-connect-fed-azure-adfs/elbdeployment5.png)

**8.4. Настройка пробы**

Выполните те же действия, и при настройке внутреннего балансировщика нагрузки для настройки пробы для серверного пула серверов WAP.

![Настройка пробы для балансировщика нагрузки с выходом в Интернет](./media/how-to-connect-fed-azure-adfs/elbdeployment6.png)

**8.5. Создание правил балансировки нагрузки**

Выполните те же действия внутреннего балансировщика нагрузки, чтобы настроить правило балансировки нагрузки для TCP-порт 443.

![Настройка правил балансировки нагрузки для балансировщика нагрузки с выходом в Интернет](./media/how-to-connect-fed-azure-adfs/elbdeployment7.png)

### <a name="9-securing-the-network"></a>9. Обеспечение безопасности сети
**9.1. Обеспечение безопасности внутренней подсети.**

В целом требуются следующие правила для эффективной защиты внутренней подсети (в порядке, как показано ниже)

| Правило | Описание | Поток |
|:--- |:--- |:---:|
| AllowHTTPSFromDMZ |Разрешить подключения по протоколу HTTPS из сети Периметра |Входящий |
| DenyInternetOutbound |Нет доступа к Интернету |Исходящий |

![Правила доступа INT (входящий трафик)](./media/how-to-connect-fed-azure-adfs/nsg_int.png)

<!--
[comment]: <> (![INT access rules (inbound)](./media/how-to-connect-fed-azure-adfs/nsgintinbound.png))
[comment]: <> (![INT access rules (outbound)](./media/how-to-connect-fed-azure-adfs/nsgintoutbound.png))
-->

**9.2. Обеспечение защиты подсети DMZ**

| Правило | Описание | Поток |
|:--- |:--- |:---:|
| AllowHTTPSFromInternet |Разрешить HTTPS из Интернета к сети Периметра |Входящий |
| DenyInternetOutbound |Либо, кроме HTTPS к Интернету заблокирован |Исходящий |

![Правила доступа EXT (входящий трафик)](./media/how-to-connect-fed-azure-adfs/nsg_dmz.png)

<!--
[comment]: <> (![EXT access rules (inbound)](./media/how-to-connect-fed-azure-adfs/nsgdmzinbound.png))
[comment]: <> (![EXT access rules (outbound)](./media/how-to-connect-fed-azure-adfs/nsgdmzoutbound.png))
-->

> [!NOTE]
> Если проверка сертификата пользователя клиента (clientTLS проверки подлинности с помощью X509 сертификатов пользователей) является обязательным, AD FS требуется TCP порт 49443 был включен для получения доступа.
> 
> 

### <a name="10-test-the-ad-fs-sign-in"></a>10. Тестирование входа AD FS
Самым простым способом является для тестирования AD FS — использовать страницу IdpInitiatedSignon.aspx. Чтобы иметь возможность сделать это, необходимо включить IdpInitiatedSignOn в свойствах AD FS. Выполните следующие действия, чтобы проверить установку AD FS

1. Запустите ниже командлет на сервере AD FS, с помощью PowerShell, чтобы включить.
   Set-AdfsProperties -EnableIdPInitiatedSignonPage $true 
2. Из любого внешнего компьютера получить доступ к https:\//adfs-server.contoso.com/adfs/ls/IdpInitiatedSignon.aspx.  
3. Должна появиться страница AD FS, например ниже:

![Тестовая страница входа](./media/how-to-connect-fed-azure-adfs/test1.png)

Для успешного входа в систему он будет отобразится сообщение об успешном выполнении как показано ниже:

![Успешное завершение тестирования](./media/how-to-connect-fed-azure-adfs/test2.png)

## <a name="template-for-deploying-ad-fs-in-azure"></a>Шаблон для развертывания AD FS в Azure
Этот шаблон развертывает 6 виртуальных машин программы установки, 2 для каждого контроллеров домена, AD FS и WAP.

[AD FS в шаблон развертывания Azure](https://github.com/paulomarquesc/adfs-6vms-regular-template-based)

Можно использовать существующую виртуальную сеть или создать новую виртуальную сеть при развертывании этого шаблона. Ниже перечислены различные параметры, доступные для настройки развертывания с описанием использования параметра в процессе развертывания. 

| Параметр | Описание |
|:--- |:--- |
| Location |Регион для развертывания ресурсов, например East US. |
| StorageAccountType |Тип созданной учетной записи хранения |
| VirtualNetworkUsage |Указывает, будет создан новую виртуальную сеть или используйте существующую |
| virtualNetworkName |Имя виртуальной сети, чтобы создать, обязательная для существующего или нового использования виртуальной сети |
| VirtualNetworkResourceGroupName |Указывает имя группы ресурсов, где находится существующей виртуальной сети. При использовании существующей виртуальной сети, это становится обязательным параметром, поэтому развертывания можно найти идентификатор существующей виртуальной сети |
| VirtualNetworkAddressRange |Диапазон адресов новой виртуальной сети, обязательный параметр при создании новой виртуальной сети |
| InternalSubnetName |Имя внутренней подсети и настраивается в оба варианта использования виртуальной сети (новой или существующей) |
| InternalSubnetAddressRange |Диапазон адресов внутренней подсети, которая содержит контроллеры домена и серверы ADFS. обязательный при создании новой виртуальной сети. |
| DMZSubnetAddressRange |Диапазон адресов подсети dmz, содержащий прокси-серверов Windows приложение, обязательным при создании новой виртуальной сети. |
| DMZSubnetName |Имя внутренней подсети и настраивается в оба варианта использования виртуальной сети (новой или существующей). |
| ADDC01NICIPAddress |Внутренний IP-адрес первого контроллера домена, этот IP-адрес будет назначаться статически на контроллер домена и должен быть допустимый IP-адрес в пределах внутренней подсети. |
| ADDC02NICIPAddress |Внутренний IP-адрес второго контроллера домена, этот IP-адрес будет назначаться статически на контроллер домена и должен быть допустимый IP-адрес в пределах внутренней подсети. |
| ADFS01NICIPAddress |Внутренний IP-адрес первого сервера служб федерации Active Directory, этот IP-адрес будет назначаться статически на сервер ADFS и должен быть допустимый IP-адрес в пределах внутренней подсети. |
| ADFS02NICIPAddress |Внутренний IP-адрес второго сервера служб федерации Active Directory, этот IP-адрес будет назначаться статически на сервер ADFS и должен быть допустимый IP-адрес в пределах внутренней подсети. |
| WAP01NICIPAddress |Внутренний IP-адрес первого сервера WAP, этот IP-адрес статически назначается серверу WAP и должен быть допустимый IP-адрес в пределах подсети DMZ |
| WAP02NICIPAddress |Внутренний IP-адрес второго сервера WAP, этот IP-адрес статически назначается серверу WAP и должен быть допустимый IP-адрес в пределах подсети DMZ |
| ADFSLoadBalancerPrivateIPAddress |Внутренний IP-адрес подсистемы балансировки нагрузки служб федерации Active Directory, этот IP-адрес будет назначаться статически в подсистему балансировки нагрузки и должен быть допустимый IP-адрес в пределах внутренней подсети. |
| ADDCVMNamePrefix |Префикс имени виртуальной машины для контроллеров домена |
| ADFSVMNamePrefix |Префикс имени виртуальной машины для серверов ADFS. |
| WAPVMNamePrefix |Префикс имени виртуальной машины для серверов WAP. |
| ADDCVMSize |Размер виртуальной машины из контроллеров домена |
| ADFSVMSize |Размер виртуальной машины для серверов ADFS. |
| WAPVMSize |Размер виртуальной машины для серверов WAP. |
| adminUserName |Имя локального администратора виртуальных машин |
| adminPassword |Пароль для учетной записи локального администратора виртуальных машин |

## <a name="additional-resources"></a>Дополнительные ресурсы
* [Группы доступности](https://aka.ms/Azure/Availability) 
* [Azure Load Balancer](https://aka.ms/Azure/ILB)
* [Внутренняя Подсистема балансировки нагрузки](https://aka.ms/Azure/ILB/Internal)
* [Балансировки нагрузки для Интернета](https://aka.ms/Azure/ILB/Internet)
* [Учетные записи хранения](https://aka.ms/Azure/Storage)
* [Виртуальные сети Azure](https://aka.ms/Azure/VNet)
* [AD FS и прокси-сервер приложения веб-ссылок](https://aka.ms/ADFSLinks) 

## <a name="next-steps"></a>Следующие шаги
* [Интеграция локальных удостоверений с Azure Active Directory](https://docs.microsoft.com/azure/active-directory/hybrid/whatis-hybrid-identity)
* [Настройка и управление AD FS с помощью Azure AD Connect](/azure/active-directory/hybrid/how-to-connect-fed-whatis)
* [Развертывание высокой доступности в нескольких регионах AD FS в Azure с помощью диспетчера трафика Azure](active-directory-adfs-in-azure-with-azure-traffic-manager.md)
