---
title: Высокий уровень доступности кросс-географическое развертывание AD FS в Azure с помощью диспетчера трафика Azure | Документация Майкрософт
description: В этом документе вы узнаете, как развертывать AD FS в Azure для высокого уровня доступность.
keywords: AD FS с диспетчером трафика Azure, ADFS с диспетчером трафика Azure, географическим, многоцентрами обработки данных, географическими центрами обработки данных, географическими центрами обработки данных, развертыванием AD FS в Azure, развертыванием ADFS Azure, Azure AD FS, службами ADFS, развертыванию ADFS, развертывании AD FS, ADFS в Azure, Развертывание ADFS в Azure, развертывание AD FS в Azure, ADFS Azure, введение в AD FS, Azure, AD FS в Azure, IaaS, ADFS, перемещение ADFS в Azure
services: active-directory
documentationcenter: ''
author: anandyadavmsft
manager: mtillman
editor: ''
ms.assetid: a14bc870-9fad-45ed-acd5-a90ccd432e54
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: get-started-article
ms.date: 09/01/2016
ms.author: anandy;billmath
ms.openlocfilehash: d98eb126513d707bce7abe3e901c8bf584d2319c
ms.sourcegitcommit: f6490192d686f0a1e0c2ebe471f98e30105c0844
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/10/2019
ms.locfileid: "70868015"
---
# <a name="high-availability-cross-geographic-ad-fs-deployment-in-azure-with-azure-traffic-manager"></a>Высокий уровень доступности кросс-географическое развертывание AD FS в Azure с помощью диспетчера трафика Azure
[AD FS развертывании в Azure](how-to-connect-fed-azure-adfs.md) предоставляет пошаговые инструкции по развертыванию простой инфраструктуры AD FS для Организации в Azure. В этой статье приведены дальнейшие действия по созданию кросс-географического развертывания AD FS в Azure с помощью [диспетчера трафика Azure](https://docs.microsoft.com/azure/traffic-manager/). Диспетчер трафика Azure помогает создать географически распределенную и высокопроизводительную инфраструктуру AD FS для вашей организации, используя ряд методов маршрутизации, которые могут соответствовать различным потребностям инфраструктуры.

Высокодоступная географическая AD FSная инфраструктура позволяет:

* **Исключение единой точки отказа:** Благодаря возможностям отработки отказа диспетчера трафика Azure можно достичь высокодоступной AD FS инфраструктуры, даже если один из центров обработки данных в части земного шара выходит из строя.
* **Улучшенная производительность.** Вы можете использовать предлагаемое развертывание в этой статье, чтобы предоставить высокопроизводительную инфраструктуру AD FS, которая поможет ускорить проверку подлинности пользователей. 

## <a name="design-principles"></a>Принципы проектирования
![Общая структура](./media/active-directory-adfs-in-azure-with-azure-traffic-manager/blockdiagram.png)

Основные принципы разработки будут такими же, как и в разделе принципы разработки статьи AD FS развертывании в Azure. На схеме выше показано простое расширение базового развертывания в другой географический регион. Ниже приведены некоторые моменты, которые следует учитывать при расширении развертывания до нового географического региона.

* **Виртуальная сеть:** Необходимо создать новую виртуальную сеть в географическом регионе, в котором требуется развернуть дополнительную AD FS инфраструктуру. На приведенной выше схеме вы увидите Geo1 VNET и Geo2 VNET в качестве двух виртуальных сетей в каждом географическом регионе.
* **Контроллеры домена и AD FS серверы в новой географической виртуальной сети:** Рекомендуется развертывать контроллеры домена в новом географическом регионе, чтобы серверы AD FS в новом регионе не могли обращаться к контроллеру домена в другой сети, чтобы выполнить проверку подлинности и таким образом повысить производительность.
* **Учетные записи хранения:** Учетные записи хранения связаны с регионом. Так как вы будете развертывать компьютеры в новом географическом регионе, вам потребуется создать новые учетные записи хранения для использования в регионе.  
* **Группы безопасности сети:** Как учетные записи хранения, группы безопасности сети, созданные в регионе, нельзя использовать в другом географическом регионе. Поэтому вам потребуется создать новые группы безопасности сети, аналогичные тем, которые находятся в первом географическом регионе для подсети INT и DMZ в новом географическом регионе.
* **Метки DNS для общедоступных IP-адресов:** Диспетчер трафика Azure может ссылаться на конечные точки только через метки DNS. Поэтому для общедоступных IP-адресов внешних подсистем балансировки нагрузки требуется создать метки DNS.
* **Диспетчер трафика Azure:** Диспетчер трафика Microsoft Azure позволяет управлять распределением пользовательского трафика между конечными точками службы, работающими в разных центрах обработки данных по всему миру. Диспетчер трафика Azure работает на уровне DNS. Он использует ответы DNS для направления трафика конечных пользователей на глобально распределенные конечные точки. Затем клиенты подключаются к этим конечным точкам напрямую. Используя различные варианты маршрутизации производительности, взвешенного и приоритетного, можно легко выбрать вариант маршрутизации, который лучше всего подходит для нужд вашей организации. 
* **Подключение v-NET к V-NET между двумя регионами:** Подключение между виртуальными сетями не требуется. Поскольку каждая виртуальная сеть имеет доступ к контроллерам домена и имеет AD FS и WAP-сервер, они могут работать без подключения между виртуальными сетями в разных регионах. 

## <a name="steps-to-integrate-azure-traffic-manager"></a>Действия по интеграции диспетчера трафика Azure
### <a name="deploy-ad-fs-in-the-new-geographical-region"></a>Развертывание AD FS в новом географическом регионе
Следуйте инструкциям и рекомендациям в разделе [развертывание AD FS в Azure](how-to-connect-fed-azure-adfs.md) , чтобы развернуть ту же топологию в новом географическом регионе.

### <a name="dns-labels-for-public-ip-addresses-of-the-internet-facing-public-load-balancers"></a>Метки DNS для общедоступных IP-адресов подсистем балансировки нагрузки с выходом в Интернет (общедоступных)
Как упоминалось выше, диспетчер трафика Azure может ссылаться только на метки DNS в качестве конечных точек, поэтому важно создать метки DNS для общедоступных IP-адресов внешних подсистем балансировки нагрузки. На снимке экрана ниже показано, как можно настроить метку DNS для общедоступного IP-адреса. 

![Метка DNS](./media/active-directory-adfs-in-azure-with-azure-traffic-manager/eastfabstsdnslabel.png)

### <a name="deploying-azure-traffic-manager"></a>Развертывание диспетчера трафика Azure
Выполните следующие действия, чтобы создать профиль диспетчера трафика. Дополнительные сведения см. в разделе [Управление профилем диспетчера трафика Azure](https://docs.microsoft.com/azure/traffic-manager/traffic-manager-manage-profiles).

1. **Создайте профиль диспетчера трафика.** Присвойте профилю диспетчера трафика уникальное имя. Это имя профиля является частью DNS-имени и действует как префикс для метки имени домена диспетчера трафика. Имя/префикс добавляется в. trafficmanager.net, чтобы создать метку DNS для диспетчера трафика. На снимке экрана ниже показан префикс DNS диспетчера трафика, который задается как мистс, и результирующая метка DNS будет иметь значение mysts.trafficmanager.net. 
   
    ![Создание профиля диспетчера трафика](./media/active-directory-adfs-in-azure-with-azure-traffic-manager/trafficmanager01.png)
2. **Метод маршрутизации трафика:** В диспетчере трафика доступны три варианта маршрутизации:
   
   * Priority 
   * Производительность
   * Взвешенное
     
     Для обеспечения высокой скорости реагирования AD FS инфраструктуры рекомендуется использовать **производительность** . Тем не менее можно выбрать любой метод маршрутизации, наиболее подходящий для нужд развертывания. На AD FS функциональности не влияет выбранный параметр маршрутизации. Дополнительные сведения см. в разделе [методы маршрутизации трафика диспетчера трафика](https://docs.microsoft.com/azure/traffic-manager/traffic-manager-routing-methods) . На снимке экрана ниже показан выбранный метод **производительности** .
3. **Настроить конечные точки:** На странице Диспетчер трафика щелкните конечные точки и выберите Добавить. Откроется страница добавить конечную точку, как показано на снимке экрана ниже.
   
   ![Настройка конечных точек](./media/active-directory-adfs-in-azure-with-azure-traffic-manager/eastfsendpoint.png)
   
   Для различных входных данных следуйте приведенным ниже рекомендациям.
   
   **Тип.** Выберите конечную точку Azure, так как мы будем указывать на общедоступный IP-адрес Azure.
   
   **Имя:** Создайте имя, которое нужно связать с конечной точкой. Это не DNS-имя, и оно не влияет на записи DNS.
   
   **Тип целевого ресурса:** Выберите общедоступный IP-адрес в качестве значения этого свойства. 
   
   **Целевой ресурс:** Это позволит выбрать одну из различных меток DNS, доступных в подписке. Выберите метку DNS, соответствующую конечной точке, которую вы настраиваете.
   
   Добавьте конечную точку для каждого географического региона, на который диспетчер трафика Azure должен маршрутизировать трафик.
   Дополнительные сведения и подробные инструкции по добавлению и настройке конечных точек в диспетчере трафика см. в статье [Добавление, отключение, включение и удаление конечных](https://docs.microsoft.com/azure/traffic-manager/traffic-manager-manage-endpoints) точек.
4. **Настройка пробы:** На странице Диспетчер трафика щелкните Конфигурация. На странице Конфигурация необходимо изменить параметры монитора для проверки на HTTP-порт 80 и относительный путь/адфс/пробе.
   
    ![Настройка пробы](./media/active-directory-adfs-in-azure-with-azure-traffic-manager/mystsconfig.png) 
   
   > [!NOTE]
   > **Убедитесь, что состояние конечных точек в сети после завершения настройки**. Если все конечные точки находятся в состоянии пониженной функциональности, диспетчер трафика Azure будет выполнять наилучшую попытку маршрутизации трафика, предполагая, что диагностика неверна и все конечные точки доступны.
   > 
   > 
5. **Изменение записей DNS для диспетчера трафика Azure:** Служба федерации должна быть записью CNAME в DNS-имя диспетчера трафика Azure. Создайте запись CNAME в общедоступных записях DNS, чтобы кто-то пытается связаться со службой федерации, на самом деле достигает диспетчера трафика Azure.
   
    Например, чтобы указать службе Федерации, fs.fabidentity.com диспетчер трафика, необходимо обновить запись ресурса DNS следующим образом:
   
    <code>fs.fabidentity.com IN CNAME mysts.trafficmanager.net</code>

## <a name="test-the-routing-and-ad-fs-sign-in"></a>Тестирование маршрутизации и AD FS вход в систему
### <a name="routing-test"></a>Проверка маршрутизации
Очень простая проверка маршрутизации заключается в попытке проверить связь с DNS-именем службы федерации с компьютера в каждом географическом регионе. В зависимости от выбранного метода маршрутизации конечная точка, на которой она фактически проверяется, будет отображаться в окне проверки связи. Например, если выбрана маршрутизация производительности, будет достигнута конечная точка, ближайшая к региону клиента. Ниже приведен моментальный снимок двух пакетов проверки связи из двух разных регионов: один в EastAsia регионе и один в западной части США. 

![Проверка маршрутизации](./media/active-directory-adfs-in-azure-with-azure-traffic-manager/pingtest.png)

### <a name="ad-fs-sign-in-test"></a>AD FS теста входа
Самый простой способ протестировать AD FS — использовать страницу страницу idpinitiatedsignon. aspx. Чтобы это сделать, необходимо включить страницу idpinitiatedsignon в свойствах AD FS. Выполните следующие действия, чтобы проверить настройку AD FS

1. Запустите приведенный ниже командлет на AD FS сервере с помощью PowerShell, чтобы включить его. 
   Set-AdfsProperties-Енаблеидпинитиатедсигнонпаже $true
2. С любого внешнего компьютера доступ к<yourfederationservicedns>HTTPS:///адфс/ЛС/идпинитиатедсигнон.аспкс
3. Вы должны увидеть AD FS страницу, как показано ниже:
   
    ![Тест ADFS — запрос проверки подлинности](./media/active-directory-adfs-in-azure-with-azure-traffic-manager/adfstest1.png)
   
    При успешном входе в систему будет предоставлено сообщение об успешном выполнении, как показано ниже:
   
    ![Тест ADFS — успешная проверка подлинности](./media/active-directory-adfs-in-azure-with-azure-traffic-manager/adfstest2.png)

## <a name="related-links"></a>Связанные ссылки
* [Базовое развертывание AD FS в Azure](how-to-connect-fed-azure-adfs.md)
* [диспетчер трафика Microsoft Azure](https://docs.microsoft.com/azure/traffic-manager/)
* [Методы маршрутизации трафика в диспетчере трафика](https://docs.microsoft.com/azure/traffic-manager/traffic-manager-routing-methods)

## <a name="next-steps"></a>Следующие шаги
* [Управление профилем диспетчера трафика Azure](https://docs.microsoft.com/azure/traffic-manager/traffic-manager-manage-profiles)
* [Добавление, отключение, включение и удаление конечных точек](https://docs.microsoft.com/azure/traffic-manager/traffic-manager-manage-endpoints) 

