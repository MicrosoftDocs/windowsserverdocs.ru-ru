---
ms.assetid: 434fd617-373a-405e-bae4-da324ea83efc
title: Руководство по развертыванию служб федерации Active Directory в Windows Server 2012 R2
description: ''
author: billmath
ms.author: billmath
manager: femila
ms.date: 05/31/2017
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: identity-adfs
ms.openlocfilehash: 13ce514dc5f3f70217a26c898cde6fe24d4967c6
ms.sourcegitcommit: 0d0b32c8986ba7db9536e0b8648d4ddf9b03e452
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2019
ms.locfileid: "59847385"
---
# <a name="configure-a-federation-server"></a>Настройка сервера федерации

>Область применения. Windows Server 2016, Windows Server 2012 R2

После установки служб федерации Active Directory \(AD FS\) службу роли на компьютере, можно приступать к настройке этого компьютера в качестве сервера федерации. Необходимо выполнить одно из следующих действий.  
  
-   [Настройка первого сервера федерации в ферме серверов федерации](assetId:///e340cf8f-acf3-4cba-8135-a9353b85e714#BKMK_1)  
  
-   [Добавление сервера федерации в существующую ферму серверов федерации](assetId:///e340cf8f-acf3-4cba-8135-a9353b85e714#BKMK_2)  
  
## <a name="BKMK_1"></a>Настройка первого сервера федерации в ферме серверов федерации  
  
### <a name="to-configure-the-first-federation-server-in-a-new-federation-server-farm-by-using-the-active-directory-federation-service-configuration-wizard"></a>Настройка первого сервера федерации в ферме серверов федерации с помощью мастера настройки федерации службы Active Directory  
  
> [!NOTE]  
> Убедитесь, что права администратора домена или иметь доступные учетные данные администратора домена, перед выполнением этой процедуры.  
  
1.  На странице **Панель мониторинга** диспетчера серверов щелкните флажок **Уведомления**, а затем щелкните **Настроить службу федерации на сервере**.  
  
    Откроется **Мастер конфигурации служб федерации Active Directory** .  
  
2.  На странице **Приветствие** щелкните **Создать первый сервер федерации на ферме серверов федерации** и нажмите кнопку **Далее**.  
  
3.  На **подключение к AD DS** укажите учетную запись, используя права администратора домена для Active Directory \(AD\) домена, к которому подсоединен этот компьютер, а затем нажмите кнопку **Далее**.  
  
4.  На странице **Укажите свойства службы** выполните следующее, а затем нажмите кнопку **Далее**.  
  
    -   Импортируйте PFX-файл, содержащий Secure Socket Layer \(SSL\) сертификат и ключ, полученный ранее. В [шаг 2: Регистрация SSL-сертификата для AD FS](../../ad-fs/deployment/Enroll-an-SSL-Certificate-for-AD-FS.md), полученным этот сертификат и скопировать его на компьютер, который вы хотите настроить в качестве сервера федерации. Чтобы импортировать pfx-файл с помощью мастера, нажмите кнопку **импорта**, а затем перейдите к расположению файла. Введите пароль для PFX-файл, при появлении запроса.  
  
    -   Укажите имя для вашей службы федерации. Например **fs.contoso.com**. Это имя должно соответствовать одному из субъекта или альтернативных имен субъекта в сертификате.  
  
    -   Укажите отображаемое имя для вашей службы федерации. Например **Contoso Corporation**. Пользователи видят это имя службы федерации Active Directory \(AD FS\) входа\-на странице.  
  
5.  На **укажите учетную запись службы** укажите учетную запись службы. Можно создать или использовать существующую группу управляемых учетных записей служб \(gMSA\) или использовать существующую учетную запись пользователя домена. Если выбран вариант создания учетной записи gMSA, укажите имя для новой учетной записи. Если выбран параметр для использования существующей групповой управляемой учетной записи или учетной записи домена, нажмите кнопку **выберите** для выбора учетной записи.  
  
    > [!NOTE]  
    > Преимуществом использования групповой управляемой учетной записи является его автоматическое\-согласование функции обновления пароля.  
  
    > [!WARNING]  
    > Если вы хотите использовать учетную запись gMSA, должен быть по крайней мере один контроллер домена в среде под управлением операционной системы Windows Server 2012.  
    >   
    > Если групповой управляемой учетной записи может быть отключена, и вы увидите сообщение об ошибке, такие как **групповые управляемые учетные записи служб не доступны, так как корневой ключ KDS не задан**, вы можете включить групповой управляемой учетной записи в домене, выполнив следующие Windows Команды PowerShell на контроллере домена, который работает под управлением Windows Server 2012 или более поздней версии, в вашем домене Active Directory: `Add-KdsRootKey –EffectiveTime (Get-Date).AddHours(-10)`. Возвращается к мастеру, нажмите кнопку **Назад**, а затем нажмите кнопку **Далее** для повторно\-введите **укажите учетную запись службы** страницы. Теперь должен быть включен параметр групповой управляемой учетной записи. Выберите его и введите имя учетной записи gMSA, которое вы хотите использовать.  
  
6.  На **укажите базу данных конфигурации** странице, укажите базу данных конфигурации AD FS и нажмите кнопку **Далее**. Можно либо создать базу данных на этом компьютере, с использованием внутренней базы данных Windows \(WID\), или можно указать расположение и имя экземпляра Microsoft SQL Server.  
  
    Дополнительные сведения см. в разделе [Роль базы данных конфигурации AD FS](../../ad-fs/technical-reference/The-Role-of-the-AD-FS-Configuration-Database.md).  
  
    > [!IMPORTANT]  
    > Если вы хотите создать ферму AD FS и использовать SQL Server для хранения данных конфигурации, можно использовать SQL Server 2008 и более поздние версии, включая SQL Server 2012 и SQL Server 2014.  
  
7.  На странице **Просмотр параметров** проверьте выбранные параметры конфигурации и нажмите кнопку **Далее**.  
  
8.  На **Pre\-необходимые проверки** странице, убедитесь, что все предварительные проверки успешно пройдены и нажмите кнопку **Настройка**.  
  
9. На **результатов** странице, просмотрите результаты и проверка успешного завершения настройки и нажмите кнопку **далее шаги, необходимые для развертывания службы федерации**. Дополнительные сведения см. в разделе [дальнейшие действия для завершения установки AD FS](https://go.microsoft.com/fwlink/p/?LinkId=286704). Чтобы выйти из мастера, нажмите кнопку **Закрыть**.  
  
### <a name="BKMK_3"></a>Настройка первого сервера федерации в ферму серверов федерации с помощью Windows PowerShell  
Можно создать новую ферму серверов федерации с помощью новой или существующей управляемой учетной записи службы или учетная запись пользователя домена.  
  
-   **Если вы хотите создать новый сервер федерации с помощью учетной записи gMSA, сделайте следующее:**  
  
    > [!IMPORTANT]  
    > Необходимо иметь права администратора домена для создания первого сервера федерации в ферме серверов федерации.  
  
    1.  На компьютере, где вы хотите настроить в качестве сервера федерации, убедитесь, что требуется SSL-сертификат импортирован в **локального компьютера\\My Store** каталога. Вы можете проверить, был ли импортирован SSL-сертификат, выполнив следующую команду в командной строке Windows PowerShell: `dir Cert:\LocalMachine\My`. Сертификат указан по своему отпечатку в **локального компьютера\\My Store** каталога.  
  
    2.  На контроллере домена откройте командное окно Windows PowerShell и выполните следующую команду, чтобы проверить, был ли создан корневой ключ KDS в домене: `Get-KdsRootKey –EffectiveTime (Get-Date).AddHours(-10)`. Если он не был создан таким образом, чтобы выходные данные не отображаются сведения о, выполните следующую команду для создания ключа: `Add-KdsRootKey –EffectiveTime (Get-Date).AddHours(-10)`.  
  
    3.  На компьютере, где вы хотите настроить в качестве сервера федерации откройте командное окно Windows PowerShell и выполните следующую команду:  
  
        ```  
        Install-AdfsFarm -CertificateThumbprint <certificate_thumbprint> -FederationServiceName <federation_service_name> -GroupServiceAccountIdentifier <domain>\<GMSA_Name>$  
        ```  
  
        > [!WARNING]  
        > `$` Необходим вход в конце предыдущей команды.  
  
        Для получения значения для `<certificate_thumbprint>`, запустите `dir Cert:\LocalMachine\My`, а затем выберите отпечаток SSL-сертификата. Значение `<federation_service_name>` — имя службы федерации, например, **fs.contoso.com**.  
  
        > [!NOTE]  
        > Если это не при первом выполнении этой команды, добавить `OverwriteConfiguration` параметра.  
  
        > [!NOTE]  
        > Предыдущая команда создает ферму внутренней базы данных Windows. Если вы хотите создать ферму серверов SQL Server, необходимо иметь экземпляр SQL Server уже установлен и работоспособен.  
        >   
        > Можно использовать следующую команду для создания первого сервера федерации в новой ферме, используется экземпляр SQL Server: `Install-AdfsFarm -CertificateThumbprint <certificate_thumbprint> -FederationServiceName <federation_service_name> -GroupServiceAccountIdentifier <domain>\<GMSA_name>$ -SQLConnectionString "Data Source=<SQL_Host_Name?\<SQL_instance_ name>;Integrated Security=True"` где **< SQL\_узла\_имя >** — это имя сервера, на какие SQL Сервер работает под управлением, и **< SQL\_экземпляр\_имя >** — имя экземпляра SQL Server. При использовании экземпляра по умолчанию SQL Server, используйте **SQLConnectionString** значение "**источника данных\=< SQL\_узла\_имя >; Integrated Security\=True** ".  
  
        > [!IMPORTANT]  
        > Если вы хотите создать ферму AD FS и использовать SQL Server для хранения данных конфигурации, то можете использовать SQL Server 2008 или более поздние версии, включая SQL Server 2012.  
  
-   **Если вы хотите создать новый сервер федерации с помощью существующей учетной записи домена, сделайте следующее:**  
  
    1.  На компьютере, где вы хотите настроить в качестве сервера федерации, убедитесь, что требуется SSL-сертификат импортирован в **локального компьютера\\My Store** каталога. Вы можете проверить, был ли импортирован SSL-сертификат, выполнив следующую команду в командной строке Windows PowerShell: `dir Cert:\LocalMachine\My`. Сертификат указан по своему отпечатку в **локального компьютера\\My Store** каталога.  
  
    2.  На компьютере, где вы хотите настроить в качестве сервера федерации, откройте командное окно Windows PowerShell и выполните следующую команду: `$fscred = Get-Credential`. Введите учетные данные учетной записи пользователя домена, которые вы хотите использовать для учетной записи службы федерации в формате домена\\имя пользователя.  
  
    3.  В том же окне команд Windows PowerShell выполните следующую команду:  
  
        ```  
        Install-AdfsFarm -CertificateThumbprint <certificate_thumbprint> -FederationServiceName <federation_service_name> -ServiceAccountCredential $fscred  
        ```  
  
        Для получения значения для **< сертификат\_отпечаток >**, запустите `dir Cert:\LocalMachine\My`, а затем выберите отпечаток SSL-сертификата. Значение **< федерации\_службы\_имя >** имя службы федерации, например fs.contoso.com.  
  
        > [!NOTE]  
        > Если это не при первом выполнении этой команды, добавить `OverwriteConfiguration` параметра.  
  
        > [!NOTE]  
        > Предыдущая команда создает ферму внутренней базы данных Windows. Если вы хотите создать ферму SQL Server, необходимо иметь экземпляра SQL Server уже установлен и работоспособен.  
        >   
        > Можно использовать следующую команду для создания первого сервера федерации в новой ферме, используется экземпляр SQL Server: `Install-AdfsFarm -CertificateThumbprint <certificate_thumbprint> -FederationServiceName <federation_service_name> -ServiceAccountCredential $fscredential -SQLConnectionString "Data Source=<SQL_Host_Name>\<SQL_instance_ name>;Integrated Security=True"` где **SQL\_узла\_имя** — это имя сервера, на котором SQL Server запущена, и **SQL\_экземпляр\_имя** — имя экземпляра SQL Server. При использовании экземпляра по умолчанию SQL Server, используйте **SQLConnectionString** значение "**источника данных\=< SQL\_узла\_имя >; Integrated Security\=True** ".  
  
        > [!IMPORTANT]  
        > Если вы хотите создать ферму AD FS и использовать SQL Server для хранения данных конфигурации, можно использовать SQL Server 2008 и более поздние версии, включая SQL Server 2012 и SQL Server 2014.  
  
## <a name="BKMK_2"></a>Добавление сервера федерации в существующую ферму серверов федерации  
  
> [!IMPORTANT]  
> Убедитесь, что вы выполнили [Step 3: Установите службу роли AD FS](../../ad-fs/deployment/Install-the-AD-FS-Role-Service.md), перед началом описанных процедур этого раздела.  
  
> [!IMPORTANT]  
> Убедитесь, что вы получили допустимый сервер SSL сертификат проверки подлинности перед выполнением этой процедуры.  
  
### <a name="to-add-a-federation-server-to-an-existing-federation-server-farm-via-the-active-directory-federation-service-configuration-wizard"></a>Добавление сервера федерации в существующую ферму серверов федерации через мастер настройки федерации службы Active Directory  
  
1.  На странице **Панель мониторинга** диспетчера серверов щелкните флажок **Уведомления**, а затем щелкните **Настроить службу федерации на сервере**.  
  
    Откроется **Мастер конфигурации служб федерации Active Directory** .  
  
2.  На **приветствия** выберите **Добавление сервера федерации в ферму серверов федерации**, а затем нажмите кнопку **Далее**.  
  
3.  На **подключение к AD DS** укажите учетную запись, используя права администратора домена для домена AD, к которому подсоединен этот компьютер, а затем щелкните **Далее**.  
  
4.  На **укажите ферму** странице, укажите имя основного сервера федерации в ферме, которая использует WID или укажите имя узла базы данных и имя экземпляра базы данных фермы серверов федерации, который использует SQL Server.  
  
    > [!WARNING]  
    > В Windows Server® 2012 R2, существует способ обхода, чтобы указать экземпляр SQL Server по умолчанию. Обходной путь — не использовать пользовательский интерфейс. Вместо этого используйте действия, описанные в [Настройка первого сервера федерации в ферму серверов федерации с помощью Windows PowerShell](Configure-a-Federation-Server.md#BKMK_3).  
  
    > [!IMPORTANT]  
    > Если вы хотите создать ферму AD FS и использовать SQL Server для хранения данных конфигурации, то можете использовать SQL Server 2008 или более поздние версии, включая SQL Server 2012.  
  
5.  На **укажите SSL-сертификат** странице, импортируйте PFX-файл, содержащий SSL-сертификат и ключ, полученный ранее. Этот сертификат является необходимым сертификатом аутентификации службы. В [шаг 2: Регистрация SSL-сертификата для AD FS](../../ad-fs/deployment/Enroll-an-SSL-Certificate-for-AD-FS.md), полученным этот сертификат и скопировать его на компьютер, который требуется настроить в качестве сервера федерации. Чтобы импортировать pfx-файл с помощью мастера, нажмите кнопку **импорта** и перейдите к расположению файла. Введите пароль для PFX-файл, при появлении запроса.  
  
6.  На **укажите учетную запись службы** укажите ту же учетную запись службы, настроенной при создании первого сервера федерации в ферме. Можно использовать существующую группу управляемой учетной записи службы или учетная запись пользователя домена.  
  
    > [!IMPORTANT]  
    > Указываемая учетная запись должен быть той же учетной записи учетной записи, который использовался на основном сервере федерации на этой ферме.  
  
7.  На странице **Просмотр параметров** проверьте выбранные параметры конфигурации и нажмите кнопку **Далее**.  
  
8.  На **Pre\-необходимые проверки** странице, убедитесь, что все предварительные проверки успешно пройдены и нажмите кнопку **Настройка**.  
  
9. На **результатов** странице, просмотрите результаты и проверка успешного завершения настройки и нажмите кнопку **далее шаги, необходимые для развертывания службы федерации**. Дополнительные сведения см. в разделе [дальнейшие действия для завершения установки AD FS](https://go.microsoft.com/fwlink/p/?LinkId=286704). Чтобы выйти из мастера, нажмите кнопку **Закрыть**.  
  
### <a name="to-add-a-federation-server-to-an-existing-federation-server-farm-via-windows-powershell"></a>Добавление сервера федерации в существующую ферму серверов федерации с помощью Windows PowerShell  
Можно добавить сервер федерации в существующую ферму, используя существующую управляемую учетную запись или учетная запись пользователя домена.  
  
-   Если вы хотите присоединить сервер федерации в ферму, используя существующую управляемую учетную запись, сделайте следующее:  
  
    1.  На компьютере, где вы хотите настроить в качестве сервера федерации, убедитесь, что требуется SSL-сертификат импортирован в **локального компьютера\\My Store** каталога. Вы можете проверить, был ли импортирован SSL-сертификат, выполнив следующую команду в командной строке Windows PowerShell: `dir Cert:\LocalMachine\My`. Сертификат указан по своему отпечатку в **локального компьютера\\My Store** каталога.  
  
    2.  На компьютере, где вы хотите настроить в качестве сервера федерации откройте командное окно Windows PowerShell и выполните следующую команду.  
  
        ```  
        Add-AdfsFarmNode -GroupServiceAccountIdentifier <domain>\<GMSA_name>$ -PrimaryComputerName <first_federation_server_hostname> -CertificateThumbprint <certificate_thumbprint>  
        ```  
  
        `<domain>\<GMSA_name>` является доменом AD и имя управляемой учетной записи в этом домене. `<first_federation_server_hostname>` — Это имя узла основного сервера федерации в существующей ферме.  
  
        Можно получить значение для `<certificate_thumbprint>` , выполнив `dir Cert:\LocalMachine\My` на предыдущем шаге.  
  
        > [!NOTE]  
        > Если это не при первом выполнении этой команды, добавить `OverwriteConfiguration` параметра.  
  
        > [!NOTE]  
        > Предыдущая команда создает узел фермы внутренней базы данных Windows. Если вы хотите создать узел фермы сервера компьютеров под управлением SQL Server, необходимо иметь экземпляра SQL Server уже установлен и работоспособен.  
        >   
        > Чтобы добавить сервер федерации в существующую ферму, использующего экземпляр SQL Server можно использовать следующую команду: `Add-AdfsFarmNode -GroupServiceAccountIdentifier <domain>\<GMSA_name>$ -SQLConnectionString "Data Source=<SQL_Host_Name>\<SQL_instance_ name>;Integrated Security=True"` где **SQL\_узла\_имя** — это имя сервера, на котором SQL Server запущена, и **SQL\_экземпляр\_имя** — имя экземпляра SQL Server. При использовании экземпляра по умолчанию SQL Server, используйте **SQLConnectionString** значение "**источника данных\=< SQL\_узла\_имя >; Integrated Security\=True** ".  
  
        > [!IMPORTANT]  
        > Если вы хотите создать ферму AD FS и использовать SQL Server для хранения данных конфигурации, можно использовать SQL Server 2008 и более поздние версии, включая SQL Server 2012 и SQL Server 2014.  
  
-   Если вы хотите присоединить сервер федерации к ферме с помощью существующей учетной записи домена, сделайте следующее:  
  
    1.  На компьютере, где вы хотите настроить в качестве сервера федерации, откройте окно Windows PowerShellcommand, и затем выполните следующую команду: `$fscred = get-credential`. Введите учетные данные учетной записи пользователя домена, которые вы хотите использовать для учетной записи службы федерации в формате домена\\имя пользователя.  
  
    2.  На компьютере, где вы хотите настроить в качестве сервера федерации, убедитесь, что требуется SSL-сертификат импортирован в **локального компьютера\\My Store** каталога. Вы можете проверить, был ли импортирован SSL-сертификат, выполнив следующую команду в окне Windows PowerShellcommand: `dir Cert:\LocalMachine\My`. Сертификат указан по своему отпечатку в **локального компьютера\\My Store** каталога.  
  
    3.  В этом же окне команд Windows PowerShell выполните следующую команду.  
  
        ```  
        Add-AdfsFarmNode -ServiceAccountCredential $fscred -PrimaryComputerName <first_federation_server_hostname> -CertificateThumbprint <certificate_thumbprint>  
        ```  
  
        > [!NOTE]  
        > Если это не при первом выполнении этой команды, добавить `OverwriteConfiguration` параметра.  
  
        > [!NOTE]  
        > Предыдущая команда создает узел фермы внутренней базы данных Windows. Если вы хотите создать узел фермы сервера компьютеров под управлением SQL Server, необходимо иметь экземпляра SQL Server уже установлен и работоспособен. Можно использовать следующую команду, чтобы добавить сервер федерации в существующую ферму с помощью экземпляра SQL Server: `Add-AdfsFarmNode -ServiceAccountCredential $fscred -SQLConnectionString "Data Source=<SQL_Host_Name>\<SQL_instance_ name>;Integrated Security=True"` где **SQL\_узла\_имя** имя сервера, на котором экземпляр SQL Сервер работает под управлением, и **SQL\_экземпляр\_имя** — имя экземпляра SQL Server. При использовании экземпляра по умолчанию SQL Server, используйте **SQLConnectionString** значение "**источника данных\=< SQL\_узла\_имя >; Integrated Security\=True** ".  
  
        > [!IMPORTANT]  
        > Если вы хотите создать ферму AD FS и использовать SQL Server для хранения данных конфигурации, можно использовать SQL Server 2008 и более поздние версии, включая SQL Server 2012 и SQL Server 2014.  
  
## <a name="see-also"></a>См. также 

[Развертывание AD FS](../../ad-fs/AD-FS-Deployment.md)  

[Руководство по развертыванию Windows Server 2012 R2 AD FS](../../ad-fs/deployment/Windows-Server-2012-R2-AD-FS-Deployment-Guide.md)  
 
[Развертывание фермы серверов федерации](../../ad-fs/deployment/Deploying-a-Federation-Server-Farm.md)  
  

