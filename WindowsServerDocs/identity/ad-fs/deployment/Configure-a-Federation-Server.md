---
ms.assetid: 434fd617-373a-405e-bae4-da324ea83efc
title: "Руководство по развертыванию Windows Server 2012 R2 AD FS"
description: 
author: billmath
ms.author: billmath
manager: femila
ms.date: 05/31/2017
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: identity-adfs
ms.openlocfilehash: 13ce514dc5f3f70217a26c898cde6fe24d4967c6
ms.sourcegitcommit: db290fa07e9d50686667bfba3969e20377548504
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/12/2017
---
# <a name="configure-a-federation-server"></a>Настройка сервера федерации

>Область применения: Windows Server 2016, Windows Server 2012 R2

После установки службы роли службы федерации Active Directory \(AD FS\) на компьютере, вы будете готовы настроить этот компьютер в качестве сервера федерации. Выполните одно из следующих:  
  
-   [Настройка первого сервера федерации в ферме серверов федерации](assetId:///e340cf8f-acf3-4cba-8135-a9353b85e714#BKMK_1)  
  
-   [Добавление сервера федерации в существующую ферму серверов федерации](assetId:///e340cf8f-acf3-4cba-8135-a9353b85e714#BKMK_2)  
  
## <a name="BKMK_1"></a>Настройка первого сервера федерации в ферме серверов федерации  
  
### <a name="to-configure-the-first-federation-server-in-a-new-federation-server-farm-by-using-the-active-directory-federation-service-configuration-wizard"></a>Настройка первого сервера федерации в ферме серверов федерации с помощью мастера настройки федерации службы Active Directory  
  
> [!NOTE]  
> Убедитесь, что иметь права администратора домена, или иметь доступных учетных данных администратора домена, перед выполнением этой процедуры.  
  
1.  В диспетчере сервера **мониторинга** щелкните **уведомления**, а затем щелкните **настроить службу федерации на сервере**.  
  
    **Мастер конфигурации служб федерации сертификации Active Directory** открывается.  
  
2.  На **приветствия** выберите **создание первого сервера федерации в ферме серверов федерации**, а затем нажмите кнопку **Далее**.  
  
3.  На **подключиться к AD DS** укажите учетную запись с помощью права администратора домена для домена Active Directory \(AD\), к которому подсоединен этот компьютер, а затем нажмите кнопку **Далее**.  
  
4.  На **укажите свойства службы** страницы, выполните следующие действия и нажмите кнопку **Далее**:  
  
    -   Импортируйте PFX-файл, содержащий \(SSL\) протокола SSL-сертификат и ключ, который вы получили более ранних версий. В [шаг 2: регистрация SSL-сертификата для AD FS](../../ad-fs/deployment/Enroll-an-SSL-Certificate-for-AD-FS.md), этот сертификат установлен и скопировать его на компьютер, который требуется настроить в качестве сервера федерации. Для импорта PFX-файл, через мастер, нажмите кнопку **импорта**и перейдите к расположению файла. Введите пароль для PFX-файл, при появлении.  
  
    -   Введите имя для вашей службы федерации. Например **fs.contoso.com**. Это имя должно соответствовать одному из получателя или альтернативного имени субъекта в сертификате.  
  
    -   Укажите отображаемое имя для вашей службы федерации. Например **Contoso Corporation**. Это имя отображается для пользователей на \(AD FS\) sign\ служб федерации Active Directory-странице.  
  
5.  На **укажите учетную запись службы** укажите учетную запись службы. Можно создавать или использовать существующий \(gMSA\) групповой управляемой учетной записи службы или использовать существующую учетную запись пользователя домена. Если выбрать параметр, чтобы создать управляемую учетную запись, укажите имя для новой учетной записи. Если выбрать параметр, чтобы использовать существующий групповой управляемой учетной записи или учетной записи домена, нажмите кнопку **выберите** Выбор учетной записи.  
  
    > [!NOTE]  
    > Преимущество использования групповой управляемой учетной записи функция его согласовывается автоматически пароль обновления.  
  
    > [!WARNING]  
    > Если вы хотите использовать групповой управляемой учетной записи, должен быть по крайней мере один контроллер домена в вашей среде, под управлением операционной системы Windows Server 2012.  
    >   
    > Если отключить параметр групповой управляемой учетной записи, и появится сообщение об ошибке **групповых управляемых учетных записей служб не доступны, так как не имеет корневого ключа KDS**, можно включить групповой управляемой учетной записи в домене, выполнив следующую команду Windows PowerShell на контроллере домена, который работает под управлением Windows Server 2012 или более поздней версии, в вашем домене Active Directory:`Add-KdsRootKey –EffectiveTime (Get-Date).AddHours(-10)`. Затем вернуться в мастер, нажмите кнопку **Назад**, а затем нажмите кнопку **Далее** для повторно-введите **укажите учетную запись службы** страницы. Теперь должен быть включен параметр групповой управляемой учетной записи. Выберите его и введите имя учетной записи групповой управляемой учетной записи, которые вы хотите использовать.  
  
6.  На **укажите базу данных конфигурации** указать базу данных конфигурации AD FS и щелкните **Далее**. Либо можно создать базу данных на этом компьютере с помощью \(WID\) внутренней базы данных Windows, или можно указать расположение и имя экземпляра Microsoft SQL Server.  
  
    Дополнительные сведения см. в разделе [роль базы данных конфигурации AD FS](../../ad-fs/technical-reference/The-Role-of-the-AD-FS-Configuration-Database.md).  
  
    > [!IMPORTANT]  
    > Если вы хотите создать ферму AD FS и использовать SQL Server для хранения данных конфигурации, можно использовать SQL Server 2008 и более поздние версии, включая SQL Server 2012 и SQL Server 2014.  
  
7.  На **просмотреть параметры**, проверьте выбранные параметры конфигурации и нажмите кнопку **Далее**.  
  
8.  На **проверки предварительно реквизит** убедитесь, что все предварительные проверки успешно выполнены и нажмите кнопку **Настройка**.  
  
9. На **результатов**, просмотрите результаты и проверка успешного завершения конфигурации и нажмите кнопку **далее действия, необходимые для развертывания службы федерации**. Дополнительные сведения см. в разделе [дальнейшие действия для завершения установки AD FS](https://go.microsoft.com/fwlink/p/?LinkId=286704). Нажмите кнопку **закрыть** завершить работу мастера.  
  
### <a name="BKMK_3"></a>Настройка первого сервера федерации в новой ферме серверов федерации через Windows PowerShell  
Можно создать новую ферму серверов федерации с помощью новой или существующей управляемой учетной записи или существующую учетную запись пользователя домена.  
  
-   **Если вы хотите создать новый сервер федерации с помощью учетной записи gMSA, выполните следующие действия.**  
  
    > [!IMPORTANT]  
    > Необходимо иметь права администратора домена для создания первого сервера федерации в ферме серверов федерации.  
  
    1.  На компьютере, который требуется настроить в качестве сервера федерации, убедитесь, что требуется SSL-сертификат был импортирован **локальное хранилище Computer\\My** каталога. Можно проверить, является ли SSL-сертификат был импортирован, выполнив следующую команду в командном окне Windows PowerShell:`dir Cert:\LocalMachine\My`. Сертификат указан в списке по отпечатку в **локальное хранилище Computer\\My** каталога.  
  
    2.  На контроллере домена откройте окно команд Windows PowerShell и выполните следующую команду, чтобы проверить, создан ли корневого ключа KDS в вашем домене:`Get-KdsRootKey –EffectiveTime (Get-Date).AddHours(-10)`. Если он не был создан так, что выходные данные будут содержать никакие сведения, выполните следующую команду для создания ключа:`Add-KdsRootKey –EffectiveTime (Get-Date).AddHours(-10)`.  
  
    3.  На компьютере, который требуется настроить в качестве сервера федерации откройте окно команд Windows PowerShell и выполните следующую команду:  
  
        ```  
        Install-AdfsFarm -CertificateThumbprint <certificate_thumbprint> -FederationServiceName <federation_service_name> -GroupServiceAccountIdentifier <domain>\<GMSA_Name>$  
        ```  
  
        > [!WARNING]  
        > `$`Входа в конце выполнения предыдущей команды не требуется.  
  
        Для получения значения для `<certificate_thumbprint>`, запустите `dir Cert:\LocalMachine\My`, а затем выберите отпечаток SSL-сертификат. Значение `<federation_service_name>` — это имя службы федерации, например, **fs.contoso.com**.  
  
        > [!NOTE]  
        > Если это не впервые, выполните следующую команду, добавьте `OverwriteConfiguration`параметра.  
  
        > [!NOTE]  
        > Предыдущая команда создает фермы внутренней базы данных Windows. Если вы хотите создать ферму серверов SQL Server, необходимо иметь экземпляр SQL Server уже установлены и работать.  
        >   
        > Можно использовать следующую команду для создания первого сервера федерации в новой ферме, использующий экземпляр SQL Server: `Install-AdfsFarm -CertificateThumbprint <certificate_thumbprint> -FederationServiceName <federation_service_name> -GroupServiceAccountIdentifier <domain>\<GMSA_name>$ -SQLConnectionString "Data Source=<SQL_Host_Name?\<SQL_instance_ name>;Integrated Security=True"`где **< SQL\_Host\_Name >** — это имя сервера, на котором выполняется SQL Server, и **< SQL\_instance\_name >** — это имя экземпляра SQL Server. Если используется экземпляр по умолчанию SQL Server, используйте **SQLConnectionString** значение «**данные Source\ = < SQL\_Host\_Name >; интегрированной Security\ = True**».  
  
        > [!IMPORTANT]  
        > Если вы хотите создать ферму AD FS и использовать SQL Server для хранения данных конфигурации, можно использовать SQL Server 2008 и более поздние версии, включая SQL Server 2012.  
  
-   **Если вы хотите создать новый сервер федерации с использованием существующей учетной записи пользователя домена, выполните следующие действия.**  
  
    1.  На компьютере, который требуется настроить в качестве сервера федерации, убедитесь, что требуется SSL-сертификат был импортирован **локальное хранилище Computer\\My** каталога. Можно проверить, является ли SSL-сертификат был импортирован, выполнив следующую команду в командном окне Windows PowerShell:`dir Cert:\LocalMachine\My`. Сертификат указан в списке по отпечатку в **локальное хранилище Computer\\My** каталога.  
  
    2.  На компьютере, который требуется настроить в качестве сервера федерации, откройте окно команд Windows PowerShell и выполните следующую команду:`$fscred = Get-Credential`. Введите данные учетной записи пользователя домена, которые вы хотите использовать в формате домен\пользователь имя учетной записи службы федерации.  
  
    3.  В том же окне команд Windows PowerShell выполните следующую команду:  
  
        ```  
        Install-AdfsFarm -CertificateThumbprint <certificate_thumbprint> -FederationServiceName <federation_service_name> -ServiceAccountCredential $fscred  
        ```  
  
        Для получения значения для **< certificate\_thumbprint >**, запустите `dir Cert:\LocalMachine\My`, а затем выберите отпечаток SSL-сертификат. Значение **< federation\_service\_name >** — это имя службы федерации, например, fs.contoso.com.  
  
        > [!NOTE]  
        > Если это не впервые, выполните следующую команду, добавьте `OverwriteConfiguration`параметра.  
  
        > [!NOTE]  
        > Предыдущая команда создает фермы внутренней базы данных Windows. Если вы хотите создать ферму SQL Server, необходимо иметь экземпляр SQL Server уже установлены и работать.  
        >   
        > Можно использовать следующую команду для создания первого сервера федерации в новой ферме, использующий экземпляр SQL Server: `Install-AdfsFarm -CertificateThumbprint <certificate_thumbprint> -FederationServiceName <federation_service_name> -ServiceAccountCredential $fscredential -SQLConnectionString "Data Source=<SQL_Host_Name>\<SQL_instance_ name>;Integrated Security=True"`где **SQL\_Host\_Name** — это имя сервера, на котором выполняется SQL Server, и **SQL\_instance\_name** — это имя экземпляра SQL Server. Если используется экземпляр по умолчанию SQL Server, используйте **SQLConnectionString** значение «**данные Source\ = < SQL\_Host\_Name >; интегрированной Security\ = True**».  
  
        > [!IMPORTANT]  
        > Если вы хотите создать ферму AD FS и использовать SQL Server для хранения данных конфигурации, можно использовать SQL Server 2008 и более поздние версии, включая SQL Server 2012 и SQL Server 2014.  
  
## <a name="BKMK_2"></a>Добавление сервера федерации в существующую ферму серверов федерации  
  
> [!IMPORTANT]  
> Убедитесь, что вы выполнили [шаг 3: Установка службы роли AD FS](../../ad-fs/deployment/Install-the-AD-FS-Role-Service.md), перед началом описанных процедур этого раздела.  
  
> [!IMPORTANT]  
> Убедитесь, что вы получили действительный SSL-серверу сертификат проверки подлинности перед выполнением этой процедуры.  
  
### <a name="to-add-a-federation-server-to-an-existing-federation-server-farm-via-the-active-directory-federation-service-configuration-wizard"></a>Добавление сервера федерации в существующую ферму серверов федерации, через мастер настройки служб Active Directory федерации  
  
1.  В диспетчере сервера **мониторинга** щелкните **уведомления**, а затем щелкните **настроить службу федерации на сервере**.  
  
    **Мастер конфигурации служб федерации сертификации Active Directory** открывается.  
  
2.  На **приветствия** выберите **добавить сервер федерации в ферме серверов федерации**, а затем нажмите кнопку **Далее**.  
  
3.  На **подключиться к AD DS** укажите учетную запись с помощью права администратора домена для домена AD, к которому подсоединен этот компьютер, а затем нажмите кнопку **Далее**.  
  
4.  На **указать фермы** страницы, укажите имя основного сервера федерации в ферме, использующей внутренней базы данных Windows или укажите имя узла базы данных и имя экземпляра базы данных фермы серверов федерации, который использует SQL Server.  
  
    > [!WARNING]  
    > В Windows Server® 2012 R2, существует обходного пути, чтобы указать экземпляр SQL Server по умолчанию. Обходной путь заключается в том, чтобы не использовать пользовательский интерфейс. Вместо этого используйте действия, описанные в [Настройка первого сервера федерации в новой ферме серверов федерации через Windows PowerShell](Configure-a-Federation-Server.md#BKMK_3).  
  
    > [!IMPORTANT]  
    > Если вы хотите создать ферму AD FS и использовать SQL Server для хранения данных конфигурации, можно использовать SQL Server 2008 и более поздние версии, включая SQL Server 2012.  
  
5.  На **SSL-сертификат, укажите** страницы, импорта PFX-файл, содержащий SSL-сертификат и ключ, который вы получили ранее. Этот сертификат является необходимым сертификатом аутентификации службы. В [шаг 2: регистрация SSL-сертификата для AD FS](../../ad-fs/deployment/Enroll-an-SSL-Certificate-for-AD-FS.md), этот сертификат установлен и скопировать его на компьютер, который требуется настроить в качестве сервера федерации. Для импорта PFX-файл, через мастер, нажмите кнопку **импорта** и перейдите к расположению файла. Введите пароль для PFX-файл, при появлении.  
  
6.  На **укажите учетную запись службы** укажите ту же запись службы, который вы настроили при создании первого сервера федерации в ферме. Можно использовать существующую группу управляемых учетных записей служб или существующую учетную запись пользователя домена.  
  
    > [!IMPORTANT]  
    > Указанная учетная запись, необходимо с учетной записью учетной записью, которая использовалась для основного сервера федерации в ферме.  
  
7.  На **просмотреть параметры**, проверьте выбранные параметры конфигурации и нажмите кнопку **Далее**.  
  
8.  На **проверки предварительно реквизит** убедитесь, что все предварительные проверки успешно выполнены и нажмите кнопку **Настройка**.  
  
9. На **результатов**, просмотрите результаты и проверка успешного завершения конфигурации и нажмите кнопку **далее действия, необходимые для развертывания службы федерации**. Дополнительные сведения см. в разделе [дальнейшие действия для завершения установки AD FS](https://go.microsoft.com/fwlink/p/?LinkId=286704). Нажмите кнопку **закрыть** завершить работу мастера.  
  
### <a name="to-add-a-federation-server-to-an-existing-federation-server-farm-via-windows-powershell"></a>Добавление сервера федерации в существующую ферму серверов федерации через Windows PowerShell  
Можно добавить сервер федерации к существующей ферме с помощью существующей учетной записи gMSA или существующую учетную запись пользователя домена.  
  
-   Если вы хотите присоединить к ферме серверов федерации с использованием существующей учетной записи gMSA, выполните следующие действия.  
  
    1.  На компьютере, который требуется настроить в качестве сервера федерации, убедитесь, что требуется SSL-сертификат был импортирован **локальное хранилище Computer\\My** каталога. Можно проверить, является ли SSL-сертификат был импортирован, выполнив следующую команду в командном окне Windows PowerShell:`dir Cert:\LocalMachine\My`. Сертификат указан в списке по отпечатку в **локальное хранилище Computer\\My** каталога.  
  
    2.  На компьютере, который требуется настроить в качестве сервера федерации откройте окно команд Windows PowerShell и выполните следующую команду.  
  
        ```  
        Add-AdfsFarmNode -GroupServiceAccountIdentifier <domain>\<GMSA_name>$ -PrimaryComputerName <first_federation_server_hostname> -CertificateThumbprint <certificate_thumbprint>  
        ```  
  
        `<domain>\<GMSA_name>` — своему домену AD и имя учетной записи gMSA в том же домене. `<first_federation_server_hostname>` — Имя узла основного сервера федерации на этой ферме существующих.  
  
        Можно получить значение для `<certificate_thumbprint>`, выполнив `dir Cert:\LocalMachine\My`на предыдущем шаге.  
  
        > [!NOTE]  
        > Если это не впервые, выполните следующую команду, добавьте `OverwriteConfiguration`параметра.  
  
        > [!NOTE]  
        > Предыдущая команда создает узел фермы внутренней базы данных Windows. Если вы хотите создать узле фермы серверов компьютеров под управлением SQL Server, необходимо иметь экземпляр SQL Server уже установлены и работать.  
        >   
        > Добавление сервера федерации в существующую ферму, используется экземпляр SQL Server можно использовать следующую команду: `Add-AdfsFarmNode -GroupServiceAccountIdentifier <domain>\<GMSA_name>$ -SQLConnectionString "Data Source=<SQL_Host_Name>\<SQL_instance_ name>;Integrated Security=True"`где **SQL\_Host\_Name** — это имя сервера, на котором выполняется SQL Server, и **SQL\_instance\_name** — это имя экземпляра SQL Server. Если используется экземпляр по умолчанию SQL Server, используйте **SQLConnectionString** значение «**данные Source\ = < SQL\_Host\_Name >; интегрированной Security\ = True**».  
  
        > [!IMPORTANT]  
        > Если вы хотите создать ферму AD FS и использовать SQL Server для хранения данных конфигурации, можно использовать SQL Server 2008 и более поздние версии, включая SQL Server 2012 и SQL Server 2014.  
  
-   Если вы хотите присоединить к ферме серверов федерации с использованием существующей учетной записи пользователя домена, выполните следующие действия.  
  
    1.  На компьютере, который требуется настроить в качестве сервера федерации, откройте окно Windows PowerShellcommand и затем выполните следующую команду:`$fscred = get-credential`. Введите данные учетной записи пользователя домена, которые вы хотите использовать в формате домен\пользователь имя учетной записи службы федерации.  
  
    2.  На компьютере, который требуется настроить в качестве сервера федерации, убедитесь, что требуется SSL-сертификат был импортирован **локальное хранилище Computer\\My** каталога. Можно проверить, является ли SSL-сертификат был импортирован, выполнив следующую команду в окне Windows PowerShellcommand:`dir Cert:\LocalMachine\My`. Сертификат указан в списке по отпечатку в **локальное хранилище Computer\\My** каталога.  
  
    3.  В том же окне команд Windows PowerShell выполните следующую команду.  
  
        ```  
        Add-AdfsFarmNode -ServiceAccountCredential $fscred -PrimaryComputerName <first_federation_server_hostname> -CertificateThumbprint <certificate_thumbprint>  
        ```  
  
        > [!NOTE]  
        > Если это не впервые, выполните следующую команду, добавьте `OverwriteConfiguration`параметра.  
  
        > [!NOTE]  
        > Предыдущая команда создает узел фермы внутренней базы данных Windows. Если вы хотите создать узле фермы серверов компьютеров под управлением SQL Server, необходимо иметь экземпляр SQL Server уже установлены и работать. Добавление сервера федерации в существующей ферме с помощью экземпляра SQL Server можно использовать следующую команду: `Add-AdfsFarmNode -ServiceAccountCredential $fscred -SQLConnectionString "Data Source=<SQL_Host_Name>\<SQL_instance_ name>;Integrated Security=True"`где **SQL\_Host\_Name** — это имя сервера, на котором запущен экземпляр SQL Server, и **SQL\_instance\_name** — это имя экземпляра SQL Server. Если используется экземпляр по умолчанию SQL Server, используйте **SQLConnectionString** значение «**данные Source\ = < SQL\_Host\_Name >; интегрированной Security\ = True**».  
  
        > [!IMPORTANT]  
        > Если вы хотите создать ферму AD FS и использовать SQL Server для хранения данных конфигурации, можно использовать SQL Server 2008 и более поздние версии, включая SQL Server 2012 и SQL Server 2014.  
  
## <a name="see-also"></a>См. также: 

[Развертывание AD FS](../../ad-fs/AD-FS-Deployment.md)  

[Руководство по развертыванию Windows Server 2012 R2 AD FS](../../ad-fs/deployment/Windows-Server-2012-R2-AD-FS-Deployment-Guide.md)  
 
[Развертывание фермы серверов федерации](../../ad-fs/deployment/Deploying-a-Federation-Server-Farm.md)  
  

