---
ms.assetid: 434fd617-373a-405e-bae4-da324ea83efc
title: Руководство по развертыванию служб федерации Active Directory в Windows Server 2012 R2
description: ''
author: billmath
ms.author: billmath
manager: femila
ms.date: 05/31/2017
ms.topic: article
ms.prod: windows-server
ms.technology: identity-adfs
ms.openlocfilehash: 9636d1a7b67f3f9c7766d6b986cb9d7c194a5c74
ms.sourcegitcommit: 9687d3eb221b89061a48bf1e73fb3b25bee69f9a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/28/2020
ms.locfileid: "78169614"
---
# <a name="configure-a-federation-server"></a>Настройка сервера федерации

После установки службы роли службы федерации Active Directory (AD FS) \(AD FS\) на компьютере можно приступить к настройке этого компьютера для работы в качестве сервера федерации. Можно выполнить одно из следующих действий.

-   [Настройка первого сервера федерации в новой ферме серверов федерации](Configure-a-Federation-Server.md#BKMK_1)

-   [Добавление сервера федерации в существующую ферму серверов федерации](Configure-a-Federation-Server.md#BKMK_2)

## <a name="BKMK_1"></a>Настройка первого сервера федерации в новой ферме серверов федерации

### <a name="to-configure-the-first-federation-server-in-a-new-federation-server-farm-by-using-the-active-directory-federation-service-configuration-wizard"></a>Настройка первого сервера федерации в новой ферме серверов федерации с помощью мастера настройки Active Directory служба федерации

> [!NOTE]
> Перед выполнением этой процедуры убедитесь, что у вас есть разрешения администратора домена или у вас есть доступ к учетным данным администратора домена.

1.  На странице **Панель мониторинга** диспетчера сервера установите флажок **Уведомления**, а затем выберите **Настроить службу федерации на этом сервере**.

    Откроется **Мастер конфигурации служб федерации Active Directory**.

2.  На странице **Приветствие** щелкните **Создать первый сервер федерации на ферме серверов федерации** и нажмите кнопку **Далее**.

3.  На странице **Подключение к AD DS** укажите учетную запись, используя разрешения администратора домена для Active Directory \(домен AD\), к которому присоединен этот компьютер, а затем нажмите кнопку **Далее**.

4.  На странице **Укажите свойства службы** выполните следующее, а затем нажмите кнопку **Далее**.

    -   Импортируйте PFX-файл, содержащий безопасный уровень сокета \(SSL\) сертификат и ключ, полученные ранее. На [шаге 2. Регистрация SSL-сертификата для AD FS](../../ad-fs/deployment/Enroll-an-SSL-Certificate-for-AD-FS.md)вы получили этот сертификат и скопировали его на компьютер, который требуется настроить в качестве сервера федерации. Чтобы импортировать PFX-файл с помощью мастера, нажмите кнопку **Импорт**, а затем перейдите к расположению файла. При появлении запроса введите пароль для PFX-файла.

    -   Введите имя для службы федерации. Например **fs.contoso.com**. Это имя должно совпадать одним из имен субъекта или альтернативных имен субъекта сертификата.

    -   Введите отображаемое имя для службы федерации. Например **Contoso Corporation**. Пользователи видят это имя на службы федерации Active Directory (AD FS) \(AD FS\) подписывать\-на странице.

5.  На странице **Выбор учетной записи службы** укажите учетную запись службы. Вы можете создать или использовать существующую групповую управляемую учетную запись службы \(gMSA\) или использовать существующую учетную запись пользователя домена. Если вы выбрали вариант создания новой учетной записи gMSA, укажите имя новой учетной записи. Если выбран параметр использовать существующую учетную запись gMSA или домена, нажмите кнопку **выбрать** , чтобы выбрать учетную запись.

    > [!NOTE]
    > Преимущество использования учетной записи gMSA — это функция автоматического\-согласованного обновления пароля.

    > [!WARNING]
    > Если вы хотите использовать учетную запись gMSA, в вашей среде должен быть хотя бы один контроллер домена, работающий под управлением операционной системы Windows Server 2012.
    >
    > Если параметр gMSA отключен, и отображается сообщение об ошибке, например **групповые управляемые учетные записи службы недоступны, так как не был задан корневой ключ KDS**, можно включить gMSA в домене, выполнив следующую команду Windows PowerShell на контроллере домена, работающем под управлением windows Server 2012 или более поздней версии, в домене Active Directory: `Add-KdsRootKey –EffectiveTime (Get-Date).AddHours(-10)`. Затем вернитесь к мастеру, нажмите кнопку **назад**, а затем нажмите кнопку **Далее** , чтобы снова\-введите страницу **Указание учетной записи службы** . Параметр gMSA теперь должен быть включен. Вы можете выбрать его и ввести имя учетной записи gMSA, которую вы хотите использовать.

6.  На странице **Указание базы данных конфигурации** укажите базу данных конфигурации AD FS, а затем нажмите кнопку **Далее**. Можно либо создать базу данных на этом компьютере с помощью внутренней базы данных Windows \(WID\), либо указать расположение и имя экземпляра Microsoft SQL Server.

    Дополнительные сведения см. в разделе [Роль базы данных конфигурации AD FS](../../ad-fs/technical-reference/The-Role-of-the-AD-FS-Configuration-Database.md).

    > [!IMPORTANT]
    > Если вы хотите создать ферму AD FS и использовать SQL Server для хранения данных конфигурации, можно использовать SQL Server 2008 и более поздних версий, включая SQL Server 2012 и SQL Server 2014.

7.  На странице **Просмотр параметров** проверьте выбранные параметры конфигурации и нажмите кнопку **Далее**.

8.  На странице **проверки предварительных требований\-** убедитесь, что все проверки готовности успешно выполнены, а затем нажмите кнопку **настроить**.

9. На странице **результаты** просмотрите результаты и проверьте, успешно ли завершена конфигурация, а затем нажмите кнопку **дальнейшие действия, необходимые для завершения развертывания службы федерации**. Дополнительные сведения см. в разделе [дальнейшие действия по завершению установки AD FS](https://go.microsoft.com/fwlink/p/?LinkId=286704). Чтобы выйти из мастера, нажмите кнопку **Закрыть**.

### <a name="BKMK_3"></a>Настройка первого сервера федерации в новой ферме серверов федерации с помощью Windows PowerShell
Новую ферму серверов федерации можно создать с помощью новой или существующей учетной записи gMSA или существующей учетной записи пользователя домена.

-   **Если вы хотите создать новый сервер федерации с помощью новой учетной записи gMSA, выполните следующие действия.**

    > [!IMPORTANT]
    > Для создания первого сервера федерации в новой ферме необходимо обладать разрешениями администратора домена.

    1.  На компьютере, который требуется настроить в качестве сервера федерации, убедитесь, что необходимый SSL-сертификат был импортирован на **локальный компьютер\\моем каталоге хранилища** . Чтобы проверить, был ли сертификат SSL импортирован, выполните следующую команду в командном окне Windows PowerShell: `dir Cert:\LocalMachine\My`. Сертификат отображается по его отпечатку на **локальном компьютере\\каталоге My Store** .

    2.  На контроллере домена Откройте командное окно Windows PowerShell и выполните следующую команду, чтобы проверить, был ли в вашем домене создан корневой ключ KDS: `Get-KdsRootKey –EffectiveTime (Get-Date).AddHours(-10)`. Если она не была создана так, чтобы выходные данные не отображались, выполните следующую команду, чтобы создать ключ: `Add-KdsRootKey –EffectiveTime (Get-Date).AddHours(-10)`.

    3.  На компьютере, который нужно настроить в качестве сервера федерации, откройте командную строку Windows PowerShell и выполните следующую команду:

        ```
        Install-AdfsFarm -CertificateThumbprint <certificate_thumbprint> -FederationServiceName <federation_service_name> -GroupServiceAccountIdentifier <domain>\<GMSA_Name>$
        ```

        > [!WARNING]
        > Требуется знак `$` в конце предыдущей команды.

        Чтобы получить значение для `<certificate_thumbprint>`, выполните `dir Cert:\LocalMachine\My`, а затем выберите отпечаток SSL-сертификата. Значение `<federation_service_name>` — это имя службы федерации, например **fs.contoso.com**.

        > [!NOTE]
        > Если эта команда не выполняется в первый раз, добавьте параметр `OverwriteConfiguration`.

        > [!NOTE]
        > Предыдущая команда создает ферму WID. Если вы хотите создать ферму серверов SQL Server, необходимо иметь уже установленный и работоспособный экземпляр SQL Server.
        >
        > Можно использовать следующую команду для создания первого сервера федерации в новой ферме, использующей экземпляр SQL Server: `Install-AdfsFarm -CertificateThumbprint <certificate_thumbprint> -FederationServiceName <federation_service_name> -GroupServiceAccountIdentifier <domain>\<GMSA_name>$ -SQLConnectionString "Data Source=<SQL_Host_Name?\<SQL_instance_ name>;Integrated Security=True"`, где **< sql\_Host\_name >** — имя сервера, на котором выполняется SQL Server, а **< SQL\_instance\_name >** — имя экземпляра SQL Server. Если используется экземпляр SQL Server по умолчанию, используйте значение **склконнектионстринг** , равное "**источник данных\=< SQL\_узел\_имя >; встроенная безопасность\=true**".

        > [!IMPORTANT]
        > Если вы хотите создать ферму AD FS и использовать SQL Server для хранения данных конфигурации, то можете использовать SQL Server 2008 или более поздние версии, включая SQL Server 2012.

-   **Если требуется создать новый сервер федерации с использованием существующей учетной записи пользователя домена, выполните следующие действия.**

    1.  На компьютере, который требуется настроить в качестве сервера федерации, убедитесь, что необходимый SSL-сертификат был импортирован на **локальный компьютер\\моем каталоге хранилища** . Чтобы проверить, был ли сертификат SSL импортирован, выполните следующую команду в командном окне Windows PowerShell: `dir Cert:\LocalMachine\My`. Сертификат отображается по его отпечатку на **локальном компьютере\\каталоге My Store** .

    2.  На компьютере, который требуется настроить в качестве сервера федерации, Откройте командное окно Windows PowerShell и выполните следующую команду: `$fscred = Get-Credential`. Введите учетные данные учетной записи пользователя домена, которые вы хотите использовать для учетной записи службы федерации, в формате домен\\имя пользователя.

    3.  В той же командной строке Windows PowerShell выполните следующую команду:

        ```
        Install-AdfsFarm -CertificateThumbprint <certificate_thumbprint> -FederationServiceName <federation_service_name> -ServiceAccountCredential $fscred
        ```

        Чтобы получить значение для **<\_отпечаток сертификата >** , запустите `dir Cert:\LocalMachine\My`, а затем выберите отпечаток SSL-сертификата. Значение **<\_службы федерации\_имя >** — это имя службы федерации, например FS.contoso.com.

        > [!NOTE]
        > Если эта команда не выполняется в первый раз, добавьте параметр `OverwriteConfiguration`.

        > [!NOTE]
        > Предыдущая команда создает ферму WID. Если вы хотите создать ферму SQL Server, у вас должен быть экземпляр SQL Server уже установлен и работает.
        >
        > Можно использовать следующую команду, чтобы создать первый сервер федерации в новой ферме, использующей экземпляр SQL Server: `Install-AdfsFarm -CertificateThumbprint <certificate_thumbprint> -FederationServiceName <federation_service_name> -ServiceAccountCredential $fscredential -SQLConnectionString "Data Source=<SQL_Host_Name>\<SQL_instance_ name>;Integrated Security=True"`, где **sql\_Host\_Name** — это имя сервера, на котором выполняется SQL Server, а **sql\_instance\_Name** — это имя экземпляра SQL Server. Если используется экземпляр SQL Server по умолчанию, используйте значение **склконнектионстринг** , равное "**источник данных\=< SQL\_узел\_имя >; встроенная безопасность\=true**".

        > [!IMPORTANT]
        > Если вы хотите создать ферму AD FS и использовать SQL Server для хранения данных конфигурации, можно использовать SQL Server 2008 и более поздних версий, включая SQL Server 2012 и SQL Server 2014.

## <a name="BKMK_2"></a>Добавление сервера федерации в существующую ферму серверов федерации

> [!IMPORTANT]
> Убедитесь, что вы завершили [Шаг 3. Установите службу роли AD FS](../../ad-fs/deployment/Install-the-AD-FS-Role-Service.md), прежде чем запускать процедуры, описанные в этом разделе.

> [!IMPORTANT]
> Перед выполнением этой процедуры убедитесь, что вы получили действительный сертификат проверки подлинности сервера SSL.

### <a name="to-add-a-federation-server-to-an-existing-federation-server-farm-via-the-active-directory-federation-service-configuration-wizard"></a>Чтобы добавить сервер федерации в существующую ферму серверов федерации в мастере настройки службы федерации Active Directory, выполните следующие действия.

1.  На странице **Панель мониторинга** диспетчера сервера установите флажок **Уведомления**, а затем выберите **Настроить службу федерации на этом сервере**.

    Откроется **Мастер конфигурации служб федерации Active Directory**.

2.  На странице **приветствия** выберите **Добавить сервер федерации в ферму серверов федерации**, а затем нажмите кнопку **Далее**.

3.  На странице **Подключение к AD DS** укажите учетную запись, используя разрешения администратора домена для домена AD, к которому присоединен этот компьютер, а затем нажмите кнопку **Далее**.

4.  На странице **Указание фермы** укажите имя основного сервера федерации в ферме, использующей WID, или укажите имя узла базы данных и имя экземпляра базы данных существующей фермы серверов федерации, которая использует SQL Server.

    > [!WARNING]
    > В Windows Server® 2012 R2 существует обходной путь для указания экземпляра по умолчанию SQL Server. Обходной путь не следует использовать в пользовательском интерфейсе. Вместо этого выполните действия, описанные в статье [Настройка первого сервера федерации в новой ферме серверов федерации с помощью Windows PowerShell](Configure-a-Federation-Server.md#BKMK_3).

    > [!IMPORTANT]
    > Если вы хотите создать ферму AD FS и использовать SQL Server для хранения данных конфигурации, то можете использовать SQL Server 2008 или более поздние версии, включая SQL Server 2012.

5.  На странице **Указание сертификата SSL** импортируйте PFX-файл, содержащий сертификат и ключ SSL, которые были получены ранее. Этот сертификат является необходимым сертификатом аутентификации службы. На [шаге 2. Регистрация SSL-сертификата для AD FS](../../ad-fs/deployment/Enroll-an-SSL-Certificate-for-AD-FS.md)вы получили этот сертификат и скопировали его на компьютер, который требуется настроить в качестве сервера федерации. Чтобы импортировать PFX-файл с помощью мастера, щелкните **Импорт** и перейдите к расположению файла. При появлении запроса введите пароль для PFX-файла.

6.  На странице **Указание учетной записи службы** укажите ту же учетную запись службы, которая была настроена при создании первого сервера федерации в ферме. Можно использовать существующую управляемую учетную запись службы группы или существующую учетную запись пользователя домена.

    > [!IMPORTANT]
    > Указанная учетная запись должна быть той же учетной записью, что и учетная запись, которая использовалась на основном сервере федерации в этой ферме.

7.  На странице **Просмотр параметров** проверьте выбранные параметры конфигурации и нажмите кнопку **Далее**.

8.  На странице **проверки предварительных требований\-** убедитесь, что все проверки готовности успешно выполнены, а затем нажмите кнопку **настроить**.

9. На странице **результаты** просмотрите результаты и проверьте, успешно ли завершена конфигурация, а затем нажмите кнопку **дальнейшие действия, необходимые для завершения развертывания службы федерации**. Дополнительные сведения см. в разделе [дальнейшие действия по завершению установки AD FS](https://go.microsoft.com/fwlink/p/?LinkId=286704). Чтобы выйти из мастера, нажмите кнопку **Закрыть**.

### <a name="to-add-a-federation-server-to-an-existing-federation-server-farm-via-windows-powershell"></a>Добавление сервера федерации в существующую ферму серверов федерации с помощью Windows PowerShell
Сервер федерации можно добавить в существующую ферму, используя существующую учетную запись gMSA или существующую учетную запись пользователя домена.

-   Если вы хотите присоединить сервер федерации к ферме с помощью существующей учетной записи gMSA, выполните следующие действия.

    1.  На компьютере, который требуется настроить в качестве сервера федерации, убедитесь, что необходимый SSL-сертификат был импортирован на **локальный компьютер\\моем каталоге хранилища** . Чтобы проверить, был ли сертификат SSL импортирован, выполните следующую команду в командном окне Windows PowerShell: `dir Cert:\LocalMachine\My`. Сертификат отображается по его отпечатку на **локальном компьютере\\каталоге My Store** .

    2.  На компьютере, который требуется настроить в качестве сервера федерации, Откройте командное окно Windows PowerShell и выполните следующую команду.

        ```
        Add-AdfsFarmNode -GroupServiceAccountIdentifier <domain>\<GMSA_name>$ -PrimaryComputerName <first_federation_server_hostname> -CertificateThumbprint <certificate_thumbprint>
        ```

        `<domain>\<GMSA_name>` домен AD и имя вашей учетной записи gMSA в этом домене. `<first_federation_server_hostname>` — это имя узла основного сервера федерации в этой существующей ферме.

        Значение для `<certificate_thumbprint>` можно получить, выполнив `dir Cert:\LocalMachine\My` на предыдущем шаге.

        > [!NOTE]
        > Если эта команда не выполняется в первый раз, добавьте параметр `OverwriteConfiguration`.

        > [!NOTE]
        > Предыдущая команда создает узел фермы WID. Если необходимо создать узел фермы серверов, на котором работают SQL Server, необходимо установить экземпляр SQL Server, который уже установлен и работает.
        >
        > Можно использовать следующую команду, чтобы добавить сервер федерации в существующую ферму, использующую экземпляр SQL Server: `Add-AdfsFarmNode -GroupServiceAccountIdentifier <domain>\<GMSA_name>$ -SQLConnectionString "Data Source=<SQL_Host_Name>\<SQL_instance_ name>;Integrated Security=True"`, где **sql\_Host\_Name** — это имя сервера, на котором выполняется SQL Server, а **sql\_instance\_Name** — это имя экземпляра SQL Server. Если используется экземпляр SQL Server по умолчанию, используйте значение **склконнектионстринг** , равное "**источник данных\=< SQL\_узел\_имя >; встроенная безопасность\=true**".

        > [!IMPORTANT]
        > Если вы хотите создать ферму AD FS и использовать SQL Server для хранения данных конфигурации, можно использовать SQL Server 2008 и более поздних версий, включая SQL Server 2012 и SQL Server 2014.

-   Если вы хотите присоединить сервер федерации к ферме с помощью существующей учетной записи пользователя домена, выполните следующие действия.

    1.  На компьютере, который требуется настроить в качестве сервера федерации, откройте окно Windows тем и выполните следующую команду: `$fscred = get-credential`. Введите учетные данные учетной записи пользователя домена, которые вы хотите использовать для учетной записи службы федерации, в формате домен\\имя пользователя.

    2.  На компьютере, который требуется настроить в качестве сервера федерации, убедитесь, что необходимый SSL-сертификат был импортирован на **локальный компьютер\\моем каталоге хранилища** . Чтобы проверить, был ли импортирован SSL-сертификат, выполните следующую команду в окне тем Windows: `dir Cert:\LocalMachine\My`. Сертификат отображается по его отпечатку на **локальном компьютере\\каталоге My Store** .

    3.  В том же командном окне Windows PowerShell выполните следующую команду.

        ```
        Add-AdfsFarmNode -ServiceAccountCredential $fscred -PrimaryComputerName <first_federation_server_hostname> -CertificateThumbprint <certificate_thumbprint>
        ```

        > [!NOTE]
        > Если эта команда не выполняется в первый раз, добавьте параметр `OverwriteConfiguration`.

        > [!NOTE]
        > Предыдущая команда создает узел фермы WID. Если необходимо создать узел фермы серверов, на котором работают SQL Server, необходимо установить экземпляр SQL Server, который уже установлен и работает. Можно использовать следующую команду для добавления сервера федерации в существующую ферму с помощью экземпляра SQL Server: `Add-AdfsFarmNode -ServiceAccountCredential $fscred -SQLConnectionString "Data Source=<SQL_Host_Name>\<SQL_instance_ name>;Integrated Security=True"`, где **SQL\_Host\_Name** — это имя сервера, на котором выполняется экземпляр SQL Server, а **SQL\_instance\_Name** — это имя экземпляра SQL Server. Если используется экземпляр SQL Server по умолчанию, используйте значение **склконнектионстринг** , равное "**источник данных\=< SQL\_узел\_имя >; встроенная безопасность\=true**".

        > [!IMPORTANT]
        > Если вы хотите создать ферму AD FS и использовать SQL Server для хранения данных конфигурации, можно использовать SQL Server 2008 и более поздних версий, включая SQL Server 2012 и SQL Server 2014.

## <a name="see-also"></a>См. также

[Развертывание AD FS](../../ad-fs/AD-FS-Deployment.md)

[Рекомендации по развертыванию AD FS Windows Server 2012 R2](../../ad-fs/deployment/Windows-Server-2012-R2-AD-FS-Deployment-Guide.md)

[Развертывание фермы серверов федерации](../../ad-fs/deployment/Deploying-a-Federation-Server-Farm.md)


