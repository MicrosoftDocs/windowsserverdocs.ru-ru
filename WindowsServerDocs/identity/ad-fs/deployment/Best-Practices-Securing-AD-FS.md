---
ms.assetid: b7bf7579-ca53-49e3-a26a-6f9f8690762f
title: Рекомендации по обеспечению безопасности AD FS и прокси веб-приложения
description: В этом документе приводятся рекомендации по безопасному планированию и развертыванию службы федерации Active Directory (AD FS) (AD FS) и прокси веб-приложения.
author: billmath
ms.author: billmath
manager: femila
ms.date: 05/31/2017
ms.topic: article
ms.prod: windows-server
ms.technology: identity-adfs
ms.openlocfilehash: 15b0c721b620e2891f4452fd54501f4970b7c177
ms.sourcegitcommit: 6aff3d88ff22ea141a6ea6572a5ad8dd6321f199
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/27/2019
ms.locfileid: "71359998"
---
## <a name="best-practices-for-securing-active-directory-federation-services"></a>Рекомендации по обеспечению безопасности службы федерации Active Directory (AD FS)


В этом документе приводятся рекомендации по безопасному планированию и развертыванию службы федерации Active Directory (AD FS) (AD FS) и прокси веб-приложения.  Он содержит сведения о поведении этих компонентов по умолчанию и рекомендации по дополнительным конфигурациям безопасности для Организации с конкретными вариантами использования и требованиями безопасности.

Этот документ относится к AD FS и WAP в Windows Server 2012 R2 и Windows Server 2016 (Предварительная версия).  Эти рекомендации можно использовать при развертывании инфраструктуры в локальной сети или в среде, размещенной в облаке, например Microsoft Azure.

## <a name="standard-deployment-topology"></a>Стандартная топология развертывания
Для развертывания в локальных средах рекомендуется стандартная топология развертывания, состоящая из одного или нескольких серверов AD FS во внутренней корпоративной сети с одним или несколькими серверами прокси веб-приложения (WAP) в сети периметра или экстрасети.  На каждом уровне AD FS и WAP подсистема балансировки нагрузки оборудования или программного обеспечения помещается перед фермой серверов и обрабатывает маршрутизацию трафика.  Брандмауэры размещаются как обязательные перед внешним IP-адресом балансировщика нагрузки перед каждой фермой (FS и прокси).

![Топология AD FS Standard](media/Best-Practices-Securing-AD-FS/adfssec1.png)

## <a name="ports-required"></a>Требуемые порты
На приведенной ниже схеме показаны порты брандмауэра, которые должны быть включены между компонентами AD FS и WAP.  Если развертывание не включает в себя Azure AD или Office 365, то требования к синхронизации можно игнорировать.

>Обратите внимание, что порт 49443 требуется только в том случае, если используется проверка подлинности сертификата пользователя, которая является необязательной для Azure AD и Office 365.

![Топология AD FS Standard](media/Best-Practices-Securing-AD-FS/adfssec2.png)

>[!NOTE]
> Порт 808 (Windows Server 2012 R2) или порт 1501 (Windows Server 2016 +) — это порт net. TCP, AD FS используемый локальной конечной точкой WCF для передачи данных конфигурации в процесс службы и PowerShell. Этот порт можно просмотреть, выполнив Get-AdfsProperties | Выберите Нетткппорт. Это локальный порт, который не нужно открывать в брандмауэре, но будет отображаться при сканировании порта. 

### <a name="azure-ad-connect-and-federation-serverswap"></a>Azure AD Connect и серверы федерации/WAP
В этой таблице описаны порты и протоколы, необходимые для обмена данными между сервером Azure AD Connect и серверами федерации и WAP.  

Protocol |Порты |Описание
--------- | --------- |---------
HTTP|80 (TCP/UDP)|Используется для загрузки списков отзыва сертификатов (CRL) для проверки SSL-сертификатов.
HTTPS|443 (TCP/UDP)|Используется для синхронизации с Azure AD.
WinRM|5985| Прослушиватель WinRM

### <a name="wap-and-federation-servers"></a>Серверы WAP и Федерации
В этой таблице описываются порты и протоколы, необходимые для обмена данными между серверами федерации и серверами WAP.

Protocol |Порты |Описание
--------- | --------- |---------
HTTPS|443 (TCP/UDP)|Используется для проверки подлинности.

### <a name="wap-and-users"></a>WAP и пользователи
В этой таблице описаны порты и протоколы, необходимые для обмена данными между пользователями и серверами WAP.

Protocol |Порты |Описание
--------- | --------- |--------- |
HTTPS|443 (TCP/UDP)|Используется для проверки подлинности устройства.
TCP|49443 (TCP)|Используется для проверки подлинности сертификата.

Дополнительные сведения о необходимых портах и протоколах, необходимых для гибридных развертываний, [см. в](https://azure.microsoft.com/documentation/articles/active-directory-aadconnect-ports/)этом документе.

Подробные сведения о портах и протоколах, необходимых для развертывания Azure AD и Office 365, см. в документе [здесь](https://support.office.com/en-us/article/Office-365-URLs-and-IP-address-ranges-8548a211-3fe7-47cb-abb1-355ea5aa88a2?ui=en-US&rs=en-US&ad=US).

### <a name="endpoints-enabled"></a>Конечные точки включены

При установке AD FS и WAP в службе Федерации и на прокси-сервере включаются набор по умолчанию конечных точек AD FS.  Эти значения по умолчанию были выбраны на основе наиболее часто используемых и использованных сценариев, и их не нужно изменять.  

### <a name="optional-min-set-of-endpoints-proxy-enabled-for-azure-ad--office-365"></a>Используемых Минимальный набор конечных точек прокси-сервера для Azure AD/Office 365
Организации, развертывающие AD FS и WAP только для сценариев Azure AD и Office 365, могут ограничить количество конечных точек AD FS, включенных на прокси-сервере, для достижения более минимальной уязвимой зоны.
Ниже приведен список конечных точек, которые должны быть включены на прокси-сервере в следующих сценариях.

|Конечная точка|Цель
|-----|-----
|/адфс/лс|Потоки проверки подлинности на основе браузера и текущие версии Microsoft Office использовать эту конечную точку для проверки подлинности Azure AD и Office 365
|/adfs/services/trust/2005/usernamemixed|Используется для Exchange Online с клиентами Office более ранних, чем Office 2013, может обновить 2015.  Последующие клиенты используют пассивную конечную точку \адфс\лс.
|/adfs/services/trust/13/usernamemixed|Используется для Exchange Online с клиентами Office более ранних, чем Office 2013, может обновить 2015.  Последующие клиенты используют пассивную конечную точку \адфс\лс.
|/adfs/oauth2|Он используется для любых современных приложений (локально или в облаке), настроенных для проверки подлинности непосредственно в AD FS (т. е. не через AAD).
|/адфс/сервицес/труст/мекс|Используется для Exchange Online с клиентами Office более ранних, чем Office 2013, может обновить 2015.  Последующие клиенты используют пассивную конечную точку \адфс\лс.
|/adfs/ls/federationmetadata/2007-06/federationmetadata.xml |Требование для всех пассивных потоков; и используются Office 365 или Azure AD для проверки сертификатов AD FS


AD FS конечные точки можно отключить на прокси-сервере, используя следующий командлет PowerShell:
    
    PS:\>Set-AdfsEndpoint -TargetAddressPath <address path> -Proxy $false

Пример:
    
    PS:\>Set-AdfsEndpoint -TargetAddressPath /adfs/services/trust/13/certificatemixed -Proxy $false
    

### <a name="extended-protection-for-authentication"></a>Расширенная защита для проверки подлинности
Расширенная защита для проверки подлинности — это функция, которая позволяет устранить проблемы с мужчина в середине (MITM) атаках и включена по умолчанию с AD FS.

#### <a name="to-verify-the-settings-you-can-do-the-following"></a>Чтобы проверить параметры, можно выполнить следующие действия.
Этот параметр можно проверить с помощью команды PowerShell командлет.  
    
   `PS:\>Get-ADFSProperties`

Свойство имеет `ExtendedProtectionTokenCheck`значение.  Значение по умолчанию — Allow, поэтому преимущества безопасности могут быть достигнуты без проблем совместимости с браузерами, которые не поддерживают эту возможность.  

### <a name="congestion-control-to-protect-the-federation-service"></a>Контроль перегрузки для защиты службы федерации
Прокси-сервер службы федерации (часть WAP) обеспечивает контроль перегрузки для защиты службы AD FS от переполнения запросов.  Прокси веб-приложения отклоняет запросы проверки подлинности внешних клиентов, если сервер федерации перегружен, как обнаружено задержкой между прокси веб-приложения и сервером федерации.  Этот компонент настроен по умолчанию с рекомендуемым пороговым значением задержки.

#### <a name="to-verify-the-settings-you-can-do-the-following"></a>Чтобы проверить параметры, можно выполнить следующие действия.
1.  На компьютере прокси веб-приложения откройте окно командной строки с повышенными привилегиями.
2.  Перейдите в каталог ADFS по адресу%Виндир%\адфс\конфиг.
3.  Измените параметры управления перегрузкой со значений по умолчанию на<congestionControl latencyThresholdInMSec="8000" minCongestionWindowSize="64" enabled="true" />"".
4.  Сохраните и закройте файл.
5.  Перезапустите службу AD FS, выполнив команду "NET Service адфссрв", а затем — "net start адфссрв".
Руководство по этой возможности можно найти [здесь](https://msdn.microsoft.com/library/azure/dn528859.aspx ).

### <a name="standard-http-request-checks-at-the-proxy"></a>Стандартные проверки запросов HTTP на прокси-сервере
Прокси-сервер также выполняет следующие стандартные проверки для всего трафика:

- А FS-P — проверка подлинности в AD FS с помощью короткого сертификата.  В случае потенциальной компрометации серверов DMZ AD FS может «отозвать доверие прокси-сервера», чтобы он больше не доверял всем входящим запросам от потенциально скомпрометированных прокси. Отмена доверия прокси-сервера отзывает собственный сертификат прокси-сервера, чтобы он не смог успешно пройти проверку подлинности для AD FS сервера.
- FS-P прерывает все подключения и создает новое HTTP-соединение со службой AD FS во внутренней сети. Это обеспечивает доступ к буферу на уровне сеанса между внешними устройствами и службой AD FS. Внешнее устройство никогда не подключается напрямую к службе AD FS.
- Службы федерации (FS) выполняют проверку HTTP-запросов, которая специально фильтрует заголовки HTTP, которые не требуются службе AD FS.

## <a name="recommended-security-configurations"></a>Рекомендуемые конфигурации безопасности
Убедитесь, что все AD FS и WAP-серверы получают самые актуальные обновления. наиболее важными рекомендациями по безопасности для инфраструктуры AD FS является обеспечение того, что у вас есть средства, позволяющие обеспечить актуальность AD FS и WAP-серверов с помощью всех обновлений безопасности, а также необязательных на этой странице для AD FS заданы важные обновления.

Для клиентов Azure AD рекомендуется отслеживать и отслеживать текущую инфраструктуру с помощью Azure AD Connect Health для AD FS, функции Azure AD Premium.  Azure AD Connect Health включает мониторы и оповещения, которые инициируются, если на компьютере AD FS или WAP отсутствует одно из важных обновлений, специально предназначенное для AD FS и WAP.

Сведения об установке Azure AD Connect Health для AD FS можно найти [здесь](https://azure.microsoft.com/documentation/articles/active-directory-aadconnect-health-agent-install/).

## <a name="additional-security-configurations"></a>Дополнительные конфигурации безопасности
Следующие дополнительные возможности можно настроить дополнительно для предоставления дополнительных средств защиты, предлагаемых в развертывании по умолчанию.

### <a name="extranet-soft-lockout-protection-for-accounts"></a>Мягкая защита блокировки экстрасети для учетных записей
С помощью функции блокировки экстрасети в Windows Server 2012 R2 администратор AD FS может задать максимально допустимое количество неудачных запросов на проверку подлинности (ExtranetLockoutThreshold) и период времени (Екстранетобсерватионвиндов) для интервала наблюдения. При достижении этого максимального числа (ExtranetLockoutThreshold) запросов проверки подлинности AD FS прекращает попытки проверки подлинности предоставленных учетных данных для AD FS в течение заданного периода времени (Екстранетобсерватионвиндов). Это действие защищает учетную запись от блокировки учетной записи AD, иными словами, защищает эту учетную запись от потери доступа к корпоративным ресурсам, которые используют AD FS для проверки подлинности пользователя. Эти параметры применяются ко всем доменам, которые служба AD FS может проходить проверку подлинности.

Для установки AD FS блокировки экстрасети можно использовать следующую команду Windows PowerShell (пример): 

    PS:\>Set-AdfsProperties -EnableExtranetLockout $true -ExtranetLockoutThreshold 15 -ExtranetObservationWindow ( new-timespan -Minutes 30 )

Для справки общедоступная документация по этой функции приведена [здесь](https://technet.microsoft.com/library/dn486806.aspx ). 

### <a name="disable-ws-trust-windows-endpoints-on-the-proxy-ie-from-extranet"></a>Отключите WS-Trust конечные точки Windows на прокси-сервере, т. е. из экстрасети.

Конечные точки Windows WS-Trust ( */ADFS/Services/Trust/2005/windowstransport* и */ADFS/Services/Trust/13/windowstransport*) предназначены только для конечных точек в интрасети, использующих привязку WIA в HTTPS. Предоставление доступа к экстрасети может позволить запросам к этим конечным точкам обходить защиту блокировок. Эти конечные точки должны быть отключены на прокси-сервере (т. е. отключены из экстрасети) для защиты блокировки учетных записей AD с помощью следующих команд PowerShell. При отключении этих конечных точек на прокси-сервере нет известных последствий для конечного пользователя.

    PS:\>Set-AdfsEndpoint -TargetAddressPath /adfs/services/trust/2005/windowstransport -Proxy $false
    PS:\>Set-AdfsEndpoint -TargetAddressPath /adfs/services/trust/13/windowstransport -Proxy $false
    
### <a name="differentiate-access-policies-for-intranet-and-extranet-access"></a>Различение политик доступа для интрасети и доступа к экстрасети
AD FS имеет возможность отличать политики доступа для запросов, исходящих из локальных, корпоративных сетей и запросов, которые поступают из Интернета через прокси-сервер.  Это можно сделать для каждого приложения или глобально.  Для больших бизнес-приложений или приложений с конфиденциальными данными или личными сведениями рекомендуется требовать многофакторную проверку подлинности.  Это можно сделать с помощью оснастки управления AD FS.  

### <a name="require-multi-factor-authentication-mfa"></a>Требовать многофакторную проверку подлинности (MFA)
AD FS можно настроить для использования строгой проверки подлинности (например, многофакторной проверки подлинности), специально для запросов, поступающих через прокси-сервер, для отдельных приложений и для условного доступа к Azure AD, Office 365 и локальным ресурсам.  Поддерживаются следующие методы MFA: Microsoft Azure MFA и сторонние поставщики.  Пользователю предлагается ввести дополнительные сведения (например, текст SMS, содержащий один код времени), а AD FS работает с подключаемым модулем поставщика, чтобы разрешить доступ.  

Поддерживаемые внешние поставщики MFA включают перечисленные на [этой](https://technet.microsoft.com/library/dn758113.aspx) странице, а также HDi глобальные.

### <a name="hardware-security-module-hsm"></a>Аппаратный модуль безопасности (HSM)
В конфигурации по умолчанию ключи, которые AD FS использует для подписывания маркеров, никогда не оставляют серверы федерации в интрасети.  Они никогда не находятся в ДЕМИЛИТАРИЗОВАНной зоне или на прокси-компьютерах.  При необходимости обеспечить дополнительную защиту эти ключи можно защитить в аппаратном модуле безопасности, подключенном к AD FS.  Корпорация Майкрософт не создает программный продукт HSM, однако на рынке, поддерживающей AD FS, существует несколько продуктов.  Чтобы реализовать эту рекомендацию, следуйте указаниям поставщика, чтобы создать сертификаты X509 для подписывания и шифрования, а затем используйте AD FS установки PowerShell командлеты, указав пользовательские сертификаты следующим образом:

    PS:\>Install-AdfsFarm -CertificateThumbprint <String> -DecryptionCertificateThumbprint <String> -FederationServiceName <String> -ServiceAccountCredential <PSCredential> -SigningCertificateThumbprint <String>

Где:


- `CertificateThumbprint`Ваш SSL-сертификат
- `SigningCertificateThumbprint`Ваш сертификат для подписи (с защищенным HSM-ключом)
- `DecryptionCertificateThumbprint`Ваш сертификат шифрования (с защищенным ключом HSM)



