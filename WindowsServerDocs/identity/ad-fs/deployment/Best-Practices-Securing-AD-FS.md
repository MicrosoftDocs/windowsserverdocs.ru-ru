---
ms.assetid: b7bf7579-ca53-49e3-a26a-6f9f8690762f
title: "Рекомендации по обеспечению безопасности Служб федерации Active Directory и прокси веб-приложения"
description: "Этот документ содержит рекомендации по безопасной планирование и развертывание служб федерации Active Directory (AD FS) и прокси веб-приложения."
author: billmath
ms.author: billmath
manager: femila
ms.date: 05/31/2017
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: identity-adfs
ms.openlocfilehash: 6026246228b22fdea6001528ab7621a1704f1983
ms.sourcegitcommit: 70c1b6cedad55b9c7d2068c9aa4891c6c533ee4c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/03/2017
---
## <a name="best-practices-for-securing-active-directory-federation-services"></a>Рекомендации по обеспечению безопасности служб федерации Active Directory

>Область применения: Windows Server 2016, Windows Server 2012 R2, Windows Server 2012

Этот документ содержит рекомендации по безопасной планирование и развертывание служб федерации Active Directory (AD FS) и прокси веб-приложения.  Он содержит сведения о поведении по умолчанию этих компонентов и рекомендации по конфигурации дополнительную безопасность для организации с конкретные случаи использования и требований к безопасности.

В этом документе относится к AD FS и WAP в Windows Server 2012 R2 и Windows Server 2016 (ознакомительная версия).  Эти рекомендации можно использовать ли развернута инфраструктура, в в локальной сети или в среде размещенного облака, такой как Microsoft Azure.

## <a name="standard-deployment-topology"></a>Стандартное развертывание топологии
Для развертывания в локальных сред мы рекомендуем стандартного развертывания топологии, состоящий из одного или нескольких серверов AD FS во внутренней корпоративной сети с помощью одного или нескольких серверов прокси-сервера приложений Web (WAP) в сети Периметра или экстрасети сети.  На каждом уровне службы федерации Active Directory и WAP, оборудования или программного обеспечения балансировки нагрузки помещается перед фермы серверов и обрабатывает маршрутизации трафика.  Брандмауэры, помещаются при необходимости на передней части внешний IP-адрес подсистемы балансировки нагрузки перед каждой ферме (федерации Active Directory и прокси-сервера).

![Топология AD FS Standard](media/Best-Practices-Securing-AD-FS/adfssec1.png)

## <a name="ports-required"></a>Порты, необходимые
Следующей схеме показана порты брандмауэра, которые должны быть активированы между и перечисление компонентов развертывания AD FS и WAP.  Если развертывание не включает Azure AD или Office 365, требования к синхронизации можно игнорируются.

>Обратите внимание, что порт 49443 только требуется, если используется проверка подлинности сертификата пользователя, который является необязательным для Azure AD и Office 365.

![Топология AD FS Standard](media/Best-Practices-Securing-AD-FS/adfssec2.png)

### <a name="azure-ad-connect-and-federation-serverswap"></a>Azure AD Connect и серверами федерации и WAP
В этой таблице описаны порты и протоколы, необходимые для обмена данными между серверами федерации и WAP и Azure AD Connect-server.  

Протокол |Порты |Описание
--------- | --------- |---------
HTTP|80 (TCP/UDP)|Можно загрузить списки отзыва сертификатов (списков отзыва сертификатов) для проверки сертификатов SSL.
HTTPS|443(TCP/UDP)|Используется для синхронизации с Azure AD.
WinRM|5985| Прослушиватель WinRM

### <a name="wap-and-federation-servers"></a>Серверы федерации и WAP
В этой таблице описаны порты и протоколы, необходимые для обмена данными между серверами федерации и серверами WAP.

Протокол |Порты |Описание
--------- | --------- |---------
HTTPS|443(TCP/UDP)|Используется для проверки подлинности.

### <a name="wap-and-users"></a>WAP и пользователей
В этой таблице описаны порты и протоколы, необходимые для обмена данными между пользователями и WAP-серверов.

Протокол |Порты |Описание
--------- | --------- |--------- |
HTTPS|443(TCP/UDP)|Используется для проверки подлинности устройств.
TCP|49443 (TCP)|Используется для проверки подлинности сертификата.

Дополнительные сведения о требуемые порты и протоколы, необходимые для гибридных развертываний см. в документе [здесь ](https://azure.microsoft.com/en-us/documentation/articles/active-directory-aadconnect-ports/).

Подробные сведения о порты и протоколы, необходимые для Azure AD и развертывания Office 365, см. в документе [здесь ](https://support.office.com/en-us/article/Office-365-URLs-and-IP-address-ranges-8548a211-3fe7-47cb-abb1-355ea5aa88a2?ui=en-US&rs=en-US&ad=US).

### <a name="endpoints-enabled"></a>Включить конечные точки

При установке AD FS и WAP набор конечных точек AD FS по умолчанию включены в службе федерации и прокси-сервера.  Эти настройки по умолчанию были выбраны на основе на наиболее часто требуется использовать сценарии и нет необходимости изменить их.  

### <a name="optional-min-set-of-endpoints-proxy-enabled-for-azure-ad--office-365"></a>[Необязательно] Набор мин конечные точки прокси-сервера, включена для Azure AD или Office 365
Развертывание Служб федерации Active Directory и WAP только для Azure AD организации и Office 365 сценариев можно еще больше ограничить количество конечных точек AD FS включена на прокси-сервер для достижения более минимальный атак.
Ниже приведен список конечных точек, которые необходимо включить на прокси-сервера в этих сценариях:

|Конечная точка|Назначение
|-----|-----
|/ adfs/ls|Проходит проверку подлинности с помощью браузера и текущей версии Microsoft Office использовать эту конечную точку для Azure AD и проверки подлинности в Office 365
|/ADFS/Services/Trust/2005/usernamemixed|Используется для Exchange Online с клиентами Office старше, чем обновления Office 2013 май 2015 г.  Более новые клиенты с помощью пассивного \adfs\ls endpoint.
|/ADFS/Services/Trust/13/usernamemixed|Используется для Exchange Online с клиентами Office старше, чем обновления Office 2013 май 2015 г.  Более новые клиенты с помощью пассивного \adfs\ls endpoint.
|/ adfs/oauth2|Это используется для всех современных приложений (в локальной среде или в облаке), настроенные для проверки подлинности непосредственно в AD FS (т. е. не через AAD)
|/ADFS/Services/Trust/MEX|Используется для Exchange Online с клиентами Office старше, чем обновления Office 2013 май 2015 г.  Более новые клиенты с помощью пассивного \adfs\ls endpoint.
|/ADFS/ls/federationmetadata/2007-06/federationmetadata.XML |Требования для любой процедур пассивной проверки; и используемый Office 365 или Azure AD для проверки сертификатов Служб федерации Active Directory


Конечные точки AD FS может быть отключена на прокси-сервера, с помощью командлета PowerShell:
    
    PS:\>Set-AdfsEndpoint -TargetAddressPath <address path> -Proxy $false

Например:
    
    PS:\>Set-AdfsEndpoint -TargetAddressPath /adfs/services/trust/13/certificatemixed -Proxy $false
    

### <a name="extended-protection-for-authentication"></a>Расширенная защита для проверки подлинности
Расширенная защита для проверки подлинности — это компонент, который устраняет от злоумышленник в середине атак (MITM) и включена по умолчанию в AD FS.

#### <a name="to-verify-the-settings-you-can-do-the-following"></a>Чтобы проверить параметры, можно сделать следующее:
Этот параметр можно проверить с помощью ниже командлетов PowerShell для.  
    
   `PS:\>Get-ADFSProperties`

Свойство `ExtendedProtectionTokenCheck`.  Значение по умолчанию — разрешить, чтобы преимущества безопасности можно добиться, предотвратив проблемы совместимости в браузерах, которые не поддерживают функцию.  

### <a name="congestion-control-to-protect-the-federation-service"></a>Контроль перегрузки для защиты службы федерации
Прокси-службы федерации (часть WAP) обеспечивает контроль перегрузки для защиты службы AD FS из потока запросов.  Прокси веб-приложения будут отклонять внешних клиентских запросов проверки подлинности, если сервер федерации перегружен, как обнаруженные задержка между веб-приложения прокси и сервер федерации.  Этот компонент настроен по умолчанию на уровне пороговое значение задержки рекомендуемые.

#### <a name="to-verify-the-settings-you-can-do-the-following"></a>Чтобы проверить параметры, можно сделать следующее:
1.  На компьютере прокси веб-приложения запустите окно команд с повышенными привилегиями.
2.  Перейдите в каталог служб федерации Active Directory, % WINDIR%\adfs\config.
3.  Изменение параметров контроля перегрузки из его значения по умолчанию "<congestionControl latencyThresholdInMSec="8000" minCongestionWindowSize="64" enabled="true" />".
4.  Сохраните и закройте файл.
5.  Перезапустите службу AD FS, выполнив «net stop adfssrv», а затем «net start adfssrv».
Для справки, можно найти рекомендации на этой возможности [здесь ](https://msdn.microsoft.com/en-us/library/azure/dn528859.aspx ).

### <a name="standard-http-request-checks-at-the-proxy"></a>Проверяет стандартный HTTP-запрос на прокси-сервера
Прокси-сервер также выполняет следующие стандартные проверки для всего трафика:

- FS-P сам выполняет проверку подлинности для AD FS через недолго сертификат.  В сценарии возможная компрометация dmz серверов AD FS может «отозвать доверия прокси-сервера», чтобы он больше не доверяет всех входящих запросов от потенциально скомпрометированы прокси-серверов. Отмена доверия прокси-сервера лишает каждый прокси собственный сертификат, чтобы он не сможет проверить подлинность успешно в любых целях, чтобы сервер AD FS
- FS-P завершает все подключения и создает новое подключение HTTP для службы AD FS во внутренней сети. Это обеспечивает уровня сеанса буфером между внешних устройств и службы AD FS. Внешнее устройство не подключается непосредственно к службы AD FS.
- FS-P выполняет проверку запроса HTTP, который специально отфильтровывает заголовки HTTP, которые не требуются службы AD FS.

## <a name="recommended-security-configurations"></a>Конфигурации безопасности
Убедитесь, все службы федерации Active Directory и серверы WAP получают последние обновления, убедитесь, что средства на месте, чтобы поддерживать актуальность обновлений для системы безопасности, а также эти необязательные обновления, указанный как важные для Служб федерации Active Directory на этой странице серверов AD FS и WAP наиболее важные рекомендации безопасности для инфраструктуры AD FS.

Рекомендуется для клиентов Azure AD, отслеживать и поддерживать актуальность своей инфраструктуры — с помощью Azure AD подключения работоспособности для служб AD FS, это функция Azure AD Premium.  Работоспособность подключения Azure AD включают мониторы и предупреждения, если компьютера к AD FS или WAP отсутствует один из важных обновлений специально для Служб федерации Active Directory и WAP.

Сведения об установке работоспособности подключения Azure AD для службы федерации Active Directory можно найти [здесь ](https://azure.microsoft.com/en-us/documentation/articles/active-directory-aadconnect-health-agent-install/).

## <a name="additional-security-configurations"></a>Дополнительную безопасность конфигурации
Для обеспечения дополнительной защиты для соглашения, предлагаемые по умолчанию развертывания можно настроить следующие дополнительные возможности при необходимости.

### <a name="extranet-soft-lockout-protection-for-accounts"></a>Блокировка экстрасети «мягкое» защиты учетных записей
Благодаря функции блокировки экстрасети в Windows Server 2012 R2, администратор AD FS можно задать максимальное количество запросов проверки подлинности (ExtranetLockoutThreshold) и "окно наблюдения период времени (ExtranetObservationWindow). При достижении этого максимальное число (ExtranetLockoutThreshold) запросы проверки подлинности AD FS прекращают для проверки подлинности предоставленных учетной записи от службы федерации Active Directory в течение заданного времени (ExtranetObservationWindow). Это действие позволяет защитить эту учетную запись от блокировки учетной записи AD, другими словами, эта учетная запись защищает от потеря доступа к корпоративным ресурсам, которые используют службы федерации Active Directory для проверки подлинности пользователя. Эти параметры применяются ко всем доменам, которые службы AD FS может пройти проверку подлинности.

Можно использовать следующую команду Windows PowerShell для установки блокировки экстрасети AD FS (пример): 

    PS:\>Set-AdfsProperties -EnableExtranetLockout $true -ExtranetLockoutThreshold 15 -ExtranetObservationWindow ( new-timespan -Minutes 30 )

Справочник по общедоступной документации эта функция является [здесь](https://technet.microsoft.com/en-us/library/dn486806.aspx ). 

### <a name="differentiate-access-policies-for-intranet-and-extranet-access"></a>Различия политики доступа для интрасети и экстрасети доступа
AD FS имеет возможность отличить политики доступа для запросов, приходящих в запросах vs корпоративной локальной сети, получаемые Интернет через прокси-сервер.  Это можно сделать в приложении или глобально.  Для значения высокой бизнес-приложений или приложений с помощью конфиденциальные или личные сведения рассмотрите возможность несколькими двухфакторной проверки подлинности.  Это можно сделать с помощью оснастки управления AD FS.  

### <a name="require-multi-factor-authentication-mfa"></a>Требуется поддержка разных фактор проверки подлинности
Службы федерации Active Directory можно настроить таким образом, чтобы требовать строгой проверки подлинности (например, проверка подлинности коэффициент несколькими), специально для-запросов через прокси-сервер для отдельных приложений и для условного доступа к Azure AD или Office 365 и локальных ресурсов.  Поддерживаемые методы многофакторной проверки подлинности включают многофакторной проверки Подлинности Microsoft Azure и сторонних поставщиков.  Пользователю будет предложено предоставить дополнительную информацию (например текст SMS-сообщения, содержащие один код времени), и службы федерации Active Directory работает с поставщика подключаемый модуль, чтобы разрешить доступ.  

Поддерживаемые внешних поставщиков многофакторной проверки Подлинности, перечислены в [это](https://technet.microsoft.com/en-us/library/dn758113.aspx) страницы, а также глобальные HDI.

### <a name="hardware-security-module-hsm"></a>Аппаратный модуль безопасности (HSM)
В конфигурации по умолчанию использует ключи службы федерации Active Directory для подписи токенов никогда не оставьте серверов федерации в интрасети.  Они не присутствуют в сети Периметра или на прокси-серверов.  (Необязательно) для обеспечения дополнительной защиты, эти ключи могут быть защищены в аппаратный модуль безопасности, подключенные к AD FS.  Корпорация Майкрософт не дает продукт HSM, однако существует несколько на рынке, которые поддерживают AD FS.  Чтобы реализовать Эта рекомендация, следуйте рекомендациям поставщика для создания X509 сертификаты для подписывания и шифрования, затем использовать командлеты powershell установки AD FS, указывая пользовательских сертификатов, как показано ниже:

    PS:\>Install-AdfsFarm -CertificateThumbprint <String> -DecryptionCertificateThumbprint <String> -FederationServiceName <String> -ServiceAccountCredential <PSCredential> -SigningCertificateThumbprint <String>

где:


- `CertificateThumbprint` является SSL-сертификата
- `SigningCertificateThumbprint` Это ваш сертификат подписи (с ключом Защищенных)
- `DecryptionCertificateThumbprint` является сертификата шифрования (с ключом Защищенных)



