---
ms.assetid: b7bf7579-ca53-49e3-a26a-6f9f8690762f
title: Рекомендации по обеспечению безопасности AD FS и прокси веб-приложения
description: В этом документе приведены рекомендации по безопасной планирование и развертывание служб федерации Active Directory (AD FS) и прокси веб-приложения.
author: billmath
ms.author: billmath
manager: femila
ms.date: 05/31/2017
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: identity-adfs
ms.openlocfilehash: 958bf8455d03ddc04395fafe83e70a49c7659c96
ms.sourcegitcommit: 0b5fd4dc4148b92480db04e4dc22e139dcff8582
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/24/2019
ms.locfileid: "66192440"
---
## <a name="best-practices-for-securing-active-directory-federation-services"></a>Рекомендации по обеспечению безопасности служб федерации Active Directory


В этом документе приведены рекомендации по безопасной планирование и развертывание служб федерации Active Directory (AD FS) и прокси веб-приложения.  Она содержит сведения о поведении по умолчанию эти компоненты и рекомендации для обеспечения дополнительной безопасности конфигураций для организации с конкретные варианты использования и требования к безопасности.

Этот документ относится к AD FS и WAP в Windows Server 2012 R2 и Windows Server 2016 (Предварительная версия).  Эти рекомендации можно использовать ли инфраструктура развертывается в локальной сети или в размещенной облачной среде, например Microsoft Azure.

## <a name="standard-deployment-topology"></a>Стандартное развертывание топологии
Для развертывания в локальных средах мы рекомендуем топологии стандартного развертывания, состоящий из одного или нескольких серверов AD FS во внутренней корпоративной сети, с помощью одного или нескольких прокси-сервера приложений Web (WAP) серверов в сети Периметра или экстрасети сети.  На каждом уровне, AD FS и WAP, оборудования или программного обеспечения подсистемы балансировки нагрузки находится перед фермы серверов и обрабатывает маршрутизацию трафика.  Брандмауэры, помещаются как требуется в начале внешний IP-адрес подсистемы балансировки нагрузки перед каждой фермы (FS и прокси-сервера).

![Топология AD FS Standard](media/Best-Practices-Securing-AD-FS/adfssec1.png)

## <a name="ports-required"></a>Порты, необходимые
Следующей схеме показана порты брандмауэра, которые необходимо включить между и среди компоненты развертывания AD FS и WAP.  Если развертывание включает в себя Azure AD или Office 365, требования к синхронизации можно не учитывать.

>Обратите внимание, что порт 49443 только требуется, если используется проверка подлинности сертификата пользователя, который является необязательным для Azure AD и Office 365.

![Топология AD FS Standard](media/Best-Practices-Securing-AD-FS/adfssec2.png)

### <a name="azure-ad-connect-and-federation-serverswap"></a>Azure AD Connect и серверы федерации и WAP
В этой таблице описываются порты и протоколы, которые необходимы для обмена данными между сервером Azure AD Connect и серверами федерации и WAP.  

Protocol |Порты |Описание
--------- | --------- |---------
HTTP|80 (TCP ИЛИ UDP)|Используется для загрузки CRL (списки отзыва сертификатов) для проверки сертификатов SSL.
HTTPS|443(TCP/UDP)|Используется для синхронизации с Azure AD.
WinRM|5985| Прослушиватель WinRM

### <a name="wap-and-federation-servers"></a>WAP и серверы федерации
В этой таблице описываются порты и протоколы, которые необходимы для обмена данными между серверами федерации и WAP-серверах.

Protocol |Порты |Описание
--------- | --------- |---------
HTTPS|443(TCP/UDP)|Используется для проверки подлинности.

### <a name="wap-and-users"></a>WAP и пользователи
В этой таблице описываются порты и протоколы, которые необходимы для обмена данными между пользователями и серверами WAP.

Protocol |Порты |Описание
--------- | --------- |--------- |
HTTPS|443(TCP/UDP)|Используется для проверки подлинности устройства.
TCP|49443 (TCP)|Используется для проверки подлинности сертификата.

Дополнительные сведения о портах и протоколах, необходимых для гибридных развертываний, см. в документе [здесь](https://azure.microsoft.com/documentation/articles/active-directory-aadconnect-ports/).

Подробные сведения о портах и протоколах, необходимые для Azure AD и развертывания Office 365, см. в документе [здесь](https://support.office.com/en-us/article/Office-365-URLs-and-IP-address-ranges-8548a211-3fe7-47cb-abb1-355ea5aa88a2?ui=en-US&rs=en-US&ad=US).

### <a name="endpoints-enabled"></a>Включенных конечных точек

При установке AD FS и WAP, набор конечных точек AD FS по умолчанию включены в службы федерации и прокси-класса.  Эти значения по умолчанию были выбраны в зависимости от наиболее часто требуется и используется сценариев и нет необходимости изменять их.  

### <a name="optional-min-set-of-endpoints-proxy-enabled-for-azure-ad--office-365"></a>[Необязательно] Min набор конечных точек прокси-сервера, на поддержку Azure AD и Office 365
Организаций, развертывающих AD FS и WAP только для Azure AD и сценариев Office 365 можно еще больше ограничить число конечных точек AD FS включен прокси-сервер для достижения более минимальными поверхность атаки.
Ниже приведен список конечных точек, которые необходимо включить на прокси-сервер в следующих сценариях:

|Конечная точка|Цель
|-----|-----
|/adfs/ls|Потоки проверки подлинности на основе обозревателя и текущими версиями Microsoft Office использовать эту конечную точку для Azure AD и проверки подлинности Office 365
|/adfs/services/trust/2005/usernamemixed|Использовать для Exchange Online с Office клиенты старше, чем обновление Office 2013 май 2015 г.  Более новые клиенты использовать конечную точку пассивной \adfs\ls.
|/adfs/services/trust/13/usernamemixed|Использовать для Exchange Online с Office клиенты старше, чем обновление Office 2013 май 2015 г.  Более новые клиенты использовать конечную точку пассивной \adfs\ls.
|/adfs/oauth2|Это используется для любого современные приложения (локально или в облаке) был настроен для проверки подлинности непосредственно в AD FS (т. е. не через AAD)
|/adfs/services/trust/mex|Использовать для Exchange Online с Office клиенты старше, чем обновление Office 2013 май 2015 г.  Более новые клиенты использовать конечную точку пассивной \adfs\ls.
|/adfs/ls/federationmetadata/2007-06/federationmetadata.xml |Требования для любой пассивных потоков; и используемый Office 365 или Azure AD для проверки сертификатов служб AD FS


Можно отключить конечных точек AD FS на прокси-сервер, используя следующий командлет PowerShell:
    
    PS:\>Set-AdfsEndpoint -TargetAddressPath <address path> -Proxy $false

Пример:
    
    PS:\>Set-AdfsEndpoint -TargetAddressPath /adfs/services/trust/13/certificatemixed -Proxy $false
    

### <a name="extended-protection-for-authentication"></a>Расширенная защита для проверки подлинности
Расширенная защита для проверки подлинности — это функция, снижает опасность от злоумышленник в середине атак и включено по умолчанию в AD FS.

#### <a name="to-verify-the-settings-you-can-do-the-following"></a>Чтобы проверить параметры, можно сделать следующее:
Этот параметр можно проверить с помощью ниже командлета PowerShell.  
    
   `PS:\>Get-ADFSProperties`

Свойство является `ExtendedProtectionTokenCheck`.  Значение по умолчанию – разрешить, таким образом, чтобы повышенной безопасности может осуществляться без проблем совместимости с браузерами, которые не поддерживают возможность.  

### <a name="congestion-control-to-protect-the-federation-service"></a>Контроль перегрузки для защиты службы федерации
Прокси-службы федерации (частью протокола WAP) предоставляет контроля перегрузки для защиты службы AD FS от потока запросов.  Прокси веб-приложения будет отклонять запросы проверки подлинности внешнего клиента, если сервер федерации перегружен по показаниям задержки между прокси веб-приложения и сервером федерации.  Этот компонент настраивается по умолчанию с уровнем рекомендуемые задержка порогового значения.

#### <a name="to-verify-the-settings-you-can-do-the-following"></a>Чтобы проверить параметры, можно сделать следующее:
1.  Запустите окно командной строки с повышенными привилегиями на компьютер прокси веб-приложения.
2.  Перейдите в каталог служб федерации Active Directory, в папке % WINDIR%\adfs\config.
3.  Изменить значения по умолчанию для параметров контроля перегрузки "<congestionControl latencyThresholdInMSec="8000" minCongestionWindowSize="64" enabled="true" />".
4.  Сохраните и закройте файл.
5.  Перезапустите службу AD FS, «net stop adfssrv», а затем «net start adfssrv».
Для справки можно найти рекомендации по этой возможности [здесь](https://msdn.microsoft.com/en-us/library/azure/dn528859.aspx ).

### <a name="standard-http-request-checks-at-the-proxy"></a>Проверка стандартного HTTP-запроса на прокси-сервер
Прокси-сервер также выполняет следующие стандартные проверки для всего трафика.

- FS-P, сам выполняет проверку подлинности для AD FS через ограниченный срок действия сертификата.  В случае возможная компрометация серверы сети периметра AD FS, можно «отозвать доверия прокси-сервера», чтобы она больше не доверяет все входящие запросы от потенциально компрометации учетных записей-посредников. Отмена доверия прокси-сервера лишает каждый прокси-сервера в собственный сертификат, таким образом, чтобы он не может успешно проходить проверку подлинности для любых целей, на сервер AD FS
- FS-P завершает все подключения и создает новое подключение HTTP к службе AD FS во внутренней сети. Это предоставляет буфер уровня сеанса между внешними устройствами и службой AD FS. Внешнее устройство никогда не подключается непосредственно к службе AD FS.
- FS-P выполняет проверку запроса HTTP, который специально отфильтровывает заголовки HTTP, которые не требуются службы AD FS.

## <a name="recommended-security-configurations"></a>Конфигурации безопасности
Убедитесь, что все серверы AD FS и WAP получать самые последние обновления, убедитесь, что вы разработали средства актуальности ваших серверов AD FS и WAP с помощью всех обновлений системы безопасности, а также их необязательно является наиболее важные рекомендации по безопасности для инфраструктуры AD FS обновления, указанные как важные для служб AD FS на этой странице.

Для клиентов Azure AD можно отслеживать и поддерживать в актуальном состоянии инфраструктуры рекомендуется с помощью Azure AD Connect Health для AD FS, в состав Azure AD Premium.  Azure AD Connect Health включает мониторы и предупреждения, которые активируют Если машине AD FS или WAP отсутствует один из важных обновлениях специально для AD FS и WAP.

Сведения об установке Azure AD Connect Health для AD FS можно найти [здесь](https://azure.microsoft.com/documentation/articles/active-directory-aadconnect-health-agent-install/).

## <a name="additional-security-configurations"></a>Конфигурации для обеспечения дополнительной безопасности
Чтобы обеспечить дополнительную безопасность для предлагаемым в стандартном развертывании можно настроить следующие дополнительные возможности при необходимости.

### <a name="extranet-soft-lockout-protection-for-accounts"></a>Блокировка экстрасети «мягкий» защиты для учетных записей
С помощью функции блокировки экстрасети в Windows Server 2012 R2 AD FS администратор может задать максимально допустимое количество запросов проверки подлинности (ExtranetLockoutThreshold) и "окно наблюдения период времени (ExtranetObservationWindow). При достижении данного максимального числа (ExtranetLockoutThreshold) запросы проверки подлинности AD FS прекращает попытки для проверки подлинности указанной учетной записи в AD FS для периода времени (ExtranetObservationWindow). Это действие позволяет защитить эту учетную запись от блокировки учетных записей AD, другими словами, эта учетная запись защищает от потери доступа к корпоративным ресурсам, которые зависят от AD FS для проверки подлинности пользователя. Эти параметры применяются ко всем доменам, которые могут проверять подлинность службы AD FS.

Чтобы задать блокировка экстрасети AD FS (например,) можно использовать следующую команду Windows PowerShell: 

    PS:\>Set-AdfsProperties -EnableExtranetLockout $true -ExtranetLockoutThreshold 15 -ExtranetObservationWindow ( new-timespan -Minutes 30 )

Для справки, является общедоступной документации по этой причине [здесь](https://technet.microsoft.com/library/dn486806.aspx ). 

### <a name="differentiate-access-policies-for-intranet-and-extranet-access"></a>Отличить политики доступа для интрасети и доступа к экстрасети
AD FS имеет возможность различать политики доступа для запросов, поступающих в запросах vs локальной корпоративной сети, которые поступают из Интернета через прокси-сервер.  Это можно сделать в приложении или глобально.  Для особо важным для бизнеса приложений или приложений с помощью конфиденциальные или личные сведения учитывать требование многофакторной проверки подлинности.  Это можно сделать с помощью оснастки управления AD FS.  

### <a name="require-multi-factor-authentication-mfa"></a>Требовать многофакторной проверки подлинности (MFA)
AD FS можно настроить таким образом, чтобы требовать строгой проверки подлинности (например, многофакторной проверки подлинности), специально для запросов, поступающих через прокси-сервер, для отдельных приложений и условный доступ Azure AD и Office 365 и локальным ресурсам.  Поддерживаемые методы многофакторной проверки Подлинности включают многофакторной проверки Подлинности Microsoft Azure и сторонних поставщиков.  Пользователю предлагается для предоставления дополнительных сведений (например SMS, содержащие один код времени), службы федерации Active Directory работает с использованием подключаемого модуля, чтобы разрешить доступ конкретного поставщика.  

Поддерживаемые внешних поставщиков многофакторной проверки Подлинности, перечислены в [это](https://technet.microsoft.com/library/dn758113.aspx) страницы, а также глобальные HDI.

### <a name="hardware-security-module-hsm"></a>Аппаратный модуль безопасности (HSM)
В конфигурации по умолчанию ключи службы федерации Active Directory, который используется для подписи маркеров, никогда не оставить серверов федерации в интрасети.  Они никогда не присутствуют в сети Периметра, или на компьютерах прокси-сервера.  При необходимости для обеспечения дополнительной защиты, эти ключи могут быть защищены в аппаратном модуле безопасности, подключенные к AD FS.  Microsoft не создает продукт с аппаратным модулем безопасности, тем не менее существует несколько на рынке, который поддерживает AD FS.  Чтобы реализовать эту рекомендацию, следуйте указаниям поставщика для создания X509 сертификаты для подписывания и шифрования, затем использовать командлеты powershell установки AD FS, указывая пользовательских сертификатов, как показано ниже:

    PS:\>Install-AdfsFarm -CertificateThumbprint <String> -DecryptionCertificateThumbprint <String> -FederationServiceName <String> -ServiceAccountCredential <PSCredential> -SigningCertificateThumbprint <String>

Где:


- `CertificateThumbprint` является SSL-сертификата
- `SigningCertificateThumbprint` является сертификата подписи (с ключом HSM защищенные)
- `DecryptionCertificateThumbprint` — Это сертификат шифрования (с ключом HSM защищенные)



