---
description: 'Дополнительные сведения: обновление до AD FS в Windows Server 2016 с SQL Server'
title: Обновление до AD FS в Windows Server 2016 с SQL Server
author: billmath
manager: mtillman
ms.date: 04/11/2018
ms.topic: article
ms.assetid: 70f279bf-aea1-4f4f-9ab3-e9157233e267
ms.author: billmath
ms.openlocfilehash: 5fcc31c0b0f0482a545d17135603efaa97e174d7
ms.sourcegitcommit: 40905b1f9d68f1b7d821e05cab2d35e9b425e38d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/06/2021
ms.locfileid: "97948530"
---
# <a name="upgrading-to-ad-fs-in-windows-server-2016-with-sql-server"></a>Обновление до AD FS в Windows Server 2016 с SQL Server


> [!NOTE]
> Начать обновление только с определенного времени, запланированного на завершение. Не рекомендуется держать AD FS в смешанном режиме в течение продолжительного периода времени, так как сохранение AD FS в смешанном режиме может вызвать проблемы с фермой.


## <a name="moving-from-a-windows-server-2012-r2-ad-fs-farm-to-a-windows-server-2016-ad-fs-farm"></a>Переход с фермы AD FS Windows Server 2012 R2 на ферму AD FS Windows Server 2016
В следующем документе описано, как обновить ферму AD FS Windows Server 2012 R2 до AD FS в Windows Server 2016 при использовании SQL Server для базы данных AD FS.

### <a name="upgrading-ad-fs-to-windows-server-2016-fbl"></a>Обновление AD FS до Windows Server 2016 ФБЛ
Новые возможности AD FS для Windows Server 2016 — функция уровня поведения фермы (ФБЛ).   Эти функции являются уровнями фермы и определяют функции, которые может использовать ферма AD FS.   По умолчанию ФБЛ в ферме Windows Server 2012 R2 AD FS входит в состав Windows Server 2012 R2 ФБЛ.

Сервер AD FS Windows Server 2016 можно добавить в ферму Windows Server 2012 R2 и будет работать в той же ФБЛ, что и Windows Server 2012 R2.  Если сервер AD FS Windows Server 2016 работает таким образом, ферма называется смешанной.  Тем не менее вы не сможете воспользоваться новыми функциями Windows Server 2016, пока не будет вызвано ФБЛ в Windows Server 2016.  С помощью смешанной фермы:

-   Администраторы могут добавлять новые серверы федерации Windows Server 2016 в существующую ферму Windows Server 2012 R2.  В результате ферма находится в смешанном режиме и работает на уровне поведения фермы Windows Server 2012 R2.  Чтобы обеспечить согласованное поведение в ферме, новые функции Windows Server 2016 не могут быть настроены или использованы в этом режиме.

-   После удаления всех серверов федерации Windows Server 2012 R2 из фермы в смешанном режиме и в случае фермы WID один из новых серверов федерации Windows обслуживает 2016 был повышен до роли основного узла, а администратор может вызвать ФБЛ из Windows Server 2012 R2 в Windows Server 2016.  В результате все новые AD FS Windows Server 2016 могут быть настроены и использованы.

-   В результате возможности смешанной фермы AD FS Организации Windows Server 2012 R2, которые стремятся перейти на Windows Server 2016, не должны развертывать совершенно новую ферму, экспортировать и импортировать данные конфигурации.  Вместо этого они могут добавлять узлы Windows Server 2016 в существующую ферму, пока она находится в режиме «в сети», и при этом возникнет относительно короткое время простоя, вовлеченное в ФБЛ.

Учтите, что в режиме смешанной фермы AD FS ферма не поддерживает новые функции и функции, появившиеся в AD FS в Windows Server 2016.  Это означает, что Организации, желающие испытать новые функции, не смогут сделать это до тех пор, пока не будет вызвано ФБЛ.  Поэтому, если ваша организация планирует протестировать новые функции до создания ФБЛ, для этого потребуется развернуть отдельную ферму.

В оставшейся части документа содержатся инструкции по добавлению сервера федерации Windows Server 2016 в среду Windows Server 2012 R2 и последующему порождению ФБЛ к Windows Server 2016.  Эти шаги были выполнены в тестовой среде, описанной в схеме архитектуры ниже.

> [!NOTE]
> Прежде чем перейти к AD FS в Windows Server 2016 ФБЛ, необходимо удалить все узлы Windows 2012 R2.  Вы не можете просто обновить ОС Windows Server 2012 R2 до Windows Server 2016 и стать узлом 2016.  Его необходимо будет удалить и заменить новым узлом 2016.

На схеме архитектуры показана программа установки, которая использовалась для проверки и записи описанных ниже действий.

![Architecture](media/Upgrading-to-AD-FS-in-Windows-Server-2016-SQL/arch.png)


#### <a name="join-the-windows-2016-ad-fs-server-to-the-ad-fs-farm"></a>Присоединение сервера AD FS Windows 2016 к ферме AD FS

1.  С помощью диспетчер сервера установите роль службы федерации Active Directory (AD FS) на Windows Server 2016

2.  С помощью мастера настройки AD FS присоедините новый сервер Windows Server 2016 к существующей ферме AD FS.  На экране **приветствия** нажмите кнопку **Далее**.
![Снимок экрана, на котором отображается экран приветствия в мастере настройки AD FS.](media/Upgrading-to-AD-FS-in-Windows-Server-2016-SQL/configure1.png)
3.  На экране **Подключение к домен Active Directory службам** **адайте учетную запись администратора** с разрешениями на выполнение настройки служб федерации и нажмите кнопку **Далее**.
4.  На экране **Укажите ферму** введите имя сервера и экземпляра SQL Server, а затем нажмите кнопку **Далее**.
![Снимок экрана, на котором показан экран указания фермы в мастере настройки AD FS.](media/Upgrading-to-AD-FS-in-Windows-Server-2016-SQL/configure3.png)
5.  На экране **Указание SSL-сертификата** укажите сертификат и нажмите кнопку **Далее**.
![Присоединение к ферме](media/Upgrading-to-AD-FS-in-Windows-Server-2016-SQL/configure4.png)
6.  На экране **Укажите учетную запись службы** укажите учетную запись службы и нажмите кнопку **Далее**.
7.  На экране **Параметры проверки** проверьте параметры и нажмите кнопку **Далее**.
8.  На экране **проверки предварительных требований** убедитесь, что все проверки готовности пройдены, и нажмите кнопку **настроить**.
9.  На экране **результатов** убедитесь, что сервер был успешно настроен, и нажмите кнопку **Закрыть**.


#### <a name="remove-the-windows-server-2012-r2-ad-fs-server"></a>Удаление сервера AD FS Windows Server 2012 R2

>[!NOTE]
>Не нужно задавать сервер-источник AD FS с помощью Set-AdfsSyncProperties роли при использовании SQL в качестве базы данных.  Это связано с тем, что все узлы считаются первичными в этой конфигурации.

1.  На AD FS сервере Windows Server 2012 R2 в диспетчер сервера используйте команду **Удалить роли и компоненты** в разделе **Управление**.
![Снимок экрана, посвященный пункту меню "удалить роли и компоненты".](media/Upgrading-to-AD-FS-in-Windows-Server-2016-SQL/remove1.png)
2.  На странице **Приступая к работе** нажмите кнопку **Далее**.
3.  На экране **выбора сервера** нажмите кнопку **Далее**.
4.  На экране **роли сервера** удалите флажок рядом с **службы федерации Active Directory (AD FS)** и нажмите кнопку **Далее**.
![Удалить сервер](media/Upgrading-to-AD-FS-in-Windows-Server-2016-SQL/remove2.png)
5.  На экране **компонентов** нажмите кнопку **Далее**.
6.  На экране **подтверждения** нажмите кнопку **Удалить**.
7.  После завершения этой работы перезапустите сервер.

#### <a name="raise-the-farm-behavior-level-fbl"></a>Повышение уровня поведения фермы (ФБЛ)
Перед этим шагом необходимо убедиться в том, что forestprep и domainprep были запущены в среде Active Directory и что Active Directory имеет схему Windows Server 2016.  Этот документ запущен с контроллером домена Windows 2016 и не требует запуска, поскольку они были запущены при установке AD.

>[!NOTE]
>Прежде чем начать процесс, убедитесь, что Windows Server 2016 является актуальным, запустив Центр обновления Windows из параметров.  Продолжайте этот процесс, пока не перестанут требоваться обновления. Кроме того, убедитесь, что учетная запись учетной записи службы ADFS имеет административные разрешения на сервере SQL Server и на каждом сервере в ферме ADFS.

1. Теперь на сервере Windows Server 2016 откройте PowerShell и выполните следующую команду: **$cred = Get-Credential** и нажмите клавишу ВВОД.
2. Введите учетные данные, имеющие права администратора на SQL Server.
3. Теперь в PowerShell введите следующую команду: **Invoke-адфсфармбехавиорлевелраисе-Credential $CRED**
2. При появлении запроса введите **Y**.  Это начнет повышать уровень.  После завершения этого процесса вы успешно вызвали ФБЛ.
![Завершить обновление](media/Upgrading-to-AD-FS-in-Windows-Server-2016-SQL/finish1.png)
3. Теперь, если вы переходите к AD FS управления, вы увидите новые узлы, добавленные для AD FS в Windows Server 2016.
4. Аналогичным образом можно использовать командлет PowerShell: Get-AdfsFarmInformation для отображения текущего ФБЛ.
![Снимок экрана, показывающий, как использовать командлет Get-AdfsFarmInformation для отображения текущего F B L.](media/Upgrading-to-AD-FS-in-Windows-Server-2016-SQL/finish2.png)

#### <a name="upgrade-the-configuration-version-of-existing-wap-servers"></a>Обновление версии существующих серверов WAP
1. Настройте WAP на каждом прокси-сервере веб приложения, выполнив следующую команду PowerShell в окне с повышенными привилегиями:
    ```powershell
    $trustcred = Get-Credential -Message "Enter Domain Administrator credentials"
    Install-WebApplicationProxy -CertificateThumbprint {SSLCert} -fsname fsname -FederationServiceTrustCredential $trustcred
    ```
2. Удалите старые серверы из кластера и обеспечьте только серверы WAP, на которых работает последняя версия сервера, которая была перенастроена ранее, выполнив следующую команду PowerShell.
    ```powershell
    Set-WebApplicationProxyConfiguration -ConnectedServersName WAPServerName1, WAPServerName2
    ```
3. Проверьте конфигурацию WAP, выполнив Get-WebApplicationProxyConfiguration команды. Коннектедсерверснаме будет отражать запуск сервера из предыдущей команды.
    ```powershell
    Get-WebApplicationProxyConfiguration
    ```
4. Чтобы обновить Конфигуратионверсион серверов WAP, выполните следующую команду PowerShell.
    ```powershell
    Set-WebApplicationProxyConfiguration -UpgradeConfigurationVersion
    ```
5. Убедитесь, что Конфигуратионверсион обновлен с помощью команды PowerShell Get-WebApplicationProxyConfiguration.
