---
title: Устранение неполадок AD FS — сертификаты
description: В этом документе описаны типичные проблемы с сертификатами.
author: billmath
ms.author: billmath
manager: mtillman
ms.date: 02/21/2017
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: identity-adfs
ms.openlocfilehash: cee87ce864e333b98e92fa64e939f2ead7edc156
ms.sourcegitcommit: f6490192d686f0a1e0c2ebe471f98e30105c0844
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/10/2019
ms.locfileid: "70869185"
---
# <a name="ad-fs-troubleshooting---certificates"></a>Устранение неполадок AD FS — сертификаты
Для правильной работы AD FS требуются следующие сертификаты.  Если какие – либо из них не были настроены или установлены должным образом, могут возникнуть проблемы.  

## <a name="required-certificates"></a>Требуемые сертификаты
Для AD FS требуются следующие сертификаты:



- **Доверие федерации** . для этого требуется, чтобы сертификат, связанный с доверенным корневым центром сертификации (ЦС), присутствовал в доверенном привилегированном хранилище как поставщика утверждений, так и серверов федерации проверяющей стороны, была реализована структура кросс-сертификации, в которой каждая сторона обменивается своим корневым центром сертификации с партнером или самозаверяющим сертификатами, которые были импортированы на каждой стороне, где это необходимо.
- **Подпись маркера** — каждому служба федерации компьютеру требуется сертификат для подписи маркера.  Сертификат подписи маркера поставщика утверждений должен быть доверенным для сервера федерации проверяющей стороны. Сертификат подписи маркера проверяющей стороны должен быть доверенным для всех приложений, которые получают маркеры от сервера федерации RP.
- **SSL (SSL)** — SSL-сертификат для служба федерации должен присутствовать в надежном хранилище на компьютере прокси-сервера федерации и иметь допустимую цепочку для хранилища доверенных центров сертификации (ЦС).
- **Список отзыва сертификатов (CRL)** — для любого сертификата, в котором ОПУБЛИКОВАН список отзыва сертификатов, список отзыва сертификатов должен быть доступен всем клиентам и серверам, которым требуется доступ к сертификату.

Если какой либо из указанных выше конфигураций настроен неправильно, AD FS не будет работать.

## <a name="common-things-to-check-with-certificates"></a>Общие действия для проверки сертификатов
Ниже приведен список действий, которые могут возникнуть, и их следует проверять при попытке устранения проблемы с сертификатом.

- Убедитесь, что сертификат является доверенным
    - Клиенты должны доверять SSL-сертификатам.
    - Проверяющим сторонам необходимо доверять сертификатам подписи маркеров.
- Проверьте цепочку доверия — каждый сертификат в цепочке должен быть допустимым.
- Проверка даты истечения срока действия сертификата
- Проверка доступности списка отзыва сертификатов (CRL)
    - Убедитесь, что поле CDP заполнено.
    - Вручную перейти к CDP
- Убедитесь, что сертификат не отозван

## <a name="common-certificate-errors"></a>Распространенные ошибки сертификатов
В следующей таблице перечислены распространенные ошибки и возможные причины.

|событие|Причина|Разрешение
|-----|-----|-----|
|Событие 249-не удалось найти сертификат в хранилище сертификатов. В сценариях переключения сертификатов это может привести к сбою, если служба федерации подписывается или расшифровывается с помощью этого сертификата.|Рассматриваемый сертификат отсутствует в локальном хранилище сертификатов, или учетная запись службы не имеет разрешения на закрытый ключ сертификата.|Убедитесь, что сертификат установлен в хранилище LocalMAchine\My на сервере AD FS. Убедитесь, что учетная запись службы AD FS имеет доступ на чтение закрытого ключа сертификата.|
|Событие 315-произошла ошибка при попытке построить цепочку сертификатов для сертификата подписи доверия поставщика утверждений.|Сертификат отозван.</br></br>Не удается проверить цепочку сертификатов.</br></br>Срок действия сертификата истек или еще не вступил в силу.|Убедитесь, что сертификат действителен и не был отозван.</br></br>Убедитесь, что список отзыва сертификатов доступен.|
|Событие 316-произошла ошибка при попытке создать цепочку сертификатов для сертификата подписи доверия с проверяющей стороной.|Сертификат отозван.</br></br>Не удается проверить цепочку сертификатов.</br></br>Срок действия сертификата истек или еще не вступил в силу.|Убедитесь, что сертификат действителен и не был отозван.</br></br>Убедитесь, что список отзыва сертификатов доступен.|
|Событие 317-произошла ошибка при попытке создать цепочку сертификатов для сертификата шифрования доверия проверяющей стороны.|Сертификат отозван.</br></br>Не удается проверить цепочку сертификатов.</br></br>Срок действия сертификата истек или еще не вступил в силу.|Убедитесь, что сертификат действителен и не был отозван.</br></br>Убедитесь, что список отзыва сертификатов доступен.|
|Событие 319-произошла ошибка при построении цепочки сертификатов для сертификата клиента.|Сертификат отозван.</br></br>Не удается проверить цепочку сертификатов.</br></br>Срок действия сертификата истек или еще не вступил в силу.|Убедитесь, что сертификат действителен и не был отозван.</br></br>Убедитесь, что список отзыва сертификатов доступен.|
|Событие 360-запрос был сделан в конечной точке транспорта сертификата, но запрос не включал сертификат клиента.|Корневой ЦС, выдавший сертификат клиента, не является доверенным.</br></br>Срок действия сертификата клиента истек.</br></br>Сертификат клиента является самозаверяющим и не является доверенным.|Убедитесь, что корневой ЦС, выдавший сертификат клиента, находится в доверенном корневом хранилище.</br></br>Убедитесь, что срок действия сертификата клиента не истек.</br></br>Если сертификат клиента является самозаверяющим, убедитесь, что он добавлен в список доверенных сертификатов, или замените самозаверяющий сертификат доверенным сертификатом.|
|Событие 374-произошла ошибка при создании цепочки сертификатов для сертификата шифрования доверия поставщика утверждений.|Сертификат отозван.</br></br>Не удается проверить цепочку сертификатов.</br></br>Срок действия сертификата истек или еще не вступил в силу.|Убедитесь, что сертификат действителен и не был отозван.</br></br>Убедитесь, что список отзыва сертификатов доступен.|
|Событие 381-произошла ошибка при попытке построить цепочку сертификатов для сертификата конфигурации.|Один из сертификатов, настроенных для использования на AD FS сервере, просрочен или был отозван.|Убедитесь, что все настроенные сертификаты не отозваны и срок их действия не истек.|
|Событие 385-AD FS обнаружила, что один или несколько сертификатов в базе данных конфигурации AD FS необходимо обновить вручную.|Один из сертификатов, настроенных для использования на AD FS сервере, истек или приближается к дате окончания срока действия.|Обновление сертификата с истекшим сроком действия или с момента окончания срока действия с заменой. (Если вы используете самозаверяющие сертификаты и включаете автоматическую смену сертификатов, эта ошибка может быть проигнорирована, так как она будет самостоятельно устранена.)|
|Событие 387-AD FS обнаружило, что один или несколько сертификатов, указанных в служба федерации, не были доступны учетной записи службы, используемой службой AD FS Windows.|Учетная запись службы AD FS не имеет разрешений на чтение закрытого ключа одного или нескольких настроенных сертификатов.|Убедитесь, что учетная запись службы AD FS имеет разрешение на чтение закрытого ключа всех настроенных сертификатов.|
|Событие 389-AD FS обнаружило, что для одного или нескольких отношений доверия требуется обновление сертификатов вручную, так как срок их действия истек или срок действия скоро истечет.|Срок действия одного из сертификатов настроенного партнера истек или срок его действия скоро истечет. Это может применяться либо к доверию поставщика утверждений, либо к отношениям доверия с проверяющей стороной.|Если доверие создано вручную, обновите конфигурацию сертификата вручную. Если вы использовали метаданные федерации для создания отношения доверия, сертификат будет обновляться автоматически, как только партнер обновит сертификат.|




## <a name="next-steps"></a>Следующие шаги

- [Устранение неполадок в AD FS](ad-fs-tshoot-overview.md)
 