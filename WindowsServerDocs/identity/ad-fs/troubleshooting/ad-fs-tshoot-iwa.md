---
title: Устранение неполадок AD FS — встроенная проверка подлинности Windows
description: В этом документе описывается устранение неполадок встроенной проверки подлинности Windows
author: billmath
ms.author: billmath
manager: mtillman
ms.date: 02/21/2017
ms.topic: article
ms.openlocfilehash: f1f3adbb7b2e692d2db18c6891694761a3205f08
ms.sourcegitcommit: 6717decb5839aa340c81811d6fde020aabaddb3b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/26/2021
ms.locfileid: "98781873"
---
# <a name="ad-fs-troubleshooting---integrated-windows-authentication"></a>Устранение неполадок AD FS — встроенная проверка подлинности Windows
Встроенная проверка подлинности Windows позволяет пользователям входить в систему с учетными данными Windows и работать с единым входом (SSO), используя Kerberos или NTLM.

## <a name="reason-integrated-windows-authentication-fails"></a>Причина сбоя встроенной проверки подлинности Windows
Существует три основные причины, по которым встроенная проверка подлинности Windows завершится ошибкой. К ним относятся:
    - Неправильное Настройка имени субъекта-службы (SPN)
    - Токен привязки канала
    - Настройка Internet Explorer

## <a name="spn-misconfiguration"></a>Неправильное Настройка имени участника-службы
Имя участника-службы (SPN) — это уникальный идентификатор экземпляра службы. Имена участников-служб используются при проверке подлинности Kerberos для связывания экземпляра службы с учетной записью входа службы. Это позволяет клиентскому приложению запросить проверку подлинности учетной записи службы, даже если у клиента нет имени учетной записи.

Ниже приведен пример использования имени субъекта-службы с AD FS.
1. Веб-браузер запрашивает Active Directory, чтобы определить, какая учетная запись службы работает под sts.contoso.com
2. Active Directory сообщает браузеру, что это AD FS учетной записи службы.
3. Браузер получит билет Kerberos для учетной записи службы AD FS.

Если учетная запись службы AD FS имеет неправильно настроенное или неправильное SPN, это может вызвать проблемы.  Просмотр трассировок сети может привести к ошибкам, например КРБ Error: KRB5KDC_ERR_S_PRINCIPAL_UNKNOWN.

С помощью трассировки сети (например, Wireshark) можно определить, какое имя субъекта-службы пытается разрешить браузер, а затем использовать средство командной строки SetSPN – Q <spn> .  Возможно, он не найден или назначен другой учетной записи, отличной от учетной записи службы AD FS.

![Снимок экрана: окно командной строки.](media/ad-fs-tshoot-iwa/iwa3.png)

Имя субъекта-службы можно проверить, просмотрев свойства учетной записи службы AD FS.

![Снимок экрана вкладки Редактора атрибутов в диалоговом окне свойств учетной записи службы D F S, в котором отображается значение имени субъекта-службы. ](media/ad-fs-tshoot-iwa/iwa1.png)

## <a name="channel-binding-token"></a>Токен привязки канала
В текущей версии, если клиентское приложение проходит проверку подлинности на сервере с использованием протокола Kerberos, дайджест-проверку подлинности или проверку NTLM с использованием HTTPS, то сначала устанавливается канал безопасности транспортного уровня (TLS), а проверка подлинности выполняется по этому каналу.

Токен привязки канала является свойством внешнего канала, защищенного TLS, и используется для привязки внешнего канала к диалогу по внутреннему каналу, прошедшему проверку подлинности клиента.

При возникновении атаки "злоумышленник в середине" и расшифровке и повторном шифровании SSL-трафика ключ не будет совпадать.  AD FS определит, что в центре веб-обзора r и самого себя есть что-то другое.  Это приведет к сбою проверки подлинности Kerberos, и пользователю будет предложено диалоговое окно 401 вместо единого входа.

Это может быть вызвано следующим:
 - любые элементы, находясь между браузером и AD FS
 - Fiddler
 - Обратные прокси-серверы, выполняющие мост SSL

По умолчанию AD FS имеет значение Allow.  Этот параметр можно изменить с помощью командлета PowerShell. `Set-ADFSProperties -ExtendProtectionTokenCheck`

Дополнительные сведения см. в статье рекомендации [по безопасному планированию и развертыванию AD FS](../../ad-fs/design/best-practices-for-secure-planning-and-deployment-of-ad-fs.md).

## <a name="internet-explorer-configuration"></a>Настройка Internet Explorer

По умолчанию Internet Explorer будет иметь следующий порядок:

1. Internet Explorer получит ответ 401 от AD FS с словом NEGOTIATE в заголовке.
2. Это указывает веб-браузеру на необходимость получения билета Kerberos или NTLM для отправки обратно в AD FS.
3. По умолчанию IE пытается сделать это (SPNEGO) без вмешательства пользователя, если слово NEGOTIATE находится в заголовке.  Он будет работать только для сайтов интрасети.

Существует два основных момента, которые могут помешать этому.

- Включить встроенную проверку подлинности Windows не проверяется в свойствах IE.  Он находится в разделе «Свойства обозревателя» — > «> безопасность».

   ![Снимок экрана вкладки "Дополнительно" диалогового окна "Свойства обозревателя" с вызываемым параметром "включить встроенную проверку подлинности Windows".](media/ad-fs-tshoot-iwa/iwa4.png)

- Зоны безопасности настроены неправильно

  - FQDN не входит в зону интрасети

  - URL-адрес AD FS не входит в зону интрасети.

    ![Снимок экрана: окно локальной интрасети перед диалоговым окном "Свойства браузера".](media/ad-fs-tshoot-iwa/iwa5.png)

## <a name="next-steps"></a>Next Steps

- [Устранение неполадок в AD FS](ad-fs-tshoot-overview.md)
