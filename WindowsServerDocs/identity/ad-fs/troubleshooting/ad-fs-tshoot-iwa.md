---
title: Устранение неполадок AD FS — встроенная проверка подлинности Windows
description: В этом документе описывается устранение неполадок встроенной проверки подлинности Windows
author: billmath
ms.author: billmath
manager: mtillman
ms.date: 02/21/2017
ms.topic: article
ms.prod: windows-server
ms.technology: identity-adfs
ms.openlocfilehash: 98f6c2e39b2a5eeab76103c1ae477dde785a0e04
ms.sourcegitcommit: 6aff3d88ff22ea141a6ea6572a5ad8dd6321f199
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/27/2019
ms.locfileid: "71385391"
---
# <a name="ad-fs-troubleshooting---integrated-windows-authentication"></a>Устранение неполадок AD FS — встроенная проверка подлинности Windows
Встроенная проверка подлинности Windows позволяет пользователям входить в систему с учетными данными Windows и работать с единым входом (SSO), используя Kerberos или NTLM.

## <a name="reason-integrated-windows-authentication-fails"></a>Причина сбоя встроенной проверки подлинности Windows
Существует три основные причины, по которым встроенная проверка подлинности Windows завершится ошибкой. Подробные сведения.
    - Неправильное Настройка имени субъекта-службы (SPN)
    - Токен привязки канала
    - Конфигурация Internet Explorer

## <a name="spn-misconfiguration"></a>Неправильное Настройка имени участника-службы
Имя участника-службы (SPN) — это уникальный идентификатор экземпляра службы. Имена участников-служб используются при проверке подлинности Kerberos для связывания экземпляра службы с учетной записью входа службы. Это позволяет клиентскому приложению запросить проверку подлинности учетной записи службы, даже если у клиента нет имени учетной записи.

Ниже приведен пример использования имени субъекта-службы с AD FS.
1. Веб-браузер запрашивает Active Directory, чтобы определить, какая учетная запись службы работает под sts.contoso.com
2. Active Directory сообщает браузеру, что это AD FS учетной записи службы.
3. Браузер получит билет Kerberos для учетной записи службы AD FS.

Если учетная запись службы AD FS имеет неправильно настроенное или неправильное SPN, это может вызвать проблемы.  Просмотр трассировки сети может привести к ошибкам, таким как КРБ Error: KRB5KDC_ERR_S_PRINCIPAL_UNKNOWN.

С помощью трассировки сети (например, Wireshark) можно определить, какое имя субъекта-службы пытается разрешить браузер, а затем использовать средство командной строки SetSPN – Q <spn>.  Возможно, он не найден или назначен другой учетной записи, отличной от учетной записи службы AD FS.

![интегрирует](media/ad-fs-tshoot-iwa/iwa3.png)

Имя субъекта-службы можно проверить, просмотрев свойства учетной записи службы AD FS.

![интегрирует](media/ad-fs-tshoot-iwa/iwa1.png)

## <a name="channel-binding-token"></a>Токен привязки канала
В настоящее время, когда клиентское приложение выполняет проверку подлинности на сервере с помощью протокола Kerberos, дайджеста или NTLM с использованием HTTPS, сначала устанавливается канал TLS, а проверка подлинности выполняется с помощью этого канала. 

Токен привязки канала является свойством внешнего канала, защищенного TLS, и используется для привязки внешнего канала к диалогу по внутреннему каналу, прошедшему проверку подлинности клиента.

Если возникает атака "злоумышленник в середине", и они отменяют шифрование и повторно шифруют трафик SSL, ключ не будет совпадать.  AD FS определит, что в центре веб-обзора r и самого себя есть что-то другое.  Это приведет к сбою проверки подлинности Kerberos, и пользователю будет предложено диалоговое окно 401 вместо единого входа.

Это может быть вызвано следующим:
 - любые элементы, находясь между браузером и AD FS
 - Fiddler
 - Обратные прокси-серверы, выполняющие мост SSL

По умолчанию AD FS имеет значение Allow.  Этот параметр можно изменить с помощью PowerShell командлет `Set-ADFSProperties -ExtendProtectionTokenCheck`.

Дополнительные сведения см. в статье рекомендации [по безопасному планированию и развертыванию AD FS](../../ad-fs/design/best-practices-for-secure-planning-and-deployment-of-ad-fs.md).

## <a name="internet-explorer-configuration"></a>Конфигурация Internet Explorer
По умолчанию Internet Explorer будет иметь следующий порядок:

1. Internet Explorer получит ответ 401 от AD FS с словом NEGOTIATE в заголовке.
2. Это указывает веб-браузеру на необходимость получения билета Kerberos или NTLM для отправки обратно в AD FS.
3. По умолчанию IE пытается сделать это (SPNEGO) без вмешательства пользователя, если слово NEGOTIATE находится в заголовке.  Он будет работать только для сайтов интрасети.

Существует два основных момента, которые могут помешать этому из хаппеинг.
   - Включить встроенную проверку подлинности Windows не проверяется в свойствах IE.  Он находится в разделе «Свойства обозревателя» — > «> Безопасность».
   
   ![интегрирует](media/ad-fs-tshoot-iwa/iwa4.png)
   
   - Зоны безопасности настроены неправильно
       - FQDN не входит в зону интрасети
       - URL-адрес AD FS не входит в зону интрасети.

      ![интегрирует](media/ad-fs-tshoot-iwa/iwa5.png)
## <a name="next-steps"></a>Следующие шаги

- [Устранение неполадок в AD FS](ad-fs-tshoot-overview.md)
