---
title: AD FS устранение неполадок — аудит событий и ведение журнала
description: В этом документе описано, как использовать различные журналы AD FS для устранения неполадок.
author: billmath
ms.author: billmath
manager: mtillman
ms.date: 02/21/2018
ms.topic: article
ms.openlocfilehash: ef0adfa8b0e565981ea5273508f8c943d67e2d02
ms.sourcegitcommit: dfa48f77b751dbc34409aced628eb2f17c912f08
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/07/2020
ms.locfileid: "87953148"
---
# <a name="ad-fs-troubleshooting---events-and-logging"></a>AD FS устранение неполадок — события и ведение журнала
AD FS предоставляет два основных журнала, которые можно использовать при устранении неполадок.  К ним относятся:

- Журнал администратора
- Журнал трассировки

Каждый из этих журналов будет объяснен ниже.

## <a name="admin-log"></a>Журнал администратора
Журнал администратора содержит сведения высокого уровня о возникших проблемах и включается по умолчанию.

### <a name="to-view-the-admin-log"></a>Просмотр журнала администратора
1.  Откройте средство просмотра событий
2.  Разверните **журнал приложений и служб**.
3.  Разверните **AD FS**.
4.  Щелкните **Admin** (Администратор).

![усовершенствования аудита](media/ad-fs-tshoot-logging/event1.PNG)

## <a name="trace-log"></a>Журнал трассировки
Журнал трассировки — это место, где регистрируются подробные сообщения, и будет наиболее полезным журналом при устранении неполадок. Так как значительная часть сведений журнала трассировки может быть создана за короткий промежуток времени, что может повлиять на производительность системы, журналы трассировки по умолчанию отключены.

### <a name="to-enable-and-view-the-trace-log"></a>Включение и Просмотр журнала трассировки
1.  Откройте средство просмотра событий
2.  Щелкните правой кнопкой мыши **журнал приложений и служб** и выберите вид и щелкните **Показать аналитические и отладочные журналы**.  В левой части отобразятся дополнительные узлы.
![усовершенствования аудита](media/ad-fs-tshoot-logging/event2.PNG)
3.  Развернуть трассировку AD FS
4.  Щелкните отладку правой кнопкой мыши и выберите **Включить журнал**.
![усовершенствования аудита](media/ad-fs-tshoot-logging/event3.PNG)


## <a name="event-auditing-information-for-ad-fs-on-windows-server-2016"></a>Сведения об аудите событий для AD FS в Windows Server 2016
По умолчанию для AD FS в Windows Server 2016 доступен базовый уровень аудита.  При базовом аудите администраторы увидят 5 или менее событий для одного запроса.  Это означает значительное уменьшение количества событий, которые администраторы должны просматривать, чтобы увидеть один запрос.   Уровень аудита может быть повышен или снижен с помощью PowerShell командлет:

```PowerShell
Set-AdfsProperties -AuditLevel
```

В таблице ниже описываются доступные уровни аудита.

|Уровень аудита|Синтаксис PowerShell|Описание|
|----- | ----- | ----- |
|Отсутствуют|Set-AdfsProperties-AuditLevel None|Аудит отключен, и никакие события не регистрируются.|
|Базовый (по умолчанию)|Set-AdfsProperties-AuditLevel Basic|Для одного запроса будет зарегистрировано не более 5 событий.|
|Подробный|Set-AdfsProperties-AuditLevel verbose|Будут регистрироваться все события.  При этом будет записываться значительный объем информации по запросу.|

Чтобы просмотреть текущий уровень аудита, можно использовать PowerShell командлет: Get-AdfsProperties.

![усовершенствования аудита](media/ad-fs-tshoot-logging/ADFS_Audit_1.PNG)

Уровень аудита может быть повышен или снижен с помощью PowerShell командлет: Set-AdfsProperties-AuditLevel.

![усовершенствования аудита](media/ad-fs-tshoot-logging/ADFS_Audit_2.png)

## <a name="types-of-events"></a>Типы событий
События AD FS могут принадлежать разным типам на основе различных типов запросов, обрабатываемых AD FS. С каждым типом события связаны определенные данные.  Тип событий может различаться между запросами входа (т. е. запросами маркера) и системными запросами (вызовы сервера, включая выборку сведений о конфигурации).

В следующей таблице описаны основные типы событий.

|Тип события|Идентификатор события|Описание|
|----- | ----- | ----- |
|Успешная проверка учетных данных|1202|Запрос, в котором успешно проверяются новые учетные данные служба федерации. Сюда входят WS-Trust, WS-Federation, SAML-P (первый этап для создания единого входа) и службы авторизации OAuth.|
|Новая ошибка проверки учетных данных|1203|Запрос, в котором не пройдена новая проверка учетных данных служба федерации. К ним относятся WS-Trust, WS-подача, SAML-P (первый этап для создания единого входа) и службы авторизации OAuth.|
|Маркер приложения успешно выполнен|1200|Запрос, в котором служба федерации успешно выдается маркер безопасности. Для WS-Federation SAML-P это регистрируется, когда запрос обрабатывается с помощью артефакта единого входа. (например, файл cookie единого входа).|
|Сбой маркера приложения|1201|Запрос, в котором произошел сбой выдачи маркера безопасности служба федерации. Для WS-Federation SAML-P регистрируется при обработке запроса с помощью артефакта единого входа. (например, файл cookie единого входа).|
|Запрос на смену пароля успешно выполнен|1204|Транзакция, в которой запрос на изменение пароля был успешно обработан служба федерации.|
|Ошибка запроса на смену пароля|1205|Транзакция, в которой не удалось обработать запрос на изменение пароля служба федерации.|
|Выход успешно выполнен|1206|Описывает успешный запрос на выход.|
|Сбой выхода|1207|Описывает неудачный запрос на выход.|

## <a name="security-auditing"></a>Аудит безопасности
Аудит безопасности учетной записи AD FS службы иногда помогает отслеживать проблемы с обновлением паролей, ведением журнала запросов и ответов, запрашивать заголовки контект и результаты регистрации устройств.  Аудит учетной записи службы AD FS по умолчанию отключен.

### <a name="to-enable-security-auditing"></a>Включение аудита безопасности
1. Нажмите кнопку Пуск, укажите пункт **программы**, затем **Администрирование**и выберите пункт **Локальная политика безопасности**.
2. Перейдите в папку **Параметры безопасности\Локальные политики\Управление правами пользователей** и дважды щелкните элемент **Создание аудитов безопасности**.
3. На вкладке **Параметр локальной безопасности** убедитесь, что в списке указана учетная запись службы AD FS. Если она отсутствует, щелкните ссылку Добавление пользователя или группы, добавьте запись в список и нажмите кнопку ОК.
4. Откройте командную строку с повышенными привилегиями и выполните следующую команду, чтобы включить аудит auditpol.exe/Set/субкатегори: "Application Generated"/фаилуре: enable/сукцесс: enable
5. Закройте окно **Локальная политика безопасности** и откройте оснастку управления AD FS.

Чтобы открыть оснастку "Управление AD FS", нажмите кнопку Пуск, наведите указатель на пункт программы, затем на администрирование и выберите пункт Управление AD FS.

6. На панели действия выберите Изменить служба федерации свойства.
7. В диалоговом окне Свойства службы федерации перейдите на вкладку События.
8. Установите флажки **Успешные события аудита** и **Неудачные события аудита**.
9. Щелкните ОК.

![усовершенствования аудита](media/ad-fs-tshoot-logging/event4.PNG)

>[!NOTE]
>Приведенные выше инструкции используются только в том случае, если AD FS находится на изолированном сервере-члене.  Если AD FS выполняется на контроллере домена, а не в локальной политике безопасности, используйте **политику контроллера домена по умолчанию** , расположенную в **Групповая политика управление, лес, домены и контроллеры домена**.  Щелкните Изменить и перейдите к **компьютеру \ \ конфигурация \ локальные политики \ параметры безопасности Policies\User Rights Management**

## <a name="windows-communication-foundation-and-windows-identity-foundation-messages"></a>Сообщения Windows Communication Foundation и Windows Identity Foundation
Помимо ведения журнала трассировки, иногда может потребоваться просмотреть сообщения Windows Communication Foundation (WCF) и Windows Identity Foundation (WIF), чтобы устранить проблему. Это можно сделать, изменив файл **Microsoft.IdentityServer.ServiceHost.Exe.Config** на сервере AD FS.

Этот файл находится в **папке<% System root% > \виндовс\адфс** и имеет формат XML. Ниже приведены соответствующие части файла.
```
<!-- To enable WIF tracing, change the switchValue below to desired trace level - Verbose, Information, Warning, Error, Critical -->

<source name="Microsoft.IdentityModel" switchValue="Off"> … </source>

<!-- To enable WCF tracing, change the switchValue below to desired trace level - Verbose, Information, Warning, Error, Critical -->

<source name="System.ServiceModel" switchValue="Off" > … </source>
```


После применения этих изменений сохраните конфигурацию и перезапустите службу AD FS. После включения этих трассировок с помощью соответствующих параметров они будут отображаться в журнале трассировки AD FS в Просмотр событий Windows.

## <a name="correlating-events"></a>Корреляция событий
Одним из самых важных вещей, которые необходимо устранить, являются проблемы с доступом, которые создают большое количество событий ошибок или отладки.

Для этого AD FS сопоставляет все события, записанные в Просмотр событий, в журналах администрирования и отладки, которые соответствуют определенному запросу, используя уникальный глобальный уникальный идентификатор (GUID), называемый ИДЕНТИФИКАТОРом действия. Этот идентификатор создается, когда запрос на выдачу маркера изначально представлен веб-приложению (для приложений, использующих профиль пассивного запроса) или запросов, отправленных непосредственно поставщику утверждений (для приложений, использующих WS-Trust).

![ActivityId](media/ad-fs-tshoot-logging/activityid1.png)

Идентификатор действия остается неизменным для всей продолжительности запроса и регистрируется как часть каждого события, записанного в Просмотр событий для этого запроса. Это означает следующее:
 - Фильтрация или поиск Просмотр событий с помощью этого идентификатора действия может помочь в отслеживании всех связанных событий, соответствующих запросу маркера.
 - один и тот же идентификатор действия заносится в журнал на разных компьютерах, что позволяет устранять неполадки запросов пользователей на нескольких компьютерах, таких как прокси-сервер федерации (FSP).
 - Идентификатор действия также будет отображаться в браузере пользователя, если запрос AD FS завершается сбоем, что позволяет пользователю передавать этот идентификатор в службу технической поддержки или ИТ.

![ActivityId](media/ad-fs-tshoot-logging/activityid2.png)

Чтобы помочь в процессе устранения неполадок, AD FS также регистрирует событие идентификации вызывающего объекта всякий раз, когда происходит сбой процесса выдачи маркера на сервере AD FS. Это событие содержит тип утверждения и значение одного из следующих типов утверждений, предполагая, что эти сведения передаются в служба федерации как часть запроса маркера:
- https://schemas.microsoft.com/ws/2008/06/identity/claims/windowsaccountnameh
- http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier
- http://schemas.xmlsoap.org/ws/2005/05/identity/claims/upnh
- https://schemas.microsoft.com/ws/2008/06/identity/claims/upn
- http://schemas.xmlsoap.org/claims/UPN
- http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddressh
- https://schemas.microsoft.com/ws/2008/06/identity/claims/emailaddress
- http://schemas.xmlsoap.org/claims/EmailAddress
- http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name
- https://schemas.microsoft.com/ws/2008/06/identity/claims/name
- http://schemas.xmlsoap.org/ws/2005/05/identity/claims/privatepersonalidentifier

Событие ID звонящего также регистрирует идентификатор действия, чтобы можно было использовать идентификатор действия для фильтрации или поиска в журналах событий конкретного запроса.




## <a name="next-steps"></a>Next Steps

- [Устранение неполадок в AD FS](ad-fs-tshoot-overview.md)
