---
title: AD FS, устранение неполадок — аудит и ведение журнала
description: В этом документе описывается использование в различных журналах AD FS для устранения неполадок
author: billmath
ms.author: billmath
manager: mtillman
ms.date: 02/21/2018
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: identity-adfs
ms.openlocfilehash: 1acc00ca376c48f7fb34214cef3a92961d355ae4
ms.sourcegitcommit: eaf071249b6eb6b1a758b38579a2d87710abfb54
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/31/2019
ms.locfileid: "66444023"
---
# <a name="ad-fs-troubleshooting---events-and-logging"></a>AD FS Устранение неполадок — события и ведения журнала
AD FS предоставляет два первичного журнала, которые могут использоваться в устранении неполадок.  Подробные сведения.

- Журнал администратора
- Журнал трассировки  
 
Каждый из этих журналов будет описано ниже.

## <a name="admin-log"></a>Журнал администратора
Журнал администратора предоставляет данных верхнего уровня о проблемах, которые выполняются и включена по умолчанию.

### <a name="to-view-the-admin-log"></a>Чтобы просмотреть журнал администратора
1.  Откройте средство просмотра событий
2.  Разверните **журналы приложений и служб**.
3.  Разверните **AD FS**.
4.  Щелкните **администратора**.

![улучшения аудита](media/ad-fs-tshoot-logging/event1.PNG)  

## <a name="trace-log"></a>Журнал трассировки
Журнал трассировки представляет подробные сообщения регистрируются куда будет журнале наиболее полезно при устранении неполадок. Так как большой объем данных журнала трассировки могут создаваться в короткий промежуток времени, что может повлиять на производительность системы, журналы трассировки будут отключены по умолчанию. 

### <a name="to-enable-and-view-the-trace-log"></a>Для включения и просмотра журнала трассировки
1.  Откройте средство просмотра событий
2.  Щелкните правой кнопкой мыши **журналы приложений и служб** и выберите представление, а выберите **Отобразить аналитический и отладочный журналы**.  Отображает дополнительные узлы в левой части.
![улучшения аудита](media/ad-fs-tshoot-logging/event2.PNG)  
3.  Разверните AD FS трассировки
4.  Щелкните правой кнопкой мыши, отладки, а затем выберите **включить журнал**.
![улучшения аудита](media/ad-fs-tshoot-logging/event3.PNG)  


## <a name="event-auditing-information-for-ad-fs-on-windows-server-2016"></a>События сведений аудита для AD FS на Windows Server 2016  
По умолчанию AD FS в Windows Server 2016 имеет базовый уровень аудита.  С помощью основные возможности аудита, администраторы будут см. в разделе не более пяти события для отдельного запроса.  Это обозначает значительное уменьшается число событий, которые администраторы имеют просмотра, чтобы увидеть одного запроса.   Уровень аудита можно быть увеличивается или уменьшается, используя командлет PowerShell:  

```PowerShell
Set-AdfsProperties -AuditLevel 
```

В таблице ниже приведены доступные уровни аудита.  

|Уровень аудита|Синтаксис PowerShell|Описание|  
|----- | ----- | ----- |
|Нет|SET-AdfsProperties - AuditLevel None|Аудит отключен и события не регистрируются.|  
|Basic (по умолчанию)|SET-AdfsProperties - AuditLevel Basic|Не более 5 события будут регистрироваться для отдельного запроса|  
|Verbose|Set-AdfsProperties - AuditLevel Verbose|Регистрируются все события.  Это позволит входить значительный объем сведения каждого запроса.|  
  
Чтобы просмотреть текущий уровень аудита, можно использовать командлет PowerShell:  Get-AdfsProperties.  
  
![улучшения аудита](media/ad-fs-tshoot-logging/ADFS_Audit_1.PNG)  
  
Уровень аудита можно быть увеличивается или уменьшается, используя командлет PowerShell:  SET-AdfsProperties - AuditLevel.  
  
![улучшения аудита](media/ad-fs-tshoot-logging/ADFS_Audit_2.png)  
  
## <a name="types-of-events"></a>Типы событий  
События AD FS могут быть различных типов, в зависимости от различных типов запросов, обрабатываемых службами AD FS. Каждый тип событий имеет данных, связанных с ним.  Тип событий могут отличаться от запросов на вход (т. е. запросы маркеров) и запросы системы (вызовы сервера, включая получение сведений о конфигурации).    

В следующей таблице описываются основные типы событий.  
  
|Тип события|Идентификатор события|Описание| 
|----- | ----- | ----- | 
|Успех проверки новых учетных данных|1202|Запрос, где новые учетные данные проверяются успешно службой федерации. Это включает в себя WS-Trust, WS-Federation, SAML-P (первый этап для создания единого входа) и конечных точек авторизации OAuth.|  
|Ошибка проверки новой учетных данных|1203|Запрос, где сбой проверки новых учетных данных в службе федерации. Это включает в себя WS-Trust, WS-Fed, SAML-P (первый этап для создания единого входа) и конечных точек авторизации OAuth.|  
|Приложение успешно маркеров|1200|Запрос, где успешно выданный маркер безопасности службой федерации. Для WS-Federation, SAML-P, это действие регистрируется, когда запрос обрабатывается с артефактом единого входа. (например, файл cookie единого входа).|  
|Сбой маркера приложения|1201|Запрос, где сбой выдачи маркеров безопасности в службе федерации. Для WS-Federation, SAML-P, это действие регистрируется при обработке запроса с артефактом единого входа. (например, файл cookie единого входа).|  
|Запрос на изменение пароля успешно|1204|Транзакции, где запрос на смену пароля успешно обработан службой федерации.|  
|Ошибка запроса изменения пароля|1205|Не удалось обработать службой федерации транзакций, где запрос на смену пароля.| 
|Выйдите из системы успешно|1206|Описывает успешный запрос выхода.|  
|Выйдите из системы сбоя|1207|Описывает Невыполненный запрос выхода.|  

## <a name="security-auditing"></a>Аудит безопасности
Аудит безопасности учетной записи службы AD FS может иногда помочь отслеживание проблем с обновления паролей, ведение журнала запросов и ответов, contect заголовки запросов и результатов регистрации устройства.  Аудит учетной записи службы AD FS отключен по умолчанию.

### <a name="to-enable-security-auditing"></a>Чтобы включить аудит безопасности
1. Нажмите кнопку Пуск, выберите пункт **программы**, пункты **Администрирование**, а затем нажмите кнопку **Локальная политика безопасности**.
2. Перейдите в папку **Параметры безопасности\Локальные политики\Управление правами пользователей** и дважды щелкните элемент **Создание аудитов безопасности**.
3. На **параметр локальной безопасности** убедитесь, что указана учетная запись службы AD FS. Если он отсутствует, нажмите кнопку Добавить пользователя или группу и добавить его в список и нажмите кнопку ОК.
4. Откройте командную строку с повышенными привилегиями и выполните следующую команду, чтобы включить аудит auditpol.exe/set /subcategory: /success:enable /failure:enable «Создано приложением»
5. Закрыть **Локальная политика безопасности**, а затем откройте оснастку управления AD FS.
 
Чтобы открыть оснастку управления AD FS, нажмите кнопку Пуск, выберите программы, Администрирование и управление AD FS.
 
6. В области действий щелкните Изменить свойства службы федерации
7. В диалоговом окне Свойства службы федерации перейдите на вкладку события.
8. Выберите **успешные события аудита** и **неудачные события аудита** флажки.
9. Нажмите кнопку "ОК".

![улучшения аудита](media/ad-fs-tshoot-logging/event4.PNG)  
 
>[!NOTE]
>Выше инструкциям используются только в том случае, когда AD FS находится в автономном рядового сервера.  Если AD FS работает на контроллере домена, а не локальная политика безопасности, используйте **политику контроллера домена по умолчанию** в **группы политики управления или леса и домены/домена контроллеры**.  Щелкните "Изменить" и перейдите к **компьютера компьютера\Политики\Параметры Settings\Security Settings\Local Policies\User Rights Management**

## <a name="windows-communication-foundation-and-windows-identity-foundation-messages"></a>Сообщения Windows Communication Foundation и Windows Identity Foundation
В дополнение к ведения журнала трассировки иногда может потребоваться просмотреть сообщения Windows Communication Foundation (WCF) и Windows Identity Foundation (WIF) для поиска и устранения проблемы. Это можно сделать, изменив **Microsoft.IdentityServer.ServiceHost.Exe.Config** файл на сервере AD FS. 

Этот файл находится в **\Windows\ADFS < % системы корневой % >** и в формате XML. Ниже приведены соответствующие части файла: 
```
<!-- To enable WIF tracing, change the switchValue below to desired trace level - Verbose, Information, Warning, Error, Critical -->

<source name="Microsoft.IdentityModel" switchValue="Off"> … </source>

<!-- To enable WCF tracing, change the switchValue below to desired trace level - Verbose, Information, Warning, Error, Critical -->

<source name="System.ServiceModel" switchValue="Off" > … </source>
```


После применения этих изменений, сохраните конфигурацию и перезапустите службу AD FS. После включения этих трассировок заданием нужных параметров, они будут отображаться в журнале трассировки AD FS в средстве просмотра событий Windows.

## <a name="correlating-events"></a>Сопоставление событий
Одна из самых сложных задач, для устранения неполадок — создавать большое число ошибок и отладочные события проблемы доступа.

Чтобы упростить это, AD FS сопоставляет все события, которые записываются в средство просмотра событий, как администратор, так и журналы отладки, которые соответствуют на определенный запрос с помощью уникальный глобальный уникальный идентификатор (GUID) вызывается идентификатор действия. Этот идентификатор создается в том случае, когда запрос выдачи токена, изначально отображаемого в веб-приложения (для приложений с помощью профиля пассивной службы запросов) или запросов, отправляемых непосредственно поставщика утверждений (для приложений, использующих WS-Trust). 

![ActivityID](media/ad-fs-tshoot-logging/activityid1.png)

Этот идентификатор действия остается неизменным в течение всего запроса и регистрируется как для каждого события записываются в средство просмотра для данного запроса. Что это значит:
 - фильтрации или поиска средство просмотра событий, используя это действие, идентификатор может помочь хранить список всех связанных событий, которые соответствуют запрос маркера
 - один и тот же идентификатор активности регистрируется на разных компьютерах, что позволит вам для устранения неполадок запроса пользователя между несколькими компьютерами, таким как прокси сервера федерации (FSP)
 - Идентификатор действия будут также отображаться в браузере пользователя при сбое запроса AD FS любым способом, таким образом позволяя пользователю взаимодействовать этот идентификатор в службу поддержки или ИТ-поддержки.

![ActivityID](media/ad-fs-tshoot-logging/activityid2.png)

Чтобы помочь вам в процессе устранения неполадок, AD FS также журналы событий идентификатор вызывающего объекта, каждый раз, когда в процессе выдачи маркера происходит сбой на сервере AD FS. Это событие содержит тип утверждения и значение одного из следующих типов утверждений, при условии, что эта информация было передано в службу федерации как часть запроса маркера:
- http://schemas.microsoft.com/ws/2008/06/identity/claims/windowsaccountnameh
- http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier
- http://schemas.xmlsoap.org/ws/2005/05/identity/claims/upnh
- http://schemas.microsoft.com/ws/2008/06/identity/claims/upn
- http://schemas.xmlsoap.org/claims/UPN
- http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddressh
- http://schemas.microsoft.com/ws/2008/06/identity/claims/emailaddress 
- http://schemas.xmlsoap.org/claims/EmailAddress
- http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name
- http://schemas.microsoft.com/ws/2008/06/identity/claims/name
- http://schemas.xmlsoap.org/ws/2005/05/identity/claims/privatepersonalidentifier 

Идентификатор события вызывающий объект также записывает идентификатор действия, чтобы можно было использовать код операции для фильтрации или поиска в журнале событий для определенного запроса.




## <a name="next-steps"></a>Следующие шаги

- [Устранение неполадок в AD FS](ad-fs-tshoot-overview.md)
