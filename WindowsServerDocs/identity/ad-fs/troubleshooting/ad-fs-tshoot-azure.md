---
title: Устранение неполадок AD FS в Azure AD
description: В этом документе описывается устранение различных аспектов AD FS и Azure AD.
author: billmath
ms.author: billmath
manager: mtillman
ms.date: 03/01/2018
ms.topic: article
ms.prod: windows-server
ms.technology: identity-adfs
ms.openlocfilehash: b66d688052398ba76b6721e8bab0d0878be4959a
ms.sourcegitcommit: 3632b72f63fe4e70eea6c2e97f17d54cb49566fd
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/03/2020
ms.locfileid: "87517709"
---
# <a name="ad-fs-troubleshooting---azure-ad"></a>Устранение неполадок AD FS в Azure AD
С ростом облака многие компании были перемещены на использование Azure AD для различных приложений и служб.  Федерацию с Azure AD стало стандартной практикой во многих организациях.  В этом документе рассматриваются некоторые аспекты устранения неполадок, возникающих в этой Федерации.  Некоторые статьи в общем документе по устранению неполадок по-прежнему относятся к интеграции с Azure, поэтому в этом документе основное внимание уделяется работе с Azure AD и AD FS взаимодействием.

## <a name="redirection-to-ad-fs"></a>Перенаправление на AD FS

Перенаправление происходит при входе в приложение, например Office 365, и вы перенаправлялись в Организации, AD FS серверы для входа.

![Экран перенаправления для AD FS](media/ad-fs-tshoot-azure/azure1.png)

### <a name="first-things-to-check"></a>Первые вещи, которые следует проверить

Если перенаправление не происходит, необходимо проверить несколько вещей.

1. Убедитесь, что клиент Azure AD включен для Федерации, выполнив вход на портал Azure и установив флажок в разделе Azure AD Connect.

   ![Экран входа пользователя в Azure AD Connect](media/ad-fs-tshoot-azure/azure2.png)

2. Убедитесь, что ваш личный домен проверен, щелкнув домен рядом с параметром Федерация в портал Azure.

   ![Домен, отображаемый рядом с Федерацию на портале](media/ad-fs-tshoot-azure/azure3.png)

3. Наконец, необходимо проверить [DNS](ad-fs-tshoot-dns.md) и убедиться, что AD FS серверы или серверы WAP разрешаются из Интернета.  Убедитесь, что это разрешение и вы можете переходить к нему.

4. Кроме того, вы можете использовать командлет PowerShell `Get-AzureADDomain` для получения этих сведений.

   ![Экран командлета PowerShell](media/ad-fs-tshoot-azure/azure6.png)

### <a name="you-are-receiving-an-unknown-auth-method-error"></a>Получена неизвестная ошибка метода проверки подлинности
Вы можете столкнуться с ошибкой "Неизвестный метод проверки подлинности", сообщающей, что AuthnContext не поддерживается на уровне AD FS или STS при перенаправлении из Azure.

Чаще всего это происходит, когда Azure AD перенаправляется на AD FS или STS с помощью параметра, который обеспечивает метод проверки подлинности.

Чтобы применить метод проверки подлинности, используйте один из следующих методов.
- Для WS-Federation используйте строку запроса WAUTH для принудительного применения предпочтительного метода проверки подлинности.

- Для SAML 2.0 используйте следующую команду:
  ```
  <saml:AuthnContext>
  <saml:AuthnContextClassRef>
  urn:oasis:names:tc:SAML:2.0:ac:classes:PasswordProtectedTransport
  </saml:AuthnContextClassRef>
  </saml:AuthnContext>
  ```
  Если принудительный метод проверки подлинности отправляется с неправильным значением или если этот метод проверки подлинности не поддерживается для AD FS или STS, то перед проверкой подлинности вы получаете сообщение об ошибке.

|Требуется метод проверки подлинности|универсальный код ресурса (URI) wauth|
|-----|-----|
|Проверка подлинности с помощью имени пользователя и пароля|urn:oasis:names:tc:SAML:1.0:am:password|
|Проверка подлинности клиента SSL|urn: IETF: RFC: 2246|
|Встроенная проверка подлинности Windows|urn: Federation: Authentication: Windows|

Поддерживаемые классы контекста проверки подлинности SAML

|Метод проверки подлинности|URI класса контекста проверки подлинности|
|-----|-----|
|Имя пользователя и пароль.|urn:oasis:names:tc:SAML:2.0:ac:classes:Password|
|Защищенный паролем транспорт|urn: Oasis: Names: TC: SAML: 2.0: AC: Classes: Пассвордпротектедтранспорт|
|Клиент транспортного уровня (TLS)|urn: Oasis: Names: TC: SAML: 2.0: AC: Classes: Тлсклиент
|Сертификат X.509|urn: Oasis: Names: TC: SAML: 2.0: AC: Classes: X509
|Встроенная проверка подлинности Windows|urn: Federation: Authentication: Windows|
|Kerberos|urn: Oasis: Names: TC: SAML: 2.0: AC: Classes: Kerberos|

Чтобы убедиться, что метод проверки подлинности поддерживается на уровне AD FS, проверьте следующее.

#### <a name="ad-fs-20"></a>AD FS 2.0

В разделе **/адфс/лс/web.config**убедитесь, что указана запись для типа проверки подлинности.

```
<microsoft.identityServer.web>
<localAuthenticationTypes>
<add name="Forms" page="FormsSignIn.aspx" />
<add name="Integrated" page="auth/integrated/" />
<add name="TlsClient" page="auth/sslclient/" />
<add name="Basic" page="auth/basic/" />
</localAuthenticationTypes>
```

#### <a name="ad-fs-2012-r2"></a>AD FS 2012 R2

В разделе **управление AD FS**щелкните **политики проверки подлинности** в оснастке AD FS.

В разделе **Основная проверка подлинности** щелкните Изменить рядом с параметром глобальные параметры. Можно также щелкнуть правой кнопкой мыши политики проверки подлинности и выбрать пункт Изменить глобальную основную проверку подлинности. Или на панели действия выберите Изменить глобальную основную проверку подлинности.

В окне Изменение политики глобальной проверки подлинности на главной вкладке можно настроить параметры в рамках глобальной политики проверки подлинности. Например, для основной проверки подлинности можно выбрать доступные методы проверки подлинности в экстрасети и интрасети.

* * Убедитесь, что установлен флажок обязательный метод проверки подлинности.

#### <a name="ad-fs-2016"></a>AD FS 2016

В разделе **управление AD FS**щелкните **службы** и **методы проверки подлинности** в оснастке AD FS.

В разделе **Основная проверка подлинности** щелкните Изменить.

В окне **изменение методов проверки подлинности** на главной вкладке можно настроить параметры в рамках политики проверки подлинности.

![Изменить окно методов проверки подлинности](media/ad-fs-tshoot-azure/azure4.png)

## <a name="tokens-issued-by-ad-fs"></a>Токены, выданные AD FS

### <a name="azure-ad-throws-error-after-token-issuance"></a>Azure AD выдает ошибку после выдачи маркера
После AD FS выдачи маркера, Azure AD может вызвать ошибку. В этом случае проверьте наличие следующих проблем:
- Утверждения, выданные AD FS в токене, должны соответствовать соответствующим атрибутам пользователя в Azure AD.
- токен для Azure AD должен содержать следующие обязательные утверждения:
    - WSFED
        - UPN: значение этого утверждения должно соответствовать имени участника-пользователя в Azure AD.
        - ImmutableID: значение этого утверждения должно соответствовать sourceAnchor или ImmutableID пользователя в Azure AD.

Чтобы получить значение атрибута пользователя в Azure AD, выполните следующую командную строку:`Get-AzureADUser –UserPrincipalName <UPN>`

![Экран командлета PowerShell](media/ad-fs-tshoot-azure/azure5.png)

   - SAML 2,0:
       - IDPEmail: значение этого утверждения должно совпадать с именем субъекта-пользователя пользователей в Azure AD.
       - NAMEID: значение этого утверждения должно соответствовать sourceAnchor или ImmutableID пользователя в Azure AD.

Дополнительные сведения см. [в статье Использование поставщика удостоверений SAML 2,0 для реализации единого входа](/previous-versions/azure/azure-services/dn641269(v=azure.100)).

### <a name="token-signing-certificate-mismatch-between-ad-fs-and-azure-ad"></a>Несоответствие сертификата для подписи маркера между AD FS и Azure AD.

AD FS использует сертификат подписи маркера для подписывания маркера, отправляемого пользователю или приложению. Доверие между AD FS и Azure AD — это федеративное доверие, основанное на этом сертификате для подписи маркера.

Однако если сертификат для подписи маркера на стороне AD FS изменился из-за автоматической смены сертификатов или какого-либо вмешательства, то сведения о новом сертификате необходимо обновить на стороне Azure AD для федеративного домена. Если основной сертификат для подписи маркера на AD FS отличается от AD ADs, маркер, выданный AD FS, не является доверенным для Azure AD. Таким образом, федеративный пользователь не может войти в систему.

Чтобы устранить эту проблему, воспользуйтесь инструкциями в статье [Обновление сертификатов федерации для Office 365 и Azure Active Directory](/azure/active-directory/connect/active-directory-aadconnect-o365-certs).

## <a name="other-common-things-to-check"></a>Другие распространенные вещи, которые следует проверить
Ниже приведен краткий список действий, которые необходимо проверить при возникновении проблем с AD FS и взаимодействием Azure AD.
- устаревшие или кэшированные учетные данные в диспетчере учетных данных Windows
- Для алгоритма SHA, настроенного для отношения доверия с проверяющей стороной для Office 365, задано значение SHA1

## <a name="next-steps"></a>Next Steps

- [Устранение неполадок в AD FS](ad-fs-tshoot-overview.md)
