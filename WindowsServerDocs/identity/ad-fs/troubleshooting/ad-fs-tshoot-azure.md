---
title: AD FS Устранение неполадок — Azure AD
description: В этом документе описываются способы устранения различных аспектов AD FS и Azure AD
author: billmath
ms.author: billmath
manager: mtillman
ms.date: 03/01/2018
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: identity-adfs
ms.openlocfilehash: 6f85c447ac0816c46e07145dbe9a491a29e17c0f
ms.sourcegitcommit: 0d0b32c8986ba7db9536e0b8648d4ddf9b03e452
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2019
ms.locfileid: "59846475"
---
# <a name="ad-fs-troubleshooting---azure-ad"></a>AD FS Устранение неполадок — Azure AD
С ростом облака используется множеством компаний переходит на использование Azure AD для своих различных приложений и служб.  Федерации с Azure AD стала обычной практикой с во многих организациях.  В этом документе будут рассмотрены некоторые аспекты Устранение проблемы, связанные с этой федерации.  Некоторые подразделы общие документ по устранению неполадок по-прежнему относятся к федерации с Azure, поэтому в этом документе основное внимание уделяется только особенности с Azure AD и AD FS взаимодействия.

## <a name="redirection-to-ad-fs"></a>Перенаправление на AD FS
Перенаправление происходит, когда вы можете войти в приложение, например Office 365 и вы «redirected» для вашей организации серверов AD FS для входа в систему.

![](media/ad-fs-tshoot-azure/azure1.png)


### <a name="first-things-to-check"></a>В первую очередь для проверки
Если перенаправление не осуществляется, что есть несколько вещей, который вы хотите проверить

   1. Убедитесь, что клиент Azure AD включен для федерации, вход на портал Azure и проверка в Azure AD Connect.

![](media/ad-fs-tshoot-azure/azure2.png)

   2.  Убедитесь, что ваш пользовательский домен проверяется, щелкнув домена рядом с федерации на портале Azure.
![](media/ad-fs-tshoot-azure/azure3.png)

   3. Наконец, вы хотите проверить [DNS](ad-fs-tshoot-dns.md) и убедитесь, что серверов AD FS или WAP-серверы разрешают из Интернета.  Убедитесь, что это разрешает и возможности для перехода к нему.
   4. Можно также использовать командлет PowerShell: `Get-AzureADDomain` также получить эту информацию.

![](media/ad-fs-tshoot-azure/azure6.png)

### <a name="you-are-receiving-an-unknown-auth-method-error"></a>При возникновении ошибок метод Неизвестный Auth
Вы можете столкнуться, «Неизвестная Auth method» сообщение об ошибке, AuthnContext не поддерживается на уровне AD FS или STS при перенаправлении из Azure. 

Чаще всего это происходит, когда Azure AD перенаправляет AD FS или STS, используя параметр, который применяет метод проверки подлинности. 

Чтобы применить метод проверки подлинности, используйте один из следующих методов:
- Для WS-Federation WAUTH строку запроса можно используйте для принудительного способ проверки подлинности.

- Для SAML 2.0 используйте следующие команды:
```
<saml:AuthnContext>
<saml:AuthnContextClassRef>
urn:oasis:names:tc:SAML:2.0:ac:classes:PasswordProtectedTransport
</saml:AuthnContextClassRef>
</saml:AuthnContext>
```
При отправке метод принудительной проверки подлинности с неверным или если этот метод проверки подлинности не поддерживается на AD FS или STS, появляется сообщение об ошибке, прежде чем вы прошли проверку подлинности.

|Метод проверки подлинности, нужно было|wauth URI|
|-----|-----|
|Проверка подлинности с помощью имени пользователя и пароля|urn:oasis:names:tc:SAML:1.0:am:password|
|Проверка подлинности клиента SSL|urn:ietf:rfc:2246|
|Встроенная проверка подлинности Windows|urn:federation:authentication:windows|

Поддерживаемые классы контекста проверки подлинности SAML

|Метод проверки подлинности|Класс контекста проверки подлинности URI|
|-----|-----| 
|имя пользователя и пароль;|urn: oasis: имена: tc: SAML:2.0:ac:classes:Password|
|Транспорт защищен паролем|urn: oasis: имена: tc: SAML:2.0:ac:classes:PasswordProtectedTransport|
|Транспортный клиент Layer Security (TLS)|urn: oasis: имена: tc: SAML:2.0:ac:classes:TLSClient
|Сертификат X.509|urn: oasis: имена: tc: SAML:2.0:ac:classes:X 509
|Встроенная проверка подлинности Windows|urn:federation:authentication:windows|
|Kerberos|urn: oasis: имена: tc: SAML:2.0:ac:classes:Kerberos|

Чтобы убедиться в том, что метод проверки подлинности поддерживается на уровне AD FS, проверьте следующее.

#### <a name="ad-fs-20"></a>AD FS 2.0 

В разделе **/adfs/ls/web.config**, убедитесь, что имеется запись для типа проверки подлинности.

```
<microsoft.identityServer.web>
<localAuthenticationTypes>
<add name="Forms" page="FormsSignIn.aspx" />
<add name="Integrated" page="auth/integrated/" />
<add name="TlsClient" page="auth/sslclient/" />
<add name="Basic" page="auth/basic/" />
</localAuthenticationTypes>
```

#### <a name="ad-fs-2012-r2"></a>AD FS 2012 R2

В разделе **управления AD FS**, нажмите кнопку **политики проверки подлинности** в AD FS оснастки.

В **основной проверки подлинности** раздела, щелкните "Изменить" рядом с глобальными параметрами. Можно также щелкнуть правой кнопкой политики проверки подлинности и затем выберите Изменить глобальную основную проверку подлинности. Или в области действий выберите Изменить глобальную основную проверку подлинности.

В окне «Изменение глобальной политики проверки подлинности» на вкладке «основной» как часть глобальной политики поверки подлинности можно настроить параметры. Например для основной проверки подлинности, можно выбрать доступные методы проверки подлинности в экстрасети и интрасети.

** Убедитесь в том, что установлен флажок метод обязательную проверку подлинности. 

#### <a name="ad-fs-2016"></a>AD FS 2016

В разделе **управления AD FS**, нажмите кнопку **службы** и **методы проверки подлинности** в AD FS оснастки.

В **основной проверки подлинности** раздела, щелкните "Изменить".

В **изменение методов проверки подлинности** окне на вкладке «основной» при настройке политики проверки подлинности можно настроить параметры.

![](media/ad-fs-tshoot-azure/azure4.png)

## <a name="tokens-issued-by-ad-fs"></a>Маркеры, выданные AD FS

### <a name="azure-ad-throws-error-after-token-issuance"></a>Azure AD выдает ошибку после выдачи маркера
После AD FS выдает маркер, Azure AD может выдавать ошибку. В этом случае проверьте следующее:
- Утверждения, выданные AD FS в маркере должны сопоставить соответствующие атрибуты пользователя в Azure AD.
- маркер для Azure AD должен содержать следующие необходимые утверждения:
    - WSFED: 
        - ИМЯ УЧАСТНИКА-ПОЛЬЗОВАТЕЛЯ: Значение этого утверждения должно совпадать имена участников-пользователей в Azure AD.
        - ImmutableID: Значение этого утверждения должно совпадать sourceAnchor или ImmutableID пользователя в Azure AD.

Чтобы получить значение атрибута пользователя в Azure AD, выполните следующую команду: `Get-AzureADUser –UserPrincipalName <UPN>`

![](media/ad-fs-tshoot-azure/azure5.png)

   - SAML 2.0:
       - IDPEmail: Значение этого утверждения должно соответствовать имя участника-пользователя пользователей в Azure AD.
       - NAMEID: Значение этого утверждения должно совпадать sourceAnchor или ImmutableID пользователя в Azure AD.

Дополнительные сведения см. в разделе [использование поставщика удостоверений SAML 2.0 для реализации единого входа](https://technet.microsoft.com/library/dn641269.aspx).

### <a name="token-signing-certificate-mismatch-between-ad-fs-and-azure-ad"></a>Подписи маркера несоответствие сертификата между AD FS и Azure AD.

AD FS использует сертификат для подписи маркера для подписи маркера, который отправляется для пользователя или приложения. Отношение доверия между AD FS и Azure AD — это доверие федерации основана на этот сертификат для подписи маркера.

Тем не менее если сертификат для подписи маркера AD FS со стороны изменяется из-за автоматическую замену сертификата или некоторые действия со стороны, нового сертификата должны обновляться на стороне Azure AD для федеративного домена. Когда основной сертификат подписи маркера на AD FS отличается от рекламы Azure, маркер, выданный AD FS не является доверенным для Azure AD. Таким образом федеративного пользователя войти в систему не допускается.

Чтобы исправить это можно использовать приведены в [обновление сертификатов федерации для Office 365 и Azure Active Directory](https://docs.microsoft.com/azure/active-directory/connect/active-directory-aadconnect-o365-certs).

## <a name="other-common-things-to-check"></a>Общие сведения
Ниже приведен краткий список проверки при возникновении проблем с взаимодействием AD FS и Azure AD.
- устаревшие или кэшированных учетных данных в диспетчере учетных данных Windows
- Имеет значение SHA1 безопасного хэш-алгоритма, который настроен на доверие проверяющей стороны для Office 365

## <a name="next-steps"></a>Следующие шаги

- [Устранение неполадок AD FS](ad-fs-tshoot-overview.md)