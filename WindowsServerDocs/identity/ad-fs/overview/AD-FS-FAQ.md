---
ms.assetid: acc9101b-841c-4540-8b3c-62a53869ef7a
title: Вопросы и ответы по AD FS
description: Часто задаваемые вопросы по AD FS
author: billmath
ms.author: billmath
manager: mtillman
ms.date: 11/02/2020
ms.topic: article
ms.openlocfilehash: d4b1130de67d4e4d7f57065dac307cddc0aef369
ms.sourcegitcommit: 3181fcb69a368f38e0d66002e8bc6fd9628b1acc
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/30/2020
ms.locfileid: "96330486"
---
# <a name="ad-fs-frequently-asked-questions-faq"></a>Часто задаваемые вопросы по AD FS (FAQ)

В следующей документации приведены часто задаваемые вопросы относительно службы федерации Active Directory (AD FS).  Документ разбит на группы в зависимости от типа вопроса.

## <a name="deployment"></a>Развертывание

### <a name="how-can-i-upgrademigrate-from-previous-versions-of-ad-fs"></a>Как обновить или перенести предыдущие версии AD FS

AD FS можно обновить, используя одно из следующих средств:

- Windows Server 2012 R2 AD FS для Windows Server 2016 AD FS или более поздней версии. Обратите внимание, что при обновлении с Windows Server 2016 AD FS до Windows Server 2019 AD FS методология будет той же.
    - [Обновление до AD FS в Windows Server 2016 с помощью базы данных WID](../deployment/upgrading-to-ad-fs-in-windows-server.md)
    - [Обновление до AD FS в Windows Server 2016 с помощью базы данных SQL](../deployment/upgrading-to-ad-fs-in-windows-server-sql.md)
- Windows Server 2012 AD FS на Windows Server 2012 R2 AD FS
    - [Migrating Active Directory Federation Services Role Service to Windows Server 2012 R2](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/dn486815(v=ws.11)) (Переход службы ролей для служб федерации Active Directory на Windows Server 2012 R2)
- AD FS 2.0 на Windows Server 2012 AD FS
    - [Migrate Active Directory Federation Services Role Services to Windows Server 2012](../deployment/migrate-ad-fs-role-services-to-windows-server-2012.md) (Переход служб ролей для служб федерации Active Directory в Windows Server 2012)
- AD FS 1.x на AD FS 2.0
    - [Migrating from AD FS 1.x to AD FS 2.0](/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/ff678035(v=ws.10)) (Переход от AD FS 1.x на AD FS 2.0)

При необходимости обновления с AD FS 2.0 или 2.1 (Windows Server 2008 R2 или Windows Server 2012) следует использовать встроенные скрипты (расположенные в C:\Windows\ADFS).

### <a name="why-does-ad-fs-installation-require-a-reboot-of-the-server"></a>Почему для установки AD FS требуется перезагрузка сервера?

В Windows Server 2016 добавлена поддержка HTTP/2, однако HTTP/2 нельзя использовать для проверки подлинности сертификата клиента.  Поскольку многие сценарии AD FS используют аутентификацию сертификата клиента, а значительное количество клиентов не поддерживают повторные запросы с помощью HTTP/1.1, конфигурация фермы AD FS заново настраивает параметры HTTP локального сервера на HTTP/1.1.  Для этого требуется перезагрузка сервера.

### <a name="is-using-windows-2016-wap-servers-to-publish-the-ad-fs-farm-to-the-internet-without-upgrading-the-back-end-ad-fs-farm-supported"></a>Поддерживается ли использование WAP-серверов Windows 2016 для публикации фермы AD FS в Интернете без обновления внутренней фермы AD FS?
Да, эта конфигурация поддерживается, однако в этой конфигурации не будут поддерживаться новые функции AD FS 2016.  Этот временная конфигурация на этапе миграции с AD FS 2012 R2 на AD FS 2016 и ее не следует развертывать в течение длительного периода времени.

### <a name="is-it-possible-to-deploy-ad-fs-for-office-365-without-publishing-a-proxy-to-office-365"></a>Можно ли развернуть AD FS для Office 365 без публикации прокси-сервера в Office 365?
Да, это поддерживается. Однако, в качестве побочного эффекта.

1. Вам потребуется вручную управлять обновлением сертификатов для подписи маркера, так как Azure AD не сможет получить доступ к метаданным федерации. Дополнительные сведения об обновлении сертификата для подписи маркера вручную см. в разделе [Renew federation certificates for Office 365 and Azure Active Directory](/azure/active-directory/connect/active-directory-aadconnect-o365-certs) (обновление сертификатов федерации для Office 365 и Azure Active Directory)
2. Вы не сможете использовать прежние потоки проверки подлинности (например, поток проверки подлинности прокси-сервера ExO)

### <a name="what-are-load-balancing-requirements-for-ad-fs-and-wap-servers"></a>Каковы требования к балансировке нагрузки для серверов AD FS и WAP?

AD FS — это система без отслеживания состояния. Следовательно, балансировка нагрузки довольно проста для входа в систему. Ниже приведены основные рекомендации для систем балансировки нагрузки.


- Подсистемы балансировки нагрузки не нужно настраивать с учетом соответствия IP-адресов. Это может привести к чрезмерной нагрузке на подмножество ваших серверов в определенных сценариях Exchange Online.
- Подсистемы балансировки нагрузки НЕ ДОЛЖНЫ завершать подключения HTTPS и повторно инициировать новое подключение к серверу ADFS.
- Подсистемы балансировки нагрузки ДОЛЖНЫ гарантировать, что подключающийся IP-адрес будет преобразован в качестве исходного IP-адреса в пакет HTTP при отправке в ADFS. Если балансировщик нагрузки не может отправить исходный IP-адрес в HTTP-пакет, подсистема балансировки нагрузки должна добавить (или присоединить в случае существующего) IP-адрес к заголовку x-forwarded-for. Это необходимо для правильной работы с определенными функциями, связанными с IP-адресами (запрещенный IP-адрес, интеллектуальная блокировка экстрасети...), и может привести к снижению уровня безопасности в случае неправильной настройки.
- Подсистемы балансировки нагрузки должны поддерживать SNI. В этом случае убедитесь, что AD FS настроено на создание привязок HTTPS для поддержки клиентов, не поддерживающих SNI.
- Подсистемы балансировки нагрузки ДОЛЖНЫ использовать конечную точку проверки работоспособности HTTP AD FS, чтобы определить, работают ли серверы AD FS или WAP и исключать их, если 200 ОК не возвращается.

### <a name="what-multi-forest-configurations-are-supported-by-ad-fs"></a>Какие конфигурации с несколькими лесами поддерживаются AD FS?

AD FS поддерживает различные конфигурации с несколькими лесами и полагается на базовую сеть доверия AD DS для проверки подлинности пользователей в нескольких доверенных областях. Мы настоятельно рекомендуем 2 сторонние отношения доверия, так как это более простая настройка, чтобы убедиться, что подсистема доверия работает корректно и без проблем. Дополнительно,

- В случае одностороннего отношения доверия с лесом, например леса DMZ, содержащего удостоверения партнеров, мы рекомендуем развернуть ADFS в корпоративном лесу и рассматривать лес DMZ как другое локальное доверие поставщика утверждений, подключенное через LDAP. В этом случае встроенная проверка подлинности Windows не будет работать для пользователей леса DMZ, и они должны будут выполнять проверку подлинности паролей, так как это единственный поддерживаемый механизм для протокола LDAP. В случае невозможности этого варианта вам потребуется настроить другой ADFS в лесу DMZ и добавить его в качестве отношения доверия с поставщиком утверждений в ADFS в корпоративном лесу. Пользователям потребуется обнаружение домашней области, но будет работать встроенная проверка подлинности Windows и проверка подлинности паролей. Внесите соответствующие изменения в правила выдачи в ADFS в лесу DMZ, так как ADFS в корпоративном лесу не сможет получить дополнительные сведения о пользователе из леса DMZ.
- Хотя отношения доверия на уровне домена поддерживаются и могут работать, мы настоятельно рекомендуем перейти на модель доверия на уровне леса. Кроме того, необходимо убедиться, что маршрутизация имени участника-пользователя и разрешение имен NETBIOS должны работать правильно.

>[!NOTE]
>Если используется выборочная проверка подлинности с конфигурацией с двусторонним доверием, убедитесь, что пользователю-участнику предоставлено " разрешение на проверку подлинности" в учетной записи целевой службы.

### <a name="does-ad-fs-extranet-smart-lockout-support-ipv6"></a>Поддерживает ли функция интеллектуальной блокировки экстрасети AD FS протокол IPv6?
Да, адреса IPv6 используются для знакомых и неизвестных расположений.


## <a name="design"></a>Проектирование

### <a name="what-third-party-multi-factor-authentication-providers-are-available-for-ad-fs"></a>Какие сторонние поставщики многофакторной идентификации доступны для AD FS?
AD FS предоставляет расширяемый механизм для интеграции сторонних поставщиков MFA. Для этого не задана программа сертификации. Предполагается, что поставщик выполнил необходимые проверки перед выпуском.

Список поставщиков, которые получили уведомления от корпорации Майкрософт, публикуются в списке [поставщиков MFA для AD FS](../operations/Configure-Additional-Authentication-Methods-for-AD-FS.md).  Всегда могут быть доступными поставщики, о которых мы не знаем, и мы будем обновлять список по мере того, как узнаем о них.

### <a name="are-third-party-proxies-supported-with-ad-fs"></a>Поддерживаются ли сторонние прокси-серверы AD FS?
Да, сторонние прокси-серверы могут быть размещены перед AD FS, но любой сторонний прокси-сервер должен поддерживать протокол [MS-ADFSPIP](/openspecs/windows_protocols/ms-adfspip/76deccb1-1429-4c80-8349-d38e61da5cbb), который будет использоваться вместо прокси-службы веб-приложения.

Ниже приведен список поставщиков третьих лиц, о которых мы осведомлены.  Всегда могут быть доступными поставщики, о которых мы не знаем, и мы будем обновлять список по мере того, как узнаем о них.

- [F5 — доступ к диспетчеру политики](https://support.f5.com/kb/en-us/products/big-ip_apm/manuals/product/apm-third-party-integration-13-1-0/12.html#guid-1ee8fbb3-1b33-4982-8bb3-05ae6868d9ee)
- [Контроллер доставки приложений Citrix (ADC)](https://docs.citrix.com/en-us/citrix-adc/current-release/aaa-tm/adfs-proxy-wsfed.html)


### <a name="where-is-the-capacity-planning-sizing-spreadsheet-for-ad-fs-2016"></a>Где находится таблица для изменения размера планирования ресурсов для AD FS 2016?
Версию AD FS 2016 электронной таблицы можно скачать [здесь](https://adfsdocs.blob.core.windows.net/adfs/ADFSCapacity2016.xlsx).
Это также можно использовать для AD FS в Windows Server 2012 R2.

### <a name="how-can-i-ensure-my-ad-fs-and-wap-servers-support-apples-atp-requirements"></a>Как убедиться, что мои AD FS и серверы WAP поддерживают требования ATP?

Компания Apple выпустила набор требований под названием ATS, которые могут влиять на звонки из приложений iOS, выполняющих аутентификацию в AD FS.  Вы можете гарантировать соответствие ваших серверов AD FS и WAP, убедившись, что они поддерживают [требования для подключения с помощью ATS](https://developer.apple.com/library/prerelease/content/documentation/General/Reference/InfoPlistKeyReference/Articles/CocoaKeys.html#//apple_ref/doc/uid/TP40009251-SW57).
В частности, вам следует убедиться, что ваши серверы AD FS и WAP поддерживают TLS 1.2, и что согласованный набор шифров TLS соединения будет поддерживать абсолютную скрытность в будущем.

Вы можете включить и отключить SSL 2.0 и 3.0 и TLS версии 1.0, 1.1 и 1.2, используя [управления протоколами SSL в AD FS](../operations/Manage-SSL-Protocols-in-AD-FS.md).

Чтобы серверы AD FS и WAP согласовывались только с комплектами шифров TLS, поддерживающими ATP, можно отключить все комплекты шифров, которые не входят в [список комплектов шифров, совместимых с ATP](https://developer.apple.com/library/prerelease/content/documentation/General/Reference/InfoPlistKeyReference/Articles/CocoaKeys.html#//apple_ref/doc/uid/TP40009251-SW57).  Для этого используйте [командлеты Windows TLS PowerShell](/powershell/module/tls/?view=win10-ps).

## <a name="developer"></a>Разработчик

### <a name="when-generating-an-id_token-with-adfs-for-a-user-authenticated-against-ad-how-is-the-sub-claim-generated-in-the-id_token"></a>Каким образом в идентификаторе id_token генерируется утверждение sub при генерации идентификатора id_token с помощью ADFS для пользователя, прошедшего проверку подлинности в AD?
Значение утверждения sub — это хэш идентификатора клиента со значением утверждения привязки.

### <a name="what-is-the-lifetime-of-the-refresh-tokenaccess-token-when-the-user-logs-in-via-a-remote-claims-provider-trust-over-ws-fedsaml-p"></a>Каково время существования маркера обновления/маркера доступа, если пользователь входит в систему через удаленного поставщика утверждений, которому можно доверять через WS-Fed/SAML-P?
Время существования обновленного маркера будет временем существования маркера, полученного ADFS от удаленного поставщика утверждений, которому доверяет поставщик. Время существования маркера доступа будет равно времени существования маркера проверяющей стороны, для которой выдается маркер доступа.

### <a name="i-need-to-return-profile-and-email-scopes-as-well-in-addition-to-the-openid-scope-can-i-obtain-additional-information-using-scopes-how-to-do-it-in-ad-fs"></a>Кроме того, необходимо вернуть области профиля и электронной почты, а также область OpenID Connect. Можно ли получить дополнительные сведения, используя области? Как это сделать в AD FS?
Вы можете использовать настроенный id_token для добавления соответствующей информации в сам id_token. Дополнительную информацию см. в статье [Customize claims to be emitted in id_token when using OpenID Connect or OAuth with AD FS 2016 or later](../development/Custom-Id-Tokens-in-AD-FS.md) (Настройка утверждений, которые будут генерироваться в id_token при использовании OpenID Connect или OAuth с AD FS 2016 или более поздней версией).

### <a name="how-to-issue-json-blobs-inside-jwt-tokens"></a>Как выдавать большие двоичные объекты JSON внутри маркеров JWT?
Для этого в AD FS 2016 был добавлен специальный ValueType("<http://www.w3.org/2001/XMLSchema#json>") и управляющий символ(\x22). Ниже приведен пример для правила выдачи, а также окончательные выходные данные маркера доступа.

Пример правила выдачи:

```
=> issue(Type = "array_in_json", ValueType = "http://www.w3.org/2001/XMLSchema#json", Value = "{\x22Items\x22:[{\x22Name\x22:\x22Apple\x22,\x22Price\x22:12.3},{\x22Name\x22:\x22Grape\x22,\x22Price\x22:3.21}],\x22Date\x22:\x2221/11/2010\x22}");
```

Заявка, выданная в маркере доступа:

```
"array_in_json":{"Items":[{"Name":"Apple","Price":12.3},{"Name":"Grape","Price":3.21}],"Date":"21/11/2010"}
```

### <a name="can-i-pass-resource-value-as-part-of-the-scope-value-like-how-requests-are-done-against-azure-ad"></a>Можно ли передавать значение ресурса в составе значения области, примерно как при отправке запросов к Azure AD?
С обновлением AD FS в Server 2019 вы сможете передать значение ресурса, внедренное в параметр scope. Параметр scope теперь можно упорядочить в виде списка с разделителями-пробелами, где каждая запись представляет собой структуру из ресурса и области. Например, **<создайте допустимый пример запроса>** .

### <a name="does-ad-fs-support-pkce-extension"></a>Поддерживает ли AD FS расширение PKCE?
AD FS в Server 2019 поддерживает PKCE (ключ подтверждения для обмена кодами) для потока предоставления кода авторизации OAuth.

### <a name="what-permitted-scopes-are-supported-by-ad-fs"></a>Какие разрешенные области поддерживаются AD FS?
- aza — при использовании [Расширения протокола OAuth 2.0 для клиентов брокера](/openspecs/windows_protocols/ms-oapxbc/2f7d8875-0383-4058-956d-2fb216b44706), и если параметр области содержит область "aza", сервер выдает новый основной маркер обновления и устанавливает его в поле ответа refresh_token, а также задает для поля refresh_token_expires_in время существования нового основного маркера обновления, если он применяется.
- OpenID Connect — позволяет приложению запрашивать использование протокола авторизации OpenID Connect.
- logon_cert — область logon_cert позволяет приложению запрашивать сертификаты входа в систему, которые можно использовать для интерактивного входа пользователей, прошедших проверку подлинности. Сервер AD FS пропускает параметр access_token из ответа и вместо этого предоставляет цепочку сертификатов CMS в кодировке Base64 или полный ответ PKI. Дополнительные сведения доступны [здесь](/openspecs/windows_protocols/ms-oapx/32ce8878-7d33-4c02-818b-6c9164cc731e).
- user_impersonation — область user_impersonationа необходима для успешного запроса маркера доступа от имени AD FS. Дополнительные сведения об использовании этой области см. в статье [Build a multi-tiered application using On-Behalf-Of (OBO) using OAuth with AD FS 2016 or later](../../ad-fs/development/ad-fs-on-behalf-of-authentication-in-windows-server.md) (Создание многоуровневого приложения с использованием OBO с помощью OAuth с AD FS 2016 или более поздней версии).
- vpn_cert — область vpn_cert позволяет приложению запрашивать сертификаты VPN, которые можно использовать для установки VPN-подключений с использованием проверки подлинности по EAP-TLS. Это больше не поддерживается.
- email — позволяет приложению запрашивать утверждение по электронной почте для пользователя, выполнившего вход. Это больше не поддерживается.
- profile — позволяет приложению запрашивать утверждение связанные с профилем пользователя, выполнившего вход. Это больше не поддерживается.


## <a name="operations"></a>Операции

### <a name="how-do-i-replace-the-ssl-certificate-for-ad-fs"></a>Разделы справки заменить SSL-сертификат для AD FS?
Сертификат AD FS SSL не совпадает с сертификатом связи службы AD FS, найденным в оснастке управления AD FS.  Чтобы изменить сертификат AD FS SSL, необходимо использовать PowerShell. Следуйте указаниям в следующей статье:

[Управление SSL-сертификатами в AD FS и WAP 2016](../operations/manage-ssl-certificates-ad-fs-wap.md)

### <a name="how-can-i-enable-or-disable-tlsssl-settings-for-ad-fs"></a>Как включить или отключить параметры TLS/SSL для AD FS?
Чтобы отключить или включить протоколы SSL и комплекты шифров, используйте:

[Managing SSL/TLS Protocols and Cipher Suites for AD FS](../operations/Manage-SSL-Protocols-in-AD-FS.md) (Управление протоколами SSL/TLS и комплектами шифров для AD FS)

### <a name="does-the-proxy-ssl-certificate-have-to-be-the-same-as-the-ad-fs-ssl-certificate"></a>Должен ли SSL-сертификат прокси совпадать с сертификатом AD FS SSL?
Используйте следующие рекомендации в отношении SSL-сертификата прокси и сертификата AD FS SSL:


- Если прокси-служба используется для передачи в AD FS запросов, использующих встроенную проверку подлинности Windows, прокси-сертификат SSL должен быть таким же (и с тем же ключом), что и SSL-сертификат сервера федерации.
- Если в AD FS включено свойство ExtendedProtectionTokenCheck (это значение по умолчанию), прокси-сертификат SSL должен быть таким же (и с тем же ключом), что и SSL-сертификат сервера федерации.
- В противном случае сертификат SSL прокси-сервера может иметь другой ключ из сертификата AD FS SSL, но должен соответствовать тем же [требованиям.](./ad-fs-requirements.md)

### <a name="why-do-i-only-see-a-password-login-on-ad-fs-and-not-my-other-authentication-methods-that-i-have-configured"></a>Почему я вижу только вход с паролем на AD FS, а не другие методы проверки подлинности, которые я настроил?
AD FS на экране входа в систему отображает только один метод проверки подлинности, когда приложению явно требуется конкретный URI проверки подлинности, сопоставляемый с настроенным и включенным методом проверки подлинности. Это передается в параметре 'wauth' для запросов WS-Federation и в параметре 'RequestedAuthnCtxRef' в запросе протокола SAML. В результате отображается только запрошенный метод проверки подлинности (например, вход с помощью пароля).

Когда AD FS используется с Azure AD, приложения часто отправляют в Azure AD параметр prompt = login. По умолчанию Azure AD преобразует это для запроса нового имени входа на основе пароля в AD FS. Это наиболее распространенная причина, по которой при входе на AD FS отображается вход с помощью пароля или не отображается параметр для входа с помощью сертификата. Это можно легко исправить, внеся изменения в параметры федеративного домена в Azure AD.

Сведения о том, как это настроить, см. в разделе [Приглашение службы федерации Active Directory (AD FS) = поддержка параметра входа](../operations/AD-FS-Prompt-Login.md).

### <a name="how-can-i-change-the-ad-fs-service-account"></a>Как изменить учетную запись службы AD FS?
Чтобы изменить учетную запись службы AD FS, следуйте инструкциям в разделе, используя панель элементов AD FS [Учетная запись службы модуля PowerShell](https://github.com/Microsoft/adfsToolbox/tree/master/serviceAccountModule).

### <a name="how-can-i-configure-browsers-to-use-windows-integrated-authentication-wia-with-ad-fs"></a>Как настроить браузеры для использования встроенной проверки подлинности Windows (WIA) с AD FS?

Сведения о настройке браузеров см. в разделе [Настройка браузеров для использования встроенной проверки подлинности Windows (WIA) с AD FS](../operations/Configure-AD-FS-Browser-WIA.md).

### <a name="can-i-turn-off-browserssoenabled"></a>Можно ли отключить BrowserSsoEnabled?
Если у вас нет политик управления доступом на основе устройства в ADFS или регистрации сертификата Windows Hello для бизнеса с помощью ADFS; вы можете отключить BrowserSsoEnabled. BrowserSsoEnabled позволяет ADFS получать PRT (основной маркер обновления) от клиента, который содержит сведения об устройстве. Без проверки подлинности устройств ADFS не будет работать на устройствах Windows 10.

### <a name="how-long-are-ad-fs-tokens-valid"></a>Как долго действительны маркеры AD FS?

Часто этот вопрос означает "как долго пользователи получают единый вход (SSO) без необходимости вводить новые учетные данные и как этим может управлять администратор?"  Это поведение и параметры конфигурации, управляющие этими параметрами, описаны в статье [Параметры единого входа AD FS](../operations/ad-fs-single-sign-on-settings.md).

Ниже перечислено время существования различных файлов cookie и маркеров по умолчанию (а также параметры, которые регулируют время существования):

**Зарегистрированные устройства**

- Файлы cookie PRT и SSO: 90 дней максимум, регулируется по PSSOLifeTimeMins. (Указанное устройство используется по крайней мере каждые 14 дней, которое управляется DeviceUsageWindow).

- Маркер обновления: вычисляется на основе приведенного выше, чтобы обеспечить единообразное поведение

- access_token: 1 час по умолчанию на основе проверяющей стороны.

- id_token: аналогично маркеру доступа.

**Незарегистрированные устройства**

- Файлы cookie единого входа: по умолчанию по 8 часов регулируется SSOLifetimeMins.  Когда функция Keep Me Signed in (KMSI) включена, по умолчанию она доступна в течение 24 часов и может быть сконфигурирована с помощью KMSILifetimeMins.


- Токен обновления: по умолчанию 8 часов. 24 часа при включенной системе KMSI

- access_token: 1 час по умолчанию на основе проверяющей стороны.

- id_token: аналогично маркеру доступа.

### <a name="does-ad-fs-support-http-strict-transport-security-hsts"></a>Поддерживает ли AD FS протокол HTTP-безопасности (HSTS)?

Протокол HTTP для обеспечения безопасности транспорта (HSTS) — это механизм политики веб-безопасности, который помогает снизить атаки на понижение уровня протокола и захват файлов cookie для служб, которые имеют конечные точки HTTP и HTTPS. Он позволяет веб-серверам объявлять, что веб-браузер (или другие агенты пользователя) должны взаимодействовать с ним только с помощью протокола HTTPS и никогда через протокол HTTP.

Все конечные точки AD FS для трафика веб-проверки подлинности открываются исключительно по протоколу HTTPS.  В результате AD FS эффективно устраняет угрозы, предоставляемые механизмом политики безопасности транспортного протокола HTTP (при проектировании нет перехода на более раннюю версию HTTP, так как в HTTP нет прослушивателей). Кроме того, AD FS предотвращает отправку файлов cookie на другой сервер с конечными точками протокола HTTP, помечая все файлы cookie флагом Secure.

Поэтому реализация HSTS на сервере AD FS не требуется, так как она никогда не может быть понижена.  В целях обеспечения соответствия AD FS серверы соответствуют этим требованиям, так как они никогда не используют протокол HTTP, а все файлы cookie помечены как безопасные.

Кроме того, AD FS 2016 (с наиболее актуальными исправлениями) и AD FS 2019 поддерживает выпуск заголовка HSTS. Чтобы настроить его, см. статью [Настройка заголовков ответа безопасности HTTP с помощью AD FS](../operations/customize-http-security-headers-ad-fs.md)

### <a name="x-ms-forwarded-client-ip-does-not-contain-the-ip-of-the-client-but-contains-ip-of-the-firewall-in-front-of-the-proxy-where-can-i-get-the-right-ip-of-the-client"></a>X-ms-forwarded-client-ip не содержит IP-адрес клиента, но содержит IP-адрес брандмауэра перед прокси-сервером. Где можно получить правильный IP-адрес клиента?
Не рекомендуется завершать SSL-завершение до WAP. Если завершение SSL выполняется перед WAP, X-ms-forwarded-client-ip будет содержать IP-адрес сетевого устройства перед WAP. Ниже приведено краткое описание различных утверждений, связанных с IP-адресами, которые поддерживаются AD FS.
 - x-ms-client-ip : Сетевой IP-адрес устройства, подключенного к службе STS.  В случае запроса из экстрасети он всегда содержит IP-адрес WAP.
 - x-ms-forwarded-client-ip : Многозначное утверждение, которое будет содержать любые значения, перенаправляемые в ADFS службой Exchange Online, и IP-адрес устройства, подключенного к WAP.
 - Userip: Для запросов экстрасети это утверждение будет содержать значение x-ms-forwarded-client-ip.  Для запросов в интрасети это утверждение будет содержать то же значение, что и x-ms-client-ip.

 Кроме того, в AD FS 2016 (с наиболее актуальными исправлениями) и более поздних версиях также поддерживается запись заголовка x-forwarded-for. Все подсистемы балансировки нагрузки или сетевые устройства, не пересылаемые на уровне 3 (IP-адрес сохраняется), должны добавлять входящий IP-адрес клиента в стандартный заголовок x-forwarded-for.

### <a name="i-am-trying-to-get-additional-claims-on-the-user-info-endpoint-but-its-only-returning-subject-how-can-i-get-additional-claims"></a>Я пытаюсь получить дополнительные утверждения в конечной точке сведений о пользователе, но она только возвращает субъект. Как получить дополнительные заявки?
Конечная точка UserInfo AD FS всегда возвращает утверждение субъекта, как указано в стандартах OpenID Connect. AD FS не предоставляет дополнительные утверждения, запрошенные через конечную точку UserInfo. Если вам требуются дополнительные утверждения в маркере идентификации, обратитесь к [Пользовательским маркерам безопасности в AD FS](../development/custom-id-tokens-in-ad-fs.md).

### <a name="why-do-i-see-a-lot-of-1021-errors-on-my-ad-fs-servers"></a>Почему на моих AD FS серверах отображается много ошибок 1021?
Это событие обычно регистрируется для недействительного доступа к ресурсам в AD FS для ресурса 00000003-0000-0000-C000-000000000000. Эта ошибка вызвана ошибочным поведением клиента, на котором он пытается получить маркер доступа для службы Azure AD Graph. Так как ресурс отсутствует в AD FS, это приводит к событию события с идентификатором 1021 на серверах AD FS. Можно спокойно игнорировать любые предупреждения или ошибки для ресурса 00000003-0000-0000-C000-000000000000 на AD FS.

### <a name="why-am-i-seeing-a-warning-for-failure-to-add-the-ad-fs-service-account-to-the-enterprise-key-admins-group"></a>Почему я вижу предупреждение о сбое добавления учетной записи службы AD FS в группу "Администраторы основного уровня предприятия"?
Эта группа создается только в том случае, если контроллер домена Windows 2016 с ролью FSMO PDC существует в домене. Чтобы устранить эту ошибку, можно создать группу вручную и выполнить указанные ниже действия, чтобы предоставить необходимые разрешения после добавления учетной записи службы в качестве члена группы.
1.    Откройте оснастку **Пользователи и компьютеры Active Directory**.
2.    **Щелкните правой кнопкой мыши** имя домена в области навигации и выберите пункт **Свойства**.
3.    **Щелкните** "Безопасность" (Если вкладка "Безопасность" отсутствует, включите "Дополнительные параметры" из меню "Вид").
4.    **Щелкните** "Дополнительно". **Щелкните** "Добавить". **Щелкните** "Выбор участника".
5.    Откроется диалоговое окно "Выбор пользователей, компьютеров, учетных записей служб или групп".  В текстовое поле введите имена выбираемых объектов, введите Группа администраторов предприятия.  Нажмите кнопку "ОК".
6.    В поле со списком "Применяется к" выберите **Descendant User objects**.
7.    С помощью полосы прокрутки перейдите в нижнюю часть страницы и нажмите **Очистить все**.
8.    В разделе **Свойства** выберите пункты **Чтение msDS-KeyCredentialLink** и **Запись msDS-KeyCrendentialLink**.

### <a name="why-does-modern-authentication-from-android-devices-fail-if-the-server-does-not-send-all-the-intermediate-certificates-in-the-chain-with-the-ssl-cert"></a>Почему не удается выполнить современные проверки подлинности на устройствах Android, если сервер не отправляет все промежуточные сертификаты в цепочку с SSL-сертификатом?

Федеративные пользователи могут столкнуться с проверкой подлинности в Azure AD для приложений, использующих библиотеку ADAL для Android. Приложение получит **AuthenticationException** при попытке отобразить страницу входа. В Chrome страница входа AD FS может быть вызвана как незащищенная.

Android - во всех версиях и на всех устройствах - не поддерживает загрузку дополнительных сертификатов из поля сертификата **authorityInformationAccess**. Это относится и к браузеру Chrome. Любой сертификат проверки подлинности сервера, в котором отсутствуют промежуточные сертификаты, приведет к этой ошибке, если вся цепочка сертификатов не будет передана из AD FS.

Правильным решением этой проблемы является настройка AD FS и WAP серверов на отправку необходимых промежуточных сертификатов вместе с сертификатом SSL.

При экспорте SSL сертификата с одного компьютера, который будет импортирован в личное хранилище компьютера, AD FS и WAP сервера (серверов), убедитесь, что экспортировали закрытый ключ и выберите **файл обмена личной информацией — PKCS #12**.

Очень важно отметить флажок **Включить все сертификаты в путь сертификата, если это возможно**, а также **Экспортировать все расширенные свойства**.

Запустите certlm.msc на серверах Windows и импортируйте *.PFX-файл в личное хранилище сертификатов компьютера. Это приведет к тому, что сервер передаст всю цепочку сертификатов в библиотеку ADAL.

>[!NOTE]
> Хранилище сертификатов подсистем балансировки сетевой нагрузки также должно быть обновлено для включения целой цепочки сертификатов, если она есть

### <a name="does-ad-fs-support-head-requests"></a>Поддерживает ли AD FS запросы HEAD?
AD FS не поддерживает запросы HEAD.  Приложения не должны использовать запросы HEAD к конечным точкам AD FS.  Это может привести к неожиданным и/или задержанным ответам на ошибки HTTP.  Кроме того, в журнале событий AD FS могут отображаться непредвиденные события ошибок.

### <a name="why-am-i-not-seeing-a-refresh-token-when-i-am-logging-in-with-a-remote-idp"></a>Почему я не вижу маркер обновления при входе с помощью удаленного IdP?
Обновленный маркер не выдается, если выданный IdP маркер имеет срок действия менее 1 часа. Чтобы убедиться, что маркер обновления выдается, увеличьте срок действия маркера, выданного IdP, на более чем 1 час.

### <a name="do-we-have-any-way-to-change-rp-token-encryption-algorithm"></a>Есть ли способ изменить алгоритм шифрования маркеров RP?
По умолчанию для шифрования маркеров RP задано значение AES256, и оно не может быть изменено на другое.

### <a name="on-a-mixed-mode-farm-i-get-error-when-trying-to-set-the-new-ssl-certificate-using-set-adfssslcertificate--thumbprint-how-can-i-update-the-ssl-certificate-in-a-mixed-mode-ad-fs-farm"></a>В ферме со смешанным режимом при попытке задать новый SSL-сертификат с помощью Set-AdfsSslCertificate-Thumbprint возникает ошибка. Как обновить SSL-сертификат в ферме смешанного режима AD FS?
Фермы AD FS смешанного режима являются переходными состояниями. Перед обновлением SSL-сертификата рекомендуется либо переключиться на сертификат SSL, либо завершить процесс, а также повысить уровень поведения фермы. В случае, если это не было сделано, приведенные ниже инструкции предоставляют возможность обновления SSL-сертификата.

На серверах WAP можно по-прежнему использовать Set-WebApplicationProxySslCertificate. На серверах ADFS необходимо использовать Netsh. Выполните действия, указанные ниже.

1. Выберите подмножество серверов ADFS 2016 для обслуживания (например, удалить из балансировщика нагрузки).
2. На серверах, выбранных в #1, импортируйте новый сертификат с помощью MMC.
3. Удаление существующих сертификатов

    a. netsh http delete sslcert hostnameport=fs.contoso.com:443 b. netsh http delete sslcert hostnameport=localhost:443 c. netsh http delete sslcert hostnameport=fs.contoso.com:49443

4.  Добавление нового сертификата

    a. netsh http add sslcert hostnameport=fs.contoso.com:443 certhash=CERTTHUMBPRINT appid={5d89a20c-beab-4389-9447-324788eb944a} certstorename=MY sslctlstorename=AdfsTrustedDevices

    b. netsh http add sslcert hostnameport=localhost:443 certhash=CERTTHUMBPRINT appid={5d89a20c-beab-4389-9447-324788eb944a} certstorename=MY sslctlstorename=AdfsTrustedDevices

    c. netsh http add sslcert hostnameport=fs.contoso.com:49443 certhash=CERTTHUMBPRINT appid={5d89a20c-beab-4389-9447-324788eb944a} certstorename=MY sslctlstorename=AdfsTrustedDevices

5. Перезапуск службы ADFS на выбранном сервере
6. Удаление подмножества серверов WAP для обслуживания
7. На выбранных серверах WAP импортируйте новый сертификат через MMC.
8. Настройка нового сертификата на сервере WAP с помощью командлета

    a. Set-WebApplicationProxySslCertificate -Thumbprint " CERTTHUMBPRINT"

9. Перезапуск службы на выбранных серверах WAP
10. Верните выбранные серверы WAP и AD FS в рабочую среду.

Выполните обновление на остальных серверах AD FS и WAP аналогичным образом.

### <a name="is-adfs-supported-when-web-application-proxy-wap-servers-are-behind-azure-web-application-firewallwaf"></a>Поддерживаются ли ADFS, когда серверы прокси веб-приложения (WAP) находятся за брандмауэром веб-приложения Azure (WAF)?
Службы ADFS и серверы веб-приложений поддерживают любой брандмауэр, который не выполняет завершение SSL на конечной точке. Кроме того, серверы ADFS и WAP имеют встроенные механизмы для предотвращения распространенных веб-атак, таких как межсайтовые сценарии, прокси-сервер ADFS и удовлетворяют все требования, определенных [протоколом MS-ADFSPIP](/openspecs/windows_protocols/ms-adfspip/76deccb1-1429-4c80-8349-d38e61da5cbb).

### <a name="i-am-seeing-an-event-441-a-token-with-a-bad-token-binding-key-was-found-what-should-i-do-to-resolve-this"></a>Я вижу "Event 441: Обнаружен маркер с неверным ключом привязки токена." Что мне делать для решения этой проблемы?
В AD FS 2016 привязка токенов включается автоматически и вызывает несколько известных проблем в сценариях прокси-сервера и федерации, что приводит к этой ошибке. Чтобы устранить эту проблему, выполните следующую команду PowerShell и удалите поддержку привязки маркеров.

`Set-AdfsProperties -IgnoreTokenBinding $true`

### <a name="i-have-upgraded-my-farm-from-ad-fs-in-windows-server-2016-to-ad-fs-in-windows-server-2019-the-farm-behavior-level-for-the-ad-fs-farm-has-been-successfully-raised-to-2019-but-the-web-application-proxy-configuration-is-still-displayed-as-windows-server-2016"></a>Я обновил мою ферму с AD FS в Windows Server 2016 на AD FS в Windows Server 2019. Уровень поведения фермы для фермы AD FS успешно повышен до версии 2019, но конфигурация прокси-сервера веб приложения по-прежнему отображается как Windows Server 2016?
После обновления до Windows Server 2019 версия конфигурации прокси веб-приложения продолжит отображаться как Windows Server 2016. Прокси веб-приложения не имеет новых функций для версии Windows Server 2019, и если уровень поведения фермы был успешно создан на AD FS, прокси веб-приложения продолжит отображаться как Windows Server 2016 по своей разработке.

### <a name="can-i-estimate-the-size-of-the-adfsartifactstore-before-enabling-esl"></a>Можно ли оценить размер ADFSArtifactStore перед включением ESL?
При включенном ESL, AD FS отслеживает действия учетной записи и известные расположения для пользователей в базе данных ADFSArtifactStore. Размер этой базы данных масштабируется относительно числа отслеживаемых пользователей и известных расположений. Планируя включить ESL, вы можете оценить размер базы данных ADFSArtifactStore для роста до 1 ГБ на 100 000 пользователей. Если ферма AD FS использует внутреннюю базу данных Windows (WID), расположением по умолчанию для файлов базы данных является C:\Windows\WID\Data. Чтобы предотвратить заполнение этого диска, перед включением ESL убедитесь, что у вас есть как минимум 5 ГБ свободного места в хранилище. В дополнение к дисковому хранилищу, планируйте рост общей памяти процесса после включения ESL на дополнительный 1 ГБ оперативной памяти для пользователей численностью 500 000 или меньше.

### <a name="i-am-seeing-event-570-active-directory-trust-enumeration-was-unable-to-enumerate-one-of-more-domains-due-to-the-following-error-enumeration-will-continue-but-the-active-directory-identifier-list-may-not-be-correct-validate-that-all-expected-active-directory-identifiers-are-present-by-running-get-adfsdirectoryproperties-on-ad-fs-2019-what-is-the-mitigation-for-this-event"></a>Я вижу в AD FS 2019 следующее уведомление: Event 570 (Active Directory trust enumeration was unable to enumerate one of more domains due to the following error. Enumeration will continue but the Active Directory identifier list may not be correct. Validate that all expected Active Directory identifiers are present by running Get-ADFSDirectoryProperties) (Событие 570 (Функции перечисления доверия Active Directory не удалось перечислить один из доменов из-за следующей ошибки. Перечисление будет продолжено, но список идентификаторов Active Directory может быть неправильным. Убедитесь, что представлены все ожидаемые идентификаторы Active Directory, выполнив команду Get-ADFSDirectoryProperties)). Как предотвратить это событие?
Это событие возникает, когда леса не являются доверенными, а AD FS пытается перечислить все леса в цепочке доверенных лесов и подключиться к ним. Например, если лес A и лес B AD FS являются доверенными, как и лес B и лес C, AD FS перечислит все три леса и попытается найти доверие между лесами A и C. Если пользователи из леса, который вызывает ошибку, должны пройти проверку подлинности AD FS, настройте доверие между лесом AD FS лесом и лесом, вызывающим ошибку. Если пользователям из леса, вызывающего ошибку, не нужно проходить проверку подлинности с помощью AD FS, эту ошибку следует игнорировать.

### <a name="i-am-seeing-an-event-id-364-microsoftidentityserverauthenticationfailedexception-msis5015-authentication-of-the-presented-token-failed-token-binding-claim-in-token-must-match-the-binding-provided-by-the-channel-what-should-i-do-to-resolve-this"></a>Я вижу следующее уведомление: Event ID 364: Microsoft.IdentityServer.AuthenticationFailedException: MSIS5015: Authentication of the presented token failed. Token Binding claim in token must match the binding provided by the channel (Событие 364: Microsoft.IdentityServer.AuthenticationFailedException: MSIS5015: не удалось проверить подлинность представленного маркера. Утверждение привязки маркера в маркере должно соответствовать привязке, предоставленной каналом). Что мне делать для решения этой проблемы?
В AD FS 2016 привязка токенов включается автоматически и вызывает несколько известных проблем в сценариях прокси-сервера и федерации, что приводит к этой ошибке. Чтобы устранить эту проблему, выполните следующую команду PowerShell и удалите поддержку привязки маркеров.

`Set-AdfsProperties -IgnoreTokenBinding $true`
