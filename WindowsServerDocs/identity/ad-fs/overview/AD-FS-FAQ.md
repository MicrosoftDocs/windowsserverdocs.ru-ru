---
ms.assetid: acc9101b-841c-4540-8b3c-62a53869ef7a
title: ВОПРОСЫ И ОТВЕТЫ ПО AD FS
description: Часто задаваемые вопросы о AD FS
author: billmath
ms.author: billmath
manager: mtillman
ms.date: 04/17/2019
ms.topic: article
ms.custom: it-pro
ms.prod: windows-server
ms.technology: identity-adfs
ms.openlocfilehash: 48d93f515a5f3e5f8ce2c3ff9a1b40f300ca57ed
ms.sourcegitcommit: c5709021aa98abd075d7a8f912d4fd2263db8803
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/18/2020
ms.locfileid: "76265746"
---
# <a name="ad-fs-frequently-asked-questions-faq"></a>AD FS часто задаваемые вопросы


В следующей документации приведены часто задаваемые вопросы относительно службы федерации Active Directory (AD FS).  Документ был разбит на группы в зависимости от типа вопроса.

## <a name="deployment"></a>Развертывание

### <a name="how-can-i-upgrademigrate-from-previous-versions-of-ad-fs"></a>Как обновить или перенести предыдущие версии AD FS
Обновление AD FS можно выполнить одним из следующих средств:


- Windows Server 2012 R2 AD FS для Windows Server 2016 AD FS или более поздней версии. Обратите внимание, что при обновлении с Windows Server 2016 AD FS до Windows Server 2019 AD FS методология будет одинаковой. 
    - [Обновление до AD FS в Windows Server 2016 с помощью базы данных WID](../deployment/Upgrading-to-AD-FS-in-Windows-Server-2016.md)
    - [Обновление до AD FS в Windows Server 2016 с помощью базы данных SQL](../deployment/Upgrading-to-AD-FS-in-Windows-Server-2016-SQL.md)
- Windows Server 2012 AD FS Windows Server 2012 R2 AD FS
    - [Переход на AD FS в Windows Server 2012 R2](https://technet.microsoft.com/library/dn486815.aspx)
- AD FS 2,0 на Windows Server 2012 AD FS
    - [Переход на AD FS в Windows Server 2012](https://technet.microsoft.com/library/jj647765.aspx)
- AD FS 1. x для AD FS 2,0
    - [Обновление с AD FS 1. x до AD FS 2,0](https://technet.microsoft.com/library/ff678035.aspx)

Если необходимо выполнить обновление с AD FS 2,0 или 2,1 (Windows Server 2008 R2 или Windows Server 2012), необходимо использовать встроенные скрипты (расположенные в К:\виндовс\адфс).

### <a name="why-does-ad-fs-installation-require-a-reboot-of-the-server"></a>Почему AD FS установки требуется перезагрузка сервера?

Поддержка HTTP/2 была добавлена в Windows Server 2016, но HTTP/2 нельзя использовать для проверки подлинности сертификата клиента.  Поскольку многие AD FS сценарии используют проверку подлинности на основе сертификата клиента, а значительное число клиентов не поддерживает повторные запросы с помощью HTTP/1.1, AD FS конфигурация фермы перенастраивает параметры HTTP локального сервера на HTTP/1.1.  Для этого требуется перезагрузка сервера.  

### <a name="is-using-windows-2016-wap-servers-to-publish-the-ad-fs-farm-to-the-internet-without-upgrading-the-back-end-ad-fs-farm-supported"></a>Использует ли Windows 2016 WAP-серверы для публикации фермы AD FS в Интернете без обновления поддерживаемой серверной фермы AD FS?
Да, эта конфигурация поддерживается, однако в этой конфигурации не будут поддерживаться новые функции AD FS 2016.  Эта конфигурация должна быть временной на этапе миграции с AD FS 2012 R2 на AD FS 2016 и не должна развертываться в течение длительного периода времени.

### <a name="is-it-possible-to-deploy-ad-fs-for-office-365-without-publishing-a-proxy-to-office-365"></a>Можно ли развернуть AD FS для Office 365 без публикации прокси-сервера в Office 365?
Да, это поддерживается. Однако в качестве побочного действия

1. Вам потребуется вручную управлять обновлением сертификатов для подписи маркеров, так как Azure AD не сможет получить доступ к метаданным федерации. Дополнительные сведения об обновлении сертификата для подписи маркера вручную см. в статье [продление сертификатов федерации для Office 365 и Azure Active Directory](https://docs.microsoft.com/azure/active-directory/connect/active-directory-aadconnect-o365-certs)
2. Вы не сможете использовать прежние потоки проверки подлинности (например, поток проверки подлинности Ексо прокси)

### <a name="what-are-load-balancing-requirements-for-ad-fs-and-wap-servers"></a>Каковы требования к балансировке нагрузки для серверов AD FS и WAP?

AD FS — это система без отслеживания состояния. Таким образом, балансировка нагрузки довольно проста для имен входа. Ниже приведены основные рекомендации для систем балансировки нагрузки.


- Подсистемы балансировки нагрузки не должны быть настроены с учетом соответствия IP-адресов. Это может привести к источником значительного нагрузки на подмножество серверов в определенных сценариях Exchange Online.
- Подсистемы балансировки нагрузки не должны завершать подключения HTTPS и повторно инициировать новое подключение к серверу ADFS.
- Подсистемы балансировки нагрузки должны гарантировать, что подключающийся IP-адрес должен быть преобразован в качестве исходного IP-адреса в пакет HTTP при отправке в ADFS. Если балансировщик нагрузки не может отправить исходный IP-адрес в HTTP-пакете, подсистема балансировки нагрузки должна добавить (или добавить в случае существующего) IP-адреса к заголовку x-forwardd-for. Это необходимо для правильной обработки определенных компонентов, связанных с протоколом IP (запрещенный IP-адрес, интеллектуальная блокировка экстрасети,...) и может привести к снижению безопасности при неправильной настройке.
- Подсистемы балансировки нагрузки должны поддерживать SNI. В этом случае убедитесь, что AD FS настроены для создания привязок HTTPS для поддержки клиентов, не поддерживающих SNI.
- Подсистемы балансировки нагрузки должны использовать конечную точку проверки работоспособности HTTP AD FS, чтобы определить, работают ли AD FS или WAP-серверы и исключают их, если 200 ОК не возвращается.

### <a name="what-multi-forest-configurations-are-supported-by-ad-fs"></a>Какие конфигурации с несколькими лесами поддерживаются AD FS?

AD FS поддерживает несколько конфигураций с несколькими лесами и использует основную сеть AD DS доверия для проверки подлинности пользователей в нескольких доверенных сферах. Мы настоятельно рекомендуем использовать двустороннее доверие лесов, так как это упрощенная программа установки, обеспечивающая правильную работу подсистемы доверия без проблем. Дополнительного

- В случае одностороннего отношения доверия с лесом, например леса ДЕМИЛИТАРИЗОВАНной зоны, содержащего удостоверения партнеров, мы рекомендуем развернуть ADFS в лесу Corp и расрассматривать лес DMZ как другое локальное доверие поставщика утверждений, подключенное через LDAP. В этом случае встроенная проверка подлинности Windows не будет работать для пользователей леса сети периметра, и они должны будут выполнять проверку подлинности паролей, так как это единственный поддерживаемый механизм для протокола LDAP. В случае невозможности этого варианта вам потребуется настроить другой ADFS в лесу ДЕМИЛИТАРИЗОВАНной зоны и добавить его в качестве отношения доверия поставщика утверждений в ADFS в лесу Corp. Пользователям потребуется обнаружение домашней области, но будет работать встроенная проверка подлинности Windows и проверка подлинности паролей. Внесите соответствующие изменения в правила выдачи в ADFS в лесу DMZ, так как ADFS в лесу Corp не сможет получить дополнительные сведения о пользователе из леса ДЕМИЛИТАРИЗОВАНной зоны.
- Хотя отношения доверия на уровне домена поддерживаются и могут работать, мы настоятельно рекомендуем перейти на модель доверия на уровне леса. Кроме того, необходимо убедиться, что маршрутизация имени участника-пользователя и разрешение имен NETBIOS должны работать правильно.

>[!NOTE]  
>Если используется проверка подлинности елективе с конфигурацией с двусторонним доверием, убедитесь, что пользователю-участнику предоставлено разрешение "разрешить проверку подлинности" в учетной записи целевой службы. 


## <a name="design"></a>Оформление

### <a name="what-third-party-multi-factor-authentication-providers-are-available-for-ad-fs"></a>Какие сторонние поставщики многофакторной идентификации доступны для AD FS?
AD FS предоставляет расширяемый механизм для интеграции сторонних поставщиков MFA. Для этого не задана программа сертификации. Предполагается, что поставщик выполнил необходимые проверки перед выпуском. 

Список поставщиков, которые получили уведомления Майкрософт, публикуются в [поставщиках MFA для AD FS](../operations/Configure-Additional-Authentication-Methods-for-AD-FS.md).  Всегда могут быть доступны поставщики, о которых мы незнакомы, и мы будем обновлять список, как мы будем изучать.

### <a name="are-third-party-proxies-supported-with-ad-fs"></a>Поддерживаются ли AD FSы сторонними прокси-серверами?
Да, сторонние прокси-серверы могут размещаться перед прокси, но любой сторонний прокси должен поддерживать [протокол MS-адфспип](https://msdn.microsoft.com/library/dn392811.aspx) , используемый вместо прокси веб-приложения.

Ниже приведен список поставщиков третьих лиц, о которых мы осведомлены.  Всегда могут быть доступны поставщики, о которых мы незнакомы, и мы будем обновлять список, как мы будем изучать.

- [F5 доступ к диспетчеру политики](https://support.f5.com/kb/en-us/products/big-ip_apm/manuals/product/apm-third-party-integration-13-1-0/12.html#guid-1ee8fbb3-1b33-4982-8bb3-05ae6868d9ee)


### <a name="where-is-the-capacity-planning-sizing-spreadsheet-for-ad-fs-2016"></a>Где находится таблица для изменения размера планирования ресурсов для AD FS 2016?
Версию AD FS 2016 электронной таблицы можно скачать [здесь](http://adfsdocs.blob.core.windows.net/adfs/ADFSCapacity2016.xlsx).
Это также можно использовать для AD FS в Windows Server 2012 R2.

### <a name="how-can-i-ensure-my-ad-fs-and-wap-servers-support-apples-atp-requirements"></a>Как убедиться, что мои AD FS и серверы WAP поддерживают требования к ATP?

Компания Apple выпустила ряд требований, именуемых безопасностью транспорта приложений (ATS), которые могут повлиять на вызовы из приложений iOS, которые проходят проверку подлинности в AD FS.  Вы можете убедиться, что AD FS и серверы WAP соответствуют [требованиям для подключения с помощью ATS](https://developer.apple.com/library/prerelease/content/documentation/General/Reference/InfoPlistKeyReference/Articles/CocoaKeys.html#//apple_ref/doc/uid/TP40009251-SW57).  
В частности, следует убедиться, что серверы AD FS и WAP поддерживают TLS 1,2 и что согласованный комплект шифров TLS будет поддерживать идеальную пересылку.

Вы можете включить и отключить SSL 2,0 и 3,0 и TLS версии 1,0, 1,1 и 1,2, используя [Управление протоколами SSL в AD FS](../operations/Manage-SSL-Protocols-in-AD-FS.md).

Чтобы серверы AD FS и WAP согласовывались только с комплектами шифров TLS, поддерживающими ATP, можно отключить все комплекты шифров, которые не входят в список комплектов [шифров, совместимых с ATP](https://developer.apple.com/library/prerelease/content/documentation/General/Reference/InfoPlistKeyReference/Articles/CocoaKeys.html#//apple_ref/doc/uid/TP40009251-SW57).  Для этого используйте [командлеты Windows TLS PowerShell](https://technet.microsoft.com/itpro/powershell/windows/tls/index).

## <a name="developer"></a>Разработчик

### <a name="when-generating-an-id_token-with-adfs-for-a-user-authenticated-against-ad-how-is-the-sub-claim-generated-in-the-id_token"></a>Как подзапрос "подсистема", созданный в id_token, при создании id_token с ADFS для пользователя, прошедшего проверку подлинности в AD?
Значение утверждения "подзапрос" — это хэш-код клиента + значение утверждения привязки.

### <a name="what-is-the-lifetime-of-the-refresh-tokenaccess-token-when-the-user-logs-in-via-a-remote-claims-provider-trust-over-ws-fedsaml-p"></a>Каково время существования маркера обновления или маркера доступа, когда пользователь входит в систему через удаленное доверие поставщика утверждений через WS-подача/SAML-P?
Время существования маркера обновления станет временем существования маркера, который ADFS получил от отношения доверия поставщика удаленных утверждений. Время существования маркера доступа будет равно времени существования токена проверяющей стороны, для которой выдается маркер доступа.

### <a name="i-need-to-return-profile-and-email-scopes-as-well-in-addition-to-the-openid-scope-can-i-obtain-additional-information-using-scopes-how-to-do-it-in-ad-fs"></a>Кроме того, необходимо вернуть области профиля и электронной почты, а также область OpenID Connect. Можно ли получить дополнительные сведения с помощью областей? Как это сделать в AD FS?
Для добавления релевантной информации в id_token можно использовать настраиваемые id_token. Дополнительные сведения см. в статье [Настройка утверждений, которые будут выдаваться в id_token](../development/Custom-Id-Tokens-in-AD-FS.md).

### <a name="how-to-issue-json-blobs-inside-jwt-tokens"></a>Как выдавать большие двоичные объекты JSON внутри маркеров JWT?
Специальный ValueType ("<http://www.w3.org/2001/XMLSchema#json>") и escape-символ (\x22) для этого был добавлен в AD FS 2016. Ниже приведен пример для правила выдачи, а также окончательные выходные данные маркера доступа.

Пример правила выдачи:

    => issue(Type = "array_in_json", ValueType = "http://www.w3.org/2001/XMLSchema#json", Value = "{\x22Items\x22:[{\x22Name\x22:\x22Apple\x22,\x22Price\x22:12.3},{\x22Name\x22:\x22Grape\x22,\x22Price\x22:3.21}],\x22Date\x22:\x2221/11/2010\x22}");

Заявка, выданная в маркере доступа:

    "array_in_json":{"Items":[{"Name":"Apple","Price":12.3},{"Name":"Grape","Price":3.21}],"Date":"21/11/2010"}

### <a name="can-i-pass-resource-value-as-part-of-the-scope-value-like-how-requests-are-done-against-azure-ad"></a>Можно ли передавать значение ресурса как часть значения области, например, как запросы выполняются в Azure AD?
С AD FS на сервере 2019 теперь можно передать значение ресурса, внедренное в параметр Scope. Параметр области можно упорядочить в виде списка с разделителями-пробелами, где каждая запись представляет собой структуру как ресурс или область. Например:  
**< создать допустимый пример запроса >**

### <a name="does-ad-fs-support-pkce-extension"></a>Поддерживает ли AD FS расширение PKCE?
AD FS в сервере 2019 поддерживает ключ проверки подлинности для обмена кодом (PKCE) для потока предоставления кода авторизации OAuth

### <a name="what-permitted-scopes-are-supported-by-ad-fs"></a>Какие разрешенные области поддерживаются AD FS?
- Аза — если используются [расширения протокола OAuth 2,0 для клиентов брокера](https://docs.microsoft.com/openspecs/windows_protocols/ms-oapxbc/2f7d8875-0383-4058-956d-2fb216b44706) и параметр scope содержит область "аза", сервер выдает новый основной маркер обновления и устанавливает его в refresh_token поле ответа, а также задает для поля refresh_token_expires_in значение времени существования нового основного маркера обновления, если оно применяется.
- OpenID Connect — позволяет приложению запрашивать использование протокола авторизации OpenID Connect Connect.
- logon_cert. область logon_cert позволяет приложению запрашивать сертификаты входа в систему, которые можно использовать для интерактивного входа пользователей, прошедших проверку подлинности. AD FS сервер пропускает параметр access_token из ответа и вместо этого предоставляет цепочку сертификатов CMS в кодировке Base64 или полный ответ PKI. Дополнительные сведения можно найти [здесь](https://docs.microsoft.com/openspecs/windows_protocols/ms-oapx/32ce8878-7d33-4c02-818b-6c9164cc731e). 
- user_impersonation — область user_impersonationа необходима для успешного запроса маркера доступа от имени из AD FS. Дополнительные сведения об использовании этой области см. в статье [Создание многоуровневого приложения с использованием on-OBO с помощью OAuth с AD FS 2016](../../ad-fs/development/ad-fs-on-behalf-of-authentication-in-windows-server.md).
- vpn_cert. область vpn_cert позволяет приложению запрашивать сертификаты VPN, которые можно использовать для установки VPN-подключений с использованием проверки подлинности по ПРОТОКОЛу TLS. Это больше не поддерживается.
- Электронная почта. позволяет приложению запрашивать утверждение по электронной почте для пользователя, выполнившего вход. Это больше не поддерживается. 
- профиль. разрешает приложению запрашивать утверждения, связанные с профилем пользователя для входа. Это больше не поддерживается. 


## <a name="operations"></a>Операции

### <a name="how-do-i-replace-the-ssl-certificate-for-ad-fs"></a>Разделы справки заменить SSL-сертификат для AD FS?
AD FS SSL-сертификат не совпадает с сертификатом связи AD FS службы, найденным в оснастке управления AD FS.  Чтобы изменить AD FS SSL-сертификат, необходимо использовать PowerShell. Следуйте указаниям в следующей статье:

[Управление SSL-сертификатами в AD FS и WAP 2016](../operations/Manage-SSL-Certificates-AD-FS-WAP-2016.md)

### <a name="how-can-i-enable-or-disable-tlsssl-settings-for-ad-fs"></a>Как включить или отключить параметры TLS/SSL для AD FS
Чтобы отключить или включить протоколы SSL и комплекты шифров, используйте следующую команду:

[Управление протоколами SSL в AD FS](../operations/Manage-SSL-Protocols-in-AD-FS.md)

### <a name="does-the-proxy-ssl-certificate-have-to-be-the-same-as-the-ad-fs-ssl-certificate"></a>Должен ли SSL-сертификат прокси совпадать с сертификатом AD FS SSL?  
Используйте следующие рекомендации в отношении SSL-сертификата прокси и сертификата AD FS SSL.


- Если прокси-сервер используется для прокси-запросов AD FS, использующих встроенную проверку подлинности Windows, прокси-сертификат SSL должен быть одинаковым (используйте тот же ключ), что и сертификат SSL сервера федерации.
- Если свойство AD FS "Екстендедпротектионтокенчекк" включено (параметр по умолчанию в AD FS), SSL-сертификат прокси должен быть одинаковым (используйте тот же ключ), что и сертификат SSL сервера федерации.
- В противном случае SSL-сертификат прокси может иметь другой ключ, отличный от сертификата AD FS SSL, но должен соответствовать тем же [требованиям](../overview/AD-FS-2016-Requirements.md) .

### <a name="why-do-i-only-see-a-password-login-on-ad-fs-and-not-my-other-authentication-methods-that-i-have-configured"></a>Почему я вижу только вход с паролем на AD FS, а не другие методы проверки подлинности, которые я настроил? 
AD FS на экране входа в систему отображается только один метод проверки подлинности, когда приложению явно требуется конкретный URI проверки подлинности, сопоставляемый с настроенным и включенным методом проверки подлинности. Это значение передается в параметре "wauth" для запросов WS-Federation и параметр "Рекуестедауснктксреф" в запросе протокола SAML. В результате отображается только запрошенный метод проверки подлинности (например, вход с помощью пароля).

Когда AD FS используется с Azure AD, приложения часто отправляют в Azure AD параметр prompt = Login. По умолчанию Azure AD преобразует это для запроса нового имени входа на основе пароля в AD FS. Это наиболее распространенная причина, по которой вход с паролем на AD FS в сети отсутствует или не отображается параметр для входа с помощью сертификата. Это можно легко исправлено, внеся изменения в параметры федеративного домена в Azure AD. 

Сведения о том, как это настроить, см. в разделе [службы федерации Active Directory (AD FS) Prompt = параметр входа support](../operations/AD-FS-Prompt-Login.md).

### <a name="how-can-i-change-the-ad-fs-service-account"></a>Как изменить учетную запись службы AD FS?
Чтобы изменить учетную запись службы AD FS, выполните инструкции, используя [модуль PowerShell учетной записи службы](https://github.com/Microsoft/adfsToolbox/tree/master/serviceAccountModule)панели инструментов AD FS.

### <a name="how-can-i-configure-browsers-to-use-windows-integrated-authentication-wia-with-ad-fs"></a>Как настроить браузеры для использования встроенной проверки подлинности Windows (WIA) с AD FS?

Сведения о настройке браузеров см. в разделе [Настройка браузеров для использования встроенной проверки подлинности Windows (WIA) с AD FS](../operations/Configure-AD-FS-Browser-WIA.md).

### <a name="can-i-turn-off-browserssoenabled"></a>Можно ли отключить Бровсерссоенаблед?
Если у вас нет политик управления доступом на основе устройства в ADFS или регистрации сертификата Windows Hello для бизнеса с помощью ADFS; Вы можете отключить Бровсерссоенаблед. Бровсерссоенаблед позволяет ADFS получать PRT (основной маркер обновления) от клиента, который содержит сведения об устройстве. Без проверки подлинности устройств ADFS не будет работать на устройствах Windows 10.

### <a name="how-long-are-ad-fs-tokens-valid"></a>Как долго AD FS маркеры допустимы?

Часто этот вопрос означает "как долго пользователи получают единый вход (SSO) без необходимости вводить новые учетные данные и как можно управлять администратором?  Это поведение и параметры конфигурации, управляющие им, описаны в статье [AD FS Параметры единого входа](https://technet.microsoft.com/windows-server-docs/identity/ad-fs/operations/ad-fs-2016-single-sign-on-settings).

Ниже перечислены времена жизни различных файлов cookie и маркеров по умолчанию (а также параметры, управляющие временем жизни):

**Зарегистрированные устройства**

- Файлы cookie PRT и SSO: максимум 90 дней, который регулируется Пссолифетимеминс. (Указанное устройство используется по крайней мере каждые 14 дней, которое управляется Девицеусажевиндов).

- Маркер обновления: вычисляется на основе приведенного выше, чтобы обеспечить единообразное поведение

- access_token: 1 час по умолчанию на основе проверяющей стороны

- id_token: то же, что и маркер доступа

**Незарегистрированные устройства**

- Файлы cookie единого входа: по умолчанию — 8 часов, которым управляет Ссолифетимеминс.  Если включено "оставаться в системе" (функции "оставаться), значение по умолчанию составляет 24 часа и настраивается через Кмсилифетимеминс.


- Маркер обновления: по умолчанию — 8 часов. 24 часа с включенным функции "оставаться

- access_token: 1 час по умолчанию на основе проверяющей стороны

- id_token: то же, что и маркер доступа

### <a name="does-ad-fs-support-http-strict-transport-security-hsts"></a>Поддерживает ли AD FS протокол HTTP-безопасности (HSTS)?  

Протокол HTTP для обеспечения безопасности транспорта (HSTS) — это механизм политики веб-безопасности, который помогает снизить атаки на понижение уровня протокола и захват файлов cookie для служб, которые имеют конечные точки HTTP и HTTPS. Он позволяет веб-серверам объявлять, что веб-браузер (или другие агенты пользователя) должны взаимодействовать с ним только с помощью протокола HTTPS и никогда через протокол HTTP.

Все конечные точки AD FS для трафика веб-проверки подлинности открываются исключительно по протоколу HTTPS.  В результате AD FS эффективно устраняет угрозы, предоставляемые механизмом политики безопасности транспортного протокола HTTP (при проектировании нет перехода на более раннюю версию HTTP, так как в HTTP нет прослушивателей). Кроме того, AD FS предотвращает отправку файлов cookie на другой сервер с конечными точками протокола HTTP, помечая все файлы cookie флагом Secure.

Поэтому реализация HSTS на сервере AD FS не требуется, так как она никогда не может быть понижена.  В целях обеспечения соответствия AD FS серверы соответствуют этим требованиям, так как они никогда не используют протокол HTTP, а все файлы cookie помечены как безопасные.

Кроме того, AD FS 2016 (с наиболее актуальными исправлениями) и AD FS 2019 поддерживает выпуск заголовка HSTS. Чтобы настроить его, см. раздел [Настройка заголовков ответа безопасности HTTP с помощью AD FS](../operations/customize-http-security-headers-ad-fs.md)

### <a name="x-ms-forwarded-client-ip-does-not-contain-the-ip-of-the-client-but-contains-ip-of-the-firewall-in-front-of-the-proxy-where-can-i-get-the-right-ip-of-the-client"></a>X-MS-Forwarded-Client-IP не содержит IP-адрес клиента, но содержит IP-адрес брандмауэра перед прокси-сервером. Где можно получить правильный IP-адрес клиента?
Не рекомендуется завершать SSL-завершение до WAP. Если завершение SSL выполняется перед WAP, X-MS-forwardd-Client-IP будет содержать IP-адрес сетевого устройства перед WAP. Ниже приведено краткое описание различных утверждений, связанных с IP-адресами, которые поддерживаются AD FS.
 - x-MS-Client-IP: сетевой IP-адрес устройства, подключенного к STS.  В случае запроса в экстрасеть всегда содержит IP-адрес WAP.
 - x-MS-Forwarded-Client-IP: утверждение с несколькими значениями, которое будет содержать любые значения, перенаправляемые в ADFS службой Exchange Online, и IP-адрес устройства, подключенного к WAP.
 - Усерип: для запросов в экстрасети это утверждение будет содержать значение x-MS-Forwarded-Client-IP.  Для запросов в интрасети это утверждение будет содержать то же значение, что и x-MS-Client-IP.

 Кроме того, в AD FS 2016 (с наиболее актуальными исправлениями) и более поздних версиях также поддерживается запись заголовка x-forwardd-for. Все подсистемы балансировки нагрузки или сетевые устройства, не пересылаемые на уровне 3 (IP-адрес сохраняется), должны добавлять входящий IP-адрес клиента в стандартный стандарт x-forwardd-for. 

### <a name="i-am-trying-to-get-additional-claims-on-the-user-info-endpoint-but-its-only-returning-subject-how-can-i-get-additional-claims"></a>Я пытаюсь получить дополнительные утверждения в конечной точке сведений о пользователе, но только возвращает субъект. Как получить дополнительные заявки?
Конечная точка UserInfo AD FS всегда возвращает утверждение субъекта, как указано в стандартах OpenID Connect. AD FS не предоставляет дополнительные утверждения, запрошенные через конечную точку UserInfo. Если вам требуются дополнительные утверждения в маркере идентификации, см. Дополнительные сведения о [токенах настраиваемых идентификаторов в AD FS](../development/custom-id-tokens-in-ad-fs.md).

### <a name="why-do-i-see-a-lot-of-1021-errors-on-my-ad-fs-servers"></a>Почему на моих AD FS серверах отображается много ошибок 1021?
Это событие обычно регистрируется для недопустимого доступа к ресурсам в AD FS для ресурса 00000003-0000-0000-C000-000000000000. Эта ошибка вызвана ошибочным поведением клиента, на котором он пытается получить маркер доступа для службы Azure AD Graph. Так как ресурс отсутствует в AD FS, это приводит к событию с ИДЕНТИФИКАТОРом 1021 на серверах AD FS. Можно спокойно игнорировать любые предупреждения или ошибки для ресурса 00000003-0000-0000-C000-000000000000 на AD FS.

### <a name="why-am-i-seeing-a-warning-for-failure-to-add-the-ad-fs-service-account-to-the-enterprise-key-admins-group"></a>Почему я вижу предупреждение о сбое добавления учетной записи службы AD FS в группу "Администраторы корпоративных ключей"?
Эта группа создается только в том случае, если контроллер домена Windows 2016 с ролью FSMO PDC существует в домене. Чтобы устранить эту ошибку, можно создать группу вручную и выполнить указанные ниже действия, чтобы предоставить необходимые разрешения после добавления учетной записи службы в качестве члена группы.
1.  Откройте **Пользователи и компьютеры Active Directory**.
2.  Щелкните **правой кнопкой мыши** имя домена в области навигации и **выберите пункт** свойства.
3.  **Нажмите кнопку** Безопасность (Если вкладка Безопасность отсутствует, включите дополнительные функции в меню Вид).
4.  **Нажмите кнопку** Продвинут. **Нажмите кнопку** Включить. **Нажмите кнопку** Выберите участника.
5.  Откроется диалоговое окно Выбор пользователя, компьютера, учетной записи службы или группы.  В текстовом поле введите имя объекта для выбора введите ключевая группа администраторов.  Нажмите кнопку "ОК".
6.  В списке применяется к выберите **потомки объекты пользователя**.
7.  С помощью полосы прокрутки прокрутите страницу вниз и **щелкните** очистить все.
8.  В разделе **Свойства** выберите **Read msDS-Кэйкредентиаллинк** и **Write msDS-кэйкредентиаллинк**.

### <a name="why-does-modern-authentication-from-android-devices-fail-if-the-server-does-not-send-all-the-intermediate-certificates-in-the-chain-with-the-ssl-cert"></a>Почему не удается выполнить современные проверки подлинности на устройствах Android, если сервер не отправляет все промежуточные сертификаты в цепочку с SSL-сертификатом?

Федеративные пользователи могут столкнуться с проверкой подлинности в Azure AD для приложений, использующих библиотеку ADAL для Android. Приложение получит **исключение** , когда попытается отобразить страницу входа. В Chrome страница входа AD FS может быть вызвана как незащищенная.

Android — во всех версиях и на всех устройствах — не поддерживает скачивание дополнительных сертификатов из поля **аусоритинформатионакцесс** сертификата. Это справедливо и в браузере Chrome. Любой сертификат проверки подлинности сервера, в котором отсутствуют промежуточные сертификаты, приведет к этой ошибке, если вся цепочка сертификатов не передается из AD FS.

Решением этой проблемы является настройка серверов AD FS и WAP на отправку необходимых промежуточных сертификатов вместе с SSL-сертификатом.

При экспорте SSL-сертификата с одного компьютера для импорта в личное хранилище компьютера AD FS и WAP-серверов обязательно экспортируйте закрытый ключ и выберите **файл обмена личной информацией — PKCS #12**.

Важно, чтобы флажок **включал все сертификаты в путь сертификата, если это возможно** , а также **экспортировать все расширенные свойства**.  

Запустите certlm. msc на серверах Windows и импортируйте *. PFX-файл в личное хранилище сертификатов компьютера. Это приведет к тому, что сервер передаст всю цепочку сертификатов в библиотеку ADAL.

>[!NOTE]
> Хранилище сертификатов подсистем балансировки сетевой нагрузки также должно быть обновлено для включения целой цепочки сертификатов, если она есть

### <a name="does-ad-fs-support-head-requests"></a>Поддерживает ли AD FS запросы HEAD?
AD FS не поддерживает запросы HEAD.  Приложения не должны использовать запросы HEAD к AD FS конечным точкам.  Это может привести к непредвиденным и/или отложенным ответам на ошибки HTTP.  Кроме того, в журнале событий AD FS могут отображаться непредвиденные события ошибок.

### <a name="why-am-i-not-seeing-a-refresh-token-when-i-am-logging-in-with-a-remote-idp"></a>Почему я не вижу маркер обновления при входе с помощью удаленного IdP?
Маркер обновления не выдается, если маркер, выданный IdP, имеет валидти менее 1 часа. Чтобы убедиться, что маркер обновления выдается, увеличьте срок действия маркера, выданного IdP, на более 1 часа.

### <a name="do-we-have-any-way-to-change-rp-token-encryption-algorithm"></a>Есть ли способ изменить алгоритм шифрования маркеров RP?
По умолчанию для шифрования маркеров RP задано значение AES256, и оно не может быть изменено на другое.

### <a name="on-a-mixed-mode-farm-i-get-error-when-trying-to-set-the-new-ssl-certificate-using-set-adfssslcertificate--thumbprint-how-can-i-update-the-ssl-certificate-in-a-mixed-mode-ad-fs-farm"></a>В ферме со смешанным режимом при попытке задать новый SSL-сертификат с помощью Set-AdfsSslCertificate-Thumbprint возникает ошибка. Как обновить SSL-сертификат в смешанном режиме AD FS ферме?
Фермы AD FS смешанного режима являются переходными состояниями. Перед обновлением SSL-сертификата рекомендуется либо переключиться на сертификат SSL, либо завершить процесс, а также повысить уровень поведения фермы. В случае, если это не было сделано, приведенные ниже инструкции предоставляют возможность обновления SSL-сертификата. 

На серверах WAP можно по-прежнему использовать Set-Вебаппликатионпроксисслцертификате. На серверах ADFS необходимо использовать Netsh. Выполните действия, указанные ниже.

1. Выберите подмножество серверов ADFS 2016 для обслуживания (например, удалить из балансировщика нагрузки).
2. На серверах, выбранных в #1, импортируйте новый сертификат с помощью MMC.
3. Удаление существующих сертификатов

    А. Netsh HTTP DELETE sslcert хостнамепорт = FS. contoso. com: 443 b. Netsh HTTP DELETE sslcert хостнамепорт = localhost: 443 c. Netsh HTTP DELETE sslcert хостнамепорт = FS. contoso. com: 49443

4.  Добавление нового сертификата

    А. netsh http add sslcert хостнамепорт = FS. contoso. com: 443 certhash = CERTTHUMBPRINT ид_приложения = {5d89a20c-BEAB-4389-9447-324788eb944a} цертсторенаме = MY сслктлсторенаме = Адфструстеддевицес

    Б. netsh http add sslcert хостнамепорт = localhost: 443 certhash = CERTTHUMBPRINT ид_приложения = {5d89a20c-BEAB-4389-9447-324788eb944a} цертсторенаме = MY сслктлсторенаме = Адфструстеддевицес

    в. netsh http add sslcert хостнамепорт = FS. contoso. com: 49443 certhash = CERTTHUMBPRINT ид_приложения = {5d89a20c-BEAB-4389-9447-324788eb944a} цертсторенаме = MY сслктлсторенаме = Адфструстеддевицес

5. Перезапуск службы ADFS на выбранном сервере
6. Удаление подмножества серверов WAP для обслуживания
7. На выбранных серверах WAP Импортируйте новый сертификат через MMC.
8. Настройка нового сертификата в WAP с помощью командлета

    А. Set-Вебаппликатионпроксисслцертификате-Thumbprint "CERTTHUMBPRINT"

9. Перезапуск службы на выбранных серверах WAP
10. Верните выбранные серверы WAP и AD FS в рабочую среду.

Выполните обновление на остальных серверах AD FS и WAP аналогичным образом.

### <a name="is-adfs-supported-when-web-application-proxy-wap-servers-are-behind-azure-web-application-firewallwaf"></a>Поддерживаются ли ADFS, когда серверы прокси веб-приложения (WAP) находятся за брандмауэром веб-приложения Azure (WAF)?
Службы ADFS и серверы веб-приложений поддерживают любой брандмауэр, который не выполняет завершение SSL на конечной точке. Кроме того, серверы ADFS и WAP имеют встроенные механизмы для предотвращения распространенных веб-атак, таких как межсайтовые сценарии, прокси-сервер ADFS и удовлетворяют всем требованиям, определенным [протоколом MS-адфспип](https://msdn.microsoft.com/library/dn392811.aspx).

### <a name="i-am-seeing-an-event-441-a-token-with-a-bad-token-binding-key-was-found-what-should-i-do-to-resolve-this"></a>Я вижу "событие 441: обнаружен маркер с неверным ключом привязки токена". Что мне делать для решения этой проблемы?
В AD FS 2016 привязка токенов включается автоматически и вызывает несколько известных проблем в сценариях прокси-сервера и Федерации, что приводит к этой ошибке. Чтобы устранить эту проблему, выполните следующую команду PowerShell и удалите поддержку привязки маркеров.

`Set-AdfsProperties -IgnoreTokenBinding $true`

### <a name="i-have-upgraded-my-farm-from-ad-fs-in-windows-server-2016-to-ad-fs-in-windows-server-2019-the-farm-behavior-level-for-the-ad-fs-farm-has-been-successfully-raised-to-2019-but-the-web-application-proxy-configuration-is-still-displayed-as-windows-server-2016"></a>Я обновил мою ферму с AD FS в Windows Server 2016 на AD FS в Windows Server 2019. Уровень поведения фермы для AD FS фермы успешно повышен до 2019, но конфигурация прокси-сервера веб приложения по-прежнему отображается как Windows Server 2016?
После обновления до Windows Server 2019 версия конфигурации прокси веб-приложения продолжит отображаться как Windows Server 2016. Прокси веб-приложения не имеет новых функций для версии Windows Server 2019, и если уровень поведения фермы был успешно создан на AD FS, прокси веб-приложения продолжит отображаться как Windows Server 2016 по разработке.

### <a name="can-i-estimate-the-size-of-the-adfsartifactstore-before-enabling-esl"></a>Можно ли оценить размер Адфсартифактсторе перед включением есл?
При включенном есл AD FS отслеживает действия учетной записи и известные расположения для пользователей в базе данных Адфсартифактсторе. Размер этой базы данных масштабируется относительно числа отслеживаемых пользователей и известных расположений. При планировании включения есл можно оценить размер базы данных Адфсартифактсторе, чтобы она увеличивалась с частотой до 1 ГБ на 100 000 пользователей. Если AD FS ферма использует внутреннюю базу данных Windows (WID), расположением по умолчанию для файлов базы данных является К:\виндовс\вид\дата. Чтобы предотвратить заполнение этого диска, перед включением есл убедитесь, что у вас есть как минимум 5 ГБ свободного хранилища. Помимо дискового пространства, следует запланировать общий объем памяти процесса для увеличения после включения есл до дополнительной 1 ГБ ОЗУ для заполнения пользователем 500 000 или менее.
