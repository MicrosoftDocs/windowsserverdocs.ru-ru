---
ms.assetid: acc9101b-841c-4540-8b3c-62a53869ef7a
title: Вопросы и ответы по AD FS 2016
description: Часто задаваемые вопросы для AD FS 2016
author: billmath
ms.author: billmath
manager: mtillman
ms.date: 04/17/2019
ms.topic: article
ms.custom: it-pro
ms.prod: windows-server-threshold
ms.technology: identity-adfs
ms.openlocfilehash: f3f84a5c18589d38606825ee064cfb729003a05d
ms.sourcegitcommit: a3958dba4c2318eaf2e89c7532e36c78b1a76644
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/05/2019
ms.locfileid: "66719683"
---
# <a name="ad-fs-frequently-asked-questions-faq"></a>Часто задаваемые вопросы (FAQ) AD FS


Следующая документация является домашней на часто задаваемые вопросы относительно служб федерации Active Directory.  Документ был разбит на группы, в зависимости от типа вопроса.

## <a name="deployment"></a>Развертывание

### <a name="how-can-i-upgrademigrate-from-previous-versions-of-ad-fs"></a>Как выполнить обновление или миграцию из предыдущих версий AD FS
Вы можете обновить AD FS, с помощью одного из следующих:


- Windows Server 2012 R2 AD FS для Windows Server 2016 AD FS
    - [Обновление до AD FS в Windows Server 2016 с помощью базы данных WID](../deployment/Upgrading-to-AD-FS-in-Windows-Server-2016.md)
    - [Обновление до AD FS в Windows Server 2016 с помощью базы данных SQL](../deployment/Upgrading-to-AD-FS-in-Windows-Server-2016-SQL.md)
- Windows Server 2012 AD FS в Windows Server 2012 R2 AD FS
    - [Миграция в AD FS на Windows Server 2012 R2](https://technet.microsoft.com/library/dn486815.aspx)
- AD FS 2.0 для Windows Server 2012 AD FS
    - [Миграция в AD FS на Windows Server 2012](https://technet.microsoft.com/library/jj647765.aspx)
- AD FS 1.x в AD FS 2.0
    - [Обновление с AD FS 1.x в AD FS 2.0](https://technet.microsoft.com/library/ff678035.aspx)

Если необходимо выполнить обновление от AD FS 2.0 или 2.1 (Windows Server 2008 R2 или Windows Server 2012), необходимо использовать готовую скрипты (находится в C:\Windows\ADFS).

### <a name="why-does-ad-fs-installation-require-a-reboot-of-the-server"></a>Почему установки AD FS требуется перезагрузка сервера?

В Windows Server 2016 добавлена поддержка HTTP/2, но HTTP/2 не может использоваться для проверки подлинности сертификата клиента.  Так как во многих сценариях AD FS делают использование проверки подлинности сертификата клиента и значительное количество клиентов поддерживает повторная попытка запросов с использованием HTTP/1.1, фермы при настройке AD FS повторно настраивается локальный сервер параметры HTTP для HTTP/1.1.  Это требуется перезагрузка сервера.  

### <a name="is-using-windows-2016-wap-servers-to-publish-the-ad-fs-farm-to-the-internet-without-upgrading-the-back-end-ad-fs-farm-supported"></a>Чтобы опубликовать ферму AD FS к Интернету без обновления серверной фермы AD FS поддерживается использует WAP-серверы Windows 2016?
Да, эта конфигурация поддерживается, но нет новых функций AD FS 2016 будет поддерживаться в этой конфигурации.  Эта конфигурация предназначена для временного во время миграции из AD FS 2012 R2 в AD FS 2016 и не следует развертывать для длительных периодов времени.

### <a name="is-it-possible-to-deploy-ad-fs-for-office-365-without-publishing-a-proxy-to-office-365"></a>Это позволяет развертывать AD FS для Office 365 без публикации учетную запись-посредник для Office 365?
Да, эта возможность поддерживается. Тем не менее в качестве побочного эффекта

1. Необходимо будет вручную управлять обновлением сертификаты для подписи токенов, так как Azure AD не смогут получить доступ к метаданным федерации. Дополнительные сведения о вручную обновить сертификат для подписи маркера. в статье [обновление сертификатов федерации для Office 365 и Azure Active Directory](https://docs.microsoft.com/azure/active-directory/connect/active-directory-aadconnect-o365-certs)
2. Вы не сможете использовать потоки устаревший способ проверки подлинности (например ExO прокси потоком проверки подлинности)

### <a name="what-are-load-balancing-requirements-for-ad-fs-and-wap-servers"></a>Каковы требования балансировки нагрузки для серверов AD FS и WAP

AD FS является системы без отслеживания состояния. Таким образом Балансировка нагрузки является достаточно простым для имен входа. Ниже приведены основные рекомендации для системы балансировки нагрузки.


- Не следует настраивать с помощью сопоставления IP-адрес подсистемы балансировки нагрузки. Это может подвергнуть Необоснованно нагрузки на подмножестве серверов в определенных сценариях Exchange Online.
- Подсистемы балансировки нагрузки не должны завершать соединения HTTPS и повторно запустите новое подключение к серверу служб федерации Active Directory.
- Подсистемы балансировки нагрузки следует убедиться, IP-адрес подключения, которые должны преобразовываться как исходный IP-адрес в HTTP-пакет, во время отправки для служб федерации Active Directory. В случае недоступности подсистемы балансировки нагрузки не удается отправить исходный IP-адрес в HTTP-пакет, подсистемы балансировки нагрузки необходимо добавить (или в конце в случае существующие) IP-адрес в заголовке x-forwarded-for. Это необходимо для правильную обработку определенных IP-адрес функции (заблокированные IP-адрес, смарт-блокировка экстрасети,...), связанные с и может привести к снижению уровня безопасности, если настроена неправильно.
- Подсистемы балансировки нагрузки должен поддерживать SNI. В случае это не так, убедитесь, что AD FS настроена для создания привязок HTTPS для обработки клиентов NAP без указания имени сервера.
- Подсистемы балансировки нагрузки следует использовать конечную точку проверки работоспособности AD FS HTTP для обнаружения, если серверы AD FS или WAP запущены и работают и исключить их, если ответ 200 ОК не возвращается.

### <a name="what-multi-forest-configurations-are-supported-by-ad-fs"></a>Какие конфигурации с несколькими лесами поддерживаются службами AD FS?

AD FS поддерживает несколько конфигурации с несколькими лесами и зависит от базовой сети доверия AD DS для проверки подлинности пользователей в нескольких сферах доверенным. Мы настоятельно рекомендуем отношения доверия лесов двунаправленного, так как это, чтобы упростить установку, чтобы убедиться, что подсистема доверия правильно работает без проблем. Кроме того,

- В случае доверие лесов, один из способов например лес DMZ, содержащий идентификаторов партнеров рекомендуется развертывание служб федерации Active Directory в лесу corp и обработке сети Периметра леса в качестве другого локального доверия с поставщиком утверждений, подключенные через LDAP. В этом случае Windows интегрированной проверки подлинности не будет работать для пользователей сети Периметра леса, и они будут необходимы для выполнения проверки подлинности пароля, как это единственный поддерживаемый механизм для протокола LDAP. В случае этот параметр не может продолжить, необходимо настроить другой служб федерации Active Directory в лесу сети Периметра и добавить их как отношением доверия поставщика утверждений в службах ADFS в лесу corp. Пользователям потребуется Home realm discovery, но Windows интегрированной проверки подлинности и проверки подлинности пароля будет работать. Можно внести соответствующие изменения в правила выдачи в службах ADFS в сети Периметра леса как служб федерации Active Directory в лесу Corp., не смогут получить пользователя дополнительных сведений о пользователе из сети Периметра леса.
- Отношения доверия на уровне домена, поддерживаются и могут работать, мы настоятельно рекомендуем перемещение в модель уровень доверия леса. Кроме того необходимо чтобы убедиться, что имя участника-пользователя маршрутизации и разрешение имен NETBIOS имен необходимо работать точно.



## <a name="design"></a>Оформление

### <a name="what-third-party-multi-factor-authentication-providers-are-available-for-ad-fs"></a>Какие сторонние поставщики многофакторной проверки подлинности доступны для AD FS?
Ниже приведен перечень сторонних поставщиков, которые нам известно.  Всегда может быть поставщиков, доступных в том случае, что мы не знают, и мы будем обновлять список, так как мы изучаем их.

- [Компания Gemalto идентификации и безопасности](http://www.gemalto.com/identity)
- [Корпоративной проверки подлинности inWebo](http://www.inwebo.com/)
- [Соединитель API пользователей многофакторной проверки Подлинности имени входа](https://www.loginpeople.com)
- [Агент проверки подлинности RSA SecurID для служб федерации Microsoft Active Directory](http://www.emc.com/security/rsa-securid/rsa-authentication-agents/microsoft-ad-fs.htm)
- [Агент (SAS) службы проверки подлинности SafeNet для AD FS](http://www.safenet-inc.com/resources/integration-guide/data-protection/Safenet_Authentication_Service/SafeNet_Authentication_Service__AD_FS_Agent_Configuration_Guide/?langtype=1033)
- [Служба проверки подлинности мобильных устройств компания Swisscom ID](http://swisscom.ch/mid)
- [Проверка Symantec и идентификатор защиты службы (VIP)](http://www.symantec.com/vip-authentication-service)

### <a name="are-third-party-proxies-supported-with-ad-fs"></a>Поддерживаются ли прокси-серверы сторонних с AD FS?
Да, сторонние учетные записи-посредники могут размещаться перед прокси веб-приложения, но любой третьей стороны прокси-сервер должен поддерживать [протокола MS-ADFSPIP](https://msdn.microsoft.com/library/dn392811.aspx) для использования вместо прокси веб-приложения.

### <a name="what-third-party-proxies-are-available-for-ad-fs-that-support-ms-adfspip"></a>Какие прокси-серверы сторонних доступны для AD FS, которая поддерживает MS-ADFSPIP?

Ниже приведен перечень сторонних поставщиков, которые нам известно.  Всегда может быть поставщиков, доступных в том случае, что мы не знают, и мы будем обновлять список, так как мы изучаем их.

- [F5 Access Policy Manager](https://support.f5.com/kb/en-us/products/big-ip_apm/manuals/product/apm-third-party-integration-13-1-0/12.html#guid-1ee8fbb3-1b33-4982-8bb3-05ae6868d9ee)

### <a name="where-is-the-capacity-planning-sizing-spreadsheet-for-ad-fs-2016"></a>Где является планирование мощности электронная таблица масштабов для AD FS 2016?
Версия AD FS 2016 электронной таблицы может быть загружена [здесь](http://adfsdocs.blob.core.windows.net/adfs/ADFSCapacity2016.xlsx).
Это также может использоваться для AD FS в Windows Server 2012 R2.

### <a name="how-can-i-ensure-my-ad-fs-and-wap-servers-support-apples-atp-requirements"></a>Как обеспечить AD FS и WAP серверов служба поддержки моей компании Apple требования к ATP

Apple выпустила ряд требований, вызывается приложение Transport Security (ATS), может повлиять на вызовы из приложения для iOS, проверку подлинности в AD FS.  Можно обеспечить в AD FS и WAP-серверы соответствуют, убедившись, что они поддерживают [требования для подключения с помощью ATS](https://developer.apple.com/library/prerelease/content/documentation/General/Reference/InfoPlistKeyReference/Articles/CocoaKeys.html#//apple_ref/doc/uid/TP40009251-SW57).  
В частности следует убедиться, что серверы AD FS и WAP поддержки TLS 1.2 и что шифров, согласованный с подключение TLS будут поддерживать безопасной пересылки.

Можно включить и отключить SSL 2.0 и 3.0 и TLS версий 1.0, 1.1 и 1.2 с помощью [управление протоколы SSL в AD FS](../operations/Manage-SSL-Protocols-in-AD-FS.md).

Чтобы обеспечить AD FS и WAP серверы согласования только шифров TLS, которые поддерживают ATP, можно отключить все комплекты шифров, не входящие в [список шифров, совместимые с ATP](https://developer.apple.com/library/prerelease/content/documentation/General/Reference/InfoPlistKeyReference/Articles/CocoaKeys.html#//apple_ref/doc/uid/TP40009251-SW57).  Чтобы сделать это, используйте [командлетов Windows TLS PowerShell](https://technet.microsoft.com/itpro/powershell/windows/tls/index).

## <a name="developer"></a>Разработчик

### <a name="when-generating-an-idtoken-with-adfs-for-a-user-authenticated-against-ad-how-is-the-sub-claim-generated-in-the-idtoken"></a>При создании маркера идентификации с помощью служб федерации Active Directory для пользователя, проверку подлинности относительно AD, как утверждения «sub» создается в id_token?
Значение утверждения «sub» — это хэш идентификатор клиента + значение утверждения привязки.

### <a name="what-is-the-lifetime-of-the-refresh-tokenaccess-token-when-the-user-logs-in-via-a-remote-claims-provider-trust-over-ws-fedsaml-p"></a>Что такое время существования маркера обновления маркера или доступ к нему при входе пользователя в через отношения доверия поставщика утверждений удаленного через WS-Fed/SAML-P
Время существования маркера обновления будет время существования токена, ADFS, получивший из отношения доверия с поставщиком удаленного утверждений. Время существования маркера доступа будет время существования маркера доверяющей стороны, для которого выдан маркер доступа.

### <a name="i-need-to-return-profile-and-email-scopes-as-well-in-addition-to-the-openid-scope-can-i-obtain-additional-information-using-scopes-how-to-do-it-in-ad-fs"></a>Мне нужно возвращать профиль и электронная почта областей также помимо область OpenId. Как получить дополнительные сведения о использовании области? Как это сделать в AD FS?
Настраиваемые маркера "id_token" позволяет добавлять соответствующие сведения в сам "id_token". Дополнительные сведения см. в статье [настроить утверждения в id_token](../development/Custom-Id-Tokens-in-AD-FS.md).

### <a name="how-to-issue-json-blobs-inside-jwt-tokens"></a>Как отправлять большие двоичные объекты json в токены JWT?
Специальные ValueType ("<http://www.w3.org/2001/XMLSchema#json>"), а также экранировать character(\x22) это была добавлена в AD FS 2016. Выполните приведенный ниже пример для правил выдачи, а также в итоге маркер доступа.

Пример правила выдачи:

    => issue(Type = "array_in_json", ValueType = "http://www.w3.org/2001/XMLSchema#json", Value = "{\x22Items\x22:[{\x22Name\x22:\x22Apple\x22,\x22Price\x22:12.3},{\x22Name\x22:\x22Grape\x22,\x22Price\x22:3.21}],\x22Date\x22:\x2221/11/2010\x22}");

Утверждения, выпущенные в маркере доступа:

    "array_in_json":{"Items":[{"Name":"Apple","Price":12.3},{"Name":"Grape","Price":3.21}],"Date":"21/11/2010"}

### <a name="can-i-pass-resource-value-as-part-of-the-scope-value-like-how-requests-are-done-against-azure-ad"></a>Можно передать значение ресурса в составе значение области, например как запросы выполняются в Azure AD?
С помощью AD FS на сервере 2019 теперь можно передавать значение ресурса, внедренные в параметр области. Параметр области теперь может быть организованы в виде списка разделенные пробелом, где каждая запись представляет структуру, что ресурс решения и содержания работ. Например  
**< создать допустимый пример запроса >**

### <a name="does-ad-fs-support-pkce-extension"></a>AD FS поддерживает PKCE расширения?
AD FS в 2019 г. сервер поддерживает ключ подтверждения для обмена кодом (PKCE) для потоке предоставления кода авторизации OAuth

### <a name="what-permitted-scopes-are-supported-by-ad-fs"></a>Какие разрешенные области поддерживаются службами AD FS?
- aza - при использовании [расширения протокола OAuth 2.0 для клиентов Broker](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-oapxbc/2f7d8875-0383-4058-956d-2fb216b44706) и, если параметр области содержит область «aza», сервер выдает новый маркер обновления основной и задает его в поле refresh_token ответа, а также параметр поле refresh_token_expires_in времени существования новый маркер основной обновления, если он применяется.
- openid - позволяет приложению запрашивать использование протокола OpenID Connect авторизации.
- logon_cert - область logon_cert позволяет приложению запрашивать сертификаты входа в систему, которые можно использовать для интерактивного прошедших проверку подлинности пользователей. Сервер AD FS параметр маркер доступа из ответа и вместо этого обеспечивает цепочку сертификатов CMS с кодировкой base64 или CMC полный ответ PKI. Дополнительные сведения о доступных [здесь](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-oapx/32ce8878-7d33-4c02-818b-6c9164cc731e). 
- user_impersonation - эту область необходима для успешного запроса маркера доступа on-behalf-of из AD FS. Дополнительные сведения об использовании этой области см [Создание многоуровневого приложения, с помощью On-Behalf-Of (OBO) с помощью OAuth с AD FS 2016](../../ad-fs/development/ad-fs-on-behalf-of-authentication-in-windows-server.md).
- vpn_cert - область vpn_cert позволяет приложению запрашивать сертификаты VPN, которые могут использоваться для установления VPN-подключения с использованием проверки подлинности EAP-TLS. Это больше не поддерживается.
- электронного письма — позволяет приложению запрашивать утверждения на электронную почту для пользователя, выполнившего. Это больше не поддерживается. 
- Профилирование — позволяет приложению запрашивать профиль связанные утверждения для входа в систему. Это больше не поддерживается. 


## <a name="operations"></a>Операции

### <a name="how-do-i-replace-the-ssl-certificate-for-ad-fs"></a>Как заменить сертификат SSL для служб AD FS?
AD FS SSL-сертификат не является таким же, как обнаруженный в оснастке управления AD FS communications сертификат службы AD FS.  Чтобы изменить сертификат AD FS SSL, необходимо использовать PowerShell. Следуйте указаниям в следующей статье:

[Управление SSL-сертификатами в AD FS и WAP 2016](../operations/Manage-SSL-Certificates-AD-FS-WAP-2016.md)

### <a name="how-can-i-enable-or-disable-tlsssl-settings-for-ad-fs"></a>Как включить или отключить параметры TLS/SSL для служб AD FS
Чтобы отключить или включить протоколы SSL и шифров, используйте следующую команду:

[Управление SSL-протоколов в AD FS](../operations/Manage-SSL-Protocols-in-AD-FS.md)

### <a name="does-the-proxy-ssl-certificate-have-to-be-the-same-as-the-ad-fs-ssl-certificate"></a>Имеет ли SSL-сертификат прокси-сервера должен совпадать с AD FS SSL-сертификат?  
Воспользуйтесь приведенными ниже указаниями по отношению к SSL-сертификат прокси-сервера и AD FS SSL-сертификат:


- Если прокси-сервер используется для запросов прокси-сервера AD FS, которые используют Windows встроенной проверки подлинности, SSL-сертификат прокси-сервера должен совпадать с (использовать тот же ключ) SSL-сертификата сервера федерации
- Если свойство AD FS — «ExtendedProtectionTokenCheck» включено (по умолчанию в AD FS), SSL-сертификат прокси-сервера должен совпадать с (использовать тот же ключ) SSL-сертификата сервера федерации
- В противном случае может иметь другой ключ из AD FS SSL-сертификат SSL-сертификат прокси-сервера, но должен соответствовать значению [требования](../overview/AD-FS-2016-Requirements.md)

### <a name="how-can-i-configure-promptlogin-behavior-for-ad-fs"></a>Настройка строки = имя входа поведение для AD FS?
Сведения о том, как настроить запрос = имя входа, см. в разделе [служб федерации Active Directory запрос = Поддержка параметров входа](../operations/AD-FS-Prompt-Login.md).

### <a name="how-can-i-change-the-ad-fs-service-account"></a>Как изменить учетную запись службы AD FS?
Чтобы изменить учетную запись службы AD FS, следуйте инструкциям, с помощью AD FS элементов [модуль Powershell для учетной записи службы](https://github.com/Microsoft/adfsToolbox/tree/master/serviceAccountModule).

### <a name="how-can-i-configure-browsers-to-use-windows-integrated-authentication-wia-with-ad-fs"></a>Как настроить браузеры для использования встроенной проверки подлинности Windows (WIA) с AD FS?

Сведения о настройке браузеров см. в разделе [настроить браузеры для использования встроенной проверки подлинности Windows (WIA) с AD FS](../operations/Configure-AD-FS-Browser-WIA.md).

### <a name="can-i-turn-off-browserssoenabled"></a>Можно ли отключить BrowserSsoEnabled?
Если у вас нет политики управления доступом на основе устройства на AD FS или Windows Hello для бизнеса сертификатов с помощью служб федерации Active Directory; Вы можете отключить BrowserSsoEnabled. BrowserSsoEnabled позволяет ADFS для сбора PRT (основного маркера обновления) от клиента, который содержит сведения об устройстве. Без этого устройства проверки подлинности служб федерации Active Directory не будет работать на устройствах Windows 10.

### <a name="how-long-are-ad-fs-tokens-valid"></a>Как долго допустимые токены AD FS?

Часто означает этот вопрос «сколько пользователей получу единого входа (SSO) без необходимости ввести новые учетные данные, и как администратор контролировать,?»  В этой статье описано это поведение и параметры конфигурации, определяющие, [параметры AD FS единый вход](https://technet.microsoft.com/windows-server-docs/identity/ad-fs/operations/ad-fs-2016-single-sign-on-settings).

Время существования по умолчанию различных файлов cookie и маркеры, перечислены ниже (а также параметры, которые управляют временем жизни).

**Зарегистрированные устройства**

- Файлы cookie PRT и единого входа: 90 дней, в соответствии с PSSOLifeTimeMins. (Предоставленного устройства используется по крайней мере каждые 14 дней, которая управляется DeviceUsageWindow)

- Токен обновления: вычисляется в выше, чтобы обеспечить согласованное поведение

- access_token: 1 час по умолчанию на основе проверяющей стороны

- "id_token": то же, что маркер доступа

**Отмена регистрации устройства**

- Файлы cookie SSO: по умолчанию, регулируется SSOLifetimeMins 8 часов.  Если сохранить выход Оставаться в системе включен, значение по умолчанию — 24 часа и можно настроить с помощью KMSILifetimeMins.


- Токен обновления: 8 часов по умолчанию. 24 часа с поддержкой Оставаться

- access_token: 1 час по умолчанию на основе проверяющей стороны

- "id_token": то же, что маркер доступа

### <a name="does-ad-fs-support-http-strict-transport-security-hsts"></a>AD FS поддерживает HTTP строгой безопасности транспорта (HSTS)?  

HTTP строгой безопасности транспорта (HSTS) — это механизм политики безопасности web, который помогает устранить атаки протоколов понижение уровня и перехвата куки-файл для служб, которые имеют конечные точки HTTP и HTTPS. Он позволяет веб-серверов объявить, что веб-браузеров (или других complying агенты пользователей) необходимо взаимодействовать только с ним по протоколу HTTPS и никогда не по протоколу HTTP.

Все конечные точки службы федерации Active Directory для проверки подлинности веб-трафика, открываются только по протоколу HTTPS.  Таким образом, AD FS эффективно снижает опасность угроз, которые предоставляет механизм политики безопасности транспорта HTTP (намеренно не существует не на более раннюю версию HTTP, так как отсутствуют прослушиватели в HTTP). Кроме того службы федерации Active Directory предотвращает отправку на другой сервер с конечными точками протокола HTTP, пометив все файлы cookie с флаг secure файлы cookie.

Таким образом реализации HSTS на сервере AD FS не является обязательным, так как он никогда не может быть изменена.  Для соответствия нормативным требованиям серверы AD FS удовлетворяет этим требованиям, поскольку они никогда не могут использовать HTTP, и все файлы cookie безопасного.

### <a name="x-ms-forwarded-client-ip-does-not-contain-the-ip-of-the-client-but-contains-ip-of-the-firewall-in-front-of-the-proxy-where-can-i-get-the-right-ip-of-the-client"></a>X-ms-forwarded--IP-адрес клиента не содержит IP-адрес клиента, но содержит IP-адрес брандмауэра перед прокси-сервер. Где можно получить правой IP-адрес клиента?
Рекомендуется не выполнять завершение запросов SSL перед WAP. В случае, если завершение SSL-запросов выполняется перед WAP, X-ms-forwarded--IP-адрес клиента будет содержать IP-адрес сетевого устройства перед WAP. Ниже приведено краткое описание различных IP-адреса, относящиеся к утверждения, которые поддерживаются службами AD FS.
 - x-ms-client-ip : Сетевой IP-адреса устройства, связанного с STS.  В случае запроса экстрасети всегда содержит IP-адреса WAP.
 - x-ms-forwarded-client-ip : Многозначного утверждения, который будет содержать все значения, пересылаемый для служб федерации Active Directory Exchange Online, а также IP-адрес устройства, связанного с WAP.
 - Userip: Для экстрасети запросов это утверждение будет содержать значение x-ms-forwarded--IP-адрес клиента.  Для запросов интрасети это утверждение будет содержать то же значение, что x-ms--IP-адрес клиента.

### <a name="i-am-trying-to-get-additional-claims-on-the-user-info-endpoint-but-its-only-returning-subject-how-can-i-get-additional-claims"></a>Я пытаюсь получение дополнительных утверждений на конечная точка сведений о пользователя, но только возврат темы. Получение дополнительных утверждений
Конечную точку userinfo служб федерации Active Directory всегда возвращает утверждение субъекта, как указано в стандартах OpenID. AD FS не предоставляет дополнительных утверждений, запрашиваемых через конечную точку UserInfo. Если вам нужна дополнительные утверждения в маркере, см. раздел [пользовательских маркеров безопасности в AD FS](../development/custom-id-tokens-in-ad-fs.md).

### <a name="why-do-i-see-a-lot-of-1021-errors-on-my-ad-fs-servers"></a>Почему большое число ошибок 1021 на своих серверах AD FS?
Это событие обычно регистрируется для недопустимый доступ к ресурсам в AD FS для ресурса 00000003-0000-0000-c000-000000000000. Эта ошибка вызвана ошибочное поведение клиента, в котором система пытается получить маркер доступа для службы Azure AD Graph. Так как ресурс отсутствует в AD FS, в результате события 1021 идентификатор на серверах AD FS. Это можно просто проигнорировать все предупреждения или ошибки для ресурсов 00000003-0000-0000-c000-000000000000 на AD FS.

### <a name="why-am-i-seeing-a-warning-for-failure-to-add-the-ad-fs-service-account-to-the-enterprise-key-admins-group"></a>Почему отображается предупреждение о сбой при добавлении учетной записи службы AD FS в группу "Администраторы предприятия ключ"?
Эта группа создается только в том случае, если существует контроллер домена Windows 2016 с ролью FSMO основного контроллера домена в домене. Чтобы устранить эту ошибку, можно создать группу вручную и следуйте ниже, чтобы предоставить необходимое разрешение после добавления учетной записи службы в качестве члена группы.
1.  Откройте оснастку **Пользователи и компьютеры Active Directory**.
2.  **Щелкните правой кнопкой мыши** доменного имени в области навигации и **щелкните** свойства.
3.  **Нажмите кнопку** безопасности (если вкладку «Безопасность» отсутствует, включите дополнительные функции из меню "Вид").
4.  **Нажмите кнопку** Advanced. **Нажмите кнопку** добавить. **Нажмите кнопку** выберите субъект.
5.  Появится диалоговое окно Выбор пользователя, компьютера, учетной записи службы или группы.  В поле введите имя объекта выберите текстовое поле введите ключ администратора группы.  Нажмите кнопку "ОК".
6.  В поле применяется к окну списка, выберите **дочерние объекты пользователя**.
7.  Используя полосу прокрутки, прокрутите до нижней части страницы и **щелкните** снимите флажки для всех.
8.  В **свойства** выберите **чтение msDS-KeyCredentialLink** и **записи msDS-KeyCredentialLink**.

### <a name="why-does-modern-authentication-from-android-devices-fail-if-the-server-does-not-send-all-the-intermediate-certificates-in-the-chain-with-the-ssl-cert"></a>Почему современную проверку подлинности от устройства Android завершается неудачно, если сервер не отправляет все промежуточные сертификаты в цепочке с SSL-сертификат?

Федеративные пользователи могут столкнуться проверки подлинности Azure AD для приложений, использующих библиотеки ADAL для Android отказавшего библиотеки. Приложение получит **AuthenticationException** при попытке отобразить страницу входа. В браузере chrome AD FS страницу входа в систему могут быть вызваны как небезопасные.

Android — для всех версий и всех устройств — не поддерживает загрузку дополнительных сертификатов из **authorityInformationAccess** поле сертификата. Это справедливо также браузера Chrome. Любой сертификат проверки подлинности сервера, в которой отсутствуют промежуточные сертификаты приведет эта ошибка, если вся цепочка сертификатов не передано из AD FS.

Правильное решение этой проблемы является настройка серверов для отправки необходимые промежуточные сертификаты вместе с SSL-сертификат AD FS и WAP.

При экспорте сертификата SSL, с одного компьютера, можно импортировать в личном хранилище, AD FS и WAP-серверы, на компьютере убедитесь, что экспорт закрытого ключа и выберите **файл обмена личной информацией - PKCS #12**.

Очень важно, что флажок, чтобы **включить по возможности все сертификаты в путь сертификата** установлен, а также **экспортировать все расширенные свойства**.  

Запустите certlm.msc на серверах Windows и импортировать *. PFX-ФАЙЛ в хранилище личных сертификатов на компьютере. В результате сервере, чтобы передать всю цепочку сертификатов с библиотекой ADAL.

>[!NOTE]
> Сертификат хранилища из сети подсистемы балансировки нагрузки следует обновить также включать всю цепочку сертификатов при его наличии

### <a name="does-ad-fs-support-head-requests"></a>AD FS поддерживает запросы HEAD?
Службы федерации Active Directory не поддерживает запросы HEAD.  Приложения должны использовать запросы HEAD для конечных точек AD FS.  Это может вызвать сообщения об ошибках HTTP, Непредвиденная и/или отложенной.  Кроме того вы можете увидеть события произошла непредвиденная ошибка в журнале событий AD FS.

### <a name="why-am-i-not-seeing-a-refresh-token-when-i-am-logging-in-with-a-remote-idp"></a>Почему я не вижу маркер обновления при я вход под удаленного IdP?
Маркер обновления не выдается, если маркер, выданный поставщиком удостоверений имеет validty менее чем за час. Чтобы убедиться, что выданный маркер обновления, увеличьте допустимость маркера, выданного службой поставщика удостоверений для более чем за час.

### <a name="do-we-have-any-way-to-change-rp-token-encryption-algorithm"></a>У нас любым способом, чтобы изменить алгоритм шифрования маркеров RP?
По умолчанию шифрование маркеров RP присвоено AES256 и его невозможно изменить на любое другое значение.

### <a name="on-a-mixed-mode-farm-i-get-error-when-trying-to-set-the-new-ssl-certificate-using-set-adfssslcertificate--thumbprint-how-can-i-update-the-ssl-certificate-in-a-mixed-mode-ad-fs-farm"></a>На ферме смешанного режима, появляется сообщение об ошибке при попытке задать новый SSL-сертификат, с помощью Set-AdfsSslCertificate-Thumbprint. Как обновить сертификат SSL в смешанном режиме фермы AD FS?
На WAP-серверы по-прежнему можно использовать набор WebApplicationProxySslCertificate. На серверах служб федерации Active Directory необходимо использовать netsh. Выполните указанные ниже действия.

1. Выбрать подмножество серверов ADFS 2016 для обслуживания (например, удалите из балансировщика нагрузки)
2. На серверах, выбранной на #1 импортируйте новые сертификаты с помощью консоли MMC
3. Удаление существующих сертификатов

    1. netsh http delete sslcert hostnameport=fs.contoso.com:443 b. Netsh http delete sslcert hostnameport = localhost:443 c. netsh http delete sslcert hostnameport=fs.contoso.com:49443

4.  Добавить новый сертификат

    1. Netsh http добавить sslcert hostnameport=fs.contoso.com:443 certhash = CERTTHUMBPRINT appid = {5d89a20c-beab-4389-9447-324788eb944a} certstorename = MY sslctlstorename = AdfsTrustedDevices

    2. Netsh http добавить sslcert hostnameport = localhost:443 certhash = CERTTHUMBPRINT appid = {5d89a20c-beab-4389-9447-324788eb944a} certstorename = MY sslctlstorename = AdfsTrustedDevices

    В. Netsh http добавить sslcert hostnameport=fs.contoso.com:49443 certhash = CERTTHUMBPRINT appid = {5d89a20c-beab-4389-9447-324788eb944a} certstorename = MY sslctlstorename = AdfsTrustedDevices

5. Перезапустить службу ADFS на выбранном сервере
6. Удаление подмножества WAP-серверы для обслуживания
7. На выбранных серверах WAP импортируйте новые сертификаты с помощью консоли MMC
8. Установить новый сертификат на WAP, с помощью командлета

    1. SET-WebApplicationProxySslCertificate-отпечаток «CERTTHUMBPRINT»

9. Перезапустите службу на выбранные серверы WAP
10. Помещает выбранные серверы WAP и AD FS в рабочей среде.

Выполните обновление на остальной части AD FS и WAP-серверах аналогично.

### <a name="is-adfs-supported-when-web-application-proxy-wap-servers-are-behind-azure-web-application-firewallwaf"></a>Поддерживается ли служб федерации Active Directory, если прокси-сервера приложений Web (WAP) серверы находятся в пределах Azure Web Application Firewall(WAF)?
ADFS и серверов веб-приложение поддерживает любой брандмауэр не выполняет завершение SSL-запросов в конечной точке. Кроме того, серверы ADFS и WAP имеют встроенные механизмы для предотвращения распространенных сетевых атак, таких как межузловых сценариев, прокси-сервер ADFS и удовлетворять всем требованиям, определенным в [протокола MS-ADFSPIP](https://msdn.microsoft.com/library/dn392811.aspx).

### <a name="i-am-seeing-an-event-441-a-token-with-a-bad-token-binding-key-was-found-what-should-i-do-to-resolve-this"></a>Я вижу «441 событий: Токен с ключом неправильный токен привязки найден.» Что следует сделать для решения этой проблемы?
В AD FS 2016 привязки токена включается автоматически и вызывает несколько известных проблем со сценариями прокси-сервера и федерации результаты в эту ошибку. Чтобы устранить эту проблему, выполните следующую команду Powershell и удаление поддержки привязки токена.

`Set-AdfsProperties -IgnoreTokenBinding $true`
