---
ms.assetid: 8a64545b-16bd-4c13-a664-cdf4c6ff6ea0
title: "Сценарии AD FS для разработчиков"
description: 
author: billmath
ms.author: billmath
manager: femila
ms.date: 05/31/2017
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: identity-adfs
ms.openlocfilehash: 753b2b235cb1d73ab47588f8f229410c1f81db40
ms.sourcegitcommit: db290fa07e9d50686667bfba3969e20377548504
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/12/2017
---
# <a name="ad-fs-scenarios-for-developers"></a>Сценарии AD FS для разработчиков

>Область применения: Windows Server 2016

AD FS в Windows Server 2016 [AD FS 2016] позволяет добавить отрасли стандартного подключения OpenID и OAuth 2.0 на основе проверки подлинности и авторизации для приложений, которые вы разрабатываете и установлены эти приложения проверки подлинности пользователей, непосредственно от службы федерации Active Directory.    
  
AD FS 2016 также поддерживает WS-Trust, WS-Federation и SAML протоколы и профили мы с поддержкой в предыдущих версиях.  Если вы заинтересованы в руководстве разработчика для этих протоколов, см. в статье здесь.  В этой статье расскажем о том, как использовать и использовать преимущества новых поддержку протокола.  
  
## <a name="why-modern-authentication"></a>Почему современных проверки подлинности  
Вы можете продолжать использовать AD FS для входа в с помощью WS-Federation, SAML протоколы так же, как и WS-Trust у есть прежде, чем с помощью новые протоколы можно получить следующие преимущества:  
  
* **Простота и согласованности**  
    * Используйте тот же набор API и шаблонов для разрешения входа для:   
        *   несколько типов приложений (сервер, рабочий стол, мобильных устройств, браузер)  
        *   несколько платформ (android, iOS, Windows)  
        *   приложения внутри корпоративной сети или в облаке  
    * Используйте тот же набор библиотеки, которые уже можно использовать для проверки подлинности пользователей в соответствии с Azure AD  
* **Гибкость**  
    * Помимо авторизации обычного пользователя поддержки более сложных сценариев, таких как:      
        * ? стол 3 входа потоках, в которых авторизует пользователя веб-приложения или службы для доступа к ресурсам, которые находятся с другой веб-приложения или службы.    
        * ? Потоки сервера на сервер, в которых служба средний уровень обращается к серверной части API  
        * ? JavaScript приложениям одностраничной (SPA)  
* **Отраслевая поддержка**  
    * OAuth 2.0 подключения OpenID нравится и широкого использования во всех направлениях, поэтому знаний этих шаблонов можно включить проверку подлинности и авторизацию вне среде Active Directory  
  
## <a name="how-it-works-the-basics"></a>Как это работает: основы  
Современные проверки подлинности AD FS можно добавить в приложение с помощью тот же набор инструментов и библиотеки, которые уже можно использовать для проверки подлинности пользователей в соответствии с Azure AD.   
  
В сценарии AD FS Конечно, это AD FS и не Azure AD, который служит в качестве поставщика удостоверений и авторизации сервера.  В противном случае концепции одинаково: предоставить свои учетные данные пользователей и получить токены, напрямую или с помощью посредника, для доступа к ресурсам.  
  
Наиболее базовый сценарий состоит из пользователя или «владельцем ресурса», взаимодействие с браузером для доступа к веб-приложения:  
  
![AD FS для разработчиков](media/ADFS_DEV_1.png)  
  
Веб-приложения, называется «Клиент», поскольку он инициирует запрос авторизации сервера (AD FS) для маркера доступа к ресурсу.  Ресурс может размещаться веб-приложении, сам или могут быть доступны в Интернете API где-либо в сети или в Интернете.   Пользователь или «владелец ресурса» авторизация клиентских веб-приложение для получения маркера, указав учетные данные на сервер авторизации.    
  
## <a name="how-it-works-components"></a>Как это работает: компонентов  
OAuth 2.0 подключения OpenID сценариев и в AD FS внесите использовать тот же набор средств и библиотек, которые можно использовать в случае поставщика удостоверений Azure AD.  Эти компоненты являются:  
* Библиотека Active Directory проверки подлинности (ADAL): клиентские библиотеки, облегчают сбор учетных данных пользователя, создание и отправка запросов токена и получение полученный маркеры.    
* (Откройте веб-интерфейс .NET) OWIN по промежуточного слоя: во время OWIN — это проект на основе сообщества, корпорация Майкрософт создала набор сервера стороне библиотеки для защиты веб-приложений и веб-API-интерфейсов с подключения OpenID и OAuth 2.0  
  
На следующем рисунке показаны роли из этих компонентов:  
  
![AD FS для разработчиков](media/ADFS_DEV_2.png)  
  
## <a name="modeling-these-scenarios-in-ad-fs-2016"></a>Моделирование этих сценариев в AD FS 2016  
  
### <a name="application-groups"></a>Группы приложений  
Для представления этих сценариев в политике AD FS, мы представили новые концепция, называемая группами приложений.  Группа приложения может содержать любое количество и сочетание следующих основных типов приложений:  
  
  
  
Группа приложений и типов приложений  |Описание  |Роли    
---------|---------|---------  
Собственное приложение     |  Иногда называют открытый клиента, этот способ предназначен для клиентского приложения, которое выполняется на компьютере или устройстве, и с которыми пользователь взаимодействует.       | Запросы маркеров с авторизации сервера (AD FS) для доступа пользователей к ресурсам.  Отправляет HTTP-запросы к защищенным ресурсам, используя маркеры как HTTP-заголовки.        
Сервер приложений     |   Веб-приложение, которое работает на сервере и доступен пользователям через браузер.  Потому что он поддерживает поддержания свой собственный секрет клиента или учетных данных, он иногда называется конфиденциальных клиентов.      | Запросы маркеров с авторизации сервера (AD FS) для доступа пользователей к ресурсам.  Отправляет HTTP-запросы к защищенным ресурсам, используя маркеры как HTTP-заголовки.               
Веб-API     |  Ресурс конечный пользователь получает доступ к. Рассматривайте их в новое представление «проверяющих сторон».| Применяет маркеры, полученные с клиентов  
  
### <a name="differences-from-ad-fs-2012-r2"></a>Отличия от AD FS 2012 R2  
Группы приложений объединить элементы доверия и авторизации, AD FS 2012 R2 отдельно, представлены в виде проверяющих сторон, клиентов и разрешения для приложений.  
  
Следующие таблицы сравнивает методы, с помощью которых соответствующие объекты доверия приложения создаются в AD FS 2012 R2 vs AD FS 2016:  
  
AD FS в Windows Server 2012 R2|В PowerShell|Управление AD FS  
---------|---------|---------  
Добавление собственного клиента|Добавить AdfsClient|NA  
Добавьте серверное приложение в качестве клиента|Добавить AdfsClient|NA  
Добавить веб-API и ресурсов|-AdfsRelyingPartyTrust|Создание отношений доверия с проверяющей стороной  
  
AD FS 2016|В PowerShell|Управление AD FS  
---------|---------|---------  
Добавление собственного клиента|Добавить AdfsNativeClientApplication|Добавьте группу собственного приложения  
Добавьте серверное приложение в качестве клиента|Добавить AdfsServerApplication|Добавление приложения группы серверов  
Добавить веб-API и ресурсов|Добавить AdfsWebApiApplication|Добавление группы приложения API веб-приложений  
  
### <a name="application-permissions-and-consent"></a>Разрешения для приложений и согласия  
По умолчанию клиентам в группу приложений будет разрешено получать доступ к ресурсам в той же группе.  Администратор не требуется настраивать разрешения для конкретного приложения.  Группами приложений также администраторы могут указать, разрешено, такие как openid или user_impersonation области.  В описаниях сценария укажите ровно области, которые необходимы для какой сценарий.  
  
Так как службы федерации Active Directory использует модель согласия администратора, пользователи не получают запрос на согласие при доступе к ресурсам.  Настроив группу приложений, администратор в силу дает согласие от имени всех пользователей приложения.  
  
## <a name="supported-scenarios"></a>Поддерживаемые сценарии  
Приведенные в следующем разделе описаны сценарии, которые мы поддерживаем более подробно.  
  
### <a name="tokens-used"></a>Маркеры, используемые  
Убедитесь в этих сценариях использовать три типа маркера:  
  
* **id_token:** JWT маркер, используемый для представления удостоверения пользователя. «Aud» или аудитории утверждение id_token совпадает с Идентификатором клиента собственный или сервера приложений.  
* **access_token:** JWT маркер, используемый в Oauth и OpenID подключения сценариев и предназначен для потребления ресурсов.  Утверждение «aud» или аудитории токена должен совпадать с идентификатором ресурса или веб-API.  
* **refresh_token:** этот маркер отправляется вместо сбор учетных данных пользователя для обеспечения единого входа на взаимодействие.  Этот маркер и выдается и потребляемых AD FS и недоступен для клиентов или ресурсов.    
  
### <a name="native-client-to-web-api"></a>Собственный клиент к веб-API  
Этот сценарий позволяет пользователю приложения собственный клиент для вызова API AD FS 2016 защищенных веб.  
* Приложение собственный клиент использует ADAL для отправки авторизации и маркер запросы к AD FS, запроса учетных данных пользователя, при необходимости, а затем отправляет маркер, полученный в HTTP-заголовке запроса на веб-API  
* [Эта часть предназначена только для наглядности] Веб-API считывает утверждения из ClaimsPrincipal объекта, вызванное маркер доступа, отправленных клиентом и отправляет их обратно клиенту.  
  
![Описание протокола потока](media/ADFS_DEV_3.png)  
  
1.  Собственный клиент приложение инициирует потока с помощью вызова ADAL библиотеки.  Это инициирует на основе браузера HTTP GET для AD FS авторизовать конечной точке:  
  
**Запрос авторизации:**  
GET https://fs.contoso.com/adfs/oauth2/authorize?  
  
Параметр|Значение  
---------|---------  
response_type|«код»  
ресурс|RP ID (идентификатор) API веб-приложения группы  
client_id|Клиент идентификатор собственного приложения в группу приложений  
redirect_uri|Перенаправление URI собственного приложения в группе приложений  
  
**Запрос авторизации ответ:**  
Если пользователь не входил в систему перед, пользователю предлагается ввести учетные данные.    
AD FS отвечает, возвращая код авторизации как параметр «код» в компоненте запроса redirect_uri.  Например: найти расположение HTTP/1.1 302: **http://redirect_uri:80 /? код =&lt;кода&gt;.**  
  
2.  Собственный клиент затем отправляет код, вместе с указанными ниже параметрами endpoint токена AD FS:  
  
**Запрос маркера:**  
POST https://fs.contoso.com/adfs/oauth2/token  
  
Параметр|Значение  
---------|---------  
grant_type|«authorization_code» 
код|кода авторизации из 1  
ресурс|RP ID (идентификатор) API веб-приложения группы  
client_id|Клиент идентификатор собственного приложения в группу приложений  
redirect_uri|Перенаправление URI собственного приложения в группе приложений  
  
**Ответ на запрос маркера:**  
AD FS отвечает 200 HTTP с access_token, refresh_token и id_token в тексте.  
  
3.  Затем собственного приложения отправляет access_token часть выше ответа в заголовке авторизации в HTTP-запрос веб-API.  
  
### <a name="single-sign-on-behavior"></a>Поведение единого входа  
Последующие клиент запрашивает в 1 час (по умолчанию) access_token останутся действительными в кэше, а новый запрос не будет активировать любой трафик на AD FS.  Access_token автоматически извлекается из кэша, ADAL.  
  
После истечения срока действия маркера доступа, ADAL будет автоматически отправлять запрос обновления маркера на основе токена конечной точки службы федерации Active Directory (автоматически, пропуская запрос авторизации).  
**Обновите запрос маркера.**  
POST https://fs.contoso.com/adfs/oauth2/token
   

Параметр|Значение|
---------|---------
grant_type|«refresh_token»|
ресурс|RP ID (идентификатор) API веб-приложения группы|
client_id|Клиент идентификатор собственного приложения в группу приложений
refresh_token|токен обновления, выданный AD FS в ответ на запрос маркера начальной

  
  
**Ответ на запрос маркера для обновления:**  
Если токен обновления, в течение < SSO_period > запрос приведет к новый маркер доступа. Пользователю не предлагается ввести учетные данные.  Дополнительные сведения о см. параметры единого входа [параметры AD FS единого входа на](../../ad-fs/operations/AD-FS-2016-Single-Sign-On-Settings.md)  
  
Если токен обновления истек, запрос приведет ошибку HTTP 401, ошибка «invalid_grant» и «error_description» «MSIS9615: истек срок действия токена обновления, полученные в параметре refresh_token». В этом случае ADAL автоматически отправляет новый запрос авторизации, которое выглядит так же, как #1 выше.    
  
### <a name="web-browser-to-web-app"></a>Веб-браузер на веб-приложения   
В этом сценарии пользователя с помощью обозревателя необходим доступ к ресурсам, расположенным веб-приложением.    
Существует два сценария, которые это сделать.  
  
#### <a name="oauth-confidential-client"></a>Конфиденциальных клиентов OAuth  
Этот сценарий аналогичен выше в наличии запрос авторизации с кодом для обмена маркера.  Инициирует запрос авторизации через браузер с помощью веб-приложение (моделировать как серверное приложение в AD FS) и обменивается кода для маркера (путем непосредственного подключения к AD FS)  
  
![Описание протокола потока](media/ADFS_DEV_4.png)  
  
1.  Инициирует веб-приложения, авторизации запросов через браузер, который отправляет HTTP GET для Служб федерации Active Directory с помощью авторизовать конечной точки  
**Запрос авторизации**:  
GET https://fs.contoso.com/adfs/oauth2/authorize?  
  
Параметр|Значение  
---------|---------  
response_type|«код»  
ресурс|RP ID (идентификатор) API веб-приложения группы  
client_id|Идентификатор клиента для основного приложения группы приложений  
redirect_uri|Перенаправление URI веб-приложение (серверное приложение) в группе приложений  
  
Запрос авторизации ответ:  
Если пользователь не входил в систему перед, пользователю предлагается ввести учетные данные.  
AD FS отвечает, возвращая код авторизации как параметр «код» в компоненте запроса redirect_uri, например: расположение найден HTTP/1.1 302: https://webapp.contoso.com/?code=&lt;кода&gt;.  
  
2.  В результате выше 302 браузера инициирует HTTP GET для веб-приложения, например: GET http://redirect_uri:80 /? код =&lt;кода&gt;.   
  
3.  На этом этапе веб-приложения, получен код, инициирует запрос на AD FS маркера конечной точки, отправка ниже  
**Запрос маркера:**  
POST https://fs.contoso.com/adfs/oauth2/token  
  
Параметр|Значение  
---------|---------  
grant_type|«authorization_code»  
код|кода авторизации из 2 выше  
ресурс|RP ID (идентификатор) API веб-приложения группы  
client_id|Идентификатор клиента для веб-приложения (серверное приложение) в группу приложений  
redirect_uri|Перенаправление URI веб-приложение (серверное приложение) в группе приложений  
client_secret|Секрет веб-приложение (серверное приложение) в группу приложений. **Примечание: Учетных данных клиента не должно быть client_secret.  Службы федерации Active Directory поддерживает также используют сертификаты или встроенную проверку подлинности Windows.**  
  
**Ответ на запрос маркера:**  
AD FS отвечает 200 HTTP с access_token, refresh_token и id_token в тексте.  
утверждения  
4.  Веб-приложений, а затем либо потребляет access_token часть выше ответа (в случае, в котором веб-приложении, сам размещен ресурс) и в противном случае отправляет его в заголовке авторизации в HTTP-запрос в веб-API.  
  
#### <a name="single-sign-on-behavior"></a>Поведение единого входа  
Если маркер доступа будет по-прежнему быть действительным для 1 часа (по умолчанию) в кэше клиента, вы считаете, что второй запрос будет работать как в сценарии собственный клиент выше - новый запрос не будет активировать любой трафик на AD FS как маркер доступа автоматически извлекается из кэша, ADAL.  Однако это возможно, что веб-приложение может отправляет отдельные авторизации и запросы маркеров, бывший через отдельные URL-адреса объединять, как в нашем примере.  
  
В этом случае это файла cookie единого входа AD FS браузера, который позволяет AD FS для выдачи нового кода авторизации без запроса учетных данных пользователя. Веб-приложение вызывает для Служб федерации Active Directory для обмена нового кода авторизации для новый маркер доступа.  Пользователю не предлагается ввести учетные данные.  
  
В противном случае если веб-приложение — смарт-достаточно, чтобы знать, если пользователь уже прошел проверку подлинности, можно пропустить авторизовать запрос и либо:  
* маркер кэшированные доступа, если срок действия не истек, получить и использовать, или   
* запрос маркера на основе запроса могут отправляться в AD FS маркера конечных точках, как описано ниже  
  
**Обновите запрос маркера.**  
POST https://fs.contoso.com/adfs/oauth2/token
   
Параметр|Значение  
---------|---------  
grant_type|«refresh_token»  
ресурс|RP ID (идентификатор) API веб-приложения группы  
client_id|Идентификатор клиента для веб-приложения (серверное приложение) в группу приложений  
refresh_token|Выдан AD FS в ответ на запрос маркера начальной токен обновления  
client_secret|Секрет использования веб-приложения (серверное приложение) в группу приложений  
  
**Ответ на запрос маркера для обновления:**  
Если токен обновления, в течение < SSO_period > запрос приведет к новый маркер доступа. Пользователю не предлагается ввести учетные данные. Дополнительные сведения о см. параметры единого входа [параметры AD FS единого входа на](../../ad-fs/operations/AD-FS-2016-Single-Sign-On-Settings.md)   
  
Если токен обновления истек, запрос приведет ошибку HTTP 401, ошибка «invalid_grant» и «error_description» «MSIS9615: истек срок действия токена обновления, полученные в параметре refresh_token». В этом случае ADAL автоматически отправляет новый запрос авторизации, которое выглядит так же, как #1 выше.    
  
#### <a name="openid-connect-hybrid-flow"></a>OpenID подключение: Поток гибридного  
Этот сценарий похож на приведенном выше, в том, что существует запрос авторизации инициируется веб-приложения через перенаправления браузера, а также код для обмена маркера из веб-приложения Служб федерации Active Directory.  В этом случае отличается, что службы федерации Active Directory выдает id_token как часть запроса ответа начальной авторизации.  
  
![Описание протокола потока](media/ADFS_DEV_5.png)  
  
1.  Инициирует веб-приложения, авторизации запросов через браузер, который отправляет HTTP GET для Служб федерации Active Directory с помощью авторизовать конечной точки  
  
**Запрос авторизации:**  
GET https://fs.contoso.com/adfs/oauth2/authorize?  
  
Параметр|Значение  
---------|---------  
response_type|«Код + id_token»  
response_mode|«form_post»  
ресурс|RP ID (идентификатор) API веб-приложения группы  
client_id|Идентификатор клиента для веб-приложения (серверное приложение) в группу приложений  
redirect_uri|Перенаправление URI веб-приложение (серверное приложение) в группу приложений  
  
**Запрос авторизации ответ:**  
Если пользователь не входил в систему перед, пользователю предлагается ввести учетные данные.  
AD FS в ответ HTTP 200 и формой, содержащей ниже как скрытые элементы:  
* код: кода авторизации  
* id_token: JWT токен, содержащий заявки, описывающие пользователя, проверку подлинности  
2.  Формы автоматически учитывает redirect_uri использования веб-приложения, отправку код и id_token веб-приложения.  
  
3.  На этом этапе веб-приложения, получен код, инициирует запрос на AD FS маркера конечной точки, отправка ниже  
  
**Запрос маркера:**  
POST https://fs.contoso.com/adfs/oauth2/token
  
  
  
Параметр|Значение  
---------|---------  
grant_type|«authorization_code»  
код|кода авторизации из выше  
ресурс|RP ID (идентификатор) API веб-приложения группы  
client_id|Идентификатор клиента для веб-приложения (серверное приложение) в группу приложений  
redirect_uri|Перенаправление URI веб-приложение (серверное приложение) в группе приложений  
client_secret|Секрет использования веб-приложения (серверное приложение) в группу приложений  
  
**Ответ на запрос маркера:**  
AD FS отвечает 200 HTTP с access_token, refresh_token и id_token в тексте.  
  
4.  Веб-приложений, а затем либо потребляет access_token часть выше ответа (в случае, в котором веб-приложении, сам размещен ресурс) и в противном случае отправляет его в заголовке авторизации в HTTP-запрос в веб-API.  
  
#### <a name="single-sign-on-behavior"></a>Поведение единого входа  
Единый вход поведение аналогичен случаю выше поток конфиденциальных клиентов Oauth 2.0.  
  
### <a name="on-behalf-of"></a>От имени владельца  
В этом сценарии веб-приложение использует исходный маркер доступа пользователя для запроса и получить новый маркер доступа для другой веб-API, который будет получить доступ к веб-приложение от имени конечного пользователя.  Это называется поток «от имени владельца».  
  
![Описание протокола потока](media/ADFS_DEV_6.png)  
  
Шаги 1 и 2 работать так же, как шаги 3 и 4, в предыдущей процедуре.  
На шаге 3 ключа требование заключается в том, что параметр client_id, идентификатор клиента для веб-приложения 2, должен совпадать RP идентификатор из веб-API A. Другими словами аудитории маркер доступа, обмениваемые новый маркер должен соответствовать Идентификатору клиента субъекта, запрашивающего новый маркер.  

## <a name="related-content"></a>Связанное содержимое  
В разделе [разработка AD FS](../AD-FS-Development.md) полный список статей руководство по, который содержат поэтапные инструкции с помощью связанных потоков. 
