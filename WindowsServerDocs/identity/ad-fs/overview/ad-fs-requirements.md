---
ms.assetid: 28f4a518-1341-4a10-8a4e-5f84625b314b
title: Требования к AD FS 2016
description: Требования к установке служб федерации Active Directory.
author: billmath
ms.author: billmath
manager: mtillman
ms.date: 03/06/2018
ms.topic: article
ms.prod: windows-server
ms.technology: identity-adfs
ms.openlocfilehash: c8ab160699bc6a961f4fbed6c58cf072a395a313
ms.sourcegitcommit: 6aff3d88ff22ea141a6ea6572a5ad8dd6321f199
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/27/2019
ms.locfileid: "71407429"
---
# <a name="ad-fs-requirements"></a>Требования AD FS



Ниже описаны требования к развертыванию AD FS.  
  
-   [Требования к сертификатам](ad-fs-requirements.md#BKMK_1)  
  
-   [Требования к оборудованию](ad-fs-requirements.md#BKMK_2)  
  
-   [Требования к прокси-серверу](ad-fs-requirements.md#BKMK_3)  
  
-   [Требования к AD DS](ad-fs-requirements.md#BKMK_4)  
  
-   [Требования к базе данных конфигурации](ad-fs-requirements.md#BKMK_5)  
  
-   [Требования к браузерам](ad-fs-requirements.md#BKMK_6)  

-   [Сетевые требования](ad-fs-requirements.md#BKMK_7)  
  
-   [Требования к разрешениям](ad-fs-requirements.md#BKMK_13)  
  
## <a name="BKMK_1"></a>Требования к сертификатам  
  
### <a name="ssl-certificates"></a>SSL-сертификаты

Для каждого сервера AD FS и прокси-службы веб-приложений предоставляется сертификат SSL для обслуживания HTTPS-запросов к службе федерации.  Прокси-служба веб-приложений может иметь дополнительные сертификаты SSL для обслуживания запросов к опубликованным приложениям.

**Рекомендация.** Используйте один и тот же SSL-сертификат для всех серверов федерации AD FS и прокси-служб веб-приложений. 

**Требования.**

SSL-сертификаты на серверах федерации должны отвечать следующим требованиям:
- сертификат должен быть открытым доверенным сертификатом (для рабочих развертываний);
- сертификат должен содержать значение EKU (расширенное использование ключа) "Server Authentication" (Проверка подлинности сервера);
- сертификат должен содержать имя службы федерации, например fs.contoso.com, в качестве имени субъекта или альтернативного имени субъекта (SAN);
- для проверки подлинности сертификата на порту 443 сертификат должен содержать в качестве альтернативного имени субъекта значение certauth.\<имя службы федерации\>, например certauth.fs.contoso.com;
- для регистрации устройств или для современной проверки подлинности в локальных ресурсах с клиентами более старых версий, чем Windows 10, в качестве альтернативного имени субъекта должно быть указано значение enterpriseregistration.\<суффикс имени участника-пользователя\> для каждого используемого в организации суффикса имени участника-пользователя.

SSL-сертификаты в прокси-службе веб-приложений должны отвечать следующим требованиям:
- Если прокси-служба используется для передачи в AD FS запросов, использующих встроенную проверку подлинности Windows, прокси-сертификат SSL должен быть таким же (и с тем же ключом), что и SSL-сертификат сервера федерации.
- Если в AD FS включено свойство ExtendedProtectionTokenCheck (это значение по умолчанию), прокси-сертификат SSL должен быть таким же (и с тем же ключом), что и SSL-сертификат сервера федерации.
- В противном случае для SSL-сертификата прокси-службы действуют те же требования, что и для SSL-сертификата сервера федерации.

### <a name="service-communication-certificate"></a>Сертификат взаимодействия служб
Этот сертификат не является обязательным для большинства сценариев использования AD FS, включая Azure AD и Office 365. По умолчанию AD FS настраивает в качестве сертификата взаимодействия служб SSL-сертификат, предоставленный при начальной настройке.

**Рекомендация.**
- Используйте тот же сертификат, что и для SSL.  

### <a name="token-signing-certificate"></a>Сертификат для подписи маркера
Этот сертификат используется для подписывания маркеров, выдаваемых проверяющей стороне, поэтому приложения проверяющей стороны должны считать этот сертификат и связанный с ним ключ известными и доверенными. При изменении сертификата для подписи маркера, например по истечении срока его действия, необходимо обновить эти сведения у всех проверяющих сторон.

**Рекомендация.** Используйте стандартные для AD FS внутренние самозаверяющие сертификаты для подписи маркера.  

**Требования.**
- Если ваша организация требует, чтобы для подписи маркеров использовались сертификаты корпоративной PKI, это можно настроить с помощью параметра SigningCertificateThumbprint в командлете Install-AdfsFarm.
- Независимо от того, используются ли внутренние сертификаты или сертификаты внешних служб, при изменении сертификата для подписи маркера необходимо передать сведения о новом сертификате всем проверяющим сторонам.  В противном случае вход на все необновленные проверяющие стороны будет завершаться ошибкой.

### <a name="token-encryptingdecrypting-certificate"></a>Сертификат шифрования и расшифровки маркера
Этот сертификат используется поставщиками утверждений, которые шифруют передаваемые в AD FS маркеры.

**Рекомендация.** Используйте стандартные для AD FS внутренние самозаверяющие сертификаты для расшифровки маркера.  

**Требования.**
- Если ваша организация требует, чтобы для подписи маркеров использовались сертификаты корпоративной PKI, это можно настроить с помощью параметра DecryptingCertificateThumbprint в командлете Install-AdfsFarm.
- Независимо от того, используются ли внутренние сертификаты или сертификаты внешних служб, при изменении сертификата для расшифровки маркера необходимо передать сведения о новом сертификате всем поставщикам утверждений.  В противном случае вход на все необновленные поставщики утверждений будет завершаться ошибкой.
  
> [!CAUTION]  
> Сертификаты, используемые для\-подписи и шифрования/расшифровки\-токенов,\/играют критически важную роль для стабильности службы федерации. Клиенты, которые самостоятельно управляют сертификатами для\-подписи маркера и (или) для \-шифрования/расшифровки сертификатов,\/должны обеспечить их резервное копирование и независимую доступность во время событий восстановления.  

### <a name="user-certificates"></a>Сертификаты пользователей
- Если в AD FS используется проверка подлинности с сертификатом пользователя x509, все сертификаты пользователей должны быть связаны с корневым центром сертификации, который является доверенным для серверов AD FS и прокси-службы веб-приложений.

## <a name="BKMK_2"></a>Требования к оборудованию  
Требования к оборудованию для AD FS и прокси-службы веб-приложений (физических или виртуальных компьютеров) определяют мощность ЦП, и вам нужно правильно выбрать размер фермы для обеспечения нужной производительности.  
- Используйте [электронную таблицу планирования ресурсов AD FS 2016](http://adfsdocs.blob.core.windows.net/adfs/ADFSCapacity2016.xlsx), чтобы определить требуемое количество серверов для AD FS и прокси-службы веб-приложений.

Требования к памяти и диску для AD FS почти не зависят от нагрузки и приводятся в таблице ниже.


|**Требования к оборудованию**|**Минимальное значение**|**Рекомендуемое значение**|
|----- | ----- |-----|
|ОЗУ|2 ГБ|4 ГБ |
|Место на диске|32 ГБ|100 ГБ |

**Требования к оборудованию для SQL Server**

Если вы используете SQL Server для базы данных конфигурации AD FS, выберите размер SQL Server по базовому уровню рекомендаций для SQL Server.  Размер базы данных AD FS очень мал, и AD FS не создает заметной нагрузки на этот экземпляр базы данных.  Однако в процессе проверки подлинности AD FS может подключаться к этой базе данных несколько раз, поэтому сетевое подключение должно быть надежным.  К сожалению, SQL Azure не поддерживается в качестве базы данных конфигурации AD FS.
  
## <a name="BKMK_3"></a>Требования к прокси-серверу  
  
-   Для доступа к экстрасети необходимо развернуть службу роли прокси-службы веб-приложений, которая входит в роль сервера удаленного доступа. 

-   Сторонние прокси-серверы должны поддерживать [протокол MS-ADFSPIP](https://msdn.microsoft.com/library/dn392811.aspx) в качестве прокси AD FS.  Список сторонних поставщиков см. в разделе [вопросов и ответов](AD-FS-FAQ.md).

-   Для AD FS 2016 требуется, чтобы прокси-служба веб-приложений работала под управлением Windows Server 2016.  Прокси нижнего уровня невозможно настроить для фермы AD FS 2016, которая работает на уровне поведения фермы 2016.
  
-   Сервер федерации и служба роли прокси-службы веб-приложений не могут быть установлены на одном компьютере.  
  
## <a name="BKMK_4"></a>Требования к AD DS  
**Требования к контроллеру домена**  
  
- Для AD FS требуется, чтобы контроллеры домена работали под управлением Windows Server 2008 или более поздней версии.

- Для Microsoft Passport for Work требуется хотя бы один контроллер домена под управлением Windows Server 2016.
  
> [!NOTE]  
> Поддержка сред с контроллерами домена Windows Server 2003 уже закончилась. Дополнительные сведения о жизненном цикле поддержки Майкрософт см. на [этой странице](https://support.microsoft.com/lifecycle/search/default.aspx?sort=PN&alpha=Windows+Server+2003&Filter=FilterNO).  
  
**Требования к функциональному уровню домена**  
  
 - Все домены учетных записей пользователей и домены, к которым присоединяются серверы AD FS, должны работать на функциональном уровне домена Windows Server 2003 или более поздней версии.  
  
 - Для проверки подлинности по сертификатам клиента (которые явно сопоставлены c учетными записями пользователей в AD DS) требуется функциональный уровень домена Windows Server 2008 или выше.  
  
**Требования к схеме**  
  
-   Для новых установок AD FS 2016 требуется схема Active Directory 2016 (минимальная версия 85).

-   Для повышения уровня поведения фермы AD FS до 2016 требуется схема Active Directory 2016 (минимальная версия 85).  

  
**Требования к учетным записям служб**  
  
-   В качестве учетной записи службы для AD FS можно использовать любую стандартную учетную запись домена. Поддерживаются также групповые управляемые учетные записи служб. Разрешения, необходимые во время выполнения, будут добавлены при настройке AD FS автоматически.

-   Для учетной записи службы AD требуется назначение прав пользователя "Вход в качестве службы".

-   Для "NT Service\adfssrv" и "NT Service\drs" требуются назначения прав пользователя "Создание аудитов безопасности" и "Вход в качестве службы".

-   Для групповых управляемых учетных записей службы требуется по меньшей мере один контроллер домена под управлением Windows Server 2012 или более поздней версии.  Групповая управляемая учетная запись службы должна находиться в контейнере CN=Managed Service Accounts по умолчанию.  

-   Для проверки подлинности Kerberos необходима регистрация имени субъекта-службы "`HOST/<adfs\_service\_name>`" в учетной записи службы AD FS. По умолчанию AD FS настраивает этот параметр при создании новой фермы AD FS.  В случае сбоя, например при конфликте имен или отсутствии разрешений, вы увидите предупреждение и должны будете добавить его вручную.  
   
**Требования к домену**  
  
-   Все серверы AD FS должны быть присоединены к домену AD DS.  
  
-   Все серверы AD FS в ферме должны быть развернуты в одном домене.  
   
**Требования к нескольким лесам**  
  
-   Домен, к которому присоединяются серверы AD FS, должен доверять каждому домену или лесу, в котором есть пользователи с проверкой подлинности в службе AD FS.  

-   Лес, в который входит учетная запись службы AD FS, должен доверять лесам всех пользователей, используемым для входа. 
  
-   Учетная запись службы AD FS должна иметь разрешения на чтение атрибутов пользователей в каждом домене, в котором есть пользователи, выполняющие проверку подлинности в службе AD FS.  
  
## <a name="BKMK_5"></a>Требования к базе данных конфигурации  
В этом разделе описаны требования и ограничения для ферм AD FS, которые используют в качестве базы данных внутреннюю базу данных Windows (WID) или SQL Server соответственно.  
  
**WID**  
  
-   Профиль разрешения артефактов SAML 2.0 в ферме WID не поддерживается.    

-   Обнаружение воспроизведения маркеров в ферме WID не поддерживается. (Эта функция используется только в сценариях, где AD FS выступает в качестве поставщика федерации и использует маркеры безопасности внешних поставщиков утверждений.)  
  
В следующей таблице приведены сведения о количестве серверов AD FS, поддерживаемом для ферм WID и SQL Server.    
  
  
|| В AD FS настроено от 1 до 100 отношений доверия с проверяющей стороной | Настроено более 100 отношений доверия с проверяющей стороной  |
| --- |--- | --- |
|От 1 до 30 серверов AD FS|Поддерживается для WID|Не поддерживается для WID — нужен SQL Server |
|Более 30 серверов AD FS|Не поддерживается для WID — нужен SQL Server|Не поддерживается для WID — нужен SQL Server  
  
**SQL Server**  
  
- Для AD FS в Windows Server 2016 поддерживается SQL Server 2008 и более поздних версий.

- В ферме SQL Server поддерживается как разрешение артефактов SAML, так и обнаружение воспроизведения маркеров.  
  
## <a name="BKMK_6"></a>Требования к браузерам  
Если проверка подлинности AD FS выполняется через браузер или браузерный элемент управления, этот браузер должен соответствовать следующим требованиям.  
  
- Должно быть разрешено выполнение JavaScript.  
  
- Для единого входа в клиентском браузере должно быть разрешено использование файлов cookie.  
  
- Должен поддерживаться индикатор имени сервера (\(SNI\)).  
  
- Для проверки подлинности по сертификату пользователя и (или) сертификату устройства браузер должен поддерживать проверку подлинности SSL-сертификата клиента.  

- Для простого входа с использованием встроенной проверки подлинности Windows должно быть настроено имя службы федерации (например, HTTPS:\/\/fs.contoso.com) в зоне местной интрасети или в зоне доверенных узлов.
  ## <a name="BKMK_7"></a>Требования к сети  
 
**Требования к брандмауэру**  
  
На брандмауэрах, которые расположены между прокси-службой веб-приложений и фермой серверов федерации, а также между клиентами и прокси-службой веб-приложений, должен быть открыт порт TCP 443 для входящих подключений.  
  
Кроме того, если требуется проверка подлинности клиента на основе сертификата пользователя \(проверка подлинности clientTLS с использованием сертификатов пользователя X509\), а конечная точка certauth не включена на порту 443, для AD FS 2016 необходимо открыть для входящих подключений TCP-порт 49443 на брандмауэре между клиентами и прокси-службой веб-приложений. Это не является обязательным для брандмауэра между прокси-службой веб-приложений и серверами федерации\). 

Дополнительные сведения о требованиях к портам и протоколам в гибридной среде см. в [этой статье](https://docs.microsoft.com/azure/active-directory/connect/active-directory-aadconnect-ports). 

Дополнительные сведения см. в статье с [рекомендациями по защите служб федерации Active Directory](../deployment/Best-Practices-Securing-AD-FS.md).
  
**Требования к DNS**  
  
-   Для доступа из интрасети все клиенты, которые обращаются к службе AD FS из внутренней корпоративной сети \(интрасети\), должны иметь возможность разрешать имя службы AD FS в адрес сервера AD FS или подсистемы балансировки нагрузки для серверов AD FS.  
  
-   Для доступа из экстрасети все клиенты, которые обращаются к службе AD FS из-за пределов корпоративной сети \(из экстрасети или Интернета\), должны иметь возможность разрешать имя службы AD FS в адрес сервера прокси-службы веб-приложений или подсистемы балансировки нагрузки для серверов прокси-службы веб-приложений.  
  
-   Каждый сервер прокси-службы веб-приложений в сети периметра должен иметь возможность разрешать имя службы AD FS в адрес сервера AD FS или подсистемы балансировки нагрузки для серверов AD FS. Для этого можно настроить альтернативный DNS-сервер в сети периметра или локально настроить разрешение имен на сервере с помощью файла hosts.  
  
-   Для встроенной проверки подлинности Windows необходимо использовать в DNS запись A \(но не CNAME\) для имени службы федерации.  

-   Для проверки подлинности по сертификату пользователя на порту 443 необходимо настроить в DNS разрешение имени certauth.\<имя службы федерации\> в адрес сервера федерации или прокси-службы веб-приложений.

-   Для регистрации устройств или для современной проверки подлинности на локальных ресурсах с клиентами более старых версий, чем Windows 10, необходимо настроить разрешение имен enterpriseregistration.\<суффикс имени участника-пользователя\> для каждого используемого в организации суффикса имени участника-пользователя в адрес сервера федерации или прокси-службы веб-приложений.

**Требования к подсистеме балансировки нагрузки**
- Подсистема балансировки нагрузки НЕ ДОЛЖНА завершать SSL-подключение. AD FS поддерживает несколько вариантов использования с проверкой подлинности на основе сертификата, которые будут невозможны при таком завершении SSL-подключения. Завершение SSL-подключения в подсистеме балансировки нагрузки не поддерживается ни для одного варианта использования. 
- Мы рекомендуем использовать подсистему балансировки нагрузки, которая поддерживает SNI. Если это невозможно, в качестве обходного пути можно настроить использование резервной привязки 0.0.0.0 на сервере AD FS или прокси-службы веб-приложений.
- Мы рекомендуем использовать конечные точки проб работоспособности HTTP (не HTTPS) для проверки маршрутизации трафика через подсистему балансировки нагрузки. Это позволяет избежать проблем, связанных со SNI. На эти пробы конечные точки должны возвращать ответ HTTP 200 OK и обрабатывать их локально, без зависимостей от внутренних серверных служб. К пробе HTTP можно обратиться по протоколу HTTP, используя путь "/adfs/probe"
    - http://&lt;имя прокси-службы веб-приложений&gt;/adfs/probe
    - http://&lt;имя сервера ADFS&gt;/adfs/probe
    - http://&lt;IP-адрес прокси-службы веб-приложений&gt;/adfs/probe
    - http://&lt;IP-адрес сервера ADFS&gt;/adfs/probe
- Мы НЕ РЕКОМЕНДУЕМ использовать для балансировки нагрузки циклический перебор DNS. Такой тип балансировки нагрузки не позволяет автоматически удалять узлы из подсистемы балансировки нагрузки с помощью проб работоспособности. 
- Мы НЕ РЕКОМЕНДУЕМ использовать в подсистеме балансировки нагрузки сходство сеансов на основе IP-адресов или прикрепленные сеансы для трафика проверки подлинности в AD FS. Это может вызвать перегрузку определенных узлов при использовании устаревшего протокола проверки подлинности для почтовых клиентов, которые подключаются к почтовым службам Office 365 (Exchange Online). 

## <a name="BKMK_13"></a>Требования к разрешениям  
Администратор, который выполняет установку и начальную настройку AD FS, должен иметь разрешения локального администратора на сервере AD FS.  Если у локального администратора нет разрешений на создание объектов в Active Directory, ему нужно обратиться к администратору домена для создания нужных объектов AD, а затем настроить ферму AD FS с помощью параметра AdminConfiguration.  
  
  

