---
title: Основные понятия AD FS OpenID Connect / OAuth
description: Узнайте о AD FS современных концепций проверки подлинности.
author: billmath
ms.author: billmath
manager: daveba
ms.date: 08/09/2019
ms.topic: article
ms.prod: windows-server
ms.technology: identity-adfs
ms.openlocfilehash: 353546be17f096b692c2429aa65529d302a2df7e
ms.sourcegitcommit: d5e27c1f2f168a71ae272bebf8f50e1b3ccbcca3
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/23/2020
ms.locfileid: "86966856"
---
# <a name="ad-fs-openid-connectoauth-concepts"></a>Основные понятия AD FS OpenID Connect / OAuth
Применимо к AD FS 2016 и более поздних версий
 
## <a name="modern-authentication-actors"></a>Современные субъекты проверки подлинности 

|Субъект| Описание|
|-----|-----|
|Конечный пользователь|Это субъект безопасности (пользователи, приложения, службы и группы), которым требуется доступ к ресурсу.|  
|Клиент|Это веб-приложение, определяемое по ИДЕНТИФИКАТОРу клиента. Клиент обычно является стороной, с которой взаимодействует конечный пользователь, и запрашивает маркеры у сервера авторизации.
|Сервер авторизации и поставщик удостоверений (IdP)| Это ваш сервер AD FS. Он отвечает за проверку подлинности субъектов безопасности, существующих в каталоге Организации. Он выдает маркеры безопасности (маркер доступа носителя, маркер идентификации, маркер обновления) после успешной проверки подлинности этих субъектов безопасности.
|Сервер ресурсов, поставщик ресурсов, проверяющая сторона| Это место, где находится ресурс или данные. Он доверяет серверу авторизации для безопасной проверки подлинности и авторизации клиента и использует маркеры доступа носителя, чтобы обеспечить возможность предоставления доступа к ресурсу.

Следующая схема предоставляет наиболее простую связь между субъектами:

![Современные субъекты проверки подлинности](media/adfs-modern-auth-concepts/concept1.png)

## <a name="application-types"></a>Типы приложений 
 

|Тип приложения|Описание|Роль|
|-----|-----|-----|
|Собственное приложение|Иногда называется **общедоступным клиентом**. это клиентское приложение, работающее на ПК или устройстве и взаимодействующее с пользователем.|Запрашивает маркеры от сервера авторизации (AD FS) для доступа пользователей к ресурсам. Отправляет HTTP-запросы к защищенным ресурсам, используя токены в качестве заголовков HTTP.| 
|Серверное приложение (веб-приложение)|Веб-приложение, которое выполняется на сервере и обычно доступно пользователям через браузер. Так как он способен поддерживать собственный секрет или учетные данные клиента, он иногда называется **конфиденциальным клиентом**. |Запрашивает маркеры от сервера авторизации (AD FS) для доступа пользователей к ресурсам. Перед запросом маркера клиент (веб-приложение) должен пройти проверку подлинности с помощью секрета. | 
|Веб-API|Конечный ресурс, к которому обращается пользователь. Их следует рассматривать как новое представление "проверяющих сторон".|Потребляет маркеры доступа носителя, полученные клиентами| 

## <a name="application-group"></a>Группа приложений 
 
Каждый клиент OAuth (собственное или веб-приложение) или ресурс (веб-API), настроенный с AD FS, должен быть связан с группой приложений. Клиенты в группе приложений могут быть настроены для доступа к ресурсам в одной группе. Группа приложений может содержать несколько клиентов и ресурсов.  

## <a name="security-tokens"></a>Маркеры безопасности 
 
Современная проверка подлинности использует следующие типы токенов: 
- **id_token**: маркер JWT, выданный сервером авторизации (AD FS) и используемый клиентом. Утверждения в маркере идентификации будут содержать сведения о пользователе, чтобы клиент мог его использовать.  
- **ACCESS_TOKEN**: маркер JWT, выданный сервером авторизации (AD FS) и предназначенный для использования ресурсом. "AUD" или утверждение аудитории этого маркера должно соответствовать идентификатору ресурса или веб-API.  
- **refresh_token**: этот маркер выдается AD FS для использования клиентом при необходимости обновления id_token и ACCESS_TOKEN. Маркер является непрозрачным для клиента и может использоваться только AD FS.  

## <a name="scopes"></a>Области действия 
 
При регистрации ресурса в AD FS можно настроить области, чтобы разрешить AD FS выполнять определенные действия. Помимо настройки области, значение области также необходимо отправить в запросе на AD FS для выполнения действия. Например, администратор должен настроить область как OpenID Connect во время регистрации ресурса, а приложение (клиент) должно отправить Scope = OpenID Connect в запросе на проверку подлинности, чтобы AD FS выдать маркер идентификатора. Подробные сведения о областях, доступных в AD FS, приведены ниже. 
 
- Аза — если используются [расширения протокола OAuth 2,0 для клиентов брокера](/openspecs/windows_protocols/ms-oapxbc/2f7d8875-0383-4058-956d-2fb216b44706)   и параметр scope содержит область "аза", сервер выдает новый основной маркер обновления и устанавливает его в refresh_token поле ответа, а также задает для поля refresh_token_expires_in значение времени существования нового основного маркера обновления, если оно применяется. 
- OpenID Connect — позволяет приложению запрашивать использование протокола авторизации OpenID Connect. 
- logon_cert — область logon_cert позволяет приложению запрашивать сертификаты входа в систему, которые можно использовать для интерактивного входа пользователей, прошедших проверку подлинности. Сервер AD FS пропускает параметр access_token из ответа и вместо этого предоставляет цепочку сертификатов CMS в кодировке Base64 или полный ответ PKI. Дополнительные сведения можно найти [здесь](/openspecs/windows_protocols/ms-oapx/32ce8878-7d33-4c02-818b-6c9164cc731e).
- user_impersonation — область user_impersonationа необходима для успешного запроса маркера доступа от имени AD FS. Дополнительные сведения об использовании этой области см. в статье [Создание многоуровневого приложения с помощью on-OBO (использование) с помощью OAuth с AD FS 2016](ad-fs-on-behalf-of-authentication-in-windows-server.md). 
- аллатклаимс — область аллатклаимс позволяет приложению запрашивать утверждения в маркере доступа и добавлять их в маркер идентификации.   
- vpn_cert — область vpn_cert позволяет приложению запрашивать сертификаты VPN, которые можно использовать для установки VPN-подключений с использованием проверки подлинности по EAP-TLS. Это больше не поддерживается. 
- email — позволяет приложению запрашивать утверждение по электронной почте для пользователя, выполнившего вход.  
- profile — позволяет приложению запрашивать утверждение связанные с профилем пользователя, выполнившего вход.  

## <a name="claims"></a>Утверждения 
 
Маркеры безопасности (токены доступа и идентификации), выданные AD FS содержат утверждения или утверждения сведений о субъекте, для которого была выполнена проверка подлинности. Приложения могут использовать утверждения для различных задач, включая следующие: 
- проверка маркера безопасности; 
- идентификация клиента каталога субъекта; 
- Отображение сведений о пользователе 
- Определение авторизации субъекта. утверждения, существующие в заданном маркере безопасности, зависят от типа маркера, типа учетных данных, используемых для проверки подлинности пользователя, и конфигурации приложения.  
 
## <a name="high-level-ad-fs-authentication-flow"></a>Поток проверки подлинности высокого уровня AD FS 

![Поток проверки подлинности AD FS](media/adfs-modern-auth-concepts/adfsauthflow.png)


 1. AD FS получает запрос проверки подлинности от клиента.  
 
 2. AD FS проверяет идентификатор клиента в запросе на проверку подлинности с помощью идентификатора клиента, полученного во время регистрации клиента и ресурса в AD FS. При использовании конфиденциального клиента AD FS также проверяет секрет клиента, указанный в запросе проверки подлинности. AD FS также проверить универсальный код ресурса (URI) перенаправления клиента. 
 
 3. AD FS определяет ресурс, к которому клиент хочет получить доступ через параметр ресурса, переданный в запросе проверки подлинности. Если используется клиентская библиотека MSAL, параметр resource не отправляется. Вместо этого URL-адрес ресурса отправляется как часть параметра области: *Scope = [URL-адрес ресурса]//[значения области, например OpenID Connect]*. 

    Если ресурс не передается с помощью параметра resource или Scope, ADFS будет использовать URN-ресурс по умолчанию: Microsoft: userInfo, политики (например, MFA, политика выдачи или авторизация), не могут быть настроены. 
 
 4. Далее AD FS проверяет, имеет ли клиент разрешения на доступ к ресурсу. AD FS также проверяет, соответствуют ли области, переданные в запросе проверки подлинности, областям, настроенным при регистрации ресурса. Если у клиента нет разрешений или соответствующие области не отправляются в запросе проверки подлинности, поток аутентификации завершается.   
 
 5. После проверки разрешений и областей AD FS проверяет подлинность пользователя с помощью настроенного [метода проверки подлинности](../operations/configure-authentication-policies.md).   

 6. Если требуется [дополнительный метод проверки подлинности](../operations/configure-additional-authentication-methods-for-ad-fs.md) в соответствии с политикой ресурсов или глобальной политикой аутентификации, AD FS активирует дополнительную проверку подлинности. 

 7. Для выполнения проверки подлинности AD FS использует [Azure MFA](../operations/configure-ad-fs-and-azure-mfa.md) или СТОРОННИЙ [сторонний MFA](../operations/additional-authentication-methods-ad-fs.md) .   
 
 8. После проверки подлинности пользователя AD FS применяет [правила утверждений](../deployment/configuring-claim-rules.md) (определяет утверждения, отправленные ресурсу как часть маркеров безопасности) и [политики контроля доступа](../operations/ad-fs-client-access-policies.md) (определяет, что пользователь удовлетворяет необходимым условиям для доступа к ресурсу).   

 9. Затем AD FS создает маркеры доступа и обновления. 

 10. AD FS также создает маркер идентификации. 
 
 11. Если scope = аллатклаимс включен в запрос проверки подлинности, [маркер идентификации настраивается так](custom-id-tokens-in-ad-fs.md) , чтобы включить в маркер доступа утверждения на основе определенных правил утверждений. 
    
 12. После создания и настройки необходимых токенов AD FS отвечает клиенту, включая маркеры. Маркер идентификации включается в ответ, только если запрос проверки подлинности содержит Scope = OpenID Connect. Клиент всегда может получить маркер идентификатора после проверки подлинности с помощью конечной точки токена. 

## <a name="types-of-libraries"></a>Типы библиотек 
  
С AD FSами используются два типа библиотек: 
- **Клиентские библиотеки**. собственные клиенты и серверные приложения используют клиентские библиотеки для получения маркеров доступа для вызова ресурса, например веб-API. Библиотека проверки подлинности Microsoft (MSAL) — это последняя и рекомендуемая клиентская библиотека при использовании AD FS 2019. Для AD FS 2016 рекомендуется использовать Библиотека проверки подлинности Active Directory (ADAL).  

- **Серверные библиотеки по промежуточного слоя**: веб-приложения используют серверные библиотеки по промежуточного слоя для входа пользователя. Веб-API используют серверные библиотеки ПО промежуточного слоя для проверки маркеров, отправляемых собственными клиентами или другими серверами. OWIN (открытый веб-интерфейс для .NET) является рекомендуемой библиотекой по промежуточного слоя. 

## <a name="customize-id-token-additional-claims-in-id-token"></a>Настройка маркера идентификации (дополнительные утверждения в маркере идентификации)
 
В некоторых сценариях веб-приложению (клиенту) могут потребоваться дополнительные утверждения в маркере идентификации, чтобы помочь в функциональности. Это можно сделать с помощью одного из следующих параметров. 

**Вариант 1.** Следует использовать при использовании общедоступного клиента, а веб-приложение не имеет ресурса, к которому он пытается получить доступ. Для параметра требуется 
1.  response_mode задать как form_post 
2.  Идентификатор проверяющей стороны (идентификатор веб-API) совпадает с идентификатором клиента

![AD FS настройки токена 1](media/adfs-modern-auth-concepts/option1.png)

**Вариант 2.** Следует использовать, если веб-приложение имеет ресурс, к которому он пытается получить доступ, и ему необходимо передать дополнительные утверждения через маркер идентификации. Можно использовать как общедоступные, так и конфиденциальные клиенты. Для параметра требуется 
1.  response_mode задать как form_post 
2.  KB4019472 установлен на серверах AD FS 
3.  Область аллатклаимс, назначенная паре "клиент — RP". Область можно назначить с помощью командлета Grant-Адфсаппликатионпермиссион (использовать Set-Адфсаппликатионпермиссион, если он уже был получен), как показано в следующем примере: 

    ``` powershell
    Grant-AdfsApplicationPermission -ClientRoleIdentifier "https://my/privateclient" -ServerRoleIdentifier "https://rp/fedpassive" -ScopeNames "allatclaims","openid"
    ```

![AD FS настройки токена 2](media/adfs-modern-auth-concepts/option2.png)

Чтобы лучше понять, как настроить веб-приложение в ADFS для получения настраиваемого маркера идентификации, см. раздел [Настройка утверждений, которые будут выдаваться в id_token при использовании OpenID Connect Connect или OAuth с AD FS 2016 или более поздней версии](Custom-Id-Tokens-in-AD-FS.md).

## <a name="single-log-out"></a>Один выход

В результате одного выхода все сеансы клиента закончаются с помощью идентификатора сеанса. AD FS 2016 и более поздних версий поддерживает единый выход для OpenID Connect Connect/OAuth. Дополнительные сведения см. в разделе [единый выход для OpenID Connect Connect with AD FS](ad-fs-logout-openid-connect.md).


## <a name="ad-fs-endpoints"></a>AD FS конечных точек

|Конечная точка AD FS|Описание|
|-----|-----|
|/Authorize|AD FS возвращает код авторизации, который можно использовать для получения маркера доступа|
|/Token|AD FS возвращает маркер доступа, который можно использовать для доступа к ресурсу (веб-API).|
|/усеринфо|AD FS Возвращает утверждения о пользователе, прошедшем проверку подлинности|
|/девицекоде|AD FS возвращает код устройства и пользовательский код|
|/логаут|AD FS выходить из систему пользователя|
|/кэйс|AD FS открытые ключи, используемые для подписывания ответов|
|/.велл-кновн/опенид-конфигуратион|AD FS возвращает метаданные подключения OAuth/OpenID Connect.|
