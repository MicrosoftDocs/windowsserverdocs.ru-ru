---
title: AD FS MSAL Native App, вызывающий веб-API
description: Получите сведения о создании пользователей для входа в систему с собственным приложением, прошедших проверку подлинности AD FS 2019 и получение маркеров с помощью библиотеки MSAL для вызова веб-API.
author: billmath
ms.author: billmath
manager: daveba
ms.date: 08/09/2019
ms.topic: article
ms.prod: windows-server
ms.technology: identity-adfs
ms.openlocfilehash: ff76a6dffd66296a02cffcbd79bc6dfadc91c14a
ms.sourcegitcommit: 6aff3d88ff22ea141a6ea6572a5ad8dd6321f199
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/27/2019
ms.locfileid: "71407795"
---
# <a name="scenario-native-app-calling-web-api"></a>Сценарий: Вызов веб-API в собственном приложении 
>Область применения. AD FS 2019 и более поздних версий 
 
Узнайте, как создавать входные пользователи в собственном приложении, прошедшие проверку подлинности AD FS 2019 и вызвав маркеры с помощью [библиотеки MSAL](https://github.com/AzureAD/microsoft-authentication-library-for-dotnet/wiki) для вызова веб-API.  
 
Прежде чем читать эту статью, необходимо ознакомиться с [AD FS концепциями](../ad-fs-openid-connect-oauth-concepts.md) и [потоком предоставления кода авторизации](../../overview/ad-fs-openid-connect-oauth-flows-scenarios.md#authorization-code-grant-flow) .
 
## <a name="overview"></a>Обзор 
 
 ![Обзор](media/adfs-msal-native-app-web-api/native1.png)

В этом потоке вы добавляете проверку подлинности в собственное приложение (общедоступный клиент), что может привести к входу пользователей и вызову веб-API. Чтобы вызвать веб-API из собственного приложения, которое входит в систему пользователей, можно использовать метод получения маркера [аккуиретокенинтерактиве](https://docs.microsoft.com/en-us/dotnet/api/microsoft.identity.client.ipublicclientapplication.acquiretokeninteractive?view=azure-dotnet#Microsoft_Identity_Client_IPublicClientApplication_AcquireTokenInteractive_System_Collections_Generic_IEnumerable_System_String__) для MSAL. Чтобы включить это взаимодействие, MSAL использует веб-браузер. 

 
Чтобы лучше понять, как настроить собственное приложение в ADFS для интерактивного получения маркера доступа, давайте будем использовать пример, доступный [здесь](https://github.com/microsoft/adfs-sample-msal-dotnet-native-to-webapi) , и пошаговые инструкции по настройке регистрации и кода приложения.  
 

## <a name="pre-requisites"></a>Предварительные требования 


- Клиентские средства GitHub 
- Настройка и запуск AD FS 2019 или более поздней версии 
- Visual Studio 2013 или более поздней версии 
 

## <a name="app-registration-in-ad-fs"></a>Регистрация приложения в AD FS 
В этом разделе показано, как зарегистрировать собственное приложение в качестве общедоступного клиента и веб-API в качестве проверяющей стороны (RP) в AD FS 

  1. В **AD FS управления**щелкните правой кнопкой мыши **группы приложений** и выберите команду **Добавить группу приложений**.   
  
  2. В мастере группы приложений в поле **имя** введите **нативеапптовебапи** и в разделе **клиент-сервер приложения** выберите **собственное приложение, осуществляющее доступ к шаблону веб-API** . Нажмите кнопку **Далее**.  
  
      ![REG приложения](media/adfs-msal-native-app-web-api/native2.png)  

  3. Скопируйте значение **идентификатора клиента** . Он будет использоваться позже в качестве значения **ClientID** в файле **app. config** приложения. Введите следующую команду для **URI перенаправления:** https://ToDoListClient. Нажмите кнопку **Добавить**. Нажмите кнопку **Далее**.  
 
     ![REG приложения](media/adfs-msal-native-app-web-api/native3.png) 

  4. На экране Настройка веб-API введите **идентификатор:** https://localhost:44321/. Нажмите кнопку **Добавить**. Нажмите кнопку **Далее**. Это значение будет использоваться позже в файлах **app. config** и **Web. config** приложения.
 
     ![REG приложения](media/adfs-msal-native-app-web-api/native4.png)   
  
  5. На экране применить политику управления доступом выберите **разрешение все** и нажмите кнопку **Далее**. 
  
     ![REG приложения](media/adfs-msal-native-app-web-api/native5.png)   
  
  6. На экране Настройка разрешений приложения убедитесь, что **OpenID Connect** выбрано, и нажмите кнопку **Далее**.  
     
     ![REG приложения](media/adfs-msal-native-app-web-api/native6.png) 

  7. На экране Сводка нажмите кнопку **Далее**.
  
  8. На экране Завершение нажмите кнопку **Закрыть**. 
  
  9. В AD FS "Управление" щелкните **группы приложений** и выберите **нативеапптовебапи** Application Group (Группа приложений). Щелкните правой кнопкой мыши и выберите **Свойства**.
  
      ![REG приложения](media/adfs-msal-native-app-web-api/native7.png)

  10. На экране свойства Нативеапптовебапи выберите **нативеапптовебапи — веб-API** в разделе **веб-API** и нажмите кнопку **изменить...** 
  
      ![REG приложения](media/adfs-msal-native-app-web-api/native8.png) 

  11. На странице свойства Нативеапптовебапи — веб-API выберите вкладку **правила преобразования выдачи** и нажмите кнопку **Добавить правило...** 
  
      ![REG приложения](media/adfs-msal-native-app-web-api/native9.png) 

  12. В мастере добавления правила преобразования утверждений выберите **преобразовать входящее утверждение** в раскрывающемся списке **шаблон правила обработки утверждений:** и нажмите кнопку **Далее**.  
  
      ![REG приложения](media/adfs-msal-native-app-web-api/native10.png) 

  13. Введите **NameID** в поле **имя правила утверждений:** . Выберите **имя** для **типа входящего утверждения:** , **идентификатор имени** для **типа исходящего утверждения:** и **Общее имя** для **формата исходящего идентификатора имени:** . Нажмите кнопку **Готово**.
  
      ![REG приложения](media/adfs-msal-native-app-web-api/native11.png) 

  14. Нажмите кнопку ОК в Нативеапптовебапи — экран свойств веб-API, а затем экран свойства Нативеапптовебапи.  
 
## <a name="code-configuration"></a>Конфигурация кода 
В этом разделе показано, как настроить собственное приложение для входа в систему и получить маркер для вызова веб-API. 

1. Скачайте [Пример отсюда](https://github.com/microsoft/adfs-sample-msal-dotnet-native-to-webapi) 

2. Открытие примера с помощью Visual Studio 

3. Откройте файл App. config. Измените следующие настройки: 
   - IDA: Authority-введите https://[имя узла AD FS]/адфс
   - IDA: ClientId — введите значение **идентификатора клиента** из #3 в разделе "регистрация приложения" в AD FS выше. 
   - IDA: RedirectUri — введите значение **URI перенаправления** из #3 в разделе Регистрация приложения в AD FS выше.
   - TODO: Тодолистресаурцеид — введите значение **идентификатора** из #4 в разделе "регистрация приложения" в AD FS выше. 
   - IDA: TODO: Тодолистбасеаддресс — введите значение **идентификатора** из #4 в разделе "регистрация приложения" в AD FS выше. 
 
     ![Конфигурация кода](media/adfs-msal-native-app-web-api/native12.png)

 4. Откройте файл Web. config. Измените следующие настройки: 
    - IDA: идентификатор аудитории — введите значение **идентификатора** из #4 в разделе Регистрация приложения в AD FS выше. 
    - IDA Адфсметадатаендпоинт — введите https://[имя узла AD FS]/FederationMetadata/2007-06/FederationMetadata.XML 
    
      ![Конфигурация кода](media/adfs-msal-native-app-web-api/native13.png)
 
  
## <a name="test-the-sample"></a>Тестирование образца 
В этом разделе показано, как проверить образец, настроенный выше. 

  1. После внесения изменений в код перестройте решение 
 
  2. В Visual Studio щелкните правой кнопкой мыши решение и выберите команду **задать запускаемые проекты...**  
 
     ![Тест приложения](media/adfs-msal-native-app-web-api/native14.png)

  3. На странице Свойства убедитесь, что для параметра **действие** задано значение **Запуск** для каждого из проектов. 
      
     ![Тест приложения](media/adfs-msal-native-app-web-api/native15.png)

  4. В верхней части Visual Studio щелкните зеленую стрелку.  
 
     ![Тест приложения](media/adfs-msal-native-app-web-api/native16.png)

  5. На главном экране собственного приложения щелкните **Вход**.  
  
     ![Тест приложения](media/adfs-msal-native-app-web-api/native17.png)

    Если вы не видите экран собственного приложения, найдите и удалите файлы * мсалкаче. bin из папки, в которой хранится репозиторий проекта в системе. 

  6. Вы будете перенаправлены на страницу входа AD FS. Выполните вход. 
  
      ![Тест приложения](media/adfs-msal-native-app-web-api/native18.png)

  7. После входа введите текст **Сборка собственного приложения в веб-API** в поле **создать элемент для выполнения**. Нажмите кнопку **Добавить элемент**.  Будет вызвана **Служба списка задач (веб-API)** и добавлен элемент в кэш. 
    
       ![Тест приложения](media/adfs-msal-native-app-web-api/native19.png)
 
## <a name="next-steps"></a>Следующие шаги
[Подключения AD FS OpenID или потоки OAuth и сценарии использования приложений](../../overview/ad-fs-openid-connect-oauth-flows-scenarios.md)
 