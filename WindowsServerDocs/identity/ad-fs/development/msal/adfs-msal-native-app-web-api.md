---
title: AD FS MSAL Native App, вызывающий веб-API
description: Получите сведения о создании пользователей для входа в систему с собственным приложением, прошедших проверку подлинности AD FS 2019 и получение маркеров с помощью библиотеки MSAL для вызова веб-API.
author: billmath
ms.author: billmath
manager: daveba
ms.date: 08/09/2019
ms.topic: article
ms.openlocfilehash: 88333427cf8f147e0d81d8d07dfff08fb2cebb09
ms.sourcegitcommit: fc2a7c69a74edcd79372054c4a9a24237510babd
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/22/2021
ms.locfileid: "98672966"
---
# <a name="scenario-native-app-calling-web-api"></a>Сценарий: собственное приложение, вызывающее веб-API
>Применимо к: AD FS 2019 и более поздних версий

Узнайте, как создавать входные пользователи в собственном приложении, прошедшие проверку подлинности AD FS 2019 и вызвав маркеры с помощью [библиотеки MSAL](https://github.com/AzureAD/microsoft-authentication-library-for-dotnet/wiki)  для вызова веб-API.

Прежде чем читать эту статью, необходимо ознакомиться с [AD FS концепциями](../ad-fs-openid-connect-oauth-concepts.md) и [потоком предоставления кода авторизации](../../overview/ad-fs-openid-connect-oauth-flows-scenarios.md#authorization-code-grant-flow) .

## <a name="overview"></a>Обзор

 ![Обзор](media/adfs-msal-native-app-web-api/native1.png)

В этом потоке вы добавляете проверку подлинности в собственное приложение (общедоступный клиент), что может привести к входу пользователей и вызову веб-API. Чтобы вызвать веб-API из собственного приложения, которое входит в систему пользователей, можно использовать метод получения маркера [аккуиретокенинтерактиве](/dotnet/api/microsoft.identity.client.ipublicclientapplication.acquiretokeninteractive#Microsoft_Identity_Client_IPublicClientApplication_AcquireTokenInteractive_System_Collections_Generic_IEnumerable_System_String__) для MSAL. Чтобы реализовать это взаимодействие, MSAL использует веб-браузер.

Чтобы лучше понять, как настроить собственное приложение в ADFS для интерактивного получения маркера доступа, давайте будем использовать пример, доступный [здесь](https://github.com/microsoft/adfs-sample-msal-dotnet-native-to-webapi) , и пошаговые инструкции по настройке регистрации и кода приложения.


## <a name="pre-requisites"></a>Предварительные требования

- Клиентские средства GitHub
- Настройка и запуск AD FS 2019 или более поздней версии
- Visual Studio 2013 или более поздней версии

## <a name="app-registration-in-ad-fs"></a>Регистрация приложения в AD FS
В этом разделе показано, как зарегистрировать собственное приложение в качестве общедоступного клиента и веб-API в качестве проверяющей стороны (RP) в AD FS

  1. В **AD FS управления** щелкните правой кнопкой мыши **группы приложений** и выберите команду **Добавить группу приложений**.

  2. В мастере группы приложений в поле **имя** введите **нативеапптовебапи** и в разделе **клиент-сервер приложения** выберите **собственное приложение, осуществляющее доступ к шаблону веб-API** . Нажмите кнопку **Далее**.

      ![Снимок экрана: страница приветствия мастера добавления группы приложений, показывающая собственное приложение, осуществляющее доступ к выделенному шаблону веб-API.](media/adfs-msal-native-app-web-api/native2.png)

  3. Скопируйте значение **идентификатора клиента** . Он будет использоваться позже в качестве значения **ClientID** в файле **App.config** приложения. Введите следующую команду для **URI перенаправления:** https://ToDoListClient . Нажмите кнопку **Добавить**. Нажмите кнопку **Далее**.

     ![Снимок экрана: страница "собственное приложение" мастера добавления группы приложений, отображающая перенаправление U R I.](media/adfs-msal-native-app-web-api/native3.png)

  4. На экране Настройка веб-API введите **идентификатор:** https://localhost:44321/ . Нажмите кнопку **Добавить**. Нажмите кнопку **Далее**. Это значение будет использоваться позже в файлах **App.config** и **Web.config** приложения.

     ![Снимок экрана страницы "Настройка веб-интерфейса API" мастера добавления группы приложений с правильным идентификатором.](media/adfs-msal-native-app-web-api/native4.png)

  5. На экране применить политику управления доступом выберите **разрешение все** и нажмите кнопку **Далее**.

     ![Снимок экрана: страница "Выбор политики управления доступом" мастера добавления группы приложений с выделенным параметром "Разрешите все".](media/adfs-msal-native-app-web-api/native5.png)

  6. На экране Настройка разрешений приложения убедитесь, что **OpenID Connect** выбрано, и нажмите кнопку **Далее**.

     ![Снимок экрана со страницей настройки разрешений приложения в мастере добавления группы приложений с выбранным параметром открыть I D.](media/adfs-msal-native-app-web-api/native6.png)

  7. На экране Сводка нажмите кнопку **Далее**.

  8. На экране Завершение нажмите кнопку **Закрыть**.

  9. В AD FS "Управление" щелкните **группы приложений** и выберите **нативеапптовебапи**         Application Group (Группа приложений). Щелкните правой кнопкой мыши и выберите **Свойства**.

      ![Снимок экрана: диалоговое окно управления D F S, в котором отображается выделенная группа Нативеапптовебапи и параметр Properties в раскрывающемся списке.](media/adfs-msal-native-app-web-api/native7.png)

  10. На экране свойства Нативеапптовебапи выберите **нативеапптовебапи — веб-API** в разделе **веб-API** и нажмите кнопку **изменить...**

      ![Снимок экрана: диалоговое окно свойств Нативеапптовебапи, показывающее выделенное приложение Нативеапптовебапи-Web A P I.](media/adfs-msal-native-app-web-api/native8.png)

  11. На странице свойства Нативеапптовебапи — веб-API выберите вкладку **правила преобразования выдачи** и нажмите кнопку **Добавить правило...**

      ![Снимок экрана: диалоговое окно "Нативеапптовебапи" (свойства P I), показывающее вкладку "правила преобразования выдачи".](media/adfs-msal-native-app-web-api/native9.png)

  12. В мастере добавления правила преобразования утверждений выберите **преобразовать входящее утверждение** в раскрывающемся списке **шаблон правила обработки утверждений:** и нажмите кнопку **Далее**.

      ![Снимок экрана со страницей выбора шаблона правила в мастере добавления правила преобразования утверждений с выбранным параметром Преобразование входящего утверждения.](media/adfs-msal-native-app-web-api/native10.png)

  13. Введите **NameID** в поле **имя правила утверждений:** . Выберите **имя** для **типа входящего утверждения:**, **идентификатор имени** для **типа исходящего утверждения:** и **Общее имя** для **формата исходящего идентификатора имени:**. Нажмите кнопку **Готово**.

      ![Снимок экрана со страницей "Настройка правила" мастера добавления правила преобразования утверждений, в котором показана описанная выше конфигурация.](media/adfs-msal-native-app-web-api/native11.png)

  14. Нажмите кнопку ОК в Нативеапптовебапи — экран свойств веб-API, а затем экран свойства Нативеапптовебапи.

## <a name="code-configuration"></a>Конфигурация кода
В этом разделе показано, как настроить собственное приложение для входа в систему и получить маркер для вызова веб-API.

1. Скачайте [Пример отсюда](https://github.com/microsoft/adfs-sample-msal-dotnet-native-to-webapi)

2. Открытие примера с помощью Visual Studio

3. Откройте файл конфигурации App.config. Измените следующие настройки:
   - IDA: Введите h`ttps://[your AD FS hostname]/adfs`
   - IDA: ClientId — введите значение **идентификатора клиента** из #3 в разделе "регистрация приложения" в AD FS выше.
   - IDA: RedirectUri — введите значение **URI перенаправления** из #3 в разделе Регистрация приложения в AD FS выше.
   - TODO: Тодолистресаурцеид — введите значение **идентификатора** из #4 в разделе "регистрация приложения" в AD FS выше.
   - IDA: TODO: Тодолистбасеаддресс — введите значение **идентификатора** из #4 в разделе "регистрация приложения" в AD FS выше.

     ![Снимок экрана файла конфигурации приложения, в котором показаны измененные значения.](media/adfs-msal-native-app-web-api/native12.png)

 4. Откройте файл Web.config. Измените следующие настройки:
    - IDA: идентификатор аудитории — введите значение **идентификатора** из #4 в разделе Регистрация приложения в AD FS выше.
    - IDA: Адфсметадатаендпоинт — ввод `https://[your AD FS hostname]/federationmetadata/2007-06/federationmetadata.xml`

      ![Снимок экрана файла веб-конфигурации, отображающего измененные значения.](media/adfs-msal-native-app-web-api/native13.png)

## <a name="test-the-sample"></a>Тестирование примера
В этом разделе показано, как проверить образец, настроенный выше.

  1. После внесения изменений в код перестройте решение

  2. В Visual Studio щелкните правой кнопкой мыши решение и выберите команду **задать запускаемые проекты...**

     ![Снимок экрана списка, который появляется при щелчке правой кнопкой мыши решения с выделенным параметром "задать запуск проектов".](media/adfs-msal-native-app-web-api/native14.png)

  3. На странице Свойства убедитесь, что для параметра **действие** задано значение **Запуск** для каждого из проектов.

     ![Снимок экрана: диалоговое окно страниц свойств решения с выбранным параметром несколько запускаемых проектов, а все действия по проектам запускаются.](media/adfs-msal-native-app-web-api/native15.png)

  4. В верхней части Visual Studio щелкните зеленую стрелку.

     ![Снимок экрана пользовательского интерфейса Visual Studio с вызываемым параметром запуска.](media/adfs-msal-native-app-web-api/native16.png)

  5. На главном экране собственного приложения щелкните **Вход**.

     ![Снимок экрана: диалоговое окно "клиент списка задач".](media/adfs-msal-native-app-web-api/native17.png)

   Если вы не видите экран собственного приложения, найдите и удалите `*msalcache.bin` файлы из папки, в которой хранится репозиторий проекта в системе.

  1. Вы будете перенаправлены на страницу входа AD FS. Выполните вход.

      ![Снимок экрана со страницей входа.](media/adfs-msal-native-app-web-api/native18.png)

  2. После входа введите текст **Сборка собственного приложения в веб-API** в поле **создать элемент для выполнения**. Нажмите кнопку **Добавить элемент**.  Будет вызвана **Служба списка задач (веб-API)** и добавлен элемент в кэш.

       ![Снимок экрана: диалоговое окно клиента списка задач с новым элементом для выполнения заполнения раздела "задачи".](media/adfs-msal-native-app-web-api/native19.png)

## <a name="next-steps"></a>Дальнейшие шаги
[Подключения AD FS OpenID или потоки OAuth и сценарии использования приложений](../../overview/ad-fs-openid-connect-oauth-flows-scenarios.md)
