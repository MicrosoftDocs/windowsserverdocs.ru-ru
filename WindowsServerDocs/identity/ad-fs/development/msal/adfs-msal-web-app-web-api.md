---
title: AD FS веб-приложения MSAL (серверное приложение) вызов веб-API
description: Узнайте, как создать пользователей для входа в веб-приложение, прошедших проверку подлинности AD FS 2019.
author: billmath
ms.author: billmath
manager: daveba
ms.date: 08/09/2019
ms.topic: article
ms.prod: windows-server
ms.technology: identity-adfs
ms.openlocfilehash: 870dbb4303d216f05bc372610f3121ff08fc8c25
ms.sourcegitcommit: 6aff3d88ff22ea141a6ea6572a5ad8dd6321f199
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/27/2019
ms.locfileid: "71407847"
---
# <a name="scenario-web-app-server-app-calling-web-api"></a>Сценарий: Веб-приложение (серверное приложение), вызывающее веб-API 
>Область применения. AD FS 2019 и более поздних версий 
 
Узнайте, как создать пользователей для входа в веб-приложение, прошедших проверку подлинности AD FS 2019, и получить маркеры с помощью [библиотеки MSAL](https://github.com/AzureAD/microsoft-authentication-library-for-dotnet/wiki) для вызова веб-API.  
 
Прежде чем читать эту статью, необходимо ознакомиться с [AD FS концепциями](../ad-fs-openid-connect-oauth-concepts.md) и [потоком предоставления кода авторизации](../../overview/ad-fs-openid-connect-oauth-flows-scenarios.md#authorization-code-grant-flow) .
 
## <a name="overview"></a>Обзор 
 
![Общие сведения о вызове веб-API веб-приложения](media/adfs-msal-web-app-web-api/webapp1.png)

В этом потоке вы добавляете проверку подлинности в веб-приложение (серверное приложение), которое, следовательно, может выполнять вход пользователей и вызывать веб-API. Чтобы вызвать веб-API из веб-приложения, используйте метод получения маркера [AcquireTokenByAuthorizationCode](https://docs.microsoft.com/en-us/dotnet/api/microsoft.identity.client.acquiretokenbyauthorizationcodeparameterbuilder?view=azure-dotnet) для MSAL. Вы будете использовать поток кода авторизации, сохранив полученный токен в кэше маркеров. Затем контроллер будет получать токены автоматически из кэша при необходимости. MSAL обновляет токен, если это необходимо. 

Веб-приложения, вызывающие веб-API: 


- — Это конфиденциальные клиентские приложения. 
- Вот почему они зарегистрировали секрет (общий секрет приложения, сертификат или учетную запись AD) с AD FS. Этот секрет передается во время вызова AD FS для получения маркера.  

Чтобы лучше понять, как зарегистрировать веб-приложение в ADFS и настроить его для получения маркеров для вызова веб-API, давайте будем использовать пример, доступный [здесь](https://github.com/microsoft/adfs-sample-msal-dotnet-webapp-to-webapi) , и пошаговые инструкции по настройке регистрации приложений и кода.  

 
## <a name="pre-requisites"></a>Предварительные требования 

- Клиентские средства GitHub 
- Настройка и запуск AD FS 2019 или более поздней версии 
- Visual Studio 2013 или более поздней версии 
 
## <a name="app-registration-in-ad-fs"></a>Регистрация приложения в AD FS 
В этом разделе показано, как зарегистрировать веб-приложение как конфиденциальный клиент и веб-API в качестве проверяющей стороны (RP) в AD FS. 

  1. В AD FS управления щелкните правой кнопкой мыши **группы приложений** и выберите команду **Добавить группу приложений**.  
  2. В мастере группы приложений в поле **имя** введите **вебапптовебапи** и в разделе **клиент-сервер приложения** выберите **серверное приложение, осуществляющее доступ к шаблону веб-API** . Нажмите кнопку **Далее**.  
  
      ![Добавить группу приложений](media/adfs-msal-web-app-web-api/webapp2.png)
  
  3. Скопируйте значение **идентификатора клиента** . Он будет использоваться позже в качестве значения для **Ida: ClientID** в файле **Web. config** приложения. Введите следующую команду для **URI перенаправления:**  - https://localhost:44326. Нажмите кнопку Добавить. Нажмите кнопку **Далее**. 
  
      ![Добавить группу приложений](media/adfs-msal-web-app-web-api/webapp3.png)
  
  4. На экране Настройка учетных данных приложения установите флажок **создать общий секрет** и скопируйте секретный код. Он будет использоваться позже в качестве значения для **Ida: ClientSecret** в файле **Web. config** приложения. Нажмите кнопку **Далее**.  
  
      ![Добавить группу приложений](media/adfs-msal-web-app-web-api/webapp4.png)
  
  5. На экране Настройка веб-API введите **идентификатор:** https://webapi. Нажмите кнопку **Добавить**. Нажмите кнопку **Далее**. Это значение будет использоваться позже для **Ida: графресаурцеид** в файле **Web. config** приложения. 
  
      ![Добавить группу приложений](media/adfs-msal-web-app-web-api/webapp5.png)
  
  6. На экране применить политику управления доступом выберите **разрешение** все и нажмите кнопку **Далее**. 
  
      ![Добавить группу приложений](media/adfs-msal-web-app-web-api/webapp6.png)
  
  7. На экране Настройка разрешений приложения убедитесь, что выбраны **OpenID Connect** и **user_impersonation** , и нажмите кнопку **Далее**. 
  
      ![Добавить группу приложений](media/adfs-msal-web-app-web-api/webapp7.png)
  
  8. На экране Сводка нажмите кнопку **Далее**. 
  
  9. На экране Завершение нажмите кнопку **Закрыть**.



## <a name="code-configuration"></a>Конфигурация кода 

В этом разделе показано, как настроить веб-приложение ASP.NET для входа в систему и получить маркер для вызова веб-API. 

  1. Скачайте [Пример отсюда](https://github.com/microsoft/adfs-sample-msal-dotnet-webapp-to-webapi)   
  
  2. Открытие примера с помощью Visual Studio 
  
  3. Откройте файл Web. config. Измените следующие настройки: 
       - IDA: ClientId — введите значение **идентификатора клиента** из #3 в разделе "регистрация приложения" в AD FS выше. 
       - IDA: ClientSecret — введите значение **секрета** из #4 в разделе Регистрация приложения в AD FS выше. 
       - IDA: RedirectUri — введите значение **URI перенаправления** из #3 в разделе Регистрация приложения в AD FS выше. 
       - IDA: Authority-введите https://[имя узла AD FS]/адфс. Например, https://adfs.contoso.com/adfs 
       - IDA: Resource — введите значение **идентификатора** из #5 в разделе "регистрация приложения" в AD FS выше. 
      
          ![Добавить группу приложений](media/adfs-msal-web-app-web-api/webapp8.png)
 
 
### <a name="test-the-sample"></a>Тестирование образца 
В этом разделе показано, как проверить образец, настроенный выше. 

  1. После внесения изменений в код перестройте решение 
  
  2. В верхней части Visual Studio убедитесь, что выбран Internet Explorer, и щелкните зеленую стрелку. 
  
      ![Добавить группу приложений](media/adfs-msal-web-app-web-api/webapp9.png)

  3. На домашней странице щелкните Вход. 
  
      ![Добавить группу приложений](media/adfs-msal-web-app-web-api/webapp10.png)

  4. Вы будете перенаправлены на страницу входа AD FS. Выполните вход. 
  
      ![Добавить группу приложений](media/adfs-msal-web-app-web-api/webapp11.png)

  5. После входа щелкните маркер доступа.  
  
      ![Добавить группу приложений](media/adfs-msal-web-app-web-api/webapp12.png)

  6. Щелкнув маркер доступа, вы получите сведения о маркере доступа, вызвав веб-API. 
  
      ![Добавить группу приложений](media/adfs-msal-web-app-web-api/webapp13.png)
 
 ## <a name="next-steps"></a>Следующие шаги
[Подключения AD FS OpenID или потоки OAuth и сценарии использования приложений](../../overview/ad-fs-openid-connect-oauth-flows-scenarios.md)
 