---
title: AD FS веб-приложения MSAL (серверное приложение) вызов веб-API
description: Узнайте, как создать пользователей для входа в веб-приложение, прошедших проверку подлинности AD FS 2019.
author: billmath
ms.author: billmath
manager: daveba
ms.date: 08/09/2019
ms.topic: article
ms.openlocfilehash: e4f02400155dcb5899417b12e4c376fa3ee69fd0
ms.sourcegitcommit: fc2a7c69a74edcd79372054c4a9a24237510babd
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/22/2021
ms.locfileid: "98672956"
---
# <a name="scenario-web-app-server-app-calling-web-api"></a>Сценарий: веб-приложение (серверное приложение), вызывающее веб-API
>Применимо к: AD FS 2019 и более поздних версий

Узнайте, как создать пользователей для входа в веб-приложение, прошедших проверку подлинности AD FS 2019, и получить маркеры с помощью [библиотеки MSAL](https://github.com/AzureAD/microsoft-authentication-library-for-dotnet/wiki) для вызова веб-API.

Прежде чем читать эту статью, необходимо ознакомиться с [AD FS концепциями](../ad-fs-openid-connect-oauth-concepts.md) и [потоком предоставления кода авторизации](../../overview/ad-fs-openid-connect-oauth-flows-scenarios.md#authorization-code-grant-flow) .

## <a name="overview"></a>Обзор

![Общие сведения о вызове веб-API веб-приложения](media/adfs-msal-web-app-web-api/webapp1.png)

В этом потоке вы добавляете проверку подлинности в веб-приложение (серверное приложение), которое, следовательно, может выполнять вход пользователей и вызывать веб-API. Чтобы вызвать веб-API из веб-приложения, используйте метод получения маркера [AcquireTokenByAuthorizationCode](/dotnet/api/microsoft.identity.client.acquiretokenbyauthorizationcodeparameterbuilder) для MSAL. Вы будете использовать поток кода авторизации, сохранив полученный маркер в кэше маркеров. Затем контроллер будет автоматически получать токены из кэша при необходимости. MSAL обновляет маркер, если это необходимо.

Веб-приложения, вызывающие веб-API:


- — Это конфиденциальные клиентские приложения.
- Вот почему они зарегистрировали секрет (общий секрет приложения, сертификат или учетную запись AD) с AD FS. Этот секрет передается во время вызова AD FS для получения маркера.

Чтобы лучше понять, как зарегистрировать веб-приложение в ADFS и настроить его для получения маркеров для вызова веб-API, давайте будем использовать пример, доступный [здесь](https://github.com/microsoft/adfs-sample-msal-dotnet-webapp-to-webapi) , и пошаговые инструкции по настройке регистрации приложений и кода.


## <a name="pre-requisites"></a>Предварительные требования

- Клиентские средства GitHub
- Настройка и запуск AD FS 2019 или более поздней версии
- Visual Studio 2013 или более поздней версии

## <a name="app-registration-in-ad-fs"></a>Регистрация приложения в AD FS
В этом разделе показано, как зарегистрировать веб-приложение как конфиденциальный клиент и веб-API в качестве проверяющей стороны (RP) в AD FS.

  1. В AD FS управления щелкните правой кнопкой мыши **группы приложений** и выберите команду **Добавить группу приложений**.
  2. В мастере группы приложений в поле **имя** введите **вебапптовебапи** и в разделе **клиент-сервер приложения** выберите **серверное приложение, осуществляющее доступ к шаблону веб-API** . Нажмите кнопку **Далее**.

      ![Снимок экрана: страница приветствия мастера добавления группы приложений, показывающая серверное приложение, осуществляющее доступ к выделенному шаблону Web A P I.](media/adfs-msal-web-app-web-api/webapp2.png)

  3. Скопируйте значение **идентификатора клиента** . Он будет использоваться позже в качестве значения для **Ida: ClientID** в файле **Web.config** приложений. Введите следующую команду для **URI перенаправления:**  -  https://localhost:44326 . Нажмите кнопку "Добавить". Нажмите кнопку **Далее**.

      ![Снимок экрана: страница серверное приложение мастера добавления группы приложений, показывающая правильный идентификатор клиента и перенаправление U R I.](media/adfs-msal-web-app-web-api/webapp3.png)

  4. На экране Настройка учетных данных приложения установите флажок **создать общий секрет** и скопируйте секретный код. Он будет использоваться позже в качестве значения для **Ida: ClientSecret** в файле **Web.config** приложений. Нажмите кнопку **Далее**.

      ![Снимок экрана: страница приложения "Настройка учетных данных приложения" мастера добавления группы приложений с выбранным параметром "создать общий секрет" и созданным общим секретом.](media/adfs-msal-web-app-web-api/webapp4.png)

  5. На экране Настройка веб-API введите **идентификатор:** https://webapi . Нажмите кнопку **Добавить**. Нажмите кнопку **Далее**. Это значение будет использоваться позже для **Ida: графресаурцеид** в файле **Web.config** приложений.

      ![Снимок экрана страницы "Настройка веб-интерфейса API" мастера добавления группы приложений с правильным идентификатором.](media/adfs-msal-web-app-web-api/webapp5.png)

  6. На экране применить политику управления доступом выберите **разрешение** все и нажмите кнопку **Далее**.

      ![Снимок экрана: страница "Выбор политики управления доступом" мастера добавления группы приложений с выделенным параметром "Разрешите все".](media/adfs-msal-web-app-web-api/webapp6.png)

  7. На экране Настройка разрешений приложения убедитесь, что **OpenID Connect** и **user_impersonation** выбраны, и нажмите кнопку **Далее**.

      ![Снимок экрана: страница "Настройка разрешений приложения" мастера добавления группы приложений с выбранными параметрами олицетворения I D и пользователя.](media/adfs-msal-web-app-web-api/webapp7.png)

  8. На экране Сводка нажмите кнопку **Далее**.

  9. На экране Завершение нажмите кнопку **Закрыть**.



## <a name="code-configuration"></a>Конфигурация кода

В этом разделе показано, как настроить веб-приложение ASP.NET для входа в систему и получить маркер для вызова веб-API.

  1. Скачайте [Пример отсюда](https://github.com/microsoft/adfs-sample-msal-dotnet-webapp-to-webapi)

  2. Открытие примера с помощью Visual Studio

  3. Откройте файл web.config. Измените следующие настройки:
       - IDA: ClientId — введите значение **идентификатора клиента** из #3 в разделе "регистрация приложения" в AD FS выше.
       - IDA: ClientSecret — введите значение **секрета** из #4 в разделе Регистрация приложения в AD FS выше.
       - IDA: RedirectUri — введите значение **URI перенаправления** из #3 в разделе Регистрация приложения в AD FS выше.
       - IDA: Authority-введите https://[имя узла AD FS]/адфс. Например, так: https://adfs.contoso.com/adfs.
       - IDA: Resource — введите значение **идентификатора** из #5 в разделе "регистрация приложения" в AD FS выше.

          ![Снимок экрана файла веб-конфигурации, отображающего измененные значения.](media/adfs-msal-web-app-web-api/webapp8.png)


### <a name="test-the-sample"></a>Тестирование примера
В этом разделе показано, как проверить образец, настроенный выше.

  1. После внесения изменений в код перестройте решение

  2. В верхней части Visual Studio убедитесь, что выбран Internet Explorer, и щелкните зеленую стрелку.

      ![Снимок экрана пользовательского интерфейса Visual Studio с вызываемым параметром IIS Express (Internet Explorer).](media/adfs-msal-web-app-web-api/webapp9.png)

  3. На домашней странице щелкните Вход.

      ![Снимок экрана домашней страницы с вызываемым параметром входа.](media/adfs-msal-web-app-web-api/webapp10.png)

  4. Вы будете перенаправлены на страницу входа AD FS. Выполните вход.

      ![Снимок экрана со страницей входа.](media/adfs-msal-web-app-web-api/webapp11.png)

  5. После входа щелкните маркер доступа.

      ![Снимок экрана домашней страницы с вызываемым параметром маркера доступа.](media/adfs-msal-web-app-web-api/webapp12.png)

  6. Щелкнув маркер доступа, вы получите сведения о маркере доступа, вызвав веб-API.

      ![Снимок экрана со сведениями о маркере доступа на странице маркера доступа.](media/adfs-msal-web-app-web-api/webapp13.png)

 ## <a name="next-steps"></a>Дальнейшие шаги
[Подключения AD FS OpenID или потоки OAuth и сценарии использования приложений](../../overview/ad-fs-openid-connect-oauth-flows-scenarios.md)

