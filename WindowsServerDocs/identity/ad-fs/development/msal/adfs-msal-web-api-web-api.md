---
title: AD FS вызов веб-API MSAL веб-API (от имени сценария)
description: Узнайте, как создать веб-API, вызывающий другой веб-API.
author: billmath
ms.author: billmath
manager: daveba
ms.date: 08/09/2019
ms.topic: article
ms.prod: windows-server
ms.technology: identity-adfs
ms.openlocfilehash: 106262b63b5aad0eddb08618eb808d2d9ff5b425
ms.sourcegitcommit: b7f55949f166554614f581c9ddcef5a82fa00625
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/18/2019
ms.locfileid: "71407801"
---
# <a name="scenario-web-api-calling-web-api-on-behalf-of-scenario"></a>Сценарий: вызов веб-API через веб-API (от имени сценария) 
> Применимо к: AD FS 2019 и более поздних версий 
 
Узнайте, как создать веб-API, вызывающий другой веб-API от имени пользователя.  
 
Прежде чем читать эту статью, необходимо ознакомиться с [основными понятиями AD FS](../ad-fs-openid-connect-oauth-concepts.md) и [Behalf_Of Flow](../../overview/ad-fs-openid-connect-oauth-flows-scenarios.md#on-behalf-of-flow) .

## <a name="overview"></a>Обзор 


- Клиент (веб-приложение), не представленный на приведенной ниже схеме, вызывает защищенный веб-API и предоставляет токен носителя JWT в своем HTTP-заголовке "Authorization". 
- Защищенный веб-API проверяет маркер и использует  method [АККУИРЕТОКЕНОНБЕХАЛФОФ](https://docs.microsoft.com/en-us/dotnet/api/microsoft.identitymodel.clients.activedirectory.authenticationcontext.acquiretokenasync?view=azure-dotnet#Microsoft_IdentityModel_Clients_ActiveDirectory_AuthenticationContext_AcquireTokenAsync_System_String_Microsoft_IdentityModel_Clients_ActiveDirectory_ClientCredential_Microsoft_IdentityModel_Clients_ActiveDirectory_UserAssertion_) MSAL для запроса (от AD FS) другого маркера, чтобы он мог сам вызывать второй веб-API (именуемый нисходящим веб-API) от имени пользователя. 
- Защищенный веб-API использует этот токен для вызова подчиненного API. Он также может вызывать Аккуиретокенсилентлатер для запроса маркеров для других нисходящих API (но по-прежнему от имени одного и того же пользователя). AcquireTokenSilent обновляет токен при необходимости.  
 
     ![обзор](media/adfs-msal-web-api-web-api/webapi1.png)
 
Чтобы лучше понять, как настроить сценарий проверки подлинности от имени в ADFS, мы будем использовать пример, доступный [здесь](https://github.com/microsoft/adfs-sample-msal-dotnet-webapi-to-webapi-onbehalfof) , и пошаговые инструкции по настройке регистрации и кода приложения.  
 
## <a name="pre-requisites"></a>Предварительные требования 

- Клиентские средства GitHub 
- Настройка и запуск AD FS 2019 или более поздней версии 
- Visual Studio 2013 или более поздней версии 
 
## <a name="app-registration-in-ad-fs"></a>Регистрация приложения в AD FS 

В этом разделе показано, как зарегистрировать собственное приложение в качестве общедоступного клиента и веб-API в качестве проверяющих сторон (RP) в AD FS 

  1. В AD FS управления щелкните правой кнопкой мыши **группы приложений** и выберите команду **Добавить группу приложений**.  
  
  2. В мастере группы приложений в поле **имя** введите **вебапитовебапи** и в разделе **клиент-сервер приложения** выберите **собственное приложение, осуществляющее доступ к шаблону веб-API** . Нажмите **Далее**.

      ![Регистрация приложения](media/adfs-msal-web-api-web-api/webapi2.png)

  3. Скопируйте значение **идентификатора клиента** . Он будет использоваться позже в качестве значения **ClientID** в файле **app. config** приложения. Введите следующие сведения для **URI перенаправления:**  -  https://ToDoListClient. Нажмите **Добавить**. Нажмите **Далее**. 
  
      ![Регистрация приложения](media/adfs-msal-web-api-web-api/webapi3.png)
  
  4. На экране Настройка веб-API введите **идентификатор:** https://localhost:44321/. Нажмите **Добавить**. Нажмите **Далее**. Это значение будет использоваться позже в файлах **app. config** и **Web. config** приложения.  
 
      ![Регистрация приложения](media/adfs-msal-web-api-web-api/webapi4.png)

  5. На экране применить политику управления доступом выберите **разрешение все** и нажмите кнопку **Далее**. 
  
      ![Регистрация приложения](media/adfs-msal-web-api-web-api/webapi5.png)  

  6. На экране Настройка разрешений приложения выберите **OpenID Connect** и **user_impersonation**. Нажмите **Далее**.  
  
      ![Регистрация приложения](media/adfs-msal-web-api-web-api/webapi6.png)  

  7. На экране Сводка нажмите кнопку **Далее**. 

  8. На экране Завершение нажмите кнопку **Закрыть**. 


  9. В AD FS "Управление" щелкните **группы приложений** и выберите **вебапитовебапи** Application Group (Группа приложений). Щелкните правой кнопкой мыши и выберите **Свойства**. 
  
      ![Регистрация приложения](media/adfs-msal-web-api-web-api/webapi7.png)  

  10. На экране свойств Вебапитовебапи нажмите кнопку **Добавить приложение...** . 
  
      ![REG приложения](media/adfs-msal-web-api-web-api/webapi8.png)

  11. В разделе автономные приложения выберите **серверное приложение**.  
  
      ![REG приложения](media/adfs-msal-web-api-web-api/webapi9.png)

  12. На экране серверного приложения добавьте https://localhost:44321/ в качестве **идентификатора клиента** и **URI перенаправления**. 
  
      ![REG приложения](media/adfs-msal-web-api-web-api/webapi10.png)

  13. На экране Настройка учетных данных приложения выберите **создать общий секрет**. Скопируйте секрет для последующего использования.
  
      ![REG приложения](media/adfs-msal-web-api-web-api/webapi11.png)

  14. На экране Сводка нажмите кнопку **Далее**. 

  15. На экране Завершение нажмите кнопку **Закрыть**. 

  16. В AD FS "Управление" щелкните **группы приложений** и выберите **вебапитовебапи** Application Group (Группа приложений). Щелкните правой кнопкой мыши и выберите **Свойства**. 
  
      ![REG приложения](media/adfs-msal-web-api-web-api/webapi12.png)

  17. На экране свойств Вебапитовебапи нажмите кнопку **Добавить приложение...** . 
  
      ![REG приложения](media/adfs-msal-web-api-web-api/webapi13.png)

  18. В разделе автономные приложения выберите **веб-API**. 
  
      ![REG приложения](media/adfs-msal-web-api-web-api/webapi14.png)  

  19. На странице Настройка веб-API добавьте в качестве **идентификатора**https://localhost:44300.  
  
      ![REG приложения](media/adfs-msal-web-api-web-api/webapi15.png)

  20. На экране применить политику управления доступом выберите **разрешение все** и нажмите кнопку **Далее**. 
  
      ![REG приложения](media/adfs-msal-web-api-web-api/webapi16.png)

  21. На экране Настройка разрешений приложения нажмите кнопку **Далее**. 
  
      ![REG приложения](media/adfs-msal-web-api-web-api/webapi17.png)

  22. На экране Сводка нажмите кнопку **Далее**.

  23. На экране Завершение нажмите кнопку **Закрыть**.  

  24. Нажмите кнопку ОК в Вебапитовебапи — экран свойств веб-API 2  

  25. На экране свойства Вебапитовебапи выберите **вебапитовебапи — веб-API** и нажмите кнопку **изменить.** ...  
  
      ![REG приложения](media/adfs-msal-web-api-web-api/webapi18.png)

  26. На странице свойства Вебапитовебапи — веб-API выберите вкладку **правила преобразования выдачи** и нажмите кнопку **Добавить правило...** . 
  
      ![REG приложения](media/adfs-msal-web-api-web-api/webapi19.png)

  27. В мастере добавления правила преобразования утверждений выберите **Отправить утверждения с помощью настраиваемого правила** из раскрывающегося списка и нажмите кнопку **Далее**. 
  
      ![REG приложения](media/adfs-msal-web-api-web-api/webapi20.png)

  28. Введите **пассаллклаимс** в поле **имя правила утверждений:** Field и **x: [] = > Issue (заявка = x);** правило утверждения в настраиваемом правиле: поле и нажмите кнопку Готово.  
   
      ![REG приложения](media/adfs-msal-web-api-web-api/webapi21.png)

  29. Нажмите кнопку ОК в Вебапитовебапи — экран свойств веб-API

  30. На экране свойства Вебапитовебапи выберите выбрать Вебапитовебапи — Web API 2 и щелкните Изменить...</br> 
   ![App reg ](media/adfs-msal-web-api-web-api/webapi22.png)

  31. На странице свойства Вебапитовебапи — веб-API 2 Выберите вкладку Правила преобразования выдачи и нажмите кнопку Добавить правило... 

  32. В мастере добавления правила преобразования утверждений выберите Отправить утверждения с помощью настраиваемого правила из допдовн и нажмите кнопку Далее ![App reg ](media/adfs-msal-web-api-web-api/webapi23.png)

  33. Введите Пассаллклаимс в поле Имя правила утверждений: field и **x: [] = > Issue (заявка = x);** правило утверждения в **настраиваемом правиле:** поле и нажмите кнопку **Готово**.  
   
      ![REG приложения](media/adfs-msal-web-api-web-api/webapi24.png)

  34.  Нажмите кнопку ОК в Вебапитовебапи — Web API 2 (Свойства экрана), а затем на экране свойства Вебапитовебапи.  
 

## <a name="code-configuration"></a>Конфигурация кода 

В этом разделе показано, как настроить веб-API для вызова другого веб-API. 

  1. Скачайте [Пример отсюда](https://github.com/microsoft/adfs-sample-msal-dotnet-webapi-to-webapi-onbehalfof)  
  
  2. Открытие примера с помощью Visual Studio 
  
  3. Откройте файл App. config. Измените следующие настройки: 
       - IDA: Authority-введите https://[имя узла AD FS]/адфс/
       - IDA: ClientId — введите значение из #3 в разделе "регистрация приложения" в AD FS выше. 
       - IDA: RedirectUri — введите значение из #3 в разделе Регистрация приложения в AD FS выше. 
       - TODO: Тодолистресаурцеид — введите значение идентификатора из #4 в разделе "регистрация приложения" в AD FS выше. 
       - IDA: TODO: Тодолистбасеаддресс — введите значение идентификатора из #4 в разделе "регистрация приложения" в AD FS выше. 
      
            ![REG приложения](media/adfs-msal-web-api-web-api/webapi25.png)

  4. Откройте файл Web. config в разделе ToDoListService. Измените следующие настройки: 
       - IDA: аудитория. Введите значение идентификатора клиента из #12 в разделе "регистрация приложения" в AD FS выше.
       - IDA: ClientId — введите значение идентификатора клиента из #12 в разделе "регистрация приложения" в AD FS выше. 
       - IDA: ClientSecret — введите общий секрет, скопированный из #13 в разделе "регистрация приложения" в AD FS выше.
       - IDA: RedirectUri — введите значение RedirectUri из #12 в разделе Регистрация приложения в AD FS выше. 
       - IDA: Адфсметадатаендпоинт-введите https://[имя узла AD FS]/FederationMetadata/2007-06/FederationMetadata.XML 
       - IDA: Обовебапибасе — введите значение идентификатора из #19 в разделе Регистрация приложения в AD FS выше. 
       - IDA: Authority-введите https://[имя узла AD FS]/адфс 
  
          ![REG приложения](media/adfs-msal-web-api-web-api/webapi26.png) 

 5. Откройте файл Web. config в разделе Вебапиобо. Измените следующие настройки: 
       - IDA: Адфсметадатаендпоинт-введите https://[имя узла AD FS]/FederationMetadata/2007-06/FederationMetadata.XML 
       - IDA: аудитория. Введите значение идентификатора клиента из #12 в разделе "регистрация приложения" в AD FS выше. 
 
          ![REG приложения](media/adfs-msal-web-api-web-api/webapi27.png)
 
## <a name="test-the-sample"></a>Тестирование образца 

В этом разделе показано, как проверить образец, настроенный выше. 

После внесения изменений в код перестройте решение 
 
  1. В Visual Studio щелкните правой кнопкой мыши решение и выберите команду **задать запускаемые проекты...** 
      
      ![REG приложения](media/adfs-msal-web-api-web-api/webapi28.png)

  2. На странице Свойства убедитесь, что для параметра **действие** задано значение **Запуск** для каждого из проектов, кроме тодолистспа.  
  
      ![REG приложения](media/adfs-msal-web-api-web-api/webapi29.png)
  
  3. В верхней части Visual Studio щелкните зеленую стрелку.  
  
      ![REG приложения](media/adfs-msal-web-api-web-api/webapi30.png)

  4. На главном экране собственного приложения щелкните **Вход**. 
  
      ![REG приложения](media/adfs-msal-web-api-web-api/webapi31.png)

     Если вы не видите экран собственного приложения, найдите и удалите файлы * мсалкаче. bin из папки, в которой хранится репозиторий проекта в системе. 
  
  5. Вы будете перенаправлены на страницу входа AD FS. Выполните вход. 
  
      ![REG приложения](media/adfs-msal-web-api-web-api/webapi32.png)

  6. После входа введите текст веб-API в вызов веб-API в поле **создать элемент для выполнения**. Нажмите кнопку **Добавить элемент**.  Это вызовет веб-API (To Do List Service), который затем вызывает веб-API 2 (Вебапиобо) и добавляет элемент в кэш.  
 
      ![REG приложения](media/adfs-msal-web-api-web-api/webapi33.png)
 
 ## <a name="next-steps"></a>Дальнейшие действия
[Подключения AD FS OpenID или потоки OAuth и сценарии использования приложений](../../overview/ad-fs-openid-connect-oauth-flows-scenarios.md)
 
 
