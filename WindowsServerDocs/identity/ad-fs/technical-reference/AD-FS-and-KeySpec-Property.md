---
title: Active Directory Federation Services и сертификат свойство Спецификация ключа сведения
description: ''
author: billmath
manager: femila
ms.date: 05/31/2017
ms.topic: article
ms.prod: windows-server-threshold
ms.assetid: a5307da5-02ff-4c31-80f0-47cb17a87272
ms.technology: identity-adfs
ms.author: billmath
ms.openlocfilehash: 32b0d08f678e9e612bb0ce9cc38d254564bd9b2f
ms.sourcegitcommit: eaf071249b6eb6b1a758b38579a2d87710abfb54
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/31/2019
ms.locfileid: "66444093"
---
# <a name="ad-fs-and-certificate-keyspec-property-information"></a>Службы федерации Active Directory и сертификат свойства KeySpec сведения
Спецификация ключа («KeySpec») — это свойство, связанное с сертификат и ключ. Он указывает, используется ли закрытый ключ, связанный с сертификатом для подписи, шифрования или оба.   

Неверное значение KeySpec могут вызвать ошибки AD FS и прокси веб-приложения таким образом.


- Не удалось установить подключение SSL/TLS к AD FS или прокси веб-приложения, без AD FS событий в журнал (хотя могут регистрироваться события SChannel 36888 и 36874)
- Сбой входа в AD FS или WAP проверки подлинности на основе страницы, форм с помощью отсутствует сообщение об ошибке, отображаемое на странице.

Возможны следующие значения в журнале событий.

    Log Name:      AD FS Tracing/Debug
    Source:        AD FS Tracing
    Date:          2/12/2015 9:03:08 AM
    Event ID:      67
    Task Category: None
    Level:         Error
    Keywords:      ADFSProtocol
    User:          S-1-5-21-3723329422-3858836549-556620232-1580884
    Computer:      ADFS1.contoso.com
    Description:
    Ignore corrupted SSO cookie.

## <a name="what-causes-the-problem"></a>Что вызывает проблемы
Свойство KeySpec определяет, как можно использовать созданные или полученные по Microsoft CryptoAPI (CAPI), из Microsoft прежних версий хранилища поставщика шифрования (CSP), ключ.

Значение KeySpec **1**, или **AT_KEYEXCHANGE**, может использоваться для подписывания и шифрования.  Значение **2**, или **AT_SIGNATURE, которое**, используется только для подписи.

Наиболее распространенные неправильная конфигурация KeySpec используется значение 2 для сертификат, отличный от сертификата для подписи маркера.  

Для сертификатов, ключи которых были созданы с помощью поставщиков криптографии следующего поколения (CNG) не существует понятия ключевых спецификации и KeySpec значение всегда равно нулю.

Узнайте, как проверить допустимость значения KeySpec ниже. 

### <a name="example"></a>Пример
Пример устаревшего CSP — Microsoft Enhanced Cryptographic Provider. 

Формат объекта blob ключа Microsoft RSA CSP включает идентификатор алгоритма, либо **CALG_RSA_KEYX** или **CALG_RSA_SIGN**, соответственно, для обслуживания запросов либо <strong>AT_KEYEXCHANGE ** или ** AT_ ПОДПИСЬ</strong> ключи.

Идентификаторы ключей алгоритм RSA сопоставляются KeySpec значения следующим образом

| Поставщик поддерживается алгоритм| Значение ключа спецификации для вызовов CAPI |
| --- | --- |
|CALG_RSA_KEYX: Ключ RSA, который может использоваться для подписывания и расшифровки| AT_KEYEXCHANGE (или KeySpec = 1)|
CALG_RSA_SIGN: Подпись RSA только ключа |AT_SIGNATURE, которое (или KeySpec = 2)|

## <a name="keyspec-values-and-associated-meanings"></a>Значения KeySpec и связанные значения
Ниже перечислены значения различных значений KeySpec.

|Значение KeySpec|Означает, что|Рекомендации по использованию AD FS|
| --- | --- | --- |
|0|Сертификат является сертификатом CNG|Только SSL-сертификата|
|1|Для предыдущих версий cert CAPI (не CNG) ключ может использоваться для подписывания и расшифровки|    SSL-сертификаты для подписи маркеров, маркера расшифровки, службы обмена данными|
|2|Для предыдущих версий cert CAPI (не CNG) ключ может использоваться только для подписи|не рекомендуется|

## <a name="how-to-check-the-keyspec-value-for-your-certificates--keys"></a>Как проверить значение KeySpec для сертификатов и ключей
Чтобы просмотреть значение сертификаты, можно использовать **certutil** средство командной строки.  

Ниже приведен пример: **certutil – v – хранить Мои**.  Это будет вывести на экран сведения о сертификате.

![KeySpec cert](media/AD-FS-and-KeySpec-Property/keyspec1.png)

В разделе CERT_KEY_PROV_INFO_PROP_ID искать две вещи:


1. **ProviderType:** Эта ошибка означает ли сертификат использует прежних версий хранилища поставщика шифрования (CSP) или поставщик хранилища ключей на основе на более новые сертификата следующего поколения (CNG) API-интерфейсы.  Любое ненулевое значение указывает поставщик прежних версий.
2. **KeySpec:** Ниже приведены допустимые значения KeySpec сертификат AD FS:

   Устаревший поставщик CSP (ProviderType не равно 0):

   |AD FS по назначению|Допустимые KeySpec значения|
   | --- | --- |
   |Взаимодействие служб|1|
   |Расшифровки маркера|1|
   |Подписывание маркеров|1 и 2|
   |SSL|1|

   CNG provider (ProviderType = 0):

   |AD FS по назначению|Допустимые KeySpec значения|
   | --- | --- |   
   |SSL|0|

## <a name="how-to-change-the-keyspec-for-your-certificate-to-a-supported-value"></a>Как изменить keyspec сертификата на поддерживаемое значение
Изменение значения KeySpec не требует сертификат повторно создать или повторно выданный центром сертификации.  KeySpec может быть изменен путем повторного импорта полный сертификат и закрытый ключ из PFX-файла в хранилище сертификатов, выполнив следующие действия:


1. Во-первых Проверьте и запишите закрытого ключа разрешения для существующего сертификата, таким образом, чтобы их можно повторно настроить при необходимости после повторного импорта.
2. Экспортируйте сертификат, включая закрытый ключ в PFX-файл.
3. Выполните следующие действия для каждого сервера AD FS и WAP
    1. Удалить сертификат (из AD FS и WAP-сервера)
    2. Откройте командную строку PowerShell с повышенными привилегиями и импортируйте PFX-файл на каждом сервере AD FS и WAP с помощью в представленном ниже синтаксисе командлета, указав значение AT_KEYEXCHANGE (который работает для всех целей сертификата AD FS):
        1. C:\>certutil – importpfx certfile.pfx AT_KEYEXCHANGE
        2. Введите пароль PFX
    3. После выполнения указанных выше, выполните следующие
        1. Проверьте разрешения закрытого ключа
        2. Перезапустите службу AD FS или wap





