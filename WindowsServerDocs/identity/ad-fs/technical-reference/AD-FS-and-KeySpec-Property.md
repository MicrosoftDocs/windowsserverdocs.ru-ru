---
title: "Службы Active Directory федерации и сертификат ключа спецификации свойства сведения"
description: 
author: billmath
manager: femila
ms.date: 05/31/2017
ms.topic: article
ms.prod: windows-server-threshold
ms.assetid: a5307da5-02ff-4c31-80f0-47cb17a87272
ms.technology: identity-adfs
ms.author: billmath
ms.openlocfilehash: db58fcce054f34c4b0a3f6725456badae9fd0468
ms.sourcegitcommit: 70c1b6cedad55b9c7d2068c9aa4891c6c533ee4c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/03/2017
---
# <a name="ad-fs-and-certificate-keyspec-property-information"></a>Службы федерации Active Directory и сертификат KeySpec свойства сведения
Спецификация ключа («KeySpec») — это свойство, связанное с помощью сертификата и ключа. Он указывает, можно ли использовать закрытый ключ, связанный с сертификатом для подписи, шифрования или оба.   

Неправильное значение KeySpec может вызвать ошибки AD FS и веб-приложения прокси таких как:


- Не удалось установить соединение SSL/TLS для AD FS или прокси веб-приложения с не имеет AD FS событий (хотя может быть занесено события SChannel 36888 и 36874)
- Сбой входа систему с AD FS или WAP страницы проверки подлинности на основе форм с сообщение об ошибке, не показанные на этой странице.

Могут отображаться следующие действия в журнале событий:

    Log Name:      AD FS Tracing/Debug
    Source:        AD FS Tracing
    Date:          2/12/2015 9:03:08 AM
    Event ID:      67
    Task Category: None
    Level:         Error
    Keywords:      ADFSProtocol
    User:          S-1-5-21-3723329422-3858836549-556620232-1580884
    Computer:      ADFS1.contoso.com
    Description:
    Ignore corrupted SSO cookie.

## <a name="what-causes-the-problem"></a>Причины проблемы
Свойство KeySpec определяет, как ключ создан или получить путем Microsoft CryptoAPI (CAPI), из Microsoft устаревших шифрования хранилища поставщика (CSP), можно использовать.

Значение KeySpec **1**, или **AT_KEYEXCHANGE**, может использоваться для подписывания и шифрования.  Значение **2**, или **AT_SIGNATURE, которое**, используется только для подписи.

Наиболее распространенные неправильная конфигурация KeySpec использует значение 2 для сертификата, отличных от сертификат для подписи маркера.  

Сертификаты, ключи которых были созданы с использованием поставщиков криптографии следующего поколения (CNG) отсутствует концепция Спецификация ключа и значения KeySpec всегда будут равны нулю.

Узнайте, как проверить наличие допустимого значения KeySpec ниже. 

### <a name="example"></a>Пример
Пример устаревших CSP — Microsoft Enhanced Cryptographic Provider. 

Формат ключа RSA Microsoft CSP включает идентификатор алгоритма либо **CALG_RSA_KEYX** или **CALG_RSA_SIGN**, соответственно, для запросов на обслуживание либо ** AT_KEYEXCHANGE ** или **AT_SIGNATURE, которое** ключи.
  
Идентификаторы ключ имеет алгоритм RSA сопоставляют KeySpec следующим образом

| Поддерживается поставщик алгоритма| Значение ключа спецификации для вызовов CAPI |
| --- | --- |
|CALG_RSA_KEYX: Ключ RSA, который может использоваться для подписи и расшифровки| AT_KEYEXCHANGE (или KeySpec = 1)|
CALG_RSA_SIGN: Только ключами подписи RSA |AT_SIGNATURE, которое (или KeySpec = 2)|

## <a name="keyspec-values-and-associated-meanings"></a>Значения KeySpec и связанные значения
Ниже приведены значения различных значений KeySpec.

|Значение KeySpec|Означает|Рекомендации по использованию AD FS|
| --- | --- | --- |
|0|Сертификат является CNG cert|SSL-сертификат только|
|1|Для старых cert CAPI (не CNG) ключ может использоваться для подписи и расшифровки|    SSL-сертификатов для подписи маркеров, маркера расшифровки, служба обмена данными|
|2|Для старых cert CAPI (не CNG) ключ можно использовать только для подписи|не рекомендуется|

## <a name="how-to-check-the-keyspec-value-for-your-certificates--keys"></a>Как проверить значение KeySpec сертификаты или ключи
Чтобы просмотреть сертификаты значение, можно использовать **certutil** средство командной строки.  

Ниже приведен пример: **certutil – v – сохранить Мои**.  Это будет дамп сведений о сертификате на экране.

![KeySpec сертификата](media/AD-FS-and-KeySpec-Property/keyspec1.png)

В разделе CERT_KEY_PROV_INFO_PROP_ID Найдите следующее:


1. **ProviderType:** это обозначает ли сертификат использует устаревшие хранилища поставщика шифрования (CSP) или поставщик хранилища ключей на основе на новых сертификатов следующего поколения (CNG) API-интерфейсы.  Любое значение, отличное от нуля указывает устаревших поставщика.
2.  **KeySpec:** ниже указаны допустимые значения KeySpec сертификат AD FS:

    Устаревший поставщика CSP (ProviderType не равно 0):
    
    |Назначение AD FS сертификата|Допустимые KeySpec значения|
    | --- | --- |
    |Взаимодействие службы|1|
    |Для расшифровки маркера|1|
    |Сертификат для подписи маркера|1 и 2|
    |ПРОТОКОЛ SSL|1|

    Поставщика CNG (ProviderType = 0):
    |Назначение AD FS сертификата|Допустимые KeySpec значения|
    | --- | --- |   
    |ПРОТОКОЛ SSL|0|

## <a name="how-to-change-the-keyspec-for-your-certificate-to-a-supported-value"></a>Как изменить значение, поддерживаемое keyspec для сертификата
Изменение значения KeySpec не требуется сертификат повторно создано или заново выданный центром сертификации.  KeySpec может быть изменено при повторном импорте полный сертификата и закрытого ключа в PFX-файла в хранилище сертификатов, как описано ниже:


1. Во-первых Проверьте и запишите закрытого ключа разрешения для существующего сертификата, чтобы их можно перенастроить при необходимости после повторного импорта.
2. Экспорт сертификата, в том числе закрытого ключа в PFX-файле.
3. Выполните следующие действия для каждого сервера AD FS и WAP
    1. Удаление сертификата (из службы федерации Active Directory или сервера WAP)
    2. Откройте командную строку PowerShell с повышенными правами и импортируйте PFX-файл на каждом сервере WAP и AD FS с помощью ниже синтаксис командлета, указав значение AT_KEYEXCHANGE (который работает для всех целей сертификат AD FS):
        1. C:\ > certutil – importpfx certfile.pfx AT_KEYEXCHANGE
        2. Введите пароль для PFX-ФАЙЛ
    3. После выполнения перечисленных выше, выполните указанные ниже
        1. Проверьте разрешения закрытого ключа
        2. Перезапустите службу служб федерации Active Directory или wap





