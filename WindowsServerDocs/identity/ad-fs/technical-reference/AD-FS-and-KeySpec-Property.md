---
title: Сведения о свойствах службы федерации Active Directory (AD FS) и спецификации ключа сертификата
description: ''
author: billmath
manager: femila
ms.date: 05/31/2017
ms.topic: article
ms.prod: windows-server
ms.assetid: a5307da5-02ff-4c31-80f0-47cb17a87272
ms.technology: identity-adfs
ms.author: billmath
ms.openlocfilehash: 51c9828cfe494c68422f4985e5b17113020c8414
ms.sourcegitcommit: 6aff3d88ff22ea141a6ea6572a5ad8dd6321f199
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/27/2019
ms.locfileid: "71407412"
---
# <a name="ad-fs-and-certificate-keyspec-property-information"></a>Сведения о свойствах AD FS и KeySpec сертификата
Спецификация ключа ("KeySpec") — это свойство, связанное с сертификатом и ключом. Он указывает, можно ли использовать закрытый ключ, связанный с сертификатом, для подписывания, шифрования или и того, и другого.   

Неверное значение KeySpec может привести к AD FS и ошибкам прокси-сервера, таким как:


- Не удалось установить подключение SSL/TLS к AD FS или прокси веб-приложения без записи событий AD FS (хотя могут регистрироваться события SChannel 36888 и 36874)
- Сбой входа на AD FS или на странице проверки подлинности на основе форм WAP без сообщения об ошибке на странице.

В журнале событий может появиться следующее:

    Log Name:      AD FS Tracing/Debug
    Source:        AD FS Tracing
    Date:          2/12/2015 9:03:08 AM
    Event ID:      67
    Task Category: None
    Level:         Error
    Keywords:      ADFSProtocol
    User:          S-1-5-21-3723329422-3858836549-556620232-1580884
    Computer:      ADFS1.contoso.com
    Description:
    Ignore corrupted SSO cookie.

## <a name="what-causes-the-problem"></a>Что вызывает проблему
Свойство KeySpec определяет способ использования ключа, созданного или получаемого с помощью Microsoft CryptoAPI (CAPI), из устаревшего поставщика криптографических хранилищ Майкрософт (CSP).

Значение KeySpec, равное **1**или **AT_KEYEXCHANGE**, может использоваться для подписывания и шифрования.  Значение **2**или **AT_SIGNATURE**используется только для подписывания.

Наиболее распространенная неправильная конфигурация KeySpec использует значение 2 для сертификата, отличного от сертификата подписи маркера.  

Для сертификатов, ключи которых были созданы с помощью поставщиков криптографии следующего поколения (CNG), не существует концепции ключа, и значение KeySpec всегда будет равно нулю.

См. раздел Проверка допустимости значения KeySpec ниже. 

### <a name="example"></a>Пример
Примером устаревшего CSP является поставщик усовершенствованных служб шифрования Майкрософт. 

Формат больших двоичных объектов Microsoft RSA CSP включает идентификатор алгоритма ( **CALG_RSA_KEYX** или **CALG_RSA_SIGN**), соответственно, для запросов на обслуживание для <strong>AT_KEYEXCHANGE * * или * * AT_SIGNATURE</strong> Keys.

Идентификаторы алгоритма ключа RSA сопоставляются со значениями KeySpec следующим образом.

| Алгоритм, поддерживаемый поставщиком| Значение спецификации ключа для вызовов CAPI |
| --- | --- |
|CALG_RSA_KEYX : Ключ RSA, который можно использовать для подписывания и расшифровки| AT_KEYEXCHANGE (или KeySpec = 1)|
CALG_RSA_SIGN : Ключ только для подписи RSA |AT_SIGNATURE (или KeySpec = 2)|

## <a name="keyspec-values-and-associated-meanings"></a>Значения KeySpec и связанные с ними обозначения
Ниже приведены значения различных значений KeySpec.

|Значение keySpec|Понимает|Рекомендуемый AD FS использования|
| --- | --- | --- |
|0|Сертификат — это сертификат CNG.|Только SSL-сертификат|
|1|Для устаревшего сертификата CAPI (не CNG) ключ можно использовать для подписывания и расшифровки.|    SSL, Подписывание маркеров, расшифровка маркеров, сертификаты связи служб|
|2|Для устаревшего сертификата CAPI (не CNG) ключ можно использовать только для подписывания|Не рекомендуется|

## <a name="how-to-check-the-keyspec-value-for-your-certificates--keys"></a>Как проверить значение KeySpec для сертификатов и ключей
Чтобы просмотреть значение сертификата, можно использовать программу командной строки **certutil** .  

Ниже приведен пример: **certutil – v — Store My**.  При этом сведения о сертификате будут выгружаться на экран.

![Сертификат keySpec](media/AD-FS-and-KeySpec-Property/keyspec1.png)

В разделе CERT_KEY_PROV_INFO_PROP_ID найдите две вещи:


1. **ProviderType:** указывает, использует ли сертификат поставщик хранилища ключей (CSP) или поставщик хранения ключа на основе API нового сертификата следующего поколения (CNG).  Любое ненулевое значение указывает на устаревший поставщик.
2. **KeySpec** Ниже приведены допустимые значения KeySpec для сертификата AD FS.

   Устаревший поставщик CSP (ProviderType не равен 0):

   |Назначение сертификата AD FS|Допустимые значения KeySpec|
   | --- | --- |
   |Взаимодействие служб|1|
   |Расшифровка маркера|1|
   |Подпись токена|1 и 2|
   |SSL|1|

   Поставщик CNG (ProviderType = 0):

   |Назначение сертификата AD FS|Допустимые значения KeySpec|
   | --- | --- |   
   |SSL|0|

## <a name="how-to-change-the-keyspec-for-your-certificate-to-a-supported-value"></a>Изменение keySpec для сертификата на поддерживаемое значение
Изменение значения KeySpec не требует повторного создания или повторной выдачи сертификата центром сертификации.  KeySpec можно изменить, повторно импортировав полный сертификат и закрытый ключ из PFX-файла в хранилище сертификатов, выполнив приведенные ниже действия.


1. Сначала проверьте и запишите разрешения закрытого ключа для существующего сертификата, чтобы после повторного импорта их можно было повторно настроить.
2. Экспортируйте сертификат, включая закрытый ключ, в PFX-файл.
3. Выполните следующие действия для каждого AD FS и сервера WAP.
    1. Удалите сертификат (с сервера AD FS или WAP).
    2. Откройте командную строку PowerShell с повышенными привилегиями и импортируйте PFX-файл на каждом AD FS и WAP-сервере с помощью приведенного ниже синтаксиса командлета, указав значение AT_KEYEXCHANGE (которое работает для всех AD FSных сертификатов):
        1. C: \>certutil – importpfx CertFile. pfx AT_KEYEXCHANGE
        2. Введите пароль PFX
    3. После выполнения приведенных выше действий выполните следующие действия.
        1. Проверка разрешений на закрытый ключ
        2. перезапуск службы ADFS или WAP





