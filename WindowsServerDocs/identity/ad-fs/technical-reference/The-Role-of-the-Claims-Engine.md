---
ms.assetid: 8b15d44e-e4e6-4510-aa91-cc7ec7161b0a
title: "Роль механизма утверждений"
description: 
author: billmath
ms.author: billmath
manager: femila
ms.date: 05/31/2017
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: identity-adfs
ms.openlocfilehash: 930b6f8034f17d8902104419042f944b82e90b4f
ms.sourcegitcommit: 70c1b6cedad55b9c7d2068c9aa4891c6c533ee4c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/03/2017
---
>Область применения: Windows Server 2016, Windows Server 2012 R2, Windows Server 2012

# <a name="the-role-of-the-claims-engine"></a>Роль механизма утверждений
На самом высоком уровне модуль утверждений в \(AD FS\) служб федерации Active Directory представляет собой модуль на основе rule\, предназначенный для предоставления и обработки запросов утверждений для службы федерации. Модуль утверждений — единственный компонент службы федерации, отвечающий за применение каждого набора правил для всех федеративных отношений доверия, настроенные и передачу результата в конвейер утверждений.  
  
Когда конвейер утверждений — это скорее логическая сущность из end\ заполнением части процесса передачи утверждений, правила утверждений являются реальным административным элементом, который можно использовать для настройки потока утверждений в процессе выполнения правил утверждений. Дополнительные сведения о процессе работы конвейера см. в разделе [The Role of the Claims Pipeline](The-Role-of-the-Claims-Pipeline.md).  
  
Как показано на следующем рисунке, процесс принятия входящих утверждений \(acceptance rules\), авторизации утверждений \(authorization rules\) инициаторов запросов и выпуска исходящих утверждений, что \(issuance rules\) посредством правил утверждений для всех федеративных отношений доверия в организации выполняется модулем утверждений.  
  
![Роли AD FS](media/adfs2_enginepipeline.gif)  
  
## <a name="claim-rules-execution-process"></a>Процесс выполнения правил утверждений  
При настройке отношения доверия с поставщиком утверждений или проверяющей стороной отношение доверия в организации с учетом правил утверждений, set\(s\) правил утверждений для этого доверия act в роли привратника для входящих утверждений, предписывая модулю утверждений применить необходимую логику в правилах утверждений, чтобы определить, следует ли выпустить какие-либо утверждения и какие утверждения выдавать.  
  
В следующем подразделе описывается каждое из действий, которое выполняется модулем во время поток утверждений через процесс выполнения правил утверждений. Каждое из действий производится на каждом этапе, описанные в процессе работы конвейера утверждений. Эти действия включают:  
  
-   Шаг 1 – инициализация  
  
-   Шаг 2 – выполнение  
  
-   Шаг 3 – результат выполнения  
  
Дополнительные сведения о процессе работы конвейера см. в разделе [The Role of the Claims Pipeline](The-Role-of-the-Claims-Pipeline.md).  
  
### <a name="step-1--initialization"></a>Шаг 1 – инициализация  
На первом шаге процесса выполнения правил утверждений модуль утверждений принимает входящие утверждения, добавляя их в *входной набор утверждений*. Входной набор утверждений аналогичен кэшу в памяти, используемому для временного хранения данных только при условии процессу не потребуется сделать доступными для извлечения данных. Во входной набор утверждений данные удаляются после завершения выполнения правил.  
  
#### <a name="adding-a-claim-to-the-input-claim-set-for-a-rule-set"></a>Добавление утверждения во входной набор утверждений для набора правил  
Входной набор утверждений создается модулем утверждений, когда ему требуется временно сохранить данные утверждений в памяти, пока он обрабатывает логику, связанную с набором правил утверждений. Модуль утверждений копирует все входящие утверждения набор входящих утверждений, откуда его может извлечь первое правило из набора правил.  
  
Например, на рисунке ниже модуль утверждений считывает утверждения A и B входящего утверждения и копирует их во входной набор утверждений. Когда они во входной набор утверждений, модуль утверждений извлекает и обрабатывает утверждения A и B в качестве входных данных для логики первого правила из набора правил утверждений.  
  
![Роли AD FS](media/adfs2_context1.gif)  
  
Все правила в наборе правил утверждений используют один и тот же набор входящих утверждений. Каждое правило в этом наборе может добавлять к общему входному набору утверждений, влияя таким образом на работу последующих правил в наборе.  
  
### <a name="step-2--execution"></a>Шаг 2 – выполнение  
На этом шаге процесса правила утверждений правила утверждений обрабатываются, когда модуль утверждений в хронологическом порядке перебирает все правила в определенном наборе правил один раз. Только каждое правило из набора правил выполняется только один раз и выполняется в том порядке, в котором они отображаются сверху вниз, отображаемый в диалоговом окне Изменение правил для утверждений в управления AD FS оснастка. Сначала обработки правила утверждения, настроенного в верхней части правила и затем обрабатываются последующие правила, пока не будут выполнены все правила.  
  
Согласно языку правил утверждений, правило утверждения состоит из двух частей: условия и инструкции выдачи. Процессы первый модуль утверждений условию, используя данные на входе утверждения, равным определить ли условие, указанное в правиле для утверждений, содержащихся во входном наборе утверждений \ (утверждения, которые соответствуют условие правила, называются соответствия claims\). Если найдены соответствующие утверждения, модуль утверждений выполняет инструкцию выдачи правила для каждого набора соответствующих утверждений. Инструкция выдачи правила может выполнять одно из следующих действий с соответствующими утверждениями:  
  
1.  Копировать соответствующее утверждение в выходной набор утверждений  
  
2.  Преобразовывать поля утверждений и создавать новое утверждение либо только во входной набор утверждений либо оценки и в выходном наборах.  
  
3.  Используйте соответствующие claim\(s\) в качестве ключа для поиска дополнительных сведений из хранилища атрибутов для создания нового claim\(s\) либо только во входном наборе утверждений, или в входной и выходной наборы утверждений.  
  
#### <a name="adding-a-claim-to-the-output-claim-set-for-a-rule-set"></a>Добавление утверждения в выходной набор утверждений для набора правил  
*Выходной набор утверждений* — это область памяти, которая изначально пуста и важно, так как модуль утверждений вернет только те утверждения, которые находятся в выходном наборе утверждений по завершении процесса выполнения. Это означает, что любые утверждения, которые имеются только во входной утверждений наборе, но не в выходной набор утверждений будут игнорироваться при формировании итогового набора исходящих утверждений.  
  
#### <a name="adding-a-claim-to-both-claim-sets-for-a-rule-set"></a>Добавление утверждения в оба набора утверждений для набора правил  
В процессе обработки правила утверждения — это добавляются во входной, либо набор утверждений или как во входной набор утверждений и выходной наборы в зависимости от инструкции, которая используется в выдачи правила. Указывает языка правил утверждений эти инструкции называются *добавить* или *проблему*.  
  
Если *добавить* используется оператор, утверждения добавляются только во входной набор утверждений и будут существовать только в целях выполнения утверждений и будут удалены после завершения выполнения. Если *проблему* используется оператор, утверждения добавляются как во входной набор утверждений, так и в выходной наборы утверждений и будут возвращены в выходном наборе утверждений по завершении выполнения. Дополнительные сведения об этих инструкциях см. в разделе [роль языка правил утверждений](The-Role-of-the-Claim-Rule-Language.md).  
  
Если условию правила из набора правил не соответствует ни одно утверждение из входного набора утверждений, инструкция выдачи частью правила игнорируется, и таким образом утверждения не добавляются ни в выходной набор утверждений, или во входной набор утверждений. На рисунке ниже и соответствующие шаги показано, что происходит, когда модуль утверждений выполняет правило преобразования.  
  
![Роли AD FS](media/adfs2_context2.gif)  
  
1.  Входящие утверждения добавляются во входной набор утверждений модулем утверждений.  
  
2.  Когда выполняется первое правило, оно видит утверждения A и B, которые находятся на данный момент времени, единственными утверждениями во входном наборе утверждений, и обрабатывает условие, содержащееся в логике правила 1.  
  
3.  Так как утверждение A имеется во входном наборе утверждений, условие правила считается true \ (утверждение A\ соответствует) и новое утверждение C добавляется к как во входной набор утверждений, и выходной наборы утверждений.  
  
4.  Теперь правило 2 может использовать утверждения A, B и C \ (все утверждения во входной утверждений set\) в качестве входных данных для обработки логики.  
  
Дополнительные сведения о преобразовании утверждений см. в разделе [When to Use a Transform Claim Rule](When-to-Use-a-Transform-Claim-Rule.md).  
  
### <a name="step-3--execution-result"></a>Шаг 3 – результат выполнения  
Последний этап выполнения набора правил утверждений начинается, как только все правила из определенного набора правил будут выполнены, и итоговый набор утверждений присутствует в выходной набор утверждений. На этом этапе модуль утверждений Возвращает контекст выходного набора в качестве результата выполнения набора правил утверждений. С этого момента отвечает конвейер утверждений берет на себя и перемещает на следующий этап дальнейшую обработку этих итоговых данных.  
  
## <a name="sending-the-execution-output-to-the-claims-pipeline"></a>Отправка результатов выполнения в конвейер утверждений  
Когда модуль утверждений обрабатывает набор правил, что набор правил выделяется собственный в памяти для входного и выходного набора утверждений. Это означает, что входной и выходной утверждений наборы, используемые одним набором правил, изолированы от входного и выходного наборов, используемых другим набором правил.  
  
После выполнения всего процесса для определенного набора правил \ (шаги 1, 2 и 3\), вновь выданные исходящие утверждения \ (содержимое set\ утверждения выходных данных) будет использоваться в качестве входных данных для следующего набора правил в конвейере утверждений. Это обеспечивает передачу утверждений из выходные данные одного правила, набора правил в другой, как показано на следующем рисунке.  
  
![Роли AD FS](media/adfs2_enginecontexts.gif)  
  
> [!NOTE]  
> Несмотря на то, что набор правил выдачи также является важным этапом работы конвейера, на приведенном выше рисунке показан только для целей простоты. Иллюстрацию, набор правил выдачи занимает в конвейере утверждений, см. [The Role of the Claims Pipeline](The-Role-of-the-Claims-Pipeline.md).  
  
В этом случае выходные данные правил принятия используются конвейером для передачи итогового набора утверждений, сформированного правилами принятия, на второй этап конвейера, где осуществляется обработка правил авторизации. На этом этапе весь процесс выполнения правил утверждений \ (above\ шаги 1, 2 и 3) повторяется для набора правил авторизации. Этот цикл продолжается до набор правил выдачи \ (последний этап pipeline\) была завершена.  
  
После как итоговые исходящие утверждения возвращаются модулем для набора правил выдачи, они будут упакованы в токен SAML, и служба федерации отправляет клиенту.  
  
## <a name="processing-authorization-rules"></a>Обработка правил авторизации  
Если набор правил утверждений, выполняемый в шаге 2 процесса выполнения правил утверждений состоит из правил авторизации \ (который имеют входной и выходной наборы утверждений, отличные rules\ принятия или выдачи), а затем эти правила авторизации выполняются с целью определить, разрешено ли инициатору запроса токена получить маркер безопасности для данной проверяющей стороны от службы федерации в соответствии с утверждениями инициатора запроса.  
  
Целью правил авторизации является выдача разрешающего или запрещающего утверждения в зависимости от того, является ли пользователь было разрешено получить токен для данной проверяющей стороны или нет. Как показано на рисунке ниже, выходные данные правил авторизации используются конвейером для определения, выполняется ли набор правил выдачи, зависимости от наличия или отсутствия разрешающего and\ или или разрешающего утверждения, — но авторизации выходные данные не используются как входные для набора правил утверждений.  
  
![Роли AD FS](media/adfs2_authorization.gif)  
  
Дополнительные сведения об авторизации утверждений см. в разделе [When to Use an Authorization Claim Rule](When-to-Use-an-Authorization-Claim-Rule.md).  
  

