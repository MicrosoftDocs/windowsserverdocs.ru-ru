---
ms.assetid: 8b15d44e-e4e6-4510-aa91-cc7ec7161b0a
title: Роль механизма утверждений
description: ''
author: billmath
ms.author: billmath
manager: femila
ms.date: 05/31/2017
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: identity-adfs
ms.openlocfilehash: 055f9baff9c20019493a54fbb92e5c53c199a5e3
ms.sourcegitcommit: f6490192d686f0a1e0c2ebe471f98e30105c0844
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/10/2019
ms.locfileid: "70865514"
---
# <a name="the-role-of-the-claims-engine"></a>Роль механизма утверждений
На самом высшем уровне подсистема утверждений в \(службы федерации Active Directory (AD FS)\) AD FS является обработчиком на основе правил\-, предназначенным для обслуживания и обработки запросов утверждений для служба Федерации. Модуль утверждений — единственный компонент службы федерации, отвечающий за применение каждого набора правил ко всем настроенным федеративным отношениям доверия и передачу результата в конвейер утверждений.  
  
Хотя конвейер утверждений является более логичным понятием сквозного\-\-процесса для передаваемых утверждений, правила утверждений — это фактический административный элемент, который можно использовать для настройки потока утверждений в процессе выполнения правил утверждений. Подробнее о процессе работы конвейера см. в разделе [The Role of the Claims Pipeline](The-Role-of-the-Claims-Pipeline.md).  
  
Как показано на следующем рисунке, акт принятия \(входящих правил\)принятия утверждений, \(Авторизация правил\) авторизации запрашивающих утверждений и выдача исходящих \( утверждений. правила\) выдачи с помощью правил утверждений для всех федеративных отношений доверия в Организации выполняются подсистемой утверждения.  
  
![Роли AD FS](media/adfs2_enginepipeline.gif)  
  
## <a name="claim-rules-execution-process"></a>Процесс выполнения правил утверждений  
При настройке доверия поставщика утверждений или отношения доверия с проверяющей стороной в Организации с правилами утверждений набор\(\) правил утверждений для этого отношения доверия действует как привратник для входящих утверждений путем вызова обработчика утверждений для применения необходимых логика в правилах утверждений, позволяющая определить, следует ли выдавать утверждения и какие утверждения должны выдаваться.  
  
В следующем подразделе описывается каждое из действий, которое выполняется модулем в рамках процесса выполнения правил утверждения. Каждое из описанных действий производится на каждом этапе процесса конвейерной обработки утверждений. Эти действия включают в себя следующее:  
  
-   Шаг 1. Инициализация  
  
-   Шаг 2. Выполнение  
  
-   Шаг 3. Результат выполнения  
  
Подробнее о процессе работы конвейера см. в разделе [The Role of the Claims Pipeline](The-Role-of-the-Claims-Pipeline.md).  
  
### <a name="step-1--initialization"></a>Шаг 1. Инициализация  
На первом шаге процесса выполнения правил утверждений модуль утверждений принимает входящие утверждения, добавляя их сначала во *входной набор утверждений*. Входной набор утверждений аналогичен кэшу в памяти, используемому для временного хранения данных только до тех пор, пока процессу не потребуется извлечь их. Данные входного набора утверждений удаляются после завершения выполнения правил.  
  
#### <a name="adding-a-claim-to-the-input-claim-set-for-a-rule-set"></a>Добавление утверждения во входной набор утверждений для набора правил  
Входной набор утверждений создается модулем утверждений, когда ему требуется временно сохранить данные утверждений в памяти, пока он обрабатывает логику, связанную с набором правил утверждений. Модуль утверждений копирует все входящие утверждения во входной набор утверждений, откуда его может извлечь первое правило из набора правил.  
  
Например, на рисунке ниже модуль утверждений считывает входящие утверждения A и B и копирует их во входной набор утверждений. После этого модуль утверждений извлекает и обрабатывает утверждения A и B в качестве входных данных для логики первого правила из набора правил утверждений.  
  
![Роли AD FS](media/adfs2_context1.gif)  
  
Все правила в наборе правил утверждений используют один и тот же входной набор утверждений. Каждое правило в этом наборе может добавлять данные к общему входному набору утверждений, влияя таким образом на работу последующих правил в наборе.  
  
### <a name="step-2--execution"></a>Шаг 2. Выполнение  
На этом шаге процесса правила утверждений обрабатываются по мере того, как модуль утверждений по очереди перебирает все правила в определенном наборе правил в хронологическом порядке. Каждое правило в наборе правил выполняется один раз и выполняется в том порядке, в котором они отображаются сверху вниз, как показано в диалоговом окне Изменение правил утверждений в оснастке\-управления AD FS в. Первым выполняется самое верхнее правило утверждения из набора правил, затем выполняются последующие правила, пока они не будут обработаны все.  
  
Согласно языку правил утверждений, правило утверждения состоит из двух частей: условия и инструкции выдачи. Подсистема утверждений сначала обрабатывает условие с помощью данных в наборе входящих утверждений, чтобы определить, имеет ли условие, заданное в правиле, значение true для утверждений, содержащихся во входном утверждении. Установите \(утверждения, соответствующие правилу условие называется соответствующими утверждениями\). Если найдены соответствующие утверждения, модуль утверждений выполняет инструкцию выдачи правила для каждого набора соответствующих утверждений. Инструкция выдачи правила может выполнять одно из следующих действий с соответствующими утверждениями:  
  
1.  копировать соответствующее утверждение в выходной набор утверждений;  
  
2.  преобразовывать поля утверждений и создавать новое утверждение либо только во входном наборе утверждений, либо как во входном, так и в выходном наборах;  
  
3.  Используйте\(соответствующее утверждение\) в качестве ключа, чтобы найти дополнительные сведения из хранилища атрибутов\) , чтобы создать новые утверждения\(в наборе входящих утверждений либо как входные, так и выходные наборы утверждений.  
  
#### <a name="adding-a-claim-to-the-output-claim-set-for-a-rule-set"></a>Добавление утверждения в выходной набор утверждений для набора правил  
*Выходной набор утверждений* — это область памяти, которая изначально пуста. Она важна, так как модуль утверждений вернет только те утверждения, которые будут находиться в выходном наборе утверждений по завершении обработки. Это означает, что любые утверждения, которые имеются только во входном наборе утверждений, но не в выходном, будут игнорироваться при формировании итогового набора исходящих утверждений.  
  
#### <a name="adding-a-claim-to-both-claim-sets-for-a-rule-set"></a>Добавление утверждения в оба набора утверждений для набора правил  
При обработке правила утверждения либо добавляются во входной набор утверждений, либо как набор входящих утверждений, так и набор выходных заявок на основе инструкции, используемой в инструкции выдачи правила. В языке правил утверждений эти инструкции называются *add* или *issue*.  
  
Если используется инструкция *add* , утверждения добавляются только во входной набор утверждений и будут существовать только в целях выполнения. По завершении выполнения они будут удалены. Если используется инструкция *issue* , утверждения добавляются как во входной, так и в выходной наборы утверждений и будут возвращены в выходном наборе утверждений по завершении выполнения. Подробнее об этих инструкциях см. в разделе [The Role of the Claim Rule Language](The-Role-of-the-Claim-Rule-Language.md).  
  
Если условию правила из набора правил не соответствует ни одно утверждение из входного набора утверждений, инструкция выдачи игнорируется. Таким образом утверждения не добавляются ни в выходной, ни во входной наборы утверждений. На приведенном ниже рисунке показано, что происходит, когда модуль утверждений выполняет правило преобразования.  
  
![Роли AD FS](media/adfs2_context2.gif)  
  
1.  Входящие утверждения добавляются во входной набор утверждений модулем утверждений.  
  
2.  Когда выполняется первое правило, оно видит утверждения A и B, которые на этот момент являются единственными утверждениями во входном наборе утверждений, и обрабатывает условие, содержащееся в логике правила 1.  
  
3.  Так как в наборе входящих утверждений есть утверждение, условие правила определяется как истинное \(соответствие утверждению A\) , а новое утверждение C добавляется как в набор входящих утверждений, так и в набор выходных исходящих заявок.  
  
4.  В правиле 2 теперь можно использовать A, B и C \(, чтобы все утверждения во входном\) утверждении были заданы в качестве входных данных для обработки своей логики.  
  
Подробнее о преобразовании утверждений см. в разделе [When to Use a Transform Claim Rule](When-to-Use-a-Transform-Claim-Rule.md).  
  
### <a name="step-3--execution-result"></a>Шаг 3. Результат выполнения  
Последний этап выполнения набора правил утверждений начинается, как только все правила из определенного набора правил будут выполнены и в выходном наборе утверждений будет содержаться итоговый набор утверждений. На этом этапе модуль утверждений возвращает контекст выходного набора утверждений в качестве результата выполнения набора правил. С этого момента за дальнейшую обработку этих итоговых данных отвечает конвейер утверждений.  
  
## <a name="sending-the-execution-output-to-the-claims-pipeline"></a>Отправка результатов выполнения в конвейер утверждений  
Когда модуль утверждений обрабатывает набор правил, этому набору выделяется в памяти собственная область для входного и выходного набора утверждений. Это означает, что входной и выходной наборы утверждений, используемые одним набором правил, изолированы от входного и выходного наборов, используемых другим набором правил.  
  
После выполнения всего процесса для \(набора правил Set 1, 2 и 3\)вновь выданное содержимое исходящих утверждений \(набора\) выходных заявок будет использоваться в качестве входных данных для следующего набора правил в конвейере утверждений. Это обеспечивает передачу утверждений из одного набора правил в другой, как показано на рисунке ниже.  
  
![Роли AD FS](media/adfs2_enginecontexts.gif)  
  
> [!NOTE]  
> Хотя набор правил выдачи также является важным этапом работы конвейера, на приведенном выше рисунке он показан не только для простоты. Иллюстрацию того, какое место набор правил выдачи занимает в конвейере утверждений, см. в разделе [The Role of the Claims Pipeline](The-Role-of-the-Claims-Pipeline.md).  
  
В этом случае выходные данные правил принятия используются конвейером для передачи итогового набора утверждений, сформированного правилами принятия, на второй этап конвейера, где осуществляется обработка правил авторизации. На этом этапе все правила \(утверждений, описанные выше\) , будут выполнены с шагами 1, 2 и 3 для набора правил авторизации. Этот цикл будет продолжен до тех пор, \(пока правило выдачи не заполнится последним этапом в конвейере.\)  
  
После того как итоговые исходящие утверждения возвращаются модулем для набора правил выдачи, они упаковываются в токен SAML, который служба федерации отправляет клиенту.  
  
## <a name="processing-authorization-rules"></a>Обработка правил авторизации  
Если набор правил утверждения, выполняемый на шаге 2 процесса обработки правил утверждений, состоит из правил \(авторизации, которые имеют разные наборы входных и выходных исходящих утверждений, чем правила\)принятия или выдачи, то они правила авторизации будут выполняться, чтобы определить, авторизован ли инициатор запроса для получения маркера безопасности для данной проверяющей стороны из служба федерации на основе утверждений запросившего.  
  
Целью правил авторизации является выдача разрешающего или запрещающего утверждения в зависимости от того, следует ли разрешить пользователю получить токен для данной проверяющей стороны или нет. Как показано на следующем рисунке, выходные данные выполнения авторизации используются конвейером для определения того, выполняется ли набор правил выдачи или нет — на основе наличия или отсутствия утверждения разрешения\/или отказа, но авторизация выходные данные выполнения не используются в качестве входных данных для набора правил утверждений.  
  
![Роли AD FS](media/adfs2_authorization.gif)  
  
Подробнее об авторизации утверждений см. в разделе [When to Use an Authorization Claim Rule](When-to-Use-an-Authorization-Claim-Rule.md).  
  

