---
ms.assetid: 606f4196-b579-4806-a462-3abd4d93e87c
title: Когда следует использовать правило "Отправлять атрибуты LDAP как утверждения"
author: billmath
ms.author: billmath
manager: femila
ms.date: 05/31/2017
ms.topic: article
ms.prod: windows-server
ms.technology: identity-adfs
ms.openlocfilehash: e10f4c4a6883e26a674cc368b0ae46f0fdb0bce0
ms.sourcegitcommit: d5e27c1f2f168a71ae272bebf8f50e1b3ccbcca3
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/23/2020
ms.locfileid: "86966476"
---
# <a name="when-to-use-a-send-ldap-attributes-as-claims-rule"></a>Когда следует использовать правило "Отправлять атрибуты LDAP как утверждения"
Это правило можно использовать в службы федерации Active Directory (AD FS) \( AD FS \) , если требуется выдавать исходящие утверждения, содержащие фактические \( \) значения атрибутов LDAP, которые существуют в хранилище атрибутов, а затем связывать тип утверждения с каждым из атрибутов LDAP. Дополнительные сведения о хранилищах атрибутов см. [в разделе роль хранилищ атрибутов](The-Role-of-Attribute-Stores.md).  
  
При использовании этого правила одно утверждение выдается для каждого указанного атрибута LDAP, соответствующего логике правила, как описано в следующей таблице.  
  
|Параметр правила|Логика правила|  
|---------------|--------------|  
|Сопоставление атрибутов LDAP с типами исходящих утверждений|Если хранилище атрибутов совпадает с *указанным хранилищем атрибутов*, а атрибут LDAP равен *указанному значению*, сопоставьте значение атрибута LDAP с *указанным типом исходящего утверждения* и выдайте утверждение.|  
  
В следующих разделах содержатся основные сведения о правилах утверждений. Кроме того, в них содержатся сведения об использовании правила "Отправлять атрибуты LDAP как утверждения".  
  
## <a name="about-claim-rules"></a>Общие сведения о правилах утверждения  
Правило утверждения представляет экземпляр бизнес-логики, который будет принимать входящее утверждение, применить к нему условие, \( если x then y \) и создать исходящее утверждение на основе параметров условия. В следующем списке перечислены важные рекомендации в отношении правил утверждений, с которыми следует ознакомиться перед прочтением дальнейших сведений в этом разделе.  
  
-   В оснастке управления AD FS \- в правила утверждения можно создавать только с помощью шаблонов правил утверждений.  
  
-   Правила утверждений обрабатывают входящие утверждения либо непосредственно из поставщика утверждений, \( например Active Directory или другой служба Федерации, \) либо из выходных данных правил преобразования принятия в отношении доверия поставщика утверждений.  
  
-   Правила утверждений обрабатываются подсистемой выдачи утверждений в хронологическом порядке в пределах заданного набора правил. Установив приоритет правил, можно дополнительно уточнить или отфильтровать утверждения, созданные предыдущими правилами в данном наборе правил.  
  
-   Шаблоны правил утверждения всегда требуют указывать тип входящего утверждения. Тем не менее, можно обрабатывать несколько значений утверждений с одним типом утверждения, используя одно правило.  
  
Дополнительные сведения о правилах утверждений и наборах правил для утверждений см. [в разделе роль правил утверждений](The-Role-of-Claim-Rules.md). Дополнительные сведения о том, как правила обрабатываются, см. [в разделе роль подсистемы утверждений](The-Role-of-the-Claims-Engine.md). Дополнительные сведения о том, как обрабатываются наборы правил для утверждений, см. [в разделе роль конвейера утверждений](The-Role-of-the-Claims-Pipeline.md).  
  
## <a name="mapping-of-ldap-attributes-to-outgoing-claim-types"></a>Сопоставление атрибутов LDAP с типами исходящих утверждений  
При использовании шаблона «отправка атрибутов LDAP в качестве правила утверждений» можно выбрать атрибуты из хранилища атрибутов LDAP, такие как Active Directory или службы домен Active Directory, \( AD DS \) отправить свои значения в качестве утверждений проверяющей стороне. По сути, при этом определенные атрибуты LDAP из указанного хранилища атрибутов сопоставляются с набором исходящих утверждений, которые могут использоваться для авторизации.  
  
С помощью этого шаблона можно добавить несколько атрибутов, которые будут отправляться как несколько утверждений из одного правила. Например, можно использовать этот шаблон правила, чтобы создать правило, которое будет искать значения атрибутов для прошедших проверку подлинности пользователей в атрибутах Active Directory **компания** и **отдел**, а затем отправить эти значения как два разных исходящих утверждения.  
  
Это правило также можно использовать для отправки всех членств в группах пользователей. Если вы хотите отправить только членство в отдельных группах, используйте правило "Отправлять членство в группах как утверждения". Дополнительные сведения см. в разделе [When to Use a Send Group Membership as a Claim Rule](When-to-Use-a-Send-Group-Membership-as-a-Claim-Rule.md).  
  
## <a name="how-to-create-this-rule"></a>Создание правила  
Это правило можно создать с помощью языка правил утверждений или с помощью шаблона "Отправка атрибутов LDAP как утверждений" в оснастке управления AD FS \- в. Этот шаблон правила предоставляет следующие возможности настройки:  
  
-   указание имени правила утверждения;  
  
-   выбор хранилища атрибутов, из которого требуется извлечь атрибуты LDAP;  
  
-   Сопоставление атрибутов LDAP с типами исходящих утверждений  
  
Дополнительные сведения о создании этого правила см. в разделе [Создание правила для отправки АТРИБУТОВ LDAP в качестве утверждений](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/dd807115(v=ws.11)).  
  
## <a name="using-the-claim-rule-language"></a>С помощью языка правил утверждений  
Если запрос к Active Directory, AD DS или службы Active Directory облегченного доступа к каталогам \( AD LDS \) должен сравниваться с атрибутом LDAP, отличным от **SamAccountName**, то вместо него необходимо использовать пользовательское правило. Если в наборе входных данных нет утверждения имени учетной записи Windows, также необходимо использовать настраиваемое правило, чтобы указать утверждение для запросов к AD DS или AD LDS.  
  
Следующие примеры помогут вам понять различные способы создания настраиваемого правила с помощью языка правил утверждений для запроса и извлечения данных из хранилища атрибутов.  
  
### <a name="example-how-to-query-an-adlds-attribute-store-and-return-a-specified-value"></a>Пример. Как запросить хранилище атрибутов AD LDS и получить указанное значение  
Параметры должны быть разделены точкой с запятой. Первый параметр — это фильтр LDAP. Последующие параметры — это атрибуты для возврата соответствующих объектов.  
  
В следующем примере показано, как найти пользователя с помощью атрибута **SamAccountName** и отправить \- утверждение адреса электронной почты, используя значение атрибута mail пользователя:  
  
```  
c:[Type == "https://schemas.microsoft.com/ws/2008/06/identity/claims/windowsaccountname", Issuer == "AD AUTHORITY"]  
=> issue(store = "AD LDS", types = ("http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress"), query = "sAMAccountName={0};mail", param = regexreplace(c.Value, "(?<domain>[^\\]+)\\(?<user>.+)", "${user}"));  
  
```  
  
В следующем примере показано, как выполнить поиск пользователя по атрибуту **mail** и выдаче заголовка и утверждению отображаемого имени, используя значения атрибутов **Title** и **DisplayName** пользователя:  
  
```  
c:[Type == " http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress ", Issuer == "AD AUTHORITY"]  
=> issue(store = "AD LDS ", types = ("http://schemas.xmlsoap.org/ws/2005/05/identity/claims/title","http://schemas.xmlsoap.org/ws/2005/05/identity/claims/displayname"), query = "mail={0};title;displayname", param = c.Value);  
```  
  
В следующем примере показано, как найти пользователя по почте и заголовку, а затем выдать утверждение отображаемого имени с помощью атрибута **DisplayName** пользователя:  
  
```  
c1:[Type == " http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress"] && c2:[Type == "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/title"]  
=> issue(store = "AD LDS ", types = ("http://schemas.xmlsoap.org/ws/2005/05/identity/claims/displayname"), query = "(&(mail={0})(title={1}));displayname", param = c1.Value, param = c2.Value);  
```  
  
### <a name="example-how-to-query-an-activedirectory-attribute-store-and-return-a-specified-value"></a>Пример. Как запросить хранилище атрибутов Active Directory и вернуть указанное значение  
Запрос Active Directory должен включать имя пользователя \( с доменным именем в \) качестве окончательного параметра, чтобы хранилище атрибутов Active Directory могла запрашивать правильный домен. В противном случае синтаксис будет неверным.  
  
В следующем примере показано, как выполнить поиск пользователя по атрибуту **sAMAccountName** в его домене, а затем получить атрибут **mail**:  
  
```  
c:[Type == "https://schemas.microsoft.com/ws/2008/06/identity/claims/windowsaccountname", Issuer == "AD AUTHORITY"]  
=> issue(store = "Active Directory", types = ("http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress"), query = "sAMAccountName={0};mail;{1}", param = regexreplace(c.Value, "(?<domain>[^\\]+)\\(?<user>.+)", "${user}"), param = c.Value);  
```  
  
### <a name="example-how-to-query-an-activedirectory-attribute-store-based-on-the-value-of-an-incoming-claim"></a>Пример. Как запросить хранилище атрибутов Active Directory на основе значения входящего утверждения  
  
```  
c:[Type == "http://test/name"]  
  
   => issue(store = "Enterprise AD Attribute Store",  
  
         types = ("http://test/email"),  
  
         query = ";mail;{0}",  
  
         param = c.Value)  
  
```  
  
Предыдущий запрос состоит из следующих трех частей:  
  
-   Фильтр LDAP — укажите эту часть запроса для получения объектов, для которых необходимо запросить атрибуты. Общие сведения о допустимых запросах LDAP см. в документе RFC 2254. При запросе к хранилищу Active Directoryных атрибутов, если не указан фильтр LDAP, \= {0} используется запрос SamAccountName, а в хранилище атрибутов Active Directory ожидает параметр, который может передавать значение для {0} . В противном случае запрос приведет к ошибке. Для хранилища атрибутов LDAP, отличного от Active Directory, нельзя опускать часть с фильтром LDAP в составе запроса, иначе запрос приведет к ошибке.  
  
-   Спецификация атрибута — в этой второй части запроса указываются атрибуты, \( разделенные запятыми, \- Если используются несколько значений атрибутов \) , которые должны быть вне отфильтрованных объектов. Количество атрибутов, которые можно указать, должно соответствовать количеству типов утверждений, которые указываются в запросе.  
  
-   Домен Active Directory — укажите последнюю часть запроса, только если это хранилище атрибутов Active Directory. \(Это необязательно при запросе других хранилищ атрибутов. \) Эта часть запроса используется для указания учетной записи пользователя в виде доменного \\ имени. Хранилище атрибутов Active Directory использует доменную часть для определения соответствующего контроллера домена, к которому нужно подключиться, и запроса атрибутов.  
  
### <a name="example-how-to-use-two-custom-rules-to-extract-the-manager-e-mail-from-an-attribute-in-activedirectory"></a>Пример. Использование двух настраиваемых правил для извлечения сообщений электронной почты руководителя \- из атрибута в Active Directory  
Следующие два настраиваемых правила при совместном использовании в порядке, показанном ниже, запрашивают Active Directory атрибута **Manager** для правила учетной записи пользователя \( 1, \) а затем используют этот атрибут для запроса учетной записи руководителя для правила атрибута **почты** \( 2 \) . Наконец, атрибут **mail** выдается как утверждение "манажеремаил". В итоге, правило 1 запрашивает Active Directory и передает результат запроса в правило 2, который извлекает \- значения электронной почты диспетчера.  
  
Например, когда эти правила завершаются, выдается утверждение, содержащее адрес электронной почты руководителя \- для пользователя в домене Corp.fabrikam.com.  
  
**Правило 1**  
  
```  
c:[Type == "https://schemas.microsoft.com/ws/2008/06/identity/claims/windowsaccountname"]  
=> add(store = "Active Directory", types = ("http://schemas.xmlsoap.org/claims/ManagerDistinguishedName"), query = "sAMAccountName=  
{0};mail,userPrincipalName,extensionAttribute5,manager,department,extensionAttribute2,cn;{1}", param = regexreplace(c.Value, "(?  
<domain>[^\\]+)\\(?<user>.+)", "${user}"), param = c.Value);  
```  
  
**Правило 2**  
  
```  
c:[Type == "https://schemas.microsoft.com/ws/2008/06/identity/claims/windowsaccountname"]  
&& c1:[Type == "http://schemas.xmlsoap.org/claims/ManagerDistinguishedName"]  
=> issue(store = "Active Directory", types = ("http://schemas.xmlsoap.org/claims/ManagerEmail"), query = "distinguishedName={0};mail;{1}", param = c1.Value,   
param = regexreplace(c1.Value, ".*DC=(?<domain>.+),DC=corp,DC=fabrikam,DC=com", "${domain}\username"));  
```  
  
> [!NOTE]  
> Эти правила работают только в том случае, если менеджер пользователя находится в том же домене, что и пользователь, \( Corp.fabrikam.com в этом примере \) .  
  
## <a name="additional-references"></a>Дополнительные ссылки  
[Создание правила для отправки атрибутов LDAP в качестве утверждений](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/dd807115(v=ws.11))  
  
