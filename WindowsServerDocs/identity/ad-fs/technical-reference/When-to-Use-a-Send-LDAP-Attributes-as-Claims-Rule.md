---
ms.assetid: 606f4196-b579-4806-a462-3abd4d93e87c
title: When to Use a Send LDAP Attributes as Claims Rule
description: 
author: billmath
ms.author: billmath
manager: femila
ms.date: 05/31/2017
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: identity-adfs
ms.openlocfilehash: 05a2dd88057b64675bbc3bd30724d1eda0880c44
ms.sourcegitcommit: db290fa07e9d50686667bfba3969e20377548504
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/12/2017
---
>Область применения: Windows Server 2016, Windows Server 2012 R2, Windows Server 2012

# <a name="when-to-use-a-send-ldap-attributes-as-claims-rule"></a>When to Use a Send LDAP Attributes as Claims Rule
Это правило можно использовать в \(AD FS\) служб федерации Active Directory, если вы хотите выдавать исходящие утверждения, которые содержат фактические значения атрибутов протокола LDAP \(LDAP\) существует в хранилище атрибутов, а затем сопоставить тип утверждения с каждым из атрибутов LDAP. Дополнительные сведения о хранилищах атрибутов см. в разделе [роль хранилищ атрибутов](The-Role-of-Attribute-Stores.md).  
  
При использовании этого правила одно утверждение выдается для каждого атрибута LDAP, указываемые и соответствующего логике правила, как описано в следующей таблице.  
  
|Правило|Логика правила|  
|---------------|--------------|  
|Сопоставление атрибутов LDAP с типами исходящих утверждений|Если хранилище атрибутов совпадает *магазина заданным атрибутом* а атрибут LDAP равен *заданное значение*, сопоставьте значение атрибута LDAP *указанного исходящего утверждения* введите и выдать утверждение.|  
  
В следующих разделах содержатся основные сведения о правилах утверждений. Они также предоставляют сведения об использовании отправлять атрибуты LDAP как утверждения правила.  
  
## <a name="about-claim-rules"></a>Общие сведения о правилах утверждения  
Правило утверждения представляет экземпляр бизнес-логики, который будет делать входящее утверждение, применяет к нему условие \ (если x затем y\) и создает исходящее утверждения на основе параметров условия. В следующем списке перечислены важные советы, которые нужно знать о правилах утверждений, перед прочтением дальнейших в этом разделе:  
  
-   В оснастка управления AD FS правил для утверждений можно создавать только с помощью шаблонов правил для утверждений  
  
-   Процесс правил утверждений входящие утверждения либо непосредственно от поставщика утверждений \ (например, Active Directory или другим служба\текущих федерации), либо из выходных данных принятия преобразования правила для отношения доверия поставщика утверждений.  
  
-   Правила утверждений обрабатываются подсистемой выдачи утверждений в хронологическом порядке в пределах заданного набора правил. Установив приоритет правил, можно дополнительно уточнить или отфильтровать утверждения, созданные предыдущими правилами в данном наборе правил.  
  
-   Шаблоны правил утверждения всегда требуют указывать тип входящего утверждения. Тем не менее можно обрабатывать несколько значений утверждений с одним типом утверждения, используя одно правило.  
  
Дополнительные сведения о правилах утверждений и наборах правил утверждений см. в разделе [роль правил утверждений](The-Role-of-Claim-Rules.md). Дополнительные сведения об обработке правил см. в разделе [The Role of the Claims Engine](The-Role-of-the-Claims-Engine.md). Дополнительные сведения об обработке наборов правил утверждений см. в разделе [The Role of the Claims Pipeline](The-Role-of-the-Claims-Pipeline.md).  
  
## <a name="mapping-of-ldap-attributes-to-outgoing-claim-types"></a>Сопоставление атрибутов LDAP с типами исходящих утверждений  
При использовании отправлять атрибуты LDAP как шаблон правила утверждения, можно выбрать атрибуты из хранилища атрибутов LDAP, например Active Directory или доменные службы Active Directory \(AD DS\) для отправки их значений как утверждений проверяющей стороне. По существу, это сопоставляет определенные атрибуты LDAP из хранилища атрибутов, определяющие с набором исходящих утверждений, которые можно использовать для авторизации.  
  
С помощью этого шаблона, можно добавить несколько атрибутов, которые будут отправляться как несколько утверждений из одного правила. Например, этот шаблон правила можно использовать для создания правила, которое будет искать значения атрибутов для прошедших проверку подлинности пользователей из **компании** и **отдел** атрибуты Active Directory, а затем отправить эти значения как два разных исходящих утверждения.  
  
Это правило также позволяет отправлять принадлежность к группам пользователей. Если вы хотите отправить только в отдельных группах, используйте отправлять членство в группе как шаблон правила утверждения. Дополнительные сведения см. в разделе [When to Use a Send Group Membership as Claim Rule](When-to-Use-a-Send-Group-Membership-as-a-Claim-Rule.md).  
  
## <a name="how-to-create-this-rule"></a>Создание правила  
Можно создать это правило с помощью языка правил утверждений или с помощью отправлять атрибуты LDAP как утверждения правило шаблона в управления AD FS оснастка. Этот шаблон правила предоставляет следующие параметры конфигурации:  
  
-   Указание имени правила утверждения  
  
-   Выбор хранилища атрибутов, из которого требуется извлечь атрибуты LDAP  
  
-   Сопоставление атрибутов LDAP с типами исходящих утверждений  
  
Дополнительные сведения о создании этого правила см. в разделе [Создание правила для отправки атрибутов LDAP как утверждений](https://technet.microsoft.com/library/dd807115.aspx).  
  
## <a name="using-the-claim-rule-language"></a>С помощью языка правил утверждений  
Если запросу к Active Directory, AD DS или служб Active Directory облегченного доступа к каталогам \(AD LDS\) необходимо сравнение с атрибутом LDAP, отличным от **samAccountname**, вместо этого необходимо использовать настраиваемое правило. Если в наборе входных данных нет утверждения имени учетной записи Windows, необходимо также использовать настраиваемое правило, чтобы указать утверждение для запросов к AD DS или AD LDS.  
  
Следующие примеры помогут вам понять различные способы создания настраиваемого правила с помощью языка правил утверждений для запроса и извлечения данных из хранилища атрибутов.  
  
### <a name="example-how-to-query-an-ad-lds-attribute-store-and-return-a-specified-value"></a>Пример: Как запросить хранилище атрибутов AD LDS и получить указанное значение  
Параметры должны быть разделены точкой с запятой. Первый параметр — это фильтр LDAP. Последующие параметры — это атрибуты для возврата соответствующих объектов.  
  
Следующий пример показывает, как выполнить поиск пользователя по **sAMAccountName** атрибут и выдать утверждение адрес e\ почту, используя значение атрибута почты пользователя:  
  
```  
c:[Type == "https://schemas.microsoft.com/ws/2008/06/identity/claims/windowsaccountname", Issuer == "AD AUTHORITY"]  
=> issue(store = "AD LDS", types = ("http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress"), query = "sAMAccountName={0};mail", param = regexreplace(c.Value, "(?<domain>[^\\]+)\\(?<user>.+)", "${user}"));  
  
```  
  
Следующий пример показывает, как выполнить поиск пользователя по **почты** атрибут и выдавать утверждения должность и отображаемое имя, с помощью значений пользователя **title** и **displayname** атрибуты:  
  
```  
c:[Type == " http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress ", Issuer == "AD AUTHORITY"]  
=> issue(store = "AD LDS ", types = ("http://schemas.xmlsoap.org/ws/2005/05/identity/claims/title","http://schemas.xmlsoap.org/ws/2005/05/identity/claims/displayname"), query = "mail={0};title;displayname", param = c.Value);  
```  
  
В следующем примере показано, как выполнить поиск пользователя по атрибутам mail и title, а затем выдать утверждение отображаемое имя, используя пользователя **displayname** атрибута:  
  
```  
c1:[Type == " http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress"] && c2:[Type == "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/title"]  
=> issue(store = "AD LDS ", types = ("http://schemas.xmlsoap.org/ws/2005/05/identity/claims/displayname"), query = "(&(mail={0})(title={1}));displayname", param = c1.Value, param = c2.Value);  
```  
  
### <a name="example-how-to-query-an-active-directory-attribute-store-and-return-a-specified-value"></a>Пример: Как запросить хранилище атрибутов Active Directory и вернуть указанное значение  
Запрос Active Directory должен включать имя пользователя \ (с имя домена) как последний параметр, чтобы хранилище атрибутов Active Directory могло запросить правильный домен. В ином случае синтаксис будет неверным.  
  
Следующий пример показывает, как выполнить поиск пользователя по **sAMAccountName** атрибута в его домене, а затем возвращают **почты** атрибута:  
  
```  
c:[Type == "https://schemas.microsoft.com/ws/2008/06/identity/claims/windowsaccountname", Issuer == "AD AUTHORITY"]  
=> issue(store = "Active Directory", types = ("http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress"), query = "sAMAccountName={0};mail;{1}", param = regexreplace(c.Value, "(?<domain>[^\\]+)\\(?<user>.+)", "${user}"), param = c.Value);  
```  
  
### <a name="example-how-to-query-an-active-directory-attribute-store-based-on-the-value-of-an-incoming-claim"></a>Пример: Как запросить хранилище атрибутов Active Directory на основе значения входящего утверждения  
  
```  
c:[Type == "http://test/name"]  
  
   => issue(store = "Enterprise AD Attribute Store",  
  
         types = ("http://test/email"),  
  
         query = ";mail;{0}",  
  
         param = c.Value)  
  
```  
  
Предыдущий запрос состоит из следующих трех частей:  
  
-   Фильтр LDAP — укажите эту часть запроса для получения объектов, для которых необходимо запросить атрибуты. Общие сведения о допустимых запросах LDAP см. в документе RFC 2254. При запросе хранилища атрибутов Active Directory и не указать фильтр LDAP, samAccountName\ = {0} предполагается запрос и хранилище атрибутов Active Directory ожидает параметр, который может дать значение для {0}. В ином случае запрос приведет к сообщение об ошибке. Для хранилища атрибутов LDAP, отличного от Active Directory нельзя опускать часть с фильтром LDAP в составе запроса или запроса приведет к ошибке.  
  
-   Спецификация атрибута — во второй части запроса, укажите атрибуты \ (которые являются разделителями запятыми при использовании нескольких атрибутов values\), необходимо из отфильтрованных объектов. Количество атрибутов, которые можно указать, должно соответствовать количеству типов утверждений, которые указываются в запросе.  
  
-   Домен Active Directory — укажите последнюю часть запроса, только если хранилище атрибутов Active Directory. \ (Нет необходимости при запросе хранилища других атрибутов. \) эта часть запроса используется для указания учетной записи пользователя в форме domain\\name. Хранилище атрибутов Active Directory использует доменную часть для определения соответствующего контроллера домена для подключения и выполнения запроса и запроса атрибутов.  
  
### <a name="example-how-to-use-two-custom-rules-to-extract-the-manager-e-mail-from-an-attribute-in-active-directory"></a>Пример: Как использовать два настраиваемых правила для извлечения e\ почты manager из атрибута в Active Directory  
Следующие два настраиваемых правила при совместном использовании в показанном ниже порядке запрашивают у Active Directory **manager** атрибут пользователя \(Rule 1\) учетной записи, а затем использовать этот атрибут запрашивают учетную запись пользователя руководителя для **почты** атрибут \(Rule 2\). Наконец **почты** атрибут выдается как утверждение ManagerEmail»». Таким образом правило 1 отправляет запрос в Active Directory и передает результат запроса правилу 2, которое затем извлекает электронный адрес руководителя значения e\ почты.  
  
Например после выполнения этих правил выдается утверждение, содержащее электронный адрес почты e\ руководителя для пользователя в домене corp.fabrikam.com.  
  
**Правило 1**  
  
```  
c:[Type == "https://schemas.microsoft.com/ws/2008/06/identity/claims/windowsaccountname"]  
=> add(store = "Active Directory", types = ("http://schemas.xmlsoap.org/claims/ManagerDistinguishedName"), query = "sAMAccountName=  
{0};mail,userPrincipalName,extensionAttribute5,manager,department,extensionAttribute2,cn;{1}", param = regexreplace(c.Value, "(?  
<domain>[^\\]+)\\(?<user>.+)", "${user}"), param = c.Value);  
```  
  
**Правило 2**  
  
```  
c:[Type == "https://schemas.microsoft.com/ws/2008/06/identity/claims/windowsaccountname"]  
&& c1:[Type == "http://schemas.xmlsoap.org/claims/ManagerDistinguishedName"]  
=> issue(store = "Active Directory", types = ("http://schemas.xmlsoap.org/claims/ManagerEmail"), query = "distinguishedName={0};mail;{1}", param = c1.Value,   
param = regexreplace(c1.Value, ".*DC=(?<domain>.+),DC=corp,DC=fabrikam,DC=com", "${domain}\username"));  
```  
  
> [!NOTE]  
> Эти правила работают, только если руководитель пользователя находится в том же домене пользователя \ (corp.fabrikam.com в этом example\).  
  
## <a name="additional-references"></a>Дополнительные ссылки  
[Создание правила для отправки атрибутов LDAP как утверждений](https://technet.microsoft.com/library/dd807115.aspx)  
  

