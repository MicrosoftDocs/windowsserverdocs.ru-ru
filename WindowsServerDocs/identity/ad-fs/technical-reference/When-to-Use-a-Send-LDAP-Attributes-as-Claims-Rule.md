---
ms.assetid: 606f4196-b579-4806-a462-3abd4d93e87c
title: Когда следует использовать правило "Отправлять атрибуты LDAP как утверждения"
description: ''
author: billmath
ms.author: billmath
manager: femila
ms.date: 05/31/2017
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: identity-adfs
ms.openlocfilehash: 5af00db05c572a45811eea49b832a054a9e0e492
ms.sourcegitcommit: 0b5fd4dc4148b92480db04e4dc22e139dcff8582
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/24/2019
ms.locfileid: "66188251"
---
# <a name="when-to-use-a-send-ldap-attributes-as-claims-rule"></a>Когда следует использовать правило "Отправлять атрибуты LDAP как утверждения"
Это правило можно использовать в службах федерации Active Directory \(AD FS\) Если вы хотите выдавать исходящие утверждения, которые содержат фактические Lightweight Directory Access Protocol \(LDAP\) значения атрибутов, существуют в атрибут хранения и затем сопоставить тип утверждения с каждым из атрибутов LDAP. Дополнительные сведения о хранилищах атрибутов см. в разделе [The Role of Attribute Stores](The-Role-of-Attribute-Stores.md).  
  
При использовании этого правила одно утверждение выдается для каждого указанного атрибута LDAP, соответствующего логике правила, как описано в следующей таблице.  
  
|Параметр правила|Логика правила|  
|---------------|--------------|  
|Сопоставление атрибутов LDAP с типами исходящих утверждений|Если хранилище атрибутов совпадает с *указанным хранилищем атрибутов*, а атрибут LDAP равен *указанному значению*, сопоставьте значение атрибута LDAP с *указанным типом исходящего утверждения* и выдайте утверждение.|  
  
В следующих разделах содержатся основные сведения о правилах утверждений. Кроме того, в них содержатся сведения об использовании правила "Отправлять атрибуты LDAP как утверждения".  
  
## <a name="about-claim-rules"></a>Общие сведения о правилах утверждения  
Правило утверждения представляет экземпляр бизнес-логики, будет к входящему утверждению, применить условие к нему \(if x, то y\) и Создание исходящего утверждения на основе параметров условия. В следующем списке перечислены важные рекомендации в отношении правил утверждений, с которыми следует ознакомиться перед прочтением дальнейших сведений в этом разделе.  
  
-   В консоли управления AD FS\-, утверждения, правила могут создаваться только с помощью шаблонов правил для утверждений  
  
-   Процесс правила утверждений входящие утверждения либо непосредственно от поставщика утверждений \(например Active Directory или другой службы федерации\) или из выходных данных принятия отношения доверия поставщика утверждений правил преобразования.  
  
-   Правила утверждений обрабатываются подсистемой выдачи утверждений в хронологическом порядке в пределах заданного набора правил. Установив приоритет правил, можно дополнительно уточнить или отфильтровать утверждения, созданные предыдущими правилами в данном наборе правил.  
  
-   Шаблоны правил утверждения всегда требуют указывать тип входящего утверждения. Тем не менее, можно обрабатывать несколько значений утверждений с одним типом утверждения, используя одно правило.  
  
Более подробные сведения о правилах для утверждений и наборах правил утверждений, см. в разделе [The Role of Claim Rules](The-Role-of-Claim-Rules.md). Дополнительные сведения об обработке правил см. в разделе [The Role of the Claims Engine](The-Role-of-the-Claims-Engine.md). Дополнительные сведения, как обрабатываются наборов правил утверждений, см. в разделе [The Role of the Claims Pipeline](The-Role-of-the-Claims-Pipeline.md).  
  
## <a name="mapping-of-ldap-attributes-to-outgoing-claim-types"></a>Сопоставление атрибутов LDAP с типами исходящих утверждений  
При использовании отправлять атрибуты LDAP как шаблон правила утверждения, можно выбрать атрибуты из хранилища атрибутов LDAP, например Active Directory или доменных служб Active Directory \(AD DS\) для отправки их значений как утверждений проверяющей стороне . По сути, при этом определенные атрибуты LDAP из указанного хранилища атрибутов сопоставляются с набором исходящих утверждений, которые могут использоваться для авторизации.  
  
С помощью этого шаблона можно добавить несколько атрибутов, которые будут отправляться как несколько утверждений из одного правила. Например, можно использовать этот шаблон правила, чтобы создать правило, которое будет искать значения атрибутов для прошедших проверку подлинности пользователей в атрибутах Active Directory **компания** и **отдел**, а затем отправить эти значения как два разных исходящих утверждения.  
  
Это правило также может использоваться для отправки сведений о членстве пользователя во всех группах. Если вы хотите отправить только членство в отдельных группах, используйте правило "Отправлять членство в группах как утверждения". Дополнительные сведения см. в разделе [когда следует использовать как правило утверждения Send Group Membership](When-to-Use-a-Send-Group-Membership-as-a-Claim-Rule.md).  
  
## <a name="how-to-create-this-rule"></a>Создание правила  
Можно создать это правило с помощью языка правил утверждений или с помощью отправлять атрибуты LDAP как шаблон правила утверждения в управлении AD FS оснасток\-в. Этот шаблон правила предоставляет следующие возможности настройки:  
  
-   указание имени правила утверждения;  
  
-   выбор хранилища атрибутов, из которого требуется извлечь атрибуты LDAP;  
  
-   Сопоставление атрибутов LDAP с типами исходящих утверждений  
  
Дополнительные сведения о создании этого правила см. в разделе [создать правило, чтобы отправлять атрибуты LDAP как утверждений](https://technet.microsoft.com/library/dd807115.aspx).  
  
## <a name="using-the-claim-rule-language"></a>С помощью языка правил утверждений  
Если запрос к Active Directory, AD DS или служб Active Directory облегченного \(AD LDS\) необходимо сравнить с атрибутом LDAP, отличное от **samAccountname**, вместо этого необходимо использовать настраиваемое правило. Если в наборе входных данных нет утверждения имени учетной записи Windows, также необходимо использовать настраиваемое правило, чтобы указать утверждение для запросов к AD DS или AD LDS.  
  
Следующие примеры помогут вам понять различные способы создания настраиваемого правила с помощью языка правил утверждений для запроса и извлечения данных из хранилища атрибутов.  
  
### <a name="example-how-to-query-an-adlds-attribute-store-and-return-a-specified-value"></a>Пример. Как запросить хранилище атрибутов AD LDS и получить указанное значение  
Параметры должны быть разделены точкой с запятой. Первый параметр — это фильтр LDAP. Последующие параметры — это атрибуты для возврата соответствующих объектов.  
  
Следующий пример показывает, как выполнить поиск пользователя по **sAMAccountName** атрибут и выдавать e\-утверждения почтовый адрес, используя значение атрибута электронной почты пользователя:  
  
```  
c:[Type == "https://schemas.microsoft.com/ws/2008/06/identity/claims/windowsaccountname", Issuer == "AD AUTHORITY"]  
=> issue(store = "AD LDS", types = ("http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress"), query = "sAMAccountName={0};mail", param = regexreplace(c.Value, "(?<domain>[^\\]+)\\(?<user>.+)", "${user}"));  
  
```  
  
В следующем примере показано, как выполнить поиск пользователя по атрибуту **mail** и выдать утверждение "Должность и отображаемое имя", используя значения атрибутов **title** и **displayname** пользователя:  
  
```  
c:[Type == " http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress ", Issuer == "AD AUTHORITY"]  
=> issue(store = "AD LDS ", types = ("http://schemas.xmlsoap.org/ws/2005/05/identity/claims/title","http://schemas.xmlsoap.org/ws/2005/05/identity/claims/displayname"), query = "mail={0};title;displayname", param = c.Value);  
```  
  
В следующем примере показано, как выполнить поиск пользователя по атрибутам mail и title, а затем выдать утверждение "Отображаемое имя", используя атрибут **displayname** пользователя:  
  
```  
c1:[Type == " http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress"] && c2:[Type == "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/title"]  
=> issue(store = "AD LDS ", types = ("http://schemas.xmlsoap.org/ws/2005/05/identity/claims/displayname"), query = "(&(mail={0})(title={1}));displayname", param = c1.Value, param = c2.Value);  
```  
  
### <a name="example-how-to-query-an-activedirectory-attribute-store-and-return-a-specified-value"></a>Пример. Как запросить хранилище атрибутов Active Directory и вернуть указанное значение  
Запрос Active Directory должен включать имя пользователя \(с доменным именем\) как последний параметр, чтобы хранилище атрибутов Active Directory можно запросить правильный домен. В противном случае синтаксис будет неверным.  
  
В следующем примере показано, как выполнить поиск пользователя по атрибуту **sAMAccountName** в его домене, а затем получить атрибут **mail**:  
  
```  
c:[Type == "https://schemas.microsoft.com/ws/2008/06/identity/claims/windowsaccountname", Issuer == "AD AUTHORITY"]  
=> issue(store = "Active Directory", types = ("http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress"), query = "sAMAccountName={0};mail;{1}", param = regexreplace(c.Value, "(?<domain>[^\\]+)\\(?<user>.+)", "${user}"), param = c.Value);  
```  
  
### <a name="example-how-to-query-an-activedirectory-attribute-store-based-on-the-value-of-an-incoming-claim"></a>Пример. Как запросить хранилище атрибутов Active Directory на основе значения входящего утверждения  
  
```  
c:[Type == "http://test/name"]  
  
   => issue(store = "Enterprise AD Attribute Store",  
  
         types = ("http://test/email"),  
  
         query = ";mail;{0}",  
  
         param = c.Value)  
  
```  
  
Предыдущий запрос состоит из следующих трех частей:  
  
-   Фильтр LDAP — укажите эту часть запроса для получения объектов, для которых необходимо запросить атрибуты. Общие сведения о допустимых запросах LDAP см. в документе RFC 2254. При запросе хранилища атрибутов Active Directory и не указать фильтр LDAP, samAccountName\= {0} запроса предполагается, что и хранилище атрибутов Active Directory ожидает параметр, позволяющий передавать значение для {0}. В противном случае запрос приведет к ошибке. Для хранилища атрибутов LDAP, отличного от Active Directory, нельзя опускать часть с фильтром LDAP в составе запроса, иначе запрос приведет к ошибке.  
  
-   Спецификация атрибута — из второй части запроса, укажите атрибуты \(которые являются разделителями\-запятыми, если вы используете несколько значений атрибутов\) , которые вам нужны отфильтрованные объекты. Количество атрибутов, которые можно указать, должно соответствовать количеству типов утверждений, которые указываются в запросе.  
  
-   Домен Active Directory — укажите последнюю часть запроса, только если это хранилище атрибутов Active Directory. \(Это необходимо, при запросе других хранилищах атрибутов.\) Эта часть запроса используется для указания учетной записи пользователя в домене формы\\имя. Хранилище атрибутов Active Directory использует доменную часть для определения соответствующего контроллера домена, к которому нужно подключиться, и запроса атрибутов.  
  
### <a name="example-how-to-use-two-custom-rules-to-extract-the-manager-e-mail-from-an-attribute-in-activedirectory"></a>Пример. Как использовать два настраиваемых правила для извлечения manager e\-почту из атрибута в Active Directory  
Следующие два настраиваемых правила при совместном использовании в показанном ниже порядке запрашивают у Active Directory **manager** атрибут учетной записи пользователя \(правила 1\) и затем использовать этот атрибут, чтобы запросить пользователя Учетная запись диспетчера для **mail** атрибут \(правила 2\). Наконец, атрибут **mail** выдается как утверждение ManagerEmail. Таким образом, правило 1 отправляет запрос в Active Directory и передает результат запроса правилу 2, которое затем извлекает manager e\-почты значения.  
  
Например, после завершения выполнения этих правил выдается утверждение, содержащий e руководителя\-почтового адреса пользователя в домене corp.fabrikam.com.  
  
**Правило 1**  
  
```  
c:[Type == "https://schemas.microsoft.com/ws/2008/06/identity/claims/windowsaccountname"]  
=> add(store = "Active Directory", types = ("http://schemas.xmlsoap.org/claims/ManagerDistinguishedName"), query = "sAMAccountName=  
{0};mail,userPrincipalName,extensionAttribute5,manager,department,extensionAttribute2,cn;{1}", param = regexreplace(c.Value, "(?  
<domain>[^\\]+)\\(?<user>.+)", "${user}"), param = c.Value);  
```  
  
**Правило 2**  
  
```  
c:[Type == "https://schemas.microsoft.com/ws/2008/06/identity/claims/windowsaccountname"]  
&& c1:[Type == "http://schemas.xmlsoap.org/claims/ManagerDistinguishedName"]  
=> issue(store = "Active Directory", types = ("http://schemas.xmlsoap.org/claims/ManagerEmail"), query = "distinguishedName={0};mail;{1}", param = c1.Value,   
param = regexreplace(c1.Value, ".*DC=(?<domain>.+),DC=corp,DC=fabrikam,DC=com", "${domain}\username"));  
```  
  
> [!NOTE]  
> Эти правила работают только в том случае, если руководитель пользователя находится в том же домене, что пользователь \(corp.fabrikam.com в этом примере\).  
  
## <a name="additional-references"></a>Дополнительная справка  
[Создание правила для отправки атрибутов LDAP как утверждений](https://technet.microsoft.com/library/dd807115.aspx)  
  

