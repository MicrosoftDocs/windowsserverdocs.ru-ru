---
ms.assetid: 77aa61bf-9c04-4889-a5d2-6f45bc1b8bd2
title: Когда следует использовать правила преобразования утверждений
author: billmath
ms.author: billmath
manager: femila
ms.date: 05/31/2017
ms.topic: article
ms.openlocfilehash: 3d39a4763eebe3e2fa28252c785a3b4d87e60143
ms.sourcegitcommit: dfa48f77b751dbc34409aced628eb2f17c912f08
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/07/2020
ms.locfileid: "87958742"
---
# <a name="when-to-use-a-transform-claim-rule"></a>Когда следует использовать правила преобразования утверждений
Это правило можно использовать в службы федерации Active Directory (AD FS) \( AD FS \) , если необходимо сопоставлять тип входящего утверждения с типом исходящего утверждения, а затем применить действие, которое определит, какие выходные данные должны выполняться на основе значений, поступающих во входящее утверждение. При использовании этого правила вы пропускаете или преобразуете все утверждения, соответствующие следующей логике правила, на основе параметров, настроенных в правиле, как показано в следующей таблице.

|Параметр правила|Логика правила|
|---------------|--------------|
|Пропуск всех входящих утверждений|Если входящее утверждение имеет *указанный тип утверждения*, а значение соответствует *любому значению*, то следует пропустить это утверждение с типом исходящего утверждения, равным *указанному типу утверждения*.|
|Замена значения входящего утверждения на значение другого исходящего утверждения|Если входящее утверждение имеет *указанный тип утверждения*, а значение соответствует *заданному значению утверждения*, следует преобразовать утверждение, установив новое значение исходящего утверждения, соответствующее *заданному значению утверждения*, а тип исходящего утверждения соответствующим *указанному типу утверждения*|
|Замена входящих \- суффиксов электронной почты новым \- суффиксом электронной почты|Если входящее утверждение имеет *указанный тип утверждения*, а значение соответствует *любому значению суффикса*, следует преобразовать утверждение, установив новое значение исходящего утверждения, соответствующее *заданному значению суффикса*, а тип исходящего утверждения соответствующим *указанному типу утверждения*|

В следующих разделах содержатся основные сведения о правилах утверждений и предоставляются дополнительные сведения об использовании этого правила.

## <a name="about-claim-rules"></a>Общие сведения о правилах утверждения
Правило утверждения представляет экземпляр бизнес-логики, который будет принимать входящее утверждение, применить к нему условие, \( если x then y \) и создать исходящее утверждение на основе параметров условия. В следующем списке перечислены важные рекомендации в отношении правил утверждений, с которыми следует ознакомиться перед прочтением дальнейших сведений в этом разделе.

-   В оснастке управления AD FS \- в правила утверждения можно создавать только с помощью шаблонов правил утверждений.

-   Правила утверждений обрабатывают входящие утверждения либо непосредственно из поставщика утверждений, \( например Active Directory или другой служба Федерации, \) либо из выходных данных правил преобразования принятия в отношении доверия поставщика утверждений.

-   Правила утверждений обрабатываются подсистемой выдачи утверждений в хронологическом порядке в пределах заданного набора правил. Установив приоритет правил, можно дополнительно уточнить или отфильтровать утверждения, созданные предыдущими правилами в данном наборе правил.

-   Шаблоны правил утверждения всегда требуют указывать тип входящего утверждения. Тем не менее, можно обрабатывать несколько значений утверждений с одним типом утверждения, используя одно правило.

Дополнительные сведения о правилах утверждений и наборах правил для утверждений см. [в разделе роль правил утверждений](The-Role-of-Claim-Rules.md). Дополнительные сведения о том, как правила обрабатываются, см. [в разделе роль подсистемы утверждений](The-Role-of-the-Claims-Engine.md). Дополнительные сведения о том, как обрабатываются наборы правил для утверждений, см. [в разделе роль конвейера утверждений](The-Role-of-the-Claims-Pipeline.md).

## <a name="pass-through-all-claim-values"></a>пропуск всех значений утверждений;
При использовании этого действия все значения входящих утверждений, соответствующие указанному типу входящего утверждения, сопоставляются с указанным типом исходящего утверждения перед их отправкой в качестве исходящих утверждений в токены, подписанные вашей службой федерации.

Например, если правило установлено с вариантом логики **Пропускать все значения утверждений**, а также задан тип "Группа" для входящего утверждения и тип "Роль" для исходящего утверждения, то все значения входящих утверждений, поступающие от издателя, по отдельности копируются в новые исходящие утверждения с типом "Роль".

## <a name="transforming-a-claim"></a>Преобразование утверждения
В AD FS термин преобразование « *утверждения* » означает замену одного значения входящего утверждения другим значением исходящего утверждения. Эту функциональность обеспечивает правило преобразования входящего утверждения. В свойствах этого правила можно задать условия для замены входящих значений на значение другого исходящего утверждения на основе указанного типа входящего утверждения.

Например, как показано на следующем рисунке, когда устанавливается правило с условием замены входящего значения на значение другого исходящего утверждения, все входящие утверждения с типом "Группа" сопоставляются с новыми типами исходящих утверждений "Роль". В этом случае значение входящего утверждения "Покупатель" заменяется на новое значение исходящего утверждения "Администратор".

![Когда следует использовать преобразование](media/adfs2_transform.gif)

Это правило можно также использовать для применения условия, которое заменит все входящие утверждения на указанное \- значение суффикса электронной почты с новым значением. Например, можно задать в этом правиле условие для изменения всех значений утверждений с суффиксом sales.corp.fabrikam.com на fabrikam.com.

## <a name="configuring-this-rule-on-a-claims-provider-trust"></a>Настройка этого правила для отношения доверия с поставщиком утверждений
При использовании отношения доверия с поставщиком утверждений это правило можно настроить для преобразования входящих утверждений от поставщика утверждений в надежные эквиваленты. Типы утверждений или значения утверждений в вашей организации могут иметь другое значение, чем в организациях поставщика утверждений. Это правило можно использовать для нормализации типов и значений утверждений, полученных от поставщика утверждений, чтобы проверяющая сторона могла понимать их эквиваленты исходящих утверждений.

## <a name="configuring-this-rule-on-a-relying-party-trust"></a>Настройка этого правила в отношениях доверия с проверяющей стороной
При использовании отношения доверия с проверяющей стороной это правило можно настроить для преобразования утверждений для определенной проверяющей стороны. Типы или значения утверждений могут иметь другое значение для определенной проверяющей стороны, и это правило позволяет изменять типы и значения исходящих утверждений для одной проверяющей стороны.

## <a name="how-to-create-this-rule"></a>Создание правила
Это правило создается с помощью языка правил утверждений или с помощью шаблона **Преобразование входящего утверждения** в оснастке управления AD FS \- в. Этот шаблон правила предоставляет следующие возможности настройки:

-   указание имени правила утверждения;

-   преобразование определенного типа входящего утверждения в указанный тип исходящего утверждения;

-   пропуск всех значений утверждений;

-   Замена значения входящего утверждения на значение другого исходящего утверждения

-   Замена входящего \- суффикса электронной почты на новый суффикс электронной \- почты

Дополнительные сведения о создании этого шаблона см. в разделе [Создание правила для преобразования входящего утверждения](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/dd807068(v=ws.11)) в AD FS руководство по развертыванию.

## <a name="using-the-claim-rule-language"></a>С помощью языка правил утверждений
Если исходящее утверждение должно состоять из содержимого нескольких входящих утверждений, необходимо использовать настраиваемое правило. Если значение исходящего утверждения должно строиться на значении входящего утверждения, но с дополнительным содержимым, в этом контексте также следует использовать настраиваемое правило. Дополнительные сведения см. в разделе [When to Use a Custom Claim Rule](When-to-Use-a-Custom-Claim-Rule.md).

### <a name="examples-of-how-to-construct-a-transform-rule-syntax"></a>Примеры создания синтаксиса правила преобразования
При использовании синтаксиса языка правил утверждений для преобразования утверждений можно задать в свойстве преобразованного утверждения новое литеральное значение. Например, следующее правило изменяет значение утверждения роли с "Администраторы" на "root" при сохранении того же типа утверждения:

```
c:[type == "https://schemas.microsoft.com/ws/2008/06/identity/claims/role", value == "Administrators"]  => issue(type = c.type, value = "root");
```

Для преобразования утверждений также можно использовать регулярные выражения. Например, следующее правило установит домен в поле утверждения имени пользователя Windows в \\ формате пользователя домена Fabrikam:

```
c:[type == "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name"] => issue(type = c.type, value = regexreplace(c.value, "(?<domain>[^\\]+)\\(?<user>.+)", "FABRIKAM\${user}"));
```

### <a name="best-practices-for-creating-custom-rules"></a>Рекомендации по созданию настраиваемых правил
Преобразования утверждений можно выборочно применять к утверждениям, выбранным с помощью основных возможностей фильтрации. Каждому из свойств утверждения, используемых для фильтрации, можно присвоить значения, со следующими оговорками.

|Свойство утверждения|Описание|
|------------------|---------------|
|Type, Value, ValueType|Эти свойства наиболее часто используются для назначения. Для итогового преобразованного утверждения должны быть заданы как минимум тип и значение.|
|Издатель|Хотя язык правил утверждений позволяет настроить издателя утверждения, это обычно не рекомендуется. Издатель утверждения не сериализуется в токене. При получении токена издателя всех утверждений свойству Issuer всех утверждений присваивается идентификатор сервера федерации, подписавшего токен. Таким образом, настройка издателя утверждения в правилах не повлияет на содержимое токена, и эта настройка будет потеряна после упаковки утверждения в токене. Единственный сценарий, где настройка издателя утверждения имеет смысл, — когда задано конкретное значение в наборе правил поставщика утверждений и набор правил проверяющей стороны создается из правил, которые ссылаются на это конкретное значение. Если свойству Issuer явно не присвоено значение в правиле утверждений, подсистема выдачи утверждений задает для нее "локальный центр".|
|OriginalIssuer|Как и свойству Issuer, свойству OriginalIssuer значение обычно не назначается явно. В отличие от Issuer, свойство OriginalIssuer сериализуется в токене, но потребители токена ожидают, что если оно задано, то будет содержать идентификатор сервера федерации, изначально выдавшего утверждение.|
|Свойства|Как описано в предыдущем разделе, контейнер свойств утверждения не сохраняется в токене, поэтому назначения свойств должны выполняться, только если последующие локальные политики будут ссылаться на данные, хранящиеся в свойстве.|

Дополнительные сведения об использовании языка правил утверждений см. [в разделе роль языка правил утверждений](The-Role-of-the-Claim-Rule-Language.md).

