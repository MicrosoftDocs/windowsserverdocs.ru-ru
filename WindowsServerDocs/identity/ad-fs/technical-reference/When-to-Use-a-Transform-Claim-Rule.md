---
ms.assetid: 77aa61bf-9c04-4889-a5d2-6f45bc1b8bd2
title: "Когда следует использовать правила преобразования утверждений"
description: 
author: billmath
ms.author: billmath
manager: femila
ms.date: 05/31/2017
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: identity-adfs
ms.openlocfilehash: c7b7ea2c8d9a08a4cbf6c89c2de2482043efe25b
ms.sourcegitcommit: db290fa07e9d50686667bfba3969e20377548504
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/12/2017
---
>Область применения: Windows Server 2016, Windows Server 2012 R2, Windows Server 2012

# <a name="when-to-use-a-transform-claim-rule"></a>Когда следует использовать правила преобразования утверждений
Это правило можно использовать в \(AD FS\) служб федерации Active Directory, когда вам нужно сопоставить тип входящего утверждения для типа исходящего утверждения и затем применить действие, которое будет определять, какой результат должен возникать на основе значений во входящем утверждении. При использовании этого правила вы пропускаете или преобразования утверждений, которые соответствуют следующей логике правила, в зависимости от параметров, настроенных в правиле, как описано в следующей таблице.  
  
|Правило|Логика правила|  
|---------------|--------------|  
|Пропуск всех входящих утверждений|Если входящее утверждение имеет тип *указанному типу утверждения* и значение равно *любое значение*, то следует пропустить утверждение с типом исходящего утверждения равным *указанному типу утверждения*|  
|Замените значение входящего утверждения на значение другого исходящего утверждения|Если входящее утверждение имеет тип *указанному типу утверждения* и значение равно *заданное значение утверждения*, следует преобразовать утверждение, установив новое значение исходящего утверждения *заданное значение утверждения* и тип исходящего утверждения соответствующим *указанному типу утверждения*|  
|Замена суффикса e\ почты входящих утверждений новым суффиксом электронной почты e\|Если входящее утверждение имеет тип *указанному типу утверждения* и значение равно *любой суффикс значение*, следует преобразовать утверждение, установив новое значение исходящего утверждения *указанному значению суффикса* и тип исходящего утверждения соответствующим *указанному типу утверждения*|  
  
В следующих разделах содержатся основные сведения о правилах утверждений и предоставляются дополнительные сведения об использовании этого правила.  
  
## <a name="about-claim-rules"></a>Общие сведения о правилах утверждения  
Правило утверждения представляет экземпляр бизнес-логики, который будет делать входящее утверждение, применяет к нему условие \ (если x затем y\) и создает исходящее утверждения на основе параметров условия. В следующем списке перечислены важные советы, которые нужно знать о правилах утверждений, перед прочтением дальнейших в этом разделе:  
  
-   В оснастка управления AD FS правил для утверждений можно создавать только с помощью шаблонов правил для утверждений  
  
-   Процесс правил утверждений входящие утверждения либо непосредственно от поставщика утверждений \ (например, Active Directory или другим служба\текущих федерации), либо из выходных данных принятия преобразования правила для отношения доверия поставщика утверждений.  
  
-   Правила утверждений обрабатываются подсистемой выдачи утверждений в хронологическом порядке в пределах заданного набора правил. Установив приоритет правил, можно дополнительно уточнить или отфильтровать утверждения, созданные предыдущими правилами в данном наборе правил.  
  
-   Шаблоны правил утверждения всегда требуют указывать тип входящего утверждения. Тем не менее можно обрабатывать несколько значений утверждений с одним типом утверждения, используя одно правило.  
  
Дополнительные сведения о правилах утверждений и наборах правил утверждений см. в разделе [роль правил утверждений](The-Role-of-Claim-Rules.md). Дополнительные сведения об обработке правил см. в разделе [The Role of the Claims Engine](The-Role-of-the-Claims-Engine.md). Дополнительные сведения об обработке наборов правил утверждений см. в разделе [The Role of the Claims Pipeline](The-Role-of-the-Claims-Pipeline.md).  
  
## <a name="pass-through-all-claim-values"></a>Пропуск всех значений утверждений  
При использовании этого действия все значения входящих утверждений, соответствующие указанному типу входящего утверждения, сопоставляются с указанным типом исходящего утверждения перед их отправкой в качестве исходящих утверждений в токены, подписанные вашей службой федерации.  
  
Например, если правило установлено с **пропуск всех значений утверждений** вариантом логики и входящего утверждения и тип группы и указанный тип исходящего утверждения роли, все значения входящих утверждений, поступающие от издателя по отдельности копируются в новые исходящие утверждения с типом роли.  
  
## <a name="transforming-a-claim"></a>Преобразование утверждения  
В AD FS, термин *преобразование утверждений* означает замену одного входящего утверждения на значение другого исходящего утверждения значение. Это правило входящего утверждения, делающий эту функцию возможной преобразования. В свойствах этого правила можно задать условия для замены входящих значений на значение другого исходящего утверждения на основе указанного типа входящего утверждения.  
  
Например как показано на следующем рисунке, когда правило с условием замены входящего значения на значение другого исходящего утверждения, все входящие утверждения с типом группы сопоставляются с новыми типами исходящих утверждений роли. В этом случае значение входящего утверждения покупатель заменяется на новый значение исходящего утверждения администратора.  
  
![Когда следует использовать преобразование](media/adfs2_transform.gif)  
  
Можно также использовать это правило для применения условия, которое приведет к замене всех входящих утверждений с указанным e\ почты значением суффикса с новым значением. Например можно задать условия в это правило для изменения всех значений утверждений с суффиксом sales.corp.fabrikam.com на fabrikam.com.  
  
## <a name="configuring-this-rule-on-a-claims-provider-trust"></a>Настройка этого правила для отношения доверия с поставщиком утверждений  
При использовании отношения доверия с поставщиком утверждений это правило можно настроить для преобразования входящих утверждений от поставщика утверждений в надежные эквиваленты. Типы утверждений или значения утверждений могут иметь другое значение в вашей организации, чем в организациях поставщика утверждений. Это правило можно использовать для нормализации типов и значений утверждений, полученных от поставщика утверждений, чтобы проверяющая сторона могла понимать их эквиваленты исходящих утверждений.  
  
## <a name="configuring-this-rule-on-a-relying-party-trust"></a>Настройка этого правила для отношения доверия с проверяющей стороной  
При использовании отношения доверия с проверяющей стороной это правило можно настроить для преобразования утверждений для определенной проверяющей стороны. Типы утверждений или утверждений значения могут иметь другое значение для определенной проверяющей стороны, и это правило позволяет изменять значения и типами исходящих утверждений для одной проверяющей стороны.  
  
## <a name="how-to-create-this-rule"></a>Создание правила  
При создании правила с помощью языка правил утверждений или **преобразование входящего утверждения** шаблона правила в управления AD FS оснастка. Этот шаблон правила предоставляет следующие параметры конфигурации:  
  
-   Указание имени правила утверждения  
  
-   Преобразование определенного типа входящего утверждения в указанный тип исходящего утверждения  
  
-   Пропуск всех значений утверждений  
  
-   Замените значение входящего утверждения на значение другого исходящего утверждения  
  
-   Замена суффикса e\ почты входящих утверждений новым суффиксом электронной почты e\  
  
Дополнительные инструкции по созданию этого шаблона см. в разделе [Создание правила для преобразования входящего утверждения](https://technet.microsoft.com/library/dd807068.aspx) в руководстве по развертыванию AD FS.  
  
## <a name="using-the-claim-rule-language"></a>С помощью языка правил утверждений  
Если исходящее утверждение должно состоять из содержимого нескольких входящих утверждений, вместо этого необходимо использовать настраиваемое правило. Если значение исходящего утверждения должно строиться на значении входящего утверждения, но с дополнительным содержимым — в этом контексте также следует использовать настраиваемое правило. Дополнительные сведения см. в разделе [When to Use a Custom Claim Rule](When-to-Use-a-Custom-Claim-Rule.md).  
  
### <a name="examples-of-how-to-construct-a-transform-rule-syntax"></a>Примеры создания синтаксиса правила преобразования  
При использовании синтаксиса языка правил утверждений для преобразования утверждений, можно задать в свойстве преобразованного утверждения новое литеральное значение. Например следующее правило изменяет значение утверждений роли с «Администраторы» на «корневой», сохраняя при этом тот же тип утверждения:  
  
```  
c:[type == “https://schemas.microsoft.com/ws/2008/06/identity/claims/role”, value == “Administrators”]  => issue(type = c.type, value = “root”);  
```  
  
Регулярные выражения также может использоваться для преобразования утверждений. Например следующее правило будет задавать в утверждениях имени пользователя windows в формате домен\пользователь для компании FABRIKAM домен:  
  
```  
c:[type == "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name"] => issue(type = c.type, value = regexreplace(c.value, "(?<domain>[^\\]+)\\(?<user>.+)", "FABRIKAM\${user}"));  
```  
  
### <a name="best-practices-for-creating-custom-rules"></a>Рекомендации по созданию настраиваемых правил  
Преобразования утверждений можно выборочно применять к утверждениям, выбранным с помощью основных возможностей фильтрации. Каждому из свойств утверждения, используемых для фильтрации можно присвоить значения, со следующими оговорками:  
  
|Свойство утверждения|Описание|  
|------------------|---------------|  
|Введите значение, ValueType|Эти свойства будут чаще всего используются для назначения. Минимум тип и значение должны быть заданы для итогового преобразованного утверждения.|  
|Издатель|Хотя язык правил утверждений позволяет настроить издателя утверждения, это обычно не рекомендуется. Издатель утверждения не сериализуется в токене. При получении токена свойству Issuer всех утверждений присваивается идентификатор сервера федерации, подписавшего токен. Таким образом настройка издателя утверждения в правилах не повлияет на содержимое токена, и параметр будет потеряна после упаковки утверждения в токене. Единственный сценарий, где настройка издателя утверждения имеет смысл, — когда задано конкретное значение в наборе правил поставщика утверждений и правил проверяющей стороны набор создается из правил, которые ссылаются на это конкретное значение. Если свойству Issuer явно не присвоено значение в правиле утверждения, подсистема выдачи утверждений устанавливает значение «ЛОКАЛЬНЫЙ АДМИНИСТРАТОР».|  
|OriginalIssuer|Как и свойству Issuer, свойству OriginalIssuer следует обычно не назначается явно значение. В отличие от Issuer, свойство OriginalIssuer сериализуется в токене, но потребители токена ожидают, что, если задано, то будет содержать идентификатор сервера федерации, изначально выдавшего утверждение.|  
|Свойства|Как описано в предыдущем разделе, контейнер свойств утверждения не сохраняется в токене, поэтому назначения свойств должны выполняться, только если последующие локальные политики будут ссылаться на данные, хранящиеся в свойстве.|  
  
Дополнительные сведения об использовании языка правил утверждений см. в разделе [роль языка правил утверждений](The-Role-of-the-Claim-Rule-Language.md).  
  

