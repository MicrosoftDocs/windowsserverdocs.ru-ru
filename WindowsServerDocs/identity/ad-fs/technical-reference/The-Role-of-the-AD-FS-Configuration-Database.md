---
ms.assetid: 68db7f26-d6e3-4e67-859b-80f352e6ab6a
title: Роль базы данных конфигурации AD FS
description: ''
author: billmath
ms.author: billmath
manager: femila
ms.date: 05/31/2017
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: identity-adfs
ms.openlocfilehash: 40f1f4952730fad0749a173fdc968714d043b1c1
ms.sourcegitcommit: 0b5fd4dc4148b92480db04e4dc22e139dcff8582
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/24/2019
ms.locfileid: "66188508"
---
# <a name="the-role-of-the-ad-fs-configuration-database"></a>Роль базы данных конфигурации AD FS
База данных конфигурации AD FS хранит все данные конфигурации, которые представляет один экземпляр служб федерации Active Directory \(AD FS\) \(службу федерации\). База данных конфигурации AD FS определяет набор параметров, необходимых службе федерации для идентификации партнеров, сертификатов, хранилищ атрибутов, утверждений и разнообразных данных об этих связанных сущностях. Эти данные конфигурации можно хранить в базу данных Microsoft SQL Server® или внутреннюю базу Windows \(WID\) функция, которая входит в состав Windows Server® 2008, Windows Server 2008 R2 и Windows Server® 2012.  
  
> [!NOTE]  
> Все содержимое базы данных конфигурации AD FS может храниться в экземпляре внутренней базы данных Windows или экземпляре базы данных SQL, но не в обоих одновременно. Следовательно, некоторые серверы федерации не могут использовать внутреннюю базу данных Windows, а другие — базу данных SQL Server для одного и того же экземпляра базы данных конфигурации AD FS.  
  
Для изучения преимуществ и недостатков использования внутренней базы данных Windows или SQL Server для хранения базы данных конфигурации AD FS воспользуйтесь информацией в этом разделе и материалами статьи [Некоторые аспекты топологии развертывания AD FS](https://technet.microsoft.com/library/gg982489.aspx).  
  
Внутренняя база данных Windows использует реляционное хранилище данных и не имеет свой собственный пользовательский интерфейс управления \(пользовательского интерфейса\). Вместо этого администраторы могут изменять содержимое базы данных конфигурации AD FS с помощью либо оснастки управления AD FS\-в Fsconfig.exe, или Windows PowerShell™ командлетов.  
  
## <a name="using-wid-to-store-the-ad-fs-configuration-database"></a>Использование внутренней базы данных Windows для хранения базы данных конфигурации AD FS  
Можно создавать базы данных конфигурации AD FS, используя WID в качестве хранилища либо при помощи команды Fsconfig.exe\-строки или мастер настройки сервера AD FS федерации. При использовании любого из этих инструментов можно выбрать любой перечисленный ниже вариант для создания топологии сервера федерации. В каждом из этих вариантов внутренняя база данных Windows используется для хранения базы данных конфигурации AD FS.  
  
-   Создать автономный\-сервера только федерации  
  
-   Создание первого сервера федерации на ферме серверов федерации  
  
-   Добавление сервера федерации в ферму серверов федерации  
  
При выборе автономном\-только параметр, внутренней базы данных Windows используется для хранения отдельного экземпляра базы данных конфигурации AD FS. Этот экземпляр не может совместно использоваться несколькими серверами федерации. Он предназначен исключительно для тестовых лабораторных сред. Дополнительные сведения об автономном\-отдельно параметр сервера федерации или как процедура настройки, см. в разделе [автономного федерации сервера с использованием WID](https://technet.microsoft.com/library/gg982486.aspx) или [Создание автономного сервера федерации](https://technet.microsoft.com/library/ee913579.aspx).  
  
Если выбран первый сервер федерации в варианте, предполагающем создание фермы серверов федерации, внутренняя база данных Windows настраивается так, чтобы ее масштабируемость позволяла впоследствии добавлять дополнительные серверы федерации в ферму. Дополнительные сведения о развертывании и настройке фермы внутренней базы данных Windows см. в статье [Ферма серверов федерации с использованием внутренней базы данных Windows](https://technet.microsoft.com/library/gg982492.aspx) или [Создание первого сервера федерации на ферме серверов федерации](https://technet.microsoft.com/library/dd807070.aspx)  
  
Если выбран вариант с добавлением сервера федерации, внутренняя база данных Windows настраивается так, чтобы реплицировать изменения в базе данных конфигурации на новый сервер федерации с заданными интервалами. Дополнительные сведения о добавлении сервера федерации на ферму внутренней базы данных Windows см. в статье [Ферма серверов федерации с использованием внутренней базы данных Windows](https://technet.microsoft.com/library/gg982492.aspx) или [Добавление сервера федерации на ферму серверов федерации](https://technet.microsoft.com/library/ee913575.aspx).  
  
> [!NOTE]  
> При развертывании фермы серверов федерации с использованием WID, некоторые возможности AD FS может оказаться недоступными. Для получения доступа к полному набору функций при настройке фермы серверов можно использовать Microsoft SQL Server для хранения базы данных конфигурации AD FS. Дополнительные сведения см. в разделе [Некоторые аспекты топологии развертывания AD FS](https://technet.microsoft.com/library/gg982489(v=ws.11).aspx).  
  
### <a name="how-a-wid-federation-server-farm-works"></a>Принципы работы фермы серверов федерации внутренней базы данных Windows  
В этом разделе описываются важные концептуальные принципы, описывающие репликацию данных фермой серверов федерации на основе внутренней базы данных Windows между основным сервером федерации и вторичными серверами федерации. .  
  
#### <a name="primary-federation-server"></a>Основной сервер федерации  
Основной сервер федерации — компьютер под управлением Windows Server 2008, Windows Server 2008 R2 или Windows Server® 2012, настроенный в роли сервера федерации с помощью мастера настройки сервера AD FS федерации и который имеет копию чтения и записи в AD FS База данных конфигурации. Основной сервер федерации всегда создается при использовании мастера конфигурации федерации сервера AD FS и выберите параметр для создания новой службы федерации и сделать этот компьютер первого сервера федерации в ферме. Все остальные серверы федерации на этой ферме, также известные как вторичные серверы федерации, должны синхронизировать изменения, внесенные на основном сервере федерации, в копию базы данных конфигурации AD FS, которая хранится локально.  
  
#### <a name="secondary-federation-servers"></a>Вторичные серверы федерации  
Вторичные серверы федерации хранится экземпляр базы данных конфигурации AD FS с основного сервера федерации, но эти копии считываются\-только. Вторичные серверы федерации подключаются к основному серверу федерации на ферме и синхронизируют с ним данные, опрашивая сервер на предмет изменения данных с регулярными интервалами Вторичные серверы федерации существует для обеспечения отказоустойчивости для основного сервера федерации действуя загрузить\-сбалансировать запросы на доступ, выполненных в различных сайтах в сетевой среде организации.  
  
> [!NOTE]  
> Если происходит сбой основного сервера федерации и он отключается от сети, все вторичные серверы федерации продолжают обрабатывать запросы в штатном режиме. Однако до тех пор, пока основной сервер федерации не будет снова подключен к сети, внести изменения в службу федерации невозможно. С помощью Windows PowerShell можно назначить вторичный сервер федерации основным. Дополнительные сведения см. в разделе [Администрирование AD FS с помощью Windows PowerShell](https://go.microsoft.com/fwlink/?LinkID=179634).  
  
#### <a name="how-the-adfs-configuration-database-is-synchronized"></a>Методы синхронизации базы данных конфигурации AD FS  
Из-за базы данных конфигурации AD FS играет важную роль, он станет доступен на всех серверах федерации в сети для обеспечения отказоустойчивости и нагрузки\-Балансировка нагрузки при обработке запросов \(при сетевой нагрузки\-используются подсистемы балансировки\). Однако для того чтобы вторичные серверы федерации можно было использовать таким образом, необходимо синхронизировать базу данных конфигурации AD FS, хранимую на основном сервере федерации.  
  
При добавлении сервера федерации на ферму новый компьютер, который станет вторичным сервером федерации, подключается к основному серверу федерации, чтобы реплицировать экземпляр базы данных конфигурации AD FS. С этого момента новый сервер федерации продолжает регулярно извлекать обновления с основного сервера федерации, как показано на следующем рисунке.  
  
![Роли AD FS](media/adfs2_WID.png)  
  
Каждый вторичный сервер федерации каждые пять минут опрашивает основной сервер федерации на наличие изменений. Вы можете настроить это значение по умолчанию пять\-точные значения, или в любое время принудительно выполнить немедленную синхронизацию с помощью командлета Windows PowerShell. Дополнительные сведения о том, как это сделать, см. в разделе [Администрирование AD FS с помощью Windows PowerShell](https://go.microsoft.com/fwlink/?LinkID=179634).  
  
Процесс синхронизации внутренней базы данных Windows также поддерживает поэтапные переносы, повышая эффективность переноса промежуточных изменений. Процесс поэтапного переноса требует существенно меньше трафика в сети, переносы выполняются гораздо быстрее.  
  
> [!NOTE]  
> Поддерживается перенос базы данных конфигурации AD FS из внутренней базы данных Windows в экземпляр SQL Server. Дополнительные сведения о том, как это сделать, см. в разделе [AD FS: Перенос базы данных конфигурации AD FS в SQL Server](https://go.microsoft.com/fwlink/?LinkId=192232) на сайте TechNet Wiki.  
  
## <a name="using-sql-server-to-store-the-ad-fs-configuration-database"></a>Использование SQL Server для хранения базы данных конфигурации AD FS  
Можно создать базу данных конфигурации AD FS, используя один экземпляр базы данных SQL Server в качестве хранилища с помощью команды Fsconfig.exe\-линия. Использование базы данных SQL Server в качестве базы данных конфигурации AD FS имеет следующие преимущества по сравнению с внутренней базой данных Windows.  
  
-   Администраторы могут использовать функции обеспечения высокой доступности в составе SQL Server  
  
-   Система предоставляет возможность увеличения производительности для обработки большого трафика.  
  
-   Он обеспечивает функциональную поддержку разрешения артефактов SAML и SAML/WS\-обнаружение воспроизведения токенов федерации \(описанных ниже\).  
  
Термин "основной сервер федерации" неприменим, если база данных конфигурации AD FS хранится в экземпляре базы данных SQL, поскольку все серверы федерации могут в равной степени считывать и осуществлять запись в базу данных конфигурации AD FS, использующую тот же кластеризованный экземпляр SQL Server, что показан на следующей иллюстрации.  
  
![Роли AD FS](media/adfs2_SQL.png)  
  
SQL Server можно использовать для настройки двух или более серверов для совместной работы в кластер серверов, чтобы убедиться, что AD FS это обеспечит высокую доступность, для обслуживания входящих клиентских запросов. Высокая доступность предоставляет масштабируемый\-out архитектуры, в котором можно увеличить емкость сервера путем добавления новых серверов. Отдельные точки сбоя компенсируются автоматической отработкой отказа.  
  
Можно достигнуть высокой доступности с помощью сетевой нагрузки\-балансировки и отработки отказа служб, обеспечивающих технологии кластеризации SQL. Дополнительные сведения о настройке SQL Server для обеспечения высокой доступности см. в разделе [Обзор решений высокой доступности](https://go.microsoft.com/fwlink/?LinkId=179853).  
  
### <a name="saml-artifact-resolution"></a>Разрешение артефактов SAML  
Security Assertion Markup Language \(SAML\) разрешение артефактов — это конечная точка на основе части протокола SAML 2.0, который описывает, как Доверяющая сторона может получать маркер непосредственно из поставщика утверждений. На первом этапе процесса разрешения клиент браузера связывается с сервером федерации ресурсов и предоставляет тому артефакт. На втором этапе серверы федерации ресурсов отправляют артефакт на URL-адрес конечной точки артефактов SAML, расположенный где-то в партнерской организации по учетным записям, чтобы разрешить сообщение артефакта. На заключительном этапе сервер федерации учетных записей издает токен серверу федерации от имени клиента браузера.  
  
> [!NOTE]  
> Если вы являетесь администратором в организации партнера по учетным записям, не забудьте назначить или привязать SSL-сертификат, который связан с корневым сертификатом участника программы корневых сертификатов Windows, веб-сайту пассивной федерации в службах IIS \( <ComputerName> \\Сайты\\Default Web Site\\adfs\\ls\) на всех серверах федерации учетной записи фермы. Важно не допустить добавления серверами федерации ресурсов SSL-сертификата в хранилище сертификатов "Доверенные лица локальных компьютеров" вручную. Кроме того, не должно возникать ситуаций, когда система не в состоянии разрешить артефакт, опубликованный в организации.  
  
### <a name="samlws---federation-token-replay-detection"></a>SAML/WS - Federation обнаружение воспроизведения токенов  
Термин *воспроизведение токенов* относится к действию, когда браузерный клиент в партнерской организации по учетным записям пытается отправить тот же токен, который он получает от сервера федерации учетных записей, несколько раз, чтобы аутентифицировать сервер федерации ресурсов.  Это происходит, когда пользователь нажимает в браузере кнопку **Назад** в попытке повторно отправить страницу аутентификации.  
  
AD FS предоставляет функциональную возможность, получившую название *обнаружение воспроизведения токенов*, с помощью которой можно обнаружить и пресечь множественные запросы токенов с использованием одного и того же токена. Если эта функция включена, обнаружение воспроизведения токенов защищает целостность запросы проверки подлинности в обоих WS\-Federation passive profile и профиле SAML WebSSO, убедившись, что тот же токен никогда не используется более одного раза. Эту функцию следует включать в ситуациях, когда нужна повышенная безопасность, например при работе с киосками.  
  
В случае с киосками пользователь может выполнить выход из системы на всех веб-сайтах, а затем злоумышленник может попытаться использовать историю браузера для повторной отправки страницы федерированной аутентификации, загруженной предыдущим пользователем. Эта функция решает проблему, сохраняя дополнительную информацию о каждой успешной попытке аутентификации партнерской организацией по учетным записям с целью обнаружения последующего воспроизведения токена и предотвращения попыток множественной аутентификации.  
  

