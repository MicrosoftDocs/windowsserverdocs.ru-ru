---
ms.assetid: 68db7f26-d6e3-4e67-859b-80f352e6ab6a
title: "Роль базы данных конфигурации AD FS"
description: 
author: billmath
ms.author: billmath
manager: femila
ms.date: 05/31/2017
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: identity-adfs
ms.openlocfilehash: 3372e1f051ba7f900753a4961d948ddabdef6f4d
ms.sourcegitcommit: db290fa07e9d50686667bfba3969e20377548504
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/12/2017
---
>Область применения: Windows Server 2016, Windows Server 2012 R2, Windows Server 2012

# <a name="the-role-of-the-ad-fs-configuration-database"></a>Роль базы данных конфигурации AD FS
База данных конфигурации AD FS хранит все данные конфигурации, представляющие отдельный экземпляр \(AD FS\) \(that is, the Federation Service\) служб федерации Active Directory. База данных конфигурации AD FS определяет набор параметров, необходимых для службы федерации для идентификации партнеров, сертификатов, хранилищ атрибутов, утверждений и разнообразных данных об этих связанных сущностях. Эти данные конфигурации можно сохранить в базе данных Microsoft SQL Server® или функция \(WID\) внутренней базы данных Windows, которая входит в состав Windows Server® 2008, Windows Server 2008 R2 и Windows Server® 2012.  
  
> [!NOTE]  
> Все содержимое базы данных конфигурации AD FS можно храниться в экземпляре внутренней базы данных Windows или экземпляре базы данных SQL, но не того и другого. Это означает, что не может иметь некоторые серверы федерации с использованием WID и другие — базу данных SQL Server для того же экземпляра базы данных конфигурации AD FS.  
  
Можно использовать следующие сведения в этом разделе и материалами в [некоторые аспекты топологии развертывания AD FS](https://technet.microsoft.com/library/gg982489.aspx) для изучения преимуществ и недостатков использования внутренней базы данных Windows или SQL Server для хранения базы данных конфигурации AD FS:  
  
Использует WID хранения реляционных данных и не имеют свою собственную управления пользовательского интерфейса \(UI\). Вместо этого администраторы могут изменять содержимое базы данных конфигурации службы федерации Active Directory с помощью управления AD FS в snap\, Fsconfig.exe или Windows PowerShell™ командлетов.  
  
## <a name="using-wid-to-store-the-ad-fs-configuration-database"></a>Использование внутренней базы данных Windows для хранения базы данных конфигурации AD FS  
Можно создать базу данных конфигурации Служб федерации Active Directory с использованием WID как хранилище с помощью программы командной строки Fsconfig.exe или мастер настройки сервера AD FS федерации. При использовании любого из этих инструментов можно выбрать любой из следующих вариантов для создания топологии сервера федерации. Каждый из этих параметров используется внутренней базы данных Windows для хранения базы данных конфигурации AD FS.  
  
-   Создание сервера федерации отдельной  
  
-   Создание первого сервера федерации в ферме серверов федерации  
  
-   Добавление сервера федерации в ферму серверов федерации  
  
Если выбрать параметр отдельной внутренней базы данных Windows используется для хранения отдельного экземпляра базы данных конфигурации AD FS. Этот экземпляр не может совместно использоваться несколькими серверами федерации. Он предназначен исключительно для тестовых лабораторных сред. Дополнительные сведения о параметр сервера федерации отдельной или настройки в разделе [автономного федерации сервера с помощью WID](https://technet.microsoft.com/library/gg982486.aspx) или [Создание автономного сервера федерации](https://technet.microsoft.com/library/ee913579.aspx).  
  
При выборе первого сервера федерации в варианте фермы серверов федерации внутренней базы данных Windows настраивается для масштабируемость позволяла дополнительные серверы федерации в ферму нужно добавить на более позднее время. Дополнительные сведения о развертывании фермы внутренней базы данных Windows для настройки в разделе [федерации сервер фермы с использованием WID](https://technet.microsoft.com/library/gg982492.aspx) или [создание первого сервера федерации в ферме серверов федерации](https://technet.microsoft.com/library/dd807070.aspx)  
  
Если выбран вариант сервера федерации с добавлением внутренней базы данных Windows настраивается для репликации базы данных изменения конфигурации на новый сервер федерации через заданные интервалы времени. Дополнительные сведения о добавлении сервера федерации на ферму внутренней базы данных Windows см. в разделе [федерации сервер фермы с использованием WID](https://technet.microsoft.com/library/gg982492.aspx) или [добавить сервер федерации в ферме серверов федерации](https://technet.microsoft.com/library/ee913575.aspx).  
  
> [!NOTE]  
> При развертывании фермы серверов федерации с использованием внутренней базы данных Windows некоторые функции службы федерации Active Directory могут оказаться недоступными. Для получения доступа к полному набору функций при настройке фермы серверов, можно использовать Microsoft SQL Server для хранения базы данных конфигурации AD FS. Дополнительные сведения см. в разделе [некоторые аспекты топологии развертывания AD FS](https://technet.microsoft.com/library/gg982489(v=ws.11).aspx).  
  
### <a name="how-a-wid-federation-server-farm-works"></a>Принципы работы фермы серверов федерации внутренней базы данных Windows  
В этом разделе описываются важные концептуальные принципы, описывающие репликацию данных между основным сервером федерации и вторичными серверами федерации фермы серверов федерации внутренней базы данных Windows. .  
  
#### <a name="primary-federation-server"></a>Основной сервер федерации  
Основной сервер федерации — компьютер под управлением Windows Server 2008, Windows Server 2008 R2 или Windows Server® 2012, настроенный в роли сервера федерации с использованием мастера конфигурации сервера AD FS федерации и который имеет чтения и записи копия базы данных конфигурации AD FS. Основной сервер федерации всегда создается при использовании мастера конфигурации сервера AD FS федерации и выберите параметр для создания новой службы федерации и сделать этот компьютер первого сервера федерации в ферме. Все остальные серверы федерации на этой ферме, также известные как вторичные серверы федерации, должны синхронизировать изменения, внесенные на основном сервере федерации в копию базы данных конфигурации AD FS, которая хранится локально.  
  
#### <a name="secondary-federation-servers"></a>Вторичные серверы федерации  
Вторичные серверы федерации хранится копия базы данных конфигурации AD FS с основного сервера федерации, однако эти экземпляры доступны только для чтения. Вторичные серверы федерации подключения и синхронизации данных с основного сервера федерации в ферме, опрашивая сервер через регулярные интервалы для проверки того, изменились ли данные. Существует вторичные серверы федерации обеспечивают отказоустойчивость основного сервера федерации балансируют для load\ запросов на доступ, поступающих с разных сайтов в сетевой среде.  
  
> [!NOTE]  
> Если происходит сбой основного сервера федерации и находится в автономном режиме, все вторичные серверы федерации продолжают обрабатывать запросы в штатном режиме. Тем не менее не новый внести изменения в службу федерации пока основной сервер федерации будет подключен. Можно назначить вторичный сервер федерации в качестве основного сервера федерации с помощью Windows PowerShell. Дополнительные сведения см. в разделе [Администрирование AD FS с помощью Windows PowerShell](https://go.microsoft.com/fwlink/?LinkID=179634).  
  
#### <a name="how-the-ad-fs-configuration-database-is-synchronized"></a>Методы синхронизации базы данных конфигурации AD FS  
Из-за база данных конфигурации AD FS играет важную роль, она доступна на всех серверах федерации в сети для обеспечения отказоустойчивости и балансировки нагрузки load\ нагрузки при обработке запросов \ (когда подсистем балансировки сети load\ являются used\). Однако для того чтобы вторичные серверы федерации использовать таким образом, необходимо синхронизировать базы данных конфигурации AD FS, который хранится на основном сервере федерации.  
  
При добавлении сервера федерации в ферму новый компьютер, который станет вторичным сервером федерации подключается к основной сервер федерации чтобы реплицировать экземпляр базы данных конфигурации AD FS. С этого момента новый сервер федерации продолжает извлекать обновления с основного сервера федерации на регулярной основе, как показано на следующем рисунке.  
  
![Роли AD FS](media/adfs2_WID.png)  
  
Каждый дополнительный сервер федерации опрашивает основной сервер федерации каждые пять минут для изменения. Можно скорректировать это значение по умолчанию five\ минут или в любое время принудительно выполнить немедленную синхронизацию для этого с помощью командлета Windows PowerShell. Дополнительные сведения о том, как это сделать см. в разделе [Администрирование AD FS с помощью Windows PowerShell](https://go.microsoft.com/fwlink/?LinkID=179634).  
  
Процесс синхронизации внутренней базы данных Windows также поддерживает поэтапные переносы, повышая эффективность переноса промежуточных изменений. Процесс поэтапного переноса требует существенно меньше трафика в сети и переносы выполняются гораздо быстрее.  
  
> [!NOTE]  
> Поддерживается миграция конфигурации базы данных AD FS из внутренней базы данных Windows на экземпляре SQL Server. Дополнительные сведения о том, как это сделать см. в разделе [Служб федерации Active Directory: Миграция базы данных конфигурации AD FS на SQL Server](https://go.microsoft.com/fwlink/?LinkId=192232) на сайте TechNet Wiki.  
  
## <a name="using-sql-server-to-store-the-ad-fs-configuration-database"></a>Использование SQL Server для хранения базы данных конфигурации AD FS  
Можно создать базы данных конфигурации AD FS, воспользовавшись одним экземпляром базы данных SQL Server как хранилище с помощью средства командной строки Fsconfig.exe. Использование базы данных SQL Server для базы данных конфигурации AD FS обеспечивает следующие преимущества по сравнению внутренней базы данных Windows.  
  
-   Администраторы могут использовать функции обеспечения высокой доступности сервера SQL Server  
  
-   Он предоставляет возможность увеличения производительности для обработки большого трафика.  
  
-   Система обеспечивает функциональную поддержку разрешения артефактов SAML и \(described below\) обнаружение воспроизведения токенов SAML и наличия WS-Federation.  
  
Термин «основной сервер федерации» неприменим, если базы данных конфигурации AD FS хранится в экземпляре базы данных SQL, поскольку все серверы федерации могут одинаково чтения и записи в базу данных конфигурации AD FS, используемая же кластеризованный экземпляр SQL Server, как показано на следующем рисунке.  
  
![Роли AD FS](media/adfs2_SQL.png)  
  
SQL Server можно использовать для настройки двух или более серверов для совместной работы в качестве кластера серверов, чтобы убедиться, что службы федерации Active Directory это обеспечит высокую доступность для обработки поступающих клиентских запросов. Высокая доступность предоставляет scale\ out архитектуры, в котором можно увеличивать производительность сервера путем добавления дополнительных серверов. Отдельные точки сбоя компенсируются автоматической отработкой отказа.  
  
Можно добиться высокого уровня доступности с помощью load\ Балансировка и отказоустойчивых служб, которые предоставляют технологии кластеризации SQL. Дополнительные сведения о настройке SQL Server для обеспечения высокой доступности см. в разделе [Обзор решений высокой доступности](https://go.microsoft.com/fwlink/?LinkId=179853).  
  
### <a name="saml-artifact-resolution"></a>Разрешение артефактов SAML  
Разрешение артефактов Security Assertion Markup Language \(SAML\) — это конечная точка на основе части протокола SAML 2.0, которая описывает возможные способы извлечения проверяющей стороной токена непосредственно от поставщика утверждений. На первом этапе процесса разрешения клиент браузера связывается с сервером федерации ресурсов и предоставляет тому артефакт. На втором этапе серверы федерации ресурсов отправляют артефакт на URL конечной точки артефактов SAML, расположенный где-то в организации партнера по учетным записям, чтобы разрешить сообщение артефакта. На заключительном этапе сервер федерации учетных записей издает маркер к серверу федерации от имени клиента браузера.  
  
> [!NOTE]  
> Если вы являетесь администратором в организации партнера по учетным записям, убедитесь, что для назначения или привязать SSL-сертификат, который связан с корневым сертификатом участника программы корневых сертификатов Windows, к веб-сайту пассивной федерации в IIS \ (<ComputerName>\\Sites\\Default WebSite\\adfs\\ls\) на всех серверах федерации учетных записей на ферме. Это важно предотвратить серверы федерации ресурсов не нужно вручную добавить SSL-сертификат в хранилище сертификатов "Доверенные лица локальных компьютеров", а не сможет разрешить артефакт, опубликованный в организации.  
  
### <a name="samlws---federation-token-replay-detection"></a>SAML и WS - Federation обнаружение воспроизведения токенов  
Термин *воспроизведения токена* относится к действию, когда браузерный клиент в организации партнера по учетным записям пытается отправить тот же токен получает от сервера федерации учетных записей несколько раз, для проверки подлинности на сервер федерации ресурсов.  Это происходит, когда пользователь нажимает **Назад** в попытке повторно отправить страницу аутентификации браузере кнопку.  
  
AD FS предоставляет функциональную возможность, получившую *обнаружение воспроизведения токена*, какие множественные запросы токенов с использованием того же токена может быть обнаружено и затем удаляется. Если эта функция включена, обнаружение воспроизведения токенов защищает целостность аутентификационных запросов в пассивном профиле наличия WS-Federation и профиле SAML WebSSO, убедившись, что один токен никогда не используется несколько раз. Эту функцию следует включать в ситуациях, когда нужна Повышенная безопасность таких как при работе с киосками.  
  
В примере терминала пользователь может выйти из всех веб-сайтов, а затем пользователь-злоумышленник может попытаться использовать историю браузера для повторной отправки страницы федерированной аутентификации, загруженной предыдущим пользователем. Эта функция решает проблему, сохраняя дополнительную информацию о каждой успешной попытке аутентификации в организации партнера по учетным записям целью обнаружения последующего воспроизведения токена и предотвращения попыток проверки подлинности позволяет успешно выполнить.  
  

