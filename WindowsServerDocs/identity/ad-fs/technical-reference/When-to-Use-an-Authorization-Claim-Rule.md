---
ms.assetid: b734cbcb-342c-4a28-8ab5-b9cd990bb1c2
title: Использование правила для утверждений авторизации
author: billmath
ms.author: billmath
manager: femila
ms.date: 05/31/2017
ms.topic: article
ms.prod: windows-server
ms.technology: identity-adfs
ms.openlocfilehash: c73b68d67742321ddb79d14b1e24eb574bb22b8c
ms.sourcegitcommit: d5e27c1f2f168a71ae272bebf8f50e1b3ccbcca3
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/23/2020
ms.locfileid: "86961616"
---
# <a name="when-to-use-an-authorization-claim-rule"></a>Использование правила для утверждений авторизации
Это правило можно использовать в службы федерации Active Directory (AD FS) \( AD FS \) , если необходимо получить тип входящего утверждения, а затем применить действие, которое определит, будет ли пользователь разрешать или запрещать доступ на основе значения, указанного в правиле. При использовании этого правила вы проходите или преобразуете утверждения, которые соответствуют следующей логике правила, на основе параметров, которые настраиваются в правиле.  
  
|Параметр правила|Логика правила|  
|---------------|--------------|  
|Разрешить всем пользователям|Если входящее утверждение имеет тип *любой тип утверждения* и значение равно *любое значение*, выдается утверждение со значением *Разрешить*.|  
|Разрешить доступ пользователям с данным входящим утверждением|Если входящее утверждение имеет тип *заданный тип утверждения* и значение равно *заданное значение утверждения*, выдается утверждение со значением *Разрешить*.|  
|Отказать в доступе пользователям с данным входящим утверждением|Если входящее утверждение имеет тип *заданный тип утверждения* и значение равно *заданное значение утверждения*, выдается утверждение со значением *Отказать*.|  
  
В следующих разделах содержатся основные сведения о правилах утверждений и предоставляются дополнительные сведения об использовании этого правила.  
  
## <a name="about-claim-rules"></a>Общие сведения о правилах утверждения  
Правило утверждения представляет экземпляр бизнес-логики, который будет принимать входящее утверждение, применить к нему условие, \( если x then y \) и создать исходящее утверждение на основе параметров условия. В следующем списке перечислены важные рекомендации в отношении правил утверждений, с которыми следует ознакомиться перед прочтением дальнейших сведений в этом разделе.  
  
-   В оснастке управления AD FS \- в правила утверждения можно создавать только с помощью шаблонов правил утверждений.  
  
-   Правила утверждений обрабатывают входящие утверждения либо непосредственно из поставщика утверждений, \( например Active Directory или другой служба Федерации, \) либо из выходных данных правил преобразования принятия в отношении доверия поставщика утверждений.  
  
-   Правила утверждений обрабатываются подсистемой выдачи утверждений в хронологическом порядке в пределах заданного набора правил. Установив приоритет правил, можно дополнительно уточнить или отфильтровать утверждения, созданные предыдущими правилами в данном наборе правил.  
  
-   Шаблоны правил утверждения всегда требуют указывать тип входящего утверждения. Тем не менее, можно обрабатывать несколько значений утверждений с одним типом утверждения, используя одно правило.  
  
Дополнительные сведения о правилах утверждений и наборах правил для утверждений см. [в разделе роль правил утверждений](The-Role-of-Claim-Rules.md). Дополнительные сведения о том, как правила обрабатываются, см. [в разделе роль подсистемы утверждений](The-Role-of-the-Claims-Engine.md). Дополнительные сведения о том, как обрабатываются наборы правил для утверждений, см. [в разделе роль конвейера утверждений](The-Role-of-the-Claims-Pipeline.md).  
  
## <a name="permit-all-users"></a>Разрешить всем пользователям  
При использовании шаблона правила «Разрешить всем пользователям» все пользователи будут иметь доступ к проверяющей стороне. Однако вы можете использовать дополнительные правила авторизации для ограничения доступа. Если одно правило разрешает пользователю доступ к проверяющей стороне, а другое правило запрещает этот доступ, результат «запретить» переопределяет результат «разрешить» и пользователь получает отказ в доступе.  
  
Пользователи, которым разрешен доступ к проверяющей стороне из службы федерации, все еще могут получить отказ в обслуживании проверяющей стороной.  
  
## <a name="permit-access-to-users-with-this-incoming-claim"></a>Разрешить доступ пользователям с данным входящим утверждением  
При использовании шаблона разрешить или запрещать пользователей, основанных на входящем шаблоне правила утверждений для создания правила и установки условия "разрешить", можно разрешить определенному пользователю доступ к проверяющей стороне на основе типа и значения входящего утверждения. Например, можно использовать этот шаблон правила, чтобы создать правило, которое разрешает доступ только пользователям, имеющим утверждение о группе со значением «Администраторы домена». Если одно правило разрешает пользователю доступ к проверяющей стороне, а другое правило запрещает этот доступ, результат «запретить» переопределяет результат «разрешить» и пользователь получает отказ в доступе.  
  
Пользователи, которым разрешен доступ к проверяющей стороне из службы федерации, все еще могут получить отказ в обслуживании проверяющей стороной. Если вы хотите разрешить всем пользователям доступ к проверяющей стороне, используйте шаблона правила «Разрешить всем пользователям».  
  
## <a name="deny-access-to-users-with-this-incoming-claim"></a>Отказать в доступе пользователям с данным входящим утверждением  
При использовании шаблона разрешить или запрещать пользователей, основанных на входящем шаблоне правила утверждений, для создания правила и установки условия отказа можно запретить доступ пользователя к проверяющей стороне на основе типа и значения входящего утверждения. Например, можно использовать этот шаблон правила, чтобы создать правило, которое запрещает доступ всем пользователям, имеющим утверждение о группе со значением «Пользователи домена».  
  
Если вы хотите использовать условие запрета, но также предоставить доступ к проверяющей стороне для конкретных пользователей, необходимо позднее явно добавить правила авторизации с условием разрешения, чтобы разрешить этим пользователям доступ к проверяющей стороне.  
  
Если пользователю отказано в доступе, когда подсистема выдачи утверждений обрабатывает набор правил, дальнейшая обработка правил завершается, а AD FS возвращает ошибку "отказано в доступе" для запроса пользователя.  
  
## <a name="authorizing-users"></a>Авторизация пользователей  
В AD FS правила авторизации используются для выдаче утверждения разрешения или отказа, определяющего, будет ли пользователь или группа пользователей, в \( зависимости от используемого типа утверждения, \) получать доступ к \- ресурсам на основе веб-ресурсов в данной проверяющей стороне. Правила авторизации можно настроить только в отношениях доверия с проверяющей стороной.  
  
### <a name="authorization-rule-sets"></a>Наборы правил авторизации  
Разные наборы правил авторизации существуют в зависимости от типа операций разрешения или запрещения, которые требуется настроить. Эти наборы правил включают следующие правила.  
  
-   **Правила авторизации выдачи**. Эти правила определяют, может ли пользователь получать утверждения для проверяющей стороны и, таким образом, получать доступ к ней.  
  
-   **Правила авторизации делегирования**. Эти правила определяют, может ли пользователь выступать от имени другого пользователя для проверяющей стороны. Когда пользователь действует в качестве другого пользователя, утверждения о запрашивающем пользователе по-прежнему помещаются в токен.  
  
-   **Правила авторизации олицетворения**. Эти правила определяют, может ли пользователь полностью олицетворять другого пользователя для проверяющей стороны. Олицетворение другого пользователя — очень мощная возможность, поскольку проверяющая сторона не знает, что пользователь олицетворяется.  
  
Дополнительные сведения о том, как процесс правил авторизации применяется в конвейере выдачи утверждений, см. в разделе «Роль подсистемы выдачи утверждений».  
  
### <a name="supported-claim-types"></a>Поддерживаемые типы утверждений  
AD FS определяет два типа утверждений, которые используются для определения того, разрешен или запрещен пользователь. Ниже приведены универсальные коды ресурсов URI следующих типов утверждений \( \) .  
  
1.  **Разрешите**: http: \/ \/ Schemas.Microsoft.com \/ авторизации \/ утверждений \/  
  
2.  **Deny**: http: \/ \/ Schemas.Microsoft.com \/ authorization \/ claims \/ Deny  
  
## <a name="how-to-create-this-rule"></a>Создание правила  
Вы можете создать оба правила авторизации либо с помощью языка правил утверждений, либо с помощью шаблона правила **Разрешить все пользователи** или **Разрешить или запретить пользователям на основе шаблона правила входящего утверждения** в оснастке управления AD FS \- в. Шаблон правила «Разрешить всем пользователям» не поддерживает все параметры конфигурации. Однако шаблон правила «Разрешать или запрещать пользователям на основании входящего утверждения» предоставляет следующие параметры конфигурации.  
  
-   указание имени правила утверждения;  
  
-   Укажите тип входящего утверждения  
  
-   Введите значение входящего утверждения  
  
-   Разрешить доступ пользователям с данным входящим утверждением  
  
-   Отказать в доступе пользователям с данным входящим утверждением  
  
Дополнительные инструкции по созданию этого шаблона см. в разделе [Создание правила для разрешения всех пользователей](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/ee913577(v=ws.11)) или [Создание правила для разрешения или запрета доступа пользователей на основе входящего утверждения](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/ee913594(v=ws.11)) в разделе руководство по развертыванию AD FS.  
  
## <a name="using-the-claim-rule-language"></a>С помощью языка правил утверждений  
Если утверждение должно отправляться только в том случае, когда значение утверждения соответствует настраиваемому шаблону, необходимо использовать настраиваемое правило. Дополнительные сведения см. в разделе [When to Use a Custom Claim Rule](When-to-Use-a-Custom-Claim-Rule.md).  
  
### <a name="example-of-how-to-create-an-authorization-rule-based-on-multiple-claims"></a>Пример создания правила авторизации на основе нескольких утверждений  
При использовании синтаксиса языка правил утверждений для авторизации заявок можно также выдавать утверждение на основе наличия нескольких утверждений в исходных заявках пользователя. Следующее правило выдает утверждение авторизации только в том случае, если пользователь является членом группы редакторов и прошел проверку подлинности Windows:  
  
```  
[type == "https://schemas.microsoft.com/ws/2008/06/identity/claims/authenticationmethod",   
value == "urn:federation:authentication:windows" ]  
&& [type == "http://schemas.xmlsoap.org/claims/Group ", value == "editors"]   
=> issue(type = "http://schemas.xmlsoap.org/claims/authZ", value = "Granted");  
```  
  
### <a name="example-of-how-to-create-authorization-rules-that-will-delegate-who-can-create-or-remove-federation-server-proxy-trusts"></a>Пример создания правил авторизации, которые будут делегировать, кто может создавать или удалять отношения доверия прокси-сервера федерации  
Прежде чем служба федерации сможет использовать прокси-сервер федерации для перенаправления клиентских запросов, должны быть установлены отношения доверия между службой федерации и компьютером прокси-сервера федерации. По умолчанию отношение доверия прокси-сервера устанавливается при успешном предоставлении каких-либо из следующих учетных данных в мастер настройки прокси-сервера федерации:  
  
-   учетной записи службы, используемой службой федерации, которую будет защищать прокси-сервер;  
  
-   учетной записи домена Active Directory, которая является членом локальной группы администраторов на всех серверах федерации в ферме серверов федерации.  
  
Если вы хотите указать, какие пользователи могут создавать доверие прокси-сервера для конкретной службы федерации, то можете использовать любой из следующих методов делегирования. Этот список методов находится в порядке приоритета, основанный на AD FS рекомендации группы разработчиков по наиболее безопасным и наименее проблематичным методам делегирования. Необходимо использовать только один из этих методов, в зависимости от потребностей вашей организации.  
  
1.  Создайте группу безопасности домена в Active Directory например \( фспрокситрусткреаторс \) , добавьте эту группу в локальную группу администраторов на каждом из серверов федерации в ферме, а затем добавьте только те учетные записи пользователей, для которых вы хотите делегировать это право в новую группу. Это является предпочтительным методом.  
  
2.  Добавьте учетную запись домена пользователя в группу администраторов на каждом из серверов федерации в ферме.  
  
3.  Если по некоторым причинам вы не можете использовать один из этих методов, то можно также создать правило авторизации для этой цели. Хотя это не рекомендуется — из-за вероятных сложностей, которые могут возникнуть, если это правило не записано правильно — правило настраиваемой авторизации можно использовать для делегирования определенным доменным учетным записям пользователей Active Directory прав создания или даже удаления отношений доверия между всеми прокси-серверами федерации, связанными с данной службой федерации.  
  
    При выборе способа 3 можно использовать следующий синтаксис правила, чтобы выдать утверждение авторизации, которое позволит указать указанного пользователя \( в этом случае, Contoso \\ франкм \) создать отношения доверия для одного или нескольких прокси-серверов федерации с Служба федерации. Это правило необходимо применить с помощью команды Windows PowerShell **Set \- ADFSProperties аддпроксяусоризатионрулес**.  
  
    ```  
    c:[Type == "https://schemas.microsoft.com/ws/2008/06/identity/claims/windowsaccountname", issuer=~"^AD AUTHORITY$" value == "contoso\frankm" ] => issue(Type = "https://schemas.microsoft.com/authorization/claims/permit", Value = "true")  
  
    exists([Type == "https://schemas.microsoft.com/ws/2008/06/identity/claims/groupsid", Value == "S-1-5-32-544", Issuer =~ "^AD AUTHORITY$"])   
    => issue(Type = "https://schemas.microsoft.com/authorization/claims/permit", Value = "true");  
  
    c:[Type == "https://schemas.microsoft.com/ws/2008/06/identity/claims/primarysid", Issuer =~ "^AD AUTHORITY$" ] => issue(store="_ProxyCredentialStore",types=("https://schemas.microsoft.com/authorization/claims/permit"),query="isProxyTrustManagerSid({0})", param= c.Value );  
  
    c:[Type == "https://schemas.microsoft.com/ws/2008/06/identity/claims/proxytrustid", Issuer =~ "^SELF AUTHORITY$" ] => issue(store="_ProxyCredentialStore",types=("https://schemas.microsoft.com/authorization/claims/permit"),query="isProxyTrustProvisioned({0})", param=c.Value );  
    ```  
  
    Если позднее вы захотите удалить этого пользователя, чтобы он больше не мог создавать отношения доверия прокси-сервера, можно вернуться к правилу авторизации доверия прокси-сервера по умолчанию, чтобы удалить право этого пользователя на создание отношений доверия прокси-сервера для службы федерации. Это правило необходимо также применить с помощью команды Windows PowerShell **Set \- ADFSProperties аддпроксяусоризатионрулес**.  
  
    ```  
    exists([Type == "https://schemas.microsoft.com/ws/2008/06/identity/claims/groupsid", Value == "S-1-5-32-544", Issuer =~ "^AD AUTHORITY$"])   
    => issue(Type = "https://schemas.microsoft.com/authorization/claims/permit", Value = "true");  
  
    c:[Type == "https://schemas.microsoft.com/ws/2008/06/identity/claims/primarysid", Issuer =~ "^AD AUTHORITY$" ] => issue(store="_ProxyCredentialStore",types=("https://schemas.microsoft.com/authorization/claims/permit"),query="isProxyTrustManagerSid({0})", param= c.Value );  
  
    c:[Type == "https://schemas.microsoft.com/ws/2008/06/identity/claims/proxytrustid", Issuer =~ "^SELF AUTHORITY$" ] => issue(store="_ProxyCredentialStore",types=("https://schemas.microsoft.com/authorization/claims/permit"),query="isProxyTrustProvisioned({0})", param=c.Value );  
    ```  
  
Дополнительные сведения об использовании языка правил утверждений см. [в разделе роль языка правил утверждений](The-Role-of-the-Claim-Rule-Language.md).  
  
