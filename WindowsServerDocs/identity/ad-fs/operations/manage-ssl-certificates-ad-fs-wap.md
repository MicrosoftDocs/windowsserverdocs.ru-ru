---
ms.assetid: a3f50046-5d48-43d3-b0f8-ac2346b15285
title: Управление SSL-сертификатами в AD FS и WAP в Windows Server 2016
description: Управление SSL-сертификатами в AD FS и WAP в Windows Server 2016
author: jenfieldmsft
ms.author: billmath
manager: samueld
ms.date: 10/02/2017
ms.topic: article
ms.prod: windows-server
ms.technology: identity-adfs
ms.openlocfilehash: 230fdaac28f4766c33e62362ca4c7e4d20f22c8e
ms.sourcegitcommit: 6aff3d88ff22ea141a6ea6572a5ad8dd6321f199
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/27/2019
ms.locfileid: "71357740"
---
# <a name="managing-ssl-certificates-in-ad-fs-and-wap-in-windows-server-2016"></a>Управление SSL-сертификатами в AD FS и WAP в Windows Server 2016



В этой статье описывается, как развернуть новый SSL-сертификат на серверах AD FS и WAP.

>[!NOTE]
>Рекомендуемый способ замены SSL-сертификата, пересылаемого в AD FS ферму, — использование Azure AD Connect.  Дополнительные сведения см. [в статье обновление SSL-сертификата для фермы службы федерации Active Directory (AD FS) (AD FS)](https://docs.microsoft.com/azure/active-directory/connect/active-directory-aadconnectfed-ssl-update) .

## <a name="obtaining-your-ssl-certificates"></a>Получение SSL-сертификатов
Для производственных AD FS ферм рекомендуется использовать общедоступный доверенный SSL-сертификат. Обычно это достигается путем отправки запроса подписи сертификата (CSR) стороннему поставщику сертификатов. Существует множество способов создания CSR, в том числе с компьютера под управлением Windows 7 или более поздней версии. Поставщик должен иметь документацию для этого.

- Убедитесь, что сертификат соответствует [требованиям к сертификатам SSL для AD FS и прокси-приложения](https://technet.microsoft.com/windows-server-docs/identity/ad-fs/overview/AD-FS-2016-Requirements#BKMK_1) .

### <a name="how-many-certificates-are-needed"></a>Сколько сертификатов требуется
Мы рекомендуем использовать общий SSL-сертификат для всех AD FS и прокси серверов. Подробные требования см. в документе [AD FS и требования SSL-сертификата для прокси](https://technet.microsoft.com/windows-server-docs/identity/ad-fs/overview/AD-FS-2016-Requirements#BKMK_1)

### <a name="ssl-certificate-requirements"></a>Требования сертификатов SSL
Требования, включая именование, корневой уровень доверия и расширений, см. в документе [AD FS и требования SSL к сертификатам прокси веб-приложения](https://technet.microsoft.com/windows-server-docs/identity/ad-fs/overview/AD-FS-2016-Requirements#BKMK_1) .

## <a name="replacing-the-ssl-certificate-for-ad-fs"></a>Замена SSL-сертификата для AD FS
> [!NOTE]
> AD FS SSL-сертификат не совпадает с сертификатом связи AD FS службы, найденным в оснастке управления AD FS. Чтобы изменить AD FS SSL-сертификат, потребуется использовать PowerShell.

Сначала определите режим привязки сертификата, в котором выполняются серверы AD FS: привязка проверки подлинности сертификата по умолчанию или альтернативный режим привязки клиента TLS.

### <a name="replacing-the-ssl-certificate-for-ad-fs-running-in-default-certificate-authentication-binding-mode"></a>Замена SSL-сертификата для AD FS, выполняемого в режиме привязки проверки подлинности сертификата по умолчанию
AD FS по умолчанию выполняет проверку подлинности сертификата устройства через порт 443 и проверку подлинности сертификата пользователя через порт 49443 (или настраиваемый порт, не 443).
В этом режиме используйте командлет PowerShell Set-AdfsSslCertificate для управления SSL-сертификатом.

Выполните инструкции ниже.

1. Сначала необходимо получить новый сертификат. Обычно это делается путем отправки запроса подписи сертификата (CSR) сторонним поставщикам сертификатов. Существует множество способов создания CSR, в том числе с компьютера под управлением Windows 7 или более поздней версии. Поставщик должен иметь документацию для этого.

    * Убедитесь, что сертификат соответствует [требованиям к сертификатам SSL для AD FS и прокси-приложения](https://technet.microsoft.com/windows-server-docs/identity/ad-fs/overview/AD-FS-2016-Requirements#BKMK_1) .

1. После получения ответа от поставщика сертификатов импортируйте его в хранилище локального компьютера на каждом AD FS и на прокси-сервере.

1. На сервере- **источнике** AD FS используйте следующий командлет для установки нового SSL-сертификата.

```powershell
Set-AdfsSslCertificate -Thumbprint '<thumbprint of new cert>'
```

Отпечаток сертификата можно найти, выполнив следующую команду:

```powershell
dir Cert:\LocalMachine\My\
```

#### <a name="additional-notes"></a>Дополнительные примечания

* Командлет Set-AdfsSslCertificate является командлетом с несколькими узлами. Это означает, что будет выполнено обновление только с первичного узла и всех узлов фермы. Это новое в сервере 2016. На сервере 2012 R2 необходимо было выполнить Set-AdfsSslCertificate на каждом сервере.
* Командлет Set-AdfsSslCertificate должен выполняться только на сервере-источнике. Сервер первичного сервера должен работать под сервером 2016, и уровень поведения фермы должен быть повышен до 2016.
* Командлет Set-AdfsSslCertificate будет использовать удаленное взаимодействие PowerShell для настройки других серверов AD FS, убедитесь, что порт 5985 (TCP) открыт на других узлах.
* Командлет Set-AdfsSslCertificate предоставит субъекту адфссрв разрешения на чтение закрытым ключам SSL-сертификата. Этот участник представляет службу AD FS. Нет необходимости предоставлять учетной записи службы AD FS доступ на чтение закрытых ключей SSL-сертификата.

### <a name="replacing-the-ssl-certificate-for-ad-fs-running-in-alternate-tls-binding-mode"></a>Замена SSL-сертификата для AD FS, работающего в альтернативном режиме привязки TLS
При настройке в альтернативном режиме клиентской привязки TLS AD FS выполняет проверку подлинности сертификата устройства в порте 443 и проверку подлинности сертификата пользователя на порте 443, а также на другом имени узла. Имя узла сертификата пользователя — это AD FS имя узла, предварительно заданное с помощью "цертаус", например "certauth.fs.contoso.com".
В этом режиме используйте командлет PowerShell Set-Адфсалтернатетлсклиентбиндинг для управления SSL-сертификатом. Это позволит управлять не только альтернативной привязкой клиента TLS, но и всеми другими привязками, для которых AD FS задает SSL-сертификат.

Выполните инструкции ниже.

1. Сначала необходимо получить новый сертификат. Обычно это делается путем отправки запроса подписи сертификата (CSR) сторонним поставщикам сертификатов. Существует множество способов создания CSR, в том числе с компьютера под управлением Windows 7 или более поздней версии. Поставщик должен иметь документацию для этого.

    * Убедитесь, что сертификат соответствует [требованиям к сертификатам SSL для AD FS и прокси-приложения](https://technet.microsoft.com/windows-server-docs/identity/ad-fs/overview/AD-FS-2016-Requirements#BKMK_1) .

1. После получения ответа от поставщика сертификатов импортируйте его в хранилище локального компьютера на каждом AD FS и на прокси-сервере.

1. На сервере- **источнике** AD FS используйте следующий командлет для установки нового SSL-сертификата.

```powershell
Set-AdfsAlternateTlsClientBinding -Thumbprint '<thumbprint of new cert>'
```

Отпечаток сертификата можно найти, выполнив следующую команду:

```powershell
dir Cert:\LocalMachine\My\
```

#### <a name="additional-notes"></a>Дополнительные примечания

* Командлет Set-Адфсалтернатетлсклиентбиндинг является командлетом с несколькими узлами. Это означает, что будет выполнено обновление только с первичного узла и всех узлов фермы.
* Командлет Set-Адфсалтернатетлсклиентбиндинг должен выполняться только на сервере-источнике. Сервер первичного сервера должен работать под сервером 2016, и уровень поведения фермы должен быть повышен до 2016.
* Командлет Set-Адфсалтернатетлсклиентбиндинг будет использовать удаленное взаимодействие PowerShell для настройки других серверов AD FS, убедитесь, что порт 5985 (TCP) открыт на других узлах.
* Командлет Set-Адфсалтернатетлсклиентбиндинг предоставит субъекту адфссрв разрешения на чтение закрытым ключам SSL-сертификата. Этот участник представляет службу AD FS. Нет необходимости предоставлять учетной записи службы AD FS доступ на чтение закрытых ключей SSL-сертификата.

## <a name="replacing-the-ssl-certificate-for-the-web-application-proxy"></a>Замена сертификата SSL для прокси веб-приложения
Чтобы настроить привязку проверки подлинности сертификата по умолчанию или альтернативный режим привязки TLS клиента в WAP, можно использовать командлет Set-Вебаппликатионпроксисслцертификате.
Чтобы заменить сертификат SSL прокси-сервера веб – приложения на **каждом** прокси-сервере, используйте следующий командлет для установки нового сертификата SSL:

```powershell
Set-WebApplicationProxySslCertificate -Thumbprint '<thumbprint of new cert>'
```

Если приведенный выше командлет завершится сбоем, поскольку срок действия старого сертификата уже истек, перенастройте прокси-сервер с помощью следующих командлетов:

```powershell
$cred = Get-Credential
```

Введите учетные данные пользователя домена, который является локальным администратором на AD FS сервере

```powershell
Install-WebApplicationProxy -FederationServiceTrustCredential $cred -CertificateThumbprint '<thumbprint of new cert>' -FederationServiceName 'fs.contoso.com'
```

## <a name="additional-references"></a>Дополнительная справка  
* [Поддержка привязки альтернативного имени узла для аутентификации сертификата в AD FS](../operations/AD-FS-support-for-alternate-hostname-binding-for-certificate-authentication.md)
* [Сведения о свойствах AD FS и KeySpec сертификата](../technical-reference/AD-FS-and-KeySpec-Property.md)
