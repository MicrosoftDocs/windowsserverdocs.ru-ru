---
ms.assetid: 5fd4063d-34dc-4b15-9a88-cc6c1fff455a
title: Пошаговое руководство. Управление рисками с помощью дополнительной многофакторной проверки подлинности для конфиденциальных приложений
description: ''
author: billmath
ms.author: billmath
manager: femila
ms.date: 05/31/2017
ms.topic: article
ms.prod: windows-server
ms.technology: identity-adfs
ms.openlocfilehash: 08aadcf0322fcb937bdde17d18aa5d30e3da68ce
ms.sourcegitcommit: 6aff3d88ff22ea141a6ea6572a5ad8dd6321f199
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/27/2019
ms.locfileid: "71357794"
---
# <a name="walkthrough-guide-manage-risk-with-additional-multi-factor-authentication-for-sensitive-applications"></a>Пошаговое руководство: управление рисками для уязвимых приложений с помощью дополнительной многофакторной проверки подлинности




## <a name="about-this-guide"></a>Информация о руководстве
В этом пошаговом руководстве приведены инструкции по настройке многофакторной проверки подлинности (MFA) в службы федерации Active Directory (AD FS) (AD FS) в Windows Server 2012 R2 на основе данных членства пользователя в группах.

Дополнительные сведения о MFA и механизмах проверки подлинности в AD FS см. в статье [Управление рисками с помощью дополнительной многофакторной проверки подлинности для конфиденциальных приложений](../../ad-fs/operations/Manage-Risk-with-Additional-Multi-Factor-Authentication-for-Sensitive-Applications.md).

Это пошаговое руководство включает в себя следующие разделы.

-   [Шаг 1. Настройка лабораторной среды @ no__t-0

-   [Шаг 2. Проверьте механизм проверки подлинности AD FS по умолчанию @ no__t-0

-   [Шаг 3. Настройка MFA на сервере федерации @ no__t-0

-   [Шаг 4. Проверка механизма MFA @ no__t-0

## <a name="BKMK_1"></a>Шаг 1. Настройка лабораторной среды
Для выполнения этого пошагового руководства вам потребуется среда, состоящая из следующих компонентов:

-   Домен Active Directory с тестовыми учетными записями пользователей и групп, работающими под Windows Server 2012 R2 или Active Directoryным доменом под Windows Server 2008, Windows Server 2008 R2 или Windows Server 2012 со схемой, обновленной до Windows Server 2012 R2

-   Сервер федерации под Windows Server 2012 R2

-   веб-сервера, на котором размещен пример приложения;

-   клиентского компьютера, с которого осуществляется доступ к примеру приложения.

> [!WARNING]
> Настоятельно не рекомендуется (как в производственной, так и в тестовой среде) использовать один и тот же компьютер в качестве сервера федерации и веб-сервера.

В этой среде сервер федерации выдает утверждения, которые необходимы для доступа пользователей к примеру приложения. На веб-сервере размещается пример приложения, которое будет считать доверенными пользователей, предъявивших утверждения, выданные сервером федерации.

Инструкции по настройке этой среды см. [в разделе Настройка лабораторной среды для AD FS в Windows Server 2012 R2](../../ad-fs/deployment/Set-up-the-lab-environment-for-AD-FS-in-Windows-Server-2012-R2.md).

## <a name="BKMK_2"></a>Шаг 2. Проверка стандартного механизма проверки подлинности через службы AD FS
В этом шаге вы проверите стандартный механизм управления доступом через службы AD FS (**проверка подлинности с помощью форм** для экстрасети и **проверка подлинности Windows** для интрасети), который перенаправляет пользователя на страницу входа AD FS, где ему нужно ввести действительные учетные данные, после чего пользователю будет предоставлен доступ к приложению. Вы можете использовать учетную запись **Роберт хатлэй** AD и пример приложения **клаимапп** , настроенного в [настройке лабораторной среды для AD FS в Windows Server 2012 R2](../../ad-fs/deployment/Set-up-the-lab-environment-for-AD-FS-in-Windows-Server-2012-R2.md).

1.  На клиентском компьютере откройте окно браузера и перейдите к вашему примеру приложения: **https://webserv1.contoso.com/claimapp** .

    В результате запрос будет автоматически перенаправлен серверу федерации и вам будет предложено ввести имя пользователя и пароль.

2.  Введите учетные данные учетной записи **Роберт хатлэй** AD, созданной в окне [Настройка лабораторной среды для AD FS в Windows Server 2012 R2](../../ad-fs/deployment/Set-up-the-lab-environment-for-AD-FS-in-Windows-Server-2012-R2.md).

    После этого вам будет предоставлен доступ к приложению.

## <a name="BKMK_3"></a>Шаг 3. Настройка многофакторной проверки подлинности на сервере федерации
Настроить MFA в AD FS в Windows Server 2012 R2 можно двумя частями:

-   [Выберите дополнительный метод проверки подлинности](../../ad-fs/operations/Walkthrough-Guide--Manage-Risk-with-Additional-Multi-Factor-Authentication-for-Sensitive-Applications.md#BKMK_5)

-   [Настройка политики MFA](../../ad-fs/operations/Walkthrough-Guide--Manage-Risk-with-Additional-Multi-Factor-Authentication-for-Sensitive-Applications.md#BKMK_6)

### <a name="BKMK_5"></a>Выберите дополнительный метод проверки подлинности
Чтобы настроить многофакторную проверку подлинности, вы должны выбрать дополнительный метод проверки подлинности. В этом руководстве для выбора дополнительного метода проверки подлинности вам предлагаются следующие варианты:

-   Выберите метод [проверки подлинности сертификата](../../ad-fs/operations/Walkthrough-Guide--Manage-Risk-with-Additional-Multi-Factor-Authentication-for-Sensitive-Applications.md#BKMK_7) , доступный в AD FS в Windows Server 2012 R2 по умолчанию

-   Настройте и выберите [Windows Azure Multi-Factor Authentication](../../ad-fs/operations/Walkthrough-Guide--Manage-Risk-with-Additional-Multi-Factor-Authentication-for-Sensitive-Applications.md#BKMK_8).

#### <a name="BKMK_7"></a>Проверка подлинности сертификата
Выполните любую из описанных ниже процедур для выбора проверки подлинности сертификата в качестве дополнительного метода проверки подлинности.

###### <a name="to-configure-certificate-authentication-as-an-additional-authentication-method-via-the-ad-fs-management-console"></a>Настройка проверки подлинности сертификата в качестве дополнительного метода проверки подлинности через консоль управления AD FS

1.  На сервере федерации в консоли управления AD FS перейдите к узлу **Политики проверки подлинности** и в разделе **Многофакторная проверка подлинности** щелкните ссылку **Изменить** рядом с подразделом **Глобальные параметры**.

2.  В окне **Изменение глобальной политики проверки подлинности** выберите вариант **Проверка подлинности сертификата** в качестве дополнительного метода проверки подлинности, а затем нажмите кнопку **ОК**.

###### <a name="to-configure-certificate-authentication-as-an-additional-authentication-method-via-windows-powershell"></a>Настройка проверки подлинности сертификата в качестве дополнительного метода проверки подлинности через Windows PowerShell

1.  На сервере федерации откройте окно команд Windows PowerShell и выполните следующую команду:

    ```
    Set-AdfsGlobalAuthenticationPolicy -AdditionalAuthenticationProvider CertificateAuthentication

    ```

    > [!WARNING]
    > Чтобы убедиться в успешном выполнении этой команды, можно выполнить команду `Get-AdfsGlobalAuthenticationPolicy` .

#### <a name="BKMK_8"></a>Многофакторная идентификация Windows Azure
Выполните описанные ниже действия, чтобы загрузить и настроить, а затем выбрать **Windows Azure Multi-Factor Authentication** в качестве дополнительной проверки подлинности на сервере федерации.

1.  [Создание поставщика многофакторной идентификации с помощью портала Windows Azure](../../ad-fs/operations/Walkthrough-Guide--Manage-Risk-with-Additional-Multi-Factor-Authentication-for-Sensitive-Applications.md#BKMK_a)

2.  [Загрузка сервер Многофакторной идентификации Windows Azure](../../ad-fs/operations/Walkthrough-Guide--Manage-Risk-with-Additional-Multi-Factor-Authentication-for-Sensitive-Applications.md#BKMK_b)

3.  [Установка сервер Многофакторной идентификации Windows Azure на сервере федерации](../../ad-fs/operations/Walkthrough-Guide--Manage-Risk-with-Additional-Multi-Factor-Authentication-for-Sensitive-Applications.md#BKMK_c)

4.  [Настройка многофакторной идентификации Windows Azure в качестве дополнительного метода проверки подлинности](../../ad-fs/operations/Walkthrough-Guide--Manage-Risk-with-Additional-Multi-Factor-Authentication-for-Sensitive-Applications.md#BKMK_d)

##### <a name="BKMK_a"></a>Создание поставщика многофакторной идентификации с помощью портала Windows Azure

1.  Войдите на портал Windows Azure с правами администратора.

2.  На левой панели выберите Active Directory.

3.  В верхней части страницы Active Directory выберите пункт **Поставщики многофакторной проверки подлинности**.  Затем внизу нажмите кнопку **Создать**.

4.  В разделе **Службы приложений->Active Directory** выберите элемент **Поставщик многофакторной проверки подлинности**, а затем выберите команду **Быстро создать**.

5.  В разделе **Службы приложений**выберите элемент **Активные поставщики проверки подлинности**, а затем выберите команду **Быстро создать**.

6.  Заполните следующие поля и выберите команду **Создать**.

    1.  **Имя** — имя поставщика многофакторной проверки подлинности.

    2.  **Модель использования** — модель использования поставщика многофакторной идентификации.

        -   **Для проверки подлинности** — модель приобретения, которая взимается за проверку подлинности. Обычно используется в сценариях применения Windows Azure Multi-Factor Authentication в потребительском приложении.

        -   **На включенную** модель приобретения пользователей, которая оплачивается для каждого включенного пользователя.  Обычно используется в сценариях приложений для сотрудников, например Office 365.

        Дополнительную информацию о моделях использования см. в разделе, содержащем [данные о ценах на Windows Azure](http://www.windowsazure.com/pricing/details/active-directory/).

    3.  **Каталог** — клиент Windows Azure Active Directory, с которым связан поставщик многофакторной идентификации. Этот параметр является необязательным, так как не требуется, чтобы поставщик был связан с Windows Azure Active Directory при обеспечении безопасности локальных приложений.

7.  После нажатия кнопки "Создать" будет создан поставщик Многофакторной идентификации и на экран будет выведено сообщение:  Successfully created Multi-Factor Authentication Provider (Поставщик Многофакторной идентификации успешно создан).  Нажмите кнопку **ОК**.

Затем вы должны загрузить сервер Windows Azure Multi-Factor Authentication. Для этого можно открыть портал Windows Azure Multi-Factor Authentication через портал Windows Azure.

##### <a name="BKMK_b"></a>Загрузка сервер Многофакторной идентификации Windows Azure

1.  Войдите на портал Windows Azure с правами администратора и выберите поставщика многофакторной проверки подлинности, которого вы создали ранее. Затем нажмите кнопку **Управление** .

    Откроется портал **Windows Azure Multi-Factor Authentication** .

2.  На портале **Windows Azure Multi-Factor Authentication** перейдите в раздел **Загрузки**и нажмите кнопку **Загрузить** для загрузки копии сервера Windows Azure Multi-Factor Authentication.

Загрузив исполняемый файл для сервера Windows Azure Multi-Factor Authentication, вы должны установить его на сервере федерации.

##### <a name="BKMK_c"></a>Установка сервер Многофакторной идентификации Windows Azure на сервере федерации

1.  Загрузите и дважды щелкните исполняемый файл для сервера Windows Azure Multi-Factor Authentication.  Начнется установка.

2.  На экране "Лицензионное соглашение" прочитайте текст соглашения, установите флажок **Принимаю** и нажмите кнопку **Далее**.

3.  Убедитесь, что конечная папка задана правильно, и нажмите кнопку **Далее**.

4.  По завершении установки нажмите кнопку **Готово**.

Теперь вы можете запустить сервер Windows Azure Multi-Factor Authentication, установленный на сервере федерации, и настроить его в качестве дополнительного метода проверки подлинности.

##### <a name="BKMK_d"></a>Настройка многофакторной идентификации Windows Azure в качестве дополнительного метода проверки подлинности

1.  Запустите сервер **Windows Azure Multi-Factor Authentication** из его расположения на сервере федерации, на странице приветствия установите флажок **Пропустить мастер настройки проверки подлинности** и нажмите кнопку **Далее**.

2.  Чтобы активировать сервер Multi-Factor Authentication, вернитесь на страницу портала управления Multi-Factor Authentication, откуда вы загрузили сервер Multi-Factor Authentication, и нажмите кнопку **Создать учетные данные для активации** . В пользовательском интерфейсе сервера Multi-Factor Authentication введите созданные учетные данные и нажмите кнопку **Активировать**.

3.  Затем в пользовательском интерфейсе **сервера Multi-Factor Authentication** вам будет предложено запустить **мастер настройки многосерверной среды**.  Выберите вариант **Нет**.

    > [!IMPORTANT]
    > Вы можете пропустить **мастер настройки многосерверной среды**, если для выполнения этого пошагового руководства используется лабораторная среда только с одним сервером федерации. Но если в вашей среде имеется несколько серверов федерации, вы должны установить сервер Multi-Factor Authentication и запустить **мастер настройки многосерверной среды** на каждом сервере федерации, чтобы обеспечить репликацию между серверами Multi-Factor Authentication, работающими на серверах федерации.

4.  В пользовательском интерфейсе **сервера Multi-Factor Authentication** щелкните значок **Пользователи** , выберите команду **Импорт из Active Directory**, выберите учетную запись **Robert Hatley** для ее подготовки в Windows Azure Multi-Factor Authentication и нажмите кнопку **Импорт**.

5.  В списке **Пользователи** выберите учетную запись **Robert Hatley** , нажмите кнопку **Изменить**и в окне **Изменение пользователя** укажите номер мобильного телефона для этой учетной записи. Убедитесь, что установлен флажок **Включено** , и нажмите кнопку **Применить**.

6.  В списке **Пользователи** выберите учетную запись **Robert Hatley** и нажмите кнопку **Проверка**. В окне **Тестовый пользователь** введите учетные данные для учетной записи **Robert Hatley** . Чтобы завершить проверку учетной записи, нажмите клавишу "#" в ячейке телефонного звонка.

7.  В пользовательском интерфейсе **сервера Multi-Factor Authentication** щелкните значок **AD FS** , установите флажки **Разрешить регистрацию пользователей**, **Разрешить пользователям выбрать метод** (включая **Телефонный звонок** и **Текстовое сообщение**), **Использовать секретные вопросы в качестве запасного варианта** и **Включить ведение журнала** , выберите элемент **Установить адаптер AD FS**и выполните инструкции мастера установки **адаптера AD FS для Multi-Factor Authentication** .

    > [!NOTE]
    > Мастер установки **адаптера AD FS для Многофакторной идентификации** создает группу безопасности под названием **Администраторы PhoneFactor** в Active Directory и добавляет учетную запись службы AD FS для вашей службы федерации в эту группу.
    > 
    > Рекомендуется убедиться на контроллере домена, что группа **Администраторы PhoneFactor** действительно создана и что учетная запись службы AD FS входит в эту группу.
    > 
    > При необходимости добавьте учетную запись службы AD FS в группу **Администраторы PhoneFactor** на контроллере домена вручную.

    Для получения дополнительной информации об установке адаптера AD FS перейдите по ссылке справки в правом верхнем углу интерфейса сервера Многофакторной идентификации.

8.  Чтобы зарегистрировать адаптер в службе федерации, на сервере федерации откройте окно команд Windows PowerShell и выполните следующую команду: `\Program Files\Multi-Factor Authentication Server\Register-MultiFactorAuthenticationAdfsAdapter.ps1`. Теперь адаптер зарегистрирован под именем **WindowsAzureMultiFactorAuthentication**.  Чтобы регистрация вступила в силу, перезапустите службу AD FS.

9. Чтобы настроить Многофакторную идентификацию Windows Azure в качестве дополнительного метода проверки подлинности, в консоли управления AD FS перейдите к узлу **Политики проверки подлинности** и в разделе **Многофакторной идентификации** щелкните ссылку **Изменить** рядом с подразделом **Глобальные параметры**. В окне **Изменение глобальной политики проверки подлинности** выберите вариант **Многофакторная проверка подлинности** в качестве дополнительного метода проверки подлинности и нажмите кнопку **ОК**.

    > [!NOTE]
    > Вы можете настроить имя и описание метода Windows Azure Multi-Factor Authentication (как и любого другого стороннего метода проверки подлинности), отображающиеся в пользовательском интерфейсе AD FS, при помощи командлета **Set-AdfsAuthenticationProviderWebContent** . Дополнительные сведения см. в разделе [https://technet.microsoft.com/library/dn479401.aspx](https://technet.microsoft.com/library/dn479401.aspx) .

### <a name="BKMK_6"></a>Настройка политики MFA
Чтобы активировать многофакторную проверку подлинности, вы должны настроить ее политику на сервере федерации. Для этого пошагового руководства в соответствии с политикой MFA необходимо, чтобы учетная запись **Роберт хатлэй** была подвергнута ВЫПОЛНЕНию MFA, поскольку она принадлежит к группе **Финансы** , настроенной в разделе [настройка лабораторной среды для AD FS в Windows Server 2012 R2](../../ad-fs/deployment/Set-up-the-lab-environment-for-AD-FS-in-Windows-Server-2012-R2.md).

Политику многофакторной проверки подлинности можно настроить через консоль управления AD FS или при помощи Windows PowerShell.

##### <a name="to-configure-the-mfa-policy-based-on-users-group-membership-data-for-claimapp--via-the-ad-fs-management-console"></a>Настройка политики MFA на основе данных членства пользователя в группах для "клаимапп" с помощью консоли управления AD FS

1.  На сервере федерации в консоли управления AD FS перейдите к узлу **Политики проверки подлинности**\\**Для отдельного отношения доверия с проверяющей стороной** и выберите отношение доверия с проверяющей стороной, которое представляет ваш пример приложения (**claimapp**).

2.  Перейдите на страницу **Действия** или щелкните правой кнопкой мыши **claimapp**и выберите пункт **Изменить настраиваемую многофакторную проверку подлинности**.

3.  В окне **Изменение отношения доверия с проверяющей стороной для claimapp** нажмите кнопку **Добавить** рядом со списком **Пользователи/Группы** . Введите в поле **Финансы** имя группы AD, созданной в окне [Настройка лабораторной среды для AD FS в Windows Server 2012 R2](../../ad-fs/deployment/Set-up-the-lab-environment-for-AD-FS-in-Windows-Server-2012-R2.md), а затем нажмите кнопку **Проверить имена**и после разрешения имени нажмите кнопку **ОК**.

4.  Нажмите кнопку **ОК** в окне **Изменение отношения доверия с проверяющей стороной для claimapp** .

##### <a name="to-configure-the-mfa-policy-based-on-users-group-membership-data-for-claimapp--via-windows-powershell"></a>Настройка политики MFA на основе данных членства пользователя в группах для "клаимапп" с помощью Windows PowerShell

1.  На сервере федерации откройте окно команд Windows PowerShell и выполните следующую команду:

    ```
    $rp = Get-AdfsRelyingPartyTrust -Name claimapp
    ```

2.  В том же окне команд Windows PowerShell выполните следующую команду:

    ```
    $GroupMfaClaimTriggerRule = 'c:[Type == "https://schemas.microsoft.com/ws/2008/06/identity/claims/groupsid", Value =~ "^(?i) <group_SID>$"] => issue(Type = "https://schemas.microsoft.com/ws/2008/06/identity/claims/authenticationmethod", Value = "https://schemas.microsoft.com/claims/multipleauthn");'
    Set-AdfsRelyingPartyTrust -TargetRelyingParty $rp -AdditionalAuthenticationRules $GroupMfaClaimTriggerRule

    ```

    > [!NOTE]
    > Обязательно замените < group_SID > значением **SID группы AD**.

## <a name="BKMK_4"></a>Шаг 4. Проверка механизма многофакторной проверки подлинности
В этом шаге вы проверите функции многофакторной проверки подлинности, настроенные в предыдущем шаге. Чтобы убедиться, что пользователь с учетной записью Active Directory **Robert Hatley** может получать доступ к вашему примеру приложения и в этот раз ему нужно пройти многофакторную проверку подлинности, поскольку он входит в группу **Finance**, можно использовать следующую процедуру.

1.  На клиентском компьютере откройте окно браузера и перейдите к вашему примеру приложения: **https://webserv1.contoso.com/claimapp** .

    В результате запрос будет автоматически перенаправлен серверу федерации и вам будет предложено ввести имя пользователя и пароль.

2.  Введите учетные данные для учетной записи Active Directory **Robert Hatley** .

    Согласно настроенной вами политике многофакторной проверки подлинности, пользователю будет предложено пройти дополнительную проверку подлинности. Текст сообщения по умолчанию: **В целях безопасности необходимо указать дополнительные данные для проверки учетной записи.** Этот текст можно полностью изменить по своему усмотрению. Дополнительную информацию о настройке взаимодействия при входе см. в разделе [Customizing the AD FS Sign-in Pages](https://technet.microsoft.com/library/dn280950.aspx).

    Если вы настроили проверку подлинности на основе сертификата в качестве дополнительного метода проверки подлинности, текст сообщения по умолчанию — **Select сертификат, который требуется использовать для проверки подлинности. Если вы отмените операцию, закройте браузер и повторите попытку.**

    Если в качестве дополнительного метода проверки подлинности вы настроили Windows Azure Multi-Factor Authentication, текст сообщения по умолчанию будет следующим: **Для завершения проверки подлинности на ваш телефон будет отправлен вызов.** Дополнительную информацию о входе с использованием Windows Azure Multi-Factor Authentication и об использовании различных вариантов для предпочтительного метода проверки см. в разделе [Обзор Windows Azure Multi-Factor Authentication](https://technet.microsoft.com/library/dn249479.aspx).

## <a name="see-also"></a>См. также
[Управление рисками с помощью дополнительной многофакторной проверки подлинности для конфиденциальных приложений](../../ad-fs/operations/Manage-Risk-with-Additional-Multi-Factor-Authentication-for-Sensitive-Applications.md)
[Настройка лабораторной среды для AD FS в Windows Server 2012 R2](../../ad-fs/deployment/Set-up-the-lab-environment-for-AD-FS-in-Windows-Server-2012-R2.md)



