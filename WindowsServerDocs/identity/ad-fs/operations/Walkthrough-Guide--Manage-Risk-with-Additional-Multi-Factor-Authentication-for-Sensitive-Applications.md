---
ms.assetid: 5fd4063d-34dc-4b15-9a88-cc6c1fff455a
title: "Пошаговое руководство - управление рисками с помощью дополнительной многофакторной проверки подлинности для уязвимых приложений"
description: 
author: billmath
ms.author: billmath
manager: femila
ms.date: 05/31/2017
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: identity-adfs
ms.openlocfilehash: 414f37e86f0072863e5fa2f107c39e5518e560ec
ms.sourcegitcommit: db290fa07e9d50686667bfba3969e20377548504
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/12/2017
---
# <a name="walkthrough-guide-manage-risk-with-additional-multi-factor-authentication-for-sensitive-applications"></a>Пошаговое руководство: Управление рисками с помощью дополнительной многофакторной проверки подлинности для уязвимых приложений

>Область применения: Windows Server 2012 R2


## <a name="about-this-guide"></a>Об этом руководстве
Это пошаговое руководство содержит инструкции по настройке многофакторной проверки подлинности (MFA) в федерации служб Active Directory (AD FS) в Windows Server 2012 R2, основанные на данных о членстве пользователя.

Дополнительные сведения о многофакторной проверки Подлинности и механизмах проверки подлинности в AD FS см. в разделе [управление рисками с помощью дополнительной многофакторной проверки подлинности для уязвимых приложений](../../ad-fs/operations/Manage-Risk-with-Additional-Multi-Factor-Authentication-for-Sensitive-Applications.md).

Это пошаговое руководство состоит из следующих разделов:

-   [Шаг 1: Настройка лабораторной среды](../../ad-fs/operations/Walkthrough-Guide--Manage-Risk-with-Conditional-Access-Control.md#BKMK_1)

-   [Шаг 2: Проверка стандартного механизма проверки подлинности Служб федерации Active Directory](../../ad-fs/operations/Walkthrough-Guide--Manage-Risk-with-Additional-Multi-Factor-Authentication-for-Sensitive-Applications.md#BKMK_2)

-   [Шаг 3: Настройка многофакторной проверки Подлинности на сервере федерации](../../ad-fs/operations/Walkthrough-Guide--Manage-Risk-with-Additional-Multi-Factor-Authentication-for-Sensitive-Applications.md#BKMK_3)

-   [Шаг 4: Проверка механизма многофакторной проверки Подлинности](../../ad-fs/operations/Walkthrough-Guide--Manage-Risk-with-Additional-Multi-Factor-Authentication-for-Sensitive-Applications.md#BKMK_4)

## <a name="BKMK_1"></a>Шаг 1: Настройка лабораторной среды
Для выполнения этого пошагового руководства вам потребуется среда, состоящая из следующих компонентов:

-   Домен Active Directory с помощью тестового пользователя и учетные записи групп, работающими под управлением Windows Server 2012 R2 или домена Active Directory под управлением Windows Server 2008, Windows Server 2008 R2 или Windows Server 2012 со схемой, обновленной до Windows Server 2012 R2

-   Сервер федерации под управлением Windows Server 2012 R2

-   Веб-сервер, на котором размещен пример приложения

-   Клиентский компьютер, из которого можно получить доступ к примеру приложения

> [!WARNING]
> Настоятельно рекомендуется (как в производственной среде и тестовых сред) следует использовать тот же компьютер в качестве сервера федерации и веб-сервера.

В этой среде сервер федерации выдает утверждения, которые требуются пользователям доступ к примеру приложения. Веб-сервере размещается пример приложения, которое будет считать доверенными пользователей, предъявивших утверждения, выданные сервером федерации.

Инструкции по настройке среды см. в разделе [Настройка лабораторной среды для служб AD FS в Windows Server 2012 R2](../../ad-fs/deployment/Set-up-the-lab-environment-for-AD-FS-in-Windows-Server-2012-R2.md).

## <a name="BKMK_2"></a>Шаг 2: Проверка стандартного механизма проверки подлинности Служб федерации Active Directory
На этом шаге вы проверите механизма управления доступом AD FS по умолчанию (**проверки подлинности форм** для экстрасети и **проверки подлинности Windows** для интрасети), где пользователь будет перенаправлен на страницу входа AD FS, ввести действительные учетные данные и предоставляется доступ к приложению. Можно использовать **Robert Hatley** учетной записи AD и **claimapp** образец приложения, которая настроена в [Настройка лабораторной среды для служб AD FS в Windows Server 2012 R2](../../ad-fs/deployment/Set-up-the-lab-environment-for-AD-FS-in-Windows-Server-2012-R2.md).

1.  На клиентском компьютере откройте окно браузера и перейдите к примеру приложения: **https://webserv1.contoso.com/claimapp**.

    Это действие автоматически перенаправляет запрос серверу федерации и вам предлагается выполнить вход с помощью имени пользователя и пароля.

2.  Введите учетные данные для **Robert Hatley** в созданную учетную запись AD [Настройка лабораторной среды для служб AD FS в Windows Server 2012 R2](../../ad-fs/deployment/Set-up-the-lab-environment-for-AD-FS-in-Windows-Server-2012-R2.md).

    Вам будет предоставлен доступ к приложению.

## <a name="BKMK_3"></a>Шаг 3: Настройка многофакторной проверки Подлинности на сервере федерации
Настройка многофакторной проверки Подлинности в AD FS в Windows Server 2012 R2 двух составляющих:

-   [Выбор дополнительного метода проверки подлинности](../../ad-fs/operations/Walkthrough-Guide--Manage-Risk-with-Additional-Multi-Factor-Authentication-for-Sensitive-Applications.md#BKMK_5)

-   [Настройка политики многофакторной проверки Подлинности](../../ad-fs/operations/Walkthrough-Guide--Manage-Risk-with-Additional-Multi-Factor-Authentication-for-Sensitive-Applications.md#BKMK_6)

### <a name="BKMK_5"></a>Выбор дополнительного метода проверки подлинности
Чтобы настроить многофакторную проверку Подлинности, необходимо выбрать дополнительный метод проверки подлинности. В этом пошаговом руководстве, для дополнительного метода проверки подлинности можно выбрать следующие параметры:

-   Выберите [проверки подлинности сертификата](../../ad-fs/operations/Walkthrough-Guide--Manage-Risk-with-Additional-Multi-Factor-Authentication-for-Sensitive-Applications.md#BKMK_7) метод, который доступен по умолчанию в AD FS в Windows Server 2012 R2

-   Настройте и выберите [многофакторной идентификации Windows Azure](../../ad-fs/operations/Walkthrough-Guide--Manage-Risk-with-Additional-Multi-Factor-Authentication-for-Sensitive-Applications.md#BKMK_8)

#### <a name="BKMK_7"></a>Проверка подлинности сертификата
Выполните любую из следующих процедур для выбора проверки подлинности сертификата в качестве дополнительного метода проверки подлинности.

###### <a name="to-configure-certificate-authentication-as-an-additional-authentication-method-via-the-ad-fs-management-console"></a>Настройка проверки подлинности сертификата в качестве дополнительного метода проверки подлинности через консоль управления AD FS

1.  На сервере федерации в консоли управления AD FS перейдите к **политики проверки подлинности** узел и в разделе **многофакторной проверки подлинности** щелкните **изменить** ссылку рядом с пунктом **глобальные параметры** подразделов.

2.  В **изменение глобальной политики проверки подлинности** выберите **проверки подлинности сертификата** в качестве дополнительного метода проверки подлинности и нажмите кнопку **ОК**.

###### <a name="to-configure-certificate-authentication-as-an-additional-authentication-method-via-windows-powershell"></a>Настройка проверки подлинности сертификата в качестве дополнительного метода проверки подлинности через Windows PowerShell

1.  На сервере федерации откройте окно команд Windows PowerShell и выполните следующую команду:

    ```
    Set-AdfsGlobalAuthenticationPolicy -AdditionalAuthenticationProvider CertificateAuthentication

    ```

    > [!WARNING]
    > Чтобы убедиться в успешном выполнении этой команды, можно запустить `Get-AdfsGlobalAuthenticationPolicy` команды.

#### <a name="BKMK_8"></a>Windows Azure Multi-factor Authentication
Выполните следующие процедуры, чтобы загрузить и настроить, а также выбрать **многофакторной идентификации Windows Azure** как дополнительная проверка подлинности на сервере федерации:

1.  [Создание поставщика многофакторной проверки подлинности через Windows Azure Portal](../../ad-fs/operations/Walkthrough-Guide--Manage-Risk-with-Additional-Multi-Factor-Authentication-for-Sensitive-Applications.md#BKMK_a)

2.  [Загрузка сервера Windows Azure Multi-factor Authentication](../../ad-fs/operations/Walkthrough-Guide--Manage-Risk-with-Additional-Multi-Factor-Authentication-for-Sensitive-Applications.md#BKMK_b)

3.  [Установка Windows Azure Multi-factor Authentication Server на сервере федерации](../../ad-fs/operations/Walkthrough-Guide--Manage-Risk-with-Additional-Multi-Factor-Authentication-for-Sensitive-Applications.md#BKMK_c)

4.  [Настройка многофакторной идентификации Windows Azure в качестве дополнительного метода проверки подлинности](../../ad-fs/operations/Walkthrough-Guide--Manage-Risk-with-Additional-Multi-Factor-Authentication-for-Sensitive-Applications.md#BKMK_d)

##### <a name="BKMK_a"></a>Создание поставщика многофакторной проверки подлинности через Windows Azure Portal

1.  Войдите в систему Windows Azure портала от имени администратора.

2.  В левой области выберите Active Directory.

3.  В верхней части страницы Active Directory выберите **поставщики многофакторной проверки подлинности**.  Затем внизу нажмите кнопку **New**.

4.  В разделе **службы приложений -> Active Directory**выберите **поставщик многофакторной проверки подлинности**и выберите **быстрое создание**.

5.  В разделе **службы приложений**выберите **активные поставщики проверки подлинности**и выберите **быстрое создание**.

6.  Заполните следующие поля и выберите команду **создание**.

    1.  **Имя** -имя поставщика многофакторной проверки подлинности.

    2.  **Модель использования** — модель использования поставщика многофакторной проверки подлинности.

        -   **На проверку подлинности** — модель покупки с оплатой для каждой проверки подлинности. Обычно используется в сценариях применения Windows Azure Multi-factor Authentication в потребительском приложении.

        -   **На включенного пользователя** — модель покупки с оплатой для каждого пользователя с доступом.  Обычно используется в сценариях сотрудника приложений, таких как Office 365.

        Дополнительные сведения о моделях использования см. в разделе [Windows Azure, сведения о ценах](http://www.windowsazure.com/pricing/details/active-directory/).

    3.  **Каталог** -клиента Windows Azure Active Directory, с которым связана поставщика многофакторной проверки подлинности. Это является необязательной, поскольку не требуется, чтобы поставщик был связан с Windows Azure Active Directory при защите локальных приложений.

7.  После нажатия кнопки Создание, будет создан поставщик многофакторной проверки подлинности, и вы увидите сообщение о том,: поставщик многофакторной идентификации успешно создан.  Нажмите кнопку **ОК**.

Затем необходимо загрузить многофакторной проверки подлинности Windows Azure сервер. Для этого можно открыть портал Windows Azure многофакторной проверки подлинности через портал Windows Azure.

##### <a name="BKMK_b"></a>Загрузка сервера Windows Azure Multi-factor Authentication

1.  Войдите на портал Windows Azure с правами администратора и выберите поставщика многофакторной проверки подлинности, созданный в предыдущей процедуре. Нажмите кнопку **управление** кнопки.

    В результате будет запущен **многофакторной идентификации Windows Azure** портала.

2.  В **многофакторной идентификации Windows Azure** портала, нажмите кнопку **загружает**, а затем нажмите кнопку **загрузить** для загрузки копии сервера Windows Azure многофакторной проверки подлинности.

Загрузив исполняемый файл для сервера Windows Azure многофакторной проверки подлинности, необходимо установить его на сервере федерации.

##### <a name="BKMK_c"></a>Установка Windows Azure Multi-factor Authentication Server на сервере федерации

1.  Загрузите и дважды щелкните исполняемый файл для сервера Windows Azure многофакторной проверки подлинности.  Начнется установка.

2.  На экране лицензионного соглашения Прочитайте соглашение, выберите **принимаю** и нажмите кнопку **Далее**.

3.  Убедитесь, что выбрана правильная папка назначения и нажмите кнопку **Далее**.

4.  После завершения установки, нажмите кнопку **Готово**.

Теперь вы готовы запустить сервер многофакторной идентификации Windows Azure, которая установлена на сервере федерации и настроить его в качестве дополнительного метода проверки подлинности.

##### <a name="BKMK_d"></a>Настройка многофакторной идентификации Windows Azure в качестве дополнительного метода проверки подлинности

1.  Запуск **многофакторной идентификации Windows Azure** из его расположения на сервере федерации, а также на странице приветствия, установите флажок **пропустить мастер настройки проверки подлинности с помощью** флажок и нажмите кнопку **Далее**.

2.  Чтобы активировать сервер многофакторной идентификации, вернитесь на страницу портала управления многофакторной идентификации, куда вы загрузили сервер многофакторной идентификации и нажмите кнопку **создать учетные данные для активации** кнопки. В пользовательском интерфейсе сервера многофакторной идентификации, введите учетные данные, которые были созданы и нажмите кнопку **активировать**.

3.  Далее, **сервера многофакторной идентификации** пользовательский интерфейс вам будет предложено запустить **мастер настройки многосерверной**.  Выберите **нет**.

    > [!IMPORTANT]
    > Вы можете пропустить **мастер настройки многосерверной** если лабораторная среда с только одним сервером федерации, используемый для выполнения этого пошагового руководства. Тем не менее, если в вашей среде имеется несколько серверов федерации, необходимо установить сервер многофакторной идентификации и завершить **мастер настройки многосерверной** на каждом сервере федерации, чтобы включить репликацию между серверами Multi-factor Authentication, работающими на серверах федерации.

4.  В **сервера многофакторной идентификации** пользовательский интерфейс, выберите **пользователей** значок, щелкните **Импорт из Active Directory**выберите **Robert Hatley** учетной записи для ее подготовки в системе многофакторной идентификации Windows Azure, а затем нажмите кнопку **импорта**.

5.  В **пользователей** выберите **Robert Hatley** учетной записью, щелкните **изменить**и в **изменение пользователя** укажите номер мобильного телефона этой учетной записи, убедитесь, что **включено** флажок установлен и нажмите кнопку **применить**.

6.  В **пользователей** выберите **Robert Hatley** учетной записи и нажмите кнопку **тест**. В **тестового пользователя** окно, введите учетные данные для **Robert Hatley** учетной записи. Когда зазвонит мобильный телефон, нажмите кнопку «#», чтобы завершить проверку учетной записи.

7.  В **сервера многофакторной идентификации** пользовательский интерфейс, выберите **AD FS** значок, убедитесь, что **разрешить регистрацию пользователей**, **разрешить пользователям выбирать метод** (включая **телефонный звонок** и **текстовое сообщение**), **использовать секретные вопросы для резервного входа** и **включить ведение журнала** проверяются флажки, нажмите кнопку **установить адаптер AD FS**и завершить **адаптера многофакторной проверки подлинности AD FS** мастера установки.

    > [!NOTE]
    > **Адаптера многофакторной проверки подлинности AD FS** мастер установки создает группу безопасности под названием **PhoneFactor Admins** в Active Directory и добавляет учетную запись службы AD FS для вашей службы федерации в эту группу.
    > 
    > Рекомендуется убедиться на контроллере домена, **PhoneFactor Admins** группы действительно создана и что учетная запись службы AD FS является членом этой группы.
    > 
    > При необходимости добавьте учетную запись службы AD FS в **PhoneFactor Admins** группы вручную на контроллере домена.

    Дополнительные сведения об установке адаптера AD FS щелкните ссылку "Справка" в правом верхнем углу сервера многофакторной идентификации.

8.  Чтобы зарегистрировать адаптер в службе федерации, на сервере федерации откройте окно команд Windows PowerShell и выполните следующую команду: `\Program Files\Multi-Factor Authentication Server\Register-MultiFactorAuthenticationAdfsAdapter.ps1`. Теперь адаптер зарегистрирован как **WindowsAzureMultiFactorAuthentication**.  Необходимо перезапустить службу AD FS для регистрации вступили в силу.

9. Настройка многофакторной идентификации Windows Azure в качестве дополнительного метода проверки подлинности, в консоли управления AD FS перейдите к **политики проверки подлинности** узел и в разделе **многофакторной проверки подлинности** щелкните **изменить** ссылку рядом с пунктом **глобальные параметры** подразделов. В **изменение глобальной политики проверки подлинности** выберите **многофакторной проверки подлинности** в качестве дополнительного метода проверки подлинности и нажмите кнопку **ОК**.

    > [!NOTE]
    > Можно настроить имя и описание метода многофакторной идентификации Windows Azure, а также какие-либо другого метода проверки подлинности сторонних, как он отображается в пользовательском Интерфейсе AD FS, выполнив **Set-AdfsAuthenticationProviderWebContent** командлета. Дополнительные сведения см. в разделе [https://technet.microsoft.com/library/dn479401.aspx](https://technet.microsoft.com/library/dn479401.aspx)

### <a name="BKMK_6"></a>Настройка политики многофакторной проверки Подлинности
Чтобы включить многофакторную проверку Подлинности, необходимо настроить политики многофакторной проверки Подлинности на сервере федерации. В этом пошаговом руководстве, согласно политике многофакторной проверки Подлинности **Robert Hatley** требуется учетная запись пройти многофакторную проверку Подлинности, поскольку он входит в **процент** группу, которую вы настроили в [Настройка лабораторной среды для служб AD FS в Windows Server 2012 R2](../../ad-fs/deployment/Set-up-the-lab-environment-for-AD-FS-in-Windows-Server-2012-R2.md).

Можно настроить политики многофакторной проверки Подлинности через консоль управления AD FS или при помощи Windows PowerShell.

##### <a name="to-configure-the-mfa-policy-based-on-users-group-membership-data-for-claimapp--via-the-ad-fs-management-console"></a>Настройка политики многофакторной проверки Подлинности на основе данных членства в группах пользователя для «claimapp» через консоль управления AD FS

1.  На сервере федерации в консоли управления AD FS перейдите к **политики проверки подлинности**\\**каждого доверия с проверяющей стороной** узел, а затем выберите доверия проверяющей стороной, которое представляет ваш пример приложения (**claimapp**).

2.  В **действия** страницу или по щелчку правой кнопкой мыши **claimapp**выберите **изменить настраиваемую многофакторную проверку подлинности**.

3.  В **изменить доверия с проверяющей стороной для claimapp** окно, нажмите кнопку **добавить** рядом со **пользователи/группы** списка. Введите в **процент** для имени группы AD, созданный в [Настройка лабораторной среды для служб AD FS в Windows Server 2012 R2](../../ad-fs/deployment/Set-up-the-lab-environment-for-AD-FS-in-Windows-Server-2012-R2.md)и нажмите кнопку **проверить имена**и когда имя будет разрешено, нажмите кнопку **ОК**.

4.  Нажмите кнопку **ОК** в **изменить доверия с проверяющей стороной для claimapp** окна.

##### <a name="to-configure-the-mfa-policy-based-on-users-group-membership-data-for-claimapp--via-windows-powershell"></a>Настройка политики многофакторной проверки Подлинности на основе данных членства в группах пользователя для «claimapp» через Windows PowerShell

1.  На сервере федерации откройте окно команд Windows PowerShell и выполните следующую команду:

    ```
    $rp = Get-AdfsRelyingPartyTrust -Name claimapp
    ```

2.  В том же окне команд Windows PowerShell выполните следующую команду:

    ```
    $GroupMfaClaimTriggerRule = 'c:[Type == "https://schemas.microsoft.com/ws/2008/06/identity/claims/groupsid", Value =~ "^(?i) <group_SID>$"] => issue(Type = "https://schemas.microsoft.com/ws/2008/06/identity/claims/authenticationmethod", Value = "https://schemas.microsoft.com/claims/multipleauthn");'
    Set-AdfsRelyingPartyTrust -TargetRelyingParty $rp -AdditionalAuthenticationRules $GroupMfaClaimTriggerRule

    ```

    > [!NOTE]
    > Убедитесь, что замените < group_SID > значением идентификатора безопасности для вашей группы AD **процент**.

## <a name="BKMK_4"></a>Шаг 4: Проверка механизма многофакторной проверки Подлинности
На этом шаге вы проверите функции многофакторной проверки Подлинности, который настроен на предыдущем шаге. Можно использовать следующую процедуру, чтобы убедиться, что **Robert Hatley** AD пользователь может получить доступ к вашему примеру приложения и этот раз ему нужно пройти многофакторную проверку Подлинности, поскольку он входит в **процент** группы.

1.  На клиентском компьютере откройте окно браузера и перейдите к примеру приложения: **https://webserv1.contoso.com/claimapp**.

    Это действие автоматически перенаправляет запрос серверу федерации и вам предлагается выполнить вход с помощью имени пользователя и пароля.

2.  Введите учетные данные для **Robert Hatley** учетную запись AD.

    На этом этапе из-за настроенной вами политике многофакторной проверки Подлинности пользователю будет предложено пройти дополнительную проверку подлинности. Текст сообщения по умолчанию **по соображениям безопасности необходимо указать дополнительные данные для подтверждения вашей учетной записи.** Тем не менее этот текст можно полностью настраивать. Дополнительные сведения о том, как настроить процесс входа в систему см. в разделе [настройка страниц AD FS Sign-in](https://technet.microsoft.com/library/dn280950.aspx).

    Если настроена проверка подлинности сертификата в качестве дополнительного метода проверки подлинности, то текст сообщения по умолчанию будет **выберите сертификат, который вы хотите использовать для проверки подлинности. Если отмены операции Закройте веб-браузер и повторите попытку.**

    Если в качестве дополнительного метода проверки подлинности вы настроили многофакторной идентификации Windows Azure, то текст сообщения по умолчанию — **для завершения проверки подлинности на ваш телефон будет отправлен вызов.** Дополнительные сведения о входе с многофакторной идентификации Windows Azure и об использовании различных вариантов для предпочтительного метода проверки см. в разделе [Обзор Windows Azure Multi-factor Authentication](https://technet.microsoft.com/library/dn249479.aspx).

## <a name="see-also"></a>См. также:
[Управление рисками для уязвимых приложений с помощью дополнительной многофакторной проверки подлинности](../../ad-fs/operations/Manage-Risk-with-Additional-Multi-Factor-Authentication-for-Sensitive-Applications.md)
[Настройка лабораторной среды для служб AD FS в Windows Server 2012 R2](../../ad-fs/deployment/Set-up-the-lab-environment-for-AD-FS-in-Windows-Server-2012-R2.md)



