---
title: Получить и настроить подписи маркера и расшифровки маркеров для AD FS
description: В этом документе описывается, как для получения и настройки служб Терминалов и TD сертификатов для AD FS
author: jenfieldmsft
ms.author: billmath
manager: samueld
ms.date: 10/23/2017
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: identity-adfs
ms.openlocfilehash: d16a886c9fb8f88748ffe732a75f0fd6a32c3702
ms.sourcegitcommit: 0d0b32c8986ba7db9536e0b8648d4ddf9b03e452
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2019
ms.locfileid: "59820215"
---
# <a name="obtain-and-configure-ts-and-td-certificates-for-ad-fs"></a>Получение и настройка служб Терминалов и TD сертификатов для AD FS

В этом разделе описываются задачи и процедуры, которые можно выполнить, чтобы обеспечить актуальность подписи маркера AD FS и сертификаты расшифровки маркеров.

Сертификаты для подписи маркеров стандартный X509 сертификаты, которые используются для безопасного подписания всех маркеров, издаваемых сервером федерации. Сертификаты расшифровки маркера, стандартных X509 сертификаты, используемые для расшифровки любых входящих маркеров. Кроме того, они публикуются в метаданных федерации.

Дополнительные сведения см. в разделе [требования к сертификатам](../design/ad-fs-requirements.md#BKMK_1)

## <a name="determine-whether-ad-fs-renews-the-certificates-automatically"></a>Определить ли AD FS автоматически обновляет сертификаты
По умолчанию AD FS настроен для создания подписи маркера и расшифровки маркеров автоматически, во время начальной настройки и когда сертификаты всех последующих версий срока их действия.

Можно выполнить следующую команду Windows PowerShell: `Get-AdfsProperties`.
  
  ![Get-ADFSProperties](media/configure-TS-TD-certs-ad-fs/ts1.png)
  
Свойство AutoCertificateRollover описывает, настроен ли обновление для подписи маркера и маркер автоматически расшифровки сертификаты AD FS.

Если AutoCertificateRollover имеет значение TRUE, сертификаты AD FS будет обновлен и настраивается автоматически в AD FS. После настройки нового сертификата, чтобы избежать сбоя, необходимо убедиться, что каждый партнер по федерации (представленной в ферме AD FS отношения доверия с поставщиком утверждений или отношений доверия проверяющих сторон) обновляется с помощью этого нового сертификата.
    
Если AD FS не настроено для обновления подписи маркера и маркером расшифровки сертификаты автоматически (если AutoCertificateRollover задано значение False), AD FS будут автоматически создавать или Начните использовать новые подписи маркера или сертификаты расшифровки маркера. Необходимо вручную выполнить эти задачи.
    
Если AD FS настроена на продление для подписи маркера и расшифровки сертификаты автоматически маркер (AutoCertificateRollover имеет значение TRUE), можно определить, когда они будут обновляться:

CertificateGenerationThreshold описывает, какое количество дней до сертификата не после даты будет создан новый сертификат.

CertificatePromotionThreshold определяет, сколько дней после создания нового сертификата, он будет обновлен до использоваться в качестве основного сертификата (другими словами, AD FS будет начинать использовать ее для подписи маркеров, выдаваемых и расшифровки токенов от поставщиков удостоверений).

![Get-ADFSProperties](media/configure-TS-TD-certs-ad-fs/ts2.png)
  
Если AD FS настроена на продление для подписи маркера и расшифровки сертификаты автоматически маркер (AutoCertificateRollover имеет значение TRUE), можно определить, когда они будут обновляться:

 - **CertificateGenerationThreshold** описывает, какое количество дней до сертификата не после даты будет создан новый сертификат.
 - **CertificatePromotionThreshold** определяет, сколько дней после создания нового сертификата, он будет обновлен до использоваться в качестве основного сертификата (другими словами, AD FS будет начинать использовать ее для подписи маркеров, выдаваемых и расшифровать маркеры от удостоверения Поставщики).

## <a name="determine-when-the-current-certificates-expire"></a>Определить, когда срок действия текущие сертификаты
Можно использовать следующую процедуру для определения основной подписи маркеров и сертификаты расшифровки маркера и определяют срок текущие сертификаты.

Можно выполнить следующую команду Windows PowerShell: `Get-AdfsCertificate –CertificateType token-signing` (или `Get-AdfsCertificate –CertificateType token-decrypting `). Либо можно изучить текущие сертификаты в оснастке MMC: Службы -> сертификаты.

![Get-ADFSCertificate](media/configure-TS-TD-certs-ad-fs/ts3.png)

Сертификат, для которого **IsPrimary** присваивается значение **True** — сертификат, который в настоящее время с помощью AD FS.

Даты, указанной для **не после** является датой, по которому должен быть настроен новый основной маркер подписи или расшифровки сертификата.

Чтобы обеспечить непрерывность обслуживания, все федерации партнеров, (представленной в ферме AD FS отношения доверия с поставщиком утверждений или отношений доверия проверяющих сторон) необходимо использовать новые сертификаты для подписи и расшифровки маркеров до истечения этого срока. Мы рекомендуем начать планирование этот процесс по крайней мере 60 дней вперед.

## <a name="generating-a-new-self-signed-certificate-manually-prior-to-the-end-of-the-grace-period"></a>Создание нового самозаверяющего сертификата вручную до окончания льготного периода
Чтобы создать самозаверяющий сертификат вручную до окончания льготного периода, можно использовать следующие действия.

1. Убедитесь, что вы вошли на основной сервер AD FS.
2. Откройте Windows PowerShell и выполните следующую команду: `Add-PSSnapin "microsoft.adfs.powershell"`
3. При необходимости можно проверить текущие сертификаты подписи в AD FS. Чтобы сделать это, выполните следующую команду: `Get-ADFSCertificate –CertificateType token-signing`. Посмотрите на выходные данные команды, чтобы просмотреть даты не после всех сертификатов в списке.
4. Чтобы создать новый сертификат, выполните следующую команду для обновления и обновления сертификатов на сервере AD FS: `Update-ADFSCertificate –CertificateType token-signing`.
5. Проверьте обновление, запустив следующую команду еще раз: `Get-ADFSCertificate –CertificateType token-signing`
6. Теперь должны появиться два сертификата, один из которых имеет **не после** даты, равную приблизительно году в будущем, для которого **IsPrimary** значение **False**.

>[!IMPORTANT]
>Чтобы избежать перерыва в обслуживании, обновите данные сертификата в Azure AD, выполнив действия в том, как для обновления Azure AD с использованием действительного сертификата подписи маркера.

## <a name="if-youre-not-using-self-signed-certificates"></a>Если вы не используете самозаверяющие сертификаты...
Если не используется по умолчанию создается автоматически, самозаверяющие сертификаты для подписи и расшифровки маркеров, необходимо обновить и вручную настроить эти сертификаты.

Во-первых необходимо получить новый сертификат от центра сертификации и импортировать его в хранилище личных сертификатов локального компьютера на каждом сервере федерации. Инструкции см. в разделе [Импорт сертификата](https://technet.microsoft.com/library/cc754489.aspx) статьи.

Затем необходимо настроить этот сертификат как вторичный AD FS подписи токена или сертификат расшифровки. (Его необходимо настроить как дополнительный сертификат, чтобы предоставить достаточно времени использовать этот новый сертификат, прежде чем повысить его уровень до основного сертификата федерации партнеров).

### <a name="to-configure-a-new-certificate-as-a-secondary-certificate"></a>Для настройки нового сертификата как дополнительного
1. Откройте PowerShell и выполните следующую команду: `Set-ADFSProperties -AutoCertificateRollover $false`
2. После импорта сертификата. Откройте **управления AD FS** консоли.
3. Разверните **службы** , а затем выберите **сертификаты**.
4. В области действий щелкните **сертификата подписи маркера добавьте**.
![Get-ADFSCertificate](media/configure-TS-TD-certs-ad-fs/ts4.png)</br>
5. Выберите новый сертификат из списка отображаемых сертификатов и нажмите кнопку ОК.
6.  Откройте PowerShell и выполните следующую команду: `Set-ADFSProperties -AutoCertificateRollover $true`

>[!WARNING]
>Убедитесь, что с новым сертификатом связан закрытый ключ, связанный с ним, и что учетная запись службы AD FS предоставлены разрешения на чтение для закрытого ключа. Проверьте это на каждом сервере федерации. Чтобы сделать это, в оснастке сертификатов, щелкните правой кнопкой мыши новый сертификат, выберите все задачи и нажмите кнопку Управление закрытыми ключами.

Разрешив достаточно времени для федерации партнеров для использования нового сертификата (они извлекают метаданных федерации или отправить их открытый ключ нового сертификата), необходимо повысить уровень дополнительного сертификата для основной сертификат.

### <a name="to-promote-the-new-certificate-from-secondary-to-primary"></a>Повышение уровня нового сертификата с дополнительного на основной

1. Откройте **управления AD FS** консоли.
2. Разверните **службы** , а затем выберите **сертификаты**.
3. Щелкните дополнительный сертификат подписи токена.
4. В **действия** панели щелкните **использовать как основной**. В окне подтверждения, нажмите кнопку "Да".
![Get-ADFSCertificate](media/configure-TS-TD-certs-ad-fs/ts5.png)</br>


## <a name="updating-federation-partners"></a>Обновление федерации партнеров

### <a name="partners-who-can-consume-federation-metadata"></a>Партнеры, способные подключаться к метаданным федерации
Если быть обновлены и настроить новый подписи маркера и сертификат расшифровки маркера, необходимо убедиться в том, все ваши федерации партнеров (организации или учетной записи организации партнеров по ресурсам, которые представлены в AD FS с проверяющей стороной стороне отношения доверия и отношения доверия с поставщиком утверждений), был выбран новые сертификаты.

### <a name="partners-who-can-not-consume-federation-metadata"></a>Партнеров, которые могут не использующие метаданные федерации
Если вашими партнерами федерации не могут использовать метаданных федерации, необходимо вручную отправить их открытый ключ нового сертификата подписи маркера и расшифровки маркера. Отправить новый открытый ключ сертификата (CER-файл или .p7b, если вы хотите включить всю цепочку) для всех ресурсов организации или учетной записью организации партнеров (представленного в AD FS доверия с проверяющей стороной и отношения доверия с поставщиком утверждений). У партнеров, в реализации изменений вход со своей стороны доверять новые сертификаты.

### <a name="promote-to-primary-if-autocertificaterollover-is-false"></a>Повысить уровень до основного (если AutoCertificateRollover имеет значение False)
Если **AutoCertificateRollover** присваивается **False**, AD FS не создаются автоматически, или вы начинаете использовать новые подпись токена или сертификаты расшифровки маркеров. Необходимо вручную выполнить эти задачи.
По прошествии некоторого проработает достаточное время для всех партнеров федерации для использования нового дополнительного сертификата, повысить уровень этого дополнительного сертификата для основного сервера (в оснастку MMC, щелкните дополнительного токена подписи сертификата и на панели действий нажмите кнопку **Задание в качестве источника**.)

## <a name="updating-azure-ad"></a>Обновление Azure AD
AD FS предоставляет единого входа для доступа к облачным службам Майкрософт, таких как Office 365, выполняя проверку подлинности пользователей с помощью существующих учетных данных AD DS.  Дополнительные сведения об использовании сертификатов см. в разделе [обновление сертификатов федерации для Office 365 и Azure AD](https://docs.microsoft.com/azure/active-directory/connect/active-directory-aadconnect-o365-certs).