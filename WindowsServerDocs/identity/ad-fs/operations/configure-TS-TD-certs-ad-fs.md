---
title: "Получить и настроить сертификат для подписи маркера и расшифровки маркера сертификаты для служб AD FS"
description: "В этом документе описывается, как получить и настройки служб Терминалов и TD сертификаты для Служб федерации Active Directory"
author: jenfieldmsft
ms.author: billmath
manager: samueld
ms.date: 10/23/2017
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: identity-adfs
ms.openlocfilehash: 0d7f8ba4efb74a377f9f9d748949a934398ebefc
ms.sourcegitcommit: db290fa07e9d50686667bfba3969e20377548504
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/12/2017
---
# <a name="obtain-and-configure-ts-and-td-certificates-for-ad-fs"></a>Получение и настройка служб Терминалов и TD сертификаты для служб AD FS

В этом разделе описаны задачи и процедуры, которые можно выполнить, чтобы обеспечить актуальность AD FS для подписи маркера и расшифровки маркера сертификаты.

Сертификаты подписи токена стандартных X509 сертификаты, используемые для безопасного подписания всех токенов, издаваемых сервером федерации. Сертификаты маркеров — это стандартная X509 сертификаты, используемые для расшифровки входящих токенов. Они также публикуется в метаданных федерации.

Дополнительные сведения см. [требования к сертификатам](../design/ad-fs-requirements.md#BKMK_1)

## <a name="determine-whether-ad-fs-renews-the-certificates-automatically"></a>Определить, является ли AD FS автоматическое возобновление действия сертификатов
По умолчанию AD FS настроены для создания подписи маркера и расшифровки маркера сертификаты автоматически, как во время начальной настройки, так и при приближении их даты окончания срока действия сертификатов.

Можно выполнить следующую команду Windows PowerShell:`Get-AdfsProperties`.
  
  ![Get-ADFSProperties](media/configure-TS-TD-certs-ad-fs/ts1.png)
  
Свойство AutoCertificateRollover описывает, настроен ли AD FS, чтобы обновить сертификат для подписи маркера и автоматически сертификатов для расшифровки маркера.

Если AutoCertificateRollover имеет значение TRUE, сертификатов Служб федерации Active Directory продление и автоматически настроены в AD FS. После настройки нового сертификата, чтобы избежать сбоя, необходимо убедиться, что каждый партнер по федерации (представлено в ферме AD FS с помощью отношений доверия с поставщиком утверждений или отношений доверия с проверяющей стороной) обновляется с помощью этого нового сертификата.
    
Если службы федерации Active Directory не настроены, чтобы обновить сертификат для подписи маркера и маркера расшифровки сертификаты автоматически (если AutoCertificateRollover имеет значение False), AD FS будет автоматически создавать или начать использовать новый сертификат для подписи маркера или сертификаты для расшифровки маркера. Необходимо вручную выполнить эти задачи.
    
Если службы федерации Active Directory настроена обновить сертификат для подписи маркера и автоматически сертификатов для расшифровки маркера (AutoCertificateRollover имеет значение TRUE), вы можете определить, когда они будут обновляться:

CertificateGenerationThreshold описание, сколько дней до даты сертификатов не после будет создан новый сертификат.

CertificatePromotionThreshold определяет количество дней после нового сертификата, он будет преобразована в машину использоваться в качестве основного сертификата (другими словами, AD FS начинают использовать его для подписи маркеров, выдаваемых им и расшифровки токенов от поставщиков удостоверений).

![Get-ADFSProperties](media/configure-TS-TD-certs-ad-fs/ts2.png)
  
Если службы федерации Active Directory настроена обновить сертификат для подписи маркера и автоматически сертификатов для расшифровки маркера (AutoCertificateRollover имеет значение TRUE), вы можете определить, когда они будут обновляться:

 - **CertificateGenerationThreshold** описание, сколько дней до даты сертификатов не после будет создан новый сертификат.
 - **CertificatePromotionThreshold** определяет количество дней после нового сертификата, он будет преобразована в машину использоваться в качестве основного сертификата (другими словами, службы федерации Active Directory будет начать его использовать для подписи маркеров, выдаваемых им и расшифровки токенов из удостоверения Поставщики).

## <a name="determine-when-the-current-certificates-expire"></a>Определить истечения срока действия текущего сертификата
Можно использовать следующую процедуру для определения основной сертификат для подписи маркера и сертификатов для расшифровки маркера и для определения истечения срока действия текущего сертификата.

Можно выполнить следующую команду Windows PowerShell: `Get-AdfsCertificate –CertificateType token-signing` (или `Get-AdfsCertificate –CertificateType token-decrypting `). Или можно проверить текущие сертификаты в консоль MMC: службы -> сертификаты.

![Get-ADFSCertificate](media/configure-TS-TD-certs-ad-fs/ts3.png)

Сертификат, для которого **IsPrimary** значение **True** сертификат, который в настоящее время с помощью Служб федерации Active Directory.

Дата, отображаемая для **не после** — это дата, с помощью которого должен быть настроен новый основной маркер подписи или расшифровки сертификата.

Чтобы обеспечить непрерывность обслуживания, всеми партнерами федерации (представлено в ферме AD FS с помощью отношений доверия с поставщиком утверждений или отношений доверия с проверяющей стороной) необходимо использовать новый сертификат для подписи маркера и расшифровки маркера сертификаты до окончания этого срока действия. Мы рекомендуем начать планировать заранее менее 60 дней, для выполнения этого процесса.

## <a name="generating-a-new-self-signed-certificate-manually-prior-to-the-end-of-the-grace-period"></a>Создание нового самозаверяющего сертификата вручную до истечения периода отсрочки
Можно использовать следующие действия, чтобы создать самозаверяющий сертификат вручную до истечения периода отсрочки.

1. Убедитесь, что вы вошли основного сервера AD FS.
2. Откройте Windows PowerShell и выполните следующую команду: `Add-PSSnapin "microsoft.adfs.powershell"`
3. Кроме того можно проверить текущие сертификаты подписи в AD FS. Чтобы сделать это, выполните следующую команду:`Get-ADFSCertificate –CertificateType token-signing`. Просмотрите выходные данные команды не после даты сертификаты, перечисленные в разделе.
4. Чтобы создать новый сертификат, выполните следующую команду для обновления и обновления сертификатов на сервере AD FS:`Update-ADFSCertificate –CertificateType token-signing`.
5. Проверьте обновление, запустив следующую команду еще раз. `Get-ADFSCertificate –CertificateType token-signing`
6. Теперь должно быть указано два сертификата, один из которых имеет **не после** дату в будущем приблизительно один год и для которого **IsPrimary** значение **False**.

>[!IMPORTANT]
>Чтобы избежать простоя службы, обновите сведения о сертификате в Azure AD, выполнив действия, в том, как обновления Azure AD с помощью действительного сертификата подписи токенов.

## <a name="if-youre-not-using-self-signed-certificates"></a>Если вы не используете самозаверяющие сертификаты...
Если не используется по умолчанию создаются автоматически, самозаверяющий сертификат для подписи маркера и расшифровки маркера сертификаты, необходимо обновить и вручную настроить эти сертификаты.

Во-первых необходимо получить новый сертификат сертификации и импортировать его в хранилище личных сертификатов локального компьютера на каждом сервере федерации. Инструкции см. в разделе [импорта сертификата](https://technet.microsoft.com/library/cc754489.aspx) статьи.

Затем необходимо настроить этот сертификат как дополнительный AD FS подписи маркера или сертификата расшифровки. (Можно настроить его в качестве дополнительного сертификата предусматривающее достаточно времени использовать этот новый сертификат до повышения уровня сертификата основным партнерами федерации).

### <a name="to-configure-a-new-certificate-as-a-secondary-certificate"></a>Для настройки нового сертификата в качестве получателя сертификата
1. Откройте PowerShell и выполните следующую команду: `Set-ADFSProperties -AutoCertificateRollover $false`
2. Импортировав сертификат. Откройте **управления AD FS** консоли.
3. Разверните **службы**, а затем выберите **сертификаты**.
4. На панели действий щелкните **сертификат для подписи маркера добавить**.
![Get-ADFSCertificate](media/configure-TS-TD-certs-ad-fs/ts4.png)</br>
5. Выберите новый сертификат из списка отображаемых сертификатов и нажмите кнопку ОК.
6.  Откройте PowerShell и выполните следующую команду: `Set-ADFSProperties -AutoCertificateRollover $true`

>[!WARNING]
>Убедитесь, что новый сертификат имеет закрытый ключ, связанный с ним и предоставить учетной записи службы AD FS разрешения на чтение закрытого ключа. Проверьте на каждом сервере федерации. Для этого в оснастке сертификатов щелкните правой кнопкой мыши новый сертификат, выберите пункт все задачи и нажмите кнопку Управление закрытыми ключами.

Как только Вы разрешили достаточно времени для партнеров федерации для использования нового сертификата (они pull метаданных федерации или отправить их ваш новый сертификат открытого ключа), необходимо повысить роль дополнительного сертификат для сертификата основным.

### <a name="to-promote-the-new-certificate-from-secondary-to-primary"></a>Для повышения роли нового сертификата из дополнительного на основной

1. Откройте **управления AD FS** консоли.
2. Разверните **службы**, а затем выберите **сертификаты**.
3. Выберите вторичный сертификат для подписи маркера.
4. В **действия** панели, щелкните **задать как основной**. В окне подтверждения, нажмите кнопку "Да".
![Get-ADFSCertificate](media/configure-TS-TD-certs-ad-fs/ts5.png)</br>


## <a name="updating-federation-partners"></a>Обновление партнерами федерации

### <a name="partners-who-can-consume-federation-metadata"></a>Партнеры, могут потреблять метаданных федерации
Если быть обновлены и настройте новый сертификат для подписи маркера и сертификат расшифровки маркера, необходимо убедиться, что все ваши федерации партнеров (организации или учетной записи организации партнеры по ресурсам, представленных в AD FS с проверяющей стороной доверие и отношения доверия с поставщиком утверждений) забрано новые сертификаты.

### <a name="partners-who-can-not-consume-federation-metadata"></a>Партнеры, не должны занимать метаданных федерации
Если партнерами федерации не может использовать метаданных федерации, необходимо вручную отправлять их открытый ключ ваш новый сертификат подписи маркера и расшифровки маркера. Отправить новый открытый ключ сертификата (.cer файл или .p7b, если вы хотите включить всей цепочки) для всех партнеров организации организации или учетной записи ресурса (представленной в AD FS проверяющей стороны отношения доверия и поставщика утверждений отношения доверия). У партнеров по реализации изменений со своей стороны доверять новые сертификаты.

### <a name="promote-to-primary-if-autocertificaterollover-is-false"></a>Повышение роли до основного (если AutoCertificateRollover имеет значение False)
Если **AutoCertificateRollover** имеет значение **False**, службы федерации Active Directory не будет автоматически создавать или Пуск, используя новый маркер подписи или сертификатов расшифровки маркера. Необходимо вручную выполнить эти задачи.
После предоставления определенного достаточно времени для всех партнеров федерации для использования нового сертификата вторичного продвижения этот дополнительный сертификат на основной (в оснастке MMC в, щелкните вторичного подписи маркера сертификатов и на панели действий щелкните **Установить в качестве основного**.)

## <a name="updating-azure-ad"></a>Обновление Azure AD
AD FS обеспечивает единого входа к облачным службам Майкрософт, таких как Office 365, проверяя личность пользователей через свои существующие учетные данные AD DS.  Дополнительные сведения об использовании сертификатов см. [обновить сертификаты федерации для Office 365 и Azure AD](https://docs.microsoft.com/en-us/azure/active-directory/connect/active-directory-aadconnect-o365-certs).