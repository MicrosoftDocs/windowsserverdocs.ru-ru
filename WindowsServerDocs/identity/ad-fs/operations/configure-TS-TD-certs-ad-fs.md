---
title: Получение и настройка сертификатов подписи маркеров и расшифровки маркеров для AD FS
description: В этом документе описывается, как получить и настроить сертификаты TS и TD для AD FS
author: jenfieldmsft
ms.author: billmath
manager: samueld
ms.date: 10/23/2017
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: identity-adfs
ms.openlocfilehash: 608f78ed03bc102cbdffb8abcc52244450b97b3c
ms.sourcegitcommit: f6490192d686f0a1e0c2ebe471f98e30105c0844
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/10/2019
ms.locfileid: "70865631"
---
# <a name="obtain-and-configure-ts-and-td-certificates-for-ad-fs"></a>Получение и настройка сертификатов TS и TD для AD FS

В этом разделе описываются задачи и процедуры, которые можно выполнить, чтобы убедиться, что сертификаты для подписи маркеров AD FS и расшифровки маркеров актуальны.

Сертификаты для подписи маркеров — это стандартные сертификаты X509, которые используются для безопасной подписи всех токенов, которые выдает сервер федерации. Сертификаты расшифровки маркеров — это стандартные сертификаты X509, которые используются для расшифровки любых входящих маркеров. Они также публикуются в метаданных федерации.

Дополнительные сведения см. в статье [требования к сертификатам](../design/ad-fs-requirements.md#BKMK_1) .

## <a name="determine-whether-ad-fs-renews-the-certificates-automatically"></a>Определить, будет ли AD FS автоматически переправлять сертификаты
По умолчанию AD FS настроен для автоматического создания сертификатов подписи маркера и расшифровки маркеров — как при первоначальной настройке, так и при приближении к сроку действия сертификатов.

Можно выполнить следующую команду Windows PowerShell: `Get-AdfsProperties`.
  
  ![Get-ADFSProperties](media/configure-TS-TD-certs-ad-fs/ts1.png)
  
Свойство AutoCertificateRollover описывает, настроена AD FS ли настройка для автоматической подписывания маркера и расшифровки сертификатов.

Если для AutoCertificateRollover задано значение TRUE, сертификаты AD FS будут обновлены и настроены в AD FS автоматически. После настройки нового сертификата во избежание сбоя необходимо убедиться, что каждый партнер Федерации (представленный в ферме AD FS с помощью отношений доверия проверяющей стороны или доверия поставщика утверждений) обновляется с помощью этого нового сертификата.
    
Если AD FS не настроен на автоматическое продление подписи маркеров и расшифровки маркеров (если AutoCertificateRollover имеет значение false), AD FS не будет автоматически создавать или начинать использовать новые подписи маркеров или расшифровки маркеров. Эти задачи придется выполнять вручную.
    
Если AD FS настроен на автоматическое продление подписи маркеров и расшифровки маркеров (AutoCertificateRollover имеет значение TRUE), можно определить, когда они будут обновлены:

Цертификатеженератионсрешолд описывает, сколько дней до даты "не позже" сертификата будет создан новый сертификат.

Цертификатепромотионсрешолд определяет, сколько дней после создания нового сертификата, что он будет выдвинут на роль основного сертификата (иными словами, AD FS начнет использовать его для подписи маркеров и расшифровки маркеров от поставщиков удостоверений).

![Get-ADFSProperties](media/configure-TS-TD-certs-ad-fs/ts2.png)
  
Если AD FS настроен на автоматическое продление подписи маркеров и расшифровки маркеров (AutoCertificateRollover имеет значение TRUE), можно определить, когда они будут обновлены:

 - **Цертификатеженератионсрешолд** описывает, сколько дней до даты "не позже" сертификата будет создан новый сертификат.
 - **Цертификатепромотионсрешолд** определяет, сколько дней после создания нового сертификата, что он будет выдвинут на роль основного сертификата (иными словами, AD FS начнет использовать его для подписывания маркеров и расшифровки маркеров удостоверений поставщики).

## <a name="determine-when-the-current-certificates-expire"></a>Определение времени истечения срока действия текущих сертификатов
Следующую процедуру можно использовать для определения сертификатов для подписи основного маркера и расшифровки маркеров, а также для определения сроков истечения срока действия текущих сертификатов.

Можно выполнить следующую команду Windows PowerShell: `Get-AdfsCertificate –CertificateType token-signing` (или `Get-AdfsCertificate –CertificateType token-decrypting `). Кроме того, можно просмотреть текущие сертификаты в консоли MMC: Сертификаты > службы.

![Get-ADFSCertificate](media/configure-TS-TD-certs-ad-fs/ts3.png)

Сертификат, для которого установлено значение «The- **PRIMARY** », равно **true** , — это сертификат, который AD FS в настоящее время используется.

Дата, указанная в поле **не позднее** , является датой, на которую должен быть настроен новый сертификат для подписывания или расшифровки первичного маркера.

Чтобы обеспечить непрерывность обслуживания, все партнеры Федерации (представленные в ферме AD FS с помощью отношений доверия проверяющей стороны или поставщика утверждений) должны использовать новые сертификаты подписи маркера и расшифровки маркеров до истечения этого срока действия. Рекомендуем начать планирование для этого процесса не менее 60 дней заранее.

## <a name="generating-a-new-self-signed-certificate-manually-prior-to-the-end-of-the-grace-period"></a>Создание самозаверяющего сертификата вручную до окончания льготного периода
Чтобы создать самозаверяющий сертификат вручную до окончания льготного периода, можно выполнить следующие действия.

1. Убедитесь, что вы вошли на основной сервер AD FS.
2. Откройте Windows PowerShell и выполните следующую команду:`Add-PSSnapin "microsoft.adfs.powershell"`
3. При необходимости можно проверить текущие сертификаты подписи в AD FS. Для этого выполните следующую команду: `Get-ADFSCertificate –CertificateType token-signing`. Просмотрите выходные данные команды, чтобы просмотреть даты не по истечении всех перечисленных сертификатов.
4. Чтобы создать новый сертификат, выполните следующую команду, чтобы продлить и обновить сертификаты на AD FS сервере: `Update-ADFSCertificate –CertificateType token-signing`.
5. Проверьте обновление, выполнив следующую команду еще раз:`Get-ADFSCertificate –CertificateType token-signing`
6. Два сертификата должны быть перечислены сейчас, один из которых имеет дату **не позже** приблизительно в один год в будущем и для **которой значение ISDATE равно** **false**.

>[!IMPORTANT]
>Чтобы избежать сбоя службы, обновите сведения о сертификате в Azure AD, выполнив действия, описанные в статье как обновить Azure AD с помощью действительного сертификата для подписи маркера.

## <a name="if-youre-not-using-self-signed-certificates"></a>Если вы не используете самозаверяющие сертификаты...
Если вы не используете автоматически формируемые по умолчанию самозаверяющие сертификаты для подписи и расшифровки маркеров, необходимо продлить и настроить эти сертификаты вручную.

Сначала необходимо получить новый сертификат из центра сертификации и импортировать его в личное хранилище сертификатов локального компьютера на каждом сервере федерации. Инструкции см. в статье [Импорт сертификата](https://technet.microsoft.com/library/cc754489.aspx) .

Затем этот сертификат необходимо настроить как вторичный AD FS сертификат подписи или расшифровки маркера. (Вы настраиваете его как дополнительный сертификат, чтобы предоставить партнерам Федерации достаточно времени для использования этого нового сертификата, прежде чем повысить его до основного сертификата).

### <a name="to-configure-a-new-certificate-as-a-secondary-certificate"></a>Настройка нового сертификата в качестве дополнительного сертификата
1. Откройте PowerShell и выполните следующую команду:`Set-ADFSProperties -AutoCertificateRollover $false`
2. После импорта сертификата. Откройте консоль **управления AD FS** .
3. Разверните узел **Служба** и выберите **Сертификаты**.
4. На панели Действия щелкните **Добавить сертификат подписи маркера**.
![Get-ADFSCertificate](media/configure-TS-TD-certs-ad-fs/ts4.png)</br>
5. Выберите новый сертификат из списка отображаемых сертификатов, а затем нажмите кнопку ОК.
6.  Откройте PowerShell и выполните следующую команду:`Set-ADFSProperties -AutoCertificateRollover $true`

>[!WARNING]
>Убедитесь, что с новым сертификатом связан закрытый ключ, а учетной записи службы AD FS предоставлены разрешения на чтение закрытого ключа. Проверьте это на каждом сервере федерации. Для этого в оснастке Сертификаты щелкните правой кнопкой мыши новый сертификат, выберите пункт Все задачи, а затем пункт Управление закрытыми ключами.

Получив достаточно времени, чтобы партнеры федерации использовали новый сертификат (либо запрашивают метаданные федерации, либо отправили им открытый ключ нового сертификата), необходимо повысить уровень вторичного сертификата до основного сертификата.

### <a name="to-promote-the-new-certificate-from-secondary-to-primary"></a>Повышение уровня нового сертификата с вторичного на первичный

1. Откройте консоль **управления AD FS** .
2. Разверните узел **Служба** и выберите **Сертификаты**.
3. Щелкните сертификат для подписи дополнительного маркера.
4. На панели **действия** щелкните **задать как основной**. Нажмите кнопку Да в запросе подтверждения.
![Get-ADFSCertificate](media/configure-TS-TD-certs-ad-fs/ts5.png)</br>


## <a name="updating-federation-partners"></a>Обновление партнеров Федерации

### <a name="partners-who-can-consume-federation-metadata"></a>Партнеры, которые могут использовать метаданные федерации
Если вы обновили и настроили новый сертификат для подписи маркера или маркера, необходимо убедиться, что все партнеры Федерации (организация ресурсов или партнеры Организации, которые представлены в AD FS с помощью отношений доверия проверяющей стороны и отношения доверия поставщиков утверждений) занимают новые сертификаты.

### <a name="partners-who-can-not-consume-federation-metadata"></a>Партнеры, которые не могут использовать метаданные федерации
Если ваши партнеры Федерации не могут использовать метаданные федерации, необходимо вручную отправить им открытый ключ нового сертификата для подписи маркера и расшифровки маркера. Отправьте новый открытый ключ сертификата (CER-файл или. p7b, если вы хотите включить всю цепочку) ко всем партнерам по организации ресурсов или организациям Организации (представленных в AD FS с помощью отношений доверия с проверяющей стороной и отношений доверия поставщиков утверждений). Поверьте, что партнеры реализуют изменения на своих сторонах, чтобы доверять новым сертификатам.

### <a name="promote-to-primary-if-autocertificaterollover-is-false"></a>Повысить до первичной (если AutoCertificateRollover имеет значение false)
Если **AutoCertificateRollover** имеет значение **false**, AD FS не будет автоматически создавать или начинать использовать новые сертификаты для подписи маркеров или расшифровки маркеров. Эти задачи придется выполнять вручную.
После разрешения достаточного периода времени для всех партнеров Федерации, чтобы использовать новый дополнительный сертификат, передайте этот вторичный сертификат в основной (в оснастке MMC щелкните сертификат подписи дополнительного маркера и на панели Действия щелкните **Задать в качестве основного**.)

## <a name="updating-azure-ad"></a>Обновление Azure AD
AD FS предоставляет доступ с помощью единого входа к облачным службам Майкрософт, таким как Office 365, путем проверки подлинности пользователей с использованием существующих учетных данных AD DS.  Дополнительные сведения об использовании сертификатов см. в статье [продление сертификатов федерации для Office 365 и Azure AD](https://docs.microsoft.com/azure/active-directory/connect/active-directory-aadconnect-o365-certs).