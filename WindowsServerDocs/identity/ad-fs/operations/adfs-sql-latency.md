---
title: Помощник по настройке SQL и решать проблемы задержки с AD FS
description: В этом документе описывается настройка SQL с помощью AD FS.
author: billmath
ms.author: billmath
manager: daveba
ms.date: 06/20/2019
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: identity-adfs
ms.openlocfilehash: fb699a1f92013f5657d2fbb48b203f96a5e5a5ba
ms.sourcegitcommit: 6b6c3601fb7493ab145ccff02db26d7123df9a3d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/21/2019
ms.locfileid: "67322865"
---
# <a name="fine-tuning-sql-and-addressing-latency-issues-with-ad-fs"></a>Помощник по настройке SQL и решать проблемы задержки с AD FS
В обновлении [AD FS 2016](https://support.microsoft.com/help/4503294/windows-10-update-kb4503294) мы внесли следующие улучшения, уменьшающие кросс-задержки базы данных. Предстоящие обновления для AD FS 2019 будет включать эти улучшения.

## <a name="in-memory-cache-update-in-background-thread"></a>Обновление кэша в памяти в фоновом потоке 
В предыдущих Always on развертываниях доступности (функция AoA) задержки существовали для любых «Чтение» операции, как главный узел может находиться в другом центре данных. Вызов между двух разных центрах обработки данных привело к задержке.  

В последнем обновлении для AD FS снижением задержки нацелено путем добавления фоновый поток, чтобы обновить кэш конфигурации AD FS и параметр для задания периода обновления. Потоку запроса, значительно сокращается время, затраченное для поиска по базе данных, как обновления кэша базы данных перемещаются в фоновом потоке.  

Когда `backgroundCacheRefreshEnabled` имеет значение true, AD FS будет включить фоновый поток для выполнения обновления кэша. Можно настроить частоту выборки данных из кэша в значение времени, задав `cacheRefreshIntervalSecs`. По умолчанию имеет значение 300 секунд при `backgroundCacheRefreshEnabled` задано значение true. После набора значение длительности, AD FS начинается обновление его кэша и обновление во время выполнения, старые данные кэша будут продолжать использоваться.  

>[!NOTE]
> Данные кэша будут обновляться за пределами `cacheRefreshIntervalSecs` значение, если служб федерации Active Directory получает уведомление от SQL, показывая, что произошло изменение в базе данных. Это уведомление будет активировать к обновлению кэша. 

### <a name="recommendations-for-setting-the-cache-refresh"></a>Рекомендации по установке обновления кэша 
Значение по умолчанию для обновления кэша — **пять минут**. Рекомендуется установить **1 час** для уменьшения обновления ненужных данных службами AD FS, так как данные кэша будут обновляться, если любых изменений SQL.  

AD FS регистрирует обратный вызов для изменения в SQL, и при изменении, служб федерации Active Directory получает уведомление. Таким способом служб федерации Active Directory получает каждого новое изменение от SQL, как только она возникает. 

В случае сбоя сети, что приведет к появлению AD FS отсутствует уведомления SQL, AD FS будет обновляться в интервале, заданном элементом кэша обновление значения. Если проблемы с подключением, вероятно, между AD FS и SQL, рекомендуется задать параметр обновления кэша для ниже, чем 1 час.  

### <a name="configuration-instructions"></a>Инструкции по настройке 
В файле конфигурации поддерживает несколько записей кэша. Следующие перечисленные ниже можно настраивать в зависимости от потребностей вашей организации. 

В следующем примере включает фоновое обновление кэша и задает период обновления кэша до 1800 секунд и 30 минут. Это необходимо сделать на каждом узле служб федерации Active Directory, и после этого необходимо перезапустить службу ADFS. Изменения не влияют на другие узлы и протестировать первый узел, прежде чем вносить изменения во всех узлах. 

  1. Перейдите к файлу конфигурации AD FS и в разделе «Microsoft.IdentityServer.Service», добавьте под записью:  
  
  - `backgroundCacheRefreshEnabled`  — Указывает, включена ли функция кэша фона. значения «true/false».
  - `cacheRefreshIntervalSecs` -Значение в секундах, по которым ADFS обновит кэш. AD FS будет обновлять кэш, если изменения в SQL. AD FS будет получать уведомления о SQL и обновить кэш.  
 
 >[!NOTE]
 > Все записи в файле конфигурации чувствительны к регистру.  
 &lt;cache cacheRefreshIntervalSecs="1800" backgroundCacheRefreshEnabled="true" /&gt; 
 
Дополнительные поддерживаемые настраиваемых значений: 

   - **maxRelyingPartyEntries** — максимальное число доверяющей стороной операций, которые AD FS сохраняет в памяти. Это значение также используется кэш разрешение приложения oAuth. Если приложение больше разрешений, чем запросов в секунду, и если все будет храниться в памяти, это значение должно быть число разрешений приложения. Значение по умолчанию — 1000.
   - **maxIdentityProviderEntries** : Эта является максимальное число утверждений AD FS сохраняет в памяти записей поставщика. Значение по умолчанию — 200. 
   - **maxClientEntries** — это максимальное число записей клиента OAuth, AD FS сохраняет в памяти. По умолчанию используется значение 500. 
   - **maxClaimDescriptorEntries** — максимальное число записей дескриптора утверждений AD FS сохраняет в памяти. По умолчанию используется значение 500. 
   - **maxNullEntries** -это используется в качестве негативный кэш. Если AD FS ищет запись в базе данных, и он не найден, AD FS добавляет негативный кэш. Это максимальный размер этого кэша. Негативный кэш для каждого типа объектов, это не одного кэша для всех объектов. Значение по умолчанию — 50,0000. 

## <a name="multiple-artifact-db-support-across-datacenters"></a>Поддерживает несколько артефактов базы данных в центрах обработки данных 
Для предыдущих конфигураций нескольких центров обработки данных AD FS NTFS поддерживала только одной базы данных артефакта, причиной задержки между center центра обработки данных во время вызовов для извлечения.  

Чтобы уменьшить задержки между центра обработки данных, администратор AD FS можно теперь развертывание нескольких экземпляров DB артефакта, а затем изменить файл конфигурации узел AD FS для указания различных артефактов DB экземпляров. Строку подключения базы данных артефакта можно указать в файле конфигурации, позволяя артефактов базы данных на узел. Если строку подключения в файле конфигурации отсутствует, узел произойдет откат к предыдущей проектирования для использования базы данных артефактов, которая присутствует в БД конфигурации.  
Гибридных средах, также поддерживаются в этой конфигурации.  

### <a name="requirements"></a>Требования: 
До настройки базы данных поддержку нескольких артефакт, выполните обновление на всех узлах и обновит двоичные файлы, так как несколькими узлами вызовы осуществляются через эту функцию. 
  1. Создайте скрипт развертывания для создания артефактов базы данных: Развертывание нескольких экземпляров DB артефакта, администратору потребуется создать скрипт развертывания SQL для базы данных артефакта. В рамках этого обновления, существующий `Export-AdfsDeploymentSQLScript`командлет был обновлен для при необходимости принимать в качестве параметра, указывающее, какие базы данных AD FS для создания SQL-скрипт развертывания для. 
 
 Например, чтобы создать скрипт развертывания для только что DB артефакта, указать `-DatabaseType` параметр и передайте значение «Артефакта». Необязательный `-DatabaseType` параметр указывает тип базы данных AD FS и может быть присвоено: Все (по умолчанию), конфигурации или артефакта. Если нет `-DatabaseType` параметр указан, сценарий настроит скриптов конфигурации и артефакта.  

   ```PowerShell
   PS C:\> Export-AdfsDeploymentSQLScript -DestinationFolder <script folder where scripts will be created> -ServiceAccountName <domain\serviceaccount> -DatabaseType "Artifact" 
   ```
Созданный скрипт должен выполняться на компьютере SQL создать необходимые базы данных и предоставить учетной записи службы AD FS, полномочий системного Администратора SQL для баз данных.

 2. Создание базы данных артефакта, с помощью сценария развертывания. Скопировать созданный скрипты развертывания CreateDB.sql и SetPermissions.sql машины SQL server и выполнять их для создания локальной базы данных артефакта. 
 
 3. Измените файл конфигурации, чтобы добавить подключение к базе данных артефакта. 
 Перейдите к файлу config узла AD FS и в разделе «Microsoft.IdentityServer.Service», добавьте точку входа для вновь настроенная ArtifactDB. 

 >[!NOTE] 
 > artifactStore и connectionString являются значениями с учетом регистра. Убедитесь, что они настроены правильно. &lt;artifactStore connectionString="Data Source=.\SQLInstance;Integrated Security=True;Initial Catalog=AdfsArtifactStore" /&gt; 
>
>Используйте значение источника данных, соответствующее подключение к sql.



 4. Перезапустите службу AD FS, чтобы изменения вступили в силу. 
 
 >[!NOTE] 
 > Не рекомендуется использовать репликацию SQL или синхронизации между базами данных артефакта. Рекомендуется настроить одну базу данных артефакта одного центра обработки данных. 
 
### <a name="cross-datacenter-failover-and-database-recovery"></a>CROSS центра обработки данных отработки отказа и восстановление базы данных  
Рекомендуется создать артефакт отработку отказа баз данных в одном центре обработки данных, что и база данных master артефакта. При отработке отказа, будут без увеличения задержки. Артефакт отработки отказа баз данных в центрах обработки данных не рекомендуется. Следующие сведения о том, как вызовы для OAuth, SAML, ESL и токен воспроизведения функция обнаружения с несколькими базами данных артефакта. 
 - **OAuth и SAML** 

   Для запросов артефакта OAuth и SAML узел будет создавать артефакт в артефакте DB представлен в файле конфигурации. Если файл конфигурации не содержит подключения к базе данных артефакта, будет использоваться распространенных артефактов базы данных. Когда следующий запрос для получения артефакт переходит на другой узел, другой узел сделает rest API для 1-й узел для получения артефакт из артефактов базы данных. Это необходимо, как разные узлы могут быть артефакта разные базы данных и узлы не знаете об этом. Если первый узел не работает, произойдет сбой разрешения артефактов. Из-за такой структуре репликации артефакт DB в разных центрах обработки данных не является обязательным. Если один всего центра обработки данных не работает, скорее всего узла, который создан артефакт также вниз, это означает, что больше не удается разрешить этот артефакт.  

 - **Блокировка экстрасети** 

    Артефакт базы данных, на которые ссылается на файл конфигурации будет использоваться для данных экстрасети. Тем не менее для компонента ESL AD FS выбирает шаблон, который записывает эти данные в артефакте DB. Все узлы сделать вызов к главному узлу для получения и задания последние сведения о каждом пользователе, REST API. Если используются несколько DB артефакта, администратору необходимо выбрать главный узел для каждого артефакта DB или центра обработки данных. 

    Чтобы выбрать один узел для основного ESL, перейдите к файлу config узла служб федерации Active Directory и в разделе «Microsoft.IdentityServer.Service», добавьте следующие строки:       
    
    На главном узле добавьте следующий элемент. Обратите внимание на то, что все три ключа чувствительны к регистру. 

    &lt;useractivityfarmrole masterFQDN = isMaster [полное ДОМЕННОЕ имя выбранного источника] = «true» /&gt;
    
    На других узлах, добавьте следующий элемент:

   &lt;useractivityfarmrole masterFQDN = isMaster [полное ДОМЕННОЕ имя выбранного источника] = «false» /&gt;
 
    >[!NOTE] 
    >Так как несколько баз данных артефакта не проводить синхронизацию данных, ESL значения не будут синхронизированы между артефакта баз данных SQL.
    Пользователь может потенциально столкнуться с другой центр обработки данных для запроса, поэтому сделать ExtranetLockoutThreshold зависимыми от числа баз данных SQL артефакта, ExtranetLockoutThreshold * номер артефакта баз данных. 
 
  - **Обнаружение воспроизведения токенов** 
    
    Данные обнаружения воспроизведения маркеров всегда вызывается в центральной базе артефакта. AD FS сохраняет маркер с отношением доверия поставщика утверждений, гарантируя, что тот же токен не может быть воспроизведено. Если злоумышленник пытается воспроизвести тот же токен, AD FS проверяет, существует ли токен в базе данных артефакта. Если присутствует маркер, запрос будет отклонен. Используется центральная база данных артефакта для обеспечения безопасности, так как данные DB артефакта не реплицируются, злоумышленник может отправить запрос в другой центр данных, воспроизведения маркера. Создание дополнительных копий только для чтения ArtifactDB не помешает задержки между центра обработки данных в этом сценарии используется только в центральной базе артефакта.    
 
 