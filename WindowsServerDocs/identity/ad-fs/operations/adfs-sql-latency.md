---
title: Тонкая настройка SQL и устранение проблем с задержкой с помощью AD FS
description: В этом документе описано, как настроить SQL с помощью AD FS.
author: billmath
ms.author: billmath
manager: daveba
ms.date: 06/20/2019
ms.topic: article
ms.prod: windows-server
ms.technology: identity-adfs
ms.openlocfilehash: 785ecd4de86c06dd12eb57e41efaa1103f2afdc5
ms.sourcegitcommit: 6aff3d88ff22ea141a6ea6572a5ad8dd6321f199
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/27/2019
ms.locfileid: "71357815"
---
# <a name="fine-tuning-sql-and-addressing-latency-issues-with-ad-fs"></a>Тонкая настройка SQL и устранение проблем с задержкой с помощью AD FS
В обновлении для [AD FS 2016](https://support.microsoft.com/help/4503294/windows-10-update-kb4503294) мы предоставили следующие усовершенствования для сокращения задержки между базами данных. В ближайшее обновление для AD FS 2019 будут включены следующие улучшения.

## <a name="in-memory-cache-update-in-background-thread"></a>Обновление кэша в памяти в фоновом потоке 
В предыдущих развертываниях по доступности AlwaysOn (AoA) задержка существовала для любой операции чтения, так как главный узел может находиться в отдельном центре обработки данных. Вызов двух разных центров обработки данных привел к задержке.  

В последнем обновлении до AD FS сокращение задержки нацелено на добавление фонового потока для обновления кэша конфигурации AD FS и параметра для установки периода времени обновления. Время, затраченное на поиск базы данных, значительно сокращается в потоке запросов, так как обновления кэша базы данных перемещаются в фоновый поток.  

Если параметр `backgroundCacheRefreshEnabled` имеет значение true, AD FS включит фоновый поток для запуска обновлений кэша. Частоту выборки данных из кэша можно настроить на значение времени, задав `cacheRefreshIntervalSecs`. Значение по умолчанию задается равным `backgroundCacheRefreshEnabled` 300 секундам, если параметру присвоено значение true. После задания длительности значения AD FS начинает обновление кэша и во время выполнения обновления старые данные кэша будут продолжать использоваться.  

>[!NOTE]
> Данные кэша будут обновляться вне значения, `cacheRefreshIntervalSecs` если ADFS получает уведомление от SQL, что означает, что в базе данных произошло изменение. Это уведомление вызывает обновление кэша. 

### <a name="recommendations-for-setting-the-cache-refresh"></a>Рекомендации по настройке обновления кэша 
Значение по умолчанию для обновления кэша составляет **5 минут**. Рекомендуется установить для него значение **1 час** , чтобы сократить ненужные обновления данных, AD FS поскольку данные кэша будут обновляться при возникновении каких-либо изменений SQL.  

AD FS регистрирует обратный вызов для изменений SQL, а после изменения ADFS получает уведомление. С помощью этого метода ADFS получает каждое новое изменение из SQL, как только оно будет происходить. 

В случае сбоя сети, что приводит к AD FS отсутствия уведомления SQL, AD FS будет обновляться с интервалом, указанным в параметре обновления кэша. При возникновении проблем с подключением между AD FS и SQL рекомендуется задать для параметра обновления кэша значение меньше 1 часа.  

### <a name="configuration-instructions"></a>Инструкции по настройке 
Файл конфигурации поддерживает несколько записей кэша. Перечисленные ниже настройки можно настроить в соответствии с потребностями Организации. 

В следующем примере включается фоновое обновление кэша и устанавливается период обновления кэша 1800 секунд или 30 минут. Это необходимо сделать на каждом узле ADFS, после чего необходимо перезапустить службу ADFS. Изменения не влияют на другие узлы и проверяют первый узел перед внесением изменений во все узлы. 

  1. Перейдите к файлу конфигурации AD FS и в разделе Microsoft. IdentityServer. Service добавьте следующий элемент:  
  
  - `backgroundCacheRefreshEnabled`— Указывает, включена ли функция фонового кэша. значения true/false.
  - `cacheRefreshIntervalSecs`— Значение в секундах, по истечении которого ADFS обновляет кэш. AD FS обновит кэш, если в SQL возникли какие-либо изменения. AD FS получит уведомление SQL и обновит кэш.  
 
 >[!NOTE]
 > Все записи в файле конфигурации чувствительны к регистру.  
 &lt;Cache Качерефрешинтервалсекс = "1800" Баккграундкачерефрешенаблед = "true"/&gt; 
 
Дополнительные поддерживаемые настраиваемые значения: 

   - **максрелингпартентриес** — максимальное число записей проверяющей стороны, которые AD FS будут оставаться в памяти. Это значение также используется кэшем разрешений приложения oAuth. При наличии большего количества разрешений приложения, чем RPs, и если все они будут храниться в памяти, это значение должно быть числом разрешений приложения. Значение по умолчанию — 1000.
   - **максидентитипровидерентриес** — максимальное число записей поставщика утверждений, AD FS будет оставаться в памяти. Значение по умолчанию — 200. 
   - **максклиентентриес** — максимальное число записей клиента OAuth, AD FS будет оставаться в памяти. По умолчанию используется значение 500. 
   - **максклаимдескрипторентриес** — максимальное число записей дескриптора утверждений, AD FS будет оставаться в памяти. По умолчанию используется значение 500. 
   - **макснуллентриес** — используется как отрицательный кэш. Когда AD FS ищет в базе данных запись, которая не найдена, AD FS добавляет в отрицательный кэш. Это максимальный размер кэша. Существует отрицательный кэш для каждого типа объектов, он не является единым кэшем для всех объектов. Значение по умолчанию — 50, 0000. 

## <a name="multiple-artifact-db-support-across-datacenters"></a>Поддержка нескольких баз данных артефактов в центрах обработки данных 
Для более ранних конфигураций нескольких центров обработки данных AD FS поддерживала только один объект Database артефакта, что вызывает задержку между центрами обработки данных во время получения вызовов.  

Чтобы снизить задержку между центрами обработки данных, администратор AD FS может развернуть несколько экземпляров базы данных артефактов, а затем изменить файл конфигурации узла AD FS, чтобы он указывал на различные экземпляры базы данных артефактов. Строка подключения к базе данных артефакта может быть предоставлена в файле конфигурации, что позволяет использовать базу данных артефактов для каждого узла. Если строка подключения отсутствует в файле конфигурации, узел вернется к предыдущему дизайну, чтобы использовать базу данных артефактов, которая содержится в БД конфигурации.  
В этой конфигурации также поддерживаются гибридные среды.  

### <a name="requirements"></a>Требования: 
Перед настройкой поддержки нескольких артефактов для базы данных запустите обновление на всех узлах и обновите двоичные файлы, так как в этой функции происходят вызовы с несколькими узлами. 
  1. Создайте скрипт развертывания для создания базы данных артефактов: Для развертывания нескольких экземпляров базы данных артефактов администратору потребуется создать скрипт развертывания SQL для базы данных артефактов. В рамках этого обновления существующий `Export-AdfsDeploymentSQLScript`командлет был обновлен с учетом параметра, указывающего, какая AD FS база данных для создания скрипта развертывания SQL для. 
 
 Например, чтобы создать скрипт развертывания только для базы данных артефактов, укажите `-DatabaseType` параметр и передайте значение "артефакт". Необязательный `-DatabaseType` параметр указывает тип базы данных AD FS и может принимать следующие значения: All (по умолчанию), артефакт или Конфигурация. Если параметр `-DatabaseType` не указан, скрипт настроит как артефакт, так и скрипт конфигурации.  

   ```PowerShell
   PS C:\> Export-AdfsDeploymentSQLScript -DestinationFolder <script folder where scripts will be created> -ServiceAccountName <domain\serviceaccount> -DatabaseType "Artifact" 
   ```
Созданный скрипт должен выполняться на компьютере SQL для создания необходимых баз данных и предоставления AD FS учетной записи службы, разрешения SA SQL для этих баз данных.

 2. Создайте базу данных артефактов с помощью скрипта развертывания. Скопируйте созданные скрипты развертывания CreateDB. SQL и SetPermissions. SQL на компьютер SQL Server и выполните их для создания локальной базы данных артефактов. 
 
 3. Измените файл конфигурации, чтобы добавить подключение к базе данных артефактов. 
 Перейдите к файлу конфигурации AD FS узла и в разделе Microsoft. IdentityServer. Service добавьте точку входа в только что настроенную Артифактдб. 

 >[!NOTE] 
 > Артифактсторе и connectionString учитывают регистр значений. Убедитесь, что они настроены правильно. &lt;Артифактсторе connectionString = "источник данных = .\Склинстанце; встроенная безопасность = true; начальный каталог = Адфсартифактсторе"/&gt; 
>
>Используйте значение источника данных, соответствующее подключению SQL.



 4. Перезапустите службу AD FS, чтобы изменения вступили в силу. 
 
 >[!NOTE] 
 > Не рекомендуется использовать репликацию SQL или синхронизацию между базами данных артефактов. Рекомендуется настроить одну базу данных артефактов на каждый центр обработки данных. 
 
### <a name="cross-datacenter-failover-and-database-recovery"></a>Переключение между отработкой отказа и восстановлением базы данных  
Рекомендуется создавать базы данных артефактов отработки отказа в том же центре обработки данных, что и Главная реплика. Если происходит отработка отказа, то задержка не увеличивается. Не рекомендуется использовать базы данных артефактов для отработки отказа в центрах данных. Ниже приведены сведения о вызовах функции определения OAuth, SAML, есл и метода обнаружения для воспроизведения маркеров с несколькими базами данных артефактов. 
 - **OAuth и SAML** 

   Для запросов артефактов OAuth и SAML узел создаст артефакт в базе данных артефактов, присутствующей в файле конфигурации. Если файл конфигурации не содержит подключения к базе данных артефактов, то будет использоваться Общая БД артефактов. Когда следующий запрос на получение артефакта переходит на другой узел, другой узел сделает API-интерфейс для второго узла получать артефакт из базы данных артефактов. Это необходимо, так как разные узлы могут иметь разные базы данных артефактов, и узлы не узнают об этом. Если первый узел не работает, разрешение артефакта не будет выполнено. Из-за такой схемы репликация базы данных артефактов в разных центрах обработки не требуется. Если один из центров обработки данных не работает, скорее всего, узел, создавший артефакт, также не работает, что означает, что артефакт больше не может быть разрешен.  

 - **Блокировка экстрасети** 

    База данных артефактов, на которую ссылается файл конфигурации, будет использоваться для данных блокировки экстрасети. Однако для функции есл AD FS выбирает объект Master, который записывает данные в базу данных артефактов. Все узлы выполняют REST API вызов главного узла для получения и установки последних сведений о каждом пользователе. Если используется несколько баз данных артефактов, администратор должен выбрать главный узел для каждой базы данных артефактов или центра обработки данных. 

    Чтобы выбрать один узел в качестве главного есл, перейдите к файлу конфигурации узла ADFS и в разделе "Microsoft. IdentityServer. Service" добавьте следующее:       
    
    В мастере добавьте следующую запись. Обратите внимание, что все три ключа чувствительны к регистру. 

    &lt;useractivityfarmrole masterFQDN = [полное доменное имя выбранного первичного] Master = "true"/&gt;
    
    На других узлах добавьте следующую запись:

   &lt;useractivityfarmrole masterFQDN = [полное доменное имя выбранного первичного] Master = "false"/&gt;
 
    >[!NOTE] 
    >Так как несколько баз данных артефактов не синхронизируют данные, значения есл не будут синхронизированы между артефактом баз данных.
    Пользователь может попасть в другой центр обработки данных для запроса, поэтому ExtranetLockoutThreshold зависит от количества баз данных артефакта, ExtranetLockoutThreshold * количества артефактов баз данных. 
 
  - **Определение воспроизведения токенов** 
    
    Данные обнаружения для воспроизведения маркеров всегда вызываются из центральной базы данных артефактов. AD FS сохраняет маркер из отношения доверия поставщика утверждений, гарантируя, что один и тот же токен не может быть воспроизведен. Если злоумышленник пытается воспроизвести тот же маркер, AD FS проверяет, существует ли маркер в базе данных артефактов. Если маркер имеется, запрос будет отклонен. Центральная база данных артефактов используется для обеспечения безопасности, так как данные базы данных артефактов не реплицируются, злоумышленник может отправить запрос в другой центр обработки данных и воспроизвести маркер. Создание дополнительных копий Артифактдб, предназначенных только для чтения, не помешает задержкам обработки данных в этом сценарии, так как используется только центральная база данных артефактов.    
 
 