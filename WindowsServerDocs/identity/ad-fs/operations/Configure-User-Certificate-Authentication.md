---
ms.assetid: 1ea2e1be-874f-4df3-bc9a-eb215002da91
title: Настройка поддержки AD FS для проверки подлинности сертификата пользователя
author: jenfieldmsft
ms.author: billmath
manager: samueld
ms.date: 01/18/2018
ms.topic: article
ms.prod: windows-server
ms.technology: identity-adfs
ms.openlocfilehash: 6fa77276aa41dc59c3dd5a131b5d8fb8a3dd2e58
ms.sourcegitcommit: d5e27c1f2f168a71ae272bebf8f50e1b3ccbcca3
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/23/2020
ms.locfileid: "86965456"
---
# <a name="configuring-ad-fs-for-user-certificate-authentication"></a>Настройка AD FS для проверки подлинности сертификата пользователя

Проверка подлинности сертификата пользователя используется главным образом в двух вариантах использования.
* Пользователи используют смарт-карты для входа в систему AD FS
* Пользователи используют сертификаты, подготовленные для мобильных устройств


## <a name="prerequisites"></a>Обязательные условия
1) Определение режима AD FS проверки подлинности сертификата пользователя, который вы хотите включить с помощью одного из режимов, описанных в [этой статье](ad-fs-support-for-alternate-hostname-binding-for-certificate-authentication.md) .
2) Убедитесь, что ваша цепочка доверия сертификатов пользователей установлена & доверенной для всех серверов AD FS и WAP, включая промежуточные центры сертификации. Обычно это делается через объект групповой политики на серверах AD FS и WAP.
3)  Убедитесь, что корневой сертификат цепочки доверия для сертификатов пользователей находится в хранилище NTAuth в Active Directory
4) При использовании AD FS в режиме проверки подлинности в альтернативном сертификате убедитесь, что серверы AD FS и WAP имеют сертификаты SSL, содержащие имя узла AD FS с префиксом "цертаус", например "certauth.fs.contoso.com", и что трафик к этому имени узла разрешен через брандмауэр
5) Если используется проверка подлинности с помощью сертификата из экстрасети, убедитесь, что хотя бы один AIA и хотя бы одно расположение CDP или OCSP из списка, указанного в сертификатах, доступны из Интернета.
6) Кроме того, для проверки подлинности на базе сертификатов Azure AD для клиентов Exchange ActiveSync сертификат клиента должен иметь маршрутизируемый адрес электронной почты пользователей в Exchange Online либо в имени участника, либо в значении имени RFC822 в поле "альтернативное имя субъекта". (Azure Active Directory сопоставляет значение RFC822 с атрибутом Address прокси в каталоге.)
7) AD FS не поддерживает указания имен пользователей с проверкой подлинности на основе смарт-карты или сертификата. 


## <a name="configure-ad-fs-for-user-certificate-authentication"></a>Настройка AD FS для проверки подлинности пользователя на основе сертификата  

Включите аутентификацию сертификата пользователя в качестве метода проверки подлинности в интрасети или экстрасети в AD FS с помощью консоли управления AD FS или командлета PowerShell `Set-AdfsGlobalAuthenticationPolicy` .

Если вы настраиваете AD FS для проверки подлинности с помощью сертификата Azure AD, убедитесь, что настроены [Параметры Azure AD](/azure/active-directory/active-directory-certificate-based-authentication-get-started#step-2-configure-the-certificate-authorities) и [правила утверждений AD FS, необходимые](/azure/active-directory/active-directory-certificate-based-authentication-ios#requirements) для поставщика сертификата и серийного номера.

Кроме того, существуют некоторые дополнительные аспекты.
- Если вы хотите использовать утверждения на основе полей и расширений сертификата в дополнение к расширению EKU (тип утверждения https://schemas.microsoft.com/2012/12/certificatecontext/extension/eku) , настройте дополнительные утверждения, прошедшие через правила на Active Directory отношения доверия поставщика утверждений.  Полный список доступных заявок на сертификат см. ниже.  
- Если необходимо ограничить доступ на основе типа сертификата, можно использовать дополнительные свойства сертификата в AD FS правила авторизации выдачи для приложения. Типичные сценарии — "разрешить только сертификаты, подготовленные поставщиком MDM" или "разрешить только сертификаты смарт-карт".
>[!IMPORTANT]
> Клиенты, использующие поток кода устройства для проверки подлинности и выполняют проверку подлинности устройства с помощью IDP, отличного от Azure AD (например AD FS), не смогут применять доступ на основе устройств (например, разрешить использование управляемых устройств, использующих сторонние службы MDM) для ресурсов Azure AD. Чтобы защитить доступ к корпоративным ресурсам в Azure AD и предотвратить утечку данных, клиенты должны настроить условный доступ на основе устройств Azure AD (т. е. "требовать, чтобы устройство было помечено как жалоба" предоставлять управление в условном доступе Azure AD).
- Настройка разрешенных центров сертификации для сертификатов клиентов с помощью руководства в разделе "Управление доверенными издателями для проверки подлинности клиента" в [этой статье](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/dn786429(v=ws.11)).
- Вы можете изменить страницы входа в соответствии с потребностями конечных пользователей при проверке подлинности на основе сертификата. В общих случаях (а) изменение "входа с использованием сертификата X509" на более удобное для конечного пользователя действие

## <a name="configure-seamless-certificate-authentication-for-chrome-browser-on-windows-desktops"></a>Настройка простой проверки подлинности сертификатов для браузера Chrome на настольных компьютерах Windows
Если на компьютере, удовлетворяющем требованиям проверки подлинности клиента, имеется несколько сертификатов пользователей (например, сертификатов Wi-Fi), то браузер Chrome в Windows Desktop выдаст пользователю запрос на выбор правильного сертификата. Это может вызвать путаницу для конечного пользователя. Чтобы оптимизировать этот интерфейс, можно настроить политику для Chrome, чтобы автоматический выбор правильного сертификата для повышения удобства работы пользователей. Эта политика может быть задана вручную путем внесения изменений в реестр или настройки автоматически с помощью объекта групповой политики (для установки разделов реестра). Для этого необходимо, чтобы сертификаты клиента пользователя использовались для проверки подлинности AD FS, чтобы иметь отдельные издатели из других вариантов использования. 

Дополнительные сведения о настройке этого цвета для Chrome см. по этой [ссылке](http://www.chromium.org/administrators/policy-list-3#AutoSelectCertificateForUrls).  


## <a name="troubleshoot-certificate-authentication"></a>Устранение неполадок проверки подлинности сертификата
В этом документе рассматриваются распространенные проблемы, возникающие при настройке AD FS для проверки подлинности сертификатов для пользователей. 

### <a name="check-if-certificate-trusted-issuers-is-configured-properly-in-all-the-ad-fswap-servers"></a>Проверьте, правильно ли настроены надежные издатели сертификатов на всех серверах AD FS и WAP.
*Распространенный симптом: HTTP 204 "нет содержимого из HTTPS \: //certauth.ADFS.contoso.com"*

AD FS использует системную операционную систему Windows для подтверждения принадлежности сертификата пользователя и обеспечения его соответствия доверенному издателю путем выполнения проверки цепочки доверия сертификатов. Для сопоставления с доверенным издателем необходимо убедиться, что все корневые и промежуточные центры настроены как Доверенные издатели в хранилище центров сертификации локального компьютера. Чтобы проверить это автоматически, используйте [анализатор диагностики AD FS](https://adfshelp.microsoft.com/DiagnosticsAnalyzer/Analyze). Средство запрашивает все серверы и обеспечивает правильную подготовку правильных сертификатов. 
1)  Скачайте и запустите средство в соответствии с инструкциями, приведенными на приведенной выше ссылке.
2)  Отправка результатов и проверка любых сбоев

### <a name="check-if-certificate-authentication-is-enabled-in-the-ad-fs-authentication-policy"></a>Проверка включения проверки подлинности сертификата в политике проверки подлинности AD FS
По умолчанию AD FS не включает проверку подлинности сертификата. Сведения о том, как включить проверку подлинности с помощью сертификата, см. в начале этого документа. 

### <a name="check-if-certificate-authentication-is-enabled-in-the-ad-fs-authentication-policy"></a>Проверка включения проверки подлинности сертификата в политике проверки подлинности AD FS
AD FS выполняет проверку подлинности сертификата пользователя по умолчанию для порта 49443 с тем же именем узла, что и AD FS (например, `adfs.contoso.com` ). Можно также настроить AD FS для использования порта 443 (HTTPS-порт по умолчанию) с помощью альтернативной привязки SSL. Однако URL-адрес, используемый в этой конфигурации, — `certauth.<adfs-farm-name>` (например, `certauth.contoso.com` ). Дополнительные сведения см. в [этой ссылке](ad-fs-support-for-alternate-hostname-binding-for-certificate-authentication.md) . Наиболее распространенным случаем сетевого подключения является то, что брандмауэр настроен неправильно и блокирует или мешает трафику проверки подлинности сертификата пользователя. Как правило, при возникновении этой проблемы отображается пустой экран или ошибка сервера 500. 
1)  Обратите внимание на имя узла и порт, настроенные в AD FS
2)  Убедитесь, что все брандмауэры перед AD FS или прокси веб-приложения (WAP) настроены для разрешения `hostname:port` комбинации для фермы AD FS. Чтобы выполнить этот шаг, вам потребуется обратиться к инженеру сети. 

### <a name="check-certificate-revocation-list-connectivity"></a>Проверка подключения к списку отзыва сертификатов
Списки отзыва сертификатов (CRL) — это конечные точки, которые кодируются в сертификат пользователя для выполнения проверок отзыва во время выполнения. Например, если украдено устройство, содержащее сертификат, администратор может добавить сертификат в список отозванных сертификатов. Все конечные точки, которые приняли этот сертификат ранее, теперь не проходят проверку подлинности.

Каждому AD FS и WAP-серверу необходимо подключиться к конечной точке списка отзыва сертификатов, чтобы проверить, является ли сертификат, который был предоставлен, действительным и не отозванным. Проверка списка отзыва сертификатов может выполняться по протоколам HTTPS, HTTP, LDAP или по протоколу OCSP (Online Certificate Status Protocol). Если AD FS или WAP-серверы не могут связаться с конечной точкой, проверка подлинности завершится ошибкой. Выполните следующие действия, чтобы устранить неполадки. 
1) Обратитесь к своему инженеру PKI, чтобы определить конечные точки списка отзыва сертификатов, используемые для отзыва сертификатов пользователей из системы PKI. 
2)  На каждом AD FS или сервере WAP убедитесь, что конечные точки списка отзыва сертификатов достижимы через используемый протокол (обычно HTTPS или HTTP).
3)  Для расширенной проверки [включите ведение журнала событий CAPI2](/archive/blogs/benjaminperkins/enable-capi2-event-logging-to-troubleshoot-pki-and-ssl-certificate-issues) на каждом сервере AD FS или WAP.
4) Проверьте наличие события с ИДЕНТИФИКАТОРом 41 (проверка отзыва) в операционных журналах CAPI2.
5) Проверка на наличие`‘\<Result value="80092013"\>The revocation function was unable to check revocation because the revocation server was offline.\</Result\>'`

***Совет***. Вы можете выбрать один AD FS или сервер WAP для упрощения устранения неполадок, настроив разрешение DNS (файл hosts в Windows), чтобы указать конкретный сервер. Это позволяет включить трассировку, предназначенную для сервера. 

### <a name="check-if-this-is-a-server-name-indication-sni-issue"></a>Проверьте, является ли проблема указание имени сервера (SNI).
AD FS требует, чтобы клиентское устройство (или браузеры) и подсистемы балансировки нагрузки поддерживали SNI. Некоторые клиентские устройства (обычно старые версии Android) могут не поддерживать SNI. Кроме того, подсистемы балансировки нагрузки могут не поддерживать SNI или не настроены для SNI. В этих экземплярах, скорее всего, будут отображаться ошибки сертификации пользователей. 
1)  Обратитесь к инженеру сети, чтобы убедиться, что Load Balancer для AD FS/WAP поддерживает SNI.
2)  В случае, если поддержка SNI не поддерживается AD FS есть решение, описанное ниже.
    *   Откройте окно командной строки с повышенными привилегиями на основном сервере AD FS
    *   Тип в ```Netsh http show sslcert```
    *   Скопируйте "идентификатор GUID приложения" и "хэш сертификата" службы федерации.
    *   Тип в `netsh http add sslcert ipport=0.0.0.0:{your_certauth_port} certhash={your_certhash} appid={your_applicaitonGUID}`

### <a name="check-if-the-client-device-has-been-provisioned-with-the-certificate-correctly"></a>Проверьте, правильно ли настроено клиентское устройство с сертификатом.
Вы можете заметить, что некоторые устройства работают правильно, но другие устройства — нет. В этом случае, как правило, это результат неправильной подготовки сертификата пользователя на клиентском устройстве. Выполните следующие действия. 
1)  Если эта ошибка связана с устройством Android, наиболее распространенной проблемой является то, что цепочка сертификатов не является полностью доверенной на устройстве Android.  Обратитесь к поставщику MDM, чтобы убедиться, что сертификат правильно подготовлен, а вся цепочка полностью доверена на устройстве Android. 
2)  Если эта ошибка связана с устройством Windows, проверьте, правильно ли подготовлен сертификат, путем проверки хранилища сертификатов Windows на наличие вошедшего в систему пользователя (не системы или компьютера).
3)  Экспортируйте сертификат пользователя клиента в CER-файл и выполните команду "certutil — f-урлфетч-Verify цертификатефиленаме. cer".


### <a name="check-if-the-tls-version-is-compatible-between-ad-fswap-servers-and-the-client-device"></a>Проверьте, совместима ли версия TLS между серверами AD FS/WAP и клиентским устройством.
В редких случаях клиентское устройство (как правило, мобильные устройства) обновляется для поддержки более высокой версии TLS (скажем, 1,3), или может возникнуть обратная проблема, при которой серверы AD FS/WAP были обновлены для использования только более высокой версии TLS, а клиентское устройство не поддерживает его. Вы можете использовать средства SSL в Интернете для проверки серверов AD FS и WAP и проверить, совместим ли он с устройством. Дополнительные сведения об управлении версиями TLS см. по [этой ссылке](manage-ssl-protocols-in-ad-fs.md).

### <a name="check-if-azure-ad-promptloginbehavior-is-configured-correctly-on-your-federated-domain-settings"></a>Проверьте, правильно ли настроены параметры федеративного домена Azure AD Промптлогинбехавиор.
Многие приложения Office 365 отправляют запрос на вход в Azure AD. По умолчанию Azure AD преобразует его в имя входа нового пароля в AD FS. В результате, даже если вы настроили проверку подлинности на сертификат в AD FS, конечные пользователи увидят только вход с паролем. 
1)  Получите параметры федеративного домена с помощью команды "Get-MsolDomainFederationSettings"
2)  Убедитесь, что для параметра Промптлогинбехавиор задано значение "Disabled" или "Нативесуппорт".

Дополнительные сведения см. в [этой ссылке](ad-fs-prompt-login.md). 

### <a name="additional-troubleshooting"></a>Дополнительные сведения об устранении неполадок
Это редкие случаи.
1)  Если списки CRL являются очень длинными, при попытке загрузки может потребоваться время ожидания. В этом случае необходимо обновить "MaxFieldLength" и "Максрекуестбите" согласноhttps://support.microsoft.com/help/820129/http-sys-registry-settings-for-windows




## <a name="reference-complete-list-of-user-certificate-claim-types-and-example-values"></a>Ссылка: полный список типов утверждений сертификатов пользователей и примеры значений

|                                         Тип утверждения                                         |                              Пример значения                               |
|--------------------------------------------------------------------------------------------|--------------------------------------------------------------------------|
|         https://schemas.microsoft.com/2012/12/certificatecontext/field/x509version         |                                    3                                     |
|     https://schemas.microsoft.com/2012/12/certificatecontext/field/signaturealgorithm      |                                sha256RSA                                 |
|           https://schemas.microsoft.com/2012/12/certificatecontext/field/issuer            |                 CN = ентка, DC = Domain, DC = contoso, DC = com                  |
|         https://schemas.microsoft.com/2012/12/certificatecontext/field/issuername          |                 CN = ентка, DC = Domain, DC = contoso, DC = com                  |
|          https://schemas.microsoft.com/2012/12/certificatecontext/field/notbefore          |                           12/05/2016 20:50:18                            |
|          https://schemas.microsoft.com/2012/12/certificatecontext/field/notafter           |                           12/05/2017 20:50:18                            |
|           https://schemas.microsoft.com/2012/12/certificatecontext/field/subject           |   E = user@contoso.com , CN = пользователь, CN = Users, DC = Domain, DC = contoso, DC = com   |
|         https://schemas.microsoft.com/2012/12/certificatecontext/field/subjectname         |   E = user@contoso.com , CN = пользователь, CN = Users, DC = Domain, DC = contoso, DC = com   |
|           https://schemas.microsoft.com/2012/12/certificatecontext/field/rawdata           |                {Данные цифрового сертификата в кодировке Base64}                 |
|        https://schemas.microsoft.com/2012/12/certificatecontext/extension/keyusage         |                             DigitalSignature                             |
|        https://schemas.microsoft.com/2012/12/certificatecontext/extension/keyusage         |                             KeyEncipherment                              |
|  https://schemas.microsoft.com/2012/12/certificatecontext/extension/subjectkeyidentifier   |                 9D11941EC06FACCCCB1B116B56AA97F3987D620A                 |
| https://schemas.microsoft.com/2012/12/certificatecontext/extension/authoritykeyidentifier  |    KeyID = D6 13 E3 6B BC = D8 15 52 0A демон 36 6a D5 0b 51 F3 0b 25 7F     |
| https://schemas.microsoft.com/2012/12/certificatecontext/extension/certificatetemplatename |                                   Пользователь                                   |
|           https://schemas.microsoft.com/2012/12/certificatecontext/extension/san           | Другое имя: имя участника = user@contoso.com , RFC822 имя =user@contoso.com |
|           https://schemas.microsoft.com/2012/12/certificatecontext/extension/eku           |                          1.3.6.1.4.1.311.10.3.4                          |

## <a name="related-links"></a>Связанные ссылки
* [Настройка альтернативной привязки имени узла для AD FS проверки подлинности сертификата](ad-fs-support-for-alternate-hostname-binding-for-certificate-authentication.md)
* [Настройка центров сертификации в Azure AD](/azure/active-directory/active-directory-certificate-based-authentication-get-started#step-2-configure-the-certificate-authorities)
