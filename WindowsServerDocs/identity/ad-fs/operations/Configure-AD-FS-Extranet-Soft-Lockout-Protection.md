---
ms.assetid: 777aab65-c9c7-4dc9-a807-9ab73fac87b8
title: Настройка защиты блокировки экстрасети AD FS
description: ''
author: billmath
ms.author: billmath
manager: femila
ms.date: 02/01/2019
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: identity-adfs
ms.openlocfilehash: 37b8c4b9b07e3111fce1bfc0a9aae10c8754bb3a
ms.sourcegitcommit: 0d0b32c8986ba7db9536e0b8648d4ddf9b03e452
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2019
ms.locfileid: "59884635"
---
# <a name="configure-ad-fs-extranet-lockout-protection"></a>Настройка защиты блокировки экстрасети AD FS

>Область применения. Windows Server 2012 R2

В AD FS на Windows Server 2012 R2 была представлена функция безопасности называется экстрасети.  С помощью этой функции AD FS будет «stop» проверка подлинности «вредоносный» учетную запись из за пределами в течение заданного времени.  Это предотвращает возможность блокируется в Active Directory учетные записи пользователей.  В дополнение к защите пользователей от блокировки учетных записей AD, блокировка экстрасети AD FS также обеспечивает защиту от атак подбора пароля

> [!NOTE]
> Эта функция работает только для **экстрасети** там, где запросы проверки подлинности, были переданы через прокси веб-приложения и применяется только к **проверки подлинности имя пользователя и пароль**.

## <a name="advantages-of-extranet-lockout"></a>Преимуществами экстрасети
Блокировка экстрасети обеспечивает следующие ключевые преимущества:
- Он защищает учетные записи пользователей из **атак методом подбора** где злоумышленник пытается угадать пароль пользователя, постоянно отправляя запросы проверки подлинности. В этом случае AD FS приведут к блокировке учетной записи пользователь-злоумышленник для доступа к экстрасети
- Он защищает учетные записи пользователей из **блокировки вредоносных учетных записей** где злоумышленник хочет блокировать учетную запись пользователя, отправляя запросы проверки подлинности с паролями не так. Таким образом несмотря на то, что учетная запись пользователя будет заблокирована с помощью AD FS для доступа к экстрасети, учетной записью пользователя в AD не заблокирована, и пользователь по-прежнему можно получить доступ к корпоративным ресурсам в пределах организации. Этот процесс называется **обратимо блокировки**.

## <a name="how-it-works"></a>Как это работает
Существует 3 параметра в AD FS, необходимо настроить для включения этой функции. 
- **EnableExtranetLockout &lt;логическое&gt;**  задать логическое значение True, если вы хотите включить экстрасети.
- **ExtranetLockoutThreshold &lt;целое число&gt;**  определяет максимальное количество попытки ввода неправильного пароля. При достижении порогового значения службы федерации Active Directory будет немедленно отклоняет запросы из экстрасети не пытается связаться с контроллером домена для проверки подлинности, независимо от того, является ли пароль хорошего или плохого, пока не передается окно экстрасети наблюдения. Это означает, что значение **badPwdCount** атрибут учетной записи AD, не будут увеличиваться при soft блокировки учетной записи.
- **ExtranetObservationWindow &lt;TimeSpan&gt;**  определяет, сколько пользователя учетная запись будет soft заблокирована. AD FS начнет выполнять попытку проверки подлинности имя пользователя и пароль, при передаче окна. AD FS использует badPasswordTime атрибут AD в качестве ссылки для определения, прошел ли окно экстрасети наблюдения или нет. Окна прошел в том случае, если текущее время > badPasswordTime + ExtranetObservationWindow. 

> [!NOTE]
> Функции блокировки экстрасети AD FS независимо от политики блокировки AD. Тем не менее, мы настоятельно рекомендуем создать **ExtranetLockoutThreshold** значение параметра значение меньше, чем пороговое значение блокировки учетной записи AD. Невыполнение этого действия приведет к AD FS, когда не удается, для защиты учетных записей были заблокированы в Active Directory. 

Пример включения функции экстрасети не более 15 число попытки ввода неправильного пароля и 30 мин soft-блокировка выглядит следующим образом:

```powershell
Set-AdfsProperties -EnableExtranetLockout $true -ExtranetLockoutThreshold 15 -ExtranetObservationWindow (new-timespan -Minutes 30)
```

Эти параметры будут применяться ко всем доменам, которые могут проверять подлинность службы AD FS. То, что он работает является AD FS, получив запрос на проверку подлинности, будет обращаться запрос LDAP из основного контроллера домена (PDC) и уточняющего запроса для **badPwdCount** атрибут для пользователя на основном контроллере домена. Если службы федерации Active Directory выполняет поиск значения **badPwdCount** > = параметр ExtranetLockoutThreshold и времени, определенному в экстрасети окно наблюдения не передан, но AD FS будет отклонять запрос немедленно, это означает, независимо от того, следует ли пользователь вводит пароль хорошего или плохого из экстрасети, то вход будет невозможен, так как AD FS не отправляет учетные данные AD. Службы федерации Active Directory не сохраняет любое состояние относится к **badPwdCount** или блокировки учетных записей пользователей. AD FS использует AD для отслеживания состояния всех. 

> [!warning]
> При включении блокировки экстрасети AD FS на Server 2012 R2 AD FS на PDC проверяются все запросы проверки подлинности через WAP. Если основной контроллер домена недоступен, пользователи смогут проходить проверку подлинности из экстрасети.

Server 2016 предоставляет дополнительный параметр, который позволяет AD FS для возврата на другом контроллере домена, если основной контроллер домена недоступен.

- **ExtranetLockoutRequirePDC &lt;логическое&gt;**  — при включении: блокировка экстрасети требует основного контроллера домена (PDC). При отключении: блокировка экстрасети будут переведены на другом контроллере домена, на случай, если основной контроллер домена недоступен.

Настройка блокировки экстрасети AD FS на Server 2016 можно использовать следующую команду Windows PowerShell:

```powershell
Set-AdfsProperties -EnableExtranetLockout $true -ExtranetLockoutThreshold 15 -ExtranetObservationWindow (new-timespan -Minutes 30) -ExtranetLockoutRequirePDC $false
```

## <a name="working-with-the-active-directory-lockout-policy"></a>Работа с политика блокировки Active Directory
Средство блокировки экстрасети AD FS независимы друг от друга политики блокировки AD. Тем не менее необходимо убедиться, что параметры для блокировка экстрасети настроена должным образом, чтобы обслуживать его назначение безопасности с помощью политики блокировки AD.
Давайте взглянем на политики блокировки AD первого. Существует три параметра, касающиеся политики блокировки в AD:
- **Учетная запись пороговое значение блокировки**: этот параметр аналогичен параметр ExtranetLockoutThreshold в AD FS. Он определяет число неудачных попыток входа, которые приведут к блокировке учетной записи пользователя. Чтобы защитить учетные записи пользователей от атаки блокировки вредоносных учетной записи, нужно задать значение ExtranetLockoutThreshold в AD FS &lt; значение пороговое значение блокировки учетной записи в AD
- **Учетная запись блокировка**: этот параметр определяет, сколько пользователя учетная запись заблокирована. Этот параметр не играет роли гораздо в этом диалоге экстрасети всегда должны быть выполнены, прежде чем произойдет блокировка AD, если настроен должным образом
- **Сбросить счетчик блокировки учетной записи после**: этот параметр определяет, сколько времени должно пройти после сбоя последнего входа пользователя перед **badPwdCount** сбрасывается на 0. Чтобы функция экстрасети в AD FS для работы с политики блокировки AD, вы хотите убедитесь, что значение ExtranetObservationWindow в AD FS &gt; значение учетной записи сброса счетчика блокировки в AD. В приведенных ниже примерах объясняется, почему.  

Давайте рассмотрим два примера и посмотрим, как **badPwdCount** меняются с течением времени, на основании различных параметров и состояния. Предположим, в обоих примерах **пороговое значение блокировки** = 4 и **ExtranetLockoutThreshold** = 2. **Red** стрелка представляет вводе неправильного пароля выполнялся **зеленый** стрелка представляет сообщение об ошибке попытки хороший пароль. В примере #1 **ExtranetObservationWindow** &gt; **учетной записи сброса счетчика блокировки**. В примере #2 **ExtranetObservationWindow** &lt; **учетной записи сброса счетчика блокировки**. 

### <a name="example-1"></a>Пример 1
![Пример 1](media/Configure-AD-FS-Extranet-Lockout-Protection/one.png)

### <a name="example-2"></a>Пример 2
![Пример 1](media/Configure-AD-FS-Extranet-Lockout-Protection/two.png)

Как видно из указанных выше, существует два условия **badPwdCount** сбрасывается до 0. Одна — при успешном входе в систему. Второе — когда придет время, чтобы сбросить этот счетчик, как определено в **учетной записи сброса счетчика блокировки** параметр. Когда **учетной записи сброса счетчика блокировки** &lt; **ExtranetObservationWindow**, учетной записи не имеет каких-либо взносов блокировки службой AD. Тем не менее если **учетной записи сброса счетчика блокировки** &gt; **ExtranetObservationWindow**, есть вероятность того, учетной записи может быть блокировки AD, но в «отложенной манере». Он может занять некоторое время для получения учетной записи заблокирован службой AD в зависимости от конфигурации AD FS может позволить один вводе неправильного пароля выполнялся только во время его окно наблюдения до **badPwdCount** достигает **пороговое значение блокировки учетной записи** .

Дополнительные сведения см. в разделе [настройки блокировки учетных записей](https://blogs.technet.microsoft.com/secguide/2014/08/13/configuring-account-lockout/). 

## <a name="known-issues"></a>Известные проблемы
Имеется известная проблема, где учетная запись пользователя AD не может проверить подлинность с помощью AD FS поскольку **badPwdCount** атрибут не реплицируется на контроллер домена, в которой запрос служб федерации Active Directory. См. в разделе [2971171](https://support.microsoft.com/help/2971171/adfs-authentication-issue-for-active-directory-users-when-extranet-loc) для получения дополнительных сведений. Можно найти все QFE AD FS, которые были выпущены до сих [здесь](../deployment/updates-for-active-directory-federation-services-ad-fs.md).

## <a name="key-points-to-remember"></a>Главное
- Блокировка экстрасети возможность доступна только для **экстрасети** источник запросов на проверку подлинности через прокси веб-приложения
- Блокировка экстрасети функция применяется только к **проверки подлинности имя пользователя и пароль**
- AD FS не отслеживать любой **badPwdCount** или пользователей, которым soft заблокирована. AD FS использует AD для отслеживания состояния всех
- Службы федерации Active Directory выполняет поиск для **badPwdCount** атрибута с помощью вызова LDAP для пользователя на основной контроллер домена для каждой попытки проверки подлинности  
- AD FS старше 2016 завершится ошибкой, если он не может получить доступ к основным контроллером домена. AD FS 2016 появился улучшения, которые позволят AD FS на переключение на другие контроллеры домена, в случае основной контроллер домена недоступен. 
- AD FS будет разрешать запросы проверки подлинности из экстрасети Если badPwdCount < ExtranetLockoutThreshold 
- Если **badPwdCount** >= **ExtranetLockoutThreshold** AND **badPasswordTime** + **ExtranetObservationWindow** < Текущее время, AD FS будет отклонять запросы на проверку подлинности из экстрасети
- Чтобы избежать блокировки вредоносных учетных записей, следует убедиться в том **ExtranetLockoutThreshold** < **пороговое значение блокировки** AND **ExtranetObservationWindow**  >  **Сбросить счетчик блокировки учетной записи**


## <a name="additional-references"></a>Дополнительная справка  
- [Рекомендации по обеспечению безопасности служб федерации Active Directory](../../ad-fs/deployment/best-practices-securing-ad-fs.md)
- [Делегирование доступа командлета Powershell AD FS для пользователей без прав администратора](delegate-ad-fs-pshell-access.md)
- [Set-AdfsProperties](https://technet.microsoft.com/itpro/powershell/windows/adfs/set-adfsproperties)

[Операции AD FS](../../ad-fs/AD-FS-2016-Operations.md)

    
