---
title: Составной домен Active Directory службы проверки подлинности и утверждения в службах федерации Active Directory
description: Следующий документ описывает комплексной проверки подлинности и утверждения AD DS в AD FS.
author: billmath
ms.author: billmath
manager: femila
ms.date: 09/07/2017
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: identity-adfs
ms.openlocfilehash: 270fb6efd63e6355c410ee45d09e6fd16b14222b
ms.sourcegitcommit: 0d0b32c8986ba7db9536e0b8648d4ddf9b03e452
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2019
ms.locfileid: "59867995"
---
# <a name="compound-authentication-and-ad-ds-claims-in-ad-fs"></a>Комплексная аутентификация и утверждения AD DS в AD FS
Windows Server 2012 расширяет возможности проверки подлинности Kerberos путем введения комплексной проверки подлинности.  Комплексной проверки подлинности позволяет включать два удостоверения запрос службы предоставления билетов Kerberos (TGS): 

- удостоверение пользователя
- Идентификация на устройстве пользователя.  

Windows выполняет комплексной проверки подлинности, расширив [Kerberos туннелирование для гибкой проверки подлинности безопасности (FAST) и защиты Kerberos](https://technet.microsoft.com/library/hh831747.aspx). 

AD FS 2012 и более поздних версий позволяет потребление из AD DS, которые выданы утверждения пользователей или устройств, которые находятся в билет проверки подлинности Kerberos. В предыдущих версиях служб AD FS утверждения ядра может только читать группы безопасности (SID) пользователя и от Kerberos, но не смог читать любой утверждений сведений, содержащихся в билет Kerberos.

Вы можете включить больше возможностей управления доступом для федеративных приложений с помощью доменных служб Active Directory (AD DS)-друг с другом, выданных утверждений пользователей и устройств со службами федерации Active Directory (AD FS).

## <a name="requirements"></a>Требования
1.  Компьютеров, подключающихся к федеративным приложениям, должно пройти проверку подлинности с помощью AD FS **встроенную проверку подлинности Windows**. 
    - Встроенная проверка подлинности Windows доступна только при подключении к внутренним серверам AD FS.
    - Компьютеры должны иметь доступ к AD FS внутренних серверов для имени службы федерации
    - Серверы AD FS должно предоставляться встроенную проверку подлинности Windows, как метод основной проверки подлинности в его параметры интрасети.

2.  Политика **поддержка клиента Kerberos для утверждений, комплексной проверки подлинности и защиты Kerberos** должны применяться ко всем компьютерам, доступа к федеративным приложениям, которые защищены с помощью комплексной проверки подлинности. Это применимо, в случае одного леса или перекрестный сценариев леса.

3.  Домен размещены серверы AD FS должен иметь **поддержка центра распространения КЛЮЧЕЙ для утверждений комплексной проверки подлинности и защиты Kerberos** параметр политики, применяемых к контроллерам домена.

## <a name="steps-for-configuring-ad-fs-in-windows-server-2012-r2"></a>Действия по настройке AD FS на Windows Server 2012 R2
Выполните следующие действия по настройке комплексной проверки подлинности и утверждения 

### <a name="step-1--enable-kdc-support-for-claims-compound-authentication-and-kerberos-armoring-on-the-default-domain-controller-policy"></a>Шаг 1.  Включите поддержку KDC для утверждений, комплексной проверки подлинности и защиты Kerberos на политику контроллера домена по умолчанию
1.  В диспетчере серверов выберите Инструменты, **Управление групповой политикой**.
2.  Перейдите вниз к **политику контроллера домена по умолчанию**, щелкните правой кнопкой мыши и выберите **изменить**.
![Управление групповой политикой](media/AD-FS-Compound-Authentication-and-AD-DS-claims/gpmc1.png)
3.  На **редактор управления групповыми политиками**в разделе **Конфигурация компьютера**, разверните **политики**, разверните **административные шаблоны** , разверните **системы**и выберите **KDC**.
4.  В области справа дважды щелкните **поддержка центра распространения КЛЮЧЕЙ для утверждений, комплексной проверки подлинности и защиты Kerberos**.
![Управление групповой политикой](media/AD-FS-Compound-Authentication-and-AD-DS-claims/gpmc2.png)
5.  В диалоговом окне Новый набор поддержка KDC для утверждений для **включено**.
6.  В параметрах щелкните **поддерживаемые** раскрывающееся меню и выберите пункт **применить** и **ОК**.
![Управление групповой политикой](media/AD-FS-Compound-Authentication-and-AD-DS-claims/gpmc3.png)

### <a name="step-2-enable-kerberos-client-support-for-claims-compound-authentication-and-kerberos-armoring-on-computers-accessing-federated-applications"></a>Шаг 2. Включение поддержки клиента Kerberos для утверждений, комплексной проверки подлинности и защиты Kerberos на компьютерах, доступ к федеративным приложениям

1.  Групповые политики, применимые к компьютерам, доступа к федеративным приложениям в **редактор управления групповыми политиками**в разделе **Конфигурация компьютера**, разверните **политики**, разверните **административные шаблоны**, разверните **системы**и выберите **Kerberos**.
2.  В области справа в окне редактора управления групповыми политиками дважды щелкните **поддержка клиента Kerberos для утверждений, комплексной проверки подлинности и защиты Kerberos.**
3.  В диалоговом окне Новый присвоено поддержка клиента Kerberos **включено** и нажмите кнопку **применить** и **ОК**.
![Управление групповой политикой](media/AD-FS-Compound-Authentication-and-AD-DS-claims/gpmc4.png)
4.  Закройте редактор управления групповыми политиками.

### <a name="step-3-ensure-the-ad-fs-servers-have-been-updated"></a>Шаг 3. Убедитесь, что серверы AD FS были обновлены.
Необходимо убедиться, что следующие обновления установлены на серверах AD FS.

|Обновление|Описание|
|----- | ----- |
|[KB2919355](https://www.microsoft.com/download/details.aspx?id=42335)|Накопительное обновление системы безопасности (включая KB2919355, KB2932046, KB2934018, KB2937592, KB2938439)|
|[KB2959977](https://www.microsoft.com/download/details.aspx?id=42530)|Обновление для Server 2012 R2|
|[Исправление 3052122](https://support.microsoft.com/help/3052122/update-adds-support-for-compound-id-claims-in-ad-fs-tokens-in-windows)|Это обновление добавляет поддержку для комплексной идентификатор утверждений в службах федерации Active Directory.|

### <a name="step-4-configure-the-primary-authentication-provider"></a>Шаг 4. Настройка поставщика основной проверки подлинности

1. Значение основного поставщика проверки подлинности **проверки подлинности Windows** для настройки AD FS интрасети.
2. В управлении AD FS в разделе **политики проверки подлинности**выберите **основной проверки подлинности** и в разделе **глобальные параметры** щелкните **изменить**.
3. На **изменение глобальной политики проверки подлинности** под **интрасети** выберите **проверки подлинности Windows**.
4. Нажмите кнопку **применить** и **ОК**.

![Управление групповой политикой](media/AD-FS-Compound-Authentication-and-AD-DS-claims/gpmc5.png)

5. С помощью PowerShell, можно использовать **Set-AdfsGlobalAuthenticationPolicy** командлета.

``` powershell
Set-AdfsGlobalAuthenticationPolicy -PrimaryIntranetAuthenticationProvider 'WindowsAuthentication'
```
>[!NOTE]
>На WID на ферме, PowerShell, команда должна выполняться на основном сервере AD FS.
>В ферме, на основе SQL команда PowerShell может выполняться на любом сервере AD FS, которая является членом фермы.

### <a name="step-5--add-the-claim-description-to-ad-fs"></a>Шаг 5.  Добавление описания утверждения для AD FS
1.  Добавьте следующее описание утверждений в ферму. Это описание утверждения не указан, по умолчанию в ADFS 2012 R2 и необходимо вручную добавить.
2.  В управлении AD FS в разделе **службы**, щелкните правой кнопкой мыши **заявки с описанием** и выберите **добавить заявки с описанием**
3.  Введите следующие сведения в описании утверждения
    - Отображаемое имя: «Группа устройств Windows» 
    - Описание утверждения: "https://schemas.microsoft.com/ws/2008/06/identity/claims/windowsdevicegroup" "
4. Установите флажок в обоих полях.
5. Нажмите кнопку **ОК**.

![Описание утверждения](media/AD-FS-Compound-Authentication-and-AD-DS-claims/gpmc6.png)

6. С помощью PowerShell, можно использовать **AdfsClaimDescription добавить** командлета.
``` powershell
Add-AdfsClaimDescription -Name 'Windows device group' -ClaimType 'https://schemas.microsoft.com/ws/2008/06/identity/claims/windowsdevicegroup' `
-ShortName 'windowsdevicegroup' -IsAccepted $true -IsOffered $true -IsRequired $false -Notes 'The windows group SID of the device' 
```


>[!NOTE]
>На WID на ферме, PowerShell, команда должна выполняться на основном сервере AD FS.
>В ферме, на основе SQL команда PowerShell может выполняться на любом сервере AD FS, которая является членом фермы.

### <a name="step-6--enable-the-compound-authentication-bit-on-the-msds-supportedencryptiontypes-attribute"></a>Шаг 6.  Включить бит комплексной проверки подлинности по атрибуту msDS-SupportedEncryptionTypes

1.  Включить бит атрибут msDS-SupportedEncryptionTypes для учетной записи, которую вы назначили для запуска службы AD FS с помощью комплексной проверки подлинности **Set-ADServiceAccount** командлета PowerShell.  

>[!NOTE]
>Если учетная запись службы изменена, то необходимо вручную включить комплексной проверки подлинности, выполнив **Set-ADUser - compoundIdentitySupported: $true** командлетов Windows PowerShell.

``` powershell
Set-ADServiceAccount -Identity “ADFS Service Account” -CompoundIdentitySupported:$true 
```
2.  Перезапустите службу ADFS.

>[!NOTE]
>После «CompoundIdentitySupported» имеет значение true, Установка групповой управляемой учетной записи, на новый серверы (2012 R2/2016) происходит сбой со следующей ошибкой — **Install-ADServiceAccount: Не удается установить учетную запись службы. Сообщение об ошибке: «Предоставленный контекст не соответствует целевой объект».** .
>
>**Решение**. Временно задать CompoundIdentitySupported значение $false. В результате этого действия служб федерации Active Directory, прекращение выпуска WindowsDeviceGroup утверждений. SET-ADServiceAccount — удостоверения «Учетная запись службы для служб федерации Active Directory» - CompoundIdentitySupported: $false, установить групповой управляемой учетной записи на новом сервере, а затем включите CompoundIdentitySupported обратно значение $True.
Отключение CompoundIdentitySupported и затем повторное включение не требуется перезапуск службы ADFS.

### <a name="step-7-update-the-ad-fs-claims-provider-trust-for-active-directory"></a>Шаг 7. Обновление AD FS отношение доверия поставщика утверждений для Active Directory

1. Обновите AD FS отношением доверия поставщика утверждений для Active Directory включить следующее правило для утверждений «Сквозная» для утверждения «WindowsDeviceGroup».
2.  В **управления AD FS**, нажмите кнопку **отношения доверия поставщиков утверждений** и в области справа щелчку **Active Directory** и выберите **изменение правил для утверждений**.
3.  На **изменение правил для утверждений для Active Director** щелкните **добавить правило**.
4.  На **утверждения мастере добавления правила преобразования** выберите **пропуск или Фильтрация входящего утверждения** и нажмите кнопку **Далее**.
5.  Добавить отображаемое имя и выберите **группу устройств Windows** из **тип входящего утверждения** раскрывающегося списка.
6.  Нажмите кнопку **Готово**.  Нажмите кнопку **применить** и **ОК**. 
![Описание утверждения](media/AD-FS-Compound-Authentication-and-AD-DS-claims/gpmc7.png)

### <a name="step-8-on-the-relying-party-where-the-windowsdevicegroup-claims-are-expected-add-a-similar-pass-through-or-transform-claim-rule"></a>Шаг 8. На проверяющей стороне, где ожидаются утверждения «WindowsDeviceGroup» добавьте аналогичные правила утверждения «Сквозная» или «Преобразование».
2.  В **управления AD FS**, нажмите кнопку **доверия проверяющей стороны** и в области справа щелчку к RP и выберите **изменение правил для утверждений**.
3.  На **правила преобразования выдачи** щелкните **добавить правило**.
4.  На **утверждения мастере добавления правила преобразования** выберите **пропуск или Фильтрация входящего утверждения** и нажмите кнопку **Далее**.
5.  Добавить отображаемое имя и выберите **группу устройств Windows** из **тип входящего утверждения** раскрывающегося списка.
6.  Нажмите кнопку **Готово**.  Нажмите кнопку **применить** и **ОК**.
![Описание утверждения](media/AD-FS-Compound-Authentication-and-AD-DS-claims/gpmc8.png)


##<a name="steps-for-configuring-ad-fs-in-windows-server-2016"></a>Действия по настройке AD FS на Windows Server 2016
Ниже подробно описываются действия по настройке комплексной проверки подлинности в AD FS для Windows Server 2016.

### <a name="step-1--enable-kdc-support-for-claims-compound-authentication-and-kerberos-armoring-on-the-default-domain-controller-policy"></a>Шаг 1.  Включите поддержку KDC для утверждений, комплексной проверки подлинности и защиты Kerberos на политику контроллера домена по умолчанию
1.  В диспетчере серверов выберите Инструменты, **Управление групповой политикой**.
2.  Перейдите вниз к **политику контроллера домена по умолчанию**, щелкните правой кнопкой мыши и выберите **изменить**.
3.  На **редактор управления групповыми политиками**в разделе **Конфигурация компьютера**, разверните **политики**, разверните **административные шаблоны** , разверните **системы**и выберите **KDC**.
4.  В области справа дважды щелкните **поддержка центра распространения КЛЮЧЕЙ для утверждений, комплексной проверки подлинности и защиты Kerberos**.
5.  В диалоговом окне Новый набор поддержка KDC для утверждений для **включено**.
6.  В параметрах щелкните **поддерживаемые** раскрывающееся меню и выберите пункт **применить** и **ОК**.


### <a name="step-2-enable-kerberos-client-support-for-claims-compound-authentication-and-kerberos-armoring-on-computers-accessing-federated-applications"></a>Шаг 2. Включение поддержки клиента Kerberos для утверждений, комплексной проверки подлинности и защиты Kerberos на компьютерах, доступ к федеративным приложениям

1.  Групповые политики, применимые к компьютерам, доступа к федеративным приложениям в **редактор управления групповыми политиками**в разделе **Конфигурация компьютера**, разверните **политики**, разверните **административные шаблоны**, разверните **системы**и выберите **Kerberos**.
2.  В области справа в окне редактора управления групповыми политиками дважды щелкните **поддержка клиента Kerberos для утверждений, комплексной проверки подлинности и защиты Kerberos.**
3.  В диалоговом окне Новый присвоено поддержка клиента Kerberos **включено** и нажмите кнопку **применить** и **ОК**.
4.  Закройте редактор управления групповыми политиками.

### <a name="step-3-configure-the-primary-authentication-provider"></a>Шаг 3. Настройка поставщика основной проверки подлинности

1. Значение основного поставщика проверки подлинности **проверки подлинности Windows** для настройки AD FS интрасети.
2. В управлении AD FS в разделе **политики проверки подлинности**выберите **основной проверки подлинности** и в разделе **глобальные параметры** щелкните **изменить**.
3. На **изменение глобальной политики проверки подлинности** под **интрасети** выберите **проверки подлинности Windows**.
4. Нажмите кнопку **применить** и **ОК**.
5. С помощью PowerShell, можно использовать **Set-AdfsGlobalAuthenticationPolicy** командлета.

``` powershell
Set-AdfsGlobalAuthenticationPolicy -PrimaryIntranetAuthenticationProvider 'WindowsAuthentication'
```
>[!NOTE]
>На WID на ферме, PowerShell, команда должна выполняться на основном сервере AD FS.
>В ферме, на основе SQL команда PowerShell может выполняться на любом сервере AD FS, которая является членом фермы.

### <a name="step-4--enable-the-compound-authentication-bit-on-the-msds-supportedencryptiontypes-attribute"></a>Шаг 4.  Включить бит комплексной проверки подлинности по атрибуту msDS-SupportedEncryptionTypes

1.  Включить бит атрибут msDS-SupportedEncryptionTypes для учетной записи, которую вы назначили для запуска службы AD FS с помощью комплексной проверки подлинности **Set-ADServiceAccount** командлета PowerShell.  

>[!NOTE]
>Если учетная запись службы изменена, то необходимо вручную включить комплексной проверки подлинности, выполнив **Set-ADUser - compoundIdentitySupported: $true** командлетов Windows PowerShell.

``` powershell
Set-ADServiceAccount -Identity “ADFS Service Account” -CompoundIdentitySupported:$true 
```
2.  Перезапустите службу ADFS.

>[!NOTE]
>После «CompoundIdentitySupported» имеет значение true, Установка групповой управляемой учетной записи, на новый серверы (2012 R2/2016) происходит сбой со следующей ошибкой — **Install-ADServiceAccount: Не удается установить учетную запись службы. Сообщение об ошибке: «Предоставленный контекст не соответствует целевой объект».** .
>
>**Решение**. Временно задать CompoundIdentitySupported значение $false. В результате этого действия служб федерации Active Directory, прекращение выпуска WindowsDeviceGroup утверждений. SET-ADServiceAccount — удостоверения «Учетная запись службы для служб федерации Active Directory» - CompoundIdentitySupported: $false, установить групповой управляемой учетной записи на новом сервере, а затем включите CompoundIdentitySupported обратно значение $True.
Отключение CompoundIdentitySupported и затем повторное включение не требуется перезапуск службы ADFS.

### <a name="step-5-update-the-ad-fs-claims-provider-trust-for-active-directory"></a>Шаг 5. Обновление AD FS отношение доверия поставщика утверждений для Active Directory

1. Обновите AD FS отношением доверия поставщика утверждений для Active Directory включить следующее правило для утверждений «Сквозная» для утверждения «WindowsDeviceGroup».
2.  В **управления AD FS**, нажмите кнопку **отношения доверия поставщиков утверждений** и в области справа щелчку **Active Directory** и выберите **изменение правил для утверждений**.
3.  На **изменение правил для утверждений для Active Director** щелкните **добавить правило**.
4.  На **утверждения мастере добавления правила преобразования** выберите **пропуск или Фильтрация входящего утверждения** и нажмите кнопку **Далее**.
5.  Добавить отображаемое имя и выберите **группу устройств Windows** из **тип входящего утверждения** раскрывающегося списка.
6.  Нажмите кнопку **Готово**.  Нажмите кнопку **применить** и **ОК**. 


### <a name="step-6-on-the-relying-party-where-the-windowsdevicegroup-claims-are-expected-add-a-similar-pass-through-or-transform-claim-rule"></a>Шаг 6. На проверяющей стороне, где ожидаются утверждения «WindowsDeviceGroup» добавьте аналогичные правила утверждения «Сквозная» или «Преобразование».
2.  В **управления AD FS**, нажмите кнопку **доверия проверяющей стороны** и в области справа щелчку к RP и выберите **изменение правил для утверждений**.
3.  На **правила преобразования выдачи** щелкните **добавить правило**.
4.  На **утверждения мастере добавления правила преобразования** выберите **пропуск или Фильтрация входящего утверждения** и нажмите кнопку **Далее**.
5.  Добавить отображаемое имя и выберите **группу устройств Windows** из **тип входящего утверждения** раскрывающегося списка.
6.  Нажмите кнопку **Готово**.  Нажмите кнопку **применить** и **ОК**.

## <a name="validation"></a>Проверка
Для проверки в выпуске «WindowsDeviceGroup» утверждений, Создание теста утверждений приложения .net 4.6. С пакетом SDK для WIF 4.0.
Настройка приложения в качестве проверяющей стороне в службах ADFS и обновите его с правилом для утверждений, как указано в шагах выше.
При проверке подлинности в приложение с помощью встроенной проверки подлинности Windows поставщик служб федерации Active Directory, являются привести следующие утверждения.
![Проверки](media/AD-FS-Compound-Authentication-and-AD-DS-claims/gpmc9.png)

Утверждения для компьютера или устройства теперь может использоваться для расширенные элементы управления доступом.

Например — следующая **AdditionalAuthenticationRules** сообщает AD FS для вызова многофакторной проверки Подлинности, если — проверка подлинности пользователя не является членом группы безопасности «-1-5-21-2134745077-1211275016-3050530490-1117» и на компьютере (где — пользователь является проверка подлинности из) не является членом группы безопасности «S-1-5-21-2134745077-1211275016-3050530490-1115 (WindowsDeviceGroup)»

Тем не менее если любое из указанных выше условий соблюдается, не вызывают многофакторной проверки Подлинности.

```
'NOT EXISTS([Type == "https://schemas.microsoft.com/ws/2008/06/identity/claims/windowsdevicegroup", Value =~ "S-1-5-21-2134745077-1211275016-3050530490-1115"])
&& NOT EXISTS([Type == "https://schemas.microsoft.com/ws/2008/06/identity/claims/groupsid", Value =~ "S-1-5-21-2134745077-1211275016-3050530490-1117"])
=> issue(Type = "https://schemas.microsoft.com/ws/2008/06/identity/claims/authenticationmethod", Value = "https://schemas.microsoft.com/claims/multipleauthn");'
```
