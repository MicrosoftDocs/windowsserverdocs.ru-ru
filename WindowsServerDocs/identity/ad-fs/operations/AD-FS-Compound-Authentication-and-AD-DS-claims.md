---
title: "Комплексная проверка подлинности и доменными службами Active Directory утверждений в службах федерации Active Directory"
description: "В следующем документе описывается комплексной проверки подлинности и утверждения AD DS в AD FS."
author: billmath
ms.author: billmath
manager: femila
ms.date: 09/07/2017
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: identity-adfs
ms.openlocfilehash: f5f80cbcbdb2deca9b098014627365b8ea819b5f
ms.sourcegitcommit: db290fa07e9d50686667bfba3969e20377548504
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/12/2017
---
# <a name="compound-authentication-and-ad-ds-claims-in-ad-fs"></a>Комплексной проверки подлинности и утверждения AD DS в AD FS
Windows Server 2012 расширяет проверки подлинности Kerberos, представив комплексной проверки подлинности.  Комплексная проверка подлинности позволяет службе Kerberos предоставления билетов (TGS) запрос включают два удостоверений: 

- удостоверение пользователя
- удостоверение пользователя устройства.  

Windows выполняет комплексной проверки подлинности, расширяя [Kerberos туннелирование для гибкой проверки подлинности безопасной (FAST) или защиту Kerberos](https://technet.microsoft.com/library/hh831747.aspx). 

AD FS 2012 и более поздних версиях позволяет потребление Доменные службы Active Directory, выданных утверждения пользователей или устройств, которые находятся в билет проверки подлинности Kerberos. В предыдущих версиях Служб федерации Active Directory утверждения, модуль может только читать пользователей и группы идентификаторы безопасности (SID) с Kerberos, но не удалось прочитать любой утверждений сведения, содержащиеся в билет Kerberos.

Можно включить более широкие возможности контроль доступа к федеративным приложениям с помощью доменных служб Active Directory (AD DS)-выданы утверждения пользователей и устройств вместе со службами федерации Active Directory (AD FS).

## <a name="requirements"></a>Требования к
1.  Компьютеров, имеющих доступ к федеративным приложениям должно пройти проверку подлинности с помощью Служб федерации Active Directory **встроенную проверку подлинности Windows**. 
    - Встроенная проверка подлинности Windows доступна только при подключении к внутренним серверам AD FS.
    - Компьютеры должны иметь доступ для имени службы федерации AD FS внутренних серверов
    - Серверов AD FS необходимо предложить встроенную проверку подлинности Windows в качестве основной проверки подлинности методом в его параметры интрасети.

2.  Политика **поддержка клиента Kerberos для утверждений, комплексной проверки подлинности и защиты Kerberos** должны действовать для всех компьютеров, имеющих доступ к федеративным приложениям, защищенным с помощью комплексной проверки подлинности. Это применимо, в случае одного леса или между сценариев леса.

3.  Домен, размещения серверов AD FS, должен обладать **поддержки центра распространения КЛЮЧЕЙ для утверждений комплексной проверки подлинности и защиты Kerberos** параметр политики, применить к контроллерам домена.

## <a name="steps-for-configuring-ad-fs-in-windows-server-2012-r2"></a>Действия по настройке Служб федерации Active Directory в Windows Server 2012 R2
Выполните следующие действия по настройке комплексной проверки подлинности и утверждения 

### <a name="step-1--enable-kdc-support-for-claims-compound-authentication-and-kerberos-armoring-on-the-default-domain-controller-policy"></a>Шаг 1: Включите поддержку KDC для утверждений, комплексной проверки подлинности и защиты Kerberos на политики контроллера домена по умолчанию
1.  В диспетчере серверов выберите средства, **Управление групповой политикой**.
2.  Перейдите вниз к **политика контроллеров домена по умолчанию**, щелкните правой кнопкой мыши и выберите **изменить**.
![Управление групповой политикой](media/AD-FS-Compound-Authentication-and-AD-DS-claims/gpmc1.png)
3.  На **редактор управления групповыми политиками**в разделе **Конфигурация компьютера**, разверните **политики**, разверните **административные шаблоны**, разверните **системы**и выберите **KDC**.
4.  В области справа дважды щелкните **поддержки центра распространения КЛЮЧЕЙ для утверждений, комплексной проверки подлинности и защиты Kerberos**.
![Управление групповой политикой](media/AD-FS-Compound-Authentication-and-AD-DS-claims/gpmc2.png)
5.  В открывшемся диалоговом окне установите поддержка KDC для утверждений для **включено**.
6.  В параметрах щелкните **поддерживаемые** из раскрывающегося меню и нажмите кнопку **применить** и **ОК**.
![Управление групповой политикой](media/AD-FS-Compound-Authentication-and-AD-DS-claims/gpmc3.png)

### <a name="step-2-enable-kerberos-client-support-for-claims-compound-authentication-and-kerberos-armoring-on-computers-accessing-federated-applications"></a>Шаг 2: Включение поддержки клиента Kerberos для утверждений, комплексной проверки подлинности и защиты Kerberos на компьютерах, доступ к федеративным приложениям

1.  Групповые политики применяются к компьютерам, доступ к федеративным приложениям в **редактор управления групповыми политиками**в разделе **Конфигурация компьютера**, разверните **политики**, разверните **администрирования Шаблоны**, разверните **системы**и выберите **Kerberos**.
2.  В правой части окна редактора управления групповыми политиками дважды щелкните **поддержка клиента Kerberos для утверждений, комплексной проверки подлинности и защиты Kerberos.**
3.  В открывшемся диалоговом окне задайте поддержка клиента Kerberos для **включено** и нажмите кнопку **применить** и **ОК**.
![Управление групповой политикой](media/AD-FS-Compound-Authentication-and-AD-DS-claims/gpmc4.png)
4.  Закройте редактор управления групповыми политиками.

### <a name="step-3-ensure-the-ad-fs-servers-have-been-updated"></a>Шаг 3: Убедитесь, что были обновлены серверов AD FS.
Необходимо убедиться, что следующие обновления установлены на серверах Служб федерации Active Directory.

|Обновление|Описание|
|----- | ----- |
|[KB2919355](https://www.microsoft.com/download/details.aspx?id=42335)|Накопительный пакет обновления безопасности (включая KB2919355, KB2932046, KB2934018, KB2937592, KB2938439)|
|[KB2959977](https://www.microsoft.com/download/details.aspx?id=42530)|Обновление для Server 2012 R2|
|[Исправление 3052122](https://support.microsoft.com/help/3052122/update-adds-support-for-compound-id-claims-in-ad-fs-tokens-in-windows)|Это обновление добавляет поддержку для комплексной утверждениям идентификатора в службах федерации Active Directory.|

### <a name="step-4-configure-the-primary-authentication-provider"></a>Шаг 4: Настройка поставщика основной проверки подлинности

1. Настроить основной поставщика проверки подлинности **проверки подлинности Windows** для настройки интрасети AD FS.
2. В оснастку управления AD FS в разделе **политики проверки подлинности**выберите **основной проверки подлинности** и в разделе **глобальные параметры** щелкните **изменить**.
3. На **изменение глобальной политики проверки подлинности** под **интрасети** выберите **проверки подлинности Windows**.
4. Нажмите кнопку **применить** и **ОК**.

![Управление групповой политикой](media/AD-FS-Compound-Authentication-and-AD-DS-claims/gpmc5.png)

5. С помощью PowerShell, можно использовать **Set-AdfsGlobalAuthenticationPolicy** командлета.

``` powershell
Set-AdfsGlobalAuthenticationPolicy -PrimaryIntranetAuthenticationProvider 'WindowsAuthentication'
```
>[!NOTE]
>В внутренней базы данных Windows на основе фермы, PowerShell, команда должна выполняться на сервере-источнике AD FS.
>На ферме SQL на основе команды PowerShell может выполняться на любом сервере Служб федерации Active Directory, который входит в состав фермы.

### <a name="step-5--add-the-claim-description-to-ad-fs"></a>Шаг 5: Добавление описания утверждения для AD FS
1.  Добавьте следующие описания утверждения в ферму. Это описание утверждений не присутствуют по умолчанию в службы федерации Active Directory 2012 R2 и необходимо вручную добавить.
2.  В оснастку управления AD FS в разделе **службы**, щелкните правой кнопкой мыши **утверждений описание** и выберите **добавить утверждений описание**
3.  Введите следующие сведения в описании утверждений
    - Отображаемое имя: «Windows группы устройств» 
    - Описание утверждений: «https://schemas.microsoft.com/ws/2008/06/identity/claims/windowsdevicegroup» "
4. Установите флажок в обоих полях.
5. Нажмите кнопку **ОК**.

![Описания утверждения](media/AD-FS-Compound-Authentication-and-AD-DS-claims/gpmc6.png)

6. С помощью PowerShell, можно использовать **добавить AdfsClaimDescription** командлета.
``` powershell
Add-AdfsClaimDescription -Name 'Windows device group' -ClaimType 'https://schemas.microsoft.com/ws/2008/06/identity/claims/windowsdevicegroup' `
-ShortName 'windowsdevicegroup' -IsAccepted $true -IsOffered $true -IsRequired $false -Notes 'The windows group SID of the device' 
```


>[!NOTE]
>В внутренней базы данных Windows на основе фермы, PowerShell, команда должна выполняться на сервере-источнике AD FS.
>На ферме SQL на основе команды PowerShell может выполняться на любом сервере Служб федерации Active Directory, который входит в состав фермы.

### <a name="step-6--enable-the-compound-authentication-bit-on-the-msds-supportedencryptiontypes-attribute"></a>Шаг 6: Включение бит комплексной проверки подлинности на атрибут msDS-SupportedEncryptionTypes

1.  Включить бит атрибут msDS-SupportedEncryptionTypes в учетной записи, предназначенные для запуска службы AD FS с помощью комплексной проверки подлинности **Set-ADServiceAccount** командлета PowerShell.  

>[!NOTE]
>Если изменить учетную запись службы, то необходимо вручную включить комплексной проверки подлинности, выполнив **Set-ADUser - compoundIdentitySupported: $true** командлетов Windows PowerShell.

``` powershell
Set-ADServiceAccount -Identity “ADFS Service Account” -CompoundIdentitySupported:$true 
```
2.  Перезапустите службу служб федерации Active Directory.

>[!NOTE]
>После «CompoundIdentitySupported» имеет значение true, установки групповой управляемой учетной записи, на новый (2012R2/2016 г.) серверов происходит сбой со следующей ошибкой: **Install-ADServiceAccount: не удается установить учетной записи службы. Сообщение об ошибке: «предоставленный контекст не соответствует целевой.»**.
>
>**Решение**: временно задать CompoundIdentitySupported значение $false. В результате этого действия служб федерации Active Directory для остановки выпуска WindowsDeviceGroup утверждений. Set-ADServiceAccount-удостоверение «Учетная запись службы для служб федерации Active Directory» - CompoundIdentitySupported: $false установить эта учетная запись на новом сервере, а затем включите CompoundIdentitySupported обратно в значение $True.
Отключение CompoundIdentitySupported и затем повторное включение не требуется перезапустить службу служб федерации Active Directory.

### <a name="step-7-update-the-ad-fs-claims-provider-trust-for-active-directory"></a>Шаг 7: Обновление доверия поставщиков утверждений AD FS для Active Directory

1. Обновление AD FS доверия с поставщиком утверждений для Active Directory, чтобы включить следующее правило утверждений «Сквозной» для утверждений «WindowsDeviceGroup».
2.  В **управления AD FS**, нажмите кнопку **отношения доверия поставщиков утверждений** и в области справа щелкните права **Active Directory** и выберите **изменение правил для утверждений**.
3.  На **изменение правил для утверждений для Active Director** щелкните **добавить правило**.
4.  На **утверждения мастере добавления правил преобразования** выберите **пропуск или Фильтрация входящего утверждения** и нажмите кнопку **Далее**.
5.  Добавьте имя пользователя и выберите **группы устройств Windows** из **тип входящего утверждения** раскрывающегося списка.
6.  Нажмите кнопку **Готово **.  Нажмите кнопку **применить** и **ОК**. 
![Описания утверждения](media/AD-FS-Compound-Authentication-and-AD-DS-claims/gpmc7.png)

### <a name="step-8-on-the-relying-party-where-the-windowsdevicegroup-claims-are-expected-add-a-similar-pass-through-or-transform-claim-rule"></a>Шаг 8: Для проверяющей стороны, ожидающем утверждения «WindowsDeviceGroup», добавьте правило для утверждений аналогичные «Сквозной» или «Преобразование».
2.  В **управления AD FS**, нажмите кнопку **доверия с проверяющей стороной** и в области справа щелкните права RP и выберите **изменение правил для утверждений**.
3.  На **правила преобразования выдачи** щелкните **добавить правило**.
4.  На **утверждения мастере добавления правил преобразования** выберите **пропуск или Фильтрация входящего утверждения** и нажмите кнопку **Далее**.
5.  Добавьте имя пользователя и выберите **группы устройств Windows** из **тип входящего утверждения** раскрывающегося списка.
6.  Нажмите кнопку **Готово **.  Нажмите кнопку **применить** и **ОК**.
![Описания утверждения](media/AD-FS-Compound-Authentication-and-AD-DS-claims/gpmc8.png)


##<a name="steps-for-configuring-ad-fs-in-windows-server-2016"></a>Шаги по настройке Служб федерации Active Directory в Windows Server 2016
Ниже подробно описаны шаги по настройке комплексной проверки подлинности в службах AD FS в Windows Server 2016.

### <a name="step-1--enable-kdc-support-for-claims-compound-authentication-and-kerberos-armoring-on-the-default-domain-controller-policy"></a>Шаг 1: Включите поддержку KDC для утверждений, комплексной проверки подлинности и защиты Kerberos на политики контроллера домена по умолчанию
1.  В диспетчере серверов выберите средства, **Управление групповой политикой**.
2.  Перейдите вниз к **политика контроллеров домена по умолчанию**, щелкните правой кнопкой мыши и выберите **изменить**.
3.  На **редактор управления групповыми политиками**в разделе **Конфигурация компьютера**, разверните **политики**, разверните **административные шаблоны**, разверните **системы**и выберите **KDC**.
4.  В области справа дважды щелкните **поддержки центра распространения КЛЮЧЕЙ для утверждений, комплексной проверки подлинности и защиты Kerberos**.
5.  В открывшемся диалоговом окне установите поддержка KDC для утверждений для **включено**.
6.  В параметрах щелкните **поддерживаемые** из раскрывающегося меню и нажмите кнопку **применить** и **ОК**.


### <a name="step-2-enable-kerberos-client-support-for-claims-compound-authentication-and-kerberos-armoring-on-computers-accessing-federated-applications"></a>Шаг 2: Включение поддержки клиента Kerberos для утверждений, комплексной проверки подлинности и защиты Kerberos на компьютерах, доступ к федеративным приложениям

1.  Групповые политики применяются к компьютерам, доступ к федеративным приложениям в **редактор управления групповыми политиками**в разделе **Конфигурация компьютера**, разверните **политики**, разверните **администрирования Шаблоны**, разверните **системы**и выберите **Kerberos**.
2.  В правой части окна редактора управления групповыми политиками дважды щелкните **поддержка клиента Kerberos для утверждений, комплексной проверки подлинности и защиты Kerberos.**
3.  В открывшемся диалоговом окне задайте поддержка клиента Kerberos для **включено** и нажмите кнопку **применить** и **ОК**.
4.  Закройте редактор управления групповыми политиками.

### <a name="step-3-configure-the-primary-authentication-provider"></a>Шаг 3: Настройка поставщика основной проверки подлинности

1. Настроить основной поставщика проверки подлинности **проверки подлинности Windows** для настройки интрасети AD FS.
2. В оснастку управления AD FS в разделе **политики проверки подлинности**выберите **основной проверки подлинности** и в разделе **глобальные параметры** щелкните **изменить**.
3. На **изменение глобальной политики проверки подлинности** под **интрасети** выберите **проверки подлинности Windows**.
4. Нажмите кнопку **применить** и **ОК**.
5. С помощью PowerShell, можно использовать **Set-AdfsGlobalAuthenticationPolicy** командлета.

``` powershell
Set-AdfsGlobalAuthenticationPolicy -PrimaryIntranetAuthenticationProvider 'WindowsAuthentication'
```
>[!NOTE]
>В внутренней базы данных Windows на основе фермы, PowerShell, команда должна выполняться на сервере-источнике AD FS.
>На ферме SQL на основе команды PowerShell может выполняться на любом сервере Служб федерации Active Directory, который входит в состав фермы.

### <a name="step-4--enable-the-compound-authentication-bit-on-the-msds-supportedencryptiontypes-attribute"></a>Шаг 4: Включение бит комплексной проверки подлинности на атрибут msDS-SupportedEncryptionTypes

1.  Включить бит атрибут msDS-SupportedEncryptionTypes в учетной записи, предназначенные для запуска службы AD FS с помощью комплексной проверки подлинности **Set-ADServiceAccount** командлета PowerShell.  

>[!NOTE]
>Если изменить учетную запись службы, то необходимо вручную включить комплексной проверки подлинности, выполнив **Set-ADUser - compoundIdentitySupported: $true** командлетов Windows PowerShell.

``` powershell
Set-ADServiceAccount -Identity “ADFS Service Account” -CompoundIdentitySupported:$true 
```
2.  Перезапустите службу служб федерации Active Directory.

>[!NOTE]
>После «CompoundIdentitySupported» имеет значение true, установки групповой управляемой учетной записи, на новый (2012R2/2016 г.) серверов происходит сбой со следующей ошибкой: **Install-ADServiceAccount: не удается установить учетной записи службы. Сообщение об ошибке: «предоставленный контекст не соответствует целевой.»**.
>
>**Решение**: временно задать CompoundIdentitySupported значение $false. В результате этого действия служб федерации Active Directory для остановки выпуска WindowsDeviceGroup утверждений. Set-ADServiceAccount-удостоверение «Учетная запись службы для служб федерации Active Directory» - CompoundIdentitySupported: $false установить эта учетная запись на новом сервере, а затем включите CompoundIdentitySupported обратно в значение $True.
Отключение CompoundIdentitySupported и затем повторное включение не требуется перезапустить службу служб федерации Active Directory.

### <a name="step-5-update-the-ad-fs-claims-provider-trust-for-active-directory"></a>Шаг 5: Обновление доверия поставщиков утверждений AD FS для Active Directory

1. Обновление AD FS доверия с поставщиком утверждений для Active Directory, чтобы включить следующее правило утверждений «Сквозной» для утверждений «WindowsDeviceGroup».
2.  В **управления AD FS**, нажмите кнопку **отношения доверия поставщиков утверждений** и в области справа щелкните права **Active Directory** и выберите **изменение правил для утверждений**.
3.  На **изменение правил для утверждений для Active Director** щелкните **добавить правило**.
4.  На **утверждения мастере добавления правил преобразования** выберите **пропуск или Фильтрация входящего утверждения** и нажмите кнопку **Далее**.
5.  Добавьте имя пользователя и выберите **группы устройств Windows** из **тип входящего утверждения** раскрывающегося списка.
6.  Нажмите кнопку **Готово **.  Нажмите кнопку **применить** и **ОК**. 


### <a name="step-6-on-the-relying-party-where-the-windowsdevicegroup-claims-are-expected-add-a-similar-pass-through-or-transform-claim-rule"></a>: Шаг 6 для проверяющей стороны, ожидающем утверждения «WindowsDeviceGroup», аналогичные правила утверждения «Сквозной» или «Преобразование».
2.  В **управления AD FS**, нажмите кнопку **доверия с проверяющей стороной** и в области справа щелкните права RP и выберите **изменение правил для утверждений**.
3.  На **правила преобразования выдачи** щелкните **добавить правило**.
4.  На **утверждения мастере добавления правил преобразования** выберите **пропуск или Фильтрация входящего утверждения** и нажмите кнопку **Далее**.
5.  Добавьте имя пользователя и выберите **группы устройств Windows** из **тип входящего утверждения** раскрывающегося списка.
6.  Нажмите кнопку **Готово **.  Нажмите кнопку **применить** и **ОК**.

## <a name="validation"></a>Проверка
Для проверки выпуска утверждений «WindowsDeviceGroup» Создание теста утверждений приложения .net 4.6. С помощью пакета SDK WIF 4.0.
Настройка приложения в качестве проверяющая сторона в службе ADFS и обновите его с помощью правил утверждений, как указано в указанных выше действий.
При прохождении проверки подлинности в приложение с помощью встроенной проверки подлинности Windows поставщика служб федерации Active Directory, следующие утверждения — привести.
![Проверка](media/AD-FS-Compound-Authentication-and-AD-DS-claims/gpmc9.png)

Утверждения для компьютера или устройства, теперь может быть использована для более широкие возможности управления доступом.

Например, следующие **AdditionalAuthenticationRules** сообщает AD FS для вызова многофакторной проверки Подлинности, если — проверка подлинности пользователя не является членом группы безопасности «-1-5-21-2134745077-1211275016-3050530490-1117» и на компьютере (где он используется Проверка подлинности которых выполняется из) не является членом группы безопасности «S-1-5-21-2134745077-1211275016-3050530490-1115 (WindowsDeviceGroup)»

Тем не менее если удовлетворены любые из перечисленных выше условий не вызывать многофакторной проверки Подлинности.

```
'NOT EXISTS([Type == "https://schemas.microsoft.com/ws/2008/06/identity/claims/windowsdevicegroup", Value =~ "S-1-5-21-2134745077-1211275016-3050530490-1115"])
&& NOT EXISTS([Type == "https://schemas.microsoft.com/ws/2008/06/identity/claims/groupsid", Value =~ "S-1-5-21-2134745077-1211275016-3050530490-1117"])
=> issue(Type = "https://schemas.microsoft.com/ws/2008/06/identity/claims/authenticationmethod", Value = "https://schemas.microsoft.com/claims/multipleauthn");'
```