---
title: Составные утверждения и домен Active Directoryные службы для проверки подлинности в службы федерации Active Directory (AD FS)
description: В следующем документе рассматривается составная проверка подлинности и AD DS утверждения в AD FS.
author: billmath
ms.author: billmath
manager: femila
ms.date: 09/07/2017
ms.topic: article
ms.prod: windows-server
ms.technology: identity-adfs
ms.openlocfilehash: 78db6f8b6961cecea55b8d371e9abf952cafdab3
ms.sourcegitcommit: 6aff3d88ff22ea141a6ea6572a5ad8dd6321f199
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/27/2019
ms.locfileid: "71358675"
---
# <a name="compound-authentication-and-ad-ds-claims-in-ad-fs"></a>Комплексная аутентификация и утверждения AD DS в AD FS
Windows Server 2012 улучшает проверку подлинности Kerberos, представляя составную проверку подлинности.  Составная проверка подлинности позволяет запросу службы предоставления билетов Kerberos (TGS) включать два удостоверения: 

- удостоверение пользователя
- удостоверение устройства пользователя.  

Windows выполняет составную проверку подлинности, расширяя [защищенное туннелирование Kerberos с помощью Secure Tunneling (Fast) или защиту Kerberos](https://technet.microsoft.com/library/hh831747.aspx). 

AD FS 2012 и более поздние версии позволяют выдавать заявки на выдачу AD DS пользователей или устройств, которые находятся в билете проверки подлинности Kerberos. В предыдущих версиях AD FS механизму утверждений удалось только считывать идентификаторы безопасности пользователей и групп из Kerberos, но не удалось прочитать сведения о заявках, содержащиеся в билете Kerberos.

Вы можете включить более широкие возможности управления доступом для федеративных приложений с помощью домен Active Directory служб (AD DS), которые выдавали утверждения пользователей и устройств вместе, с службы федерации Active Directory (AD FS) (AD FS).

## <a name="requirements"></a>Требования
1.  Компьютеры, обращающиеся к федеративным приложениям, должны пройти проверку подлинности AD FS с помощью **встроенной проверки подлинности Windows**. 
    - Встроенная проверка подлинности Windows доступна только при подключении к серверным AD FSным серверам.
    - Компьютеры должны иметь доступ к серверным AD FSным серверам для служба федерации имени
    - AD FS серверы должны предлагать встроенную проверку подлинности Windows в качестве основного метода проверки подлинности в параметрах интрасети.

2.  Для всех компьютеров, обращающихся к федеративным приложениям, защищенным с помощью составной проверки подлинности, необходимо применять политику **поддержки клиентов Kerberos для составных проверок подлинности утверждений и защиты Kerberos** . Это применимо в сценариях с одним лесом или между лесами.

3.  На корпусе домена AD FS серверы должны иметь **поддержку KDC для составной проверки подлинности утверждений и параметра политики защиты Kerberos** , применяемого к контроллерам домена.

## <a name="steps-for-configuring-ad-fs-in-windows-server-2012-r2"></a>Действия по настройке AD FS в Windows Server 2012 R2
Чтобы настроить составную проверку подлинности и утверждения, выполните следующие действия. 

### <a name="step-1--enable-kdc-support-for-claims-compound-authentication-and-kerberos-armoring-on-the-default-domain-controller-policy"></a>Шаг 1.  Включение поддержки KDC для утверждений, составной проверки подлинности и защиты Kerberos в политике контроллера домена по умолчанию
1.  В диспетчер сервера выберите инструменты, **Групповая политика управление**.
2.  Перейдите к **политике контроллера домена по умолчанию**, щелкните ее правой кнопкой мыши и выберите **изменить**.
![Управление групповая политика](media/AD-FS-Compound-Authentication-and-AD-DS-claims/gpmc1.png)
3.  На **редактор "Управление групповыми политиками"** в разделе **Конфигурация компьютера**разверните **политики**, разверните **Административные шаблоны**, узел **система**и выберите **KDC**.
4.  В области справа дважды щелкните **Поддержка KDC для утверждений, комплексной проверки подлинности и защиты Kerberos**.
![Управление групповая политика](media/AD-FS-Compound-Authentication-and-AD-DS-claims/gpmc2.png)
5.  В диалоговом окне Создание нового диалогового окна установите поддержку KDC для **включения**утверждений.
6.  В разделе Параметры выберите пункт **поддерживается** в раскрывающемся меню и нажмите кнопку **Применить** и **ОК**.
![Управление групповая политика](media/AD-FS-Compound-Authentication-and-AD-DS-claims/gpmc3.png)

### <a name="step-2-enable-kerberos-client-support-for-claims-compound-authentication-and-kerberos-armoring-on-computers-accessing-federated-applications"></a>Шаг 2. Включение поддержки клиентов Kerberos для утверждений, комплексной проверки подлинности и защиты Kerberos на компьютерах, обращающихся к федеративным приложениям

1.  На групповая политика, применяемых к компьютерам, обращающимся к федеративным приложениям, в **редактор "Управление групповыми политиками"** в разделе **Конфигурация компьютера**разверните узел **политики**, разверните узел **Административные шаблоны**, разверните узел **система.** и выберите **Kerberos**.
2.  В правой области окна редактор "Управление групповыми политиками" дважды щелкните пункт **Поддержка клиентов Kerberos для утверждений, составной проверки подлинности и защиты Kerberos.**
3.  В диалоговом окне Создать установите для параметра Поддержка клиентов Kerberos значение **включено** и нажмите кнопку **Применить** и **ОК**.
![Управление групповая политика](media/AD-FS-Compound-Authentication-and-AD-DS-claims/gpmc4.png)
4.  Закройте редактор управления групповыми политиками.

### <a name="step-3-ensure-the-ad-fs-servers-have-been-updated"></a>Шаг 3. Убедитесь, что AD FS серверы обновлены.
Необходимо убедиться, что на серверах AD FS установлены следующие обновления.

|Обновление|Описание|
|----- | ----- |
|[KB2919355](https://www.microsoft.com/download/details.aspx?id=42335)|Накопительное обновление для системы безопасности (включая KB2919355, KB2932046, KB2934018, KB2937592, KB2938439)|
|[KB2959977](https://www.microsoft.com/download/details.aspx?id=42530)|Обновление для сервера 2012 R2|
|[Исправление 3052122](https://support.microsoft.com/help/3052122/update-adds-support-for-compound-id-claims-in-ad-fs-tokens-in-windows)|Это обновление добавляет поддержку для утверждений составного идентификатора в службы федерации Active Directory (AD FS).|

### <a name="step-4-configure-the-primary-authentication-provider"></a>Шаг 4. Настройка основного поставщика проверки подлинности

1. Установите для основного поставщика проверки подлинности **проверку подлинности Windows** для параметров AD FS интрасети.
2. В области Управление AD FSми в разделе **политики проверки подлинности**выберите **Основная проверка подлинности** и в разделе **глобальные параметры** нажмите кнопку **изменить**.
3. На странице **изменение глобальной политики проверки подлинности** в разделе **интрасеть** выберите **Проверка подлинности Windows**.
4. Нажмите кнопку **Применить** и **ОК**.

![Управление групповой политикой](media/AD-FS-Compound-Authentication-and-AD-DS-claims/gpmc5.png)

5. С помощью PowerShell можно использовать командлет **Set-адфсглобалаусентикатионполици** .

``` powershell
Set-AdfsGlobalAuthenticationPolicy -PrimaryIntranetAuthenticationProvider 'WindowsAuthentication'
```
>[!NOTE]
>В ферме на основе WID необходимо выполнить команду PowerShell на сервере-источнике AD FS.
>В ферме на основе SQL команда PowerShell может выполняться на любом сервере AD FS, входящем в ферму.

### <a name="step-5--add-the-claim-description-to-ad-fs"></a>Шаг 5.  Добавьте описание утверждения в AD FS
1. Добавьте следующее описание утверждения в ферму. Это описание утверждения отсутствует по умолчанию в ADFS 2012 R2 и должно быть добавлено вручную.
2. В разделе " **Служба**" AD FS "Управление" щелкните правой кнопкой мыши **Описание утверждения** и выберите **Добавить описание утверждения** .
3. Введите следующие сведения в описание утверждения.
   - Отображаемое имя: "Группа устройств Windows" 
   - Описание утверждения: '<https://schemas.microsoft.com/ws/2008/06/identity/claims/windowsdevicegroup>' '
4. Установите флажки в обоих полях.
5. Нажмите кнопку **ОК**.

![Описание утверждения](media/AD-FS-Compound-Authentication-and-AD-DS-claims/gpmc6.png)

6. С помощью PowerShell можно использовать командлет **Add-адфсклаимдескриптион** .
   ``` powershell
   Add-AdfsClaimDescription -Name 'Windows device group' -ClaimType 'https://schemas.microsoft.com/ws/2008/06/identity/claims/windowsdevicegroup' `
   -ShortName 'windowsdevicegroup' -IsAccepted $true -IsOffered $true -IsRequired $false -Notes 'The windows group SID of the device' 
   ```


>[!NOTE]
>В ферме на основе WID необходимо выполнить команду PowerShell на сервере-источнике AD FS.
>В ферме на основе SQL команда PowerShell может выполняться на любом сервере AD FS, входящем в ферму.

### <a name="step-6--enable-the-compound-authentication-bit-on-the-msds-supportedencryptiontypes-attribute"></a>Шаг 6.  Включите бит составной проверки подлинности в атрибуте msDS-Суппортеденкриптионтипес

1.  Включите бит комплексной проверки подлинности в атрибуте msDS-Суппортеденкриптионтипес учетной записи, назначенной для запуска службы AD FS с помощью командлета PowerShell **Set-адсервицеаккаунт** .  

>[!NOTE]
>При изменении учетной записи службы необходимо вручную включить составную проверку подлинности, выполнив командлеты **Set-ADUser-компаундидентитисуппортед: $true** Windows PowerShell.

``` powershell
Set-ADServiceAccount -Identity “ADFS Service Account” -CompoundIdentitySupported:$true 
```
2. Перезапустите службу ADFS.

>[!NOTE]
>После того как для параметра "компаундидентитисуппортед" задано значение true, установка этого же gMSA на новых серверах (2012 R2/2016) завершается со **следующей ошибкой — Install-адсервицеаккаунт: Не удается установить учетную запись службы. Сообщение об ошибке: ' Указанный контекст не соответствует целевому. '** .
>
>**Решение**. Временно задайте для Компаундидентитисуппортед значение $false. Этот шаг приводит к тому, что ADFS прекращает выдачу утверждений Виндовсдевицеграуп. Set-Адсервицеаккаунт-Identity ' учетная запись службы ADFS '-Компаундидентитисуппортед: $false установить gMSA на новом сервере, а затем включить Компаундидентитисуппортед обратно в $True.
Отключение Компаундидентитисуппортед и повторное включение не требует перезапуска службы ADFS.

### <a name="step-7-update-the-ad-fs-claims-provider-trust-for-active-directory"></a>Шаг 7. Обновление отношения доверия поставщика утверждений AD FS для Active Directory

1. Обновите отношение доверия поставщика утверждений AD FS для Active Directory, чтобы включить в утверждение "Виндовсдевицеграуп" следующее правило утверждений "сквозная передача".
2.  В **AD FS управление**щелкните **отношения доверия поставщиков утверждений** и в правой области щелкните Azure **Active Directory** и выберите **изменить правила утверждений**.
3.  На странице **изменение правил утверждений для Active Directory** нажмите кнопку **Добавить правило**.
4.  В **мастере добавления правила преобразования утверждений** выберите **передать или отфильтровать входящее утверждение** и нажмите кнопку **Далее**.
5.  Добавьте отображаемое имя и выберите **группу устройств Windows** из раскрывающегося списка **тип входящего утверждения** .
6.  Нажмите кнопку **Готово**.  Нажмите кнопку **Применить** и **ОК**. 
![Описание утверждения](media/AD-FS-Compound-Authentication-and-AD-DS-claims/gpmc7.png)

### <a name="step-8-on-the-relying-party-where-the-windowsdevicegroup-claims-are-expected-add-a-similar-pass-through-or-transform-claim-rule"></a>Шаг 8. В проверяющей стороне, где ожидаются утверждения "Виндовсдевицеграуп", добавьте аналогичное правило утверждений "Pass-to" или "Transform".
2. В **AD FS управления**щелкните **отношения доверия с проверяющей стороной** и в правой области Azure щелкните RP и выберите **изменить правила утверждений**.
3. На странице **правила преобразования выдачи** нажмите кнопку **Добавить правило**.
4. В **мастере добавления правила преобразования утверждений** выберите **передать или отфильтровать входящее утверждение** и нажмите кнопку **Далее**.
5. Добавьте отображаемое имя и выберите **группу устройств Windows** из раскрывающегося списка **тип входящего утверждения** .
6. Нажмите кнопку **Готово**.  Нажмите кнопку **Применить** и **ОК**.
   ![Описание утверждения](media/AD-FS-Compound-Authentication-and-AD-DS-claims/gpmc8.png)


## <a name="steps-for-configuring-ad-fs-in-windows-server-2016"></a>Действия по настройке AD FS в Windows Server 2016
Ниже подробно описаны действия по настройке составной проверки подлинности на AD FS для Windows Server 2016.

### <a name="step-1--enable-kdc-support-for-claims-compound-authentication-and-kerberos-armoring-on-the-default-domain-controller-policy"></a>Шаг 1.  Включение поддержки KDC для утверждений, составной проверки подлинности и защиты Kerberos в политике контроллера домена по умолчанию
1.  В диспетчер сервера выберите инструменты, **Групповая политика управление**.
2.  Перейдите к **политике контроллера домена по умолчанию**, щелкните ее правой кнопкой мыши и выберите **изменить**.
3.  На **редактор "Управление групповыми политиками"** в разделе **Конфигурация компьютера**разверните **политики**, разверните **Административные шаблоны**, узел **система**и выберите **KDC**.
4.  В области справа дважды щелкните **Поддержка KDC для утверждений, комплексной проверки подлинности и защиты Kerberos**.
5.  В диалоговом окне Создание нового диалогового окна установите поддержку KDC для **включения**утверждений.
6.  В разделе Параметры выберите пункт **поддерживается** в раскрывающемся меню и нажмите кнопку **Применить** и **ОК**.


### <a name="step-2-enable-kerberos-client-support-for-claims-compound-authentication-and-kerberos-armoring-on-computers-accessing-federated-applications"></a>Шаг 2. Включение поддержки клиентов Kerberos для утверждений, комплексной проверки подлинности и защиты Kerberos на компьютерах, обращающихся к федеративным приложениям

1.  На групповая политика, применяемых к компьютерам, обращающимся к федеративным приложениям, в **редактор "Управление групповыми политиками"** в разделе **Конфигурация компьютера**разверните узел **политики**, разверните узел **Административные шаблоны**, разверните узел **система.** и выберите **Kerberos**.
2.  В правой области окна редактор "Управление групповыми политиками" дважды щелкните пункт **Поддержка клиентов Kerberos для утверждений, составной проверки подлинности и защиты Kerberos.**
3.  В диалоговом окне Создать установите для параметра Поддержка клиентов Kerberos значение **включено** и нажмите кнопку **Применить** и **ОК**.
4.  Закройте редактор управления групповыми политиками.

### <a name="step-3-configure-the-primary-authentication-provider"></a>Шаг 3. Настройка основного поставщика проверки подлинности

1. Установите для основного поставщика проверки подлинности **проверку подлинности Windows** для параметров AD FS интрасети.
2. В области Управление AD FSми в разделе **политики проверки подлинности**выберите **Основная проверка подлинности** и в разделе **глобальные параметры** нажмите кнопку **изменить**.
3. На странице **изменение глобальной политики проверки подлинности** в разделе **интрасеть** выберите **Проверка подлинности Windows**.
4. Нажмите кнопку **Применить** и **ОК**.
5. С помощью PowerShell можно использовать командлет **Set-адфсглобалаусентикатионполици** .

``` powershell
Set-AdfsGlobalAuthenticationPolicy -PrimaryIntranetAuthenticationProvider 'WindowsAuthentication'
```
>[!NOTE]
>В ферме на основе WID необходимо выполнить команду PowerShell на сервере-источнике AD FS.
>В ферме на основе SQL команда PowerShell может выполняться на любом сервере AD FS, входящем в ферму.

### <a name="step-4--enable-the-compound-authentication-bit-on-the-msds-supportedencryptiontypes-attribute"></a>Шаг 4.  Включите бит составной проверки подлинности в атрибуте msDS-Суппортеденкриптионтипес

1.  Включите бит комплексной проверки подлинности в атрибуте msDS-Суппортеденкриптионтипес учетной записи, назначенной для запуска службы AD FS с помощью командлета PowerShell **Set-адсервицеаккаунт** .  

>[!NOTE]
>При изменении учетной записи службы необходимо вручную включить составную проверку подлинности, выполнив командлеты **Set-ADUser-компаундидентитисуппортед: $true** Windows PowerShell.

``` powershell
Set-ADServiceAccount -Identity “ADFS Service Account” -CompoundIdentitySupported:$true 
```
2. Перезапустите службу ADFS.

>[!NOTE]
>После того как для параметра "компаундидентитисуппортед" задано значение true, установка этого же gMSA на новых серверах (2012 R2/2016) завершается со **следующей ошибкой — Install-адсервицеаккаунт: Не удается установить учетную запись службы. Сообщение об ошибке: ' Указанный контекст не соответствует целевому. '** .
>
>**Решение**. Временно задайте для Компаундидентитисуппортед значение $false. Этот шаг приводит к тому, что ADFS прекращает выдачу утверждений Виндовсдевицеграуп. Set-Адсервицеаккаунт-Identity ' учетная запись службы ADFS '-Компаундидентитисуппортед: $false установить gMSA на новом сервере, а затем включить Компаундидентитисуппортед обратно в $True.
Отключение Компаундидентитисуппортед и повторное включение не требует перезапуска службы ADFS.

### <a name="step-5-update-the-ad-fs-claims-provider-trust-for-active-directory"></a>Шаг 5. Обновление отношения доверия поставщика утверждений AD FS для Active Directory

1. Обновите отношение доверия поставщика утверждений AD FS для Active Directory, чтобы включить в утверждение "Виндовсдевицеграуп" следующее правило утверждений "сквозная передача".
2.  В **AD FS управление**щелкните **отношения доверия поставщиков утверждений** и в правой области щелкните Azure **Active Directory** и выберите **изменить правила утверждений**.
3.  На странице **изменение правил утверждений для Active Directory** нажмите кнопку **Добавить правило**.
4.  В **мастере добавления правила преобразования утверждений** выберите **передать или отфильтровать входящее утверждение** и нажмите кнопку **Далее**.
5.  Добавьте отображаемое имя и выберите **группу устройств Windows** из раскрывающегося списка **тип входящего утверждения** .
6.  Нажмите кнопку **Готово**.  Нажмите кнопку **Применить** и **ОК**. 


### <a name="step-6-on-the-relying-party-where-the-windowsdevicegroup-claims-are-expected-add-a-similar-pass-through-or-transform-claim-rule"></a>Шаг 6. В проверяющей стороне, где ожидаются утверждения "Виндовсдевицеграуп", добавьте аналогичное правило утверждений "Pass-to" или "Transform".
2. В **AD FS управления**щелкните **отношения доверия с проверяющей стороной** и в правой области Azure щелкните RP и выберите **изменить правила утверждений**.
3. На странице **правила преобразования выдачи** нажмите кнопку **Добавить правило**.
4. В **мастере добавления правила преобразования утверждений** выберите **передать или отфильтровать входящее утверждение** и нажмите кнопку **Далее**.
5. Добавьте отображаемое имя и выберите **группу устройств Windows** из раскрывающегося списка **тип входящего утверждения** .
6. Нажмите кнопку **Готово**.  Нажмите кнопку **Применить** и **ОК**.

## <a name="validation"></a>Проверка
Чтобы проверить выпуск утверждений "Виндовсдевицеграуп", создайте приложение тестирования с поддержкой утверждений с помощью .NET 4,6. С пакетом SDK для WIF 4,0.
Настройте приложение в качестве проверяющей стороны в ADFS и обновите его с помощью правила утверждения, как указано в шагах выше.
При проверке подлинности в приложении с помощью встроенного поставщика проверки подлинности Windows ADFS будут приведены следующие утверждения.
![Проверки](media/AD-FS-Compound-Authentication-and-AD-DS-claims/gpmc9.png)

Теперь можно использовать утверждения для компьютера/устройства для более широких элементов управления доступом.

Например, следующий **аддитионалаусентикатионрулес** сообщает AD FS вызывать MFA, если — пользователь, выполняющий проверку подлинности, не является членом группы безопасности "-1-5-21-2134745077-1211275016-3050530490-1117" и компьютером (где находится пользователь Проверка подлинности из) не является членом группы безопасности "S-1-5-21-2134745077-1211275016-3050530490-1115 (Виндовсдевицеграуп)"

Однако при выполнении любого из указанных выше условий не следует вызывать MFA.

```
'NOT EXISTS([Type == "https://schemas.microsoft.com/ws/2008/06/identity/claims/windowsdevicegroup", Value =~ "S-1-5-21-2134745077-1211275016-3050530490-1115"])
&& NOT EXISTS([Type == "https://schemas.microsoft.com/ws/2008/06/identity/claims/groupsid", Value =~ "S-1-5-21-2134745077-1211275016-3050530490-1117"])
=> issue(Type = "https://schemas.microsoft.com/ws/2008/06/identity/claims/authenticationmethod", Value = "https://schemas.microsoft.com/claims/multipleauthn");'
```
