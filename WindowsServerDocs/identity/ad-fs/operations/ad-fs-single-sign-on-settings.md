---
ms.assetid: 1a443181-7ded-4912-8e40-5aa447faf00c
title: Параметры единого входа AD FS 2016
author: billmath
ms.author: billmath
manager: femila
ms.date: 08/17/2017
ms.topic: article
ms.openlocfilehash: 5d558717e3baa2f849636f4a8f347ce327cb787c
ms.sourcegitcommit: dfa48f77b751dbc34409aced628eb2f17c912f08
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/07/2020
ms.locfileid: "87966941"
---
# <a name="ad-fs-single-sign-on-settings"></a>Параметры единого входа AD FS

Единый вход (SSO) позволяет пользователям выполнять проверку подлинности один раз и обращаться к нескольким ресурсам без запроса дополнительных учетных данных.  В этой статье описывается поведение по умолчанию AD FS для единого входа, а также параметры конфигурации, позволяющие настроить это поведение.

## <a name="supported-types-of-single-sign-on"></a>Поддерживаемые типы единого входа

AD FS поддерживает несколько типов возможностей единого входа:

-   **Единый вход сеанса**

     Файлы cookie единого входа сеанса записываются для пользователя, прошедшего проверку подлинности, что устраняет дальнейшие запросы, когда пользователь переключает приложения в течение определенного сеанса. Однако если определенный сеанс завершается, пользователь снова получит запрос на ввод учетных данных.

     AD FS по умолчанию задает файлы cookie единого входа сеанса, если устройства пользователей не зарегистрированы. Если сеанс браузера завершился и перезапущен, этот файл cookie сеанса удаляется и не является допустимым.

-   **Постоянный единый вход**

     Файлы cookie постоянного единого входа записываются для пользователя, прошедшего проверку подлинности, что исключает дальнейшие запросы, когда пользователь переключает приложения в течение срока действия файла cookie постоянного единого входа. Различие между постоянным SSO и ВХОДом в сеансе заключается в том, что постоянный единый вход можно поддерживать в разных сеансах.

     Если устройство зарегистрировано, AD FS задаст файлы cookie для постоянного единого входа. AD FS также задает файл cookie для постоянного единого входа, если пользователь выбрал параметр "оставаться в системе". Если файл cookie постоянного единого входа не является допустимым, он будет отклонен и удален.

-   **Единый вход для конкретного приложения**

     В сценарии OAuth маркер обновления используется для сохранения состояния единого входа пользователя в области конкретного приложения.

     Если устройство зарегистрировано, AD FS установит срок действия маркера обновления на основе постоянного времени существования файлов cookie единого входа для зарегистрированного устройства, которое по умолчанию составляет 7 дней для AD FS 2012 R2 и не более 90 дней с AD FS 2016, если они используют устройство для доступа к AD FS ресурсам в течение 14 дней.

Если устройство не зарегистрировано, но пользователь выбрал параметр "оставаться в системе", срок действия маркера обновления будет равным времени существования файлов cookie для постоянного единого входа, который по умолчанию составляет 1 день и не может превышать 7 дней. В противном случае время существования маркера обновления равно времени существования cookie единого входа сеанса, которое по умолчанию составляет 8 часов

 Как упоминалось выше, пользователи зарегистрированных устройств всегда будут получать постоянный единый вход, если только не отключен постоянный единый вход. Для незарегистрированных устройств можно добиться постоянного единого входа, включив функцию "оставаться в системе" (функции "оставаться).

 Чтобы включить ПССО для сценария "оставаться в системе" в Windows Server 2012 R2, необходимо установить это [исправление](https://support.microsoft.com/kb/2958298/) , которое также входит в состав [накопительного пакета обновления за Август 2014 для Windows RT 8,1, Windows 8.1 и Windows Server 2012 R2](https://support.microsoft.com/kb/2975719).

Задача | PowerShell | Описание
------------ | ------------- | -------------
Включить или отключить постоянный единый вход | ```` Set-AdfsProperties –EnablePersistentSso <Boolean> ````| Постоянный единый вход включен по умолчанию. Если она отключена, файл cookie ПССО не записывается.
"Включить/отключить" оставаться в системе " | ```` Set-AdfsProperties –EnableKmsi <Boolean> ```` | Функция "оставаться в системе" отключена по умолчанию. Если он включен, конечный пользователь увидит вариант "оставаться в системе" на AD FS странице входа.



## <a name="ad-fs-2016---single-sign-on-and-authenticated-devices"></a>AD FS 2016 — единый вход и устройства с проверкой подлинности
AD FS 2016 изменяет ПССО при проверке подлинности запрашивающей стороны от зарегистрированного устройства, увеличивая его до максимального 90 дней, но требует проверки подлинности в течение 14 дней (окно "Использование устройства").
После первого предоставления учетных данных пользователи по умолчанию с зарегистрированными устройствами получают единый вход в течение максимального периода в 90 дней, при условии, что они используют устройство для доступа к ресурсам AD FS по крайней мере раз в 14 дней.  Если после предоставления учетных данных они ожидают 15 дней, пользователи снова получат запрос на ввод учетных данных.

Постоянный единый вход включен по умолчанию. Если она отключена, файл cookie ПССО не записывается. |

``` powershell
Set-AdfsProperties –EnablePersistentSso <Boolean\>
```

Окно "Использование устройства" (по умолчанию — 14 дней) регулируется свойством AD FS **девицеусажевиндовиндайс**.

``` powershell
Set-AdfsProperties -DeviceUsageWindowInDays
```
Максимальный срок действия единого входа (90 дней по умолчанию) регулируется свойством AD FS **персистентссолифетимеминс**.

``` powershell
Set-AdfsProperties -PersistentSsoLifetimeMins
```

## <a name="keep-me-signed-in-for-unauthenticated-devices"></a>Оставаться в системе для устройств без проверки подлинности
Для незарегистрированных устройств период единого входа определяется параметрами функции " **оставаться в системе" (функции "оставаться)** .  ФУНКЦИИ "оставаться отключен по умолчанию, и его можно включить, задав свойству AD FS Кмсиенаблед значение true.

``` powershell
Set-AdfsProperties -EnableKmsi $true
```

При отключенном функции "оставаться срок действия единого входа по умолчанию составляет 8 часов.  Это можно настроить с помощью свойства Ссолифетиме.  Свойство измеряется в минутах, поэтому его значение по умолчанию — 480.

``` powershell
Set-AdfsProperties –SsoLifetime <Int32\>
```

При включенном параметре функции "оставаться по умолчанию используется период единого входа 24 часа.  Это можно настроить с помощью свойства Кмсилифетимеминс.  Свойство измеряется в минутах, поэтому его значение по умолчанию — 1440.

``` powershell
Set-AdfsProperties –KmsiLifetimeMins <Int32\>
```

## <a name="multi-factor-authentication-mfa-behavior"></a>Поведение многофакторной проверки подлинности (MFA)
Важно отметить, что при предоставлении относительно длительных периодов единого входа AD FS будет запрашивать дополнительную проверку подлинности (многофакторную проверку подлинности), когда предыдущий вход был основан на первичных учетных данных, а для текущего входа требуется MFA.  Это зависит от конфигурации единого входа. AD FS при получении запроса на проверку подлинности сначала определяет, существует ли контекст единого входа (например, файл cookie), а затем, если требуется MFA (например, если запрос поступает из-за пределов), он будет оценивать, содержит ли контекст единого входа MFA.  В противном случае будет предложено указать MFA.



## <a name="psso-revocation"></a>Отзыв ПССО
 Чтобы защитить систему безопасности, AD FS будет отклонять все постоянные файлы cookie единого входа, ранее выданные при выполнении следующих условий. Для этого пользователю потребуется предоставить свои учетные данные для повторной проверки подлинности в AD FS.

- Изменения пароля пользователя

- Параметр постоянного единого входа отключен в AD FS

- Устройство отключено администратором в случае утери или кражи

- AD FS получает файл cookie постоянного единого входа, выданный для зарегистрированного пользователя, но пользователь или устройство больше не зарегистрированы

- AD FS получает файл cookie постоянного единого входа для зарегистрированного пользователя, но пользователь повторно зарегистрирован

- AD FS получает файл cookie постоянного единого входа, который выдается в результате "оставаться в системе", но параметр "оставаться в системе" отключен в AD FS

- AD FS получает файл cookie постоянного единого входа, выданный для зарегистрированного пользователя, но сертификат устройства отсутствует или изменен во время проверки подлинности

- AD FS администратор установил время отсечки для постоянного единого входа. Если этот файл настроен, AD FS будет отклонять все хранимые файлы cookie единого входа, выданные до этого момента

  Чтобы задать время отсечения, выполните следующий командлет PowerShell:


``` powershell
Set-AdfsProperties -PersistentSsoCutoffTime <DateTime>
```

## <a name="enable-psso-for-office-365-users-to-access-sharepoint-online"></a>Включение ПССО для пользователей Office 365 для доступа к SharePoint Online
 После включения и настройки ПССО в AD FS AD FS будет записывать постоянный файл cookie после того, как пользователь прошел проверку подлинности. Когда пользователь поступает в следующий раз, если постоянный файл cookie по-прежнему действителен, пользователю не нужно предоставлять учетные данные для повторной проверки подлинности. Кроме того, можно избежать дополнительных запросов проверки подлинности для пользователей Office 365 и SharePoint Online, настроив следующие два правила утверждений в AD FS для активации сохраняемости в Microsoft Azure AD и SharePoint Online.  Чтобы разрешить пользователям ПССО для Office 365 доступ к SharePoint Online, необходимо установить это [исправление](https://support.microsoft.com/kb/2958298/) , которое также входит в состав [накопительного пакета обновления за Август 2014 для Windows RT 8,1, Windows 8.1 и Windows Server 2012 R2](https://support.microsoft.com/kb/2975719).

 Правило преобразования выдачи, которое пройдет через утверждение Инсидекорпоратенетворк

```
@RuleTemplate = "PassThroughClaims"
@RuleName = "Pass through claim - InsideCorporateNetwork"
c:[Type == "https://schemas.microsoft.com/ws/2012/01/insidecorporatenetwork"]
=> issue(claim = c);
A custom Issuance Transform rule to pass through the persistent SSO claim
@RuleName = "Pass Through Claim - Psso"
c:[Type == "https://schemas.microsoft.com/2014/03/psso"]
=> issue(claim = c);

```

Итоги:
<table>
  <tr>
    <th colspan="1">Единый интерфейс SignOn</th>
    <th colspan="3">ADFS 2012 R2 <br> Зарегистрировано ли устройство?</th>
        <th colspan="1"></th>
    <th colspan="3">ADFS 2016 <br> Зарегистрировано ли устройство?</th>
  </tr>

  <tr align="center">
    <th></th>
    <th>NO</th>
    <th>НЕТ, но функции "оставаться</th>
    <th>YES</th>
    <th></th>
    <th>NO</th>
    <th>НЕТ, но функции "оставаться</th>
    <th>YES</th>
  </tr>
 <tr align="center">
    <td>SSO = &gt; задать токен обновления =&gt;</td>
    <td>8 часов</td>
    <td>Н/Д</td>
    <td>Н/Д</td>
    <th></th>
    <td>8 часов</td>
    <td>Н/Д</td>
    <td>Н/Д</td>
  </tr>

 <tr align="center">
    <td>ПССО = &gt; задать токен обновления =&gt;</td>
    <td>Н/Д</td>
    <td>24 часа</td>
    <td>7 дней</td>
    <th></th>
    <td>Н/Д</td>
    <td>24 часа</td>
    <td>Максимум 90 дней в течение 14 дней</td>
  </tr>

 <tr align="center">
    <td>Token Lifetime</td>
    <td>1 час</td>
    <td>1 час</td>
    <td>1 час</td>
    <th></th>
    <td>1 час</td>
    <td>1 час</td>
    <td>1 час</td>
  </tr>
</table>

**Зарегистрированное устройство?** Вы получаете ПССО или постоянный единый вход. <br>
**Устройство не зарегистрировано?** Вы получаете единый вход <br>
**Устройство не зарегистрировано, но функции "оставаться?** Вы получаете ПССО или постоянный единый вход. <p>
НАЛИЧИИ
 - [x] администратор включил функцию функции "оставаться [и]
 - [x] пользователь щелкает флажок функции "оставаться на странице входа в формы

  
ADFS выдает новый маркер обновления только в том случае, если срок действия более нового маркера обновления превышает предыдущий токен. Максимальное время существования маркера составляет 84 дней, но AD FS сохраняет маркер в течение 14-дневного скользящего окна. Если маркер обновления действителен в течение 8 часов, что является обычным временем единого входа, новый маркер обновления не будет выдаваться.
 

**Хорошая информация:** <br>
Федеративные пользователи, у которых нет синхронизированного атрибута **LastPasswordChangeTimestamp** , выдают файлы cookie сеанса и маркеры обновления с **максимальным сроком хранения 12 часов**.<br>
Это происходит потому, что Azure AD не может определить, когда следует отозвать маркеры, связанные со старыми учетными данными (например, с измененным паролем). Поэтому Azure AD необходимо чаще проверять, чтобы убедиться в том, что пользователь и связанные с ним маркеры все еще находятся в хорошем виде.
