---
ms.assetid: 777aab65-c9c7-4dc9-a807-9ab73fac87b8
title: Настройка защиты блокировки экстрасети AD FS
description: ''
author: billmath
ms.author: billmath
manager: mtilman
ms.date: 03/20/2019
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: identity-adfs
ms.openlocfilehash: dd6dea2fb8a16bfdbe93f93fbdd1dc5ac47af4be
ms.sourcegitcommit: 0b5fd4dc4148b92480db04e4dc22e139dcff8582
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/24/2019
ms.locfileid: "66189905"
---
# <a name="ad-fs-extranet-lockout-and-extranet-smart-lockout"></a>AD FS экстрасети и смарт-блокировка экстрасети

## <a name="overview"></a>Обзор

Экстрасети смарт-блокировки (ESL) защищает пользователей от возникают блокировки экстрасети учетных записей от вредоносных действий.  

ESL позволяет различать попытки входа из знакомого расположения для пользователя и что может быть злоумышленник попытки входа в AD FS. При этом разрешив допустимым пользователям продолжать использовать свои учетные записи AD FS можно заблокировать злоумышленники. Это позволяет и обеспечивает защиту от атак типа "отказ в обслуживании" и определенных классов Распылитель атаках на пароль для пользователя. ESL доступен для AD FS в Windows Server 2016 и встроена в AD FS в Windows Server 2019. 

ESL доступна только для имени пользователя и пароль проверки подлинности запросы какие отправляются через экстрасеть с прокси веб-приложения или поддерживаемой сторонних производителей прокси.   

## <a name="additional-features-in-ad-fs-2019"></a>Дополнительные возможности в AD FS 2019 г. 
Блокировка экстрасети смарт-в AD FS 2019 добавляет следующие преимущества по сравнению с AD FS 2016: 
- Установите пороговые значения независимых блокировки для знакомых и незнакомого расположения, таким образом, чтобы пользователи известных оптимально могут иметь дополнительные возможности для возникновения ошибок запросов, чем подозрительных расположениях 
- Включите режим аудита для смарт-блокировка, продолжая предоставлять доступ для принудительного применения прежнее поведение обратимого блокировки. Это позволяет узнать о знакомых расположениях пользователей и по-прежнему защищаться с помощью функции экстрасети, которое доступно из AD FS 2012 R2.  

## <a name="how-it-works"></a>Принцип работы 
### <a name="configuration-information"></a>сведения о конфигурации 
При включении ESL создана новая таблица в базе данных артефакта AdfsArtifactStore.AccountActivity, и выбран узел в ферме AD FS роль хозяина «Действие пользователя». В конфигурации с внутренней базой данных Windows этот узел всегда является основным узлом. В конфигурации SQL один узел выбран до главного активности пользователей.  

Для просмотра узла, выбранные в качестве главного активности пользователей. Get-AdfsFarmInformation.FarmRoles 

Все дополнительные узлы обратитесь к главному узлу через каждой новой учетной записи через порт 80, чтобы узнать последнее значение счетчика неверных паролей и новые значения знакомого расположения и обновление этого узла, после обработки имени входа. 

![настройка](media/configure-ad-fs-extranet-smart-lockout-protection/esl1.png)

 Если дополнительный узел не может связаться с хозяином, он будет записывать события ошибок в журнал администратора AD FS. Проверка подлинности по-прежнему обрабатываться, но AD FS будут только записи локально обновленное состояние. AD FS повторит попытку обратиться к хозяину каждые 10 минут и переключится обратно к хозяину после главного доступен. 

### <a name="terminology"></a>Терминология 
- **FamiliarLocation**: При выполнении запроса проверки подлинности ESL проверяет все представленные IP-адресов. Эти IP-адреса будет представлять собой сочетание сети, пересылаемые IP-адрес и необязательный x-forwarded-for IP-адресов. Если запрос выполнен успешно, все IP-адресов добавляются в таблицу действиям в учетной записи «знакомы IP-адреса». Если запрос содержит все IP-адресов в «Знакомы IP-адресов», запрос будет рассматриваться как «знакомому».
- **UnknownLocation**: Если входящий запрос имеет по крайней мере один IP-адрес отсутствует в списке существующих «FamiliarLocation», запрос будет рассматриваться как опции «Unknown». Это позволяет обрабатывать сценарии прокси, такие как Exchange Online прежних версий проверки подлинности, где Exchange Online адреса обработки успешных и неудачных запросов.  
- **badPwdCount**: Значение, представляющее число раз, когда был отправлен неправильный пароль и проверка подлинности завершилась неудачно. Для каждого пользователя отдельные счетчики хранятся знакомых и неизвестным расположениям. 
- **UnknownLockout**: Логическое значение, на пользователя, если пользователь будет заблокирован доступ из неизвестных расположений. Это значение, рассчитывается на основании badPwdCountUnfamiliar и ExtranetLockoutThreshold значения. 
- **ExtranetLockoutThreshold**: Это значение определяет максимальное количество попытки ввода неправильного пароля. При достижении порогового значения ADFS отклоняет запросы из экстрасети, пока не истечет окно наблюдения.
- **ExtranetObservationWindow**: Это значение определяет длительность, которые заблокированы запросы имя пользователя и пароль из неизвестных расположений. При передаче в окне, для выполнения проверки подлинности имя пользователя и пароль из неизвестных расположений снова начнет служб федерации Active Directory. 
- **ExtranetLockoutRequirePDC**: При включении блокировки экстрасети требует основного контроллера домена (PDC). При отключении блокировки экстрасети будут переведены на другом контроллере домена, на случай, если основной контроллер домена недоступен.  
- **ExtranetLockoutMode**: Элементы управления входа только vs принудительно режим смарт-блокировка экстрасети 
    - **ADFSSmartLockoutLogOnly**: Экстрасети смарт-блокировка включена, но AD FS будут только записи администратора и события аудита, но будет отклонения запросов проверки подлинности. Этот режим предназначен для изначально включено для FamiliarLocation для заполнения до включения «ADFSSmartLockoutEnforce».
    - **ADFSSmartLockoutEnforce**: Полная поддержка блокировок запросов проверки подлинности не знакомы, при достижении пороговых значений. 

Поддерживаются адреса IPv4 и IPv6. 

### <a name="anatomy-of-a-transaction"></a>Анатомия транзакции 
- **Проверка подлинности до входа проверка**: При выполнении запроса проверки подлинности ESL проверяет все представленные IP-адресов. Эти IP-адреса будет представлять собой сочетание сети, пересылаемые IP-адрес и необязательный x-forwarded-for IP-адресов. В журналах аудита, соответствующих IP-адресов, перечислены в <IpAddress> поле порядке x-ms-forwarded--IP-адрес клиента, x-forwarded-for, x-ms прокси--IP-адрес клиента. 
 
  Исходя из этих IP-адресов, служб федерации Active Directory определяет, если запрос является из знакомых или незнакомого расположения, а затем проверяет, является ли соответствующие badPwdCount меньше заданного порогового значения ограничения или последнего **сбой** произошло попытки больше времени, чем интервал времени, окно наблюдения. Если выполняется одно из этих условий, ADFS позволяет этой транзакции, для дальнейшей обработки и учетных данных проверки. Если оба условия имеют значение false, учетная запись уже out заблокированным пока не пройдет окно наблюдения. По истечении окно наблюдения, пользователь может одна попытка проверки подлинности. Обратите внимание на то, что в 2019 г., служб федерации Active Directory проверяет по ограничению соответствующее пороговое значение на основе Если IP-адрес соответствует знакомого расположения или нет.
- **При успешном выполнении входа**: Если вход выполнен успешно, IP-адреса из запроса добавляются в список IP-знакомого расположения пользователя.  
- **Ошибка входа**: При сбое входа badPwdCount увеличивается. Пользователь переходит в состояние блокировки, если злоумышленник отправляет несколько неправильных паролей в системе превышает пороговое значение. (badPwdCount > ExtranetLockoutThreshold)  

![настройка](media/configure-ad-fs-extranet-smart-lockout-protection/esl2.png)

Значение «UnknownLockout» будет равно true, при блокировке учетной записи. Это означает, что badPwdCount пользователя превышает порог т. е. что кто-то попытки больше паролей, чем разрешено системой. В этом состоянии можно двумя способами, которые допустимый пользователь может войти. 
- Пользователь должен ожидать в течение ObservationWindow времени пройти или
- Чтобы сбросить состояние блокировки, сброса badPwdCount сбрасывается с «Reset-ADFSAccountLockout». 

В случае не сбрасывает учетной записи получат сообщение об ошибке попытки одним паролем в AD для каждого окна наблюдения. Учетная запись вернется в заблокированной состояние после этого будет перезапущен попытка и окно наблюдения. Значение badPwdCount сбросит только автоматически после успешной пароль имени входа. 

### <a name="log-only-mode-versus-enforce-mode"></a>Только для журнала режима и режима «Применить» 
AccountActivity таблица заполняется в том случае, как во время только для журнала режимом и режимом «Принудительно». Если режим «Только для журнала» пропускается и ESL перемещается непосредственно в режиме «Применить» без рекомендуемые период ожидания, знакомы IP-адресов пользователей будет доступен не для служб федерации Active Directory. В этом случае ESL бы ведут себя как «ADBadPasswordCounter», может блокировать трафик полномочного пользователя. Если учетная запись пользователя находится под атакой active подбора. Если режим «Только для журнала» пропускается, и пользователь вводит заблокированных out состояние с «UnknownLockout» = TRUE и пытается выполнить вход с использованием надежного пароля от IP, не находится в списке «знаком» IP-адрес, то они не смогут войти. 3 – 7 дней избежать этого сценария рекомендуется режим только для журнала. Если учетные записи являются активно подвергается атаке, менее 24 часов режима «Только для журнала» необходима для предотвращения блокировки для обычных пользователей.  

## <a name="extranet-smart-lockout-configuration"></a>Конфигурация смарт-блокировка экстрасети  
 
### <a name="prerequisites-for-ad-fs-2016"></a>Предварительные требования для AD FS 2016 
 
1. **Установить обновления на всех узлах фермы**

   Во-первых убедитесь, все серверы Windows Server 2016 AD FS обновлены начиная с июня 2018 г. обновления Windows и что на ферме AD FS 2016 работает на уровне поведения фермы 2016.
1. **Проверка разрешений** 

   Смарт-блокировка экстрасети требует, что Windows удаленное управление включено на каждом сервере AD FS.
3. **Обновить разрешения артефактов базы данных** 
 
   Смарт-блокировка экстрасети требует учетной записи службы AD FS нет разрешений на создание новой таблицы в базе данных AD FS артефакта. Войдите на любом сервере AD FS, как администратор AD FS и предоставьте это разрешение, выполнив следующие команды в окне командной строке PowerShell: 

   ``` powershell
   PS C:\>$cred = Get-Credential 
   PS C:\>Update-AdfsArtifactDatabasePermission -Credential $cred 
   ``` 
   >[!NOTE]
   >Заполнитель $cred является учетной записью, имеющей права администратора AD FS. Она должна вывести разрешений на запись для создания таблицы. 

   Приведенные выше команды может завершиться ошибкой из-за отсутствия достаточных разрешений, так как ваша ферма AD FS используется SQL Server и учетные данные, указанные выше не имеет разрешения администратора на сервере SQL. В этом случае можно настроить разрешения для базы данных вручную в базе данных SQL Server, выполнив следующую команду, при подключении к базе данных AdfsArtifactStore. 
    ```  
    # when prompted with “Are you sure you want to perform this action?”, enter Y. 

    [CmdletBinding(SupportsShouldProcess=$true,ConfirmImpact = 'High')] 
    Param() 

    $fileLocation = "$env:windir\ADFS\Microsoft.IdentityServer.Servicehost.exe.config" 

    if (-not [System.IO.File]::Exists($fileLocation)) 
    { 
    write-error "Unable to open ADFS configuration file." 
    return 
    } 

    $doc = new-object Xml 
    $doc.Load($fileLocation) 
    $connString = $doc.configuration.'microsoft.identityServer.service'.policystore.connectionString 
    $connString = $connString -replace "Initial Catalog=AdfsConfigurationV[0-9]*", "Initial Catalog=AdfsArtifactStore" 

    if ($PSCmdlet.ShouldProcess($connString, "Executing SQL command sp_addrolemember 'db_owner', 'db_genevaservice' ")) 
    { 
    $cli = new-object System.Data.SqlClient.SqlConnection 
    $cli.ConnectionString = $connString 
    $cli.Open() 

    try 
    {     

    $cmd = new-object System.Data.SqlClient.SqlCommand 
    $cmd.CommandText = "sp_addrolemember 'db_owner', 'db_genevaservice'" 
    $cmd.Connection = $cli 
    $rowsAffected = $cmd.ExecuteNonQuery()  
    if ( -1 -eq $rowsAffected ) 
    { 
    write-host "Success" 
    } 
    } 
    finally 
    { 
    $cli.CLose() 
    } 
    } 
    ``` 

### <a name="ensure-ad-fs-security-audit-logging-is-enabled"></a>Убедитесь, что включен журнал аудита безопасности AD FS 
Эта функция использует аудита безопасности, необходимо включить журналы, так что аудита в AD FS, а также локальной политики на всех серверах AD FS. 
 
### <a name="configuration-instructions"></a>Инструкции по настройке 
Свойства служб федерации Active Directory использует смарт-блокировка экстрасети **ExtranetLockoutEnabled**. Это свойство использовался ранее для элемента управления «Блокировка экстрасети мягкие» в Server 2012 R2. Если было включено обратимое экстрасети, для просмотра текущей конфигурации свойства, выполните ` Get-AdfsProperties` . 

### <a name="configuration-recommendations"></a>Рекомендации по конфигурации 
При настройке смарт-блокировка экстрасети, выполните рекомендации для настройки пороговых значений.  

`ExtranetObservationWindow (new-timespan -Minutes 30)` 

`ExtranetLockoutThreshold: – 2x AD Threshold Value` 

Значение AD: 20 ExtranetLockoutThreshold. 10 

Active Directory блокировки независимы друг от друга экстрасети смарт-блокировка. Тем не менее, если включена блокировка Active Directory, ExtranetLockoutThreshold в AD FS < пороговое значение блокировки учетной записи в AD 

`ExtranetLockoutRequirePDC - $false`
 
При включении блокировки экстрасети требует основного контроллера домена (PDC). Отключена и настроены как false, блокировка экстрасети будут переведены на другом контроллере домена, на случай, если основной контроллер домена недоступен. 
 
Чтобы задать это свойство запуска: 

``` powershell
Set-AdfsProperties -EnableExtranetLockout $true -ExtranetLockoutThreshold 15 -ExtranetObservationWindow (new-timespan -Minutes 30) -ExtranetLockoutRequirePDC $false 
```
### <a name="enable-log-only-mode"></a>Включение режима только для журнала 
 
В режиме только для журнала AD FS заполняет сведения знакомого расположения пользователей и записывает события аудита безопасности, но не блокирует все запросы. Этот режим используется для проверки, что смарт-блокировка работает, и чтобы включить AD FS «дополнительные» знакомый расположения для пользователей перед включением «принудительно» режим. Как AD FS узнает, он хранит входа в систему на пользователя (следует ли в режиме только для журнала или принудительное применение). Задайте поведение блокировки в журнал только выполнив следующий командлет.  

`Set-AdfsProperties -ExtranetLockoutMode AdfsSmartlockoutLogOnly` 

Только режим журнала должен быть временное состояние, чтобы система можно изучить поведение входа до введение принудительного применения блокировки с поведением смарт-блокировка. Рекомендуемая продолжительность режиме только для журнала составляет 3 – 7 дней. Если учетные записи являются активно подвергается атаке, режим только для журнала необходимо запустить для менее 24 часов. 

В AD FS 2016 Если поведение 2012 R2 «Блокировка экстрасети мягкие» включена перед включением смарт-блокировка экстрасети, режиме только для журнала отключит поведение «Блокировка экстрасети мягких». Смарт-блокировка AD FS не приведут к блокировке пользователей в режиме только для журнала. Тем не менее в локальном каталоге AD может заблокировать пользователя, в зависимости от конфигурации AD. Просмотрите политики блокировки AD, чтобы узнать как в локальной среде AD могут блокировки пользователей. 

В службе AD FS 2019 дополнительное преимущество заключается в возможности для перехода в режим только для журнала для смарт-блокировка продолжая применять предыдущего поведения обратимо блокировки с помощью Powershell ниже. 

`Set-AdfsProperties -ExtranetLockoutMode 3` 
 
Новый режим вступили в силу перезапустите службу AD FS на всех узлах фермы 

`Restart-service adfssrv` 
 
Настроив режим, можно включить с помощью параметра EnableExtranetLockout смарт-блокировка 
 
`Set-AdfsProperties -EnableExtranetLockout $true` 

### <a name="enable-enforce-mode"></a>Включение Принудительный режим 
 
После вы привыкли окна блокировки пороговое значение и наблюдения, можно переместить ESL «принудительно» режиме, с помощью командлета PSH: 

`Set-AdfsProperties -ExtranetLockoutMode AdfsSmartLockoutEnforce` 

Новый режим вступили в силу перезапустите службу AD FS на всех узлах фермы с помощью следующей команды. 

`Restart-service adfssrv` 

## <a name="manage-user-account-activity"></a>Управление действиям в учетной записи пользователя 
AD FS предоставляет три командлеты для управления данными учетной записи действия. Эти командлеты автоматически подключаться к узлу, удерживает главную роль в ферме. 
>[!NOTE] 
>Just Enough Administration (JEA) можно использовать для делегирования командлеты AD FS для сброса блокировки учетной записи. Например персонал службы поддержки могут предоставляться права для использования командлетов ESL. Дополнительные сведения о делегировании разрешениями на использование этих командлетов см. в разделе [делегат AD FS Powershell командлет доступ пользователям без прав администратора](delegate-ad-fs-pshell-access.md)

Это поведение можно переопределить, передав параметр - Server. 

- Get-ADFSAccountActivity 

  Чтение текущей учетной записи действия для учетной записи пользователя. Командлет всегда автоматически подключается к хозяину фермы с помощью конечной точки REST учетной записи действия. Таким образом все данные всегда должно быть согласовано. 

  Пример. Get-ADFSAccountActivity user@contoso.com 

  Свойства: 
    - BadPwdCountFamiliar: Значение счетчика увеличивается после успешной проверки подлинности из известного расположения.
    - BadPwdCountUnknown: Увеличивается при счете секунд не выполняет проверку подлинности из неизвестного местоположения
    - LastFailedAuthFamiliar: Если проверка подлинности завершилась неудачно из знакомого расположения, LastFailedAuthUnknown присваивается время неудачной проверки подлинности 
    - LastFailedAuthUnknown: Если проверка подлинности завершилась неудачно из неизвестного местоположения, LastFailedAuthUnknown присваивается время неудачной проверки подлинности 
    - FamiliarLockout: Логическое значение, которое будет «True», если «BadPwdCountFamiliar» > ExtranetLockoutThreshold 
    - UnknownLockout: Логическое значение, которое будет «True», если «BadPwdCountUnknown» > ExtranetLockoutThreshold  
    - FamiliarIPs: не более 20 IP-адреса, который знаком для пользователя. При превышении удаляется старый IP-адрес в списке. 
-    SET-ADFSAccountActivity 
     
     Добавляет новый знакомых расположениях. Знакомые список IP-адрес содержит не более 20 записей, при превышении, старый IP-адрес в списке будут удалены. 

     Пример. SET-ADFSAccountActivity user@contoso.com - AdditionalFamiliarIps «1.2.3.4»

- Reset-ADFSAccountLockout 
   
  Сбрасывает счетчик блокировки учетной записи пользователя для каждого знакомого расположения (badPwdCountFamiliar) или счетчики неизвестного расположения (badPwdCountUnfamiliar). Путем сброса счетчика, обновит значения «FamiliarLockout» или «UnfamiliarLockout», так как до сброса счетчика будет меньше порогового значения.  

   Пример. Сброс ADFSAccountLockout user@contoso.com -расположение знакомым примером:  Reset-ADFSAccountLockout user@contoso.com -Location Unknown 

## <a name="event-logging--user-activity-information-for-ad-fs-extranet-lockout"></a>Ведение журнала событий и действий пользователя для блокировки экстрасети AD FS 

### <a name="connect-health"></a>Connect Health 
Рекомендуемый способ наблюдения за действиям в учетной записи пользователя — Connect Health. Connect Health создает, загружаемые отчеты о опасных IP-адресов и попытки ввода неправильного пароля. Каждый элемент в отчете о ненадежном IP-адресе показывает статистические данные о неудачных AD FS действий входа превышающих указанный порог. Можно задать уведомления по электронной почте для предупреждения администраторов о, как только это происходит с помощью настраиваемых параметров электронной почты. Дополнительные сведения и инструкции по настройке, см. в статье [Connect Health документации](https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-health-adfs). 

### <a name="ad-fs-extranet-smart-lockout-events"></a>События AD FS экстрасети смарт-блокировка. 
Для событий смарт-блокировка экстрасети для записи ESL должен быть включен в режиме «только для журнала» или «применить», и включен аудит безопасности служб федерации Active Directory. AD FS будет записывать экстрасети события в журнал аудита безопасности: 
- Когда пользователь заблокировано out (достигает порогового значения блокировки для попыток неудачного входа) 
- При получении попытки входа для пользователя, который уже находится в состоянии блокировки в AD FS 

В режиме журнала можно просмотреть в журнале аудита безопасности для событий блокировки. Для любого события можно проверить состояние пользователя, с помощью командлета Get-ADFSAccountActivity, чтобы определить, если произошла блокировка из знакомых или незнакомого IP-адресов, а также тщательно проверить список знакомы IP-адреса для этого пользователя. 


|Идентификатор события|Описание|
|-----|-----| 
|1203|Это событие записывается для каждой попытки неправильный пароль. Как только badPwdCount достигнет значения, заданного в ExtranetLockoutThreshold, учетной записи будет заблокирован на ADFS на время, указанное в ExtranetObservationWindow.</br>Идентификатор действия: %1</br>XML: %2|
|1201|Это событие записывается каждый раз, когда пользователь будет заблокирован. </br>Идентификатор действия: %1</br>XML: %2| 
|557 (ADFS 2019)| Произошла ошибка при попытке взаимодействия со службой rest учетной записи хранилища на узле %1. Если это ферму WID. основного узла может быть вне сети. Если это SQL-фермы служб федерации Active Directory автоматически выберет новый узел для размещения роли хозяина хранилище пользователя.| 
|562 (ADFS 2019)|Произошла ошибка при организацией связи с учетной записью хранения конечной точки на сервере %1.</br>Сообщение об исключении: %2| 
|563 (ADFS 2019)|Произошла ошибка при вычислении состояния блокировки экстрасети. Настройка проверки подлинности из-за значения %1 будет разрешено для этого пользователя и будут по-прежнему выдачи маркера. Если это ферму WID. основного узла может быть вне сети. Если это SQL-фермы служб федерации Active Directory автоматически выберет новый узел для размещения роли хозяина хранилище пользователя.</br>Имя сервера для учетной записи хранилища: %2</br>Идентификатор пользователя: %3</br>Сообщение об исключении: %4|
|512|Учетная запись для следующего пользователя блокируется. Попытки входа допускается из-за конфигурации системы.</br>Идентификатор действия: %1 </br>Пользователь: %2 </br>Клиент IP-адрес: %3 </br>Счетчик неправильных паролей: %4  </br>Последняя попытка неправильного пароля: %5|
|515|Следующей учетной записи пользователя был out заблокированным, и только что указан правильный пароль. Эта учетная запись может быть скомпрометировано.</br>Дополнительные данные </br>Идентификатор действия: %1 </br>Пользователь: %2 </br>Клиент IP-адрес: %3 |
|516|Следующую учетную запись пользователя заблокирована из-за слишком большого количества попыток ввода неправильного пароля.</br>Идентификатор действия: %1  </br>Пользователь: %2  </br>Клиент IP-адрес: %3  </br>Счетчик неправильных паролей: %4  </br>Последняя попытка неправильного пароля: %5|

## <a name="esl-frequently-asked-questions"></a>ESL часто задаваемые вопросы 
 
**Будет фермы служб федерации Active Directory, с помощью экстрасети смарт-блокировка в режиме принудительного применения, когда-либо см. в разделе блокировки пользователь-злоумышленник?**  

Ответ. Если смарт-блокировка служб федерации Active Directory имеет значение «принудительно» режиме, то вы не увидите полномочного пользователя учетная запись заблокирована, подбора или отказ в обслуживании. Это единственный способ блокировки вредоносных учетной записи можно предотвратить вход пользователя — Если вредоносный субъект имеет пароль пользователя, или может отправлять запросы с известной хорошей (знакомые) IP-адресов для этого пользователя.  
 
**Что произойдет, ESL включен и вредоносный субъект имеет пароль?**  

Ответ. Типичный сценария атаки методом подбора призван угадать пароль и войти в систему.  Если пользователь является фишинга или угадать пароль затем функцию ESL не будет блокировать доступ с момента входа будет условиям «successful» правильный пароль, а также новый IP-адрес. IP-адрес недобросовестных сторон, будут отображаться как «знаком». Рекомендации по устранению рисков в этом сценарии — для очистки динамического содержимого в службах ADFS и требует многофакторной проверки подлинности для пользователей. Настоятельно рекомендуется установить защиту паролем AAD, который гарантирует, что угадать пароли не получают в систему. 
 
**Если мой пользователь не вошел в успешно из IP-адрес и затем пытается с неверным паролем несколько раз они смогут войти в систему после их наконец вводить пароль правильно?**  

Ответ. Если пользователь отправляет несколько неправильных паролей (т. е. законно неверно ввода) на следующий пример с попыткой возвращает правильный пароль, затем пользователь сразу же будет успешно выполнить вход.  Это будет очистить счетчика неверных паролей и добавит этот IP-адрес в список FamiliarIPs.  Тем не менее если они превысить порог неудачных попыток входа из неизвестного расположения, он вводит в состояние блокировки, и они потребуют ожидания за окно наблюдения и войдите с помощью пароля или требующих вмешательства администратора для сброса учетной записи.  
 
**ESL работает в интрасети слишком?**    Ответ. Если клиенты подключаются непосредственно к серверам служб федерации Active Directory, а не через прокси веб-приложения серверов ESL поведение не применяются.  
 
**Я вижу IP-адресов Microsoft в поле IP-адрес клиента. ESL блок EXO прокси методом подбора атак?**   

Ответ. ESL будет работать хорошо, чтобы предотвратить Exchange Online или другими сценариями атак методом подбора устаревшей проверки подлинности. Устаревшая проверка подлинности имеет «Идентификатор действия» 00000000-0000-0000-0000-000000000000. В эти атаки вредоносный субъект использует преимущества Exchange Online обычной проверки подлинности (также известный как устаревшая проверка подлинности), чтобы IP-адрес клиента отображается как пользователям Microsoft. Серверы Exchange online в облачной прокси-сервер проверки подлинности от имени клиента Outlook. В этих сценариях IP-адрес отправителя вредоносных будут располагаться в x-ms-forwarded--IP-адрес клиента и сервера Microsoft Exchange Online, IP-адрес будет иметь значение x-ms--IP-адрес клиента. Смарт-блокировка экстрасети проверяет сети IP-адреса, перенаправленные IP-адресов "," x-forwarded--IP-адрес клиента "и" значение x-ms--IP-адрес клиента. Если запрос выполнен успешно, все IP-адреса добавляются к списку знакомы. Если запрос поступает и любой из представленных IP-адреса нет в списке знакомых запрос будет помечен как не знакомы. Привычный пользовательский будет входить в систему успешно хотя запросы из неизвестных расположений, будут заблокированы.  


## <a name="additional-references"></a>Дополнительная справка  
[Рекомендации по обеспечению безопасности служб федерации Active Directory](../../ad-fs/deployment/best-practices-securing-ad-fs.md)

[Set-AdfsProperties](https://technet.microsoft.com/itpro/powershell/windows/adfs/set-adfsproperties)

[Операции AD FS](../../ad-fs/AD-FS-2016-Operations.md)

    
