---
ms.assetid: e863ab80-4e4c-48d3-bdaa-31815ef36bae
title: Настройка AD FS для проверки подлинности пользователей, хранящихся в каталогах LDAP
author: billmath
ms.author: billmath
manager: femila
ms.date: 05/31/2017
ms.topic: article
ms.prod: windows-server
ms.technology: identity-adfs
ms.openlocfilehash: a3e429d43fd644cd2b8ba3a5b123deecc2696f24
ms.sourcegitcommit: 912a5a402ecc6b39c1584338ea635a2ac11a4eb9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2020
ms.locfileid: "82219288"
---
# <a name="configure-ad-fs-to-authenticate-users-stored-in-ldap-directories-in-windows-server-2016-or-later"></a>Настройка AD FS для проверки подлинности пользователей, хранящихся в каталогах LDAP в Windows Server 2016 или более поздней версии

В следующем разделе описывается конфигурация, необходимая для предоставления инфраструктуре AD FS проверки подлинности пользователей, удостоверения которых хранятся в каталогах, соответствующих протоколу LDAP V3.

Во многих организациях решения для управления удостоверениями состоят из сочетания Active Directory, AD LDS или сторонних каталогов LDAP. Благодаря добавлению поддержки AD FS для проверки подлинности пользователей, хранящихся в каталогах, совместимых с LDAP V3, можно воспользоваться преимуществами набора функций корпоративного уровня AD FS независимо от того, где хранятся удостоверения пользователей. AD FS поддерживает любой каталог, совместимый с LDAP V3.

> [!NOTE]
> Некоторые AD FS функции включают единый вход (SSO), проверку подлинности устройства, гибкие политики условного доступа, поддержку работы в любом месте через интеграцию с прокси веб-приложения и тесную Федерацию с Azure AD, которая, в свою очередь, позволяет вам и вашим пользователям использовать облако, включая Office 365 и другие приложения SaaS.  Дополнительные сведения см. в разделе [службы федерации Active Directory (AD FS) Обзор](../../ad-fs/AD-FS-2016-Overview.md).

Чтобы AD FS проверить подлинность пользователей из каталога LDAP, необходимо подключить этот каталог LDAP к ферме AD FS, создав **Локальное отношение доверия с поставщиком утверждений**.  Отношение доверия с локальным поставщиком утверждений — это объект доверия, представляющий каталог LDAP в ферме AD FS. Объект доверия поставщика локальных утверждений состоит из множества идентификаторов, имен и правил, которые обозначают этот каталог LDAP в локальной службе Федерации.

Вы можете поддерживать несколько каталогов LDAP, каждый из которых имеет собственную конфигурацию, в той же AD FS ферме, добавляя несколько **локальных отношений доверия с поставщиком утверждений**. Кроме того, AD DS лесов, которые не являются доверенными для леса, который AD FS живет в, также могут моделироваться как локальные отношения доверия поставщиков утверждений. С помощью Windows PowerShell можно создавать локальные отношения доверия поставщиков утверждений.

Каталоги LDAP (локальные отношения доверия поставщика утверждений) могут сосуществовать с каталогами AD (отношениями доверия поставщиков утверждений) на одном сервере AD FS, в той же AD FS ферме, поэтому один экземпляр AD FS способен выполнять проверку подлинности и авторизацию доступа для пользователей, которые хранятся в каталогах AD и не в AD.

Для проверки подлинности пользователей из каталогов LDAP поддерживается только проверка подлинности на основе форм. Проверка подлинности Windows на основе сертификатов и встроенных данных не поддерживается для проверки подлинности пользователей в каталогах LDAP.

Все протоколы пассивной авторизации, поддерживаемые AD FS, включая SAML, WS-Federation и OAuth, также поддерживаются для удостоверений, хранящихся в каталогах LDAP.

Активный протокол авторизации WS-Trust также поддерживается для удостоверений, хранящихся в каталогах LDAP.

## <a name="configure-ad-fs-to-authenticate-users-stored-in-an-ldap-directory"></a>Настройка AD FS для проверки подлинности пользователей, хранящихся в каталоге LDAP
Чтобы настроить ферму AD FS для проверки подлинности пользователей из каталога LDAP, можно выполнить следующие действия.

1. Сначала настройте подключение к каталогу LDAP с помощью командлета **New-адфслдапсерверконнектион** :

   ```
   $DirectoryCred = Get-Credential
   $vendorDirectory = New-AdfsLdapServerConnection -HostName dirserver -Port 50000 -SslMode None -AuthenticationMethod Basic -Credential $DirectoryCred
   ```

   > [!NOTE]
   > Рекомендуется создать новый объект подключения для каждого LDAP-сервера, к которому необходимо подключиться. AD FS может подключиться к нескольким репликам LDAP-серверов и автоматически выполнить отработку отказа, если конкретный сервер LDAP не работает. В таком случае можно создать один Адфслдапсерверконнектион для каждого из этих реплик серверов LDAP, а затем добавить массив объектов подключения с помощью параметра-**лдапсерверконнектион** командлета **Add-адфслокалклаимспровидертруст** .

   **Примечание.** Попытка использовать Get-Credential и ввод различающегося имени и пароля, которые будут использоваться для привязки к экземпляру LDAP, может привести к сбою из-за требований пользовательского интерфейса для конкретных входных форматов, например домен \ имя_пользователя или user@domain.tld. Вместо этого можно использовать командлет ConvertTo-SecureString, как показано ниже (в примере ниже предполагается UID = Admin, OU = System в качестве DN учетных данных, используемых для привязки к экземпляру LDAP):

   ```
   $ldapuser = ConvertTo-SecureString -string "uid=admin,ou=system" -asplaintext -force
   $DirectoryCred = Get-Credential -username $ldapuser -Message "Enter the credentials to bind to the LDAP instance:"
   ```

   Затем введите пароль для UID = Admin и выполните остальные шаги.

2. Затем можно выполнить дополнительный шаг сопоставления атрибутов LDAP с существующими AD FS утверждениями с помощью командлета **New-адфслдапаттрибутетоклаиммаппинг** . В приведенном ниже примере атрибуты LDAP givenName, фамилия и CommonName сопоставляются с утверждениями AD FS.

   ```
   #Map given name claim
   $GivenName = New-AdfsLdapAttributeToClaimMapping -LdapAttribute givenName -ClaimType "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/givenname"
   # Map surname claim
   $Surname = New-AdfsLdapAttributeToClaimMapping -LdapAttribute sn -ClaimType "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/surname"
   # Map common name claim
   $CommonName = New-AdfsLdapAttributeToClaimMapping -LdapAttribute cn -ClaimType "http://schemas.xmlsoap.org/claims/CommonName"
   ```

   Это сопоставление выполняется для того, чтобы сделать атрибуты из хранилища LDAP доступными в качестве утверждений в AD FS для создания правил управления условным доступом в AD FS. Он также позволяет AD FS работать с пользовательскими схемами в хранилищах LDAP, предоставляя простой способ сопоставлять атрибуты LDAP с утверждениями.

3. Наконец, необходимо зарегистрировать хранилище LDAP с AD FS в качестве отношения доверия с локальным поставщиком утверждений с помощью командлета **Add-адфслокалклаимспровидертруст** :

   ```
   Add-AdfsLocalClaimsProviderTrust -Name "Vendors" -Identifier "urn:vendors" -Type Ldap

   # Connection info
   -LdapServerConnection $vendorDirectory 

   # How to locate user objects in directory
   -UserObjectClass inetOrgPerson -UserContainer "CN=VendorsContainer,CN=VendorsPartition" -LdapAuthenticationMethod Basic 

   # Claims for authenticated users
   -AnchorClaimLdapAttribute mail -AnchorClaimType "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/upn" -LdapAttributeToClaimMapping @($GivenName, $Surname, $CommonName) 

   # General claims provider properties
   -AcceptanceTransformRules "c:[Type != ''] => issue(claim=c);" -Enabled $true 

   # Optional - supply user name suffix if you want to use Ws-Trust
   -OrganizationalAccountSuffix "vendors.contoso.com"
   ```

   В приведенном выше примере вы создаете отношение доверия с локальным поставщиком утверждений под названием "поставщики". Вы указываете сведения о подключении для AD FS для подключения к каталогу LDAP, который это отношение доверия с локальным поставщиком `-LdapServerConnection` утверждений представляет, назначая `$vendorDirectory` параметру. Обратите внимание, что на шаге 1 вы `$vendorDirectory` назначили строку подключения, которая будет использоваться при подключении к конкретному каталогу LDAP. Наконец, вы указываете, что `$GivenName`атрибуты `$Surname`LDAP, `$CommonName` и (которые сопоставлены с утверждениями AD FS) используются для управления условным доступом, включая политики многофакторной идентификации и правила авторизации выдачи, а также для выдачи с помощью утверждений в маркерах безопасности, выданных в AD FS. Чтобы использовать активные протоколы, такие как WS-Trust с AD FS, необходимо указать параметр Организатионалаккаунтсуффикс, который позволяет AD FS распознавать отношения доверия между локальными поставщиками утверждений при обслуживании активного запроса авторизации.

## <a name="see-also"></a>См. также
[Операции AD FS](../../ad-fs/AD-FS-2016-Operations.md)

