---
ms.assetid: 
title: "Политики управления доступом в службах федерации Active Directory 2.0"
description: 
author: billmath
ms.author: billmath
manager: femila
ms.date: 05/31/2017
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: identity-adfs
ms.openlocfilehash: 00b9cd17c7a5c206e06bea12fd90762adb336715
ms.sourcegitcommit: db290fa07e9d50686667bfba3969e20377548504
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/12/2017
---
# <a name="client-access-control-policies-in-ad-fs-20"></a>Политики управления доступом в AD FS 2.0
Политики доступа клиента, в службах федерации Active Directory 2.0 позволяют ограничить или предоставлять пользователям доступ к ресурсам.  Здесь описано, как включить клиентских политик доступа в AD FS 2.0 и настройка наиболее распространенных сценариев.

## <a name="enabling-client-access-policy-in-ad-fs-20"></a>Включение политики доступа клиента в AD FS 2.0

Чтобы включить политику доступа клиента, выполните следующие действия.

### <a name="step-1-install-the-update-rollup-2-for-ad-fs-20-package-on-your-ad-fs-servers"></a>Шаг 1: Установка накопительного пакета обновления 2 для служб AD FS 2.0 пакет серверов AD FS

Загрузите [накопительный пакет обновления 2 для служб федерации Active Directory (AD FS) 2.0](https://support.microsoft.com/en-us/help/2681584/description-of-update-rollup-2-for-active-directory-federation-services-ad-fs-2.0) пакет и установить его на всех серверов федерации и прокси-серверов федерации.

### <a name="step-2-add-five-claim-rules-to-the-active-directory-claims-provider-trust"></a>Шаг 2: Добавление пяти правил для утверждений доверия поставщика утверждений Active Directory

После установки накопительного пакета обновления 2 для всех серверов AD FS и прокси-серверов используйте следующую процедуру для добавления в набор правил утверждений, который становится доступным для модуля политики новые типы утверждений.

Для этого будет добавление пять правил преобразования принятия для каждого из новых типов утверждений контекста запрос, используя описанную ниже процедуру.

В отношении доверия поставщика утверждений Active Directory создайте новые правила преобразования принятия передается в каждую из новых типов утверждений контекста запроса.

#### <a name="to-add-a-claim-rule-to-the-active-directory-claims-provider-trust-for-each-of-the-five-context-claim-types"></a>Для добавления правил утверждений в Active Directory доверия с поставщиком утверждений для каждого из пяти контекста типы утверждений:


1. Нажмите кнопку Пуск, выберите программы, Администрирование и нажмите кнопку AD FS 2.0 управления.
2. В дереве консоли в разделе AD FS 2.0\Trust отношения выберите отношения доверия поставщиков утверждений, щелкните правой кнопкой мыши Active Directory и нажмите кнопку Изменение правил для утверждений.
3. В диалоговом окне "Изменение правил для утверждений" выберите вкладку "правила преобразования принятия" и нажмите кнопку Добавить правило, чтобы запустить мастер создания правила.
4. На странице Выбор шаблона правила в разделе шаблон правила утверждения выберите пропуск или Фильтрация входящего утверждения из списка и нажмите кнопку Далее.
5. На странице "Настройка правила" в поле имени правила утверждения введите отображаемое имя для данного правила; в входящий тип утверждения, введите следующий URL-адрес тип утверждения и выберите проход через все значения утверждений.</br>
        `https://schemas.microsoft.com/2012/01/requestcontext/claims/x-ms-forwarded-client-ip`</br>
6. Для проверки правила, выберите его в списке и нажмите кнопку Изменить правило, а затем нажмите кнопку Просмотр языка правила. Язык правил утверждений должен выглядеть следующим образом: `c:[Type == "https://schemas.microsoft.com/2012/01/requestcontext/claims/x-ms-forwarded-client-ip"] => issue(claim = c);`
7. Щелкните "Готово".
8. В диалоговом окне "Изменение правил для утверждений" нажмите кнопку ОК, чтобы сохранить правила.
9. Повторите шаги 2 – 6 для создания дополнительных утверждений правила для каждого типа оставшиеся четыре утверждения, пока не создали все пять правила как показано ниже.

    `https://schemas.microsoft.com/2012/01/requestcontext/claims/x-ms-client-application`


    `https://schemas.microsoft.com/2012/01/requestcontext/claims/x-ms-client-user-agent`

    `https://schemas.microsoft.com/2012/01/requestcontext/claims/x-ms-proxy`

    `https://schemas.microsoft.com/2012/01/requestcontext/claims/x-ms-endpoint-absolute-path`

### <a name="step-3-update-the-microsoft-office-365-identity-platform-relying-party-trust"></a>Шаг 3: Обновление Microsoft Office 365 платформой удостоверений проверяющей стороной доверия

Выберите один из примеров ниже, чтобы настроить правила для утверждений на платформе Microsoft Office 365 идентификаторов проверяющей стороны отношения доверия, который наилучшим образом соответствует потребностям вашей организации.

## <a name="client-access-policy-scenarios-for-ad-fs-20"></a>Сценарии политики доступа клиента для служб AD FS 2.0
В следующих разделах описываются сценарии, которые существуют для AD FS 2.0

### <a name="scenario-1-block-all-external-access-to-office-365"></a>Сценарий 1: Блокировка всех внешний доступ к Office 365

Этот сценарий политики доступа клиента доступ из всех внутренних клиентов и блоки всех внешних клиентов на основе IP-адреса внешнего клиента. Набор правил основывается на правило авторизации выдачи по умолчанию разрешить доступ всем пользователям. Можно использовать следующую процедуру для добавления правила авторизации выдачи на Office 365, проверяющей стороны отношения доверия.

#### <a name="to-create-a-rule-to-block-all-external-access-to-office-365"></a>Чтобы создать правило для блокировки всех внешний доступ к Office 365



1. Нажмите кнопку Пуск, выберите программы, Администрирование и нажмите кнопку AD FS 2.0 управления.
2. В дереве консоли в разделе AD FS 2.0\Trust отношения щелкните доверия с проверяющей стороной, щелкните правой кнопкой мыши доверия платформой удостоверений Microsoft Office 365 и нажмите кнопку Изменение правил для утверждений. 
3. В диалоговом окне "Изменение правил для утверждений" выберите вкладку "правила авторизации выдачи" и нажмите кнопку Добавить правило для запуска мастера правил утверждений.
4. На странице Выбор шаблона правила в разделе шаблон правила утверждения выберите Отправка утверждений с помощью настраиваемого правила и нажмите кнопку Далее.
5. На странице "Настройка правила" в поле имени правила утверждения введите отображаемое имя для данного правила. В разделе настраиваемое правило введите или вставьте следующий синтаксиса языка правил утверждений: `exists([Type == "https://schemas.microsoft.com/2012/01/requestcontext/claims/x-ms-proxy"]) &&
    NOT exists([Type == "https://schemas.microsoft.com/2012/01/requestcontext/claims/x-ms-forwarded-client-ip",
    Value=~"customer-provided public ip address regex"])
    => issue(Type = "https://schemas.microsoft.com/authorization/claims/deny", Value = "true");` 
6. Щелкните "Готово". Убедитесь, что новое правило отображается сразу под разрешить доступ для всех пользователей правила в списке правил авторизации выдачи.
7. Чтобы сохранить правило, в диалоговом окне Изменение правил для утверждений, нажмите кнопку "ОК".

>[!NOTE]
>Вам потребуется заменить значение выше для «общего ip адрес regex» допустимое выражение IP; в разделе Построение выражения диапазона IP адрес Дополнительные сведения.


### <a name="scenario-2-block-all-external-access-to-office-365-except-exchange-activesync"></a>Сценарий 2: Блокировка всех внешний доступ к Office 365, за исключением Exchange ActiveSync

В следующем примере разрешены доступ ко всем приложениям Office 365, включая внутренних клиентов, включая Outlook, Exchange Online. Он блокирует доступ с клиентов, находящихся за пределами корпоративной сети, указываемый IP-адрес клиента, за исключением клиентов Exchange ActiveSync, таких как смартфонов. Набор правил основывается на правило авторизации выдачи по умолчанию, под названием разрешить доступ всем пользователям. Чтобы добавить правило авторизации выдачи на Office 365, проверяющей стороной отношение доверия с помощью мастера правил утверждений, выполните следующие действия:

#### <a name="to-create-a-rule-to-block-all-external-access-to-office-365"></a>Чтобы создать правило для блокировки всех внешний доступ к Office 365



1. Нажмите кнопку Пуск, выберите программы, Администрирование и нажмите кнопку AD FS 2.0 управления.
2. В дереве консоли в разделе AD FS 2.0\Trust отношения щелкните доверия с проверяющей стороной, щелкните правой кнопкой мыши доверия платформой удостоверений Microsoft Office 365 и нажмите кнопку Изменение правил для утверждений. 
3. В диалоговом окне "Изменение правил для утверждений" выберите вкладку "правила авторизации выдачи" и нажмите кнопку Добавить правило для запуска мастера правил утверждений.
4. На странице Выбор шаблона правила в разделе шаблон правила утверждения выберите Отправка утверждений с помощью настраиваемого правила и нажмите кнопку Далее.
5. На странице "Настройка правила" в поле имени правила утверждения введите отображаемое имя для данного правила. В разделе настраиваемое правило введите или вставьте следующий синтаксиса языка правил утверждений: `exists([Type == "https://schemas.microsoft.com/2012/01/requestcontext/claims/x-ms-proxy"]) &&
    NOT exists([Type == "https://schemas.microsoft.com/2012/01/requestcontext/claims/x-ms-client-application",
    Value=="Microsoft.Exchange.Autodiscover"]) &&
    NOT exists([Type == "https://schemas.microsoft.com/2012/01/requestcontext/claims/x-ms-client-application",
    Value=="Microsoft.Exchange.ActiveSync"]) &&
    NOT exists([Type == "https://schemas.microsoft.com/2012/01/requestcontext/claims/x-ms-forwarded-client-ip",
    Value=~"customer-provided public ip address regex"])
    => issue(Type = "https://schemas.microsoft.com/authorization/claims/deny", Value = "true");`
6. Щелкните "Готово". Убедитесь, что новое правило отображается сразу под разрешить доступ для всех пользователей правила в списке правил авторизации выдачи.
7. Чтобы сохранить правило, в диалоговом окне Изменение правил для утверждений, нажмите кнопку "ОК".

>[!NOTE]
>Вам потребуется заменить значение выше для «общего ip адрес regex» допустимое выражение IP; в разделе Построение выражения диапазона IP адрес Дополнительные сведения.

### <a name="scenario-3-block-all-external-access-to-office-365-except-browser-based-applications"></a>Сценарий 3: Блокировка всех внешний доступ к Office 365 за исключением приложений на основе браузера

Набор правил основывается на правило авторизации выдачи по умолчанию, под названием разрешить доступ всем пользователям. Чтобы добавить правило авторизации выдачи на платформе Microsoft Office 365 удостоверение проверяющей стороной отношение доверия с помощью мастера правил утверждений, выполните следующие действия:

>[!NOTE]
>Этот сценарий не поддерживается с прокси-сервера независимого из-за ограничений на заголовки политики доступа клиента с запросами пассивный (веб-).

#### <a name="to-create-a-rule-to-block-all-external-access-to-office-365-except-browser-based-applications"></a>Чтобы создать правило для блокировки всех внешний доступ к Office 365 за исключением приложений на основе браузера



1. Нажмите кнопку Пуск, выберите программы, Администрирование и нажмите кнопку AD FS 2.0 управления.
2. В дереве консоли в разделе AD FS 2.0\Trust отношения щелкните доверия с проверяющей стороной, щелкните правой кнопкой мыши доверия платформой удостоверений Microsoft Office 365 и нажмите кнопку Изменение правил для утверждений. 
3. В диалоговом окне "Изменение правил для утверждений" выберите вкладку "правила авторизации выдачи" и нажмите кнопку Добавить правило для запуска мастера правил утверждений.
4. На странице Выбор шаблона правила в разделе шаблон правила утверждения выберите Отправка утверждений с помощью настраиваемого правила и нажмите кнопку Далее.
5. На странице "Настройка правила" в поле имени правила утверждения введите отображаемое имя для данного правила. В разделе настраиваемое правило введите или вставьте следующий синтаксиса языка правил утверждений: `exists([Type == "https://schemas.microsoft.com/2012/01/requestcontext/claims/x-ms-proxy"]) &&
    NOT exists([Type == "https://schemas.microsoft.com/2012/01/requestcontext/claims/x-ms-forwarded-client-ip",
    Value=~"customer-provided public ip address regex"]) &&
    NOT exists([Type == "https://schemas.microsoft.com/2012/01/requestcontext/claims/x-ms-endpoint-absolute-path", Value == "/adfs/ls/"])
    => issue(Type = "https://schemas.microsoft.com/authorization/claims/deny", Value = "true");`
6. Щелкните "Готово". Убедитесь, что новое правило отображается сразу под разрешить доступ для всех пользователей правила в списке правил авторизации выдачи.
7. Чтобы сохранить правило, в диалоговом окне Изменение правил для утверждений, нажмите кнопку "ОК".

### <a name="scenario-4-block-all-external-access-to-office-365-for-designated-active-directory-groups"></a>Сценарий 4: Блокировка всех внешний доступ к Office 365 для назначенного групп Active Directory

В следующем примере включается доступа внутренних клиентов на основе IP-адреса. Он блокирует доступ с клиентов, находящихся за пределами корпоративной сети, внешний клиент IP-адрес, за исключением тех пользователей, в указанное правило Active Directory том набор строится на правило авторизации выдачи по умолчанию, под названием разрешить доступ всем пользователям. Чтобы добавить правило авторизации выдачи на платформе Microsoft Office 365 удостоверение проверяющей стороной отношение доверия с помощью мастера правил утверждений, выполните следующие действия:

#### <a name="to-create-a-rule-to-block-all-external-access-to-office-365-for-designated-active-directory-groups"></a>Чтобы создать правило для блокировки всех внешний доступ к Office 365 для назначенного групп Active Directory



1. Нажмите кнопку Пуск, выберите программы, Администрирование и нажмите кнопку AD FS 2.0 управления.
2. В дереве консоли в разделе AD FS 2.0\Trust отношения щелкните доверия с проверяющей стороной, щелкните правой кнопкой мыши доверия платформой удостоверений Microsoft Office 365 и нажмите кнопку Изменение правил для утверждений. 
3. В диалоговом окне "Изменение правил для утверждений" выберите вкладку "правила авторизации выдачи" и нажмите кнопку Добавить правило для запуска мастера правил утверждений.
4. На странице Выбор шаблона правила в разделе шаблон правила утверждения выберите Отправка утверждений с помощью настраиваемого правила и нажмите кнопку Далее.
5. На странице "Настройка правила" в поле имени правила утверждения введите отображаемое имя для данного правила. В разделе настраиваемое правило введите или вставьте следующий синтаксиса языка правил утверждений: `exists([Type == "https://schemas.microsoft.com/2012/01/requestcontext/claims/x-ms-proxy"]) &&
    exists([Type == "https://schemas.microsoft.com/ws/2008/06/identity/claims/groupsid", Value =~ "Group SID value of allowed AD group"]) &&
    NOT exists([Type == "https://schemas.microsoft.com/2012/01/requestcontext/claims/x-ms-forwarded-client-ip",
    Value=~"customer-provided public ip address regex"])
    => issue(Type = "https://schemas.microsoft.com/authorization/claims/deny", Value = "true");`
6. Щелкните "Готово". Убедитесь, что новое правило отображается сразу под разрешить доступ для всех пользователей правила в списке правил авторизации выдачи.
7. Чтобы сохранить правило, в диалоговом окне Изменение правил для утверждений, нажмите кнопку "ОК".


### <a name="descriptions-of-the-claim-rule-language-syntax-used-in-the-above-scenarios"></a>Описания синтаксиса языка правил утверждений, используемые в указанных выше сценариев

|Описание|Синтаксис языка правил для утверждений|
|-----|-----| 
|Правило по умолчанию AD FS для разрешить доступ всем пользователям. Это правило должно существовать в платформу Microsoft Office 365 идентификаторов проверяющей стороной доверия список правил авторизации выдачи.|= > проблемы (тип = «https://schemas.microsoft.com/authorization/claims/permit», значение = "true");| 
|Добавление это предложение новые, пользовательские правила указывает, что запрос поступают из прокси-сервера федерации (т. е. он имеет заголовка x-ms прокси)
Что включает все правила, это рекомендуется.|существует ([тип == «https://schemas.microsoft.com/2012/01/requestcontext/claims/x-ms-proxy»])| 
|Использовать для установки, что запрос поступил от клиента с IP-адрес в определенных допустимого диапазона.|НЕ существует ([тип == значение «https://schemas.microsoft.com/2012/01/requestcontext/claims/x-ms-forwarded-client-ip» = ~ «regex клиента общедоступных ip-адрес»])| 
|Это предложение используется для указания, что если приложение выполняется доступ не Microsoft.Exchange.ActiveSync запрос должен быть запрещен.|НЕ существует ([тип == «https://schemas.microsoft.com/2012/01/requestcontext/claims/x-ms-client-application», Value=="Microsoft.Exchange.ActiveSync «])| 
|Это правило позволяет определить, был через веб-браузер на вызов и не будут отклонены.|НЕ существует ([тип == значение «https://schemas.microsoft.com/2012/01/requestcontext/claims/x-ms-endpoint-absolute-path» == "/ adfs/ls или «])| 
|Это правило указано только для пользователей в конкретной группе Active Directory (на основе SID значения) должен быть запрещен. Добавление не оператору означает, что разрешено группы пользователей, независимо от расположения.|существует ([тип == значение «https://schemas.microsoft.com/ws/2008/06/identity/claims/groupsid» = ~ «{группы значение SID группы разрешенных AD} "])| 
|Это предложение, необходимые для выдачи deny при соблюдении всех описанных условиях.|= > проблемы (тип = «https://schemas.microsoft.com/authorization/claims/deny», значение = "true");|

### <a name="building-the-ip-address-range-expression"></a>Построение выражения диапазона адресов IP

Утверждение x-ms пересылаются--IP-адрес клиента заполняется из заголовок HTTP, заданный в настоящий момент только с Exchange Online, который заполняет заголовок при передаче запрос на проверку подлинности в AD FS. Значение утверждения может быть одно из следующих значений:

>[!Note] 
>Exchange Online в настоящее время поддерживает только адреса IPV4 и IPV6 не.

Один IP-адрес: IP-адрес клиента, который был подключен непосредственно к Exchange Online

>[!Note] 
>IP-адрес клиента в корпоративной сети будет отображаться как IP-адрес внешнего интерфейса организации исходящих прокси-сервера или шлюза.

Клиентов, подключенных к корпоративной сети по VPN-Подключение или по Майкрософт DirectAccess (DA) может отображаться как внутренних корпоративных клиентов или внешних клиентов, в зависимости от конфигурации VPN-подключения или DA.

Один или несколько IP-адресов: при Exchange Online, не удается определить IP-адрес подключение клиента, он будет задано значение, на основе значения заголовка x пересылаются для, нестандартные заголовок, который может быть включена в HTTP-запросы и поддерживается многие клиенты подсистемы балансировки нагрузки и прокси-серверов на рынке.

>[!Note]
>Несколько IP-адресов, IP-адрес клиента и адрес каждого прокси-сервера, передавшего запрос, будут разделены запятыми.

IP-адресов, связанных с Exchange Online инфраструктуры не будут отображаться в списке.


#### <a name="regular-expressions"></a>Регулярные выражения

При наличии в соответствии с диапазоном IP-адресов, потребуется создать регулярное выражение, чтобы выполнить сравнение. В следующей последовательности шагов мы предоставим случаи, как создать такое выражение для сопоставления следующие диапазоны адресов (Обратите внимание, что необходимо изменить эти примеры в соответствии с вашей общей диапазон IP-адресов):


- 192.168.1.1 – 192.168.1.25
- 10.0.0.1 – 10.0.0.14

Во-первых, базовый шаблон, который будет соответствовать один IP-адрес выглядит следующим образом: \b###\.###\.###\.###\b

Это расширение, мы может соответствовать две разные IP-адреса с помощью выражения или следующим образом: \b###\.###\.###\.###\b|\b###\.###\.###\.###\b

Таким образом, например для сопоставления только два адреса (например 192.168.1.1 или 10.0.0.1), будет использоваться: \b192\.168\.1\.1\b|\b10\.0\.0\.1\b

Это предоставляет способ, с помощью которого можно ввести любое количество адресов. Там, где нужно диапазона адресов разрешена, например 192.168.1.1 — 192.168.1.25, соответствующим необходимо использовать символ символом: \b192\.168\.1\. ([1-9] | 1 [0 – 9] | [0-5] 2) \b

>[!Note] 
>IP-адрес обрабатывается как строка и не число.


Правило разбито следующим образом: \b192\.168\.1\.

Это соответствует любое значение, начиная с 192.168.1.

Следующие соответствует диапазоны, необходимых для часть адреса после окончательного запятой:


- ([1-9] соответствует адреса оканчивается на 1-9
- | 1 [0 – 9] совпадает с адресами, которые заканчиваются на 10-19
- Адреса совпадений |2[0-5]) завершается в 20 – 25

>[!Note]
>Круглые скобки должен быть правильно установлен, чтобы не запускать соответствия другие составные части IP-адреса.

С этим блоком 192 соответствие, можно написать аналогичные выражение для 10 блока: \b10\.0\.0\. ([1-9] | [0-4] 1) \b

И объединения их, следующее выражение должно соответствовать все адреса «192.168.1.1~25» и «10.0.0.1~14»: \b192\.168\.1\. ([1-9]|1[0-9]|2[0-5])\b|\b10\.0\.0\. ([1-9] | [0-4] 1) \b

#### <a name="testing-the-expression"></a>Тестирование выражение

Выражения регулярных выражений может стать очень сложным, поэтому мы настоятельно рекомендуем использовать средство проверки регулярных выражений. В этом случае поиск в Интернете для «online регулярных выражений построителя», вы увидите несколько хорошо online служебные программы, позволит вам попробовать выражения от демонстрационные данные.

При тестировании выражение, очень важно, что вы понимаете, что ожидать, должны совпадать. Exchange online система может отправлять множество IP-адресов, разделенных запятыми. Для этого будет работать выражения, приведенные выше. Тем не менее важно учитывать это при тестирования регулярных выражений выражения. Например один может использовать следующий пример ввода, чтобы проверить приведенных выше примерах: 

192.168.1.1, 192.168.1.2, 192.169.1.1. 192.168.12.1, 192.168.1.10, 192.168.1.25, 192.168.1.26, 192.168.1.30, 1192.168.1.20 

10.0.0.1, 10.0.0.5, 10.0.0.10, 10.0.1.0, 10.0.1.1, 110.0.0.1, 10.0.0.14, 10.0.0.15, 10.0.0.10, 10,0.0.1 











## <a name="validating-the-deployment"></a>Проверка развертывания

### <a name="security-audit-logs"></a>Журналы аудита безопасности

Чтобы убедиться, что новый контекст запроса утверждения отправляются и доступны для Служб федерации Active Directory утверждений конвейер обработки, включите ведение журнала на сервере AD FS аудита. Отправьте некоторые запросы на проверку подлинности и проверьте наличие значения утверждений в записях журнала аудита стандартные средства обеспечения безопасности. 

Чтобы включить ведение журнала аудита событий безопасности, войти на сервер AD FS, выполните действия в Настройка аудита для служб AD FS 2.0.

### <a name="event-logging"></a>Ведение журнала событий

По умолчанию, невыполненных запросов, записываются в журнал событий приложения, расположенные в разделе журналы приложений и служб \ AD FS 2.0 \ см. Дополнительные сведения о журналах событий для служб AD FS Admin.For [настроить AD FS 2.0 ведение журнала событий](https://technet.microsoft.com/library/adfs2-troubleshooting-configuring-computers.aspx).

### <a name="configuring-verbose-ad-fs-tracing-logs"></a>Настройка Verbose AD FS, журналы трассировки

События трассировки Служб федерации Active Directory записываются в журнал AD FS 2.0 отладки. Чтобы включить трассировку, в разделе [Настройка трассировки отладки для служб AD FS 2.0](https://technet.microsoft.com/en-us/library/adfs2-troubleshooting-configuring-computers.aspx).

После включения трассировки используйте следующий синтаксис командной строки, чтобы включить режим подробного ведения журнала: wevtutil.exe sl «AD FS 2.0 трассировки и отладки» /l:5  

## <a name="related"></a>Связанные с
Дополнительные сведения о новых типах утверждений см [типы утверждений AD FS](AD-FS-Claims-Types.md).
 
