---
ms.assetid: 24c4b9bb-928a-4118-acf1-5eb06c6b08e5
title: "Настройка AD FS 2016 и Azure MFA"
description: 
author: billmath
ms.author: billmath
manager: femila
ms.date: 11/01/2017
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: identity-adfs
ms.openlocfilehash: be8e88ae36f344f1265fb76e66c19e0ac8aeb533
ms.sourcegitcommit: ffdfbb76c7f775e20d089d3f662d4f9a7d642f1e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/05/2018
---
# <a name="configure-ad-fs-2016-and-azure-mfa"></a>Настройка AD FS 2016 и Azure MFA

>Область применения: Windows Server 2016

Если в организации настроена федерация с Azure AD, можно использовать многофакторной идентификации Azure к защищенным ресурсам AD FS, как локально, так и в облаке. Azure MFA позволяет исключить пароли и обеспечивают более безопасный способ проверки подлинности.  Начиная с Windows Server 2016, теперь можно настроить многофакторную проверку Подлинности Azure для основной проверки подлинности. 
  
В отличие от с AD FS в Windows Server 2012 R2, адаптер AD FS 2016 Azure MFA непосредственно с Azure AD, а не требует локальным сервером Azure MFA.   Адаптер Azure MFA встроена в Windows Server 2016 и без необходимости дополнительной установки.

## <a name="registering-users-for-azure-mfa-with-ad-fs-2016"></a>Регистрация пользователей для многофакторной проверки Подлинности Azure с AD FS 2016
Службы федерации Active Directory не поддерживает встроенный «подтверждения вверх» или регистрации данных проверки безопасности Azure MFA, например номер телефона или мобильного приложения. Это означает, что пользователи должны получить подтверждены, посетив https://account.activedirectory.windowsazure.com/Proofup.aspx до использования Azure MFA для проверки подлинности AD FS приложениям. Когда пользователь, который имеет не еще подтверждены копирования в Azure AD пытается пройти проверку подлинности в Azure MFA в AD FS, они будут получать ошибки AD FS.  Как администратор AD FS можно настроить ошибок, чтобы помочь пользователю, на странице корректировки, только вместо.  Вы можете сделать это с помощью настройки onload.js обнаруживать строку сообщения об ошибке в пределах страницы AD FS и Показать новое сообщение, чтобы помочь пользователям посещать https://aka.ms/mfasetup, затем повторите попытку проверки подлинности. Подробные инструкции см. «Настройка AD FS веб-странице руководства по Регистрация методов проверки многофакторной проверки Подлинности пользователей» далее в этой статье.

>[!NOTE]
> Ранее пользователи должны были необходимые для прохождения многофакторной проверки Подлинности для регистрации (посещение https://account.activedirectory.windowsazure.com/Proofup.aspx, например через ярлык aka.ms/mfasetup).  Теперь, пользователь с AD FS, который еще не был зарегистрирован сведения о проверке многофакторной проверки Подлинности можно получить доступ к Azure AD странице корректировки, только через ярлык aka.ms/mfasetup с помощью только основной проверки подлинности (например, встроенная проверка подлинности Windows или имя пользователя и пароля через службы AD FS веб-страницы) .  Если у пользователя есть методы проверки, не настроен, Azure AD выполняет встроенной регистрации, в котором пользователь видит сообщение «Ваш администратор требуется настроить эту учетную запись для дополнительной проверки безопасности», и пользователь может выбрать «Настроить ее теперь».
> Пользователи, уже настроен по крайней мере один метод проверки многофакторной проверки Подлинности будет по-прежнему предложено предоставить многофакторной проверки Подлинности при посещении странице корректировки, только.

### <a name="recommended-deployment-topologies"></a>Топологии развертывания

#### <a name="azure-mfa-as-primary-authentication"></a>Azure MFA в качестве основной проверки подлинности
Существует ряд хорошие причины для использования многофакторной проверки Подлинности Azure в качестве основной проверки подлинности с помощью AD FS.
 - Чтобы избежать пароли для входа в Azure AD, Office 365 и другие приложения AD FS
 - Для защиты пароля на основе вход, требуя дополнительный фактор, например код подтверждения перед пароль

Если вы хотите использовать многофакторную проверку Подлинности Azure в качестве метода основной проверки подлинности в AD FS для достижения этих преимуществ, вы, вероятно, также захотите сохранить возможность использовать Azure AD условного доступа, включая «true многофакторной проверки Подлинности» путем запроса для дополнительных факторов в AD FS.

Теперь это можно сделать, настроив параметр домена Azure AD, чтобы сделать многофакторную проверку Подлинности на локальном компьютере (параметр «SupportsMfa» значение $True).  В этой конфигурации AD FS можно запрос Azure AD для выполнения сценариев условного доступа, которые этого требуют дополнительной проверки подлинности или «true многофакторной проверки Подлинности».  

Как описано выше, любой пользователь AD FS, который еще не зарегистрированных (настроенных многофакторной проверки Подлинности сведения о проверке) следует запрос через настраиваемой страницы ошибки AD FS посетить aka.ms/mfasetup для настройки проверки сведений, затем повторите попытку входа Служб федерации Active Directory.  
Azure MFA как основной рассматривается как один коэффициент, после начальной настройки пользователи должны будут для предоставления дополнительного фактора управления или обновите свои сведения о проверке в Azure AD, или получать доступ к другим ресурсам, которым требуются многофакторной проверки Подлинности.


#### <a name="azure-mfa-as-additional-authentication-to-office-365"></a>Azure MFA в качестве дополнительной проверки подлинности в Office 365
Ранее, если вам хотелось бы иметь Azure MFA как дополнительного метода проверки подлинности в AD FS для Office 365 или других проверяющих сторон, оптимальный вариант для настройки службы Azure AD для комплексной многофакторной проверки Подлинности, в котором основная проверка подлинности выполняется на локальном компьютере в AD FS и многофакторной проверки Подлинности — tr iggered с Azure AD. Теперь можно использовать Azure MFA как дополнительная проверка подлинности в AD FS, при параметр SupportsMfa домена имеет значение $True.  

Как описано выше, любой пользователь AD FS, который еще не зарегистрированных (настроенных многофакторной проверки Подлинности сведения о проверке) следует запрос через настраиваемой страницы ошибки AD FS посетить aka.ms/mfasetup для настройки проверки сведений, затем повторите попытку входа Служб федерации Active Directory.  


## <a name="pre-requisites"></a>Необходимые компоненты  
Следующие необходимые условия являются обязательными при использовании многофакторной проверки Подлинности Azure для проверки подлинности с помощью AD FS:  
  
- [Подписку Azure совместно с Azure Active Directory](https://azure.microsoft.com/pricing/free-trial/).  
- [Многофакторная Идентификация Azure](https://azure.microsoft.com/documentation/articles/multi-factor-authentication/)  

>[!NOTE]   
> Azure AD и Azure MFA, включенных в Azure AD Premium и Enterprise Mobility Suite (EMS).  При наличии любого из этих отдельных подписок необязательно.   
- Windows Server 2016 AD FS локальной среде.  
- Вашей локальной среды [федерация с Azure AD.](https://azure.microsoft.com/documentation/articles/active-directory-aadconnect-get-started-custom/#configuring-federation-with-ad-fs)  
- [Модуль Windows Azure Active Directory для Windows PowerShell](https://go.microsoft.com/fwlink/p/?linkid=236297).  
- Разрешениями глобального администратора в имеющемся экземпляре Azure AD настроить ее с помощью Azure AD для PowerShell.  
- Учетные данные администратора предприятия для настройки фермы AD FS для многофакторной проверки Подлинности Azure.  
  
  
## <a name="configure-the-ad-fs-servers"></a>Настройка серверов AD FS  
Чтобы выполнить настройку для Azure MFA для AD FS, необходимо настроить каждый сервер Служб федерации Active Directory, выполнив действия, описанные. 

>[!NOTE]
>Убедитесь, что эти действия выполняются на **все** серверов AD FS в ферме. При наличии нескольких серверов AD FS в ферме, можно выполнить необходимые настройки, удаленно с помощью Azure AD для Powershell.  
  
  
  
### <a name="step-1-generate-a-certificate-for-azure-mfa-on-each-ad-fs-server-using-the-new-adfsazuremfatenantcertificate-cmdlet"></a>Шаг 1: Создание сертификата для многофакторной проверки Подлинности Azure на каждый сервер Служб федерации Active Directory с помощью `New-AdfsAzureMfaTenantCertificate`командлета.   
Первое, что необходимо сделать это создания сертификата для Azure MFA для использования.  Это можно сделать с помощью PowerShell.  Созданный сертификат можно найти в хранилище сертификатов на локальных компьютерах и помечается с именем субъекта, содержащий TenantID для вашего каталога Azure AD.    
  
![Службы федерации Active Directory и многофакторной проверки Подлинности](media/Configure-AD-FS-2016-and-Azure-MFA/ADFS_AzureMFA3.png)  
  
Обратите внимание, что TenantID имя каталога в Azure AD.  Используйте следующий командлет PowerShell для создания нового сертификата.  
    `$certbase64 = New-AdfsAzureMfaTenantCertificate -TenantID <tenantID>`  
      
![Службы федерации Active Directory и многофакторной проверки Подлинности](media/Configure-AD-FS-2016-and-Azure-MFA/ADFS_AzureMFA1.PNG)  
  
### <a name="step-2-add-the-new-credentials-to-azure-multi-factor-auth-client-spn"></a>Шаг 2: Добавление новых учетных данных для Azure многофакторной проверки подлинности клиента SPN   
Чтобы включить серверов AD FS для связи с клиентом Azure многофакторной проверки подлинности, необходимо добавить учетные данные на имя участника-службы для многофакторной проверки подлинности Azure клиента. Сертификаты, созданные с помощью `New-AdfsAzureMFaTenantCertificate`командлет будет служить эти учетные данные. Выполните следующие действия с помощью PowerShell, чтобы добавить новые учетные данные Azure многофакторной проверки подлинности клиента имя участника-службы.  

>[!NOTE]   
>Для завершения этого шага необходимо подключиться к экземпляру Azure AD с помощью PowerShell, с помощью Connect-MsolService.  Предполагается, что вы уже подключились через PowerShell.  Сведения в разделе [Connect-MsolService.](https://msdn.microsoft.com/library/dn194123.aspx)  
     
  
2. **Установить сертификат как новые учетные данные клиента Azure многофакторной проверки подлинности**  
    
    `New-MsolServicePrincipalCredential -AppPrincipalId 981f26a1-7f43-403b-a875-f8b09b8cd720 -Type asymmetric -Usage verify -Value $certBase64 `

>[!IMPORTANT]
>  Эта команда должна выполняться на всех серверах AD FS в ферме.  На серверах, которые не задать в качестве новых учетных данных от клиента Azure многофакторной проверки подлинности сертификата не удастся многофакторной проверки Подлинности Azure AD. 

>[!NOTE]  
> 981f26a1-7f43-403b-a875-f8b09b8cd720 — идентификатор guid для Azure многофакторной проверки подлинности клиента.  
  
## <a name="configure-the-ad-fs-farm"></a>Настройка фермы AD FS  
  
После завершения предыдущего раздела на каждом сервере Служб федерации Active Directory, необходимо будет запустить `Set-AdfsAzureMfaTenant`командлета.  
  
Этот командлет должен выполняться только один раз для фермы AD FS.  Использование PowerShell для завершения этого шага.    
  
>[!NOTE]  
>Необходимо будет перезапустить службу AD FS на каждом сервере в ферме, чтобы изменения вступили в силу.  
  
    Set-AdfsAzureMfaTenant -TenantId <tenant ID> -ClientId 981f26a1-7f43-403b-a875-f8b09b8cd720  
      
![Службы федерации Active Directory и многофакторной проверки Подлинности](media/Configure-AD-FS-2016-and-Azure-MFA/ADFS_AzureMFA5.png)  
  
После этого вы увидите, что Azure MFA доступен как для интрасети и экстрасети с помощью метода основной проверки подлинности.    
  
![Службы федерации Active Directory и многофакторной проверки Подлинности](media/Configure-AD-FS-2016-and-Azure-MFA/ADFS_AzureMFA6.png)  

## <a name="renew-and-manage-ad-fs-azure-mfa-certificates"></a>Обновлять и управлять AD FS Azure многофакторной проверки Подлинности сертификатов
Следующие рекомендации по переход управлении сертификатами многофакторной проверки Подлинности Azure на серверах Служб федерации Active Directory.
По умолчанию при настройке Служб федерации Active Directory с помощью многофакторной проверки Подлинности Azure, сертификаты, созданного с использованием командлета PowerShell New-AdfsAzureMfaTenantCertificate действительны в течение 2 лет.  Чтобы определить, насколько близко к истечение срока действия сертификатов, затем для обновления и установить новые сертификаты, используйте следующую процедуру.

### <a name="assess-ad-fs-azure-mfa-certificate-expiration-date"></a>Оценка срок действия сертификата многофакторной проверки Подлинности Azure AD FS
На каждом сервере Служб федерации Active Directory, в локальном хранилище My будет самозаверяющий сертификат с» OU = Microsoft AD FS Azure MFA» в субъекта и издателя.  Это сертификат Azure MFA.  Проверьте срок действия этого сертификата на каждом сервере Служб федерации Active Directory, чтобы установить дату окончания срока действия.  

### <a name="create-new-ad-fs-azure-mfa-certificate-on-each-ad-fs-server"></a>Создать новый сертификат многофакторной проверки Подлинности Azure AD FS на каждом сервере Служб федерации Active Directory
Если почти окончания срока действия сертификатов, запустите процесс обновления, создавая новый сертификат многофакторной проверки Подлинности Azure на каждом сервере Служб федерации Active Directory. В окне команд powershell создайте новый сертификат на каждом сервере Служб федерации Active Directory, с помощью следующего командлета:

```
PS C:\> $newcert = New-AdfsAzureMfaTenantCertificate -TenantId <tenant id such as contoso.onmicrosoft.com> -Renew $true
```

В результате этот командлет будет создаваться новый сертификат, действительный с 2 дня в будущем 2 дней + 2 лет.  Операции AD FS и Azure MFA с помощью этого командлета или новый сертификат не повлияет. (Примечание: 2 дневной отсрочкой выводится преднамеренно и дает время для выполните следующие действия, чтобы настроить новый сертификат клиента, перед запуском службы федерации Active Directory, его использование для Azure MFA.)


### <a name="configure-each-new-ad-fs-azure-mfa-certificate-in-the-azure-ad-tenant"></a>Настроить каждый новый сертификат AD FS Azure MFA в клиенте Azure AD
С помощью модуля Azure AD для PowerShell, для каждого нового сертификата (на каждом сервере AD FS) обновите свои параметры Azure AD клиента следующим образом (Примечание: сначала необходимо подключить к клиента с помощью Connect-MsolService для выполнения следующих команд).

```
PS C:/> New-MsolServicePrincipalCredential -AppPrincipalId 981f26a1-7f43-403b-a875-f8b09b8cd720 -Type Asymmetric -Usage Verify -Value $certbase64
```
    Where $certbase64 is the new certificate.  The base64 encoded certificate can be obtained by exporting the certificate (without the private key) as a DER encoded file and opening in Notepad.exe, then copy/pasting to the PSH session and assigning to the variable $certbase64

### <a name="verify-that-the-new-certificates-will-be-used-for-azure-mfa"></a>Убедитесь, что новые сертификаты будут использоваться для Azure MFA
Один раз новых сертификатов становятся действительными, службы федерации Active Directory будет выбирать их и начать использовать каждый из соответствующих сертификатов для многофакторной проверки Подлинности Azure в течение нескольких часов в день.  После этого на каждом сервере, вы увидите события в журнале событий администратор AD FS со следующими сведениями: имя журнала: источник AD FS/Admin: дата AD FS: 2, 27 или 2018 событие с ИД 7:33:31 PM: 547 категории задач: ни один уровень: сведения о ключевых слов : Пользователь AD FS: DOMAIN\adfssvc компьютера: ADFS.domain.contoso.com Описание: сертификат клиента для Azure MFA был обновлен.  

TenantId: contoso.onmicrosoft.com. Старый отпечаток: 7CC103D60967318A11D8C51C289EF85214D9FC63. Старый дату окончания срока действия: 9/15/2019 года 9:43:17 PM. Новый отпечаток: 8110D7415744C9D4D5A4A6309499F7B48B5F3CCF. Новый срок действия: 2, 27/2020 2:16:07: 00.

## <a name="customize-the-ad-fs-web-page-to-guide-users-to-register-mfa-verification-methods"></a>Настройка веб-страницы AD FS для руководства Регистрация методов проверки многофакторной проверки Подлинности пользователей

Используйте следующие примеры, чтобы настроить веб-страниц AD FS для пользователей, которые еще не подтверждены вверх (настраивается в сведения о проверке многофакторной проверки Подлинности).

### <a name="find-the-error"></a>Сообщение об ошибке
Во-первых существует несколько различных сообщений об ошибках, возвращаемых в случае, в которой у пользователя отсутствуют сведения о проверке AD FS.
При использовании многофакторной проверки Подлинности Azure в качестве основной проверки подлинности без proofed пользователь будет видеть страницу ошибки службы федерации Active Directory, содержащий следующие сообщения:
```
    <div id="errorArea"> 
        <div id="openingMessage" class="groupMargin bigText">
            An error occurred 
        </div> 
        <div id="errorMessage" class="groupMargin">
            Authentication attempt failed. Select a different sign in option or close the web browser and sign in again. Contact your administrator for more information. 
        </div>
```
При попытке Azure AD в качестве дополнительной проверки подлинности без proofed пользователь будет видеть страницу ошибки службы федерации Active Directory, содержащий следующие сообщения:
```
<div id='mfaGreetingDescription' class='groupMargin'>For security reasons, we require additional information to verify your account (mahesh@jenfield.net)</div>
    <div id="errorArea"> 
        <div id="openingMessage" class="groupMargin bigText">
            An error occurred 
        </div> 
        <div id="errorMessage" class="groupMargin">
            The selected authentication method is not available for &#39;username@contoso.com&#39;. Choose another authentication method or contact your system administrator for details. 
        </div>
```

### <a name="catch-the-error-and-update-the-page-text"></a>Перехватить ошибку и обновляйте текст страницы
Перехватывать ошибки, отображающую пользователю пользовательского рекомендации — это механизм добавления javascript в конец файла onload.js, который является частью службы федерации Active Directory, веб-тему, чтобы (1) выполните поиск строки идентифицирующие ошибок и (2) предоставляют настраиваемые веб-содержимого.  (См. в статье инструкции в целом о том, как настроить файл onload.js [здесь](https://docs.microsoft.com/en-us/windows-server/identity/ad-fs/operations/advanced-customization-of-ad-fs-sign-in-pages).)

