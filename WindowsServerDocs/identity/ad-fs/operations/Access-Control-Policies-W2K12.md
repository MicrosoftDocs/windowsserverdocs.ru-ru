---
ms.assetid: 5728847d-dcef-4694-9080-d63bfb1fe24b
title: "Политики управления доступом в AD FS"
description: 
author: billmath
ms.author: billmath
manager: femila
ms.date: 05/31/2017
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: identity-adfs
ms.openlocfilehash: 0b4549192bc4dab9edf3b2a10421325144ed0cd2
ms.sourcegitcommit: db290fa07e9d50686667bfba3969e20377548504
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/12/2017
---
# <a name="access-control-policies-in-windows-server-2012-r2-and-windows-server-2012-ad-fs"></a>Политики управления доступом в Windows Server 2012 R2 и Windows Server 2012 AD FS

>Область применения: Windows Server 2012 R2 и Windows Server 2012 

Сделать политик, описанных в этой статье использовать два вида утверждений  
  
1.  Утверждения, создает на основе сведений, прокси-сервера AD FS и веб-приложения могут проверять и проверить, такие как IP-адрес клиента, подключающегося непосредственно к AD FS или WAP AD FS.  
  
2.  Утверждений Служб федерации Active Directory создается на основе сведений, пересланный в AD FS клиентом заголовки HTTP  
  
>**Важные**: политики, как описано ниже будет блокировать присоединения к домену Windows 10 и войти на сценариях, которым требуется доступ к следующих дополнительных конечных точек

Конечные точки AD FS, необходимых для присоединения к домену Windows 10 и входа на
- [имя службы федерации] / служб федерации Active Directory и службы и отношения доверия или 2005 или windowstransport
- [имя службы федерации] / служб федерации Active Directory и службы и отношения доверия или 13/windowstransport
- [имя службы федерации] / служб федерации Active Directory и службы и отношения доверия или 2005 или usernamemixed
- [имя службы федерации] / служб федерации Active Directory и службы и отношения доверия или 13/usernamemixed 
- [имя службы федерации] / служб федерации Active Directory и службы и отношения доверия или 2005 или certificatemixed
- [имя службы федерации] / служб федерации Active Directory и службы и отношения доверия или 13/certificatemixed

Чтобы решить, обновите все политики, которые запрещают на основе утверждений конечной точки, чтобы разрешить исключения для конечных точек, выше.

Например правило ниже:

`c1:[Type == "https://custom/ipoutsiderange", Value == "true"] && c2:[Type == "https://schemas.microsoft.com/2012/01/requestcontext/claims/x-ms-endpoint-absolute-path", Value != "/adfs/ls/"] => issue(Type = "https://schemas.microsoft.com/authorization/claims/deny", Value = " DenyUsersWithClaim");`  

будет обновить, чтобы:

`c1:[Type == "https://custom/ipoutsiderange", Value == "true"] && c2:[Type == "https://schemas.microsoft.com/2012/01/requestcontext/claims/x-ms-endpoint-absolute-path", Value != "(/adfs/ls/)|(/adfs/services/trust/2005/windowstransport)|(/adfs/services/trust/13/windowstransport)|(/adfs/services/trust/2005/usernamemixed)|(/adfs/services/trust/13/usernamemixed)|(/adfs/services/trust/2005/certificatemixed)|(/adfs/services/trust/13/certificatemixed)"] => issue(Type = "https://schemas.microsoft.com/authorization/claims/deny", Value = " DenyUsersWithClaim");`



> [!NOTE]
>  Утверждения из этой категории можно использовать только для реализации бизнес-политик, а не политик безопасности для защиты доступа к сети.  Это несанкционированного клиенты могут отправлять заголовки с ложные сведения, чтобы получить доступ.  
  
Политики, описанные в этой статье, всегда можно использовать в другой метод проверки подлинности, такие как имя пользователя и пароль или несколькими фактор проверки подлинности.  
  
## <a name="client-access-policies-scenarios"></a>Сценарии политик клиентского доступа  
  
|**Сценарий**|**Описание**| 
| --- | --- | 
|Сценарий 1: Блокировка всех внешний доступ к Office 365|Office 365 доступ из всех клиентов во внутренней корпоративной сети, но запрещен на основе IP-адреса внешних клиентских запросов от внешних клиентов.|  
|Сценарий 2: Блокировка всех внешний доступ к Office 365, за исключением Exchange ActiveSync|Office 365 доступ из всех клиентов во внутренней корпоративной сети, а также из любого внешних клиентских устройств, например смарт-телефонов, которые используют Exchange ActiveSync. Все другие внешних клиентов, например с помощью Outlook, блокируются.|  
|Сценарий 3: Блокировка всех внешний доступ к Office 365 за исключением приложений на основе браузера|Блоки внешний доступ к Office 365, за исключением пассивный приложений (на основе браузера), такие как Outlook Web Access или SharePoint Online.|  
|Сценарий 4: Блокировка всех внешний доступ к Office 365 за исключением назначенного групп Active Directory|Этот сценарий используется для тестирования и проверки развертывания политики доступа клиента. Он блокирует внешний доступ к Office 365 только для членов группы Active Directory один или несколько. Его можно использовать для предоставления внешний доступ только для членов группы.|  
  
## <a name="enabling-client-access-policy"></a>Включение политики доступа клиента  
 Чтобы включить политику доступа клиента в AD FS в Windows Server 2012 R2, необходимо обновить платформу Microsoft Office 365 идентификаторов проверяющей стороны отношения доверия. Выберите один из ниже, чтобы настроить правила для утверждений на сценариях-примерах **платформой удостоверений Microsoft Office 365** доверия проверяющей стороной, что наилучшим образом соответствует потребностям вашей организации.  
  
###  <a name="scenario1"></a>Сценарий 1: Блокировка всех внешний доступ к Office 365  
 Этот сценарий политики доступа клиента доступ из всех внутренних клиентов и блоки всех внешних клиентов на основе IP-адреса внешнего клиента. Добавить правильный правила авторизации выдачи в Office 365, проверяющей стороной доверия для выбранного сценария можно использовать следующие процедуры.  
  
##### <a name="to-create-rules-to-block-all-external-access-to-office-365"></a>Чтобы создать правила, блокирующие все внешний доступ к Office 365  
  
1.  Из **диспетчера сервера**, нажмите кнопку **средства**, нажмите кнопку **управления AD FS**.  
  
2.  В дереве консоли в разделе **AD fs\отношения доверия отношения**, нажмите кнопку **доверия с проверяющей стороной**, щелкните правой кнопкой мыши **платформой удостоверений Microsoft Office 365** доверия, а затем нажмите кнопку **изменение правил для утверждений**.  
  
3.  В **изменение правил для утверждений** выберите **правила авторизации выдачи**, а затем щелкните **добавить правило** запуск мастера правил утверждений.  
  
4.  На **Выбор шаблона правила** в разделе **шаблон правила утверждения**выберите **Отправка утверждений с помощью настраиваемого правила**, а затем нажмите кнопку **Далее**.  
  
5.  На **Настройка правила** в разделе **имя правила утверждений**, введите отображаемое имя для данного правила, например «при возмещении IP за пределами необходимом диапазоне запрещенных». В разделе **настраиваемого правила**введите или вставьте следующий синтаксиса языка правил утверждений (замените значение выше «x-ms пересылаются--IP-адрес клиента» с допустимое выражение IP):  
`c1:[Type == " https://schemas.microsoft.com/ws/2012/01/insidecorporatenetwork", Value == "false"] && c2:[Type == "https://schemas.microsoft.com/2012/01/requestcontext/claims/x-ms-forwarded-client-ip", Value =~ "^(?!192\.168\.1\.77|10\.83\.118\.23)"] => issue(Type = "https://schemas.microsoft.com/authorization/claims/deny", Value = " DenyUsersWithClaim");` </br>
6.  Нажмите кнопку **Готово **. Убедитесь, что новое правило отображается в списке правил авторизации выдачи перед по умолчанию **разрешить доступ всем пользователям** правило (правило отказа будут иметь приоритет, несмотря на то, что он отображается в списке ранее).  Если у вас разрешить правило доступа по умолчанию, вы можете добавить в конце списка, с помощью языка правил утверждений следующим образом:  </br>
    
    `c:[] => issue(Type = "https://schemas.microsoft.com/authorization/claims/permit", Value = "true"); ` 

7.  Чтобы сохранить новые правила в **изменение правил для утверждений** диалоговом нажмите кнопку **ОК**. Полученный список должен выглядеть следующим образом.  
  
     ![Правила авторизации выдачи](media/Access-Control-Policies-W2K12/clientaccess1.png "ADFS_Client_Access_1")  
  
###  <a name="scenario2"></a>Сценарий 2: Блокировка всех внешний доступ к Office 365, за исключением Exchange ActiveSync  
 В следующем примере разрешены доступ ко всем приложениям Office 365, включая внутренних клиентов, включая Outlook, Exchange Online. Он блокирует доступ с клиентов, находящихся за пределами корпоративной сети, указываемый IP-адрес клиента, за исключением клиентов Exchange ActiveSync, таких как смартфонов.  
  
##### <a name="to-create-rules-to-block-all-external-access-to-office-365-except-exchange-activesync"></a>Чтобы создать правила, блокирующие все внешний доступ к Office 365, за исключением Exchange ActiveSync  
  
1.  Из **диспетчера сервера**, нажмите кнопку **средства**, нажмите кнопку **управления AD FS**.  
  
2.  В дереве консоли в разделе **AD fs\отношения доверия отношения**, нажмите кнопку **доверия с проверяющей стороной**, щелкните правой кнопкой мыши **платформой удостоверений Microsoft Office 365** доверия, а затем нажмите кнопку **изменение правил для утверждений**.  
  
3.  В **изменение правил для утверждений** выберите **правила авторизации выдачи**, а затем щелкните **добавить правило** запуск мастера правил утверждений.  
  
4.  На **Выбор шаблона правила** в разделе **шаблон правила утверждения**выберите **Отправка утверждений с помощью настраиваемого правила**, а затем нажмите кнопку **Далее**.  
  
5.  На **Настройка правила** в разделе **имя правила утверждений**, пример» при возмещении IP за пределами необходимом диапазоне выдачи утверждений ipoutsiderange» введите отображаемое имя для данного правила. В разделе **настраиваемого правила**введите или вставьте следующий синтаксиса языка правил утверждений (замените значение выше «x-ms пересылаются--IP-адрес клиента» с допустимое выражение IP):  
    
    `c1:[Type == " https://schemas.microsoft.com/ws/2012/01/insidecorporatenetwork", Value == "false"] && c2:[Type == "https://schemas.microsoft.com/2012/01/requestcontext/claims/x-ms-forwarded-client-ip", Value =~ "^(?!192\.168\.1\.77|10\.83\.118\.23)"] => issue(Type = "http://custom/ipoutsiderange", Value = "true");`  

6.  Нажмите кнопку **Готово **. Убедитесь, что новое правило отображается в **правила авторизации выдачи** списка.  
  
7.  Затем в **изменение правил для утверждений** диалогового **правила авторизации выдачи** щелкните **добавить правило** снова запуск мастера правил утверждений.  
  
8.  На **Выбор шаблона правила** в разделе **шаблон правила утверждения**выберите **Отправка утверждений с помощью настраиваемого правила**, а затем нажмите кнопку **Далее**.  
  
9. На **Настройка правила** в разделе **имя правила утверждений**, введите отображаемое имя для данного правила, например «если имеется IP-адрес за пределами необходимом диапазоне, а не EAS утверждения x-ms клиентского приложения, запрещенных». В разделе **настраиваемого правила**введите или вставьте следующий синтаксиса языка правил утверждений:  
  

    `c1:[Type == "https://custom/ipoutsiderange", Value == "true"] && c2:[Type == "https://schemas.microsoft.com/2012/01/requestcontext/claims/x-ms-client-application", Value != "Microsoft.Exchange.ActiveSync"] => issue(Type = "https://schemas.microsoft.com/authorization/claims/deny", Value = "DenyUsersWithClaim");`  
  
10. Нажмите кнопку **Готово **. Убедитесь, что новое правило отображается в **правила авторизации выдачи** списка.  
  
11. Затем в **изменение правил для утверждений** диалогового **правила авторизации выдачи** щелкните **добавить правило** снова запуск мастера правил утверждений.  
  
12. На **Выбор шаблона правила** в разделе **шаблон правила утверждения,** выберите **Отправка утверждений с помощью настраиваемого правила**, а затем нажмите кнопку **Далее**.  
  
13. На **Настройка правила** в разделе **имя правила утверждений**введите отображаемое имя для данного правила, например «проверка существования приложения утверждения». В разделе **настраиваемого правила**введите или вставьте следующий синтаксиса языка правил утверждений:  
  
    ```  
    NOT EXISTS([Type == "https://schemas.microsoft.com/2012/01/requestcontext/claims/x-ms-client-application"]) => add(Type = "http://custom/xmsapplication", Value = "fail");  
    ```  
  
14. Нажмите кнопку **Готово **. Убедитесь, что новое правило отображается в **правила авторизации выдачи** списка.  
  
15. Затем в **изменение правил для утверждений** диалогового **правила авторизации выдачи** щелкните **добавить правило** снова запуск мастера правил утверждений.  
  
16. На **Выбор шаблона правила** в разделе **шаблон правила утверждения,** выберите **Отправка утверждений с помощью настраиваемого правила**, а затем нажмите кнопку **Далее**.  
  
17. На **Настройка правила** в разделе **имя правила утверждений**введите отображаемое имя для данного правила, например «запрещенных ошибкой ipoutsiderange true и приложения». В разделе **настраиваемого правила**введите или вставьте следующий синтаксиса языка правил утверждений:  
  
`c1:[Type == "https://custom/ipoutsiderange", Value == "true"] && c2:[Type == "https://custom/xmsapplication", Value == "fail"] => issue(Type = "https://schemas.microsoft.com/authorization/claims/deny", Value = "DenyUsersWithClaim");`</br>  
18. Нажмите кнопку **Готово **. Убедитесь, что новое правило отображается сразу под предыдущее правило, а перед правил по умолчанию разрешить доступ всем пользователям в списке правил авторизации выдачи (правило отказа будут иметь приоритет, несмотря на то, что он отображается в списке ранее).  </br>Если у вас разрешить правило доступа по умолчанию, вы можете добавить в конце списка, с помощью языка правил утверждений следующим образом:</br></br>      `c:[] => issue(Type = "https://schemas.microsoft.com/authorization/claims/permit", Value = "true");`</br></br>
19. Чтобы сохранить новые правила в **изменение правил для утверждений** диалогового окна нажмите кнопку ОК. Полученный список должен выглядеть следующим образом.  
  
     ![Правила авторизации выдачи](media/Access-Control-Policies-W2K12/clientaccess2.png )  
  
###  <a name="scenario3"></a>Сценарий 3: Блокировка всех внешний доступ к Office 365 за исключением приложений на основе браузера  
  
##### <a name="to-create-rules-to-block-all-external-access-to-office-365-except-browser-based-applications"></a>Чтобы создать правила, блокирующие все внешний доступ к Office 365 за исключением приложений на основе браузера  
  
1.  Из **диспетчера сервера**, нажмите кнопку **средства**, нажмите кнопку **управления AD FS**.  
  
2.  В дереве консоли в разделе **AD fs\отношения доверия отношения**, нажмите кнопку **доверия с проверяющей стороной**, щелкните правой кнопкой мыши **платформой удостоверений Microsoft Office 365** доверия, а затем нажмите кнопку **изменение правил для утверждений**.  
  
3.  В **изменение правил для утверждений** выберите **правила авторизации выдачи**, а затем щелкните **добавить правило** запуск мастера правил утверждений.  
  
4.  На **Выбор шаблона правила** в разделе **шаблон правила утверждения**выберите **Отправка утверждений с помощью настраиваемого правила**, а затем нажмите кнопку **Далее**.  
  
5.  На **Настройка правила** в разделе **имя правила утверждений**, пример» при возмещении IP за пределами необходимом диапазоне выдачи утверждений ipoutsiderange» введите отображаемое имя для данного правила. В разделе **настраиваемого правила**введите или вставьте следующий синтаксиса языка правил утверждений (замените значение выше «x-ms пересылаются--IP-адрес клиента» с допустимое выражение IP):  </br>
`c1:[Type == "https://schemas.microsoft.com/ws/2012/01/insidecorporatenetwork", Value == "false"] && c2:[Type == "https://schemas.microsoft.com/2012/01/requestcontext/claims/x-ms-forwarded-client-ip", Value =~ "^(?!192\.168\.1\.77|10\.83\.118\.23)"] => issue(Type = "http://custom/ipoutsiderange", Value = "true");`   
6.  Нажмите кнопку **Готово **. Убедитесь, что новое правило отображается в **правила авторизации выдачи** списка.  
  
7.  Затем в **изменение правил для утверждений** диалогового **правила авторизации выдачи** щелкните **добавить правило** снова запуск мастера правил утверждений.  
  
8.  На **Выбор шаблона правила** в разделе **шаблон правила утверждения,** выберите **Отправка утверждений с помощью настраиваемого правила**, а затем нажмите кнопку **Далее**.  
  
9. На **Настройка правила** в разделе **имя правила утверждений**, введите отображаемое имя для данного правила, например «если IP-адрес за пределами необходимом диапазоне, а конечная точка не/adfs/ls, запрещенных». В разделе **настраиваемого правила**введите или вставьте следующий синтаксиса языка правил утверждений:  
  
 
    `c1:[Type == "https://custom/ipoutsiderange", Value == "true"] && c2:[Type == "https://schemas.microsoft.com/2012/01/requestcontext/claims/x-ms-endpoint-absolute-path", Value != "/adfs/ls/"] => issue(Type = "https://schemas.microsoft.com/authorization/claims/deny", Value = " DenyUsersWithClaim");`  
  
10. Нажмите кнопку **Готово **. Убедитесь, что новое правило отображается в списке правил авторизации выдачи перед по умолчанию **разрешить доступ всем пользователям** правило (правило отказа будут иметь приоритет, несмотря на то, что он отображается в списке ранее).  </br></br> Если у вас разрешить правило доступа по умолчанию, вы можете добавить в конце списка, с помощью языка правил утверждений следующим образом:  
  
    `c:[] => issue(Type = "https://schemas.microsoft.com/authorization/claims/permit", Value = "true");`
  
11. Чтобы сохранить новые правила в **изменение правил для утверждений** диалоговом нажмите кнопку **ОК**. Полученный список должен выглядеть следующим образом.  
  
     ![Выдачи](media/Access-Control-Policies-W2K12/clientaccess3.png)  
  
###  <a name="scenario4"></a>Сценарий 4: Блокировка всех внешний доступ к Office 365 за исключением назначенного групп Active Directory  
 В следующем примере включается доступа внутренних клиентов на основе IP-адреса. Он блокирует доступ с клиентов, находящихся за пределами корпоративной сети, внешний клиент IP-адрес, за исключением тех пользователей, в указанном Active Directory Group.Use следующие шаги, чтобы добавить правильное правил авторизации выдачи **платформой удостоверений Microsoft Office 365** с помощью мастера правил утверждений доверия с проверяющей стороной:  
  
##### <a name="to-create-rules-to-block-all-external-access-to-office-365-except-for-designated-active-directory-groups"></a>Чтобы создать правила, блокирующие все внешний доступ к Office 365, за исключением указанных групп Active Directory  
  
1.  Из **диспетчера сервера**, нажмите кнопку **средства**, нажмите кнопку **управления AD FS**.  
  
2.  В дереве консоли в разделе **AD fs\отношения доверия отношения**, нажмите кнопку **доверия с проверяющей стороной**, щелкните правой кнопкой мыши **платформой удостоверений Microsoft Office 365** доверия, а затем нажмите кнопку **изменение правил для утверждений**.  
  
3.  В **изменение правил для утверждений** выберите **правила авторизации выдачи**, а затем щелкните **добавить правило** запуск мастера правил утверждений.  
  
4.  На **Выбор шаблона правила** в разделе **шаблон правила утверждения**выберите **Отправка утверждений с помощью настраиваемого правила**, а затем нажмите кнопку **Далее**.  
  
5.  На **Настройка правила** в разделе **имя правила утверждений**, введите отображаемое имя для данного правила примере» при возмещении IP за пределами необходимом диапазоне ipoutsiderange утверждение выдается.» В разделе **настраиваемого правила**введите или вставьте следующий синтаксиса языка правил утверждений (замените значение выше «x-ms пересылаются--IP-адрес клиента» с допустимое выражение IP):  
  
      
    `c1:[Type == "https://schemas.microsoft.com/2012/01/requestcontext/claims/x-ms-forwarded-client-ip", Value =~ "^(?!192\.168\.1\.77|10\.83\.118\.23)"] && c2:[Type == "https://schemas.microsoft.com/ws/2012/01/insidecorporatenetwork", Value == "false"] => issue(Type = "http://custom/ipoutsiderange", Value = "true");`  

6.  Нажмите кнопку **Готово **. Убедитесь, что новое правило отображается в **правила авторизации выдачи** списка.  
  
7.  Затем в **изменение правил для утверждений** диалогового **правила авторизации выдачи** щелкните **добавить правило** снова запуск мастера правил утверждений.  
  
8.  На **Выбор шаблона правила** в разделе **шаблон правила утверждения,** выберите **Отправка утверждений с помощью настраиваемого правила**, а затем нажмите кнопку **Далее**.  
  
9. На **Настройка правила** в разделе **имя правила утверждений**введите отображаемое имя для данного правила, например «проверка SID группы». В разделе **настраиваемого правила**введите или вставьте следующий синтаксиса языка правил утверждений (Замените текст «groupsid» с фактическим SID группы AD, вы используете):  
   
    `NOT EXISTS([Type == "https://schemas.microsoft.com/ws/2008/06/identity/claims/groupsid", Value == "S-1-5-32-100"]) => add(Type = "http://custom/groupsid", Value = "fail");`  

10. Нажмите кнопку **Готово **. Убедитесь, что новое правило отображается в **правила авторизации выдачи** списка.  
  
11. Затем в **изменение правил для утверждений** диалогового **правила авторизации выдачи** щелкните **добавить правило** снова запуск мастера правил утверждений.  
  
12. На **Выбор шаблона правила** в разделе **шаблон правила утверждения,** выберите **Отправка утверждений с помощью настраиваемого правила**, а затем нажмите кнопку **Далее**.  
  
13. На **Настройка правила** в разделе **имя правила утверждений**введите отображаемое имя для данного правила, например «запрещать пользователям на ipoutsiderange true и groupsid сбой». В разделе **настраиваемого правила**введите или вставьте следующий синтаксиса языка правил утверждений:  
   
    `c1:[Type == "https://custom/ipoutsiderange", Value == "true"] && c2:[Type == "https://custom/groupsid", Value == "fail"] => issue(Type = "https://schemas.microsoft.com/authorization/claims/deny", Value = "DenyUsersWithClaim");`  

14. Нажмите кнопку **Готово **. Убедитесь, что новое правило отображается сразу под предыдущее правило, а перед правил по умолчанию разрешить доступ всем пользователям в списке правил авторизации выдачи (правило отказа будут иметь приоритет, несмотря на то, что он отображается в списке ранее).  </br></br>Если у вас разрешить правило доступа по умолчанию, вы можете добавить в конце списка, с помощью языка правил утверждений следующим образом:  
   
    `c:[] => issue(Type = "https://schemas.microsoft.com/authorization/claims/permit", Value = "true");`  

15. Чтобы сохранить новые правила в **изменение правил для утверждений** диалогового окна нажмите кнопку ОК. Полученный список должен выглядеть следующим образом.  
  
     ![Выдачи](media/Access-Control-Policies-W2K12/clientaccess4.png)  
  
##  <a name="buildingip"></a>Построение выражения диапазона адресов IP  
 Утверждение x-ms пересылаются--IP-адрес клиента заполняется из заголовок HTTP, заданный в настоящий момент только с Exchange Online, который заполняет заголовок при передаче запрос на проверку подлинности в AD FS. Значение утверждения может быть одно из следующих значений:  
  
> [!NOTE]
>  Exchange Online в настоящее время поддерживает только адреса IPV4 и IPV6 не.  
  
-   Один IP-адрес: IP-адрес клиента, который был подключен непосредственно к Exchange Online  
  
> [!NOTE]
>  -   IP-адрес клиента в корпоративной сети будет отображаться как IP-адрес внешнего интерфейса организации исходящих прокси-сервера или шлюза.  
> -   Клиентов, подключенных к корпоративной сети по VPN-Подключение или по Майкрософт DirectAccess (DA) может отображаться как внутренних корпоративных клиентов или внешних клиентов, в зависимости от конфигурации VPN-подключения или DA.  
  
-   Один или несколько IP-адресов: при Exchange Online, не удается определить IP-адрес подключение клиента, он будет задано значение, на основе значения заголовка x пересылаются для, нестандартные заголовок, который может быть включена в HTTP-запросы и поддерживается многие клиенты подсистемы балансировки нагрузки и прокси-серверов на рынке.  
  
> [!NOTE]
>  1.  Несколько IP-адресов, IP-адрес клиента и адрес каждого прокси-сервера, передавшего запрос, будут разделены запятыми.  
> 2.  IP-адресов, связанных с Exchange Online инфраструктуры будет отсутствует в списке.  
  
### <a name="regular-expressions"></a>Регулярные выражения  
 При наличии в соответствии с диапазоном IP-адресов, потребуется создать регулярное выражение, чтобы выполнить сравнение. В следующей последовательности шагов мы предоставим случаи, как создать такое выражение для сопоставления следующие диапазоны адресов (Обратите внимание, что необходимо изменить эти примеры в соответствии с вашей общей диапазон IP-адресов):  
  
-   192.168.1.1 – 192.168.1.25  
  
-   10.0.0.1 – 10.0.0.14  
  
 Во-первых, базовый шаблон, который будет соответствовать один IP-адрес выглядит следующим образом: \b###\\.###\\.###\\.###\b  
  
 Это расширение, мы может соответствовать две разные IP-адреса с помощью выражения или следующим образом: \b###\\.###\\.###\\.###\b & #124;\b###\\.###\\.###\\.###\b  
  
 Таким образом, например для сопоставления только два адреса (например 192.168.1.1 или 10.0.0.1), будет использоваться: \b192\\.168\\.1\\.1\b & #124;\b10\\.0\\.0\\.1\b  
  
 Это предоставляет способ, с помощью которого можно ввести любое количество адресов. Там, где нужно диапазона адресов разрешено, например 192.168.1.1 — 192.168.1.25, соответствующим необходимо использовать символ символом: \b192\\.168\\.1\\. ([1-9] & #124; 1 [0 – 9] & #124; 2 [0-5]) \b  
  
 Обратите внимание на следующее:  
  
-   IP-адрес обрабатывается как строка и не число.  
  
-   Правило разбито следующим образом: \b192\\.168\\.1\\.  
  
-   Это соответствует любое значение, начиная с 192.168.1.  
  
-   Следующие соответствует диапазоны, необходимых для часть адреса после окончательного запятой:  
  
    -   ([1-9] соответствует адреса оканчивается на 1-9  
  
    -   & #124; 1 [0 – 9] совпадает с адресами, которые заканчиваются на 10-19  
  
    -   & адреса совпадений #124;2[0-5]) завершается в 20 – 25  
  
-   Обратите внимание, что скобки должен быть установлен правильно, чтобы не запускать соответствия другие составные части IP-адреса.  
  
-   С этим блоком 192 соответствие, можно написать аналогичные выражение для 10 блока: \b10\\.0\\.0\\. ([1-9] & #124; 1 [0-4]) \b  
  
-   И объединения их, следующее выражение должно соответствовать все адреса «192.168.1.1~25» и «10.0.0.1~14»: \b192\\.168\\.1\\. ([1-9] & #124; 1 [0 – 9] & #124; 2 [0-5]) \b & #124;\b10\\.0\\.0\\. ([1-9] & #124; 1 [0-4]) \b  
  
### <a name="testing-the-expression"></a>Тестирование выражение  
 Выражения регулярных выражений может стать очень сложным, поэтому мы настоятельно рекомендуем использовать средство проверки регулярных выражений. В этом случае поиск в Интернете для «online регулярных выражений построителя», вы увидите несколько хорошо online служебные программы, позволит вам попробовать выражения от демонстрационные данные.  
  
 При тестировании выражение, очень важно, что вы понимаете, что ожидать, должны совпадать. Exchange online система может отправлять множество IP-адресов, разделенных запятыми. Для этого будет работать выражения, приведенные выше. Тем не менее важно учитывать это при тестирования регулярных выражений выражения. Например один может использовать следующий пример ввода, чтобы проверить приведенных выше примерах:  
  
 192.168.1.1, 192.168.1.2, 192.169.1.1. 192.168.12.1, 192.168.1.10, 192.168.1.25, 192.168.1.26, 192.168.1.30, 1192.168.1.20  
  
 10.0.0.1, 10.0.0.5, 10.0.0.10, 10.0.1.0, 10.0.1.1, 110.0.0.1, 10.0.0.14, 10.0.0.15, 10.0.0.10, 10,0.0.1  
  
## <a name="claim-types"></a>Типы утверждений  
 AD FS в Windows Server 2012 R2 предоставляет сведения о контексте запрос, используя следующие типы утверждений:  
  
### <a name="x-ms-forwarded-client-ip"></a>X-MS-пересылаются--IP-адрес клиента  
 Тип утверждения: `https://schemas.microsoft.com/2012/01/requestcontext/claims/x-ms-forwarded-client-ip`  
  
 Это утверждение AD FS представляет это «лучший попытка «Проверка IP-адрес пользователя (например, клиент Outlook) процесс создания запроса. Это утверждение может содержать несколько IP-адресов, включая адрес каждого прокси-сервер, на который перенаправляется запрос.  Это утверждение заполняется из HTTP. Значение утверждения может быть одно из следующих значений:  
  
-   Один IP-адрес — IP-адрес клиента, который был подключен непосредственно к Exchange Online  
  
> [!NOTE]
>  IP-адрес клиента в корпоративной сети будет отображаться как IP-адрес внешнего интерфейса организации исходящих прокси-сервера или шлюза.  
  
-   Один или несколько IP-адресов  
  
    -   Если Exchange Online не удается определить IP-адрес подключение клиента, он будет значение на основе значения заголовка x пересылаются для нестандартных заголовок, который может быть включена в HTTP на основе запросов и поддерживается многие клиенты подсистемы балансировки нагрузки и прокси-серверов на рынке.  
  
    -   Несколько IP-адресов, IP-адрес клиента и адрес каждого прокси-сервера, передавшего запрос будет содержать запятую.  
  
> [!NOTE]
>  IP-адресов, связанных с Exchange Online инфраструктуры не будет присутствовать в списке.  
  
> [!WARNING]
>  Exchange Online в настоящее время поддерживает только IPV4-адресов; он не поддерживает IPV6-адресов.  
  
### <a name="x-ms-client-application"></a>X-MS-клиентского приложения  
 Тип утверждения: `https://schemas.microsoft.com/2012/01/requestcontext/claims/x-ms-client-application`  
  
 Это утверждение AD FS представляет протокол, используемый клиентом end, который соответствует слабо используемого приложения.  Это утверждение заполняется из заголовка HTTP, в настоящее время настроить только с Exchange Online, который заполняет заголовок при передаче запрос на проверку подлинности в AD FS. В зависимости от приложения значение это утверждение будет иметь одно из следующих:  
  
-   В случае устройств, использующих Exchange Active Sync значение равно Microsoft.Exchange.ActiveSync.  
  
-   Использование клиентом Microsoft Outlook может привести к любым из следующих значений:  
  
    -   Microsoft.Exchange.Autodiscover  
  
    -   Microsoft.Exchange.OfflineAddressBook  
  
    -   Microsoft.Exchange.RPCMicrosoft.Exchange.WebServices  
  
    -   Microsoft.Exchange.RPCMicrosoft.Exchange.WebServices  
  
-   Другие возможные значения для этого заголовка включают следующие:  
  
    -   Microsoft.Exchange.Powershell  
  
    -   Microsoft.Exchange.SMTP  
  
    -   Microsoft.Exchange.Pop  
  
    -   Microsoft.Exchange.Imap  
  
### <a name="x-ms-client-user-agent"></a>X-MS-клиент — агент пользователя  
 Тип утверждения: `https://schemas.microsoft.com/2012/01/requestcontext/claims/x-ms-client-user-agent`  
  
 Это утверждение AD FS предоставляет строку для представления тип устройства, используемый клиентом для доступа к службе. Может использоваться, когда пользователям требуется запретить доступ для определенных устройств (например, определенные типы смартфонов).  Примеры значений для это утверждение включают (но не ограничиваются) ниже значения.  
  
 Ниже приведены примеры значение x-ms агента пользователя могут содержать для клиента, которого x-ms клиентского приложения — «Microsoft.Exchange.ActiveSync»  
  
-   Vortex/1.0  
  
-   Apple iPad1C1 812.1 или  
  
-   Apple iPhone3C1 811.2 или  
  
-   Apple iPhone 704.11 или  
  
-   Moto-DROID2/4.5.1  
  
-   SAMSUNGSPHD700 ИЛИ 100.202  
  
-   Android и 0,3  
  
 Это также возможно, это значение является пустым.  
  
### <a name="x-ms-proxy"></a>X-MS-прокси  
 Тип утверждения: `https://schemas.microsoft.com/2012/01/requestcontext/claims/x-ms-proxy`  
  
 Это утверждение AD FS означает, что запрос прошло через прокси-сервер веб-приложения.  Это утверждение заполняется прокси веб-приложения, который заполняет заголовок при передаче запрос на проверку подлинности в серверной части службы федерации. AD FS затем преобразует его утверждения.  
  
 Значение утверждения является DNS-имя прокси-сервера веб-приложения, передавшего запрос.  
  
### <a name="insidecorporatenetwork"></a>InsideCorporateNetwork  
 Тип утверждения: `https://schemas.microsoft.com/ws/2012/01/insidecorporatenetwork`  
  
 Тип утверждения аналогична выше x-ms прокси, этот тип утверждения указывает, прошло ли запрос через прокси веб-приложения. В отличие от x-ms прокси insidecorporatenetwork возвращается логическое значение, с помощью значение True, указывающее, запрос непосредственно в службу федерации в корпоративной сети.  
  
### <a name="x-ms-endpoint-absolute-path-active-vs-passive"></a>X-MS--абсолютное-путь к конечной точке (пассивный Active vs)  
 Тип утверждения: `https://schemas.microsoft.com/2012/01/requestcontext/claims/x-ms-endpoint-absolute-path`  
  
 Этот тип утверждения можно использовать для определения запросов, исходящих от клиентов с «активным» (расширенными возможностями) и «пассивных» клиентов (веб-на основе браузера). Это позволяет внешних запросов из приложений на основе браузера, например Outlook Web Access, SharePoint Online или на портал Office 365 разрешаются во время запросов, исходящих от форматированного клиентов, таких как Microsoft Outlook, блокируются.  
  
 Значение утверждения — имя службы AD FS, которая получила запрос.  
  
## <a name="see-also"></a>См. также:  
 [Операции AD FS](../../ad-fs/AD-FS-2016-Operations.md)
