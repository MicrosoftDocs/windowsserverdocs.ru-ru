---
ms.assetid: 5728847d-dcef-4694-9080-d63bfb1fe24b
title: Политики управления доступом в AD FS
description: ''
author: billmath
ms.author: billmath
manager: femila
ms.date: 06/05/2018
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: identity-adfs
ms.openlocfilehash: 13969958c9b4e0539993142d680cb6c34dc10750
ms.sourcegitcommit: 0b5fd4dc4148b92480db04e4dc22e139dcff8582
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/24/2019
ms.locfileid: "66190252"
---
# <a name="access-control-policies-in-windows-server-2012-r2-and-windows-server-2012-ad-fs"></a>Политики управления доступом в Windows Server 2012 R2 и Windows Server 2012 AD FS


Создать политики, описанные в этой статье используется два вида утверждений  
  
1.  Утверждения, создает на основе сведений прокси-сервера AD FS и веб-приложения можно проверить и убедиться, такие как IP-адрес клиента, подключающегося непосредственно к AD FS или WAP AD FS.  
  
2.  Утверждений AD FS создает на основе сведений, пересланный к AD FS с помощью клиента HTTP-заголовки  
  
>**Важные**: Политики, как описано ниже будет блокировать присоединения к домену Windows 10 и входить в сценариях, где требуется доступ к следующих дополнительных конечных точек

Конечных точек AD FS, необходимых для присоединения к домену Windows 10 и входа на
- [имя службы федерации] / adfs/services/trust/2005/windowstransport
- [имя службы федерации] / adfs/services/trust/13/windowstransport
- [имя службы федерации] / adfs/services/trust/2005/usernamemixed
- [имя службы федерации] / adfs/services/trust/13/usernamemixed 
- [имя службы федерации] / adfs/services/trust/2005/certificatemixed
- [имя службы федерации] / adfs/services/trust/13/certificatemixed

Чтобы устранить проблему, обновите все политики, которые запрещают на основании утверждения конечной точки, чтобы разрешить исключение для конечных точек выше.

Например правило ниже:

`c1:[Type == "http://custom/ipoutsiderange", Value == "true"] && c2:[Type == "http://schemas.microsoft.com/2012/01/requestcontext/claims/x-ms-endpoint-absolute-path", Value != "/adfs/ls/"] => issue(Type = "http://schemas.microsoft.com/authorization/claims/deny", Value = " DenyUsersWithClaim");`  

будет добавлена информация:

`c1:[Type == "http://custom/ipoutsiderange", Value == "true"] && c2:[Type == "http://schemas.microsoft.com/2012/01/requestcontext/claims/x-ms-endpoint-absolute-path", Value != "(/adfs/ls/)|(/adfs/services/trust/2005/windowstransport)|(/adfs/services/trust/13/windowstransport)|(/adfs/services/trust/2005/usernamemixed)|(/adfs/services/trust/13/usernamemixed)|(/adfs/services/trust/2005/certificatemixed)|(/adfs/services/trust/13/certificatemixed)"] => issue(Type = "http://schemas.microsoft.com/authorization/claims/deny", Value = " DenyUsersWithClaim");`



> [!NOTE]
>  Утверждения из этой категории можно использовать только для реализации бизнес-политик, а не как политики безопасности для защиты доступа к сети.  Это возможно для неавторизованных клиентов до отправки заголовков с ложной информации, чтобы получить доступ.  
  
Политики, описанные в этой статье всегда следует использовать с помощью другого метода проверки подлинности, например имя пользователя и пароль или с несколькими идентификации.  
  
## <a name="client-access-policies-scenarios"></a>Сценарии политик доступа клиента  
  
|**Сценарий**|**Описание**| 
| --- | --- | 
|Сценарий 1. Полностью заблокировать внешний доступ к Office 365|Доступ к Office 365 разрешен из всех клиентов во внутренней корпоративной сети, но запросы от внешних клиентов отклоняются на основе IP-адреса из внешнего клиента.|  
|Сценарий 2. Полностью заблокировать внешний доступ к Office 365, за исключением Exchange ActiveSync|Допускается доступ к Office 365, со всех клиентов во внутренней корпоративной сети, а также с внешних клиентских устройств, таких как смарт-телефонов, которые используют Exchange ActiveSync. Все другие внешними клиентами, например с помощью Outlook, блокируются.|  
|Сценарий 3. Полностью заблокировать внешний доступ к Office 365 за исключением браузерных приложений|Блоки внешнего доступа к Office 365, за исключением пассивных приложений (на основе браузера), такие как Outlook Web Access или SharePoint Online.|  
|Сценарий 4. Полностью заблокировать внешний доступ к Office 365 за исключением указанного групп Active Directory|Этот сценарий используется для тестирования и проверка развертывания политики клиентского доступа. Он блокирует внешнего доступа к Office 365 только для членов группы Active Directory один или несколько. Он также может использоваться для предоставления внешнего доступа только к членам группы.|  
  
## <a name="enabling-client-access-policy"></a>После включения политики клиентского доступа  
 Чтобы включить политику клиентского доступа в AD FS в Windows Server 2012 R2, необходимо обновить платформы удостоверений Microsoft Office 365 с проверяющей стороной. Выберите один из примеров ниже, чтобы настроить правила утверждений на **платформы удостоверений Microsoft Office 365** отвечающей стороной, который лучше всего соответствует потребностям вашей организации.  
  
###  <a name="scenario1"></a> Сценарий 1. Полностью заблокировать внешний доступ к Office 365  
 Этот сценарий политики доступа клиента разрешает доступ из всех внутренних клиентов и блоки внешних клиентов IP-адрес внешнего клиента. Можно использовать следующие процедуры для добавления корректные правила авторизации выдачи на Office 365, с проверяющей стороной для выбранного сценария.  
  
##### <a name="to-create-rules-to-block-all-external-access-to-office-365"></a>Чтобы создать правила, чтобы полностью заблокировать внешний доступ к Office 365  
  
1.  Из **диспетчера серверов**, нажмите кнопку **средства**, затем нажмите кнопку **управления AD FS**.  
  
2.  В дереве консоли в разделе **AD fs\отношения доверия связи**, нажмите кнопку **доверия проверяющей стороны**, щелкните правой кнопкой мыши **платформы удостоверений Microsoft Office 365** доверия, а затем нажмите кнопку **Изменение правил утверждения**.  
  
3.  В **изменение правил для утверждений** выберите **правила авторизации выдачи** , а затем щелкните **добавить правило** запуск мастера правил утверждений.  
  
4.  На **Выбор шаблона правила** раздела **шаблон правила утверждения**выберите **Отправка утверждений с помощью настраиваемого правила**, а затем нажмите кнопку **Далее**.  
  
5.  На **Настройка правила** раздела **имя правила утверждения**, введите отображаемое имя для этого правила, например «при наличии претензии IP-адрес за пределами необходимый диапазон, запретить». В разделе **настраиваемого правила**введите или вставьте следующие синтаксиса языка правил утверждений (замените значения для «x-ms-forwarded--IP-адрес клиента» с допустимым выражением IP-адрес):  
`c1:[Type == "http://schemas.microsoft.com/ws/2012/01/insidecorporatenetwork", Value == "false"] && c2:[Type == "http://schemas.microsoft.com/2012/01/requestcontext/claims/x-ms-forwarded-client-ip", Value =~ "^(?!192\.168\.1\.77|10\.83\.118\.23)"] => issue(Type = "http://schemas.microsoft.com/authorization/claims/deny", Value = " DenyUsersWithClaim");` </br>
6.  Нажмите кнопку **Готово**. Убедитесь, что новое правило отображается в списке правил авторизации выдачи, прежде чем по умолчанию **разрешить доступ всем пользователям** правило (запрещающее правило будет иметь приоритет, несмотря на то, что он отображается в списке ранее).  Если у вас нет доступа правило разрешения по умолчанию, можно добавить, в конце списка, с помощью языка правил утверждений, следующим образом:  </br>
    
    `c:[] => issue(Type = "http://schemas.microsoft.com/authorization/claims/permit", Value = "true"); ` 

7.  Чтобы сохранить новые правила, в **изменение правил для утверждений** диалоговом окне щелкните **ОК**. Полученный список должен выглядеть следующим образом.  
  
     ![Правила авторизации выдачи](media/Access-Control-Policies-W2K12/clientaccess1.png "ADFS_Client_Access_1")  
  
###  <a name="scenario2"></a> Сценарий 2. Полностью заблокировать внешний доступ к Office 365, за исключением Exchange ActiveSync  
 Следующий пример разрешает доступ ко всем приложениям Office 365, включая Exchange Online из внутренних клиентов, включая Outlook. Он блокируется доступ к клиентам, которые расположены за пределами корпоративной сети, как указано в IP-адрес клиента, за исключением клиентов Exchange ActiveSync, таких как смарт-телефоны.  
  
##### <a name="to-create-rules-to-block-all-external-access-to-office-365-except-exchange-activesync"></a>Чтобы создать правила, чтобы полностью заблокировать внешний доступ к Office 365, за исключением Exchange ActiveSync  
  
1.  Из **диспетчера серверов**, нажмите кнопку **средства**, затем нажмите кнопку **управления AD FS**.  
  
2.  В дереве консоли в разделе **AD fs\отношения доверия связи**, нажмите кнопку **доверия проверяющей стороны**, щелкните правой кнопкой мыши **платформы удостоверений Microsoft Office 365** доверия, а затем нажмите кнопку **Изменение правил утверждения**.  
  
3.  В **изменение правил для утверждений** выберите **правила авторизации выдачи** , а затем щелкните **добавить правило** запуск мастера правил утверждений.  
  
4.  На **Выбор шаблона правила** раздела **шаблон правила утверждения**выберите **Отправка утверждений с помощью настраиваемого правила**, а затем нажмите кнопку **Далее**.  
  
5.  На **Настройка правила** раздела **имя правила утверждения**, введите отображаемое имя для этого правила, для примера «при наличии претензии IP-адрес за пределами необходимый диапазон, выдача ipoutsiderange утверждения». В разделе **настраиваемого правила**введите или вставьте следующие синтаксиса языка правил утверждений (замените значения для «x-ms-forwarded--IP-адрес клиента» с допустимым выражением IP-адрес):  
    
    `c1:[Type == "http://schemas.microsoft.com/ws/2012/01/insidecorporatenetwork", Value == "false"] && c2:[Type == "http://schemas.microsoft.com/2012/01/requestcontext/claims/x-ms-forwarded-client-ip", Value =~ "^(?!192\.168\.1\.77|10\.83\.118\.23)"] => issue(Type = "http://custom/ipoutsiderange", Value = "true");`  

6.  Нажмите кнопку **Готово**. Убедитесь, что новое правило отображается в **правила авторизации выдачи** списка.  
  
7.  Затем в **изменение правил для утверждений** диалоговом окне **правила авторизации выдачи** щелкните **добавить правило** снова запустить мастера правил утверждений.  
  
8.  На **Выбор шаблона правила** раздела **шаблон правила утверждения**выберите **Отправка утверждений с помощью настраиваемого правила**, а затем нажмите кнопку **Далее**.  
  
9. На **Настройка правила** раздела **имя правила утверждения**, введите отображаемое имя для этого правила, например «если IP-адрес за пределами необходимый диапазон и утверждение x-ms клиент приложение не EAS, запретить «. В разделе **настраиваемого правила**введите или вставьте следующие синтаксиса языка правил утверждений:  
  

    `c1:[Type == "http://custom/ipoutsiderange", Value == "true"] && c2:[Type == "http://schemas.microsoft.com/2012/01/requestcontext/claims/x-ms-client-application", Value != "Microsoft.Exchange.ActiveSync"] => issue(Type = "http://schemas.microsoft.com/authorization/claims/deny", Value = "DenyUsersWithClaim");`  
  
10. Нажмите кнопку **Готово**. Убедитесь, что новое правило отображается в **правила авторизации выдачи** списка.  
  
11. Затем в **изменение правил для утверждений** диалоговом окне **правила авторизации выдачи** щелкните **добавить правило** снова запустить мастера правил утверждений.  
  
12. На **Выбор шаблона правила** раздела **шаблон правила утверждения,** выберите **Отправка утверждений с помощью настраиваемого правила**, а затем нажмите кнопку **Далее**.  
  
13. На **Настройка правила** раздела **имя правила утверждения**введите отображаемое имя для этого правила, например «проверьте, существует ли утверждение приложения». В разделе **настраиваемого правила**введите или вставьте следующие синтаксиса языка правил утверждений:  
  
    ```  
    NOT EXISTS([Type == "http://schemas.microsoft.com/2012/01/requestcontext/claims/x-ms-client-application"]) => add(Type = "http://custom/xmsapplication", Value = "fail");  
    ```  
  
14. Нажмите кнопку **Готово**. Убедитесь, что новое правило отображается в **правила авторизации выдачи** списка.  
  
15. Затем в **изменение правил для утверждений** диалоговом окне **правила авторизации выдачи** щелкните **добавить правило** снова запустить мастера правил утверждений.  
  
16. На **Выбор шаблона правила** раздела **шаблон правила утверждения,** выберите **Отправка утверждений с помощью настраиваемого правила**, а затем нажмите кнопку **Далее**.  
  
17. На **Настройка правила** раздела **имя правила утверждения**введите отображаемое имя для этого правила, например «запретить пользователям с ipoutsiderange значение true, а не удается». В разделе **настраиваемого правила**введите или вставьте следующие синтаксиса языка правил утверждений:  
  
`c1:[Type == "http://custom/ipoutsiderange", Value == "true"] && c2:[Type == "http://custom/xmsapplication", Value == "fail"] => issue(Type = "http://schemas.microsoft.com/authorization/claims/deny", Value = "DenyUsersWithClaim");`</br>  
18. Нажмите кнопку **Готово**. Убедитесь, что новое правило появляется непосредственно под предыдущее правило и перед правило по умолчанию разрешить доступ всем пользователям в списке правил авторизации выдачи (запрещающее правило будет иметь приоритет, несмотря на то, что он отображается в списке ранее).  </br>Если у вас нет доступа правило разрешения по умолчанию, можно добавить, в конце списка, с помощью языка правил утверждений, следующим образом:</br></br>      `c:[] => issue(Type = "http://schemas.microsoft.com/authorization/claims/permit", Value = "true");`</br></br>
19. Чтобы сохранить новые правила, в **изменение правил для утверждений** диалогового окна нажмите кнопку ОК. Полученный список должен выглядеть следующим образом.  
  
     ![Правила авторизации выдачи](media/Access-Control-Policies-W2K12/clientaccess2.png )  
  
###  <a name="scenario3"></a> Сценарий 3. Полностью заблокировать внешний доступ к Office 365 за исключением браузерных приложений  
  
##### <a name="to-create-rules-to-block-all-external-access-to-office-365-except-browser-based-applications"></a>Чтобы создать правила, чтобы полностью заблокировать внешний доступ к Office 365 за исключением браузерных приложений  
  
1.  Из **диспетчера серверов**, нажмите кнопку **средства**, затем нажмите кнопку **управления AD FS**.  
  
2.  В дереве консоли в разделе **AD fs\отношения доверия связи**, нажмите кнопку **доверия проверяющей стороны**, щелкните правой кнопкой мыши **платформы удостоверений Microsoft Office 365** доверия, а затем нажмите кнопку **Изменение правил утверждения**.  
  
3.  В **изменение правил для утверждений** выберите **правила авторизации выдачи** , а затем щелкните **добавить правило** запуск мастера правил утверждений.  
  
4.  На **Выбор шаблона правила** раздела **шаблон правила утверждения**выберите **Отправка утверждений с помощью настраиваемого правила**, а затем нажмите кнопку **Далее**.  
  
5.  На **Настройка правила** раздела **имя правила утверждения**, введите отображаемое имя для этого правила, для примера «при наличии претензии IP-адрес за пределами необходимый диапазон, выдача ipoutsiderange утверждения». В разделе **настраиваемого правила**введите или вставьте следующие синтаксиса языка правил утверждений (замените значения для "x-ms-forwarded--IP-адрес клиента" с допустимым выражением IP-адрес):  </br>
`c1:[Type == "http://schemas.microsoft.com/ws/2012/01/insidecorporatenetwork", Value == "false"] && c2:[Type == "http://schemas.microsoft.com/2012/01/requestcontext/claims/x-ms-forwarded-client-ip", Value =~ "^(?!192\.168\.1\.77|10\.83\.118\.23)"] => issue(Type = "http://custom/ipoutsiderange", Value = "true");`   
6.  Нажмите кнопку **Готово**. Убедитесь, что новое правило отображается в **правила авторизации выдачи** списка.  
  
7.  Затем в **изменение правил для утверждений** диалоговом окне **правила авторизации выдачи** щелкните **добавить правило** снова запустить мастера правил утверждений.  
  
8.  На **Выбор шаблона правила** раздела **шаблон правила утверждения,** выберите **Отправка утверждений с помощью настраиваемого правила**, а затем нажмите кнопку **Далее**.  
  
9. На **Настройка правила** раздела **имя правила утверждения**, введите отображаемое имя для этого правила, например «если IP-адрес за пределами необходимый диапазон и эта конечная точка не/adfs/ls, запретить». В разделе **настраиваемого правила**введите или вставьте следующие синтаксиса языка правил утверждений:  
  
 
    `c1:[Type == "http://custom/ipoutsiderange", Value == "true"] && c2:[Type == "http://schemas.microsoft.com/2012/01/requestcontext/claims/x-ms-endpoint-absolute-path", Value != "/adfs/ls/"] => issue(Type = "http://schemas.microsoft.com/authorization/claims/deny", Value = " DenyUsersWithClaim");`  
  
10. Нажмите кнопку **Готово**. Убедитесь, что новое правило отображается в списке правил авторизации выдачи, прежде чем по умолчанию **разрешить доступ всем пользователям** правило (запрещающее правило будет иметь приоритет, несмотря на то, что он отображается в списке ранее).  </br></br> Если у вас нет доступа правило разрешения по умолчанию, можно добавить, в конце списка, с помощью языка правил утверждений, следующим образом:  
  
    `c:[] => issue(Type = "http://schemas.microsoft.com/authorization/claims/permit", Value = "true");`
  
11. Чтобы сохранить новые правила, в **изменение правил для утверждений** диалоговом окне щелкните **ОК**. Полученный список должен выглядеть следующим образом.  
  
     ![Выдача](media/Access-Control-Policies-W2K12/clientaccess3.png)  
  
###  <a name="scenario4"></a> Сценарий 4. Полностью заблокировать внешний доступ к Office 365 за исключением указанного групп Active Directory  
 В следующем примере включается доступ из внутренних клиентов на основе IP-адреса. Блокирует доступ от клиентов, находящихся за пределами корпоративной сети, IP-адресом внешнего клиента, за исключением те пользователи, в указанный Group.Use Active Directory следующие действия, чтобы добавить правильную авторизацию выдачи правила для  **Платформы удостоверений Microsoft Office 365** доверия с проверяющей стороной с помощью мастера создания правила утверждения:  
  
##### <a name="to-create-rules-to-block-all-external-access-to-office-365-except-for-designated-active-directory-groups"></a>Чтобы создать правила, чтобы заблокировать внешний доступ к Office 365, за исключением указанных групп Active Directory  
  
1.  Из **диспетчера серверов**, нажмите кнопку **средства**, затем нажмите кнопку **управления AD FS**.  
  
2.  В дереве консоли в разделе **AD fs\отношения доверия связи**, нажмите кнопку **доверия проверяющей стороны**, щелкните правой кнопкой мыши **платформы удостоверений Microsoft Office 365** доверия, а затем нажмите кнопку **Изменение правил утверждения**.  
  
3.  В **изменение правил для утверждений** выберите **правила авторизации выдачи** , а затем щелкните **добавить правило** запуск мастера правил утверждений.  
  
4.  На **Выбор шаблона правила** раздела **шаблон правила утверждения**выберите **Отправка утверждений с помощью настраиваемого правила**, а затем нажмите кнопку **Далее**.  
  
5.  На **Настройка правила** раздела **имя правила утверждения**, введите отображаемое имя для этого правила, для примера «при наличии претензии IP-адрес за пределами необходимый диапазон, выдача ipoutsiderange утверждения.» В разделе **настраиваемого правила**введите или вставьте следующие синтаксиса языка правил утверждений (замените значения для "x-ms-forwarded--IP-адрес клиента" с допустимым выражением IP-адрес):  
  
      
    `c1:[Type == "http://schemas.microsoft.com/2012/01/requestcontext/claims/x-ms-forwarded-client-ip", Value =~ "^(?!192\.168\.1\.77|10\.83\.118\.23)"] && c2:[Type == "http://schemas.microsoft.com/ws/2012/01/insidecorporatenetwork", Value == "false"] => issue(Type = "http://custom/ipoutsiderange", Value = "true");`  

6.  Нажмите кнопку **Готово**. Убедитесь, что новое правило отображается в **правила авторизации выдачи** списка.  
  
7.  Затем в **изменение правил для утверждений** диалоговом окне **правила авторизации выдачи** щелкните **добавить правило** снова запустить мастера правил утверждений.  
  
8.  На **Выбор шаблона правила** раздела **шаблон правила утверждения,** выберите **Отправка утверждений с помощью настраиваемого правила**, а затем нажмите кнопку **Далее**.  
  
9. На **Настройка правила** раздела **имя правила утверждения**введите отображаемое имя для этого правила, например «проверить SID группы». В разделе **настраиваемого правила**введите или вставьте следующие синтаксиса языка правил утверждений (Замените «groupsid» с фактическим SID группы AD, вы используете):  
   
    `NOT EXISTS([Type == "http://schemas.microsoft.com/ws/2008/06/identity/claims/groupsid", Value == "S-1-5-32-100"]) => add(Type = "http://custom/groupsid", Value = "fail");`  

10. Нажмите кнопку **Готово**. Убедитесь, что новое правило отображается в **правила авторизации выдачи** списка.  
  
11. Затем в **изменение правил для утверждений** диалоговом окне **правила авторизации выдачи** щелкните **добавить правило** снова запустить мастера правил утверждений.  
  
12. На **Выбор шаблона правила** раздела **шаблон правила утверждения,** выберите **Отправка утверждений с помощью настраиваемого правила**, а затем нажмите кнопку **Далее**.  
  
13. На **Настройка правила** раздела **имя правила утверждения**введите отображаемое имя для этого правила, например «запретить пользователям с ipoutsiderange true и groupsid не удается». В разделе **настраиваемого правила**введите или вставьте следующие синтаксиса языка правил утверждений:  
   
    `c1:[Type == "http://custom/ipoutsiderange", Value == "true"] && c2:[Type == "http://custom/groupsid", Value == "fail"] => issue(Type = "http://schemas.microsoft.com/authorization/claims/deny", Value = "DenyUsersWithClaim");`  

14. Нажмите кнопку **Готово**. Убедитесь, что новое правило появляется непосредственно под предыдущее правило и перед правило по умолчанию разрешить доступ всем пользователям в списке правил авторизации выдачи (запрещающее правило будет иметь приоритет, несмотря на то, что он отображается в списке ранее).  </br></br>Если у вас нет доступа правило разрешения по умолчанию, можно добавить, в конце списка, с помощью языка правил утверждений, следующим образом:  
   
    `c:[] => issue(Type = "http://schemas.microsoft.com/authorization/claims/permit", Value = "true");`  

15. Чтобы сохранить новые правила, в **изменение правил для утверждений** диалогового окна нажмите кнопку ОК. Полученный список должен выглядеть следующим образом.  
  
     ![Выдача](media/Access-Control-Policies-W2K12/clientaccess4.png)  
  
##  <a name="buildingip"></a> Создание выражения адрес диапазона IP-адрес  
 Утверждение x-ms-forwarded--IP-адрес клиента заполняется из HTTP-заголовка в настоящее время устанавливаются только Exchange Online, который заполняет заголовок при передаче запроса на проверку подлинности в AD FS. Значение утверждения может быть одно из следующих значений:  
  
> [!NOTE]
>  Exchange Online сейчас поддерживает только адреса IPV4 и IPV6 не.  
  
-   Один IP-адрес: IP-адрес клиента, который подключен напрямую к Exchange Online  
  
> [!NOTE]
>  -   IP-адрес клиента в корпоративной сети будет отображаться как IP-адрес внешнего интерфейса организации исходящий прокси-сервер или шлюз.  
> -   Клиентов, подключенных к корпоративной сети с VPN-Подключение или по Microsoft DirectAccess (DA) может отображаться как внутренними корпоративными клиентами или в качестве внешних клиентов, в зависимости от конфигурации VPN или DA.  
  
-   Один или несколько IP-адресов: Если Exchange Online не может определить IP-адрес подключающегося клиента, оно будет задано значение на основе значения заголовка x-forwarded-for нестандартный заголовок, который может быть включено в HTTP-запросы и поддерживается многими клиентами, подсистемы балансировки нагрузки, и прокси-серверы, на рынке.  
  
> [!NOTE]
>  1.  Несколько IP-адресов, IP-адрес клиента и адрес каждого прокси-сервера, передавшего запрос, будут разделены запятыми.  
> 2.  IP-адреса, связанные с инфраструктурой Exchange Online будет не в списке.  
  
### <a name="regular-expressions"></a>Регулярные выражения  
 При наличии в соответствии с диапазоном IP-адресов, появляется необходимость создания регулярного выражения для выполнения сравнения. В следующей последовательности шагов мы предлагаем примеры для построения такого выражения для сопоставления следующие диапазоны адресов (Обратите внимание, что необходимо будет изменить эти примеры, в соответствии с вашей общедоступный диапазон IP-адресов):  
  
-   192.168.1.1 – 192.168.1.25  
  
-   10.0.0.1 – 10.0.0.14  
  
 Во-первых, базовый шаблон, который будет соответствовать один IP-адрес выглядит следующим образом: \b###\\. ###\\. ###\\. ### \b  
  
 Это расширение, то можно сопоставить два разных IP-адреса с выражением OR следующим образом: \b###\\. ###\\. ###\\. ### \b&#124;\b###\\. ###\\. ###\\. ### \b  
  
 Таким образом, будет привести пример в соответствии с только что два адреса (например, 192.168.1.1 или 10.0.0.1): \b192\\.168\\.1\\. 1\b&#124;\b10\\.0\\.0\\. 1\b  
  
 Это дает тот метод, по которому можно ввести любое количество адресов. Там, где диапазона адресов потребуется открыть доступ, например 192.168.1.1 — 192.168.1.25, соответствие должно производиться символ символом: \b192\\.168\\.1\\. () [1-9] &#124;1 [0-9]&#124;2 [0-5]) \b  
  
 Имейте в виду следующее:  
  
-   IP-адрес рассматривается как строка и не является числом.  
  
-   Правило разбивается следующим образом: \b192\\.168\\.1\\.  
  
-   Это соответствует все значения, начинающиеся с 192.168.1.  
  
-   Следующие соответствует диапазоны, необходимые для части адреса после окончательного десятичной запятой:  
  
    -   ([1-9] соответствует адреса, заканчивающиеся на 1-9  
  
    -   &#124;1 [0-9] соответствует адреса, заканчивающиеся на 10-19  
  
    -   &#124;2[0-5]) сопоставляет адреса, заканчивающиеся на 20-25  
  
-   Обратите внимание на то, что скобки должен быть установлен правильно, таким образом, чтобы не выполнять совпадающие другие части IP-адреса.  
  
-   С блоком 192 соответствие, можно написать аналогичные выражения для 10 блока: \b10\\.0\\.0\\. () [1-9] &#124;1 [0-4]) \b  
  
-   Причем помещая их вместе, следующее выражение должно соответствовать все адреса для «192.168.1.1~25» и «10.0.0.1~14»: \b192\\.168\\.1\\. () [1-9] &#124;1 [0-9]&#124;2 [0-5]) \b&#124;\b10\\.0\\.0\\. () [1-9] &#124;1 [0-4]) \b  
  
### <a name="testing-the-expression"></a>Тестирование выражения  
 Выражения регулярных выражений может стать довольно сложным, поэтому мы настоятельно рекомендуем использовать это средство проверки регулярного выражения. В этом случае поиск в Интернете для «построитель выражений online регулярное выражение», вы найдете несколько хорошо online служебных программ, которые вы сможете опробовать выражения на основе демонстрационных данных.  
  
 При тестировании выражение, очень важно, что вы понимаете, что следует ожидать должны совпадать. Exchange online система отправляет количество IP-адресов, разделенных запятыми. Выражения, приведенные выше будет работать для этого. Тем не менее важно думать об этом при тестировании выражения regex. Например один может использовать следующий образец входных данных для проверки приведенных выше примерах:  
  
 192.168.1.1, 192.168.1.2, 192.169.1.1. 192.168.12.1, 192.168.1.10, 192.168.1.25, 192.168.1.26, 192.168.1.30, 1192.168.1.20  
  
 10.0.0.1, 10.0.0.5, 10.0.0.10, 10.0.1.0, 10.0.1.1, 110.0.0.1, 10.0.0.14, 10.0.0.15, 10.0.0.10, 10,0.0.1  
  
## <a name="claim-types"></a>Типы утверждений  
 AD FS в Windows Server 2012 R2 предоставляет контекстной информации запроса, используя следующие типы утверждений:  
  
### <a name="x-ms-forwarded-client-ip"></a>X-MS-Forwarded--IP-адрес клиента  
 Тип утверждения: `http://schemas.microsoft.com/2012/01/requestcontext/claims/x-ms-forwarded-client-ip`  
  
 Это утверждение AD FS представляет «максимально точного» в Проверка IP-адрес пользователя (например, клиент Outlook), выполняющего запрос. Это утверждение может содержать несколько IP-адресов, включая адрес каждого прокси-сервера, перенаправление запроса.  Это утверждение заполняется из HTTP. Значение утверждения может принимать одно из следующих значений:  
  
-   Один IP-адрес — IP-адрес клиента, который подключен напрямую к Exchange Online  
  
> [!NOTE]
>  IP-адрес клиента в корпоративной сети будет отображаться как IP-адрес внешнего интерфейса организации исходящий прокси-сервер или шлюз.  
  
-   Один или несколько IP-адресов  
  
    -   Если Exchange Online не может определить IP-адрес подключающегося клиента, оно будет задано значение на основе значения заголовка x-forwarded-for, нестандартный заголовок, который может быть включено в на основе HTTP запрашивает и поддерживается многими клиентами, подсистемы балансировки нагрузки, и учетные записи-посредники, представленными на рынке.  
  
    -   Несколько IP-адресов, IP-адрес клиента и адрес каждого прокси-сервера, передавшего запрос будет содержать запятую.  
  
> [!NOTE]
>  IP-адреса, связанные с инфраструктурой Exchange Online будет отсутствовать в списке.  
  
> [!WARNING]
>  Exchange Online сейчас поддерживает только IPv4-адреса; он не поддерживает IPv6-адреса.  
  
### <a name="x-ms-client-application"></a>X-MS-клиентского приложения  
 Тип утверждения: `http://schemas.microsoft.com/2012/01/requestcontext/claims/x-ms-client-application`  
  
 Это утверждение AD FS представляет протокол, используемый клиентом end, который соответствует слабо используемого приложения.  Это утверждение заполняется из заголовка HTTP, в данный момент задано только с Exchange Online, который заполняет заголовок при передаче запроса на проверку подлинности в AD FS. В зависимости от приложения значение этого утверждения будет иметь одно из следующих:  
  
-   В случае устройств, использующих Exchange Active Sync значение равно Microsoft.Exchange.ActiveSync.  
  
-   Использование клиента Microsoft Outlook может привести любое из следующих значений:  
  
    -   Microsoft.Exchange.Autodiscover  
  
    -   Microsoft.Exchange.OfflineAddressBook  
  
    -   Microsoft.Exchange.RPCMicrosoft.Exchange.WebServices  
  
    -   Microsoft.Exchange.RPCMicrosoft.Exchange.WebServices  
  
-   Другие возможные значения для этого заголовка, включают следующее:  
  
    -   Microsoft.Exchange.Powershell  
  
    -   Microsoft.Exchange.SMTP  
  
    -   Microsoft.Exchange.Pop  
  
    -   Microsoft.Exchange.Imap  
  
### <a name="x-ms-client-user-agent"></a>X-MS-клиента User-Agent  
 Тип утверждения: `http://schemas.microsoft.com/2012/01/requestcontext/claims/x-ms-client-user-agent`  
  
 Это утверждение AD FS предоставляет строку для представления типа устройства, клиент использует для доступа к службе. Это используется, если клиентам требуется запретить доступ для определенных устройств (например, определенные типы смарт-телефоны).  Примеры значений для этого утверждения причинами (но не ограничиваются) приведенные ниже значения.  
  
 Ниже приведены примеры значение x-ms-user-agent может содержать для клиента, которого x-ms клиентского приложения является «Microsoft.Exchange.ActiveSync»  
  
-   Vortex/1.0  
  
-   Apple-iPad1C1/812.1  
  
-   Apple-iPhone3C1/811.2  
  
-   Apple — iPhone/704.11  
  
-   Moto-DROID2/4.5.1  
  
-   SAMSUNGSPHD700/100.202  
  
-   Android/0.3  
  
 Это также возможно, это значение является пустым.  
  
### <a name="x-ms-proxy"></a>X-MS-прокси  
 Тип утверждения: `http://schemas.microsoft.com/2012/01/requestcontext/claims/x-ms-proxy`  
  
 Это утверждение AD FS указывает, что запрос прошел через прокси-сервер веб-приложения.  Это утверждение заполняется прокси веб-приложения, который заполняет заголовок при передаче запроса на проверку подлинности в серверной службе федерации. Службы федерации Active Directory затем преобразует его утверждения.  
  
 Значение утверждения — это DNS-имя прокси-сервера веб-приложения, передавшего запрос.  
  
### <a name="insidecorporatenetwork"></a>InsideCorporateNetwork  
 Тип утверждения: `http://schemas.microsoft.com/ws/2012/01/insidecorporatenetwork`  
  
 Тип утверждения аналогичен выше x-ms прокси, этот тип утверждения указывает, прошел ли запрос через прокси веб-приложения. В отличие от x-ms прокси insidecorporatenetwork является логическое значение с True, указывающее, запрос непосредственно к службе федерации в корпоративной сети.  
  
### <a name="x-ms-endpoint-absolute-path-active-vs-passive"></a>X-MS-Endpoint-абсолютное-Path (активное или пассивное)  
 Тип утверждения: `http://schemas.microsoft.com/2012/01/requestcontext/claims/x-ms-endpoint-absolute-path`  
  
 Этот тип утверждения может использоваться для определения запросов, исходящих от «активный» клиентов (широкие возможности) и «пассивным» (веб браузере) клиенты. Это позволяет внешние запросы из Браузерные приложения, такие как Outlook Web Access, SharePoint Online или на портале Office 365 разрешаются во время запросов, исходящих от многофункциональных клиентов, таких как Microsoft Outlook, блокируются.  
  
 Значение утверждения — это имя службы AD FS, полученного запроса.  
  
## <a name="see-also"></a>См. также  
 [Операции AD FS](../../ad-fs/AD-FS-2016-Operations.md)
