---
ms.assetid: 3a840b63-78b7-4e62-af7b-497026bfdb93
title: Пошаговое руководство. Управление рисками с помощью управления условным доступом
description: ''
author: billmath
ms.author: billmath
manager: femila
ms.date: 05/31/2017
ms.topic: article
ms.prod: windows-server
ms.technology: identity-adfs
ms.openlocfilehash: aefcd597a580de526a758c6d026c6c91d02d10c8
ms.sourcegitcommit: 6aff3d88ff22ea141a6ea6572a5ad8dd6321f199
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/27/2019
ms.locfileid: "71407462"
---
# <a name="walkthrough-guide-manage-risk-with-conditional-access-control"></a>Пошаговое руководство: Управление рисками с использованием условного управления доступом




## <a name="about-this-guide"></a>Информация о руководстве
В этом пошаговом руководстве приводятся инструкции по управлению риском с одним из факторов (пользовательских данных), доступных через механизм управления условным доступом в службы федерации Active Directory (AD FS) (AD FS) в Windows Server 2012 R2. Дополнительные сведения об управлении условным доступом и механизмами авторизации в AD FS в Windows Server 2012 R2 см. в статье [Управление рисками с помощью управления условным доступом](../../ad-fs/operations/Manage-Risk-with-Conditional-Access-Control.md).

Это пошаговое руководство включает в себя следующие разделы.

-   [Шаг 1. Настройка лабораторной среды @ no__t-0

-   [Шаг 2. Проверка механизма контроля доступа AD FS по умолчанию @ no__t-0

-   [Шаг 3. Настройка политики управления условным доступом на основе данных пользователя @ no__t-0

-   [Шаг 4. Проверка механизма управления условным доступом @ no__t-0

## <a name="BKMK_1"></a>Шаг 1. Настройка лабораторной среды
Для выполнения этого пошагового руководства вам потребуется среда, состоящая из следующих компонентов:

-   Домен Active Directory с тестовыми учетными записями пользователей и групп, работающими под Windows Server 2008, Windows Server 2008 R2 или Windows Server 2012 со схемой, обновленной до Windows Server 2012 R2 или домена Active Directory, работающего под Windows Server 2012 R2

-   Сервер федерации под Windows Server 2012 R2

-   веб-сервера, на котором размещен пример приложения;

-   клиентского компьютера, с которого осуществляется доступ к примеру приложения.

> [!WARNING]
> Настоятельно не рекомендуется (как в производственной, так и в тестовой среде) использовать один и тот же компьютер в качестве сервера федерации и веб-сервера.

В этой среде сервер федерации выдает утверждения, которые необходимы для доступа пользователей к примеру приложения. На веб-сервере размещается пример приложения, которое будет считать доверенными пользователей, предъявивших утверждения, выданные сервером федерации.

Инструкции по настройке этой среды см. [в разделе Настройка лабораторной среды для AD FS в Windows Server 2012 R2](../../ad-fs/deployment/Set-up-the-lab-environment-for-AD-FS-in-Windows-Server-2012-R2.md).

## <a name="BKMK_2"></a>Шаг 2. Проверка стандартного механизма контроля доступа через службы AD FS
В этом шаге вы проверите стандартный механизм управления доступом через службы AD FS, который перенаправляет пользователя на страницу входа AD FS, где ему нужно ввести действительные учетные данные, после чего пользователю будет предоставлен доступ к приложению. Вы можете использовать учетную запись **Роберт хатлэй** AD и пример приложения **клаимапп** , настроенного в [настройке лабораторной среды для AD FS в Windows Server 2012 R2](../../ad-fs/deployment/Set-up-the-lab-environment-for-AD-FS-in-Windows-Server-2012-R2.md).

#### <a name="to-verify-the-default-ad-fs-access-control-mechanism"></a>Проверка стандартного механизма управления доступом через службы AD FS

1.  На клиентском компьютере откройте окно браузера и перейдите к вашему примеру приложения: **https://webserv1.contoso.com/claimapp** .

    В результате запрос будет автоматически перенаправлен серверу федерации и вам будет предложено ввести имя пользователя и пароль.

2.  Введите учетные данные учетной записи **Роберт хатлэй** AD, созданной в окне [Настройка лабораторной среды для AD FS в Windows Server 2012 R2](../../ad-fs/deployment/Set-up-the-lab-environment-for-AD-FS-in-Windows-Server-2012-R2.md).

    После этого вам будет предоставлен доступ к приложению.

## <a name="BKMK_3"></a>Шаг 3. Настройка политики условного управления доступом на основе данных пользователя
В этом шаге вы настроите политику управления доступом на основе данных о членстве в группе пользователей. Иными словами, вы настроите **правило авторизации выдачи** на сервере федерации для отношения доверия с проверяющей стороной, которое представляет ваш пример приложения — **claimapp**. По логике этого правила **Роберт хатлэй** AD будет выдавать утверждения, необходимые для доступа к этому приложению, поскольку он принадлежит к группе **Финансы** . Вы добавили учетную запись **Роберт хатлэй** в группу **Финансы** в [настройке лабораторной среды для AD FS в Windows Server 2012 R2](../../ad-fs/deployment/Set-up-the-lab-environment-for-AD-FS-in-Windows-Server-2012-R2.md).

Эту задачу можно выполнить с помощью консоли управления AD FS или Windows PowerShell.

#### <a name="to-configure-conditional-access-control-policy-based-on-user-data-via-the-ad-fs-management-console"></a>Настройка политики условного управления доступом на основе данных пользователя с помощью консоли управления AD FS

1.  В консоли управления AD FS перейдите в раздел **Отношения доверия**, а затем в раздел **Отношения доверия проверяющей стороны**.

2.  Выберите отношение доверия с проверяющей стороной, которое представляет ваш пример приложения (**claimapp**), а затем перейдите на панель **Действия** либо щелкните это отношение доверия правой кнопкой мыши и выберите пункт **Изменить правила утверждений**.

3.  В окне **Изменение правил для утверждений для claimapp** перейдите на вкладку **Правила авторизации выдачи** и нажмите кнопку **Добавить правило**.

4.  В окне **мастера добавления правила авторизации выдачи утверждения**на странице **Выбор шаблона правила**выберите шаблон правила для утверждений **Разрешить или запретить доступ пользователям на основании входящего утверждения** и нажмите кнопку **Далее**.

5.  На странице **Настройка правила** выполните все указанные ниже действия и нажмите кнопку **Готово**.

    1.  Введите имя правила для утверждений, например **TestRule**.

    2.  Выберите **SID группы** в качестве **типа входящего утверждения**.

    3.  Нажмите кнопку **Обзор**, введите **Finance** в качестве имени тестовой группы Active Directory и разрешите его для поля **Значение входящего утверждения** .

    4.  Выберите параметр **Запретить доступ пользователям с этим входящим утверждением** .

6.  В окне **Изменение правил для утверждений для claimapp** удалите правило **Разрешить доступ всем пользователям** , созданное по умолчанию одновременно с этим отношением доверия с проверяющей стороной.

#### <a name="to-configure-conditional-access-control-policy-based-on-user-data-via-windows-powershell"></a>Настройка политики условного управления доступом на основе данных пользователя с помощью Windows PowerShell

1.  На сервере федерации откройте окно команд Windows PowerShell и выполните следующую команду:


~~~
`$rp = Get-AdfsRelyingPartyTrust -Name claimapp`
~~~


2. В том же окне команд Windows PowerShell выполните следующую команду:


~~~
`$GroupAuthzRule = '@RuleTemplate = "Authorization" @RuleName = "Foo" c:[Type == "https://schemas.microsoft.com/ws/2008/06/identity/claims/groupsid", Value =~ "^(?i)<group_SID>$"] =>issue(Type = "https://schemas.microsoft.com/authorization/claims/deny", Value = "DenyUsersWithClaim");'
Set-AdfsRelyingPartyTrust -TargetRelyingParty $rp -IssuanceAuthorizationRules $GroupAuthzRule`
~~~

> [!NOTE]
> Замените <group_SID> значением идентификатора безопасности для вашей группы Active Directory **Finance**.

## <a name="BKMK_4"></a>Шаг 4. Проверка механизма условного управления доступом
В этом шаге вы проверите политику условного управления доступом, настроенную в предыдущем шаге. Чтобы убедиться, что пользователь с учетной записью Active Directory **Robert Hatley** может получать доступ к вашему примеру приложения, так как он входит в группу **Finance** , а пользователям Active Directory, не принадлежащим к группе **Finance** , такой доступ запрещен, можно использовать следующую процедуру.

1.  На клиентском компьютере откройте окно браузера и перейдите к вашему примеру приложения: **https://webserv1.contoso.com/claimapp** .

    В результате запрос будет автоматически перенаправлен серверу федерации и вам будет предложено ввести имя пользователя и пароль.

2.  Введите учетные данные учетной записи **Роберт хатлэй** AD, созданной в окне [Настройка лабораторной среды для AD FS в Windows Server 2012 R2](../../ad-fs/deployment/Set-up-the-lab-environment-for-AD-FS-in-Windows-Server-2012-R2.md).

    После этого вам будет предоставлен доступ к приложению.

3.  Введите учетные данные другого пользователя Active Directory, который НЕ входит в группу **Finance**. (Дополнительные сведения о создании учетных записей пользователей в AD см. в разделе [https://technet.microsoft.com/library/cc7833232.aspx](https://technet.microsoft.com/library/cc783323%28v=ws.10%29.aspx).

    На этом этапе из-за политики контроля доступа, настроенной на предыдущем шаге, для этого пользователя AD отображается сообщение "отказано в доступе", которое не принадлежит к группе **Финансы** . Текст сообщения по умолчанию — **You не имеет прав доступа к этому сайту. Щелкните здесь, чтобы выйти и снова войти в систему, или обратитесь к администратору за разрешениями.** Этот текст можно полностью изменить по своему усмотрению. Дополнительную информацию о настройке взаимодействия при входе см. в разделе [Customizing the AD FS Sign-in Pages](https://technet.microsoft.com/library/dn280950.aspx).

## <a name="see-also"></a>См. также
[Управление рисками с помощью контроля условного доступа](../../ad-fs/operations/Manage-Risk-with-Conditional-Access-Control.md)
[Настройка лабораторной среды для AD FS в Windows Server 2012 R2](../deployment/Set-up-the-lab-environment-for-AD-FS-in-Windows-Server-2012-R2.md)



