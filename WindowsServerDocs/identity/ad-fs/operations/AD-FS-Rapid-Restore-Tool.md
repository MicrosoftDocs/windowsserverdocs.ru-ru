---
ms.assetid: 4deff06a-d0ef-4e5a-9701-5911ba667201
title: Средство ускоренного восстановления AD FS
description: ''
author: billmath
ms.author: billmath
manager: femila
ms.date: 07/02/2019
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: identity-adfs
ms.openlocfilehash: 525ba403473a9de522d9ab30662adc868b17b88d
ms.sourcegitcommit: c02756b7f5c92bf5018e17192f6fffb4754b0f06
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/03/2019
ms.locfileid: "67533506"
---
# <a name="ad-fs-rapid-restore-tool"></a>Средство ускоренного восстановления AD FS

## <a name="overview"></a>Обзор
Сегодня AD FS является режим высокой доступности, настроив ферму AD FS. Некоторые организации хотели бы способ с одним сервером развертывания AD FS, устраняя необходимость в нескольких серверов AD FS и сетевой нагрузки, балансировка инфраструктуры, но при этом иметь некоторые гарантию того, что служба может быть быстро восстановлена Если возникла проблема.
Новое средство быстрого восстановления AD FS позволяет восстановить данные AD FS без требуют полной резервной копии и восстановления операционной системы или состояния системы. Новое средство можно использовать для экспорта конфигурации AD FS в Azure или между локальным расположением.  Затем можно применить экспортированные данные для новой установки AD FS, дублирование среде AD FS или повторное ее создание. 

## <a name="scenarios"></a>Сценарии
Средство быстрого восстановления AD FS можно использовать в следующих сценариях:

1. Быстро восстановить функциональности AD FS после проблема
    - Используйте средство для создания "холодных" резервный установки AD FS, который можно быстро развернуть вместо подключенного к Интернету сервера AD FS
2. Развертывать идентичные тестовой и рабочей среды
    - Используйте средство для быстрого создания точную копию производственного AD FS в среде тестирования или для быстрого развертывания проверенные тестовой конфигурации в рабочей среде

## <a name="what-is-backed-up"></a>Объекты для резервного копирования
Средство создает резервные копии следующих конфигурации AD FS
    
- AD FS конфигурации базы данных (SQL или внутреннюю базу данных Windows)
- Файл конфигурации (расположен в папке AD FS)
- Автоматическое создание токена подписи и расшифровки, сертификатов и закрытых ключей (из контейнера Active Directory DKM)
- SSL-сертификат и любые извне зарегистрированных сертификатов (токена подписи маркеров и для взаимодействия со службой) и закрытых ключей (Примечание: закрытые ключи должны быть доступен для экспорта и пользователь, выполняющий скрипт должен иметь разрешения на доступ к ним)
- Список настраиваемых поставщиков проверки подлинности, хранилищах атрибутов и поставщика утверждений локального доверительные отношения, которые установлены.

## <a name="how-to-use-the-tool"></a>Как использовать средство
Во-первых, [загрузить](https://go.microsoft.com/fwlink/?LinkId=825646) и установите MSI-ФАЙЛ на сервере AD FS.  

Выполните следующую команду в командной строке PowerShell:

```powershell
import-module 'C:\Program Files (x86)\ADFS Rapid Recreation Tool\ADFSRapidRecreationTool.dll'
```

>[!NOTE] 
>При использовании встроенной базы данных Windows (WID), это средство необходимо запускать на сервере-источнике AD FS.  Можно использовать `Get-AdfsSyncProperties` командлет PowerShell для определения того, является ли сервер используется является основным сервером.

### <a name="system-requirements"></a>Системные требования

- Это средство работает для AD FS в Windows Server 2012 R2 и более поздних версий. 
- Требуется .NET framework — по крайней мере 4.0. 
- Восстановление, которые должны выполняться в той же версии, как резервное копирование сервера AD FS и использует одну и ту же учетную запись Active Directory как учетная запись службы AD FS.

## <a name="create-a-backup"></a>Создание резервной копии
Создание резервной копии, используйте командлет Backup-служб федерации Active Directory. Этот командлет создает резервные копии конфигурации AD FS, базы данных, SSL-сертификаты, и т.д. 

Пользователь должен быть по крайней мере права локального администратора для выполнения этого командлета. Для резервного копирования Active Directory контейнер DKM (требуется в конфигурации по умолчанию AD FS), пользователь должен иметь права администратора домена, необходимо передать учетные данные учетной записи службы AD FS либо имеет доступ к контейнеру DKM.  При использовании групповой управляемой учетной записи, пользователь должен быть администратор домена или иметь разрешения для контейнера; не может предоставить учетные данные групповой управляемой учетной записи. 

Резервная копия будет называться в соответствии с моделью «adfsBackup_ID_Date-Time». Он будет содержать номер версии, Дата и время, которое было выполнено резервное копирование.
Командлет принимает следующие параметры:
    
Наборы параметров

![Средство ускоренного восстановления AD FS](media/AD-FS-Rapid-Restore-Tool/parameter1.png)

### <a name="detailed-description"></a>Подробное описание

- **BackupDKM** -создает резервные копии Active Directory DKM контейнер, содержащий ключи AD FS в конфигурации по умолчанию (автоматически созданный маркер подписи и расшифровки сертификаты). Это используется средство AD «ldifde» экспортировать контейнер AD, а также всех поддеревьях.

- -**StorageType &lt;строка&gt;**  -тип хранилища, пользователю нужно использовать. «Файловая система» указывает, что пользователь хочет сохранить его в папку, локально или в сети «Azure» указывает, пользователю необходимо сохранить его в контейнер хранилища Azure, когда пользователь выполняет резервное копирование, они выберите расположение резервной копии файловой системы или в облако. Для Azure для использования учетных данных хранилища Azure должны быть переданы командлет. Учетные данные хранилища содержит имя учетной записи и ключ. Кроме того имя контейнера также должны передаваться в. Если контейнер не существует, он создается во время резервного копирования. Для файловой системы для использования необходимо указать путь к хранилищу. В этом каталоге будет создан каталог для каждой резервной копии. Каждый каталог создан будет содержать файлы резервных копий. 

- **EncryptionPassword &lt;строка&gt;**  -пароль, который будет использоваться для шифрования всех резервных копий файлов перед их сохранением

- **AzureConnectionCredentials &lt;pscredential&gt;**  -имя учетной записи и ключ учетной записи хранения Azure

- **AzureStorageContainer &lt;строка&gt;**  -контейнер хранилища, где будут храниться резервная копия в Azure

- **StoragePath &lt;строка&gt;**  -расположение резервные копии будут храниться в

- **ServiceAccountCredential &lt;pscredential&gt;**  — Указывает учетную запись службы используется для службы AD FS, в данный момент выполняется. Этот параметр требуется только в том случае, если пользователь хочет создать резервную копию DKM и не имеет прав администратора домена или не имеет доступа к содержимому контейнера. 

- **BackupComment &lt;string []&gt;**  -строку информационное о резервной копии, который будет отображаться во время восстановления, аналогично понятию именования контрольной точки Hyper-V. Значение по умолчанию является пустой строкой

 
## <a name="backup-examples"></a>Примеры резервного копирования
Ниже приведены примеры резервного копирования для использования AD FS быстрое восстановление средства.

### <a name="backup-the-ad-fs-configuration-with-the-dkm-to-the-file-system-and-has-access-to-the-dkm-container-contents-either-domain-admin-or-delegated"></a>Резервное копирование конфигурации AD FS, с помощью DKM, в файловой системе, и имеет доступ к содержимому контейнер DKM (либо администратора домена или делегированные)

```powershell
Backup-ADFS -StorageType "FileSystem" -StoragePath "C:\Users\administrator\testExport\" -EncryptionPassword "password" -BackupComment "Clean Install of ADFS (FS)" -BackupDKM
```
 
### <a name="backup-the-ad-fs-configuration-with-the-dkm-to-the-file-system-with-the-service-account-credential-running-as-local-admin"></a>Конфигурации резервной копии AD FS, с помощью DKM, файловую систему с учетными данными учетной записи службы, под управлением в качестве локального администратора

```powershell
Backup-ADFS -StorageType "FileSystem" -StoragePath "C:\Users\administrator\testExport\" -EncryptionPassword "password" -BackupComment "Clean Install of ADFS (FS)" -BackupDKM -ServiceAccountCredential $cred
```

### <a name="backup-the-ad-fs-configuration-without-the-dkm-to-the-azure-storage-container"></a>Создайте резервную копию конфигурации AD FS без DKM в контейнер хранилища Azure.

```powershell
Backup-ADFS -StorageType "Azure" -AzureConnectionCredentials $cred -AzureStorageContainer "adfsbackups"  -EncryptionPassword "password" -BackupComment "Clean Install of ADFS"
```

### <a name="backup-the-ad-fs-configuration-without-the-dkm-to-the-file-system"></a>Создать резервную копию конфигурации AD FS без DKM в файловой системе

```powershell   
Backup-ADFS -StorageType "FileSystem" -StoragePath "C:\Users\administrator\testExport\" -EncryptionPassword "password" -BackupComment "Clean Install of ADFS (FS)"
```

## <a name="restore-from-backup"></a>Восстановление из резервной копии
Чтобы применить конфигурацию, созданных с помощью ADFS резервного копирования в новую установку AD FS, используйте командлет Restore-служб федерации Active Directory.

Этот командлет создает новую ферму AD FS с помощью командлета `Install-AdfsFarm` и восстанавливает конфигурацию AD FS, базы данных, сертификаты, и т.д.  Если на сервере не установлена роль AD FS, он будет установлен в командлет.  Командлет проверяет расположение для восстановления с существующими резервными копиями и пользователю будет предложено выбрать соответствующую резервную копию на основе даты и времени создания и любые примечания к резервной копии, пользователь может были присоединены к резервной копии. При наличии нескольких конфигураций службы федерации Active Directory с именами служб различных федерации, пользователю предлагается выбрать соответствующую конфигурацию AD FS.
Пользователь должен иметь права администратора как в локальных, так и в домене для выполнения этого командлета.


>[!NOTE] 
>Прежде чем использовать средство быстрого восстановления AD FS, убедитесь, что сервер подключен к домену до восстановления из резервной копии. 

Командлет принимает следующие параметры: 

![Средство ускоренного восстановления AD FS](media/AD-FS-Rapid-Restore-Tool/parameter2.png)

### <a name="detailed-description"></a>Подробное описание

- **StorageType &lt;строка&gt;**  -тип хранилища, пользователю нужно использовать.
 «Файловая система» указывает, что пользователь хочет сохранить его в папке локально или в сети «Azure» указывает, что пользователь хочет сохранить его в контейнер хранилища Azure

- **DecryptionPassword &lt;строка&gt;**  -пароль, который был использован для шифрования всех резервных копий файлов 

- **AzureConnectionCredentials &lt;pscredential&gt;**  -имя учетной записи и ключ учетной записи хранения Azure

- **AzureStorageContainer &lt;строка&gt;**  -контейнер хранилища, где будут храниться резервная копия в Azure

- **StoragePath &lt;строка&gt;**  -расположение резервные копии будут храниться в

- **ADFSName &lt; строка &gt;**  -имя федерации, который резервного копирования и требуется восстановить. Если этот параметр не указан и имеется только одно Указание, то это будет использоваться. Если имеется более одной службы федерации, резервные копии в расположение, а затем пользователю предлагается выбрать один из резервных копий службы федерации.

- **ServiceAccountCredential &lt; pscredential &gt;**  -указывает, будет использоваться для новой службы AD FS восстанавливаемой учетной записи службы 

- **GroupServiceAccountIdentifier &lt;строка&gt;**  -групповой управляемой учетной записи, пользователю нужно использовать для новой службы AD FS выполняется восстановление. По умолчанию Если ни один затем резервные копии имя учетной записи используется, если он был GMSA, else пользователю предлагается в учетной записи службы

- **DBConnectionString &lt;строка&gt;**  — Если пользователь хочет использовать разные базы данных для восстановления, то они должны передать строку подключения SQL или тип внутренней базы данных Windows для WID.

- **Force &lt;bool&gt;**  -пропустить запросах, которые могут иметь средство после выбора резервного копирования

- **RestoreDKM &lt;bool&gt;**  — восстановление контейнер DKM в AD, следует задавать, если планируется создание AD и DKM была создана резервная изначально.

## <a name="restore-examples"></a>Примеры применения команды RESTORE

### <a name="restore-the-ad-fs-configuration-without-the-dkm-from-the-azure-storage-container"></a>Восстановление конфигурации AD FS без DKM из контейнера хранилища Azure

```powershell
Restore-ADFS -StorageType "Azure" -AzureConnectionCredential $cred -DecryptionPassword "password" -AzureStorageContainer "adfsbackups"
```

### <a name="restore-the-ad-fs-configuration-without-the-dkm-from-the-file-system"></a>Восстановить конфигурацию AD FS без DKM из файловой системы
 
```powershell
Restore-ADFS -StorageType "FileSystem" -StoragePath "C:\uSERS\administrator\testExport\" -DecryptionPassword "password"
```

### <a name="restore-the-ad-fs-configuration-with-the-dkm-to-the-file-system"></a>Восстановить конфигурацию AD FS с помощью DKM в файловой системе 
 
```powershell
Restore-ADFS -StorageType "FileSystem" -StoragePath "C:\uSERS\administrator\testExport\" -DecryptionPassword "password" -RestoreDKM
```

### <a name="restore-the-ad-fs-configuration-to-wid"></a>Восстановление конфигурации AD FS WID

```powershell
Restore-ADFS -StorageType "FileSystem" -StoragePath "C:\uSERS\administrator\testExport\" -DecryptionPassword "password" -DBConnectionString "WID"
``` 

### <a name="restore-the-ad-fs-configuration-to-sql"></a>Восстановление конфигурации AD FS для SQL

```powershell
Restore-ADFS -StorageType "FileSystem" -StoragePath "C:\uSERS\administrator\testExport\" -DecryptionPassword "password" -DBConnectionString "Data Source=TESTMACHINE\SQLEXPRESS; Integrated Security=True"
```

### <a name="restores-the-ad-fs-configuration-with-the-specified-gmsa"></a>Восстанавливает конфигурацию AD FS с помощью указанного групповой управляемой учетной записи

```powershell
Restore-ADFS -StorageType "FileSystem" -StoragePath "C:\uSERS\administrator\testExport\" -DecryptionPassword "password" -GroupServiceAccountIdentifier "mangupd1\adfsgmsa$"
```
### <a name="restore-the-ad-fs-configuration-with-the-specified-service-account-creds"></a>Восстановление конфигурации AD FS с указанной службы учетные данные учетной записи

```powershell
Restore-ADFS -StorageType "FileSystem" -StoragePath "C:\uSERS\administrator\testExport\" -DecryptionPassword "password" -ServiceAccountCredential $cred
```

## <a name="encryption-information"></a>Сведения о шифровании
Все данные резервных копий, шифруется перед публикацией в облаке или сохранив его в файловой системе.  

Каждый документ, который создается в процессе резервного копирования, шифруется с помощью AES-256. Пароль, передаваемые в средство служит парольную фразу, чтобы создать новый пароль, используя класс Rfc2898DeriveBytes. 

RngCryptoServiceProvider используется для создания случайные данные, используемые AES и класс Rfc2898DeriveBytes. 

## <a name="log-files"></a>Файлы журналов
Каждый раз при выполнении резервного копирования или восстановления создается файл журнала. Их можно найти по следующему адресу:

- **%LocalAppData%\ADFSRapidRecreationTool**

>[!NOTE]
> При выполнении восстановления, может создать файл PostRestore_Instructions обзором дополнительной проверки подлинности поставщиков хранилищ атрибутов, и отношения доверия поставщиков утверждений локального нужно установить вручную перед запуском службы AD FS.

## <a name="version-release-history"></a>Журнал выпуска версий

### <a name="version-10820"></a>Версия 1.0.82.0
Выпуск: Июль 2019 г.

**Исправленные проблемы:**
- Исправление ошибки для службы федерации Active Directory службы имена учетных записей, которые содержат escape-символы LDAP


### <a name="version-10810"></a>Версия: 1.0.81.0
Выпуск: Апрель 2019 г.

**Исправленные проблемы:**


- Исправления ошибок для сертификатов резервного копирования и восстановления
- Дополнительные сведения трассировки в файл журнала


### <a name="version-10750"></a>Версия: 1.0.75.0
Выпуск: Август 2018 г.

**Исправленные проблемы:**
* Обновите ADFS резервной копии, если с параметром - BackupDKM.  Средство определит, если текущий контекст имеет доступ к контейнеру DKM.  Если Да, не потребуется привилегии администратора домена или учетные данные учетной записи службы.  Это позволяет автоматически создаваемых резервных копий происходит без явного предоставления учетных данных или функционирует как учетная запись администратора домена.

### <a name="version-10730"></a>Версия: 1.0.73.0
Выпуск: Август 2018 г.

**Исправленные проблемы:**
* Обновить алгоритмы шифрования, чтобы приложение является FIPS-совместимым
    
    >[!NOTE]
    > Старые резервные копии не будет работать с новой версией из-за изменений в алгоритмах шифрования в соответствии с соответствия FIPS
    
* Добавлена поддержка кластеров SQL, использующих репликации слиянием

### <a name="version-10720"></a>Версия: 1.0.72.0
Выпуск: Июля 2018 г.

**Исправленные проблемы:**

   - Исправление ошибки: Исправлена. Установщик MSI для поддержки обновления на месте 

### <a name="10180"></a>1.0.18.0
Выпуск: Июля 2018 г.

**Исправленные проблемы:**

   - Исправление: обрабатывать пароли учетной записи службы, которые имеют специальные символы в их (т. е, «&»)
   - Исправление: восстановление завершится ошибкой, так как Microsoft.IdentityServer.Servicehost.exe.config уже используется другим процессом


### <a name="1000"></a>1.0.0.0
Дата выпуска: Октябрь, 2016 г.

Первоначальный выпуск средство быстрого восстановления AD FS
