---
ms.assetid: 4deff06a-d0ef-4e5a-9701-5911ba667201
title: Средство ускоренного восстановления AD FS
author: billmath
ms.author: billmath
manager: femila
ms.date: 04/24/2019
ms.topic: article
ms.openlocfilehash: cb95a3eb85132ee5d5f3b40536364ebd0f58b40a
ms.sourcegitcommit: 3181fcb69a368f38e0d66002e8bc6fd9628b1acc
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/30/2020
ms.locfileid: "96330466"
---
# <a name="ad-fs-rapid-restore-tool"></a>Средство ускоренного восстановления AD FS

## <a name="overview"></a>Общие сведения

Сегодня AD FS обеспечивает высокую доступность, настроив ферму AD FS. В некоторых организациях можно было бы использовать один сервер AD FS развертывания, устраняя необходимость в нескольких AD FS серверах и инфраструктуре балансировки сетевой нагрузки, в то же время предоставляя некоторые гарантии того, что служба может быть быстро восстановлена в случае возникновения проблемы.
Новое средство быстрого восстановления AD FS позволяет восстановить данные AD FS, не требуя полного резервного копирования и восстановления операционной системы или состояния системы. Вы можете использовать новое средство для экспорта AD FS конфигурации в Azure или в локальное расположение.  Затем можно применить экспортированные данные к новой AD FS установки, повторному созданию или дублированию среды AD FS.

## <a name="scenarios"></a>Сценарии

Средство быстрого восстановления AD FS можно использовать в следующих сценариях:

1. Быстрое восстановление AD FS функциональности после возникновения проблемы
    - С помощью этого средства можно создать незащищенную резервную копию AD FS, которая может быть быстро развернута вместо сервера AD FS в сети
2. Развертывание идентичных тестовых и рабочих сред
    - С помощью этого средства можно быстро создать точную копию рабочего AD FS в тестовой среде или быстро развернуть проверенную конфигурацию теста в рабочую среду.
3. Миграция из конфигурации на основе SQL в WID и наоборот
    - Используйте средство для перехода с конфигурации фермы на основе SQL на WID или наоборот.


> [!NOTE]
> Если используется репликация слиянием SQL или группы Always on доступность, средство быстрого восстановления не поддерживается. В качестве альтернативы рекомендуется использовать резервные копии на основе SQL и резервную копию SSL-сертификата.

## <a name="what-is-backed-up"></a>Что такое резервное копирование

Средство создает резервную копию следующей конфигурации AD FS

- База данных конфигурации AD FS (SQL или WID)
- Файл конфигурации (находится в папке AD FS)
- Автоматически созданные маркеры подписи и расшифровки сертификатов и закрытые ключи (из контейнера DKM Active Directory)
- SSL-сертификат и все внешние зарегистрированные сертификаты (подпись маркера, расшифровка маркера и связь со службой) и соответствующие закрытые ключи (Примечание. закрытые ключи должны быть доступны для экспорта, а пользователь, выполняющий сценарий, должен иметь разрешения на доступ к ним).
- Список установленных настраиваемых поставщиков проверки подлинности, хранилищ атрибутов и локальных отношений доверия поставщиков утверждений.

## <a name="how-to-use-the-tool"></a>Использование средства

Сначала [Скачайте](https://go.microsoft.com/fwlink/?LinkId=825646) и установите MSI на сервер AD FS.

Выполните следующую команду в командной строке PowerShell:

```powershell
import-module 'C:\Program Files (x86)\ADFS Rapid Recreation Tool\ADFSRapidRecreationTool.dll'
```

> [!NOTE]
> Если используется встроенная база данных Windows (WID), это средство необходимо запустить на сервере-источнике AD FS.  С помощью `Get-AdfsSyncProperties` командлета PowerShell можно определить, является ли сервер сервером-источником.

### <a name="system-requirements"></a>Требования к системе

- Это средство работает для AD FS в Windows Server 2012 R2 и более поздних версий.
- Требуемая версия .NET Framework — не менее 4,0.
- Восстановление должно выполняться на AD FS сервере той же версии, что и резервная копия, и использует ту же учетную запись Active Directory, что и учетная запись AD FS службы.

## <a name="create-a-backup"></a>Создание резервной копии

Чтобы создать резервную копию, используйте командлет Backup-ADFS. Этот командлет создает резервную копию конфигурации AD FS, базы данных, SSL-сертификатов и т. д.

Для выполнения этого командлета пользователь должен быть по крайней мере локальным администратором.
Чтобы создать резервную копию контейнера DKM Active Directory (требуется в конфигурации AD FS по умолчанию), пользователь должен быть администратором домена, должен передать учетные данные учетной записи AD FS службы или иметь доступ к контейнеру DKM.  Если используется учетная запись gMSA, пользователь должен быть администратором домена или иметь разрешения на доступ к контейнеру. Вы не можете указать учетные данные gMSA.

Имя резервной копии будет называться в соответствии с шаблоном "adfsBackup_ID_Date-Time". Он будет содержать номер версии, дату и время, когда была выполнена резервная копия.
Командлет принимает следующие параметры:

Наборы параметров

![Средство ускоренного восстановления AD FS](media/AD-FS-Rapid-Restore-Tool/parameter1.png)

### <a name="detailed-description"></a>Подробное описание

- **Баккупдкм** — создает резервную копию контейнера DKM Active Directory, который содержит ключи AD FS в конфигурации по умолчанию (автоматически создаваемые подписи маркеров и расшифровки сертификатов). Для экспорта контейнера AD и всех его поддеревьев используется инструмент AD "ldifde".

- -**&lt; Строка &gt; StorageType** — тип хранилища, который пользователь хочет использовать.
"FileSystem" указывает, что пользователь хочет сохранить его в папке локально или в сети "Azure". Это означает, что пользователь хочет сохранить его в контейнере хранилища Azure, когда пользователь выполняет резервное копирование, и выбирает расположение резервной копии: файловая система или в облаке.
Для использования Azure учетные данные службы хранилища Azure должны передаваться в командлет. Учетные данные хранения содержат имя и ключ учетной записи. Кроме того, имя контейнера также должно передаваться в. Если контейнер не существует, он создается во время резервного копирования.
Чтобы использовать файловую систему, необходимо указать путь к хранилищу. В этом каталоге для каждой резервной копии будет создан новый каталог. Каждый созданный каталог будет содержать резервные файлы.

- **Енкриптионпассворд &lt; String &gt;** — пароль, который будет использоваться для шифрования всех файлов, сохраненных в резервной копии, перед сохранением.

- **Азуреконнектионкредентиалс &lt; PSCredential &gt;** — имя учетной записи и ключ для учетной записи хранения Azure.

- **AzureStorageContainer &lt; String &gt;** — контейнер хранилища, в котором будет храниться резервная копия в Azure.

- **Сторажепас &lt; строка &gt;** — расположение, в котором будут храниться резервные копии

- **Сервицеаккаунткредентиал &lt; PSCredential &gt;** — указывает учетную запись службы, используемую для службы AD FS, выполняющейся в данный момент. Этот параметр необходим только в том случае, если пользователь хочет создать резервную копию DKM и не является администратором домена или не имеет доступа к содержимому контейнера.

- **Баккупкоммент &lt; String [] &gt;** — информационная строка о резервной копии, которая будет отображаться во время восстановления, аналогично концепции именования контрольных точек Hyper-V. Значение по умолчанию — пустая строка.


## <a name="backup-examples"></a>Примеры резервного копирования

Ниже приведены примеры резервного копирования для использования средства быстрого восстановления AD FS.

### <a name="backup-the-ad-fs-configuration-with-the-dkm-to-the-file-system-and-has-access-to-the-dkm-container-contents-either-domain-admin-or-delegated"></a>Резервное копирование конфигурации AD FS, с DKM, в файловую систему и доступ к содержимому контейнера DKM (администратор домена или делегированный)

```powershell
Backup-ADFS -StorageType "FileSystem" -StoragePath "C:\Users\administrator\testExport\" -EncryptionPassword "password" -BackupComment "Clean Install of ADFS (FS)" -BackupDKM
```

### <a name="backup-the-ad-fs-configuration-with-the-dkm-to-the-file-system-with-the-service-account-credential-running-as-local-admin"></a>Создайте резервную копию конфигурации AD FS с DKM в файловой системе с учетными данными учетной записи службы, работающей от имени локального администратора.

```powershell
Backup-ADFS -StorageType "FileSystem" -StoragePath "C:\Users\administrator\testExport\" -EncryptionPassword "password" -BackupComment "Clean Install of ADFS (FS)" -BackupDKM -ServiceAccountCredential $cred
```

### <a name="backup-the-ad-fs-configuration-without-the-dkm-to-the-azure-storage-container"></a>Создайте резервную копию конфигурации AD FS без DKM в контейнере хранилища Azure.

```powershell
Backup-ADFS -StorageType "Azure" -AzureConnectionCredentials $cred -AzureStorageContainer "adfsbackups"  -EncryptionPassword "password" -BackupComment "Clean Install of ADFS"
```

### <a name="backup-the-ad-fs-configuration-without-the-dkm-to-the-file-system"></a>Резервное копирование конфигурации AD FS без DKM в файловую систему

```powershell
Backup-ADFS -StorageType "FileSystem" -StoragePath "C:\Users\administrator\testExport\" -EncryptionPassword "password" -BackupComment "Clean Install of ADFS (FS)"
```

## <a name="restore-from-backup"></a>Восстановление из резервной копии

Чтобы применить конфигурацию, созданную с помощью Backup-ADFS, в новую AD FS установки, используйте командлет Restore-ADFS.

Этот командлет создает новую ферму AD FS с помощью командлета `Install-AdfsFarm` и восстанавливает конфигурацию AD FS, базу данных, сертификаты и т. д.  Если роль AD FS не была установлена на сервере, командлет установит ее.  Командлет проверяет расположение восстановления для существующих резервных копий и предлагает пользователю выбрать подходящую резервную копию в зависимости от даты и времени, когда она была сделана, и любого комментария к резервной копии, который пользователь мог присоединить к резервной копии. Если существует несколько AD FS конфигураций с разными именами служб федерации, то пользователю предлагается сначала выбрать соответствующую конфигурацию AD FS.
Для запуска этого командлета пользователь должен быть как локальным, так и администратором домена.


> [!NOTE]
> Перед использованием средства быстрого восстановления AD FS убедитесь, что сервер присоединен к домену перед восстановлением резервной копии.

Командлет принимает следующие параметры:

![Средство ускоренного восстановления AD FS](media/AD-FS-Rapid-Restore-Tool/parameter2.png)

### <a name="detailed-description"></a>Подробное описание

- **&lt; Строка &gt; StorageType** — тип хранилища, который пользователь хочет использовать.
 "FileSystem" указывает, что пользователь хочет сохранить его в папке локально или в сети "Azure". Это означает, что пользователь хочет сохранить его в контейнере хранилища Azure.

- **Декриптионпассворд &lt; String &gt;** — пароль, который использовался для шифрования всех резервных копий файлов.

- **Азуреконнектионкредентиалс &lt; PSCredential &gt;** — имя учетной записи и ключ для учетной записи хранения Azure.

- **AzureStorageContainer &lt; String &gt;** — контейнер хранилища, в котором будет храниться резервная копия в Azure.

- **Сторажепас &lt; строка &gt;** — расположение, в котором будут храниться резервные копии

- **Адфснаме &lt; String &gt;** — имя Федерации, для которого была создана резервная копия, которая будет восстановлена. Если он не указан и имеется только одно имя службы федерации, то будет использоваться. Если в расположение имеется несколько резервных копий службы федерации, пользователю предлагается выбрать одну из резервных копий служб федерации.

- **Сервицеаккаунткредентиал &lt; PSCredential &gt;** — указывает учетную запись службы, которая будет использоваться для восстанавливаемой новой службы AD FS

- **Граупсервицеаккаунтидентифиер &lt; String &gt;** — GMSA, который пользователь хочет использовать для восстановления новой службы AD FS. По умолчанию, если ни одно из них не указано, используется имя учетной записи резервной копии, если оно было GMSAо, иначе пользователю будет предложено ввести учетную запись службы.

- **&lt; Строка &gt; дбконнектионстринг** . Если пользователь хочет использовать другую базу данных для восстановления, он должен передать строку подключения SQL или тип в WID для WID.

- **Force &lt; bool &gt;** — пропуск запросов, которые может иметь средство после создания резервной копии.

- **Ресторедкм &lt; bool &gt;** — восстановите контейнер DKM в Active Directory, если вы переходите к новому рекламному объявлению и изначально выполнялось резервное копирование DKM.

## <a name="restore-examples"></a>Примеры восстановления

### <a name="restore-the-ad-fs-configuration-without-the-dkm-from-the-azure-storage-container"></a>Восстановление конфигурации AD FS без DKM из контейнера хранилища Azure

```powershell
Restore-ADFS -StorageType "Azure" -AzureConnectionCredential $cred -DecryptionPassword "password" -AzureStorageContainer "adfsbackups"
```

### <a name="restore-the-ad-fs-configuration-without-the-dkm-from-the-file-system"></a>Восстановление конфигурации AD FS без DKM из файловой системы

```powershell
Restore-ADFS -StorageType "FileSystem" -StoragePath "C:\Users\administrator\testExport\" -DecryptionPassword "password"
```

### <a name="restore-the-ad-fs-configuration-with-the-dkm-to-the-file-system"></a>Восстановление конфигурации AD FS с помощью DKM в файловую систему

```powershell
Restore-ADFS -StorageType "FileSystem" -StoragePath "C:\Users\administrator\testExport\" -DecryptionPassword "password" -RestoreDKM
```

### <a name="restore-the-ad-fs-configuration-to-wid"></a>Восстановление конфигурации AD FS в WID

```powershell
Restore-ADFS -StorageType "FileSystem" -StoragePath "C:\Users\administrator\testExport\" -DecryptionPassword "password" -DBConnectionString "WID"
```

### <a name="restore-the-ad-fs-configuration-to-sql"></a>Восстановление конфигурации AD FS в SQL

```powershell
Restore-ADFS -StorageType "FileSystem" -StoragePath "C:\Users\administrator\testExport\" -DecryptionPassword "password" -DBConnectionString "Data Source=TESTMACHINE\SQLEXPRESS; Integrated Security=True"
```

### <a name="restores-the-ad-fs-configuration-with-the-specified-gmsa"></a>Восстанавливает конфигурацию AD FS с указанным GMSA

```powershell
Restore-ADFS -StorageType "FileSystem" -StoragePath "C:\Users\administrator\testExport\" -DecryptionPassword "password" -GroupServiceAccountIdentifier "mangupd1\adfsgmsa$"
```
### <a name="restore-the-ad-fs-configuration-with-the-specified-service-account-creds"></a>Восстановление конфигурации AD FS с указанными учетными данными службы

```powershell
Restore-ADFS -StorageType "FileSystem" -StoragePath "C:\Users\administrator\testExport\" -DecryptionPassword "password" -ServiceAccountCredential $cred
```

## <a name="encryption-information"></a>Сведения о шифровании

Все резервные данные шифруются перед их передачей в облако или при хранении в файловой системе.

Каждый документ, создаваемый как часть резервной копии, шифруется с помощью AES-256. Пароль, передаваемый в средство, используется в качестве контрольной фразы для создания нового пароля с помощью класса Rfc2898DeriveBytes.

RngCryptoServiceProvider используется для создания расширяющего значения, используемого AES и классом Rfc2898DeriveBytes.

## <a name="log-files"></a>Файлы журнала

При каждом создании резервной копии или восстановления создается файл журнала. Их можно найти в следующем расположении:

- **%локалаппдата%\адфсрапидрекреатионтул**

> [!NOTE]
> При выполнении восстановления может быть создан файл PostRestore_Instructions, содержащий общие сведения о дополнительных поставщиках проверки подлинности, хранилищах атрибутов и локальных отношениях доверия поставщика утверждений для установки вручную перед запуском службы AD FS.

## <a name="version-release-history"></a>Журнал выпуска версий

### <a name="version-10823"></a>Версия 1.0.82.3

Выпуск: Апрель 2020

**Исправленные проблемы:**

- Добавлена поддержка сертификатов на основе CNG.


### <a name="version-10820"></a>Версия 1.0.82.0

Выпуск: Июль 2019

**Исправленные проблемы:**

- Исправление ошибки для AD FS имен учетных записей служб, содержащих escape-символы LDAP


### <a name="version-10810"></a>Версия: 1.0.81.0

Выпуск: Апрель 2019

**Исправленные проблемы:**

- Исправления ошибок для резервного копирования и восстановления сертификатов
- Дополнительные сведения о трассировке в файле журнала


### <a name="version-10750"></a>Версия: 1.0.75.0

Выпуск: Август 2018

**Исправленные проблемы:**

* Обновление Backup — ADFS при использовании параметра-Баккупдкм.  Средство определит, имеет ли текущий контекст доступ к контейнеру DKM.  В этом случае не требуются права администратора домена или учетные данные учетной записи службы.  Это позволяет автоматически создавать резервные копии без явного предоставления учетных данных или запуска от имени учетной записи администратора домена.

### <a name="version-10730"></a>Версия: 1.0.73.0

Выпуск: Август 2018

**Исправленные проблемы:**

* Обновите алгоритмы шифрования, чтобы приложение соответствовало стандарту FIPS.

    > [!NOTE]
    > Старые резервные копии не будут работать с новой версией из-за изменений в алгоритмах шифрования согласно требованиям FIPS

* Добавлена поддержка кластеров SQL, использующих репликацию слиянием

### <a name="version-10720"></a>Версия: 1.0.72.0

Выпуск: Июль 2018

**Исправленные проблемы:**

- Исправление ошибки. Исправлено. Установщик MSI для поддержки обновлений на месте

### <a name="10180"></a>1.0.18.0

Выпуск: Июль 2018

**Исправленные проблемы:**

- Исправление ошибки: обработчики паролей учетных записей служб, которые имеют специальные символы (IE, "&")
- Исправление ошибки. Восстановление завершается сбоем, так как Microsoft.IdentityServer.Servicehost.exe.config используется другим процессом.


### <a name="1000"></a>1.0.0.0

Дата выпуска: Октябрь 2016

Первоначальный выпуск средства быстрого восстановления AD FS
