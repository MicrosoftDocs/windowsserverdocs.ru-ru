---
title: Настройка развертывания AD FS с помощью группы доступности AlwaysOn
author: billmath
ms.author: billmath
manager: daveba
ms.date: 01/20/2020
ms.topic: article
ms.prod: windows-server
ms.technology: identity-adfs
ms.openlocfilehash: ddec398be56aba6d354b1863a98c8d641831415c
ms.sourcegitcommit: b00d7c8968c4adc8f699dbee694afe6ed36bc9de
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/08/2020
ms.locfileid: "80816097"
---
# <a name="setting-up-an-ad-fs-deployment-with-alwayson-availability-groups"></a>Настройка развертывания AD FS с помощью группы доступности AlwaysOn
Географическая распределенная топология предоставляет следующие возможности.
* Устранение единственной точки отказа: с возможностями отработки отказа можно достичь высокодоступной инфраструктуры ADFS, даже если один из центров обработки данных в части земного шара выходит из строя.
* Улучшенная производительность. Предлагаемое развертывание можно использовать для обеспечения высокопроизводительной инфраструктуры ADFS.

AD FS можно настроить для высокодоступного географического распределенного сценария.
В следующем руководстве приводится обзор AD FS с группами доступности SQL AlwaysOn, а также рекомендации по развертыванию и рекомендации.

## <a name="overview---alwayson-availability-groups"></a>Обзор — группы доступности AlwaysOn

Дополнительные сведения о группах доступности AlwaysOn см. в разделе [обзор группы доступности AlwaysOn (SQL Server)](https://technet.microsoft.com/library/ff877884.aspx) .

С точки зрения узлов фермы AD FS SQL Server группа доступности AlwaysOn заменяет один экземпляр SQL Server в качестве базы данных политик или артефактов.  Прослушиватель группы доступности использует клиент (служба маркеров безопасности AD FS) для подключения к SQL.
На следующей схеме показана ферма SQL Server AD FS с группой доступности AlwaysOn.

![ферма серверов, использующая SQL](media/ad-fs-always-on/SQLoverview.png)

Группа доступности Always On (AG) — это одна или несколько пользовательских баз данных, совместно отключающих отработку отказа. Группа доступности состоит из первичной реплики доступности и от одной до четырех вторичных реплик, поддерживаемых с помощью SQL Server перемещения данных на основе журналов для защиты данных без необходимости в общем хранилище. Каждая реплика размещается экземпляром SQL Server на другом узле WSFC. Группа доступности и соответствующее имя виртуальной сети регистрируются в качестве ресурсов в кластере WSFC.

Прослушиватель группы доступности на узле первичной реплики отвечает на входящие клиентские запросы на подключение к имени виртуальной сети и на основе атрибутов в строке подключения перенаправляет каждый запрос в соответствующий экземпляр SQL Server.
В случае отработки отказа вместо того, чтобы передавать владение общими физическими ресурсами другому узлу, кластер WSFC использует для повторной настройки вторичной реплики на другом экземпляре SQL Server, чтобы стать первичной репликой группы доступности. Затем ресурс имени виртуальной сети группы доступности передается в этот экземпляр.
В любой момент времени только один экземпляр SQL Server может размещать первичную реплику баз данных группы доступности, все связанные вторичные реплики должны находиться в отдельном экземпляре, и каждый экземпляр должен находиться на разных физических узлах.

> [!NOTE] 
> Если компьютеры работают в Azure, настройте виртуальные машины Azure, чтобы включить конфигурацию прослушивателя для взаимодействия с группами доступности AlwaysOn. Дополнительные сведения о [виртуальных машинах: прослушиватель SQL Always on](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-portal-sql-alwayson-int-listener).

Дополнительные сведения о группы доступности AlwaysOn см. в разделе [Обзор групп доступности Always On (SQL Server)](https://docs.microsoft.com/sql/database-engine/availability-groups/windows/overview-of-always-on-availability-groups-sql-server?view=sql-server-ver15).

> [!NOTE] 
> Если для организации требуется отработка отказа в нескольких центрах обработки данных, рекомендуется создать на каждом из центров обработки и в каждом из них базу, а также включить кэш в фоновом режиме, что сокращает задержку во время обработки запроса. Следуйте инструкциям, чтобы выполнить [точную настройку SQL и сократить задержку](https://docs.microsoft.com/windows-server/identity/ad-fs/operations/adfs-sql-latency).

## <a name="deployment-guidance"></a>Руководство по развертыванию

1. <b>Рассмотрим правильную базу данных для целей развертывания AD FS.</b> AD FS использует базу данных для хранения конфигурации и в некоторых случаях данные о транзакциях, связанные с служба федерации. Вы можете использовать AD FS программное обеспечение, чтобы выбрать либо встроенную базу данных Windows (WID), либо Microsoft SQL Server 2008 или более поздней версии для хранения данных в службе Федерации.
В следующей таблице описаны различия в поддерживаемых возможностях между WID и базой данных SQL.


| Категория      | Функция       | Поддерживается WID  | Поддерживается SQL |
| ------------------ |:-------------:| :---:|:---: |
| AD FS функции     | Развертывание фермы серверов федерации | Да  | Да |
| AD FS функции     | Разрешение артефактов SAML. Примечание. это не распространено для приложений SAML.     |   Нет | Нет  |
| AD FS функции | Обнаружение воспроизведения токенов SAML/WS-Federation. Примечание. требуется только тогда, когда AD FS получает маркеры от внешнего поставщиков удостоверений. Это не требуется, если AD FS не выступает в качестве IDP.      |    Нет  | Да |
| Функции базы данных     |   Базовая избыточность базы данных с использованием опрашивающей репликации, в которой один или несколько серверов, на которых размещается копия запроса к базе данных, доступная только для чтения, внесенные на исходном сервере, доступны для чтения и записи базы данных.    |   Нет | Нет  |
| Функции базы данных | Избыточность базы данных с помощью решений высокого уровня доступности, таких как кластеризация или зеркальное отображение (на уровне базы данных).      |    Нет  | Да |

Если вы являетесь крупной организацией с более чем 100 доверительными отношениями, которым необходимо предоставить доступ как внутренним пользователям, так и внешним пользователям с помощью единого входа для приложений или служб федерации, SQL является рекомендуемым вариантом.

Если вы являетесь организацией с 100 или меньше настроенными отношениями доверия, WID предоставляет избыточность данных и службы федерации (где каждый сервер федерации реплицирует изменения на другие серверы федерации в той же ферме). WID не поддерживает определение воспроизведения маркеров или разрешение артефактов и имеет ограничение в 30 серверов федерации.
Дополнительные сведения о планировании развертывания см. [здесь](https://docs.microsoft.com/windows-server/identity/ad-fs/design/planning-your-deployment).

## <a name="sql-server-high-availability-solutions"></a>SQL Server решения для обеспечения высокого уровня доступности
При использовании SQL Server в качестве базы данных конфигурации AD FS можно настроить геоизбыточность для фермы AD FS с помощью SQL Server репликации. Геоизбыточность реплицирует данные между двумя географически отдаленными сайтами, чтобы приложения могли переключаться с одного сайта на другой. Таким образом, в случае сбоя одного сайта все данные конфигурации можно будет получить на втором сайте. 
Если SQL является соответствующей базой данных для целей развертывания, перейдите к руководству по развертыванию.

В этом руководстве рассматриваются следующие этапы.
* Развертывание AD FS
* Настройка AD FS для использования группы доступности AlwaysOn
* Установка роли отказоустойчивой кластеризации
* Выполнение тестов проверки кластера
* Включение Always On групп доступности
* Резервное копирование баз данных AD FS
* Создание групп доступности AlwaysOn
* Добавление баз данных на второй узел
* Присоединение реплики доступности к группам доступности
* Обновление строки подключения SQL

## <a name="deploy-ad-fs"></a>Развертывание AD FS

> [!NOTE] 
> Если компьютеры работают в Azure, виртуальные машины должны быть настроены таким образом, чтобы прослушиватель мог взаимодействовать с группой Always On факсов. Дополнительные сведения о настройке см. в [подсистеме балансировки нагрузки для группы доступности на виртуальных машинах Azure SQL Server](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-portal-sql-alwayson-int-listener)


В этом руководством по развертыванию в качестве примера будет показана ферма из двух узлов с двумя серверами SQL Server.
Чтобы развернуть AD FS перейдите по исходным ссылкам ниже, чтобы установить службу роли AD FS. Чтобы настроить для группы AoA, необходимо выполнить дополнительные действия для этой роли.
-   [Присоединение компьютера к домену](https://docs.microsoft.com/windows-server/identity/ad-fs/deployment/join-a-computer-to-a-domain)
-   [Регистрация SSL-сертификата для AD FS](https://docs.microsoft.com/windows-server/identity/ad-fs/deployment/enroll-an-ssl-certificate-for-ad-fs)
-   [Установка службы ролей AD FS](https://docs.microsoft.com/windows-server/identity/ad-fs/deployment/install-the-ad-fs-role-service)


## <a name="configuring-ad-fs-to-use-an-alwayson-availability-group"></a>Настройка AD FS для использования группы доступности AlwaysOn

Настройка фермы AD FS с группами доступности AlwaysOn требует внесения незначительных изменений в процедуру развертывания AD FS. Убедитесь, что на каждом экземпляре сервера работает одна и та же версия SQL. Полный список предварительных требований, ограничений и рекомендаций для группы доступности Always On можно узнать [здесь](https://docs.microsoft.com/sql/database-engine/availability-groups/windows/prereqs-restrictions-recommendations-always-on-availability?view=sql-server-2017#PrerequisitesForDbs).

1.  Прежде чем можно будет настроить группы доступности AlwaysOn, необходимо создать базы данных, для которых требуется создать резервную копию.  AD FS создает свои базы данных в процессе установки и первоначальной настройки первого узла службы федерации новой фермы SQL Server AD FS.  Укажите имя узла базы данных для существующей фермы с помощью SQL Server. В рамках конфигурации AD FS необходимо указать строку подключения SQL, поэтому необходимо настроить первую ферму AD FS для прямого подключения к экземпляру SQL (это временное). Конкретные рекомендации по настройке фермы AD FS, включая настройку узла фермы AD FS со строкой подключения SQL Server, см. в разделе [Настройка сервера федерации](https://docs.microsoft.com/windows-server/identity/ad-fs/deployment/configure-a-federation-server).

![Укажите ферму](media/ad-fs-always-on/deploymentSpecifyFarm.png)

2.  Проверьте подключение к базе данных с помощью SSMS и подключитесь к имени узла целевой базы данных. При добавлении другого узла в ферму Федерации подключитесь к целевой базе данных.
3.  Укажите SSL-сертификат для AD FS фермы.

![Укажите SSL-сертификат](media/ad-fs-always-on/deploymentSpecifySSL.png)

4.  Подключите ферму к учетной записи службы или gMSA.

![Укажите учетную запись службы](media/ad-fs-always-on/deploymentSpecifyServiceAccount.png)

5.  Завершите настройку и установку фермы AD FS.

> [!NOTE] 
> SQL Server должны выполняться от имени учетной записи домена для установки групп доступности Always On. По умолчанию он выполняется как локальная система.

## <a name="install-the-failover-clustering-role"></a>Установка роли отказоустойчивой кластеризации
Роль отказоустойчивого кластера Windows Server предоставляет дополнительные сведения о отказоустойчивых кластерах Windows Server,
1.  Запустите диспетчер сервера.
2.  В меню Управление выберите команду Добавить роли и компоненты.
3.  На странице перед началом выполнения нажмите кнопку Далее.
4.  На странице Выбор типа установки выберите Установка на основе ролей или компонентов, а затем нажмите кнопку Далее.
5.  На странице Выбор целевого сервера выберите сервер SQL Server, на котором требуется установить компонент, и нажмите кнопку Далее.

![целевые серверы](media/ad-fs-always-on/clusteringDestinationServer.png)

6.  На странице Выбор ролей сервера нажмите кнопку Далее.
7.  На странице Выбор компонентов установите флажок Отказоустойчивая кластеризация.

![Выбор компонента кластеризации](media/ad-fs-always-on/clusteringFeature.png)

8.  На странице Подтверждение выбранных вариантов установки нажмите кнопку установить.
После установки средства отказоустойчивости кластеров не нужно перезапускать сервер.
9.  После завершения установки нажмите кнопку Закрыть.
10. Повторите эту процедуру на каждом сервере, который необходимо добавить как узел отказоустойчивого кластера.

## <a name="run-cluster-validation-tests"></a>Выполнение тестов проверки кластера
1.  На компьютере, на котором установлены средства управления отказоустойчивыми кластерами из средств удаленного администрирования сервера, или на сервере, на котором установлено средство отказоустойчивости кластеров, запустите диспетчер отказоустойчивости кластеров. Чтобы сделать это на сервере, запустите диспетчер сервера, а затем в меню Сервис выберите диспетчер отказоустойчивости кластеров.
2.  В области диспетчер отказоустойчивости кластеров в разделе Управление выберите проверить конфигурацию.
3.  На странице перед началом выполнения нажмите кнопку Далее.
4.  На странице Выбор серверов или кластера в поле введите имя введите NetBIOS-имя или полное доменное имя сервера, который планируется добавить в качестве узла отказоустойчивого кластера, а затем нажмите кнопку Добавить. Повторите этот шаг для каждого сервера, который нужно добавить. Чтобы добавить несколько серверов одновременно, разделяйте их имена запятой или точкой с запятой. Например, введите имена в формате server1.contoso.com, server2.contoso.com. По завершении нажмите кнопку Далее.

![Выберите серверы изображение](media/ad-fs-always-on/clusterValidationServers.png)

5. На странице Параметры тестирования выберите выполнить все тесты (рекомендуется), а затем нажмите кнопку Далее.
6. На странице Подтверждение нажмите кнопку Далее.
На странице "Проверка" показано состояние выполняющихся тестов.
7. На странице Сводка выполните одно из указанных ниже действий.
- Если результаты показывают, что тесты успешно завершены и конфигурация подходит для кластеризации, и вы хотите создать кластер немедленно, убедитесь, что установлен флажок Создать кластер, использующий проверенные узлы, и нажмите кнопку Готово. Затем перейдите к шагу 4 [процедуры создания отказоустойчивого кластера](https://docs.microsoft.com/windows-server/failover-clustering/create-failover-cluster#create-the-failover-cluster).

![изображение проверки конфигурации](media/ad-fs-always-on/clusterValidationResults.png)

-   Если результаты указывают на наличие предупреждений или сбоев, выберите Просмотреть отчет, чтобы просмотреть сведения и определить, какие проблемы необходимо исправить. Имейте в виду, что предупреждение в результатах определенного проверочного теста указывает на то, что данный аспект отказоустойчивого кластера поддерживается, но может не соответствовать рекомендациям.

> [!NOTE]
> Если получено предупреждение для теста «Проверка постоянного резервирования дисковых пространств», дополнительную информацию см. в записи блога [Предупреждение при проверке отказоустойчивого кластера Windows указывает на то, что диски не поддерживают постоянное резервирование дисковых пространств](https://blogs.msdn.microsoft.com/clustering/2013/05/24/validate-storage-spaces-persistent-reservation-test-results-with-warning/) .
> Подробнее о проверочных тестах оборудования см. в разделе [Проверка оборудования для отказоустойчивого кластера](https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/jj134244(v%3dws.11)).

## <a name="create-the-failover-cluster"></a>Создание отказоустойчивого кластера

Чтобы выполнить это действие, убедитесь в том, что учетная запись пользователя, с помощью которой вы вошли в систему, соответствует требованиям, указанным в подразделе [Проверка предварительных требований](https://docs.microsoft.com/windows-server/failover-clustering/create-failover-cluster#verify-the-prerequisites) этого раздела.
1.  Запустите диспетчер сервера.
2.  В меню Сервис выберите диспетчер отказоустойчивости кластеров.
3.  В области диспетчер отказоустойчивости кластеров в разделе Управление выберите Создать кластер.
Откроется мастер создания кластеров.
4.  На странице перед началом выполнения нажмите кнопку Далее.
5.  Если появится страница Выбор серверов, в поле введите имя введите NetBIOS-имя или полное доменное имя сервера, который планируется добавить в качестве узла отказоустойчивого кластера, а затем нажмите кнопку Добавить. Повторите этот шаг для каждого сервера, который нужно добавить. Чтобы добавить несколько серверов одновременно, разделяйте их имена запятой или точкой с запятой. Например, введите имена в формате server1.contoso.com; server2.contoso.com. По завершении нажмите кнопку Далее.

![Создание кластера и выбор серверов](media/ad-fs-always-on/createClusterServers.png)

> [!NOTE]
> Если вы решили создать кластер сразу после выполнения проверки в [процедуре Проверка конфигурации](https://docs.microsoft.com/windows-server/failover-clustering/create-failover-cluster#validate-the-configuration), страница Выбор серверов не отображается. Проверенные узлы автоматически добавляются в мастер создания кластеров, так что вводить их еще раз не нужно.

6.  Если ранее вы пропустили проверку, появится страница Предупреждение проверки. Настоятельно рекомендуется выполнить проверку кластера. Корпорация Майкрософт поддерживает только те кластеры, которые прошли все проверочные тесты. Чтобы выполнить проверочные тесты, выберите Да, а затем нажмите кнопку Далее. Завершите работу мастера проверки конфигурации, как описано в разделе [Проверка конфигурации](https://docs.microsoft.com/windows-server/failover-clustering/create-failover-cluster#validate-the-configuration).
7.  На странице Точка доступа для администрирования кластера выполните указанные ниже действия.
-   В поле Имя кластера введите имя, которое необходимо использовать для администрирования кластера. Перед этим изучите приведенную ниже информацию.
 -  Во время создания кластера это имя регистрируется в качестве объекта компьютера кластера (также известного как объект имени кластера или CNO) в AD DS. Если для кластера указано имя NetBIOS, объект CNO создается в том же расположении, в котором находятся объекты-компьютеры узлов кластера. Это может быть контейнер "Компьютеры" (по умолчанию) или подразделение.
 -  Чтобы указать другое расположение для CNO, можно ввести различающееся имя подразделения в поле Имя кластера. Например: CN = имя_кластера, OU = Clusters, DC = contoso, DC = com.
 -  Если администратор домена предварительно подготовил CNO в подразделении, отличном от того, в котором размещаются узлы кластера, укажите различающееся имя, предоставленное администратором домена.
- Если на сервере нет сетевого адаптера, настроенного на использование DHCP, для отказоустойчивого кластера необходимо настроить один или несколько статических IP-адресов. Установите флажок напротив каждой сети, которую необходимо использовать для управления кластером. Выберите поле адреса рядом с выбранной сетью, а затем введите IP-адрес, который нужно назначить кластеру. Этот IP-адрес (или адреса) будет связан с именем кластера в службе доменных имен (DNS).
- По завершении нажмите кнопку Далее.

8.  Просмотрите параметры на странице Подтверждение. По умолчанию установлен флажок Добавление всех допустимых хранилищ в кластер. Снимите его в указанных ниже случаях.
-   Хранилище следует настроить позднее.
-   Вы планируете создать кластерные дисковые пространства с помощью диспетчера отказоустойчивости кластеров или командлетов отказоустойчивой кластеризации Windows PowerShell, но еще не создали дисковые пространства в файловых службах и службах хранилища. Подробнее см. в разделе [Развертывание кластерных дисковых пространств](https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/jj822937(v%3dws.11)).
9.  Нажмите кнопку Далее, чтобы создать отказоустойчивый кластер.
10. На странице Сводка убедитесь в том, что отказоустойчивый кластер успешно создан. Если возникли какие либо предупреждения или ошибки, просмотрите сводный вывод или выберите Просмотреть отчет, чтобы просмотреть весь отчет. Нажмите кнопку Готово.
11. Чтобы убедиться в том, что кластер создан, проверьте, указано ли его имя в разделе Диспетчер отказоустойчивости кластеров в дереве навигации. Можно развернуть имя кластера, а затем выбрать элементы в разделе узлы, хранилище или сети, чтобы просмотреть связанные ресурсы.
Имейте в виду, что на успешную репликацию имени кластера в службе DNS может потребоваться некоторое время. После успешной регистрации и репликации DNS при выборе всех серверов в диспетчер сервера имя кластера должно быть указано как сервер с состоянием управляемости в сети.

![Создание кластера завершено](media/ad-fs-always-on/createClusterComplete.png)

## <a name="enable-always-on-availability-groups-with-sql-server-configuration-manager"></a>Включение групп доступности AlwaysOn с диспетчер конфигурации SQL Server

1.  Подключитесь к узлу отказоустойчивого кластера Windows Server (WSFC), на котором размещен экземпляр SQL Server, в котором нужно включить Always On группы доступности.
2.  В меню Пуск последовательно укажите пункты Все программы, Microsoft SQL Server, Средства настройки и выберите пункт диспетчер конфигурации SQL Server.
3.  В диспетчер конфигурации SQL Server щелкните SQL Server службы, щелкните правой кнопкой мыши SQL Server (<instance name>), где <instance name> — имя локального экземпляра сервера, для которого требуется включить Always On группы доступности, и выберите пункт Свойства.
4.  Перейдите на вкладку высокий уровень доступности Always On.
5.  Убедитесь, что поле Имя отказоустойчивого кластера Windows содержит имя локального отказоустойчивого кластера. Если это поле пустое, этот экземпляр сервера сейчас не поддерживает группы доступности Always On. Либо локальный компьютер не является узлом кластера, кластер WSFC остановлен, либо этот выпуск SQL Server, который не поддерживает группы доступности Always On.
6.  Установите флажок Включить Always On групп доступности и нажмите кнопку ОК.
Диспетчер конфигурации SQL Server сохранит внесенные изменения. После этого необходимо вручную перезапустить службу SQL Server. Это позволяет выбрать время перезапуска, которое лучше подходит для бизнес-требований. После перезапуска службы SQL Server Always On будет включена, а свойство сервера IsHadrEnabled будет установлено в значение 1.

![включить AoA](media/ad-fs-always-on/enableAoAGroup.png)

## <a name="back-up-ad-fs-databases"></a>Резервное копирование баз данных AD FS
Создайте резервную копию AD FS конфигурации и баз данных артефактов с полными журналами транзакций. Поместите резервную копию в выбранное место назначения.
Создайте резервную копию базы данных артефактов и конфигурации служб ADFS.
- Задачи > Резервное копирование > Full > Добавить в файл резервной копии > ОК для создания

![Резервное копирование сервера](media/ad-fs-always-on/backUpADFS.png)

## <a name="create-new-availability-group"></a>Создать новую группу доступности

1.  В обозревателе объектов подключитесь к экземпляру сервера, на котором размещена первичная реплика.
2.  Разверните узел Always On высокий уровень доступности и узел группы доступности.
3.  Для запуска мастера создания группы доступности выберите команду Создать группу доступности.
4.  При первом запуске этого мастера отображается страница Введение. Чтобы в будущем эта страница не отображалась, можно щелкнуть Больше не показывать эту страницу. Прочитав эту страницу, нажмите кнопку Далее.
5.  На странице Указание параметров группы доступности введите имя новой группы доступности в поле Имя группы доступности. Это имя должно быть допустимым идентификатором SQL Server, уникальным в кластере и в домене в целом. Максимальная длина имени группы доступности составляет 128 символов. e
6.  Затем укажите тип кластера. Возможные типы кластеров зависят от версии SQL Server и операционной системы. Выберите WSFC, EXTERNAL или NONE. Дополнительные сведения см. на странице [Указание имени группы доступности](https://docs.microsoft.com/sql/database-engine/availability-groups/windows/specify-availability-group-name-page?view=sql-server-ver15) .

![имя группы и кластера AoA](media/ad-fs-always-on/createAoAName.png)

7.  На странице Выбор баз данных в сетке приведен список пользовательских баз данных на подключеном экземпляре сервера, которые могут стать базами данных доступности. Выберите одну или несколько из перечисленных баз данных для участия в новой группе доступности. Эти базы данных станут первоначальными базами данных-источниками.
Для каждой из перечисленных баз данных столбец Размер отображает размер базы данных, если он известен. В столбце Состояние указывается, соответствует ли заданная база данных [предварительным](https://docs.microsoft.com/sql/database-engine/availability-groups/windows/prereqs-restrictions-recommendations-always-on-availability?view=sql-server-ver15) требованиям для баз данных доступности. Предварительные требования не выполнены, в кратком описании состояния указывается причина, по которой база данных не подходит. Например, если она не использует модель полного восстановления. Для получения дополнительных сведений щелкните описание состояния.
После изменения базы данных для обеспечения соответствия требованиям щелкните Обновить, чтобы обновить сетку баз данных.
Если база данных содержит главный ключ базы данных, введите пароль для него в столбце Пароль.

![Выбор баз данных для AoA](media/ad-fs-always-on/createAoASelectDb.png)

8. на странице Выбор реплик укажите и настройте одну или несколько реплик для новой группы доступности. Эта страница содержит четыре вкладки. Эти вкладки представлены в следующей таблице. Дополнительные сведения см. в разделе [Выбор реплик (мастер создания группы доступности: Мастер добавления реплики)](https://docs.microsoft.com/sql/database-engine/availability-groups/windows/specify-replicas-page-new-availability-group-wizard-add-replica-wizard?view=sql-server-ver15) .

| Вкладка      | Краткое описание       |
| ------------------ |:-------------:|
| Реплики     | Используйте эту вкладку, чтобы указать каждый экземпляр SQL Server, на котором будет размещена вторичная реплика. Обратите внимание, что экземпляр сервера, к которому вы подключены в данный момент, должен размещать первичную реплику. |
| Конечные точки     | Эта вкладка используется для проверки существующих конечных точек зеркального отображения базы данных, а также, если эта конечная точка отсутствует на экземпляре сервера, для которого учетные записи служб используют проверку подлинности Windows, чтобы автоматически создать конечную точку.|
| Предпочтения резервного копирования | Используйте эту вкладку, чтобы указать параметры резервного копирования для группы доступности в целом и приоритеты резервного копирования для отдельных реплик доступности.      |
| Слушатель     | Эта вкладка используется для создания прослушивателя группы доступности. По умолчанию мастер не создает прослушиватель.      |

![Укажите сведения о реплике](media/ad-fs-always-on/createAoAchooseReplica.png)

9. На странице Выбор начальной синхронизации данных выберите, как именно необходимо создать новые базы данных-получатели и присоединить их к группе доступности. Выберите один из следующих вариантов.
-   Автоматическое заполнение
 - SQL Server автоматически создает вторичные реплики для каждой базы данных в группе. Для автоматического заполнения необходимо, чтобы пути к файлам данных и журналов совпадали на каждом экземпляре SQL Server, участвующем в группе. Доступно на SQL Server 2016 (13. x) и более поздних версий. См. раздел [Автоматическая инициализация Always on групп доступности](https://docs.microsoft.com/sql/database-engine/availability-groups/windows/automatically-initialize-always-on-availability-group?view=sql-server-ver15).
- Полная резервная копия базы данных и журнала
 - Выберите этот параметр, если среда соответствует требованиям для автоматического запуска начальной синхронизации данных (Дополнительные сведения см. в разделе [Предварительные требования, ограничения и рекомендации ранее в этом разделе)](https://docs.microsoft.com/sql/database-engine/availability-groups/windows/use-the-availability-group-wizard-sql-server-management-studio?view=sql-server-ver15#Prerequisites).
При выборе режима Полная после создания группы доступности мастер выполнит резервное копирование всех баз данных-источников из журналов транзакций в сетевую папку и восстановит резервные копии на всех экземплярах серверов, на которых размещены вторичные реплики. Затем мастер выполнит присоединение каждой базы данных-получателя к группе доступности.
В поле Укажите общую сетевую папку, доступную для всех реплик: укажите общую папку резервной копии, к которой имеют доступ на чтение и запись все экземпляры серверов, на которых размещаются реплики. Дополнительные сведения см. в подразделе Предварительные условия ранее в этом разделе. На шаге проверки мастер выполнит проверку правильности указанного сетевого расположения, тест создаст базу данных в первичной реплике с именем "BackupLocDb_", а затем GUID и создаст резервную копию в указанном сетевом расположении, а затем восстановит ее на вторичных репликах. Можно также удалить эту базу данных вместе с ее журналом резервного копирования и файлом резервной копии на случай, если мастер не смог удалить их.
- Только присоединение
 - Если вы вручную подготовили базы данных-получатели на экземплярах серверов, где будут размещаться вторичные реплики, можно выбрать этот параметр. Мастер выполнит присоединение существующих баз данных-получателей к группе доступности.
- Пропустить первоначальную синхронизацию данных
 - Выберите этот параметр, если вы хотите использовать собственную базу данных и резервные копии журналов баз данных источника. Дополнительные сведения см. [в разделе Запуск перемещения данных в Always on базе данных-получателе (SQL Server)](https://docs.microsoft.com/sql/database-engine/availability-groups/windows/start-data-movement-on-an-always-on-secondary-database-sql-server?view=sql-server-ver15).

![Выбор параметра синхронизации данных](media/ad-fs-always-on/createAoADataSync.png)

9.  На странице Проверка выполняется проверка соответствия значений, заданных в этом мастере, требованиям мастера создания группы доступности. Чтобы внести изменения, нажмите кнопку Назад, вернитесь к предыдущей странице мастера и измените одно или несколько значений. Нажмите кнопку Далее, чтобы вернуться на страницу Проверка, а затем нажмите кнопку Повторная проверка.

10. На странице Сводка проверьте параметры, выбранные для новой группы доступности. Чтобы внести изменения, щелкните Назад, чтобы вернуться на нужную страницу. После внесения изменений нажмите кнопку Далее, чтобы вернуться на страницу Сводка.

> [!NOTE] 
> Если учетная запись службы SQL Server экземпляра сервера, на котором будет размещена новая реплика доступности, еще не существует в качестве имени входа, то мастеру создания группы доступности необходимо создать имя входа. На странице Сводка мастер показывает сведения об имени входа, которое будет создано. Если нажать кнопку Готово, мастер создаст это имя входа для учетной записи SQL Server и предоставит ему разрешение CONNECT.
> Если параметры выбраны правильно, можно нажать кнопку Скрипт, чтобы создать скрипт шагов, которые будут выполняться мастером. Теперь нажмите кнопку Готово, чтобы создать и настроить новую группу доступности.

11. На странице Выполнение установки отображается ход выполнения этапов создания группы доступности (настройка конечных точек, создание группы доступности и присоединение к группе вторичной реплики).
12. После завершения выполнения этих шагов на странице Результаты отображаются результаты выполнения каждого шага. Если все эти шаги выполнены, Новая группа доступности будет полностью настроена. Если какой-либо из шагов привел к ошибке, возможно, потребуется вручную завершить настройку или использовать мастер для шага, завершившееся сбоем. Сведения о причинах данной ошибки можно отобразить, перейдя по соответствующей ссылке «Ошибка» в столбце Результат.
По завершении работы мастера нажмите кнопку Закрыть, чтобы выйти из него.

![Проверка завершена](media/ad-fs-always-on/createAoAValidation.png)

## <a name="add-databases-on-secondary-node"></a>Добавление баз данных на вторичный узел

1.  Восстановите базу данных артефактов через пользовательский интерфейс на вторичном узле, используя созданные файлы резервной копии.
![восстановить через пользовательский интерфейс](media/ad-fs-always-on/restoreDB.png)

2. Восстановите базу данных в состоянии без восстановления.
Восстановление ![с](media/ad-fs-always-on/restoreNonRecovery.png)ми без восстановления

3. Повторите процедуру, чтобы восстановить базу данных конфигурации.

## <a name="join-availability-replica-to-an-availability-group"></a>Присоединение реплики доступности к группе доступности

1.  В обозревателе объектов подключитесь к экземпляру сервера, на котором размещена вторичная реплика, и щелкните имя сервера, чтобы развернуть дерево сервера.
2.  Разверните узел Always On высокий уровень доступности и узел группы доступности.
3.  Выберите группу доступности вторичной реплики, к которой вы подключены.
4.  Щелкните правой кнопкой мыши вторичную реплику и выберите Присоединить к группе доступности.
5.  Откроется диалоговое окно Присоединить реплику к группе доступности.
6.  Чтобы присоединить вторичную реплику к группе доступности, нажмите кнопку ОК.

![присоединить вторичную реплику](media/ad-fs-always-on/jointoAoA.png)

## <a name="update-the-sql-connection-string"></a>Обновление строки подключения SQL
Наконец, с помощью PowerShell можно изменить свойства AD FS, чтобы обновить строку подключения SQL для использования DNS-адреса прослушивателя группы доступности AlwaysOn.
Запустите изменение базы данных конфигурации на каждом узле и перезапустите службу ADFS на всех узлах ADFS. Начальное значение каталога изменяется в зависимости от версии фермы.

```
PS:\>$temp= Get-WmiObject -namespace root/ADFS -class SecurityTokenService
PS:\>$temp.ConfigurationdatabaseConnectionstring=”data source=<SQLCluster\SQLInstance>; initial catalog=adfsconfiguration;integrated security=true”
PS:\>$temp.put()
PS:\> Set-AdfsProperties –artifactdbconnection ”Data source=<SQLCluster\SQLInstance >;Initial Catalog=AdfsArtifactStore;Integrated Security=True”
```
