---
title: Настройка безопасности заголовки с AD FS
description: Descirbes документа как настроить заголовки безопасности для защиты от уязвимостей системы безопасности.
author: billmath
ms.author: billmath
manager: daveba
ms.reviewer: akgoel23
ms.date: 02/19/2019
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: identity-adfs
ms.openlocfilehash: cd3ad4e6547194a971d8a51ecb95ee56f5e4e8c2
ms.sourcegitcommit: 0d0b32c8986ba7db9536e0b8648d4ddf9b03e452
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2019
ms.locfileid: "59822725"
---
# <a name="customize-http-security-response-headers-with-ad-fs-2019"></a>Настройка заголовков ответа HTTP безопасности с AD FS 2019 г. 
Область применения. Windows Server 2019 
 
Для защиты от распространенных уязвимостей безопасности и дают администраторам возможность воспользоваться преимуществами новейших успехах в механизмы защиты на основе браузера, AD FS 2019 добавлены функциональные возможности для настройки безопасности заголовки ответов HTTP Отправленные AD FS. Это выполняется посредством введения два новых командлета: `Get-AdfsResponseHeaders` и `Set-AdfsResponseHeaders`.  
 
В этом документе, которые будут рассмотрены часто использовать заголовки ответа безопасности для демонстрации способа настройки заголовки, отправленные AD FS 2019.   
 
>[!NOTE]
>Документ предполагает установку AD FS 2019.  

 
Прежде чем мы обсудим заголовки, рассмотрим несколько сценариев, создание потребность в "Администраторы" настроить заголовки безопасности 
 
## <a name="scenarios"></a>Сценарии 
1. Администратор включил [ **Strict-Transport-Security HTTP (HSTS)** ](#http-strict-transport-security-hsts) (заставляет все подключения через HTTPS шифрования) для защиты пользователей, которым может получить доступ к веб-приложение, использующее HTTP от доступа общедоступный Wi-Fi точка, которая может быть объектом вредоносной атаки. Она бы хотела дополнительно повысить уровень безопасности, включив HSTS для дочерних доменов.  
2. Администратор настроил [ **X-Frame-Options** ](#x-frame-options) заголовка ответа (позволяет избежать отрисовки любой веб-страницы в iFrame) для защиты от clickjacked веб-страниц. Тем не менее ей необходимо настроить значение заголовка из-за нового бизнес-требование для отображения данных (в iFrame) из приложения с помощью другого источника (домен).
3. Администратор включил [ **X-XSS-Protection** ](#x-xss-protection) (позволяет избежать выполнения сценариев атак) чтобы очистить и блокировать страницы в том случае, если браузер обнаруживает выполнения сценариев атак. Тем не менее ей необходимо настроить заголовок, чтобы разрешить загрузки страницы удаляются один раз.  
4. Администратор должен включить [ **от источника совместного использования (CORS)** ](#cross-origin-resource-sharing-cors-headers) и настройки начала координат (домен) в службах AD FS, чтобы разрешить одностраничного приложения для доступа к веб-API с другим доменом.  
5. Администратор включил [ **политику безопасности содержимого (CSP)** ](#content-security-policy-csp) заголовок, чтобы предотвратить кросс-внедрения сценариев и данные сайта атак запретив все междоменные запросы. Тем не менее из-за нового бизнес-требование ей необходимо настроить заголовок, чтобы разрешить веб-страницы для загрузки изображения из любого источника и ограничения мультимедиа для доверенных поставщиков.  

 
## <a name="http-security-response-headers"></a>Заголовки безопасности 
Заголовки ответа, включаются в исходящие HTTP-ответа, отправленные AD FS в веб-браузер. Заголовки можно перечислить при помощи `Get-AdfsResponseHeaders` командлет, как показано ниже.  

![Заголовок ответа](media\customize-http-security-headers-ad-fs\header1.png)

`ResponseHeaders` Атрибут в приведенном выше снимке экрана определяет заголовки безопасности, которые будут включены службами AD FS в каждом ответе HTTP. Заголовки ответа будут отправляться только в том случае, если `ResponseHeadersEnabled` присваивается `True` (значение по умолчанию). Значение может быть присвоено `False` во избежание AD FS, включая все заголовки безопасности HTTP-ответов. Однако это не рекомендуется.  Для этого воспользуйтесь следующее:

```PowerShell
Set-AdfsResponseHeaders -EnableResponseHeaders $false
```
 
### <a name="http-strict-transport-security-hsts"></a>HTTP Strict-Transport-Security (HSTS) 
HSTS — это механизм политики безопасности web, который помогает устранить атаки протоколов понижение уровня и перехвата куки-файл для служб, которые имеют конечные точки HTTP и HTTPS. Он позволяет веб-серверов объявить, что веб-браузеров (или других complying агенты пользователей) необходимо взаимодействовать только с ним по протоколу HTTPS и никогда не по протоколу HTTP.  
 
Все конечные точки службы федерации Active Directory для проверки подлинности веб-трафика, открываются только по протоколу HTTPS. Таким образом, AD FS эффективно снижает опасность угроз, которые предоставляет механизм политики безопасности транспорта HTTP (по умолчанию есть не на более раннюю версию HTTP, так как отсутствуют прослушиватели в HTTP). Заголовок можно настроить с помощью следующих параметров 
 
- **max-age =&lt;истекает время&gt;**  — время окончания срока действия (в секундах) указывает, как долго сайта должны быть доступны только по протоколу HTTPS. По умолчанию и рекомендуемое значение — 31536000 секунд (1 год).  
- **includeSubDomains** — это необязательный параметр. Если указано, HSTS правило применяется для всех поддоменов также.  
 
#### <a name="hsts-customization"></a>Настройки HSTS 
По умолчанию заголовок включен и `max-age` равным 1 год; тем не менее, администраторы могут изменять `max-age` (максимального значения не рекомендуется) или включить HSTS для поддоменов через `Set-AdfsResponseHeaders` командлета.  
 
```PowerShell
Set-AdfsResponseHeaders -SetHeaderName "Strict-Transport-Security" -SetHeaderValue "max-age=<seconds>; includeSubDomains" 
``` 

Пример. 

```PowerShell
Set-AdfsResponseHeaders -SetHeaderName "Strict-Transport-Security" -SetHeaderValue "max-age=31536000; includeSubDomains" 
 ```

По умолчанию заголовок включен в `ResponseHeaders` атрибут; тем не менее, администраторы могут удалять заголовка из `Set-AdfsResponseHeaders` командлета.  
 
```PowerShell
Set-AdfsResponseHeaders -RemoveHeaders "Strict-Transport-Security" 
```

### <a name="x-frame-options"></a>X-Frame-Options 
AD FS по умолчанию не поддерживает внешние приложения, чтобы использовать элементы IFRAME, при выполнении интерактивный вход. Это делается во избежание определенного стиля фишинг-атаках. Обратите внимание на то, что имена входа Неинтерактивный режим может быть выполнена с помощью iFrame, из-за предыдущего сеанса уровня безопасности, который был установлен.  
 
Однако в некоторых редких случаях может доверять приложением, которое требует страницы входа iFrame поддерживает интерактивные AD FS. Заголовок «X-Frame-Options» используется для этой цели.  
 
Этот заголовок ответа HTTP безопасности используется для обмена данными в браузере ли он может обрабатывать страницы в &lt;кадра&gt;/&lt;iframe&gt;. Заголовок может быть присвоено одно из следующих значений: 
 
- **Запретить** — не удается отобразить страницу в кадре. Это значение по умолчанию и рекомендуемый вариант.  
- **sameorigin** — страницы будет отображаться во фрейме, только если источником является началом координат веб-страницы. Параметр не очень полезно, если только все предки также ведется того же происхождения.  
- **Разрешить от <specified origin>**  -странице будет отображаться во фрейме, только если источник (например, https://www.». COM) совпадает с определенным источником в заголовке. 

#### <a name="x-frame-options-customization"></a>Настройки X-Frame-Options  
По умолчанию заголовок будет присвоено deny; Тем не менее, администраторы могут изменять значения через `Set-AdfsResponseHeaders` командлета.  
```PowerShell
Set-AdfsResponseHeaders -SetHeaderName "X-Frame-Options" -SetHeaderValue "<deny/sameorigin/allow-from<specified origin>>" 
 ```

Пример. 

```PowerShell
Set-AdfsResponseHeaders -SetHeaderName "X-Frame-Options" -SetHeaderValue "allow-from https://www.example.com" 
 ```

По умолчанию заголовок включен в `ResponseHeaders` атрибут; тем не менее, администраторы могут удалять заголовка из `Set-AdfsResponseHeaders` командлета.  

```PowerShell
Set-AdfsResponseHeaders -RemoveHeaders "X-Frame-Options" 
```

### <a name="x-xss-protection"></a>X-XSS-Protection 
Этот заголовок ответа HTTP безопасности используется для остановки веб-страниц загружать при обнаружении атаки межузловых сценариев (XSS) для браузеров. Это упоминается как XSS фильтрации. Заголовок может быть присвоено одно из следующих значений 
 
- **0** — фильтрация отключает XSS. Не рекомендуется.  
- **1** — Фильтрация позволяет XSS. При обнаружении атаки XSS, браузер будет очищает ее.   
- **1; режим = блок** — Фильтрация позволяет XSS. При обнаружении межсайтового сценария браузер предотвращает обработку страницы. Это значение по умолчанию и рекомендуемый вариант.  

#### <a name="x-xss-protection-customization"></a>X-XSS-Protection настройки 
По умолчанию, будет ли задать заголовок 1; режим = блока; Тем не менее, администраторы могут изменять значения через `Set-AdfsResponseHeaders` командлета.  

```PowerShell
Set-AdfsResponseHeaders -SetHeaderName "X-XSS-Protection" -SetHeaderValue "<0/1/1; mode=block/1; report=<reporting-uri>>" 
``` 

Пример. 

```PowerShell
Set-AdfsResponseHeaders -SetHeaderName "X-XSS-Protection" -SetHeaderValue "1" 
 ```

По умолчанию заголовок включен в `ResponseHeaders` атрибут; тем не менее, администраторы могут удалить заголовок `Set-AdfsResponseHeaders` командлета. 

```PowerShell
Set-AdfsResponseHeaders -RemoveHeaders "X-XSS-Protection" 
```

### <a name="cross-origin-resource-sharing-cors-headers"></a>CROSS заголовков совместного использования от источника (CORS) 
Безопасность веб-браузера не даст веб-странице делать запросы независимо от источника, инициированные из скриптов. Тем не менее иногда может потребоваться доступ к ресурсам в других источников (домены). CORS — это стандартный W3C, позволяющий серверу смягчить ограничения политики одного источника. С помощью CORS сервер может явным образом разрешить некоторые запросы независимо от источника а другие — отклонять.  
 
Чтобы лучше понять запрос CORS, давайте Пошаговое руководство сценария, где одна страница, приложение (SPA) требуется вызывать веб-API с другим доменом. Кроме того, давайте рассмотрим, как SPA, так и API настраиваются на ADFS 2019 г. и AD FS был включен механизм CORS т. е. AD FS можно определить заголовки CORS в запросе HTTP, проверить значения заголовка и включить соответствующие заголовки CORS в ответ (сведения о включении и Настройка CORS в AD FS 2019 г. в разделе Настройка CORS ниже). Пример поток: 

1. Пользователь обращается к SPA через браузер клиента и перенаправляется к конечной точке проверки подлинности AD FS для проверки подлинности. Так как SPA настроена для неявного потока предоставления, запрос возвращает доступа + ID токен в браузер после успешной проверки подлинности.  
2. После проверки подлинности пользователя внешнего интерфейса JavaScript, включенных в SPA отправляет запрос на доступ к веб-API. Запрос перенаправляется к AD FS со следующими заголовками
    - Параметры — описаны параметры обмена данными для целевого ресурса 
    - Сервер-источник — включает происхождение веб-API
    - Access-Control-Request-Method — определяет метод HTTP (например, удаление) для использования при фактический запрос 
    - Access-Control-Request-Headers - определяет заголовки HTTP, используемый при фактический запрос 
    
   >[!NOTE]
   >Запрос CORS похож на стандартный HTTP-запроса, однако наличие заголовка origin сигнализирует о том, входящий запрос не связанные с CORS. 
3. Службы федерации Active Directory проверяет, что web API origin, содержится в заголовке указано в доверенных источников, настроенные в AD FS (сведения о том, как изменить настройки CORS ниже в разделе из доверенных источников). AD FS, затем отвечает со следующими заголовками.  
    - Access-Control-Allow-Origin – значение так же как и в заголовка Origin. 
    - Access-Control-разрешить-Method – значение так же как и в заголовке Access-Control-Request-Method. 
    - Access-Control-разрешить-Headers - значение так же как и в заголовке Access-Control-Request-Headers 
4. Браузер отправляет фактический запрос, включая следующие заголовки 
    - Метод HTTP (например, удаление) 
    - Сервер-источник — включает происхождение веб-API 
    - Все заголовки, включенные в заголовке ответа Access-Control-разрешить-Headers 
5. После проверки AD FS утверждает запрос, включая домен web API (источник) в заголовок ответа Access-Control-Allow-Origin.  
6. Включение заголовка Access-Control-Allow-Origin позволит браузер, чтобы продолжить выполнение вызова запрошенного интерфейса API.

#### <a name="cors-customization"></a>Настройка CORS 
Функциональных возможностей CORS не будет включен по умолчанию; Тем не менее администраторы могут включить функциональные возможности с помощью командлета Set-AdfsResponseHeaders.  

```PowerShell 
Set-AdfsResponseHeaders -EnableCORS $true 
 ```

Одно включено, администраторы будут иметь возможность перечислить список с помощью того же командлета из доверенных источников. Например, следующая команда позволит запросы CORS, поступившего из **https&#58;//example1.com** и **https&#58;//example1.com**. 
 
```PowerShell
Set-AdfsResponseHeaders -CORSTrustedOrigins https://example1.com,https://example2.com 
 ```

> [!NOTE]
> "Администраторы" Разрешить запросы CORS из любого источника, включая «*» в список доверенных источников, несмотря на то, что этот подход не рекомендуется из-за уязвимостей системы безопасности и предупреждающее сообщение предоставляется решите сделать. 

### <a name="content-security-policy-csp"></a>Политика безопасности содержимого (CSP) 
Этот заголовок ответа HTTP безопасности используется для предотвращения межсайтовых сценариев, кликджекинга и другие атаки путем внедрения кода данных, предотвращая браузеры случайно выполнения вредоносного содержимого. Браузеры, которые не поддерживают CSP просто игнорирует заголовки ответа CSP.  
 
#### <a name="csp-customization"></a>Настройки CSP 
Настройка заголовка CSP включает в себя изменение, разрешенное в политику безопасности, которая определяет обозревателя ресурсов для загрузки для веб-страницы. Политика безопасности по умолчанию  
 
`Content-Security-Policy: default-src ‘self’ ‘unsafe-inline’ ‘’unsafe-eval’; img-src ‘self’ data:;` 
 
**По умолчанию src** директива используется для изменения [- src директивы](https://developer.mozilla.org/docs/Web/HTTP/Headers/Content-Security-Policy/default-src) без явно листинг каждой из директив. К примеру в примере ниже политика 1 — то же, что политика 2.  

Политика 1 
```PowerShell
Set-AdfsResponseHeaders -SetHeaderName "Content-Security-Policy" -SetHeaderValue "default-src 'self'" 
```
 
Политика 2
```PowerShell 
Set-AdfsResponseHeaders -SetHeaderName "Content-Security-Policy" -SetHeaderValue "script-src ‘self’; img-src ‘self’; font-src 'self';  
frame-src 'self'; manifest-src 'self'; media-src 'self';" 
```

Если директива явным образом в списке, заданное значение переопределяет значение, заданное по умолчанию src. В приведенном ниже примере img-src использовано значение как "*" (разрешает образы загрузки из любого источника) хотя другие директивы - src использовано значение как «self» (ограничение для того же происхождения веб-страница).  

```PowerShell
Set-AdfsResponseHeaders -SetHeaderName "Content-Security-Policy" -SetHeaderValue "default-src ‘self’; img-src *" 
```
Следующие источники могут быть определены для политики по умолчанию src 
 
- «self» — указав это ограничивает источник содержимого для загрузки в исходный репозиторий веб-страницы 
- «unsafe-inline» — указав это в политике позволяет использовать встроенный JavaScript и CSS 
- «unsafe-eval» — Если указать это в политике, использование текста в код JavaScript, такие механизмы, как eval 
- «none» — указав это ограничивает содержимое из любого источника для загрузки 
- данные:-определения данных: Идентификаторы URI позволяет создателям содержимого для внедрения встроенный небольших файлов в документах. Использование не рекомендуется.  
 
>[!NOTE]
>AD FS использует JavaScript в процессе проверки подлинности и таким образом позволяет JavaScript, включая «небезопасный встроенный» и «unsafe eval» источники политики по умолчанию.  

### <a name="custom-headers"></a>Настраиваемые заголовки 
Помимо указанных выше перечислены заголовки ответа безопасности (HSTS, CSP, X-Frame-Options, X-XSS-Protection и CORS), AD FS 2019 предоставляет возможность устанавливать новые заголовки.  
 
Пример. Чтобы задать новый заголовок «TestHeader» со значением в качестве «TestHeaderValue» 

```PowerShell
Set-AdfsResponseHeaders -SetHeaderName "TestHeader" -SetHeaderValue "TestHeaderValue" 
 ```

После установки новый заголовок отправляется в ответе службы федерации Active Directory (fiddler фрагмент кода ниже).  
 
![Fiddler](media\customize-http-security-headers-ad-fs\header2.png)

## <a name="web-browswer-compatibility"></a>Веб-browswer совместимость
Используйте следующую таблицу и ссылки для определения, какие веб-браузеры совместимы с каждым из заголовков ответа безопасности.

|Заголовки безопасности|Совместимость с браузером|
|-----|-----|
|HTTP Strict-Transport-Security (HSTS)|[Совместимость с обозревателями HSTS](https://developer.mozilla.org/docs/Web/HTTP/Headers/Strict-Transport-Security#Browser_compatibility)|
|X-Frame-Options|[Совместимость с обозревателями X-Frame-Options](https://developer.mozilla.org/docs/Web/HTTP/Headers/X-Frame-Options#Browser_compatibility)| 
|X-XSS-Protection|[Совместимость с обозревателями X-XSS-Protection](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-XSS-Protection#Browser_compatibility)| 
|CROSS совместного использования (CORS) ресурсов|[Совместимость с обозревателями CORS](https://developer.mozilla.org/docs/Web/HTTP/CORS#Browser_compatibility) 
|Политика безопасности содержимого (CSP)|[Совместимость с обозревателями CSP](https://developer.mozilla.org/docs/Web/HTTP/CSP#Browser_compatibility) 

## <a name="next"></a>Далее

- [Используйте руководства troublehshooting Справка по AD FS](https://aka.ms/adfshelp/troubleshooting )
- [Устранение неполадок AD FS](../../ad-fs/troubleshooting/ad-fs-tshoot-overview.md)
