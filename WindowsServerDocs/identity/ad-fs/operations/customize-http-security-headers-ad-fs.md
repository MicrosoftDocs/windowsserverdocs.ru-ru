---
title: Настройка заголовков ответа безопасности HTTP с помощью AD FS
description: В этом документе десЦирбес, как настроить заголовки безопасности для защиты от уязвимостей системы безопасности.
author: billmath
ms.author: billmath
manager: daveba
ms.reviewer: akgoel23
ms.date: 02/19/2019
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: identity-adfs
ms.openlocfilehash: 3c497cbafb8f9313f988a1b892d2b8fef68115eb
ms.sourcegitcommit: f6503e503d8f08ba8000db9c5eda890551d4db37
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/26/2019
ms.locfileid: "68523901"
---
# <a name="customize-http-security-response-headers-with-ad-fs-2019"></a>Настройка заголовков ответов безопасности HTTP с помощью AD FS 2019 
 
Чтобы защититься от распространенных уязвимостей системы безопасности и предоставить администраторам возможность воспользоваться последними улучшениями в механизмах защиты на основе браузера, AD FS 2019 добавила функции для настройки заголовков ответа безопасности HTTP. отправляется AD FS. Это достигается за счет появления двух новых командлетов `Get-AdfsResponseHeaders` : `Set-AdfsResponseHeaders`и.  

>[!NOTE]
>Функциональные возможности настройки заголовков ответа HTTP-безопасности (кроме заголовков CORS) `Get-AdfsResponseHeaders` с `Set-AdfsResponseHeaders` помощью командлетов и были относиться к AD FS 2016. Вы можете добавить функциональные возможности в AD FS 2016, установив [KB4493473](https://support.microsoft.com/en-us/help/4493473/windows-10-update-kb4493473) и [KB4507459](https://support.microsoft.com/en-us/help/4507459/windows-10-update-kb4507459). 

В этом документе мы обсудим часто используемые заголовки ответов безопасности, чтобы продемонстрировать, как настраивать заголовки, отправленные AD FS 2019.   
 
>[!NOTE]
>В документе предполагается, что AD FS 2019 установлен.  

 
Прежде чем обсуждать заголовки, рассмотрим несколько сценариев, создающих необходимость в настройке заголовков безопасности администраторами. 
 
## <a name="scenarios"></a>Сценарии 
1. Администратор включил [**протокол HTTP с параметром HTTPS-Security (HSTS)** ](#http-strict-transport-security-hsts) (принудительно устанавливает все подключения по протоколу SSL), чтобы защитить пользователей, которые могут получить доступ к веб-приложению, с помощью протокола HTTP из общедоступной точки доступа WiFi, которая может быть взломана. Она бы хотели усилить безопасность, включив HSTS для поддоменов.  
2. Администратор настроил заголовок ответа [**X-Frame-Options**](#x-frame-options) (не позволяет отображать веб-страницы в iframe) для защиты веб-страниц от кликкжаккед. Однако ей нужно настроить значение заголовка из-за нового бизнес-требования для показа данных (в iFrame) из приложения с другим источником (доменом).
3. Администратор включил [**защиту X-XSS-Protection**](#x-xss-protection) (предотвращает атаки с использованием сценариев), чтобы очистить и заблокировать страницу, если браузер обнаруживает атаки с использованием сценариев. Однако ей нужно настроить заголовок, чтобы Страница загружалась после очистки.  
4. Администратор должен включить [**общий доступ к ресурсам в разных источниках (CORS)** ](#cross-origin-resource-sharing-cors-headers) и задать источник (домен) на AD FS, чтобы разрешить одностраничному приложению доступ к веб-API с другим доменом.  
5. Администратор включил заголовок [ **"политика безопасности содержимого" (CSP)** ](#content-security-policy-csp) , чтобы предотвратить атаки межсайтовых сценариев и внедрения данных путем запрещения запросов между доменами. Однако из-за нового бизнес-требования ему нужно настроить заголовок, чтобы разрешить веб-странице загружать изображения из любого источника и ограничивать носители доверенными поставщиками.  

 
## <a name="http-security-response-headers"></a>Заголовки ответа безопасности HTTP 
Заголовки ответов включаются в исходящий HTTP-ответ, который отправляется AD FS в браузер. Заголовки могут быть перечислены с помощью `Get-AdfsResponseHeaders` командлета, как показано ниже.  

![Ответ заголовка](media/customize-http-security-headers-ad-fs/header1.png)

`ResponseHeaders` Атрибут на приведенном выше снимке экрана определяет заголовки безопасности, которые будут включаться в AD FS в каждом HTTP-ответе. Заголовки ответов будут отправляться, только если `ResponseHeadersEnabled` для `True` задано значение (по умолчанию). Можно задать `False` значение, чтобы предотвратить AD FS, включая любые заголовки безопасности в HTTP-ответе. Однако это не рекомендуется.  Для этого используйте следующую команду:

```PowerShell
Set-AdfsResponseHeaders -EnableResponseHeaders $false
```
 
### <a name="http-strict-transport-security-hsts"></a>HTTP-протокол HTTPS — безопасность (HSTS) 
HSTS — это механизм политики веб-безопасности, который помогает снизить атаки на понижение уровня протокола и захват файлов cookie для служб, которые имеют конечные точки HTTP и HTTPS. Он позволяет веб-серверам объявлять, что веб-браузер (или другие агенты пользователя) должны взаимодействовать с ним только с помощью протокола HTTPS и никогда через протокол HTTP.  
 
Все конечные точки AD FS для трафика веб-проверки подлинности открываются исключительно по протоколу HTTPS. В результате AD FS эффективно устраняет угрозы, предоставляемые механизмом политики безопасности транспортного протокола HTTP (по умолчанию нет перехода на более раннюю версию HTTP, так как в HTTP нет прослушивателей). Заголовок можно настроить, задав следующие параметры. 
 
- **max-age =&lt;Expires&gt;**  — время окончания срока действия (в секундах) указывает, как долго сайт должен быть доступен только по протоколу HTTPS. По умолчанию и рекомендуемое значение — 31536000 секунд (1 год).  
- **includeSubDomains** — это необязательный параметр. Если указано, правило HSTS применяется также ко всем поддоменам.  
 
#### <a name="hsts-customization"></a>Настройка HSTS 
По умолчанию заголовок включен и `max-age` имеет значение 1 год; Однако администраторы могут `max-age` изменять (не рекомендуется использовать меньшее значение максимального срока) или включить HSTS для поддоменов с помощью `Set-AdfsResponseHeaders` командлета.  
 
```PowerShell
Set-AdfsResponseHeaders -SetHeaderName "Strict-Transport-Security" -SetHeaderValue "max-age=<seconds>; includeSubDomains" 
``` 

Пример. 

```PowerShell
Set-AdfsResponseHeaders -SetHeaderName "Strict-Transport-Security" -SetHeaderValue "max-age=31536000; includeSubDomains" 
 ```

По умолчанию заголовок включается в `ResponseHeaders` атрибут, однако администраторы могут удалить заголовок с `Set-AdfsResponseHeaders` помощью командлета.  
 
```PowerShell
Set-AdfsResponseHeaders -RemoveHeaders "Strict-Transport-Security" 
```

### <a name="x-frame-options"></a>Параметры X-кадра 
По умолчанию AD FS не позволяет внешним приложениям использовать iFrames при выполнении интерактивных входов. Это делается для предотвращения определенного стиля фишинговых атак. Обратите внимание, что неинтерактивные имена входа можно выполнять через iFrame из-за установленной безопасности на уровне сеанса.  
 
Однако в некоторых редких случаях вы можете доверять конкретному приложению, которое требует интерактивного AD FS для входа с помощью iFrame. Для этой цели используется заголовок "X-Frame-Options".  
 
Заголовок ответа безопасности HTTP используется для связи &lt;с браузером, может ли он отображать страницу в IFRAME&gt;фрейма&gt;./&lt; Для заголовка можно задать одно из следующих значений: 
 
- **Deny** — страница в кадре не будет отображаться. Это рекомендуемый параметр по умолчанию.  
- **самеоригин** — страница будет отображаться в рамке только в том случае, если она совпадает с исходной для веб-страницы. Этот параметр не очень удобен, если все предки также находятся в одном источнике.  
- **Разрешить-из <specified origin>**  — страница будет отображаться в кадре только в том случае, если источник (например https://www,.) com) соответствует конкретному источнику в заголовке. 

#### <a name="x-frame-options-customization"></a>Настройка параметров кадра X  
По умолчанию заголовку будет присвоено значение Deny; Однако администраторы могут изменить значение с помощью `Set-AdfsResponseHeaders` командлета.  
```PowerShell
Set-AdfsResponseHeaders -SetHeaderName "X-Frame-Options" -SetHeaderValue "<deny/sameorigin/allow-from<specified origin>>" 
 ```

Пример. 

```PowerShell
Set-AdfsResponseHeaders -SetHeaderName "X-Frame-Options" -SetHeaderValue "allow-from https://www.example.com" 
 ```

По умолчанию заголовок включается в `ResponseHeaders` атрибут, однако администраторы могут удалить заголовок с `Set-AdfsResponseHeaders` помощью командлета.  

```PowerShell
Set-AdfsResponseHeaders -RemoveHeaders "X-Frame-Options" 
```

### <a name="x-xss-protection"></a>Защита X-XSS-Protection 
Заголовок ответа безопасности HTTP используется для того, чтобы предотвратить загрузку веб-страниц при обнаружении атак с использованием межсайтовых сценариев (XSS) в браузерах. Это называется фильтрацией XSS. Для заголовка можно задать одно из следующих значений: 
 
- **0** — отключает фильтрацию XSS. Не рекомендуется.  
- **1** — включает фильтрацию XSS. Если обнаружена атака XSS, браузер будет очистить страницу.   
- **1; Mode = Block** — включает фильтрацию XSS. Если обнаружена атака XSS, браузер не будет отображать страницу. Это рекомендуемый параметр по умолчанию.  

#### <a name="x-xss-protection-customization"></a>Настройка защиты X-XSS-Protection 
По умолчанию для заголовка задается значение 1; Mode = Block; Однако администраторы могут изменить это значение с помощью `Set-AdfsResponseHeaders` командлета.  

```PowerShell
Set-AdfsResponseHeaders -SetHeaderName "X-XSS-Protection" -SetHeaderValue "<0/1/1; mode=block/1; report=<reporting-uri>>" 
``` 

Пример. 

```PowerShell
Set-AdfsResponseHeaders -SetHeaderName "X-XSS-Protection" -SetHeaderValue "1" 
 ```

По умолчанию заголовок включается в `ResponseHeaders` атрибут, однако администраторы могут удалить заголовок с `Set-AdfsResponseHeaders` помощью командлета. 

```PowerShell
Set-AdfsResponseHeaders -RemoveHeaders "X-XSS-Protection" 
```

### <a name="cross-origin-resource-sharing-cors-headers"></a>Заголовки общего доступа к ресурсам в разных источниках (CORS) 
Безопасность веб-браузера не позволяет веб-страницам делать запросы между источниками, инициированные из скриптов. Однако иногда может потребоваться доступ к ресурсам в других источниках (доменах). CORS — это стандарт консорциума W3C, позволяющий серверу ослабить политику того же источника. С помощью CORS сервер может явно разрешить некоторые запросы между источниками, одновременно отклоняя другие.  
 
Чтобы лучше понять запрос CORS, пошаговым руководством является ситуация, когда одностраничное приложение (SPA) должно вызывать веб-API с другим доменом. Давайте рассмотрим, что как SPA, так и API настроены в ADFS 2019, а AD FS включили CORS, т. е. AD FS может определить заголовки CORS в HTTP-запросе, проверить значения заголовков и включить в ответ соответствующие заголовки CORS (подробные сведения о том, как включить и Настройте CORS на AD FS 2019 в разделе настройки CORS ниже. Пример последовательности: 

1. Пользователь получает доступ к SPA через браузер клиента и перенаправляется на конечную точку проверки подлинности AD FS. Так как SPA настроена для неявного потока предоставления, запрос возвращает в браузер маркер доступа и идентификатора после успешной проверки подлинности.  
2. После проверки подлинности пользователя клиентский сценарий JavaScript, входящий в SPA, делает запрос на доступ к веб-API. Запрос перенаправляется в AD FS со следующими заголовками
    - Параметры — описание параметров связи для целевого ресурса. 
    - Источник — включает источник веб-API.
    - Access-Control-Request-Method — определяет метод HTTP (например, DELETE), который будет использоваться при выполнении фактического запроса. 
    - Access-Control-request-headers — определяет заголовки HTTP, которые будут использоваться при выполнении фактического запроса. 
    
   >[!NOTE]
   >Запрос CORS напоминает стандартный HTTP-запрос, однако присутствие заголовка источника сигнализирует, что входящий запрос является CORS связанным. 
3. AD FS проверяет, входит ли источник веб-API, включенный в заголовок, в список доверенных источников, настроенных в AD FS (см. сведения о том, как изменить Доверенные источники в разделе настройки CORS ниже). AD FS затем отвечает на следующие заголовки.  
    - Доступ — управление-разрешить-Origin — значение, аналогичное значению в заголовке источника 
    - Доступ-Control-Allow-method — значение, аналогично значению заголовка Access-Control-Request-Method. 
    - Доступ-Control-Allow-Headers-value совпадает с заголовком Access-Control-request-headers 
4. Браузер отправляет фактический запрос, включая следующие заголовки 
    - Метод HTTP (например, DELETE) 
    - Источник — включает источник веб-API. 
    - Все заголовки, включаемые в заголовок ответа Access-Control-Allow-Headers 
5. После проверки AD FS утверждает запрос, включая домен веб-API (источник) в заголовке ответа Access-Control-Allow-Origin.  
6. Включение заголовка Access-Control-Allow-Origin позволит браузеру перейти к вызову запрошенного API.

#### <a name="cors-customization"></a>Настройка CORS 
По умолчанию функции CORS не будут включены. Однако администраторы могут включить эту функцию с помощью командлета Set-Адфсреспонсехеадерс.  

```PowerShell 
Set-AdfsResponseHeaders -EnableCORS $true 
 ```

Один включен, администраторы смогут перечислить список доверенных источников с помощью того же командлета. Например, следующая команда разрешит запросы CORS из источников **HTTPS&#58;//example1.com** и **&#58;HTTPS//example1.com**. 
 
```PowerShell
Set-AdfsResponseHeaders -CORSTrustedOrigins https://example1.com,https://example2.com 
 ```

> [!NOTE]
> Администраторы могут разрешать запросы CORS из любого источника, включая "*" в список доверенных источников, хотя этот подход не рекомендуется из-за уязвимостей системы безопасности, и предупреждающее сообщение предоставляется при выборе. 

### <a name="content-security-policy-csp"></a>Политика безопасности содержимого (CSP) 
Этот заголовок ответа безопасности HTTP используется для предотвращения непреднамеренного выполнения вредоносного содержимого в сценариях межсайтовых сценариев, кликджекинга и других атак путем внедрения данных. Браузеры, не поддерживающие CSP, просто игнорируют заголовки ответа CSP.  
 
#### <a name="csp-customization"></a>Настройка CSP 
Настройка заголовка CSP включает изменение политики безопасности, определяющей, что браузер ресурсов может загружать веб-страницу. Политика безопасности по умолчанию —  
 
`Content-Security-Policy: default-src ‘self’ ‘unsafe-inline’ ‘’unsafe-eval’; img-src ‘self’ data:;` 
 
Директива **Default-src** используется для директивы Modify [-src](https://developer.mozilla.org/docs/Web/HTTP/Headers/Content-Security-Policy/default-src) , не перечисляя каждую директиву явным образом. Например, в приведенном ниже примере политика 1 совпадает с политикой 2.  

Политика 1 
```PowerShell
Set-AdfsResponseHeaders -SetHeaderName "Content-Security-Policy" -SetHeaderValue "default-src 'self'" 
```
 
Политика 2
```PowerShell 
Set-AdfsResponseHeaders -SetHeaderName "Content-Security-Policy" -SetHeaderValue "script-src ‘self’; img-src ‘self’; font-src 'self';  
frame-src 'self'; manifest-src 'self'; media-src 'self';" 
```

Если директива указана явно, указанное значение переопределяет значение, заданное для Default-src. В приведенном ниже примере img-src принимает значение "*" (что позволяет загружать изображения из любого источника), а другие директивы src принимают значение как "Self" (с максимальным приоритетом на тот же источник, что и веб-страница).  

```PowerShell
Set-AdfsResponseHeaders -SetHeaderName "Content-Security-Policy" -SetHeaderValue "default-src ‘self’; img-src *" 
```
Для политики Default-src можно определить следующие источники. 
 
- "Self" — задает ограничение источника содержимого для загрузки в начало веб-страницы 
- "unsafeed-inline" — указание этого параметра в политике позволяет использовать встроенные сценарии JavaScript и CSS 
- "unsafe-eval" — указание этого параметра в политике позволяет использовать текст в механизмах JavaScript, таких как eval 
- "None" — задает ограничение содержимого от любого источника до загрузки 
- данные: — указание данных: Универсальные коды ресурсов (URI) позволяют авторам содержимого внедрять небольшие файлы встроенными в документы. Использование не рекомендуется.  
 
>[!NOTE]
>AD FS использует JavaScript в процессе проверки подлинности и, таким образом, включает JavaScript, включая источники "unsafe-inline" и "unsafe-eval" в политике по умолчанию.  

### <a name="custom-headers"></a>Пользовательские заголовки 
Помимо указанных выше заголовков ответа безопасности (HSTS, CSP, X-Frame-Options, X-XSS-Protection и CORS), AD FS 2019 предоставляет возможность установки новых заголовков.  
 
Пример. Установка нового заголовка "Тессеадер" со значением "Тессеадервалуе" 

```PowerShell
Set-AdfsResponseHeaders -SetHeaderName "TestHeader" -SetHeaderValue "TestHeaderValue" 
 ```

После установки новый заголовок отправляется в ответе AD FS (приведенном ниже фрагменте кода Fiddler).  
 
![Fiddler](media/customize-http-security-headers-ad-fs/header2.png)

## <a name="web-browswer-compatibility"></a>Совместимость с Web подключаемый
Используйте следующую таблицу и ссылки, чтобы определить, какие веб-браузеры совместимы с каждым из заголовков ответа безопасности.

|Заголовки ответа безопасности HTTP|Совместимость с браузером|
|-----|-----|
|HTTP-протокол HTTPS — безопасность (HSTS)|[Совместимость с браузером HSTS](https://developer.mozilla.org/docs/Web/HTTP/Headers/Strict-Transport-Security#Browser_compatibility)|
|Параметры X-кадра|[Совместимость X-Frame-параметры браузера](https://developer.mozilla.org/docs/Web/HTTP/Headers/X-Frame-Options#Browser_compatibility)| 
|Защита X-XSS-Protection|[Совместимость с браузером X-XSS-Protection](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-XSS-Protection#Browser_compatibility)| 
|Общий доступ к ресурсам в разных источниках (CORS)|[Совместимость браузера CORS](https://developer.mozilla.org/docs/Web/HTTP/CORS#Browser_compatibility) 
|Политика безопасности содержимого (CSP)|[Совместимость с браузером CSP](https://developer.mozilla.org/docs/Web/HTTP/CSP#Browser_compatibility) 

## <a name="next"></a>Далее

- [Использование AD FS справочных руководств траублехшутинг](https://aka.ms/adfshelp/troubleshooting )
- [Устранение неполадок в AD FS](../../ad-fs/troubleshooting/ad-fs-tshoot-overview.md)
