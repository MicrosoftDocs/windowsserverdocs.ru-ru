---
title: Настройка производительности удаленный рабочий стол узлов виртуализации
description: Настройка производительности для узлов виртуализации удаленный рабочий стол
ms.prod: windows-server
ms.technology: performance-tuning-guide
ms.topic: article
ms.author: HammadBu; VladmiS
author: phstee
ms.date: 10/16/2017
ms.openlocfilehash: 6aad1560fa9f9429af94426487d9a33369137ded
ms.sourcegitcommit: 6aff3d88ff22ea141a6ea6572a5ad8dd6321f199
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/27/2019
ms.locfileid: "71370027"
---
# <a name="performance-tuning-remote-desktop-virtualization-hosts"></a>Настройка производительности удаленный рабочий стол узлов виртуализации


Узел виртуализации удаленных рабочих столов (узел виртуализации удаленных рабочих столов) — это служба роли, которая поддерживает сценарии инфраструктуры виртуальных рабочих столов (VDI) и позволяет нескольким одновременно работающим пользователям запускать приложения на базе Windows на виртуальных машинах, размещенных на сервере под управлением. Windows Server 2016 и Hyper-V.

Windows Server 2016 поддерживает два типа виртуальных рабочих столов: личные виртуальные рабочие столы и виртуальные рабочие столы в составе пула.

**В этом разделе:**

-   [Общие рекомендации](#general-considerations)

-   [Оптимизация производительности](#performance-optimizations)

## <a name="general-considerations"></a>Общие рекомендации


### <a name="storage"></a>Хранилище

Наиболее вероятное узким местом производительности является хранилище, поэтому важно изменить размер хранилища, чтобы правильно обрабатывалась нагрузка ввода-вывода, созданная изменениями состояния виртуальной машины. Если пилотный проект или имитация нецелесообразна, рекомендуется подготовить один дисковый шпиндел для четырех активных виртуальных машин. Используйте конфигурации дисков с хорошей производительностью записи (например, RAID 1 + 0).

При необходимости используйте дедупликацию дисков и кэширование, чтобы уменьшить нагрузку на диск, и включите решение для хранения данных, чтобы повысить производительность путем кэширования значительной части образа.

### <a name="data-deduplication-and-vdi"></a>Дедупликация данных и VDI

В Windows Server 2012 R2 дедупликация данных поддерживает оптимизацию открытых файлов. Чтобы использовать виртуальные машины, работающие на дедупликации тома, файлы виртуальной машины должны храниться на отдельном узле, отличном от узла Hyper-V. Если Hyper-V и дедупликация выполняются на одном компьютере, эти две функции будут конкурировать за системные ресурсы и негативно повлияют на общую производительность.

Том также должен быть настроен для использования типа оптимизации дедупликации "инфраструктура виртуальных рабочих столов (VDI)". Это можно настроить с помощью Диспетчер сервера (**Файловые службы и**  - **тома**  - &gt; служб&gt; хранилища **Параметры дедупликации**) или с помощью следующей команды Windows PowerShell:

``` syntax
Enable-DedupVolume <volume> -UsageType HyperV
```

> [!NOTE]
> Оптимизация дедупликации данных для открытых файлов поддерживается только для сценариев VDI с Hyper-V, использующих удаленное хранилище по протоколу SMB 3,0.

### <a name="memory"></a>Память

Использование памяти сервера управляется тремя основными факторами:

-   Издержки операционной системы

-   Служебные ресурсы Hyper-V на каждую виртуальную машину

-   Память, выделенная для каждой виртуальной машины

Для типичных рабочих нагрузок рабочей нагрузки на гостевых виртуальных машинах с x86 Window 8 или Windows 8.1 необходимо предоставить около 512 МБ памяти в качестве базовых показателей. Однако динамическая память, скорее всего, увеличит объем памяти гостевой виртуальной машины примерно на 800 МБ в зависимости от рабочей нагрузки. Для x64 мы увидим, что начиная с 800 МБ и увеличивая до 1024 МБ.

Поэтому важно предоставить достаточно памяти сервера, чтобы удовлетворить объем памяти, требуемый ожидаемым числом гостевых виртуальных машин, а также обеспечить достаточный объем памяти для сервера.

### <a name="cpu"></a>ЦП

При планировании емкости сервера для сервера узла виртуализации удаленных рабочих столов количество виртуальных машин на физические ядра будет зависеть от природы рабочей нагрузки. В качестве отправной точки целесообразно планировать 12 виртуальных машин на физические ядра, а затем выполнять соответствующие сценарии для проверки производительности и плотности. Более высокая плотность может быть достижима в зависимости от особенностей рабочей нагрузки.

Рекомендуется включить технологию Hyper-Threading, но не забудьте вычислить коэффициент превышения лимита подписки на основе числа физических ядер, а не числа логических процессоров. Это обеспечивает ожидаемый уровень производительности для каждого ЦП.

### <a name="virtual-gpu"></a>Виртуальный GPU

Microsoft RemoteFX для узла виртуализации удаленных рабочих столов — это полнофункциональная графическая среда для инфраструктуры виртуальных рабочих столов (VDI) через удаленное взаимодействие на стороне узла, конвейер кодирования захвата, высокоэффективная кодировка на основе GPU, регулирование на основе клиента. действия и виртуальный GPU с поддержкой DirectX. RemoteFX для узла виртуализации удаленных рабочих столов обновляет виртуальный GPU с DirectX9 до DirectX11. Кроме того, он повышает удобство работы пользователей за счет поддержки большего числа мониторов с более высоким разрешением.

Интерфейс RemoteFX DirectX11 доступен без аппаратного GPU с помощью программно-эмулированного драйвера. Несмотря на то, что этот программный графический процессор обеспечивает хорошее удобство работы, модуль обработки виртуальных графических объектов (GPU) RemoteFX добавляет аппаратное ускорение к виртуальным рабочим столам.

Чтобы воспользоваться преимуществами возможностей ВИРТУАЛЬНЫХ GPU RemoteFX на сервере под Windows Server 2016, требуется драйвер GPU (например, DirectX 11.1 или WDDM 1,2) на сервере узла. Чтобы получить дополнительные сведения о предложениях GPU для использования с RemoteFX для узла виртуализации удаленных рабочих столов, обратитесь к поставщику GPU.

Если вы используете виртуальный GPU RemoteFX в развертывании VDI, емкость развертывания будет зависеть от сценариев использования и конфигурации оборудования. При планировании развертывания необходимо учитывать следующее.

-   Число GPU в системе

-   Емкость видеопамяти на графических процессорах

-   Ресурсы процессора и оборудования в системе

### <a name="remotefx-server-system-memory"></a>Системная память сервера RemoteFX

Для каждого виртуального рабочего стола, поддерживающего виртуальный GPU, RemoteFX использует системную память в гостевой операционной системе и на сервере с поддержкой RemoteFX. Гипервизор гарантирует доступность системной памяти для гостевой операционной системы. На сервере каждому виртуальному рабочему столу с поддержкой GPU необходимо объявить требования к системной памяти гипервизору. Когда виртуальный рабочий стол с поддержкой GPU запускается, гипервизор резервирует дополнительный объем системной памяти на сервере с поддержкой RemoteFX для виртуального рабочего стола с поддержкой виртуальных рабочих столов.

Требования к памяти для сервера с поддержкой RemoteFX являются динамическими, так как объем памяти, потребляемой на сервере с поддержкой RemoteFX, зависит от числа мониторов, связанных с виртуальными рабочими столами с поддержкой виртуальных рабочих столов, и максимального разрешения для Эти мониторы.

### <a name="remotefx-server-gpu-video-memory"></a>Видеопамять GPU сервера RemoteFX

Каждый виртуальный рабочий стол с поддержкой GPU использует видеопамять в оборудовании GPU на сервере узла для подготовки к просмотру рабочего стола. В дополнение к отрисовке видеопамять используется кодеком для сжатия отображаемого экрана. Объем необходимой памяти напрямую зависит от количества мониторов, подготовленных для виртуальной машины.

Зарезервированная видеопамять зависит от числа мониторов и разрешения экрана системы. Некоторым пользователям может потребоваться более высокое разрешение экрана для определенных задач. Существует большая масштабируемость с более низкими параметрами разрешения, если все остальные параметры остаются постоянными.

### <a name="remotefx-processor"></a>Процессор RemoteFX

Гипервизор планирует сервер с поддержкой RemoteFX и виртуальные рабочие столы с поддержкой GPU на ЦП. В отличие от системной памяти, не существует сведений, связанных с дополнительными ресурсами, которые RemoteFX должен использовать для совместного использования с гипервизором. Дополнительные ресурсы ЦП, которые RemoteFX предоставляет виртуальному рабочему столу с поддержкой GPU, связаны с запуском драйвера Virtual GPU и протокол удаленного рабочего столаным стеком пользовательского режима.

На сервере с поддержкой RemoteFX издержки увеличиваются, так как система запускает дополнительный процесс (рдвгм. exe) на виртуальном рабочем столе с поддержкой GPU. Этот процесс использует драйвер графического устройства для выполнения команд GPU. Кодек также использует процессоры для сжатия данных экрана, которые необходимо отправить обратно клиенту.

Большее число виртуальных процессоров означает лучшее взаимодействие с пользователем. Рекомендуется выделить по меньшей мере два виртуальных процессора на виртуальный рабочий стол с поддержкой GPU. Мы также советуем использовать архитектуру x64 для виртуальных рабочих столов с поддержкой GPU, так как производительность виртуальных машин x64 лучше по сравнению с виртуальными машинами x86.

### <a name="remotefx-gpu-processing-power"></a>Вычислительные мощности GPU RemoteFX

Для каждого виртуального рабочего стола с поддержкой GPU на сервере с поддержкой RemoteFX имеется соответствующий процесс DirectX. Этот процесс воспроизводит все команды графики, полученные с виртуального рабочего стола RemoteFX, на физический графический процессор. Для физического графического процессора это эквивалентно одновременному запуску нескольких приложений DirectX.

Как правило, графические устройства и драйверы настроены на запуск нескольких приложений на рабочем столе. RemoteFX растягивает GPU, чтобы использовать их уникальным образом. Для измерения того, как GPU работает на сервере RemoteFX, были добавлены счетчики производительности для измерения ответа GPU на запросы RemoteFX.

Обычно, когда недостаточно ресурсов GPU, операции чтения и записи для GPU занимают много времени. С помощью счетчиков производительности администраторы могут предпринять превентивные действия, устраняя при этом возможность простоя для конечных пользователей.

На сервере RemoteFX доступны следующие счетчики производительности для измерения производительности виртуальных GPU:

**Графическая система RemoteFX**

-   **Пропущено кадров/сек-недостаточно ресурсов клиента** Число пропущенных кадров в секунду из-за нехватки ресурсов клиента

-   **Коэффициент сжатия графики** Отношение числа байтов в кодировке к числу входных байтов

**Управление корневым графическим процессором RemoteFX**

-   **Источников Тдрс в графических процессорах** сервера общее количество раз, когда ТДР истекает из GPU на сервере

-   **Источников Виртуальные машины с RemoteFX** общее число виртуальных машин с установленным видеоадаптером RemoteFX 3D

-   **ПАМЯТИ Доступно МБ на размер** GPU выделенной видеопамяти, которая не используется

-   **ПАМЯТИ Зарезервированный% на GPU @ no__t-0% выделенной видеопамяти, зарезервированной для RemoteFX

**Программное обеспечение RemoteFX**

-   **Частота захвата для монитора** \[1-4\] Отображение скорости захвата RemoteFX для мониторов 1-4

-   **Коэффициент сжатия** Не рекомендуется в Windows 8 и заменено **коэффициентом сжатия графики**

-   **Отложенных кадров/с** Число кадров в секунду, в которых графические данные не отправлялись в течение определенного промежутка времени

-   **Время ответа GPU из записи** Задержка, измеряемая в рамках захвата RemoteFX (в микросекундах) для выполнения операций GPU

-   **Время ответа GPU от прорисовки** Задержка, измеряемая в модуле подготовки RemoteFX (в микросекундах) для завершения операций GPU

-   **Выходные байты** Общее число байтов вывода RemoteFX

-   **Ожидание количества клиентов/с** Нерекомендуемый в Windows 8 и заменено **кадрами, пропущенными в секунду. недостаточно ресурсов клиента**

**Управление виртуальными Gpuми RemoteFX**

-   **Источников Тдрс локальным виртуальным** машинам общее количество тдрс, произошедших на этой виртуальной машине (тдрс, что сервер, распространяемый на виртуальные машины, не включены).

-   **Источников Тдрс, распространяемый по** общему числу серверов тдрс, произошедших на сервере и распространяемых на виртуальную машину

**Производительность виртуальных машин виртуальной машины RemoteFX**

-   **Data**  Общее число вызовов в секунду для отображения операций в рабочем столе виртуальной машины в секунду (в секундах)

-   **Data**  Общее число операций представления, отправленных виртуальной машиной на серверный GPU за секунду (в секунду)

-   **Data Прочитано байт/** с общее число считанных байт с сервера с поддержкой RemoteFX в секунду

-   **Data**  Общее число байтов, отправленных в GPU сервера с поддержкой RemoteFX в секунду

-   **ЛЕЖАТ Средняя задержка в буферах обмена данными (** с) в среднем времени (в секундах), затраченного на буферы обмена данными

-   **ЛЕЖАТ Задержка буфера DMA (сек** .) (в секундах) с момента отправки DMA до завершения

-   **ЛЕЖАТ Длина очереди** DMA для видеоадаптера RemoteFX 3D

-   **Источников Время ожидания ТДР на число** GPU в ТДР, произошедших на каждом GPU на виртуальной машине

-   **Источников Время ожидания ТДР для каждого ядра** GPU на виртуальной машине, равное количеству времени ожидания ТДР.

В дополнение к счетчикам производительности виртуального GPU RemoteFX можно также измерять использование GPU с помощью Process Explorer, который показывает использование видеопамяти и использования GPU.

## <a name="performance-optimizations"></a>Оптимизация производительности

### <a name="dynamic-memory"></a>Динамическая память

Динамическая память обеспечивает более эффективное использование ресурсов памяти сервера, на котором работает Hyper-V, путем балансировки распределения памяти между работающими виртуальными машинами. Память можно динамически перераспределить между виртуальными машинами в ответ на изменяющиеся рабочие нагрузки.

Динамическая память позволяет повысить плотность виртуальных машин с учетом уже существующих ресурсов без ущерба для производительности или масштабируемости. Результатом является более эффективное использование дорогостоящих ресурсов серверного оборудования, что может привести к более легкому управлению и снижению затрат.

В операционных системах на виртуальной машине под управлением Windows 8 и более поздних версий с виртуальными процессорами, охватывающими несколько логических процессоров, следует рассмотреть компромисс между запуском с динамическая память, чтобы сократить использование памяти и отключить динамическая память для повышения производительности. приложения, учитывающего топологию компьютеров. Такое приложение может использовать сведения о топологии для принятия решений о планировании и выделении памяти.

### <a name="tiered-storage"></a>Многоуровневое хранилище

Узел виртуализации удаленных рабочих столов поддерживает многоуровневые хранилища для пулов виртуальных рабочих столов. Физический компьютер, совместно используемый всеми виртуальными рабочими столами в составе пула, может использовать высокопроизводительное решение для хранения данных, такое как зеркальный твердотельный накопитель (SSD). Виртуальные рабочие столы в составе пула можно разместить на менее дорогостоящем традиционном хранилище, таком как RAID 1 + 0.

Физический компьютер должен быть размещен на SSD, так как большая часть операций чтения и ввода-вывода из виртуальных рабочих столов в составе пула переходит в операционную систему управления. Таким образом, хранилище, используемое физическим компьютером, должно поддерживать более высокие объемы операций чтения в секунду.

Эта конфигурация развертывания гарантирует экономичную производительность, когда требуется производительность. SSD обеспечивает более высокую производительность на диске меньшего размера (~ 20 ГБ на коллекцию в зависимости от конфигурации). В традиционном хранилище для виртуальных рабочих столов в составе пула (RAID 1 + 0) используется около 3 ГБ на виртуальную машину.

### <a name="csv-cache"></a>Кэш CSV

Отказоустойчивая кластеризация в Windows Server 2012 и более поздних версий обеспечивает кэширование общих томов кластера (CSV). Это чрезвычайно полезно для коллекций виртуальных рабочих столов в составе пула, где большая часть операций ввода-вывода считывается из операционной системы управления. Кэш CSV обеспечивает более высокую производительность с помощью нескольких порядков, поскольку он кэширует блоки, которые считываются более одного раза, и доставляет их из системной памяти, что сокращает число операций ввода-вывода. Дополнительные сведения о кэше CSV см. в разделе [Включение кэша CSV](http://blogs.msdn.com/b/clustering/archive/2012/03/22/10286676.aspx).

### <a name="pooled-virtual-desktops"></a>Виртуальные рабочие столы в составе пула

По умолчанию виртуальные рабочие столы в составе пула откатываются в состояние поддерживалась после выхода пользователя, поэтому любые изменения, внесенные в операционную систему Windows с момента последнего входа пользователя, будут отменены.

Хотя откат можно отключить, он по-прежнему является временным, так как обычно коллекция виртуальных рабочих столов в составе пула создается повторно из-за различных обновлений шаблона виртуального рабочего стола.

Имеет смысл отключить функции и службы Windows, зависящие от постоянного состояния. Кроме того, имеет смысл отключить службы, которые в основном используются для некорпоративных сценариев.

Каждая конкретная служба должна оцениваться должным образом до любого широкого развертывания. Ниже приведены некоторые начальные моменты, которые следует учитывать.

| Обслуживание                                      | Почему?                                                                                                                                                                                                      |
|----------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Автоматическое обновление                                  | Виртуальные рабочие столы в составе пула обновляются путем повторного создания шаблона виртуального рабочего стола.                                                                                                                          |
| автономные файлы;                                | Виртуальные рабочие столы всегда находятся в сети и подключены с точки зрения сети.                                                                                                                         |
| Фоновая дефрагментация                            | Изменения в файловой системе удаляются после выхода пользователя из системы (из-за отката в состояние поддерживалась или при повторном создании шаблона виртуального рабочего стола, что приводит к повторному созданию всех виртуальных рабочих столов в составе пула). |
| Режим гибернации или спящий режим                           | Нет такого понятия для VDI                                                                                                                                                                                   |
| Дамп памяти для проверки ошибок                        | Нет такой концепции для виртуальных рабочих столов в составе пула. Ошибка. Проверка виртуального рабочего стола в составе пула начнется из состояния поддерживалась.                                                                                       |
| Автонастройка WLAN                              | Отсутствует интерфейс устройства Wi-Fi для VDI                                                                                                                                                                 |
| Служба общего доступа к проигрывателю Windows Media | Ориентированная на потребителей служба                                                                                                                                                                                  |
| Поставщик домашней группы                          | Ориентированная на потребителей служба                                                                                                                                                                                  |
| Общий доступ к подключению к Интернету                  | Ориентированная на потребителей служба                                                                                                                                                                                  |
| Расширенные службы Media Center               | Ориентированная на потребителей служба                                                                                                                                                                                  |
> [!NOTE]
> Этот список не является полным списком, так как любые изменения повлияют на предполагаемые цели и сценарии. Дополнительные сведения см. в разделе [горячее нажатие клавиш, получите его сейчас, сценарий оптимизации VDI для Windows 8, с помощью PFE!](http://blogs.technet.com/b/jeff_stokes/archive/2013/04/09/hot-off-the-presses-get-it-now-the-windows-8-vdi-optimization-script-courtesy-of-pfe.aspx).

 
> [!NOTE]
> В Windows 8 по умолчанию включена упреждающая выборка. Он совместим с VDI и не должен быть отключен. Избыточная выборка может еще больше сократить потребление памяти посредством общего доступа к странице памяти, что полезно для VDI. Виртуальные рабочие столы в составе пула под Windows 7 должны быть отключены, но для персональных виртуальных рабочих столов, работающих под Windows 7, необходимо оставить.

 
