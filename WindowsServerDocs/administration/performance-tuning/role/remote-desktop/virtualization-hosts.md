---
title: Настройка узлов виртуализации удаленных рабочих столов производительности
description: Настройка производительности для узлов виртуализации удаленных рабочих столов
ms.prod: windows-server-threshold
ms.technology: performance-tuning-guide
ms.topic: article
ms.author: HammadBu; VladmiS
author: phstee
ms.date: 10/16/2017
ms.openlocfilehash: 7ef1eee97e40b9d3d131cef01722a0d42660b609
ms.sourcegitcommit: 0d0b32c8986ba7db9536e0b8648d4ddf9b03e452
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2019
ms.locfileid: "59838065"
---
# <a name="performance-tuning-remote-desktop-virtualization-hosts"></a>Настройка узлов виртуализации удаленных рабочих столов производительности


Узел виртуализации удаленных рабочих столов (RD Virtualization Host) — это служба роли, который поддерживает сценариев инфраструктуры виртуальных рабочих столов (VDI) и позволяет запускать приложения на основе Windows на виртуальных машинах, размещенных на сервере под управлением нескольких одновременных пользователей Windows Server 2016 и Hyper-V.

Windows Server 2016 поддерживает два типа виртуальных рабочих столов, личные виртуальные рабочие столы и виртуальными рабочими столами.

**В этом разделе:**

-   [Общие соображения](#general)

-   [Оптимизация производительности](#perfopt)

## <a href="" id="general"></a>Общие соображения


### <a name="storage"></a>Хранилище

Хранилище является узким местом производительности, скорее всего, и очень важно выбрать размер хранилища для правильной обработки нагрузку ввода-вывода, который создается путем изменения состояния виртуальной машины. Если для пилотного развертывания или моделирования не представляется возможным, рекомендуется является подготовка один шпиндель диска для четырех активных виртуальных машин. Использование конфигурации диска, для которых высокая скорость записи (например, RAID 1 + 0).

При необходимости используется Дедупликация диска и кэширование для уменьшения нагрузки чтения с диска и включить решения хранилища повысить производительность благодаря кэшированию значительную часть изображения.

### <a name="data-deduplication-and-vdi"></a>Дедупликация данных и VDI

Представленный в Windows Server 2012 R2, Дедупликация данных поддерживает оптимизацию для открытых файлов. Чтобы использовать виртуальные машины на дедуплицированном томе, файлы виртуальных машин должны храниться на отдельном сервере с узла Hyper-V. Если Hyper-V и дедупликации выполняются на одном компьютере, эти две функции будет конкурировать за системные ресурсы и отрицательно повлиять на общую производительность.

Тома также должен быть настроен на использование «виртуальной инфраструктуры рабочих столов (VDI)? Тип оптимизации дедупликации. Это можно настроить с помощью диспетчера серверов (**файловых служб и служб хранилища**  - &gt; **тома**  - &gt; **параметры дедупликации**) или с помощью Windows PowerShell следующие команды:

``` syntax
Enable-DedupVolume <volume> -UsageType HyperV
```

**Примечание**    оптимизация дедупликации для открытых файлов поддерживается только для сценариев VDI с Hyper-V с использованием удаленного хранилища через SMB 3.0.


### <a name="memory"></a>Память

Использование памяти сервера определяется три основных фактора:

-   Издержки операционной системы

-   Служба Hyper-V, издержки на каждую виртуальную машину

-   Память, выделенная для каждой виртуальной машины

Для рабочей нагрузки рабочего типичный базы знаний гостевой виртуальной машины работающей x86, Windows 8 или Windows 8.1 должен предоставляться ~ 512 МБ памяти в качестве базового. Тем не менее динамической памяти, скорее всего увеличит гостевой виртуальной машине памяти около 800 МБ, в зависимости от рабочей нагрузки. X64 мы см. в разделе о 800 МБ начиная, увеличение 1024 МБ.

Таким образом важно обеспечить достаточный объем памяти сервера для памяти, необходимый ожидаемое число гостевых виртуальных машин, а также разрешить достаточное количество памяти для сервера.

### <a name="cpu"></a>ЦП

При планировании емкости сервера для сервера узла виртуализации удаленных рабочих Столов, количество виртуальных машин каждого физического ядра будет зависеть от характера рабочей нагрузки. В качестве отправной точки разумно план 12 виртуальные машины каждого физического ядра и затем выполнить соответствующие сценарии для проверки производительности и плотности. Возможно, более высокую плотность достигаемое в зависимости от особенностей рабочей нагрузки.

Мы рекомендуем включить hyper-threading, но убедитесь, что для вычисления коэффициента превышение лимита подписки на основе количество физических ядер и не число логических процессоров. Это гарантирует ожидаемый уровень производительности для каждого Процессора.

### <a name="virtual-gpu"></a>Виртуальный графический Процессор

Microsoft RemoteFX для узла виртуализации удаленных рабочих Столов обеспечивает удобство работы сложные графические объекты, для кодирования Virtual Desktop Infrastructure (VDI) через удаленное взаимодействие на стороне узла, конвейер отрисовки захвата кодирования, весьма эффективный на основе графического Процессора, регулирование зависимости от быстродействия клиента действие и виртуальный графический Процессор с поддержкой DirectX. RemoteFX для узла виртуализации удаленных рабочих Столов обновляет виртуальный графический Процессор DirectX9 для DirectX11. Он также улучшает взаимодействие с пользователем, поддерживая несколько мониторов с более высоким разрешением.

RemoteFX DirectX11 доступна без оборудования GPU, через драйвер эмуляции программного обеспечения. Несмотря на то, что это программное обеспечение GPU предоставляет хорошие условия работы, RemoteFX виртуальный графический процессор (vgpu) добавляет возможности аппаратным ускорением виртуальных рабочих столов.

Чтобы воспользоваться преимуществами интерфейса RemoteFX VGPU на сервере под управлением Windows Server 2016, требуется драйвер графического Процессора (например, DirectX11.1 или WDDM 1.2) на сервере узла. Дополнительные сведения о предложениях GPU для использования с RemoteFX для узла виртуализации удаленных рабочих Столов обратитесь к поставщику GPU.

При использовании виртуальных GPU RemoteFX в развертывании VDI, емкость развертывания будет зависеть сценарии использования и конфигурации оборудования. При планировании развертывания, учитывайте следующее:

-   Количество процессоров в системе

-   Объем памяти видео на GPU

-   И аппаратных ресурсов системы

### <a name="remotefx-server-system-memory"></a>RemoteFX server системной памяти

Каждый виртуальный рабочий стол, снабженный виртуальный графический Процессор, RemoteFX системной памяти в гостевой операционной системы и используются на сервере с поддержкой RemoteFX. Низкоуровневая оболочка гарантирует доступность системной памяти для операционной системы на виртуальной машине. На сервере каждый виртуальный GPU с поддержкой виртуального рабочего стола необходимо объявить его системы требования к объему памяти низкоуровневой оболочки. При запуске виртуального графического Процессора с поддержкой виртуального рабочего стола, низкоуровневая оболочка резервирует дополнительная оперативная память на сервере с поддержкой RemoteFX для виртуальных рабочих столов с поддержкой VGPU.

Требования к памяти для сервера с поддержкой RemoteFX является динамическим, так как объем памяти, занятой server с поддержкой RemoteFX зависит число мониторов, связанных с поддержкой VGPU виртуальных рабочих столов и максимальное разрешение для Эти мониторы.

### <a name="remotefx-server-gpu-video-memory"></a>RemoteFX server видеопамяти графического Процессора

Каждый виртуальный графический Процессор с поддержкой виртуальному рабочему столу использует видеопамяти в оборудовании GPU на сервере узла для отображения рабочего стола. В дополнение к визуализации видеопамяти используется кодек для сжатия отображаемого экрана. Необходимый объем памяти напрямую зависит от объема мониторов, которые были подготовлены к виртуальной машине.

Видеопамяти, которая резервируется зависит количество мониторов и разрешение экрана системы. Некоторым пользователям может потребоваться более высокое разрешение экрана для выполнения конкретных задач. Имеется высокую масштабируемость с нижней параметры разрешения, если все остальные параметры не изменяются.

### <a name="remotefx-processor"></a>Процессора RemoteFX

Низкоуровневая оболочка назначает server с поддержкой RemoteFX и виртуальный графический Процессор с поддержкой виртуальных рабочих столов на ЦП. В отличие от системной памяти не существует сведения, относящиеся к дополнительным ресурсам, которые RemoteFX требуется обеспечить совместное использование с низкоуровневой оболочкой. Дополнительная нагрузка на ЦП издержки, RemoteFX вносят в виртуальный графический Процессор с поддержкой виртуального рабочего стола, связанные с запуском виртуальный драйвер графического Процессора и стек протокола удаленного рабочего стола пользовательского режима.

На сервере с поддержкой RemoteFX издержки увеличивается, так как система запускает дополнительный процесс (rdvgm.exe) на виртуальный графический Процессор с поддержкой виртуального рабочего стола. Этот процесс использует драйвер устройства графики для выполнения команд на GPU. Кодек также использует ЦП для сжатия данных экрана, необходимо отправить обратно клиенту.

Количество виртуальных процессоров означает удобства работы пользователя. Мы рекомендуем выделить по крайней мере два виртуальных ЦП на виртуальный графический Процессор с поддержкой виртуального рабочего стола. Мы также рекомендуем использовать x64 архитектуры для виртуального графического Процессора с поддержкой виртуальных рабочих столов так как производительность в виртуальные машины лучше по сравнению с x86 x64 виртуальных машин.

### <a name="remotefx-gpu-processing-power"></a>Вычислительных мощностей RemoteFX GPU

Для каждого виртуального с поддержкой GPU виртуальному рабочему столу имеется соответствующий DirectX процесс, запущенный на сервере с поддержкой RemoteFX. Этот процесс воспроизводит командам графики, полученными от RemoteFX виртуального рабочего стола на физических GPU. Для физического GPU это эквивалентно одновременного запуска нескольких приложений DirectX.

Как правило для выполнения нескольких приложений на рабочем столе настраиваемых графических устройств и драйверов. RemoteFX растягивает графических процессоров для использования уникальным образом. Чтобы измерить, как работает графического Процессора на сервере RemoteFX, счетчики производительности были добавлены для измерения ответ GPU RemoteFX запросов.

Обычно в том случае, когда ресурс GPU не хватает ресурсов, операции чтения и записи к GPU принимают много времени для завершения. С помощью счетчиков производительности, администраторы могут стать предупредительные действия, устраняя возможность простоев для конечных пользователей.

Следующие счетчики производительности доступны на сервере RemoteFX для измерения производительности виртуального графического Процессора:

**RemoteFX графики**

-   **Кадры пропускаются в секунду - недостаточно ресурсов клиента** пропущено число кадров в секунду из-за ресурсов недостаточно клиента

-   **Коэффициент сжатия графики** отношение числа байтов, закодированных в число входных байтов

**RemoteFX корневой управления GPU**

-   **Ресурсы: Ошибок TDR в графических процессоров сервера** общее количество попыток TDR время ожидания в графический Процессор на сервере

-   **Ресурсы: Виртуальные машины RemoteFX** общее число виртуальных машин, имеющих RemoteFX 3D видеоадаптер установлен

-   **ВИДЕОПАМЯТЬ: Доступно, МБ на GPU** объем видеопамяти, не используется

-   **ВИДЕОПАМЯТЬ: Зарезервированный % в GPU** процент используемой видеопамяти, зарезервированных для RemoteFX

**RemoteFX программного обеспечения**

-   **Частота захвата для монитора** \[1 – 4\] показывает скорость записи RemoteFX для мониторов 1 – 4

-   **Коэффициент сжатия** не рекомендуемые к использованию в Windows 8 и заменена **коэффициент сжатия графики**

-   **Отложенный кадров в секунду** число кадров в секунду, где графических данных не было отправлено в течение отведенного времени

-   **Время ответа GPU захвата** задержка измеряется в RemoteFX записи (в микросекундах) для завершения операций GPU

-   **Время отклика GPU отрисовки** задержка измеряется в RemoteFX отрисовки (в микросекундах) для завершения операций GPU

-   **Выходные данные байт** общее число RemoteFX выходных байт

-   **Ожидание клиента/сек** не рекомендуемые к использованию в Windows 8 и заменена **кадров секунду пропущено - недостаточно ресурсов клиента**

**Управление vGPU RemoteFX**

-   **Ресурсы: Ошибок TDR локальными для виртуальных машин** общее число ошибок TDR, которые произошли в этой виртуальной машины (ошибок TDR сервера распространяется на виртуальные машины, не включаются)

-   **Ресурсы: Ошибок TDR распространяются сервером** общее число ошибок TDR произошедшего на сервере и, которые были переданы на виртуальную машину

**Производительность vGPU RemoteFX виртуальной машины**

-   **Данные: Вызывается представляется в секунду** общее число (в секундах) присутствует операций для отображения на рабочий стол виртуальной машины в секунду

-   **Данные: Представляется в секунду исходящих** общее число операций присутствует, отправляемые серверу GPU в секунду для виртуальной машины

-   **Данные: Прочитано байт/с** общее число считанных байтов с сервера с поддержкой RemoteFX в секунду

-   **Данные: Отправка байт в сек** общее число байтов, отправленных на сервер с поддержкой RemoteFX GPU в секунду

-   **DMA: Буферы связи, среднее время задержки (в секундах)** Средняя продолжительность времени (в секундах), затраченное на буферы связи

-   **DMA: Задержка буфера DMA (сек.)** количество времени (в секундах) из при отправке DMA до завершения

-   **DMA: Длина очереди** длина очереди DMA для адаптера RemoteFX 3D видео

-   **Ресурсы: Время ожидания TDR в GPU** число из TDR времени ожидания, произошедшие на GPU на виртуальной машине

-   **Ресурсы: Время ожидания TDR в ядро GPU** число из TDR времени ожидания, произошедших на GPU ядра на виртуальной машине

В дополнение к RemoteFX виртуальный GPU счетчики производительности можно также измерить использование GPU с помощью Process Explorer, показывающий использование видеопамяти и уровень использования GPU.

## <a href="" id="perfopt"></a>Оптимизация производительности


### <a name="dynamic-memory"></a>Динамическая память

Динамическая память позволяет более эффективно использование ресурсов памяти сервера, выполняющего Hyper-V правильно распределяя распределение памяти между запуском виртуальных машин. Память может динамически выделяться между виртуальными машинами в ответ на их меняющиеся рабочие нагрузки.

Динамическая память позволяет повысить плотность виртуальных машин с ресурсами, которые уже есть без снижения производительности и масштабируемости. Результатом является более эффективного использования дорогостоящих ресурсов серверного оборудования, которые можно преобразовать в более простое управление и снизить расходы.

На гостевые операционные системы под управлением Windows 8 и выше с виртуальными процессорами, охватывающие несколько логических процессоров, помните о компромиссе между выполнением с динамической памятью, чтобы свести к минимуму использование памяти и отключение динамической памяти для повышения производительности приложения, которое представляет компьютер топологию виду. Такие приложения могут использовать сведения о топологии для принятия решений планирования и памяти выделения.

### <a name="tiered-storage"></a>Многоуровневое хранилище

Узел виртуализации удаленных рабочих Столов поддерживает многоуровневого хранилища для пулов виртуальных рабочих столов. Физический компьютер, который является общим для всех виртуальными рабочими столами в коллекции можно использовать решение небольшие, высокой производительности хранилища, например зеркальных твердотельного накопителя (SSD). Пулы виртуальных рабочих столов могут размещаться на менее затратный, традиционный носителях, например RAID 1 + 0.

Физический компьютер должен размещаться на SSD представляет собой, так как большая часть чтения я или от операционной системы виртуальными рабочими столами в управляющей операционной системе. Таким образом, хранилище, которое используется для физического компьютера должна поддерживать гораздо выше чтения ввода-вывода в секунду.

Эта конфигурация развертывания гарантирует экономически эффективные производительности, когда требуется производительности. SSD-ДИСКАХ обеспечивает повышенную производительность диска меньшего размера (около 20 ГБ в коллекции, в зависимости от конфигурации). Традиционное хранение пулы виртуальных рабочих столов (RAID 1 + 0) примерно 3 ГБ на каждую виртуальную машину.

### <a name="csv-cache"></a>Кэш CSV

Отказоустойчивая кластеризация в Windows Server 2012 и более поздних версий обеспечивает кэширование на общие тома кластера (CSV). Это очень полезно для коллекции виртуальных рабочих столов в составе пула там, где большую часть чтения операций ввода-вывода берутся из операционной системы. Кэш CSV обеспечивает более высокую производительность по несколько раз, так как он кэширует блоки, которые считываются более одного раза и доставляет их из системной памяти, который сокращает число операций ввода-вывода. Дополнительные сведения о кэше CSV, см. в разделе [Включение кэша CSV](http://blogs.msdn.com/b/clustering/archive/2012/03/22/10286676.aspx).

### <a name="pooled-virtual-desktops"></a>Пулы виртуальных рабочих столов

По умолчанию пулы виртуальных рабочих столов происходит возврат к исходному состоянию после выхода пользователя, поэтому любые изменения, внесенные в операционную систему Windows, с момента последнего входа пользователя отбрасываются.

Несмотря на то, что имеется возможность отключить возможность отмены, это по-прежнему временное состояние, так как обычно коллекции удаленных рабочих столов не будет создана повторно из-за различные обновления шаблона виртуального рабочего стола.

Смысл отключить компоненты Windows и служб, зависящих от постоянное состояние. Кроме того имеет смысл отключить службы, которые являются главным образом для некорпоративных сценариев.

Каждой конкретной службы должно оцениваться соответствующим образом перед любой масштабного развертывания. Ниже приведены начальной необходимо учитывать следующее.

| Обслуживание                                      | Почему?                                                                                                                                                                                                      |
|----------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Автоматическое обновление                                  | Пулы виртуальных рабочих столов, обновляются с помощью повторного создания шаблона виртуального рабочего стола.                                                                                                                          |
| автономные файлы;                                | Виртуальные рабочие столы — всегда подключение с сетевой точки зрения.                                                                                                                         |
| Дефрагментация в фоновом режиме                            | Изменения файловой системы будут удалены после входа пользователь увидит (из-за откат к исходному состоянию или повторного создания шаблона виртуального рабочего стола, что приводит к повторное создание все пулы виртуальных рабочих столов). |
| Режим гибернации или спящий режим                           | Такие концепции для VDI                                                                                                                                                                                   |
| Дамп памяти Проверка ошибок                        | Такие концепции для виртуальными рабочими столами. Проверку на наличие ошибок виртуальному рабочему столу будет запущен в исходное состояние.                                                                                       |
| Автонастройки Беспроводной сети                              | Нет интерфейса устройства Wi-Fi для VDI                                                                                                                                                                 |
| Служба общего доступа к сети проигрывателя Windows Media | Службы, ориентированные на потребителя                                                                                                                                                                                  |
| Поставщик домашней группы                          | Службы, ориентированные на потребителя                                                                                                                                                                                  |
| Подключения к Интернету                  | Службы, ориентированные на потребителя                                                                                                                                                                                  |
| Расширенные службы Media Center               | Службы, ориентированные на потребителя                                                                                                                                                                                  |

 

**Примечание**    этот список не должен быть полный список, так как все изменения коснутся предполагаемого целей и сценариев. Дополнительные сведения см. в разделе ["Горячий" уровень из типографии, загрузите его сейчас, сценарий оптимизации Windows 8 VDI, оплаченным из PFE!](http://blogs.technet.com/b/jeff_stokes/archive/2013/04/09/hot-off-the-presses-get-it-now-the-windows-8-vdi-optimization-script-courtesy-of-pfe.aspx).

 

**Примечание**    SuperFetch в Windows 8 включена по умолчанию. Он учитывает VDI и не следует отключать. Служба superFetch может дополнительно уменьшить потребление памяти через совместное использование страниц памяти, который является полезным для VDI. Пулы виртуальных рабочих столов под управлением Windows 7, следует отключить SuperFetch, но для персональных виртуальных рабочих столов под управлением Windows 7, он должен оставаться на.

 
