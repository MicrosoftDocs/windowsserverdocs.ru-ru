---
title: Настройка производительности файловых серверов SMB
description: Настройка производительности файловых серверов SMB
ms.prod: windows-server
ms.technology: performance-tuning-guide
ms.topic: article
author: phstee
ms.author: NedPyle; Danlo; DKruse
ms.date: 4/14/2017
ms.openlocfilehash: 918d21139a068da1a46fbda1fa5034e14c8379c0
ms.sourcegitcommit: 083ff9bed4867604dfe1cb42914550da05093d25
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/14/2020
ms.locfileid: "75947066"
---
# <a name="performance-tuning-for-smb-file-servers"></a>Настройка производительности файловых серверов SMB

## <a name="smb-configuration-considerations"></a>Рекомендации по конфигурации SMB
Не включайте какие либо службы или компоненты, которые не требуются для файлового сервера и клиентов. К ним могут относиться подписывание SMB, кэширование на стороне клиента, Мини-фильтры файловой системы, служба поиска, запланированные задачи, шифрование NTFS, сжатие NTFS, IPSEC, фильтры брандмауэра, Teredo и шифрование SMB.

Убедитесь, что режимы управления питанием BIOS и операционной системы заданы по мере необходимости, что может включать режим высокой производительности или изменение состояния C. Убедитесь, что установлены последние, наиболее устойчивые и быстрые драйверы для хранения и сетевых устройств.

Копирование файлов — это обычная операция, выполняемая на файловом сервере. В Windows Server имеется несколько встроенных служебных программ копирования файлов, которые можно запустить с помощью командной строки. Рекомендуется использовать Robocopy. Параметр **/MT** , появившийся в Windows Server 2008 R2, может значительно повысить скорость удаленной передачи файлов с помощью нескольких потоков при копировании нескольких мелких файлов. Также рекомендуется использовать параметр **/log** , чтобы сократить вывод на консоль путем перенаправления журналов на устройство NUL или в файл. При использовании XCopy рекомендуется добавлять параметры **/q** и **/k** в существующие параметры. Первый вариант уменьшает нагрузку на ЦП за счет сокращения времени вывода консоли, а второй сокращает сетевой трафик.

## <a name="smb-performance-tuning"></a>Настройка производительности SMB


Производительность файлового сервера и доступные настройки зависят от протокола SMB, согласованного между клиентом и сервером, а также с развернутыми компонентами файлового сервера. Самая высокая версия протокола, доступная в настоящее время, — это SMB 3.1.1 в Windows Server 2016 и Windows 10. Вы можете проверить, какая версия SMB используется в вашей сети, с помощью Windows PowerShell **Get-смбконнектион** на клиентах и **Get-смбсессион | FL** на серверах.

### <a name="smb-30-protocol-family"></a>Семейство протоколов SMB 3,0

SMB 3,0 была введена в Windows Server 2012 и улучшена в Windows Server 2012 R2 (SMB 3,02) и Windows Server 2016 (SMB 3.1.1). В этой версии появились технологии, которые могут значительно повысить производительность и доступность файлового сервера. Дополнительные сведения см. в разделе [SMB в Windows Server 2012 и 2012 R2 2012](https://aka.ms/smb3plus) и [новые возможности SMB 3.1.1](https://aka.ms/smb311).



### <a name="smb-direct"></a>SMB Direct

В SMB Direct появилась возможность использования сетевых интерфейсов RDMA для высокой пропускной способности с низкой задержкой и низкой загрузкой ЦП.

Когда SMB обнаруживает сеть с поддержкой RDMA, она автоматически пытается использовать возможность RDMA. Однако если по какой-либо причине клиенту SMB не удается подключиться с помощью пути RDMA, будет просто продолжать использовать TCP/IP-соединения. Все интерфейсы RDMA, совместимые с SMB Direct, должны также реализовать стек TCP/IP, и многоканальный протокол SMB знает об этом.

SMB Direct не требуется в какой-либо конфигурации SMB, но рекомендуется всегда для тех, кто хочет снизить задержку и снизить загрузку ЦП.

Дополнительные сведения о SMB Direct см. в статье [повышение производительности файлового сервера с помощью SMB Direct](https://aka.ms/smbdirect).

### <a name="smb-multichannel"></a>Технология SMB Multichannel

Многоканальный протокол SMB позволяет файловым серверам одновременно использовать несколько сетевых подключений и обеспечивает повышенную пропускную способность.

Дополнительные сведения о многоканальном SMB см. в статье [развертывание многоканального](https://aka.ms/smbmulti)SMB.

### <a name="smb-scale-out"></a>Горизонтальное масштабирование SMB

При горизонтальном масштабировании SMB 3,0 в конфигурации кластера обеспечивает отображение общего ресурса на всех узлах кластера. Эта конфигурация "активный/активный" позволяет дополнительно масштабировать кластеры файловых серверов без сложной конфигурации с несколькими томами, общими ресурсами и кластерами. Максимальная пропускная способность общего доступа — это общая пропускная способность всех узлов кластера файлового сервера. Общая пропускная способность больше не ограничивается пропускной способностью отдельного узла кластера, а зависит от возможности резервной системы хранения. Увеличить общую пропускную способность можно путем добавления узлов.

Дополнительные сведения о горизонтальном масштабировании SMB см. в разделе [Масштабируемый файловый сервер (Общие сведения о данных приложений](https://technet.microsoft.com/library/hh831349.aspx) ) и в записи блога [для масштабирования, а не для масштабирования. это вопрос](https://blogs.technet.com/b/filecab/archive/2013/12/05/to-scale-out-or-not-to-scale-out-that-is-the-question.aspx).

### <a name="performance-counters-for-smb-30"></a>Счетчики производительности для SMB 3,0

Следующие счетчики производительности SMB появились в Windows Server 2012 и считаются базовым набором счетчиков при мониторинге использования ресурсов SMB 2 и более поздних версий. Запись счетчиков производительности в локальный, необработанный (BLG) журнал счетчиков производительности. Получение всех экземпляров с помощью подстановочного знака (\*) менее затратно, а затем извлечение определенных экземпляров во время последующей обработки с помощью программы Relog. exe.

-   **Общие ресурсы SMB Client**

    Эти счетчики отображают сведения о общих файловых ресурсах на сервере, к которому обращается клиент, использующий протокол SMB 2,0 или более поздней версии.

    Если вы уже знакомы с обычными счетчиками дисков в Windows, вы можете заметить определенное сходство. Это не случайно. Счетчики производительности "клиентские ресурсы SMB" рассчитаны на точное соответствие счетчиков дисков. Таким образом вы можете легко повторно использовать любые рекомендации по настройке производительности диска приложений в настоящее время. Дополнительные сведения о сопоставлении счетчиков см. [в блоге по счетчикам производительности клиента для общего ресурса](https://blogs.technet.com/b/josebda/archive/2012/11/19/windows-server-2012-file-server-tip-new-per-share-smb-client-performance-counters-provide-great-insight.aspx).

-   **Общие серверные ресурсы SMB**

    Эти счетчики отображают сведения о файловых ресурсах SMB 2,0 или более поздней версии на сервере.

-   **Сеансы SMB Server**

    Эти счетчики отображают сведения о сеансах SMB Server, использующих SMB 2,0 или более поздней версии.

    Включение счетчиков на стороне сервера (общие серверные ресурсы или сеансы сервера) может оказать значительное влияние на производительность для рабочих нагрузок с большими объемами операций ввода-вывода.

-   **Фильтр ключей возобновления**

    Эти счетчики отображают сведения о фильтре ключа возобновления.

-   **Подключение SMB Direct**

    Эти счетчики измеряют различные аспекты активности подключения. Компьютер может иметь несколько подключений SMB Direct. Счетчики прямого подключения SMB представляют каждое соединение как пару IP-адресов и портов, где первый IP-адрес и порт представляют локальную конечную точку подключения, а второй IP-адрес и порт — удаленную конечную точку подключения.

-   **Связи счетчиков производительности "физический диск", "SMB" и "CSV FS"**

    Дополнительные сведения о том, как связаны счетчики физического диска, SMB и CSV (файловая система), см. в следующей записи блога: [общий том кластера счетчики производительности](https://blogs.msdn.com/b/clustering/archive/2014/06/05/10531462.aspx).

## <a name="tuning-parameters-for-smb-file-servers"></a>Параметры настройки для файловых серверов SMB


Следующие параметры реестра REG\_DWORD могут повлиять на производительность файловых серверов SMB:

- **Smb2CreditsMin** и **Smb2CreditsMax**

  ```
  HKLM\System\CurrentControlSet\Services\LanmanServer\Parameters\Smb2CreditsMin
  ```

  ```
  HKLM\System\CurrentControlSet\Services\LanmanServer\Parameters\Smb2CreditsMax
  ```

  Значения по умолчанию: 512 и 8192 соответственно. Эти параметры позволяют серверу динамически регулировать параллелизм операций клиента в указанных границах. Некоторые клиенты могут повысить пропускную способность с более высокими ограничениями параллелизма, например, скопировав файлы по каналам с высокой пропускной способностью и большим временем задержки.
    
  > [!TIP]
  > До Windows 10 и Windows Server 2016 количество кредитов, предоставленных клиенту, изменяется динамически между Smb2CreditsMin и Smb2CreditsMax на основе алгоритма, который пытался определить оптимальное количество кредитов для предоставления в зависимости от задержки сети. и использование кредита. В Windows 10 и Windows Server 2016 сервер SMB был изменен на безусловное предоставление кредитов при запросе до заданного максимального количества кредитов. В рамках этого изменения механизм регулирования кредита, который уменьшает размер кредитного окна каждого подключения, когда сервер находится под нехваткой памяти, был удален. Событие нехватки памяти ядра, которое вызвало регулирование, получает сигнал, только если на сервере недостаточно памяти (< несколько МБ), чтобы быть бесполезным. Так как сервер больше не сжимает кредитовые окна, параметр Smb2CreditsMin больше не требуется и теперь игнорируется.
  > 
  > Вы можете отслеживать общие ресурсы SMB-клиентов\\кредитные задержки в секунду, чтобы узнать, нет ли каких-либо проблем с кредитовыми данными.

- **аддитионалкритикалворкерсреадс**

    ```
    HKLM\System\CurrentControlSet\Control\Session Manager\Executive\AdditionalCriticalWorkerThreads
    ```

    Значение по умолчанию — 0. Это означает, что дополнительные критические рабочие потоки ядра не добавляются. Это значение влияет на количество потоков, используемых кэшем файловой системы для запросов с упреждающим чтением и записью. Создание этого значения может привести к увеличению количества операций ввода-вывода в очереди в подсистеме хранения, а также к повышению производительности ввода-вывода, особенно на системах с множеством логических процессоров и мощного оборудования для хранения данных.

    >[!TIP]
    > Значение может потребоваться увеличиться, если объем неизмененных данных диспетчера кэша (кэш счетчиков производительности\\«грязных» страниц) растет для использования большой части (свыше ~ 25%). памяти или, если система выполняет множество синхронных операций ввода-вывода.

- **макссреадсперкуеуе**

  ```
  HKLM\System\CurrentControlSet\Services\LanmanServer\Parameters\MaxThreadsPerQueue
  ```

  Значение по умолчанию — 20. Увеличение этого значения приводит к увеличению числа потоков, которые файловый сервер может использовать для обслуживания параллельных запросов. Если необходимо обслуживать большое количество активных подключений, а аппаратные ресурсы, такие как пропускная способность хранилища, достаточны, увеличение значения может повысить масштабируемость сервера, производительность и время ответа.

  >[!TIP]
  > Указывает, что значение может потребоваться увеличиться, если рабочие очереди SMB2 увеличиваются очень большими (счетчик производительности "рабочие очереди сервера\\длина очереди\\SMB2 без блокировки \*" постоянно превышает ~ 100).

  >[!Note]
  >В Windows 10 и Windows Server 2016 Макссреадсперкуеуе недоступен. Число потоков для пула потоков будет равно "20 * число процессоров в узле NUMA".
     

- **асинчронаускредитс**

  ``` 
  HKLM\System\CurrentControlSet\Services\LanmanServer\Parameters\AsynchronousCredits
  ```

  Значение по умолчанию — 512. Этот параметр ограничивает количество параллельных асинхронных команд SMB, разрешенных для одного соединения. В некоторых случаях (например, при наличии сервера переднего плана с серверным сервером IIS) требуется большой объем параллелизма (для запросов на уведомления об изменении файлов в частности). Значение этой записи можно увеличить для поддержки этих случаев.

### <a name="smb-server-tuning-example"></a>Пример настройки SMB Server

Во многих случаях следующие параметры позволяют оптимизировать компьютер для производительности файлового сервера. Предложенные значения не являются оптимальными и применимыми на всех компьютерах. Следует тщательно оценить влияние каждого параметра, прежде чем применять его.

| Параметр                       | Применение | Default |
|---------------------------------|-------|---------|
| аддитионалкритикалворкерсреадс | 64    | 0       |
| макссреадсперкуеуе              | 64    | 20      |


### <a name="smb-client-performance-monitor-counters"></a>Счетчики монитора производительности клиента SMB

Дополнительные сведения о счетчиках клиента SMB см. в разделе [Совет файлового сервера Windows Server 2012: новые счетчики производительности для каждого общего ресурса SMB обеспечивают превосходную аналитику](https://blogs.technet.com/b/josebda/archive/2012/11/19/windows-server-2012-file-server-tip-new-per-share-smb-client-performance-counters-provide-great-insight.aspx).
