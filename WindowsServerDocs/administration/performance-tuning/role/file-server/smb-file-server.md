---
title: Настройка производительности для файловых серверов SMB
description: Настройка производительности для файловых серверов SMB
ms.prod: windows-server-threshold
ms.technology: performance-tuning-guide
ms.topic: article
author: phstee
ms.author: NedPyle; Danlo; DKruse
ms.date: 4/14/2017
ms.openlocfilehash: 87ad8058f7353c938087b1211e0f17820f0bd2ae
ms.sourcegitcommit: eaf071249b6eb6b1a758b38579a2d87710abfb54
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/31/2019
ms.locfileid: "66435657"
---
# <a name="performance-tuning-for-smb-file-servers"></a>Настройка производительности для файловых серверов SMB

## <a name="smb-configuration-considerations"></a>Рекомендации по конфигурации SMB
Не включайте все службы или функции, которые не требуют файлового сервера и клиентов. Это могут быть подписывание SMB, кэширование на стороне клиента, мини фильтров файловой системы, службы поиска, запланированные задачи, шифрование NTFS, сжатие NTFS, IPSEC, фильтры брандмауэра, Teredo и SMB шифрования.

Убедитесь, что установлен BIOS и режимов управления питанием операционной системы при необходимости, который может включать режим высокой производительности или изменении C-состояния. Убедитесь в том, что установлены последние, наиболее отказоустойчивых и быстрым хранилища и сетевые драйверы устройств.

Копирование файлов является распространенной операцией на файловом сервере. Windows Server имеет несколько средств копирования встроенных файлов, которые можно выполнять с помощью командной строки. Рекомендуется использовать Robocopy. Представленные в Windows Server 2008 R2, **/mt** параметр Robocopy может значительно повысить скорость на удаленную передачу файлов с помощью нескольких потоков при копировании нескольких небольших файлов. Мы также рекомендуем использовать **/log** параметр, чтобы уменьшить выходные данные консоли, перенаправляя журналы на устройство NUL или в файл. При использовании Xcopy, мы рекомендуем добавить **/q** и **/k** параметры существующих параметров. Первый вариант уменьшает нагрузку на ЦП за счет сокращения вывод на консоль и последний уменьшает сетевой трафик.

## <a name="smb-performance-tuning"></a>Настройка производительности SMB


Производительность сервера и доступные tunings зависят от протокола SMB, который согласовывается между каждой клиентом и сервером и возможности развернутой файлового сервера. Самый высокий в настоящее время доступна версия протокола — SMB 3.1.1 в Windows Server 2016 и Windows 10. Вы можете проверить, какая версия SMB используется в вашей сети с помощью Windows PowerShell **Get-SMBConnection** на клиентах и **Get-SMBSession | FL** на серверах.

### <a name="smb-30-protocol-family"></a>Семейство протоколов SMB 3.0

SMB 3.0 была введена в Windows Server 2012 и в дальнейшем расширится в Windows Server 2012 R2 (SMB 3.02) и Windows Server 2016 (SMB 3.1.1). В этой версии добавлены технологии, которые могут значительно повысить производительность и доступность файлового сервера. Дополнительные сведения см. в разделе [SMB в Windows Server 2012 и 2012 R2 2012](https://aka.ms/smb3plus) и [новые возможности SMB 3.1.1](https://aka.ms/smb311).



### <a name="smb-direct"></a>SMB Direct

SMB Direct появилась возможность использовать RDMA сетевых интерфейсов для высокой пропускной способностью с низкой задержкой и низкую загрузку ЦП.

Каждый раз, когда SMB обнаруживает в сети с поддержкой RDMA, автоматически предпринимается попытка использовать функцию RDMA. Тем не менее если для какой-либо причине клиент SMB не удается подключиться, используя путь RDMA, он просто продолжат вместо этого используйте подключения по протоколу TCP/IP. Требуется также реализовать стека TCP/IP всех интерфейсов RDMA, совместимых с SMB Direct и SMB Multichannel известно.

SMB Direct не требуется на какой-либо настройки SMB, но "s всегда рекомендуется для тех, кто хочет более низкую задержку и Низкий коэффициент использования ЦП.

Дополнительные сведения о SMB Direct, см. в разделе [увеличение производительности файлового сервера с SMB Direct](https://aka.ms/smbdirect).

### <a name="smb-multichannel"></a>Технология SMB Multichannel

SMB Multichannel позволяет файловым серверам одновременно использовать несколько сетевых подключений и обеспечивает увеличение пропускной способности.

Дополнительные сведения о SMB Multichannel, см. в разделе [Deploy SMB Multichannel](https://aka.ms/smbmulti).

### <a name="smb-scale-out"></a>Масштабирование SMB

Масштабирование SMB позволяет SMB 3.0 в конфигурации кластера, чтобы показать общую папку во всех узлах кластера. Эта конфигурация активный/активный дает возможность масштабирования кластеров файловых серверов, без сложные конфигурации с несколькими томами, общие ресурсы и ресурсы кластера. Пропускная способность максимальное общего ресурса является общей пропускной способности всех узлов кластера файловых серверов. Общая пропускная способность больше не ограничивается пропускной способностью одного узла кластера, но вместо зависит возможность резервной системы хранения. Увеличить общую пропускную способность можно путем добавления узлов.

Дополнительные сведения о SMB горизонтального масштабирования, см. в разделе [масштабируемого файлового сервера для обзора данных приложения](https://technet.microsoft.com/library/hh831349.aspx) и в записи блога [масштабировать или нет, вот в чем вопрос](http://blogs.technet.com/b/filecab/archive/2013/12/05/to-scale-out-or-not-to-scale-out-that-is-the-question.aspx).

### <a name="performance-counters-for-smb-30"></a>Счетчики производительности для SMB 3.0

Следующие счетчики производительности SMB появились в Windows Server 2012, и они считаются базовый набор счетчиков, при мониторинге использования ресурсов SMB 2 и более поздних версиях. Журнал счетчиков производительности на локальном журнал счетчиков производительности необработанных (.blg). Требует меньше затрат для сбора всех экземпляров с помощью подстановочного знака (\*), а затем извлечь определенные экземпляры во время постобработки, с помощью Relog.exe.

-   **Общие ресурсы SMB-клиента**

    Эти счетчики отображения сведений о файловых ресурсов на сервере, на который осуществляется клиентом, который использует SMB 2.0 и более поздних версий.

    Если вы "знакомы со счетчиками обычный диск в Windows, вы можете заметить определенные сходство. Что "s не по ошибке. Счетчики производительности общих ресурсов SMB клиента были разработаны для точно соответствовать счетчиков диска. Таким образом, можно без труда использовать любой рекомендации по настройке производительности диска приложения у вас сейчас. Дополнительные сведения о сопоставлении счетчика см. в разделе [в блоге, посвященном счетчики производительности клиента общего ресурса](http://blogs.technet.com/b/josebda/archive/2012/11/19/windows-server-2012-file-server-tip-new-per-share-smb-client-performance-counters-provide-great-insight.aspx).

-   **Серверные общие папки SMB**

    Эти счетчики отображаются сведения об SMB 2.0 или более поздней версии общих папок на сервере.

-   **Сеансы SMB-сервера**

    Эти счетчики отображаются сведения о сеансах сервера SMB, которые используют SMB 2.0 или более поздней версии.

    Включение счетчиков на стороне сервера (общих папок на сервере или сеансов сервера) может иметь значительно влияет на производительность при высоких рабочих нагрузках ввода-ВЫВОДА.

-   **Фильтром ключа возобновления**

    Эти счетчики отображаются сведения о фильтром ключа возобновления.

-   **Прямое подключение SMB**

    Эти счетчики измеряют различные аспекты действия по соединению. Компьютер может иметь несколько подключений SMB Direct. Прямое подключение SMB счетчиков представляют каждое подключение как пара IP-адресов и портов, где первый IP-адрес и порт представляют локальную конечную точку подключения, а второй IP-адрес и порт для подключения удаленной конечной точки.

-   **Физический диск, SMB, связи счетчики производительности CSV FS**

    Дополнительные сведения о взаимосвязи (файловая система) счетчики физического диска, SMB и CSV FS см. в следующей записи блога: [Счетчики производительности тома общего кластера](http://blogs.msdn.com/b/clustering/archive/2014/06/05/10531462.aspx).

## <a name="tuning-parameters-for-smb-file-servers"></a>Параметры настройки для файловых серверов SMB


Следующий REG\_параметры реестра DWORD может повлиять на производительность файловых серверов SMB:

- **Smb2CreditsMin** и **Smb2CreditsMax**

  ```
  HKLM\System\CurrentControlSet\Services\LanmanServer\Parameters\Smb2CreditsMin
  ```

  ```
  HKLM\System\CurrentControlSet\Services\LanmanServer\Parameters\Smb2CreditsMax
  ```

  Значения по умолчанию — 512 до 8192, соответственно. Эти параметры позволяют серверу для регулирования параллельной обработки операции клиента динамически в рамках заданных границ. Некоторые клиенты могут добиться увеличения пропускной способности с выше ограничения параллелизма, например, копирование файлов по сети с высокой пропускной способностью, высоким уровнем задержки.
    
  > [!TIP]
  > До Windows 10 и Windows Server 2016 число кредитов, предоставленные клиенту изменяться динамически между Smb2CreditsMin и Smb2CreditsMax, в зависимости от алгоритма, который попытался определить оптимальное число кредитов, чтобы предоставить в зависимости от задержки в сети и кредит на использование. В Windows 10 и Windows Server 2016 SMB-сервера было изменено безусловно предоставлять кредиты по запросу до заданного максимального числа кредитов. В рамках этого изменения кредит регулирования механизма, который уменьшает размер окна кредит каждого подключения, когда сервер испытывает недостаток памяти, был удален. Ядра нехватки памяти, какое событие вызвало регулирования срабатывающая только в том случае, когда сервер требует так мало памяти (< несколько МБ) относительно бесполезны. Так как сервер больше не сжимает кредит windows параметр Smb2CreditsMin больше не требуется и теперь учитывается.
  > 
  > Вы можете отслеживать общие ресурсы SMB-клиента\\кредит зависает в сек для просмотра, если возникли проблемы с использованием кредитов.

- **AdditionalCriticalWorkerThreads**

    ```
    HKLM\System\CurrentControlSet\Control\Session Manager\Executive\AdditionalCriticalWorkerThreads
    ```

    Значение по умолчанию — 0, означающее, что добавлены без дополнительных в ядре рабочих потоков. Это значение влияет на количество потоков, которые использует кэш файловой системы для упреждающего чтения и отложенной записи запросов. Увеличение этого значения можно обеспечить, несколько обновляемых посредством очередей ввода-вывода в подсистеме хранилища, и он может повысить производительность операций ввода-вывода, особенно в системах с множество логических процессоров и оборудование для хранения мощный.

    >[!TIP]
    > Значение может потребоваться увеличить, если объем диспетчера кэша "грязных" данных (счетчик производительности кэша\\"грязных" страниц) увеличивается использование крупным сегментом (более чем ~ 25%) памяти или если система выполняет много синхронных операций чтения.

- **MaxThreadsPerQueue**

  ```
  HKLM\System\CurrentControlSet\Services\LanmanServer\Parameters\MaxThreadsPerQueue
  ```

  Значение по умолчанию — 20. Увеличение этого значения повышает количество потоков, файловый сервер можно использовать для обслуживания параллельных запросов. Если большое количество активных подключений должны быть обслужены и аппаратных ресурсов, таких как пропускная способность хранилища, достаточны, увеличение значения может повысить масштабируемость сервера, производительность и время ответа.

  >[!TIP]
  > Значение, указывающее, может потребоваться увеличить значение увеличивается при SMB2 рабочих очередей очень больших (счетчик производительности "рабочие очереди сервера\\длина очереди\\SMB2 неблокирующем \*" постоянно превышает около 100).

  >[!Note]
  >В Windows 10 и Windows Server 2016 MaxThreadsPerQueue недоступна. Число потоков, пул потоков будет равно «20 * количество процессоров в узле NUMA.».
     

- **AsynchronousCredits**

  ``` 
  HKLM\System\CurrentControlSet\Services\LanmanServer\Parameters\AsynchronousCredits
  ```

  Значение по умолчанию — 512. Этот параметр ограничивает число параллельных асинхронных команд SMB, разрешенных в одном соединении. Иногда (например, когда имеется сервер переднего плана с сервером IIS серверной части) требуется большой объем параллелизма (файл запросы на изменение уведомления, в частности). Для поддержки этих случаях можно увеличить значение этого элемента.

### <a name="smb-server-tuning-example"></a>Пример настройки сервера SMB

Следующие параметры можно оптимизировать производительность во многих случаях на компьютере. Предложенные значения не являются оптимальными и применимыми на всех компьютерах. Следует тщательно оценить влияние каждого параметра, прежде чем применять его.

| Параметр                       | Значение | Значение по умолчанию |
|---------------------------------|-------|---------|
| AdditionalCriticalWorkerThreads | 64    | 0       |
| MaxThreadsPerQueue              | 64    | 20      |


### <a name="smb-client-performance-monitor-counters"></a>Счетчики производительности клиента SMB

Дополнительные сведения о счетчиках клиента SMB, см. в разделе [совет по Server файл Windows Server 2012: Новые счетчики производительности клиента SMB для файлового ресурса обеспечивают немало помогает](http://blogs.technet.com/b/josebda/archive/2012/11/19/windows-server-2012-file-server-tip-new-per-share-smb-client-performance-counters-provide-great-insight.aspx).
