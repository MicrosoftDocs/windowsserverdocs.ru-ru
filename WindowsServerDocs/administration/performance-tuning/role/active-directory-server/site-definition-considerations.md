---
title: Определение сайта и размещение контроллера домена в добавляет настройку производительности
description: Рекомендации по настройке производительности для определения сайта и размещения контроллера домена в Active Directory.
ms.topic: article
ms.author: timwi; chrisrob; herbertm; kenbrumf;  mleary; shawnrab
author: phstee
ms.date: 10/16/2017
ms.openlocfilehash: bb0850923dca2f0749c1f2cb5e787d998e8f03ca
ms.sourcegitcommit: 68444968565667f86ee0586ed4c43da4ab24aaed
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/07/2020
ms.locfileid: "87992252"
---
# <a name="proper-placement-of-domain-controllers-and-site-considerations"></a>Правильное размещение контроллеров домена и рекомендации по сайту

Правильное определение сайта является критически важным для производительности. Клиенты, выходящие за пределы сайта, могут испытывать низкую производительность при проверке подлинности и запросах. Кроме того, с появлением IPv6 на клиентах запрос может поступать либо из IPv4, либо с адреса IPv6, а Active Directory должны быть правильно определены для IPv6. При настройке обеих операционных систем операционная система предпочитает IPv6-адрес IPv4.

Начиная с Windows Server 2008, контроллер домена пытается использовать разрешение имен для обратного просмотра, чтобы определить сайт, в котором должен находиться клиент. Это может привести к исчерпанию пула потоков ATQ и привести к тому, что контроллер домена перестанет отвечать на запросы. Для этого нужно правильно определить топологию сайта для IPv6. В качестве обходного решения можно оптимизировать инфраструктуру разрешения имен для быстрого реагирования на запросы контроллера домена. Дополнительные сведения см. [в разделе отложенный отклик контроллера домена Windows server 2008 или Windows server 2008 R2 на запросы LDAP или Kerberos](https://support.microsoft.com/kb/2668820).

Дополнительная область рассмотрения заключается в поиске контроллеров домена для чтения и записи для сценариев, в которых используются RODC.  Для некоторых операций требуется доступ к контроллеру домена с возможностью записи или целевой контроллер домена с возможностью записи, если достаточно контроллера домена только для чтения.  Оптимизация этих сценариев может занять два пути:
-   Обращение к контроллерам домена с возможностью записи, если достаточно контроллера домена только для чтения.  Для этого требуется изменение кода приложения.
-   Где может потребоваться контроллер домена с возможностью записи.  Размещайте контроллеры домена для чтения и записи в Центральных расположениях, чтобы избежать задержки.

Дополнительные сведения:
-   [Совместимость приложений с RODC](/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/cc772597(v=ws.10))
-   [Интерфейс служб Active Directory (ADSI) и контроллер домена только для чтения (RODC) — предотвращение проблем с производительностью](/archive/blogs/fieldcoding/active-directory-service-interface-adsi-and-the-read-only-domain-controller-rodc-avoiding-performance-issues)

## <a name="optimize-for-referrals"></a>Оптимизировать для ссылок

Ссылки — это способ перенаправления запросов LDAP, если на контроллере домена не размещена копия раздела, на который выполнен запрос. При возврате ссылки она содержит различающееся имя секции, имя DNS и номер порта. Клиент использует эти сведения для продолжения выполнения запроса на сервере, на котором размещается секция. Это сценарий DCLocator, и все определения сайтов и размещения контроллеров домена поддерживаются, но приложения, зависящие от ссылок, часто пробывают. Рекомендуется убедиться, что топология AD, включая определения сайтов и размещение контроллера домена, правильно отражает потребности клиента. Кроме того, сюда могут входить контроллеры домена из нескольких доменов на одном сайте, Настройка параметров DNS или перемещение сайта приложения.

## <a name="optimization-considerations-for-trusts"></a>Рекомендации по оптимизации для отношений доверия

В сценарии внутреннего леса отношения доверия обрабатываются в соответствии со следующей иерархией доменов: "общий-дочерний домен — &gt; дочерний домен — корневой домен леса — дочерний домен" &gt; &gt; &gt; . Это означает, что защищенные каналы в корне леса и каждом родительском объекте могут стать перегруженными из-за агрегирования запросов проверки подлинности, передаваемых контроллеров домена в иерархии доверия. Это может также привести к задержкам в активных каталогах крупного географического дисперсии, когда проверка подлинности также требует передачи очень скрытых ссылок, чтобы повлиять на поток выше. Перегрузки могут происходить в сценариях доверия между лесами и более нижнего уровня. Следующие рекомендации применимы ко всем сценариям.

-   Правильно настройте MaxConcurrentAPI для поддержки нагрузки по безопасному каналу. Дополнительные сведения см. в разделе Настройка [производительности для проверки подлинности NTLM с помощью параметра MaxConcurrentApi](https://support.microsoft.com/kb/2688798/EN-US).

-   Создайте сокращенные доверия в соответствии с нагрузкой.

-   Убедитесь, что каждый контроллер домена в домене способен выполнять разрешение имен и взаимодействовать с контроллерами домена в доверенном домене.

-   Убедитесь, что учитывается уровень доверия.

-   Включите протокол Kerberos, где это возможно, и сократите использование безопасного канала, чтобы снизить риск MaxConcurrentAPI узких мест.

Сценарии междоменного доверия — это область, которая постоянно намерена для многих клиентов. Проблемы с разрешением имен и подключением, часто из-за брандмауэров, вызывают нехватку ресурсов на доверяющем контроллере домена и влияют на все клиенты. Более того, часто в случае невнимательного сценария оптимизируется доступ к доверенным контроллерам домена. Ключевые области, обеспечивающие правильность работы, перечислены ниже.

-   Убедитесь, что разрешение имен DNS и WINS, которые используются контроллерами домена доверия, может разрешить точный список контроллеров домена для доверенного домена.

    -   Статически добавленные записи имеют тенденции в том, что они устаревают и повторно представляют проблемы с подключением с течением времени. Пересылка DNS, динамическая служба DNS и слияние инфраструктур WINS и DNS являются более подправными в долгосрочном запуске.

    -   Обеспечьте правильную настройку серверов пересылки, условной пересылки и вторичных копий для зон прямого и обратного просмотра для каждого ресурса в среде, к которому может потребоваться доступ клиенту. Опять же, для этого требуется ручное обслуживание и тенденция устареть. Консолидация инфраструктуры идеальна.

-   Контроллеры домена в доверяющем домене будут пытаться располагать контроллеры домена в доверенном домене, которые находятся на одном сайте, а затем выполнить восстановление размещения для универсальных локаторов.

    -   Дополнительные сведения о том, как работает DCLocator, см. в разделе [Поиск контроллера домена на ближайшем сайте](/previous-versions/windows/it-pro/windows-2000-server/cc978016(v=technet.10)).

    -   Согласование имен сайтов между доверенными и доверяющими доменами для отражения контроллера домена в том же расположении. Убедитесь, что сопоставления подсети и IP-адресов должным образом связаны с сайтами в обоих лесах. Дополнительные сведения см. в разделе [Локатор доменов в доверии лесов](/archive/blogs/askds/domain-locator-across-a-forest-trust).

    -   Убедитесь, что порты открыты в соответствии с потребностями DCLocator для расположения контроллера домена. Если между доменами существуют брандмауэры, убедитесь, что брандмауэры правильно настроены для всех доверий. Если брандмауэры не открыты, доверенный контроллер домена по-прежнему будет пытаться получить доступ к доверенному домену. В случае сбоя связи по какой либо причине доверенный контроллер домена в конечном итоге истечет время ожидания запроса к доверенному контроллеру домена. Однако эти ожидания могут занять несколько секунд на запрос и могут вынимать сетевые порты на доверяющем контроллере домена, если объем входящих запросов высок. Клиент может столкнуться с ожиданием истечения времени ожидания контроллера домена в качестве зависших потоков, что может привести к зависанию приложений (если приложение выполняет запрос в основном потоке). Дополнительные сведения см. [в разделе Настройка брандмауэра для доменов и доверий](https://support.microsoft.com/kb/179442).

    -   Используйте Днсавоидрегистеррекордс для устранения проблемных контроллеров домена с высокой задержкой, например, в сопутствующих сайтах, от рекламы до универсальных локаторов. Дополнительные сведения см. в разделе [Оптимизация расположения контроллера домена или глобального каталога, находящегося вне сайта клиента](https://support.microsoft.com/kb/306602).

        > [!NOTE]
        > Существует практический лимит в 50 на число контроллеров домена, которые может использовать клиент. Это должны быть наиболее оптимальные и высокопроизводительные контроллеры домена.


    -  Попробуйте разместить контроллеры домена из доверенных и доверенных доменов в одном физическом расположении.

Для всех сценариев доверия учетные данные направляются в соответствии с доменом, указанным в запросах проверки подлинности. Это также справедливо для запросов к LookupAccountName и Лсалукупнамес (а также к другим наиболее часто используемым интерфейсам API). Когда параметры домена для этих API передают значение NULL, контроллер домена будет пытаться найти имя учетной записи, указанное в каждом доступном доверенном домене.

-   Отключите проверку всех доступных доверий, если указан домен со значением NULL. [Ограничение поиска изолированных имен во внешних доверенных доменах с помощью записи реестра Лсалукупрестриктисолатеднамелевел](https://support.microsoft.com/kb/818024)

-   Отключите передачу запросов проверки подлинности с пустым доменом, указанным для всех доступных доверий. [Процесс Lsass.exe может перестать отвечать, если на контроллере домена Active Directory имеется много внешних доверий](https://support.microsoft.com/kb/923241/EN-US)

## <a name="additional-references"></a>Дополнительные ссылки
- [Обеспечение высокой производительности серверов Active Directory](index.md)
- [Рекомендации по оборудованию](hardware-considerations.md)
- [Рекомендации по протоколу LDAP](ldap-considerations.md)
- [Устранение проблем с производительностью доменных служб Active Directory](troubleshoot.md)
- [Планирование ресурсов для доменных служб Active Directory](https://go.microsoft.com/fwlink/?LinkId=324566)