---
title: Рекомендации по использованию памяти в AD DS настройке производительности
description: Использование памяти процессом Lsass.exe на контроллерах домена под управлением Windows Server 2012 R2, 2016 и 2019.
ms.topic: article
ms.author: v-tea
author: teresa-motiv
ms.date: 7/3/2019
ms.openlocfilehash: 546839b803e8306fb3093ade6e317a155b7a117d
ms.sourcegitcommit: 7cacfc38982c6006bee4eb756bcda353c4d3dd75
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/14/2020
ms.locfileid: "90077281"
---
# <a name="memory-usage-considerations-for-ad-ds-performance-tuning"></a>Рекомендации по использованию памяти для настройки производительности AD DS

В этой статье описываются некоторые основы служба LSASS (LSASS, также называемый Lsass.exe процессом), рекомендации по настройке LSASS и ожидания использования памяти. Эта статья должна использоваться в качестве руководств по анализу производительности и использования памяти программой LSASS на контроллерах домена (DCs). Сведения в этой статье могут быть полезны при наличии вопросов по настройке и настройке серверов и контроллеров домена для оптимизации этого механизма.

LSASS отвечает за управление проверкой подлинности домена и управлением Active Directory в локальном центре безопасности (LSA). LSASS обрабатывает проверку подлинности как для клиента, так и для сервера, а также управляет подсистемой Active Directory. LSASS отвечает за следующие компоненты:

- Локальная система безопасности
- Служба NetLogon
- Служба диспетчера учетных записей безопасности (SAM)
- Служба LSA Server
- протокол SSL
- Протокол проверки подлинности Kerberos V5
- Протокол проверки подлинности NTLM
- Другие пакеты проверки подлинности, которые загружаются в LSA

Службы Active Directory базы данных (NTDSAI.dll) работают с расширенным подсистемой хранилища (ESE, ESENT.dll).

Ниже приведена визуальная схема использования памяти программой LSASS на контроллере домена.

![Схема компонентов, использующих память LSASS](media/domain-controller-lsass-memory-usage.png)

Объем памяти, которую LSASS использует на контроллере домена, увеличивается в соответствии с Active Directory использованием. При запросе данных они кэшируются в памяти. В результате Служба LSASS будет нормально видна с использованием объема памяти, превышающего размер файла базы данных Active Directory (NTDS. dit).

Как показано на схеме, использование памяти LSASS может быть разделено на несколько частей, включая буферный кэш базы данных ESE, хранилище версий ESE и т. д. В оставшейся части этой статьи содержится информация о каждой из этих частей.

## <a name="ese-database-buffer-cache"></a>Буферный кэш базы данных ESE
Самым большим объемом использования памяти переменной в LSASS является буферный кэш базы данных ESE. Размер кэша может варьироваться от 1 МБ до размера всей базы данных. Поскольку кэш большего размера повышает производительность, ядро СУБД для Active Directory (ESENT) пытается максимально сократить размер кэша. Хотя размер кэша зависит от нехватки памяти компьютера, максимальный размер кэша базы данных ESE ограничивается *только* объемом физической памяти, установленным на компьютере. Если нет других нехватки памяти, размер кэша может увеличиваться до размера файла базы данных Active Directory NTDS. dit. Чем больше база данных, которую можно кэшировать, тем выше производительность контроллера домена.

> [!NOTE]
> Из-за способа работы алгоритма кэширования базы данных в 64-разрядной системе, размер базы данных которой меньше объема доступной оперативной памяти, размер кэша базы данных может увеличиться до 30 – 40 процентов.

## <a name="ese-version-store"></a>Хранилище версий ESE

Хранилище версий подсистемы ESE имеет переменное использование памяти (красная часть на схеме выше). Объем используемой памяти зависит от наличия Windows Server 2019 или более старых версий Windows.

- В Windows Server версии предатинг Windows Server 2019 по умолчанию LSASS может использовать около 400 МБ памяти (в зависимости от количества ЦП) на 64-разрядном компьютере для хранилища версий ESE. Дополнительные сведения о том, как используется хранилище версий, см. в следующей записи блога АСКДС по Райан RIES: [хранилище версий с именем и все они находятся за пределами контейнеров](https://techcommunity.microsoft.com/t5/Ask-the-Directory-Services-Team/The-Version-Store-Called-and-They-8217-re-All-Out-of-Buckets/ba-p/400415).

- В Windows Server 2019 это упрощено, и при первом запуске службы NTDS размер хранилища версий ESE теперь вычисляется как 10% физической памяти, а не менее 400 МБ и не более 4 ГБ. Для получения подробных сведений об устранении неполадок в хранилище версий см. другой отличный блог от Райан RIES: [подробное описание: Active Directory изменений хранилища версий ESE на сервере 2019](https://techcommunity.microsoft.com/t5/Ask-the-Directory-Services-Team/Deep-Dive-Active-Directory-ESE-Version-Store-Changes-in-Server/ba-p/400510).

## <a name="other-memory-use"></a>Использование других памяти

Наконец, есть код, стеки, кучи и различные структуры данных фиксированного размера (например, кэш схемы). Объем памяти, используемый LSASS, может отличаться в зависимости от нагрузки на компьютер. По мере увеличения числа выполняющихся потоков, это позволяет увеличить количество стеков памяти. В среднем для этих фиксированных компонентов LSASS использует от 100 МБ до 300 МБ памяти. При установке большего объема ОЗУ LSASS может использовать больше ОЗУ и меньше виртуальной памяти.

**Ограничьте или сократите количество программ на контроллере домена или добавьте дополнительную оперативную память, если это уместно**

Для оптимальной производительности LSASS на заданном контроллере домена может иметь как можно больше ОЗУ. LSASS освобождает этот объем ОЗУ по мере того, как другие процессы запрашивают ее. Идея состоит в том, чтобы оптимизировать производительность LSASS, сохраняя при этом учет других процессов, которые могут выполняться на компьютере. Список отслеживаемых программ для включает агенты мониторинга. Некоторые клиенты имеют отдельные агенты для различных серверных функций, которые могут потреблять значительные ресурсы ОЗУ. Некоторые из них могут выдавать множество запросов WMI, для которых имеется несколько сведений ниже.

Из-за этого и для повышения производительности рекомендуется ограничить или уменьшить количество программ на контроллере домена. Если запросы к памяти отсутствуют, LSASS использует эту память для кэширования базы данных Active Directory и, следовательно, обеспечивает оптимальную производительность.

Если вы заметили, что контроллер домена имеет проблемы с производительностью, также следите за процессами с значительным использованием памяти. У них может быть проблема, которую необходимо устранить. Они могут включать компоненты Майкрософт. Убедитесь, что у вас есть последние обновления для обслуживания &mdash; . Корпорация Майкрософт предлагает решения для чрезмерного использования памяти в рамках обновлений качества, что также может помочь в производительности контроллера домена.

Существуют встроенные средства ОС, которые могут потреблять значительный объем ОЗУ в зависимости от профиля использования:

- **Файловый сервер**. Контроллеры домена также являются файловыми серверами для папок SYSVOL и Netlogon, обслуживания групповой политики и сценариев для политик и сценариев запуска и входа в систему.
  Однако мы видим, что клиенты используют контроллеры домена для обслуживания другого содержимого файлов. После этого файловый сервер SMB использует оперативную память для наблюдения за активными клиентами, но самое главное, содержимое файла сделает кэш файлов операционной системы более расти и конкурирует за кэш базы данных ESE для ОЗУ.

- **Запросы WMI**. Решения для мониторинга часто делают многие запросы WMI. Отдельный запрос может оказаться недешевой для выполнения. Часто это объем вызовов, которые вызывают некоторые издержки, особенно в случае, когда решения мониторинга извлекают новые события из различных журналов событий, управляемых Windows.

  Журнал событий, создающий самый том, обычно является журналом событий безопасности. Кроме того, это журнал событий, который администраторы безопасности хотят получать, особенно на контроллерах домена.

  Служба WMI использует схему выделения динамической памяти, которая оптимизирует запросы. Таким образом, служба WMI может выделить большой объем памяти, опять конкурирующий с кэшем базы данных ESE.
