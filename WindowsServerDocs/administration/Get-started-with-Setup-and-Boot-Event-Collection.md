---
title: Начало работы с коллекцией событий установки и загрузки
description: Настройка компьютеров-сборщиков и конечных компьютеров службы сбора событий установки и загрузки
ms.prod: windows-server
ms.service: na
manager: DonGill
ms.technology: server-sbec
ms.localizationpriority: medium
ms.date: 10/16/2017
ms.tgt_pltfrm: na
ms.topic: get-started-article
ms.assetid: fc239aec-e719-47ea-92fc-d82a7247b3f8
author: jaimeo
ms.author: jaimeo
ms.openlocfilehash: d1d24cdf481f19b37093f76cf8741702e1b4de60
ms.sourcegitcommit: 6aff3d88ff22ea141a6ea6572a5ad8dd6321f199
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/27/2019
ms.locfileid: "71370512"
---
# <a name="get-started-with-setup-and-boot-event-collection"></a>Начало работы с коллекцией событий установки и загрузки

>Область применения: Windows Server

  
## <a name="overview"></a>Обзор  
Служба сбора событий установки и загрузки — это новая функция в Windows Server 2016, которая позволяет назначить "компьютер-сборщик", который будет собирать ряд важных событий, происходящих на других компьютерах во время загрузки или процесса настройки. Затем вы можете проанализировать собранные события с помощью средства просмотра событий, анализатора сообщений, Wevtutil или командлетов Windows PowerShell.  
  
Ранее эти события было невозможно отслеживать, так как инфраструктура, необходимая для их сбора, отсутствовала до выполнения настройки компьютера. Можно осуществлять мониторинг следующих событий загрузки и установки.  
  
-   Загрузка модулей ядра и драйверов  
  
-   Перечисление устройств и инициализация драйверов (включая "устройства", такие как тип ЦП)  
  
-   Проверка и установка файловых систем  
  
-   Запуск исполняемых файлов  
  
-   Запуск и завершение обновления системы  
  
-   Точки, в которых система становится доступной для входа, устанавливает подключение с контроллером домена, моменты завершения запуска служб и выявление доступности сетевых папок  
  
Компьютер-сборщик должен работать под управлением Windows Server 2016 (в режиме сервера с возможностями рабочего стола или режиме основных серверных компонентов). Конечный компьютер должен работать под управлением Windows 10 или Windows Server 2016. Также эту службу можно запустить на виртуальной машине, размещенной на компьютере, который **не** находится под управлением Windows Server 2016. Зарегистрирована работоспособность следующих сочетаний виртуализированных сборщиков и конечных компьютеров.  
  
|Узел виртуализации|Виртуальная машина сборщик|Целевая виртуальная машина|  
|-----------------------|-----------------------------|--------------------------|  
|Windows 8.1|Да|Да|  
|Windows 10|Да|Да|  
|Windows Server 2016|Да|Да|  
|Windows Server 2012 R2|Да|Нет|  
  
## <a name="installing-the-collector-service"></a>Установка службы сборщика  
Начиная с Windows Server 2016 служба сборщика событий доступна как дополнительный компонент. В этом выпуске службу можно установить используя DISM.exe с помощью следующей команды в командной строке Windows PowerShell с повышенными привилегиями.  
  
`dism /online /enable-feature /featurename:SetupAndBootEventCollection`  
  
Эта команда создает службу с именем BootEventCollector и запускает ее с пустым файлом конфигурации.  
  
Убедитесь, что установка была выполнена успешно, проверив `get-service -displayname *boot*`. Сборщик событий загрузки должен быть запущен. Он выполняется от имени учетной записи сетевой службы и создает пустой файл конфигурации (Active.xml) в расположении **%SystemDrive%\ProgramData\Microsoft\BootEventCollector\Config**.  
  
Также службу сбора событий установки и загрузки можно установить с помощью мастера добавления ролей и компонентов в диспетчере серверов.  
  
## <a name="configuration"></a>Настройка  
Для сбора событий загрузки и установки необходимо настроить два элемента.  
  
-   На конечных компьютерах, которые будут отправлять события (то есть на компьютерах, настройку и загрузку которых требуется отслеживать), включите передачу KDNET/EVENT-NET и пересылку событий.  
  
-   На компьютере-сборщике укажите, с каких компьютеров следует принимать события и где их сохранять.  
  
> [!NOTE]  
> Настроить компьютер для отправки событий настройки и загрузки самому себе невозможно. Однако если требуется осуществлять мониторинг двух компьютеров, можно настроить их для отправки событий друг другу.  
  
### <a name="configuring-a-target-computer"></a>Настройка конечного компьютера  
На каждом конечном компьютере сначала включите передачу KDNET/EVENT-NET, затем включите отправку событий трассировки событий Windows через транспорт, а затем перезагрузите конечный компьютер. EVENT-NET — это встроенный в ядро транспортный протокол, который похож на протокол KDNET (протокол отладчика ядра). Протокол EVENT-NET используется только для передачи событий и не поддерживает доступ отладчика. Эти два протокола являются взаимоисключающими; одновременно можно включить только один из них.  
  
Передачу событий можно включить удаленно (с помощью Windows PowerShell) или локально.  
  
##### <a name="to-enable-event-transport-remotely"></a>Чтобы включить передачу событий удаленно, выполните следующие действия.  
  
1.  Если вы уже настроили службу удаленного взаимодействия Windows PowerShell на конечном компьютере, перейдите к шагу 3. В противном случае на конечном компьютере откройте командную строку и выполните следующую команду:  
  
    winrm quickconfig  
  
2.  Выполните действия в отображающихся запросах и перезагрузите конечный компьютер. Если конечный компьютер находится в домене, отличном от домена компьютера-сборщика, может потребоваться определить их качестве доверенных узлов. Выполните указанные ниже действия.  
  
3.  На компьютере-сборщике выполните одну из следующих команд:  
  
    -   В командной строке Windows PowerShell: `Set-Item -Force WSMan:\localhost\Client\TrustedHosts "<target1>,<target2>,..."`, затем `Set-Item -Force WSMan:\localhost\Client\AllowUnencrypted true`, где \<Target1 > и т. д. — это имена или IP-адреса конечных компьютеров.  
  
    -   Или в командной строке: **WinRM set winrm/config/client @ {TrustedHosts = "\<target1 >,\<target2 >,..."; Алловуненкриптед = "true"}**  
  
        > [!IMPORTANT]  
        > Это действие настраивает незашифрованную связь, поэтому не делайте этого за пределами тестовой среды.  
  
4.  Проверьте удаленное подключение, перейдя на компьютер-сборщик и выполнив одну из следующих команд Windows PowerShell:  
  
    Если целевой компьютер находится в том же домене, что и компьютер сборщика, запустите `New-PSSession -Computer <target> | Remove-PSSession`  
  
    Если конечный компьютер находится в другом домене, выполните команду `New-PSSession -Computer  <target>  -Credential Administrator | Remove-PSSession`, которая предложит ввести учетные данные.  
  
    Если команда не вернет никаких результатов, это значит, что удаленное взаимодействие было установлено успешно.  
  
5.  На конечном компьютере откройте командную строку Windows PowerShell с повышенными привилегиями и выполните следующую команду:  
  
    `Enable-SbecBcd -ComputerName <target_name> -CollectorIP <ip> -CollectorPort <port> -Key <a.b.c.d>`  
  
    Здесь < target_name > — это имя конечного компьютера, \<IP > — это IP-адрес компьютера сборщика. \<порт > — номер порта, на котором будет выполняться сборщик. Ключ <a.b.c.d> является обязательным ключом шифрования для обмена данными. Он состоит из четырех буквенно-цифровых строк, разделенных точками. Этот же ключ используется на компьютере-сборщике. Если не ввести ключ, система сформирует случайный ключ; он вам потребуется для компьютера-сборщика, поэтому запишите его.  
  
6.  Если компьютер-сборщик уже настроен, обновите файл конфигурации на компьютере-сборщике сведениями для нового конечного компьютера. Для получения дополнительных сведений см. раздел "Настройка компьютера-сборщика".  
  
##### <a name="to-enable-event-transport-locally-on-the-target-computer"></a>Включение передачи событий локально на конечном компьютере  
  
1.  Запустите командную строку с повышенными привилегиями, а затем выполните следующие команды:  
  
    **BCDEdit/Евент да**  
  
    **BCDEdit/евентсеттингс NET хостип: 1.2.3.4 порт: 50000 ключ: a. b. c. d**  
  
    Здесь значение "1.2.3.4" приведено в качестве примера; замените его IP-адресом компьютера-сборщика. Также замените значение "50000" номером порта, на котором будет работать сборщик, а значение "a.b.c.d" — ключом шифрования для обмена данными. Этот же ключ используется на компьютере-сборщике. Если не ввести ключ, система сформирует случайный ключ; он вам потребуется для компьютера-сборщика, поэтому запишите его.  
  
2.  Если компьютер-сборщик уже настроен, обновите файл конфигурации на компьютере-сборщике сведениями для нового конечного компьютера. Для получения дополнительных сведений см. раздел "Настройка компьютера-сборщика".  
  
**Теперь, когда включен сам транспорт событий, необходимо включить систему для фактической отправки событий ETW через этот транспорт.**  
  
##### <a name="to-enable-sending-of-etw-events-through-the-transport-remotely"></a>Удаленное включение отправки событий трассировки событий Windows через транспорт  
  
1.  На компьютере-сборщике откройте командную строку Windows PowerShell с повышенными привилегиями.  
  
2.  Выполните команду `Enable-SbecAutologger -ComputerName <target_name>`, где <target_name> — это имя конечного компьютера.  
  
Если вы не можете настроить удаленное взаимодействие Windows PowerShell, всегда можно включить отправку событий непосредственно на конечный компьютер.  
  
##### <a name="to-enable-sending-of-etw-events-through-the-transport-locally"></a>Локальное включение отправки событий трассировки событий Windows через транспорт  
  
1.  На конечном компьютере запустите Regedit.exe и найдите этот раздел реестра:  
  
    **HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\WMI\AutoLogger**. В этом разделе различные сеансы входа размещены в виде подразделов. Со службой сбора событий загрузки и настройки можно использовать сеансы **Setup Platform**, **NT Kernel Logger** и **Microsoft-Windows-Setup**, однако рекомендуемым сеансом является **EventLog-System**. Эти разделы подробно рассмотрены в статье [Настройка и запуск сеанса авторегистратора](https://msdn.microsoft.com/library/windows/desktop/aa363687(v=vs.85).aspx).  
  
2.  В разделе EventLog-System измените значение **LogFileMode** с **0x10000180** на **0x10080180**. Дополнительные сведения об этих параметрах см. в разделе [Константы режима ведения журнала](https://msdn.microsoft.com/library/windows/desktop/aa364080(v=vs.85).aspx).  
  
3.  При необходимости можно включить переадресацию данных о проверке ошибок на компьютер-сборщик. Для этого найдите раздел реестра HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager и создайте раздел **Debug Print Filter** со значением **0x1**.  
  
4.  Перезагрузите конечный компьютер.  
  
### <a name="choosing-the-network-adapter"></a>Выбор сетевого адаптера  
Если на конечном компьютере установлено несколько сетевых адаптеров, драйвер KDNET выберет первый поддерживаемый адаптер в списке. Можно указать определенный сетевой адаптер для переадресации событий настройки, выполнив следующие действия.  
  
##### <a name="to-specify-a-network-adapter"></a>Определение сетевого адаптера  
  
1.  На конечном компьютере откройте диспетчер устройств, разверните узел **Сетевые адаптеры**, найдите сетевой адаптер, который вы хотите использовать, и щелкните его правой кнопкой мыши.  
  
2.  В открывшемся меню выберите пункт **Свойства** и перейдите на вкладку **Сведения**. Разверните меню в поле **Свойства**, прокрутите список до пункта **Сведения о расположении** (список, вероятнее всего, будет представлен не в алфавитном порядке) и выберите его. Значением будет строка в виде **PCI bus X, device Y, function Z** (Шина PCI X, устройство Y, функция Z). Запишите значения X.Y.Z; эти параметры шины необходимы для выполнения следующей команды.  
  
3.  Выполните одну из следующих команд:  
  
    Из командной строки Windows PowerShell с повышенными привилегиями: `Enable-SbecBcd -ComputerName <target_name> -CollectorIP <ip> -CollectorPort <port> -Key <a.b.c.d> -BusParams <X.Y.Z>`  
  
    Из командной строки с повышенными привилегиями: **bcdedit /eventsettings  net hostip:aaa port:50000 key:bbb busparams:X.Y.Z**  
  
### <a name="validate-target-computer-configuration"></a>Проверка конфигурации конечного компьютера  
Чтобы проверить параметры на конечном компьютере, откройте командную строку с повышенными привилегиями и выполните команду **bcdedit/enum**. По завершении выполните команду **bcdedit /eventsettings**. Еще раз проверьте следующие значения:  
  
-   Раздел  
  
-   Debugtype = NET  
  
-   Хостип = \<IP-адрес сборщика >  
  
-   Port = \<номер порта, который вы указали для использования сборщиком >  
  
-   DHCP = Да  
  
Также поверьте, что вы включили **bcdedit /event**, поскольку **/debug** и **/event** являются взаимоисключающими. Можно выполнить только одну из двух команд. Аналогичным образом нельзя смешивать /eventsettings с /debug или /dbgsettings с /event.  
  
Обратите внимание, что сбор событий не будет работать, если задать его для последовательного порта.  
  
### <a name="configuring-the-collector-computer"></a>Настройка компьютера-сборщика  
Служба сборщика получает события и сохраняет их в ETL-файлах. Затем эти ETL-файлы можно открыть другими средствами, такими как "Просмотр событий", "Анализатор сообщений", Wevtutil и командлеты Windows PowerShell.  
  
Поскольку формат ETW не позволяет указать имя конечного компьютера, события для каждого конечного компьютера необходимо сохранять в отдельном файле. Средства отображения могут показывать имя компьютера, но это будет имя компьютера, на котором запущено средство.  
  
Точнее говоря, каждому конечному компьютеру назначается цикл ETL-файлов. Имя каждого файла включает в себя индекс от 000 до максимального значения, которое вы зададите (до 999). По достижении файлом максимального заданного размера происходит переключение на запись событий в другой файл. По достижении максимального значения в 999 происходит переключение на файл с индексом 000. Таким образом файлы автоматически циклируются, ограничивая использование места на диске. Также можно настроить дополнительные внешние политики хранения для дальнейшего ограничения использования места на диске; например, можно удалять файлы, срок хранения которых превысил заданное число дней.  
  
Обычно собранные ETL-файлы хранятся в каталоге **c:\ProgramData\Microsoft\BootEventCollector\Etl** (который может содержать дополнительные вложенные папки). Самый последний файл журнала можно найти путем сортировки файлов по времени последнего изменения. Кроме того, существует журнал состояний (как правило, он находится в **c:\ProgramData\Microsoft\BootEventCollector\Logs**), в который записываются состояния переключения сборщика на запись в новый файл.  
  
Также существует журнал сборщика, который записывает сведения о самом сборщике. Этот журнал можно хранить в формате ETW (он передает события службе журнала Windows по умолчанию) или в файле (обычно в **c:\ProgramData\Microsoft\BootEventCollector\Logs**). Использовать файл полезно, когда требуется включить режимы подробного протоколирования, создающие большие объемы данных. Также можно настроить журнал на запись в стандартный выходной файл, запустив сборщик из командной строки.  
  
**Создание файла конфигурации сборщика**  
  
При включении службы создаются три XML-файла конфигурации и сохраняются в **к:\програмдата\микрософт\бутевентколлектор\конфиг**:  
  
-   **Active.xml** Этот файл содержит текущую активную конфигурацию службы сборщика.  Непосредственно после установки, этот файл содержит те же данные, что и файл Empty.xml. При настройке новой конфигурации сборщика, она сохраняется в этот файл.  
  
-   **Empty.xml** Этот файл содержит минимальный набор необходимых элементов конфигурации со значениями, заданными по умолчанию. Он не активирует процесс сбора, лишь позволяет службе сборщика запуститься в режиме простоя.  
  
-   **Example.xml** Этот файл предоставляет примеры и объяснения возможных элементов конфигурации.  
  
**Выбор предельного размера файла**  
  
Один из решений, которое вам необходимо принять — это задать ограничение на размер файла. Наиболее подходящее ограничение на размер файла зависит от ожидаемого объема событий и доступного места на диске. Файлы меньшего размера являются более удобными с точки зрения очистки старых данных. Однако каждый файл содержит дополнительные затраты на 64 КБ и чтение большого количества файлов для получения Объединенного журнала может оказаться неудобным. Абсолютный минимальный размер файла — 256 КБ. Целесообразное ограничение на размер файла с точки зрения практичности должно составлять около 1 МБ, а 10 МБ, вероятно, будут хорошим стандартным значением. Более жесткое ограничение может быть целесообразным, если ожидается большое количество событий.  
  
Следует помнить о некоторых сведениях относящихся к файлу конфигурации:  
  
-   Адрес конечного компьютера. Можно использовать IPv4-адрес, MAC-адрес или идентификатор GUID SMBIOS. При выборе адреса для использования необходимо учитывайте следующие факторы:  
  
    -   IPv4-адрес хорошо работает с назначением статических IP-адресов. Тем не менее даже статический IP-адрес должен быть доступен через DHCP.  
  
    -   MAC-адрес или идентификатор GUID SMBIOS удобно использовать, если они известны заранее, однако IP-адреса назначаются динамически.  
  
    -   Протокол EVENT-NET не поддерживает IPv6-адреса.  
  
    -   Можно указать несколько способов идентификации компьютера. Например, если планируется замена физического оборудования, можно ввести старый и новой MAC-адреса, и любой из них будет принят.  
  
-   Ключ шифрования, используемый для связи с компьютером-сборщиком.  
  
-   Имя конечного компьютера. В качестве имени компьютера можно использовать IP-адрес, имя узла или любое другое имя.  
  
-   Имя используемого ETL-файла и настройка размера цикла для него.  
  
##### <a name="to-create-the-configuration-file"></a>Создание файла конфигурации  
  
1.  Откройте командную строку Windows PowerShell с повышенными привилегиями и перейдите в каталог %SystemDrive%\ProgramData\Microsoft\BootEventCollector\Config.  
  
2.  Введите `notepad .\newconfig.xml` и нажмите клавишу ВВОД.  
  
3.  Скопируйте этот пример конфигурации в окне программы "Блокнот":  
  
    ```  
    <collector configVersionMajor="1" statuslog="c:\ProgramData\Microsoft\BootEventCollector\Logs\statuslog.xml">  
      <common>  
        <collectorport value="50000"/>  
        <forwarder type="etl">  
          <set name="file" value="c:\ProgramData\Microsoft\BootEventCollector\Etl\{computer}\{computer}_{#3}.etl"/>  
          <set name="size" value="10mb"/>  
          <set name="nfiles" value="10"/>  
          <set name="toxml" value="none"/>  
        </forwarder>  
        <target>  
          <ipv4 value="192.168.1.1"/>  
          <key value="a.b.c.d"/>  
          <computer value="computer1"/>  
        </target>  
        <target>  
          <ipv4 value="192.168.1.2"/>  
          <key value="d1.e2.f3.g4"/>  
          <computer value="computer2"/>  
        </target>  
      </common>  
    </collector>  
    ```  
  
    > [!NOTE]  
    > Корневой узел — \<> сборщика. Его атрибуты задают версию синтаксиса файла конфигурации и имя файла журнала состояний.  
    >   
    > \<общие группы элементов > объединяет несколько целевых объектов, в которых указываются общие элементы конфигурации для них, очень точно так же, как группа пользователей, может использоваться для указания общих разрешений для нескольких пользователей.  
    >   
    > Элемент \<коллекторпорт > определяет номер порта UDP, по которому сборщик будет прослушивать входящие данные. Это тот же порт, который был указан на этапе настройки конфигурации конечного компьютера для Bcdedit. Сборщик поддерживает только один порт и все остальные конечные компьютеры должны подключаться к тому же порту.  
    >   
    > Элемент \<сервера пересылки > указывает, как будут перенаправляться события ETW, полученные от целевых компьютеров. Существует только один тип сервера пересылки, который записывает события в ETL-файлы. Параметры определяют шаблон имени файла, предельный размер каждого файла в цикле и размер цикла для каждого компьютера. Параметр "toxml" определяет, что события трассировки событий Windows будут записываться в двоичном формате как и при их получении, то есть без преобразования в формат XML. В разделе "Преобразование событий XML" см. инструкции о том, в каких случаях следует преобразовывать события в формат XML. Шаблон имени файла содержит следующие подстановки: {computer} для имени компьютера и {#3} для индекса файла в цикле.  
    >   
    > В этом примере файла на двух целевых компьютерах определяется элемент \<Target >. В каждом определении указывается IP-адрес с \<> IPv4. но вы также можете использовать MAC-адрес (например, < Mac value = "11:22:33:44:55:66)\/> или < Mac value =" 11-22-33-44-55-66 "\/>) или SMBIOS GUID (например, < GUID value =" {269076F9-4B77-46E1-B03B-CA5003775B88} "\/>) для определения конечного компьютера. Также запишите ключ шифрования (тот же, который был указан или сформирован с помощью файлы Bcdedit на конечном компьютере) и имя компьютера.  
  
4.  Введите сведения для каждого целевого компьютера в виде отдельного \<целевого > элемента в файле конфигурации, а затем сохраните файл документе newconfig. XML и закройте Блокнот.  
  
5.  Примените новую конфигурацию с помощью `$result = (Get-Content .\newconfig.xml | Set-SbecActiveConfig); $result`. Выходные данные должны вернуть значение "true" в поле "Готово". При получении другого результата обратитесь к теме "Устранение неполадок" в этом разделе.  
  
Всегда можно проверить текущую активную конфигурацию с помощью `(Get-SbecActiveConfig).text`.  
  
Можно выполнить проверку допустимости файла конфигурации с помощью `$result = (Get-Content .\newconfig.xml | Check-SbecConfig); $result`.  
  
Несмотря на то что команда Windows PowerShell для применения новой конфигурации автоматически обновляет службу без необходимости в ее перезапуске, службу также можно перезапустить самостоятельно с помощью одной из следующих команд.  
  
-   С помощью Windows PowerShell: `Restart-Service BootEventCollector`  
  
-   В обычной командной строке: **sc stop BootEventCollector; sc start BootEventCollector**  
  
## <a name="configuring-nano-server-as-a-target-computer"></a>Настройка сервера Nano Server в качестве конечного компьютера  
Возможностей интерфейса, предлагаемого сервером Nano Server, в некоторых случаях может не хватать для диагностики проблем сервера. Можно настроить образ сервера Nano Server на автоматическое участие в сборе событий настройки и загрузки и отправку диагностических данных компьютеру-сборщику без дальнейшего вмешательства со стороны пользователя. Для этого выполните следующие действия:  
  
#### <a name="to-configure-nano-server-as-a-target-computer"></a>Настройка сервера Nano Server в качестве конечного компьютера  
  
1.  Создайте базовый образ сервера Nano Server. См. раздел [Начало работы с сервером Nano Server](https://technet.microsoft.com/library/mt126167.aspx) для получения дополнительных сведений.  
  
2.  Настройте компьютер-сборщик в соответствии с инструкциями в разделе "Настройка компьютера-сборщика".  
  
3.  Добавьте разделы реестра авторегистратора, чтобы активировать отправку сообщений диагностики. Для этого необходимо подключить виртуальный жесткий диск сервера Nano Server, созданный в ходе шага 1, загрузить куст реестра, а затем добавить определенные разделы реестра. В этом примере образ сервера Nano Server находится в C:\NanoServer; ваш путь может отличаться, поэтому действуйте соответствующим образом.  
  
    1.  На компьютере-сборщике скопируйте папку **..\Windows\System32\WindowsPowerShell\v1.0\Modules\BootEventCollector**и вставьте ее в каталог **..\Windows\System32\WindowsPowerShell\v1.0\Modules** на компьютере, который используется для изменения виртуального жесткого диска сервера Nano Server.  
  
    2.  Запустите консоль Windows PowerShell с повышенными разрешениями и выполните команду `Import-Module BootEventCollector`.  
  
    3.  Обновите виртуальный жесткий диска сервера Nano Server для включения авторегистраторов. Для этого выполните команду `Enable-SbecAutoLogger -Path C:\NanoServer\Workloads\IncludingWorkloads.vhd`. При этом будет добавлен простой список наиболее стандартных событий настройки и загрузки; с другим событиями можно ознакомиться в разделе [Управление сеансами трассировки событий](https://msdn.microsoft.com/library/windows/desktop/aa363694(v=vs.85).aspx).  
  
4.  Обновите параметры данных конфигурации загрузки в образе сервера Nano Server для включения флага "События" и настройте компьютер-сборщик, чтобы проверить, что события диагностики передаются на правильный сервер. Запишите IPv4-адрес, TCP-порт и ключ шифрования компьютера, которые вы настроили в файле Active.XML сборщика (см. инструкции в этом разделе). Используйте эту команду в консоли Windows PowerShell с повышенными разрешениями: `Enable-SbecBcd -Path C:\NanoServer\Workloads\IncludingWorkloads.vhd -CollectorIp 192.168.100.1 -CollectorPort 50000 -Key a.b.c.d`  
  
5.  Обновите компьютер-сборщик для получения событий, отправляемых компьютером сервера Nano Server, добавив диапазон IPv4-адресов, конкретный IPv4-адрес или MAC-адрес сервера Nano Server в файл Active.XML на компьютере-сборщике (см. тему "Настройка компьютера-сборщика" в этом разделе).  
  
## <a name="starting-the-event-collector-service"></a>Запуск службы сборщика событий  
После сохранения допустимого файла конфигурации на компьютере-сборщике и конечном компьютере, сразу после перезапуска конечного компьютера выполняется подключение к сборщику и начинается сбор событий.  
  
Журнал самой службы сбора (он отличается от данных загрузки и настройки, собираемых службой) можно найти в разделе Microsoft-Windows-BootEvent-Collector/Admin. Для графического отображения событий используйте компонент "Просмотр событий". Создайте новое представление; разверните узел **Журналы приложений и служб**, затем разверните узел **Microsoft**, а затем — **Windows**. Найдите узел **BootEvent-Collector**, разверните его и найдите узел **Admin**.  

-   С помощью Windows PowerShell: `Get-WinEvent -LogName Microsoft-Windows-BootEvent-Collector/Admin`  
  
-   В обычной командной строке: **wevtutil qe Microsoft-Windows-BootEvent-Collector/Admin**  
  
## <a name="troubleshooting"></a>Поиск и устранение неисправностей  
  
### <a name="troubleshooting-installation-of-the-feature"></a>Устранение неполадок при установке компонента  
  
||Ошибка|Описание ошибки|Признак|Потенциальная проблема|  
|-|---------|---------------------|-----------|---------------------|  
|Dism.exe|87|Параметр имени компонента не распознается в данном контексте||– Это может произойти, если неправильно введено имя компонента. Проверьте правильность имени и повторите попытку.<br />– Убедитесь, что эта функция доступна в версии операционной системы, которую вы используете. В Windows PowerShell выполните **dism /online /get-features &#124; ?{$_ -match "boot"}** . Отсутствие совпадения означает, что вы, вероятно, используете версию ОС, которая не поддерживает эту функцию.|  
|Dism.exe|0x800f080c|Неизвестное имя компонента \<>.||То же самое, что и выше|  
  
### <a name="troubleshooting-the-collector"></a>Устранение неполадок сборщика  
  
**Подробности**  
Сборщик ведет журнал собственных событий в качестве поставщика трассировки событий Windows в разделе Microsoft-Windows-BootEvent-Collector. Для поиска и устранения проблем в работе сборщика в первую очередь следует исследовать этот раздел. Проблемные события можно найти с помощью средства "Просмотр событий" в разделе "Журналы приложений и служб > Microsoft > Windows > BootEvent-Collector > Admin" или можно читать их в окне командной строки с помощью одной из следующих команд:  
  
В обычной командной строке: **wevtutil qe Microsoft-Windows-BootEvent-Collector/Admin**  
  
В командной строке Windows PowerShell: `Get-WinEvent -LogName Microsoft-Windows-BootEvent-Collector/Admin` (можно добавить `-Oldest` для возврата списка в хронологическом порядке, начиная с самых ранних событий)  
  
Можно настроить уровень детализации в журналах, используя уровни "error – ошибка", "warning – предупреждение", "info – сведения" (по умолчанию), "verbose – подробно" и "debug – отладка". Уровни детализации, которые предоставляют более подробные данные, чем уровень "сведения", полезны для диагностики проблем, связанных с невозможностью подключения конечных компьютеров, однако они могут создавать большой объем данных, поэтому их следует использовать с осторожностью.  
  
Минимальный уровень ведения журнала можно задать в элементе сборщика \<> файла конфигурации. Например: < сборщик Конфигверсионмажор = "1" минлог\="verbose" >.  
  
На подробном уровне детализации происходит регистрация записей для каждого получаемого пакета по мере его обработки. Уровень отладки добавляет дополнительные данные обработки и дампы, также содержащие все полученные пакеты трассировки событий Windows.  
  
На уровне отладки может быть полезно записывать журнал в файл вместо того, чтобы просматривать его в обычной системе ведения журналов. Для этого добавьте дополнительный элемент в элемент сборщика \<> файла конфигурации:  
  
< сборщик Конфигверсионмажор = "1" минлог = "Отладка" log\="К:\програмдата\микрософт\бутевентколлектор\логс\лог.ткст" >  
      
 **Предлагаемый подход к устранению неполадок сборщика:**  
   
1. Прежде всего убедитесь, что сборщик получил подключение от конечного компьютера (он создаст файл только при запуске отправки сообщений конечным компьютером), выполнив команду   
   ```  
   Get-SbecForwarding  
   ```  
   При возврате результата, указывающего на то, что от этого конечного компьютера установлено подключение, проблема может заключаться в параметрах авторегистратора. Отсутствие результатов выполнения команды будет свидетельствовать о том, что проблема заключается в подключении KDNET. Для диагностики проблем подключения KDNET попробуйте проверить подключение от обеих сторон (то есть от компьютера-сборщика и от конечного компьютера).  
  
2. Чтобы просмотреть расширенную диагностику из сборщика, добавьте ее в элемент > сборщика \<файла конфигурации:  
   Сборщик \<... минлог = "verbose" >  
   Это позволит получать сообщения о каждом полученном пакете.  
3. Проверьте, происходит ли получение каких-либо пакетов в принципе. Кроме того, можно записать журнал в режиме подробного протоколирования непосредственно в файл, а не через трассировку событий Windows. Для этого добавьте его в элемент сборщика \<> файла конфигурации:  
   Сборщик \<... минлог = "verbose" log = "К:\програмдата\микрософт\бутевентколлектор\логс\лог.ткст" >  
      
4. Проверьте журналы событий на наличие сообщений о полученных пакетах. Проверьте, происходит ли получение каких-либо пакетов в принципе. Если получение пакетов выполняется, но они неправильные, просмотрите сообщения о событиях для получения дополнительных сведений.  
5. На стороне конечного компьютера KDNET записывает некоторые диагностические сведения в реестр. Поиск в   
   **HKLM\SYSTEM\CurrentControlSet\Services\kdnet**.  
   KdInitStatus (DWORD) будет равно 0 при успешном выполнении и отобразит код ошибки при возникновении ошибки  
   KdInitErrorString = объяснение ошибки (также содержит информационные сообщения при отсутствии ошибки)  
  
6. Запустите Ipconfig.exe на конечном компьютере и посмотрите, какое имя устройства будет возвращено. При правильной загрузке KDNET именем устройства будет что-то вроде "kdnic" вместо исходного имени карты поставщика.  
7. Проверьте, настроен ли протокол DHCP для конечного компьютера. Для использования KDNET абсолютно необходимо наличие протокола DHCP.  
8. Убедитесь, что компьютер-сборщик находится в той же сети, что и конечный компьютер. Если это не так, проверьте правильность настройки маршрутизации, в частности, параметр шлюза по умолчанию для DHCP.  
  
  
**Состояние подключения**  
  
Вы можете проверить текущий список установленных подключений и сведения о том, куда перенаправляются данные, с помощью `Get-SbecForwarding`.  
  
Также можно получить актуальный журнал с изменениями состояния подключений с помощью `Get-SbecHistory`.  
  
### <a name="troubleshooting-setting-a-new-configuration"></a>Устранение неполадок в настройке новой конфигурации  
Если вы применили конфигурацию с помощью команды Windows PowerShell `$result = (Get-Content .\newconfig.xml | Set-SbecActiveConfig); $result`, то переменная `$result` будет содержать сведения о развертывании. Можно выполнить запрос к этой переменной для получения из нее различных сведений.  
  
Получение сведений об ошибках с помощью `$result.ErrorString`. При возврате сообщений об ошибках новая конфигурация не применяется и прежняя конфигурация остается неизменной.  
  
Получение предупреждений с помощью `$result.WarningString`.  
  
Получение информации о конфигурации с помощью `$result.InfoString`.  
  
Полные результаты можно получить с помощью `$result | fl *`.  
Кроме того, если вы не хотите сохранять результат в переменной, можно использовать `Get-Content .\newconfig.xml | Set-SbecActiveConfig | fl *`.  
  
### <a name="troubleshooting-target-computers"></a>Устранение неполадок в работе конечных компьютеров  
  
||Ошибка|Описание ошибки|Признак|Потенциальная проблема|  
|-|---------|---------------------|-----------|---------------------|  
|Конечный компьютер||Конечный компьютер не подключается к службе сбора||– Конечный компьютер не перезапустился после его настройки. Перезагрузите конечный компьютер.<br />– На конечном компьютере заданы неправильные параметры данных конфигурации загрузки. Проверьте параметры в разделе "Проверка параметров конечного компьютера". При необходимости исправьте их и перезагрузите конечный компьютер.<br />– Драйвер KDNET/EVENT-NET не может подключиться к сетевому адаптеру или подключился к неправильному сетевому адаптеру. В Windows PowerShell выполните команду `gwmi Win32_NetworkAdapter` и просмотрите выходные данные для сетевого адаптера с именем службы (ServiceName) **kdnic**. Если выбран неверный сетевой адаптер, повторно выполните действия, описанные в разделе "Определение сетевого адаптера". Если сетевой адаптер не отображается, возможно, драйвер не поддерживает ваши сетевые адаптеры.<br>**См. также** раздел "Предлагаемый подход по устранению неполадок в работе сборщика" выше, в частности, шаги 5–8.|  
|Сборщик||После переноса виртуальной машины, на которой размещен сборщик, перестали отображаться события.||Убедитесь, что IP-адрес компьютера-сборщик не был изменен. Если он был изменен, см. раздел "Удаленное включение отправки событий трассировки событий Windows через транспорт".|  
|Сборщик||Не создаются ETL-файлы.|`Get-SbecForwarding` показывает, что целевой объект подключен, без ошибок, но ETL-файлы не создаются.|Вероятно, конечный компьютер еще не отправил никакие данные; ETL-файлы создаются только при получении данных.|  
|Сборщик||Событие не отображается в ETL-файле.|Конечный компьютер отправил событие, но при считывании ETL-файла с помощью средств "Просмотр событий" или "Анализатор сообщений", событие отсутствует.|– Событие может находиться по-прежнему в буфере. События не записываются в ETL-файл, пока не заполнится буфер (64 КБ), или если в течение времени ожидания в 10–15 секунд не появятся новые события. Подождите, пока истечет время ожидания или очистите буферы с помощью `Save-SbecInstance`.<br />– Манифест события недоступен на компьютере-сборщике или на компьютере, на котором выполняются средства "Просмотр событий" или "Анализатор сообщений".  В этом случае сборщик, возможно, не может обработать событие (проверьте журнал сборщика) или средство просмотра не может отобразить его.  Рекомендуется, чтобы все манифесты и обновления были установлены на компьютере-сборщике перед их установкой на конечных компьютерах.|
