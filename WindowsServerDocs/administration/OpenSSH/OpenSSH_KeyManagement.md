---
ms.date: 09/27/2018
ms.topic: conceptual
keywords: OpenSSH, SSH, SSHD, установка, установка
contributor: maertendMSFT
author: maertendMSFT
title: Конфигурация сервера OpenSSH для Windows
ms.product: w10
ms.openlocfilehash: ed9f3653c79f1329b1334f52fe14c1184bc99539
ms.sourcegitcommit: f6490192d686f0a1e0c2ebe471f98e30105c0844
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/10/2019
ms.locfileid: "70866867"
---
# <a name="openssh-key-management"></a>Управление ключами OpenSSH

Большинство проверок подлинности в средах Windows выполняется с помощью пары "имя пользователя — пароль".
Это хорошо подходит для систем, использующих общий домен. При работе с несколькими доменами, например между локальными и облачными системами, это усложняется.

По сравнению, среды Linux часто используют пары открытого и закрытого ключей для проверки подлинности.
OpenSSH включает в себя средства для поддержки этого, в частности:

* __SSH-Keygen__ для создания безопасных ключей
* __ssh-agent__ и __SSH-Add__ для безопасного хранения закрытых ключей
* __SCP__ и __SFTP__ для безопасного копирования файлов открытых ключей во время первоначального использования сервера

В этом документе представлен обзор использования этих средств в Windows для начала использования проверки подлинности ключей с помощью SSH. Если вы не знакомы с управлением ключами SSH, настоятельно рекомендуем ознакомиться с [документом NIST IR 7966](http://nvlpubs.nist.gov/nistpubs/ir/2015/NIST.IR.7966.pdf) под названием "Безопасность интерактивного и автоматического управления доступом с помощью Secure Shell (SSH)".

## <a name="about-key-pairs"></a>Сведения о парах ключей

Пары ключей ссылаются на файлы открытого и закрытого ключей, используемые некоторыми протоколами проверки подлинности. 

Проверка подлинности с открытым ключом SSH использует асимметричные алгоритмы шифрования для создания двух ключевых файлов — один "частный", а другой — "Public". Файлы закрытых ключей эквивалентны паролю и должны защищаться во всех обстоятельствах. Если кто-то получит ваш закрытый ключ, он сможет войти в систему любого сервера SSH, к которому у вас есть доступ. Открытый ключ размещается на сервере SSH и может использоваться совместно, не нарушая закрытый ключ.

При использовании проверки подлинности с помощью ключа на сервере SSH сервер и клиент SSH сравнивают открытый ключ для имени пользователя, предоставленного закрытому ключу. Если открытый ключ не может быть проверен с помощью закрытого ключа на стороне клиента, проверка подлинности завершается ошибкой. 

Многофакторная идентификация может быть реализована с помощью пар ключей, поэтому при создании пары ключей необходимо указать парольную фразу (см. раздел Создание ключей ниже). Во время проверки подлинности пользователю предлагается ввести парольную фразу, которая используется вместе с закрытым ключом клиента SSH для проверки подлинности пользователя. 

## <a name="host-key-generation"></a>Создание ключа узла

Открытые ключи имеют определенные требования к ACL, которые в Windows приравниваются только к администраторам и системам. Чтобы упростить эту задачу, 

* Модуль PowerShell Опенсшутилс был создан для правильного задания списков управления доступом к ключам и должен быть установлен на сервере.
* При первом использовании sshd пара ключей для узла будет создана автоматически. Если выполняется ssh-agent, ключи будут автоматически добавляться в локальное хранилище. 

Чтобы упростить проверку подлинности с помощью сервера SSH, выполните следующие команды в командной строке PowerShell с повышенными привилегиями:

```powershell

# Install the OpenSSHUtils module to the server. This will be valuable when deploying user keys.
Install-Module -Force OpenSSHUtils -Scope AllUsers

# Start the ssh-agent service to preserve the server keys
Start-Service ssh-agent

# Now start the sshd service
Start-Service sshd
```

Так как нет пользователя, связанного со службой sshd, ключи узла хранятся в папке \Програмдата\сш.


## <a name="user-key-generation"></a>Создание пользовательских ключей

Чтобы использовать проверку подлинности на основе ключей, сначала необходимо создать для клиента некоторые пары открытого и закрытого ключей. В PowerShell или cmd используйте ssh-keygen для создания некоторых файлов ключей.

```powershell
cd ~\.ssh\
ssh-keygen
```

Должно отобразиться примерно следующее (где "Username" заменяется именем пользователя).

```
Generating public/private ed25519 key pair.
Enter file in which to save the key (C:\Users\username\.ssh\id_ed25519):
```

Можно нажать клавишу ВВОД, чтобы принять значение по умолчанию, или указать путь, по которому будут создаваться ключи. На этом этапе вам будет предложено использовать парольную фразу для шифрования файлов закрытого ключа.
Парольная фраза работает с файлом ключа для обеспечения 2-факторной проверки подлинности. В этом примере парольная фраза остается пустой. 

```
Enter passphrase (empty for no passphrase): 
Enter same passphrase again: 
Your identification has been saved in C:\Users\username\.ssh\id_ed25519.
Your public key has been saved in C:\Users\username\.ssh\id_ed25519.pub.
The key fingerprint is: 
SHA256:OIzc1yE7joL2Bzy8!gS0j8eGK7bYaH1FmF3sDuMeSj8 username@server@LOCAL-HOSTNAME

The key's randomart image is:
+--[ED25519 256]--+
|        .        |
|         o       |
|    . + + .      |
|   o B * = .     |
|   o= B S .      |
|   .=B O o       |
|  + =+% o        |
| *oo.O.E         |
|+.o+=o. .        |
+----[SHA256]-----+
```

Теперь у вас есть пара ключей открытого и закрытого ED25519 (файлы. pub являются открытыми ключами, а остальные являются закрытыми ключами):

```
Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-a----        9/28/2018  11:09 AM           1679 id_ed25519
-a----        9/28/2018  11:09 AM            414 id_ed25519.pub
```

Помните, что файлы закрытых ключей эквивалентны паролю должны защищаться так же, как и пароль.
Для этого используйте ssh-agent для безопасного хранения закрытых ключей в контексте безопасности Windows, связанного с именем входа Windows. Для этого запустите службу SSH-Agent от имени администратора и используйте SSH-Add для сохранения закрытого ключа. 

```powershell
# Make sure you're running as an Administrator
Start-Service ssh-agent

# This should return a status of Running
Get-Service ssh-agent

# Now load your key files into ssh-agent
ssh-add ~\.ssh\id_ed25519

```

После выполнения этих действий каждый раз, когда для проверки подлинности этого клиента требуется закрытый ключ, SSH-Agent автоматически извлекает локальный закрытый ключ и передает его клиенту SSH.

> [!NOTE]
> Настоятельно рекомендуется создать резервную копию закрытого ключа в безопасном месте, а затем удалить ее из локальной системы *после* добавления в SSH-Agent.
> Не удается получить закрытый ключ от агента.
> Если вы потеряли доступ к закрытому ключу, необходимо создать новую пару ключей и обновить открытый ключ во всех системах, с которыми вы работаете.

## <a name="deploying-the-public-key"></a>Развертывание открытого ключа

Чтобы использовать созданный ранее ключ пользователя, необходимо поместить открытый ключ на сервер в текстовый файл с именем *authorized_keys* в разделе усерс\усернаме\сш. В состав средств OpenSSH входит SCP, который является безопасной служебной программой для обмена файлами.

Чтобы переместить содержимое открытого ключа (~\.ssh\id_ed25519.pub) в текстовый файл с именем authorized_keys в ~\.SSH \ на сервере или узле.

В этом примере используется функция Repair-Аусоризедкэйпермиссионс в модуле Опенсшутилс, который ранее был установлен на узле в инструкциях выше.

```powershell
# Make sure that the .ssh directory exists in your server's home folder
ssh user1@domain1@contoso.com mkdir C:\users\user1\.ssh\

# Use scp to opy the public key file generated previously to authorized_keys on your server
scp C:\Users\user1\.ssh\id_ed25519.pub user1@domain1@contoso.com:C:\Users\user1\.ssh\authorized_keys

# Appropriately ACL the authorized_keys file on your server  
ssh --% user1@domain1@contoso.com powershell -c $ConfirmPreference = 'None'; Repair-AuthorizedKeyPermission C:\Users\user1\.ssh\authorized_keys
```

Эти действия завершают настройку, необходимую для использования проверки подлинности на основе ключей с помощью SSH в Windows.
После этого пользователь может подключиться к узлу sshd с любого клиента, имеющего закрытый ключ.

