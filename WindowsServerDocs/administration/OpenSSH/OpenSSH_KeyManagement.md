---
ms.date: 09/27/2018
ms.topic: conceptual
keywords: OpenSSH, SSH, SSHD, установка, Настройка
contributor: maertendMSFT
author: maertendMSFT
title: Конфигурация сервера OpenSSH для Windows
ms.product: w10
ms.openlocfilehash: 3e2981cbbdfe34bf28a77d5121bff0b663e0d3bf
ms.sourcegitcommit: 0d0b32c8986ba7db9536e0b8648d4ddf9b03e452
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2019
ms.locfileid: "59837155"
---
# <a name="openssh-key-management"></a>Управление ключами OpenSSH

Большинство проверка подлинности в средах Windows осуществляется с помощью пары имени пользователя и пароля.
Это подходит для систем, которые совместно используют общий домен. При работе в доменах, например, между локальной и облачной системами, становится все сложнее.

Для сравнения сред Linux обычно используют пары открытого ключа или закрытого ключа для проверки подлинности диска.
OpenSSH содержит средства для поддержки этого, в частности:

* __SSH-keygen__ для создания ключи безопасности
* __SSH-agent__ и __ssh-add__ безопасного хранения закрытых ключей
* __SCP__ и __sftp__ для безопасного копирования файлов открытого ключа во время первого использования сервера

Этот документ содержит общие сведения об использовании этих средств в Windows, чтобы приступить к использованию ключа проверки подлинности по протоколу SSH. Если вы не знакомы, управлять ключами SSH, настоятельно рекомендуется ознакомиться [документе NIST IR 7966](http://nvlpubs.nist.gov/nistpubs/ir/2015/NIST.IR.7966.pdf) под названием «Безопасность интерактивные и автоматизированные доступа управления с помощью Secure Shell (SSH)».

## <a name="about-key-pairs"></a>О пар ключей

Пары ключей см. файлы открытого и закрытого ключей, используемых в определенных протоколов проверки подлинности. 

Проверка подлинности открытым ключом SSH использует Асимметричные алгоритмы шифрования для создания двух файлов ключей — один «private» и другие «public». Файлы закрытых ключей — это эквивалент пароль и должны быть защищены при любых обстоятельствах. Если кто-то получил ваш закрытый ключ, они можете войти как любой сервер SSH, которые у вас есть доступ к. Открытый ключ является то, что размещается на сервере SSH и могут также использоваться без ущерба для закрытого ключа.

При использовании ключа проверки подлинности с помощью SSH-сервер, SSH-сервер и клиент Сравните открытый ключ для имени пользователя, предоставленный для закрытого ключа. Если открытый ключ не может проверяться на соответствие клиентские закрытый ключ, не пройдет проверку подлинности. 

Многофакторной проверки подлинности могут быть реализованы с помощью пары ключей, требуя, что следует указать парольную фразу, если пара ключей создается (см. ниже для создания ключа). Во время проверки подлинности, пользователю предлагается ввести парольную фразу, которая используется вместе с наличие закрытого ключа на стороне клиента SSH для аутентификации пользователя. 

## <a name="host-key-generation"></a>Создании ключа узла

Открытые ключи нет особых ACL требований, которые, в Windows, приравниваются к доступ только для администраторов и системы. Чтобы облегчить эту задачу, 

* Модуль OpenSSHUtils PowerShell будет создана правильно настроить ключ списки управления доступом, а также должен быть установлен на сервере
* При первом использовании sshd пары ключей для узла будет создаваться автоматически. Если выполняется ssh-agent, в локальное хранилище ключей будут добавляться автоматически. 

Чтобы упростить ключа проверки подлинности с помощью SSH-сервер, выполните следующие команды с повышенными привилегиями PowerShell:

```powershell

# Install the OpenSSHUtils module to the server. This will be valuable when deploying user keys.
Install-Module -Force OpenSSHUtils -Scope AllUsers

# Start the ssh-agent service to preserve the server keys
Start-Service ssh-agent

# Now start the sshd service
Start-Service sshd
```

Так как пользователь, не связанных с ней sshd, ключи узла хранятся в \ProgramData\ssh.


## <a name="user-key-generation"></a>Создание ключей пользователя

Чтобы использовать проверку подлинности на основе ключа, необходимо сначала создать некоторые пары открытого и закрытого для вашего клиента. PowerShell или cmd используя ssh-keygen создать некоторые файлы ключей.

```powershell
cd ~\.ssh\
ssh-keygen
```

Этого должен отобразиться примерно следующее (где «username» заменяется свое имя пользователя)

```
Generating public/private ed25519 key pair.
Enter file in which to save the key (C:\Users\username\.ssh\id_ed25519):
```

Нажмите клавишу ВВОД, чтобы принять значение по умолчанию или укажите путь, куда ключи должны быть созданы. На этом этапе вам будет предложено использовать парольную фразу для шифрования закрытого ключа файлов.
Парольная фраза работает с файлом ключа для обеспечения двухфакторной проверки подлинности. В этом примере мы исходящие из парольную фразу пустой. 

```
Enter passphrase (empty for no passphrase): 
Enter same passphrase again: 
Your identification has been saved in C:\Users\username\.ssh\id_ed25519.
Your public key has been saved in C:\Users\username\.ssh\id_ed25519.pub.
The key fingerprint is: 
SHA256:OIzc1yE7joL2Bzy8!gS0j8eGK7bYaH1FmF3sDuMeSj8 username@server@LOCAL-HOSTNAME

The key's randomart image is:
+--[ED25519 256]--+
|        .        |
|         o       |
|    . + + .      |
|   o B * = .     |
|   o= B S .      |
|   .=B O o       |
|  + =+% o        |
| *oo.O.E         |
|+.o+=o. .        |
+----[SHA256]-----+
```

Теперь у вас есть открытого и закрытого ED25519 пару ключей (pub-файл файлы, открытые ключи, а остальные — закрытые ключи):

```
Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-a----        9/28/2018  11:09 AM           1679 id_ed25519
-a----        9/28/2018  11:09 AM            414 id_ed25519.pub
```

Помните, что файлы закрытых ключей являются эквивалентом пароль должны быть защищены так же, как защитить пароль.
Для облегчения, надежно храните закрытые ключи в контексте безопасности Windows, связанный с именем для входа Windows с помощью ssh агента. Чтобы сделать это, запустите службу ssh-agent от имени администратора и используйте ssh-add хранить закрытый ключ. 

```powershell
# Make sure you're running as an Administrator
Start-Service ssh-agent

# This should return a status of Running
Get-Service ssh-agent

# Now load your key files into ssh-agent
ssh-add ~\.ssh\id_ed25519

```

После выполнения этих действий, каждый раз, когда закрытый ключ необходим для проверки подлинности от данного клиента ssh-agent будет автоматически извлекается локальный закрытый ключ и передайте его для SSH-клиента.

> [!NOTE]
> Что вы Архивировать закрытый ключ в безопасное место, а затем удалите его из локальной системы, настоятельно рекомендуется *после* Добавление ssh-agent.
> Не удалось получить закрытый ключ из агента.
> Если вы потеряете доступ к закрытому ключу, пришлось бы создать новую пару ключей и обновить открытый ключ во всех системах можно взаимодействовать.

## <a name="deploying-the-public-key"></a>Развертывание открытого ключа

Чтобы использовать ключ пользователя, который был создан выше, должна находиться на сервере, в текстовый файл с именем открытый ключ *authorized_keys* под users\username\ssh. Эти средства OpenSSH включают scp, которая представляет собой программу безопасной передачи файлов, которые помогут в этом.

Чтобы переместить содержимое открытого ключа (~\.ssh\id_ed25519.pub) в текстовый файл с именем authorized_keys ~\.ssh\ на узле/server.

В этом примере использует функцию восстановления AuthorizedKeyPermissions в модуле OpenSSHUtils, который ранее был установлен на узле в инструкциях выше.

```powershell
# Make sure that the .ssh directory exists in your server's home folder
ssh user1@domain1@contoso.com mkdir C:\users\user1\.ssh\

# Use scp to opy the public key file generated previously to authorized_keys on your server
scp C:\Users\user1\.ssh\id_ed25519.pub user1@domain1@contoso.com:C:\Users\user1\.ssh\authorized_keys

# Appropriately ACL the authorized_keys file on your server  
ssh --% user1@domain1@contoso.com powershell -c $ConfirmPreference = 'None'; Repair-AuthorizedKeyPermission C:\Users\user1\.ssh\authorized_keys
```

Конфигурации, необходимые для использования проверки подлинности на основе ключей с помощью SSH в Windows, завершения выполнения этих шагов.
После этого пользователь может подключиться к узлу sshd из любого клиента, который имеет закрытый ключ.

