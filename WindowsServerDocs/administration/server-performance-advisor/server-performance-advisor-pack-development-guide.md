---
title: Руководство по разработке пакетов Server Performance Advisor
description: Руководство по разработке пакетов Server Performance Advisor
author: coreyp-at-msft
ms.author: coreyp
manager: dongill
ms.date: 10/16/2017
ms.openlocfilehash: c27dd0602c5993fd84e6956c2f50f6e2bfec8691
ms.sourcegitcommit: af80963a1d16c0b836da31efd9c5caaaf6708133
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/31/2019
ms.locfileid: "66435475"
---
# <a name="server-performance-advisor-pack-development-guide"></a>Руководство по разработке пакетов Server Performance Advisor

>Область применения. Windows Server (половина ежегодного канала), Windows Server 2016, Windows Server 2012 R2, Windows Server 2012, Windows 8, Windows 10

Это руководство по разработке для Microsoft Server Performance Advisor (SPA) содержит рекомендации, помогающие разработчикам и системным администраторам разрабатывать пакеты Advisor для анализа производительности сервера.

Предполагается, что вы знакомы с журналы и оповещения производительности (PLA), счетчиками производительности, параметрами реестра, инструментарий управления Windows (WMI) (WMI), трассировкой событий Windows (ETW) и Transact SQL (T-SQL).

Дополнительные сведения об использовании SPA см. в разделе " [рекомендации пользователя советника по производительности сервера](server-performance-advisor-users-guide.md)".

## <a name="spa-advisor-pack-overview"></a>Обзор пакета помощника по SPA


Пакет Advisor обычно предназначен для конкретной роли сервера и определяет следующее:

* Данные, собираемые с помощью PLA, включая инструментарий управления Windows (WMI) (WMI), счетчики производительности, параметры реестра, файлы и трассировку событий для Windows (ETW)

* Правила, в которых отображаются предупреждения и рекомендации

* Отображаемые данные (собранные необработанные данные, агрегированные данные или первые 10 списков)

* Статистика для просмотра значения, которое изменяется в течение времени

* Статистические значения, которые можно затрендировать

Пакет Advisor включает следующие элементы:

* **XML-метаданные** (Провисионметадата. XML)

    * Группа сборщиков данных [журналы и оповещения производительности (PLA)](https://msdn.microsoft.com/library/windows/desktop/aa372635.aspx)

    * Макет отчета

* **Скрипты SQL**

    * Основная хранимая процедура

    * Объекты SQL, такие как хранимые процедуры и определяемые пользователем функции

* **Файл схемы ETW** (Schema. Man) это необязательно

### <a name="advisor-pack-workflow"></a>Рабочий процесс пакетов советника

![Рабочий процесс пакета Advisor](../media/server-performance-advisor/spa-dev-guide-workflow.png)

В этой блок-схеме зеленые кружки представляют пакеты Advisor. Все остальные круги представляют этапы, выполняемые в процессе работы платформы SPA. SPA использует пакет Advisor для получения данных, импорта данных в базу данных, инициализации среды выполнения и выполнения скриптов SQL.

### <a name="collect-data"></a>Сбор данных

Когда пакет Advisor помещается в очередь для конкретного сервера с помощью SPA, модуль сбора данных запрашивает XML-данные набора сборщиков данных из пакета Advisor и собирает данные с целевого сервера. Необработанные данные хранятся в указанном пользователем общем файловом ресурсе. Сбор данных прекращается до тех пор, пока не будет превышено время выполнения SPA, назначенное пользователем.

### <a name="import-data-into-the-database"></a>Импорт данных в базу данных

После завершения сбора данных каждый тип данных импортируется в соответствующую таблицу в базе данных SQL Server. Например, параметры реестра импортируются в таблицу с именем \#параметра registrykeys работать.

для импорта файла ETW требуется файл схемы ETW для декодирования ETL-файла. Файл схемы ETW — это XML-файл. Его можно создать с помощью tracerpt. exe, который входит в состав Windows. Файл схемы ETW требуется только в том случае, если пакету Advisor требуется импортировать данные ETW.

### <a name="switch-to-low-user-rights"></a>Переключиться на низкий уровень прав пользователя

Платформа SPA автоматически корректирует привилегии, чтобы максимально сокращать необходимый уровень доступа безопасности. Поскольку пакеты Advisor могут быть разработаны или изменены любым пользователем, пакет Advisor может содержать измененные сценарии SQL. Чтобы снизить риски безопасности, любой скрипт SQL для пакета Advisor должен выполняться с неограниченными правами пользователя. Он может обращаться только к ограниченным объектам базы данных, таким как временные таблицы и защищенные API-интерфейсы, предоставляемые в виде хранимых процедур. Скрипты SQL в пакете Advisor могут вызывать эти процедуры хранения для взаимодействия с платформой SPA.

### <a name="initialize-execution-environment"></a>Инициализация среды выполнения

Пакеты Advisor могут создавать различные типы выходных данных, например уведомления, рекомендации, таблицы фактов, статистику и диаграммы для статистики. Скрипты SQL выполняют определенные вычисления с собранными данными. Полученные результаты хранятся во временных таблицах через общедоступные API-интерфейсы SPA. на этапе инициализации эти временные таблицы и другие системные ресурсы должны быть подготовлены.

### <a name="run-sql-scripts"></a>Выполнение скриптов SQL

Существует Главная хранимая процедура, которая называется разработчиком пакета Advisor. Платформа SPA вызывает эту хранимую процедуру для запуска вычисления. Хранимая процедура использует собранные данные и передает конечный результат в платформу SPA.

### <a name="switch-to-administrative-rights"></a>Переключиться на административные права

Для создания отчета требуются права администратора. Создание отчетов полностью управляется SPA. Скорее всего, он будет незаконным.

### <a name="generate-a-report"></a>Создание отчета

Перед выполнением основной хранимой процедуры для пакета Advisor все вычисляемые результаты, такие как уведомления и статистика, не сохраняются. На этом этапе платформа SPA передает конечные результаты из временных таблиц в таблицы в определенном формате. После завершения этого этапа отчеты можно просмотреть с помощью консоли SPA.

## <a name="authoring-an-advisor-pack"></a>Создание пакета Advisor


### <a name="quick-guidelines"></a>Краткие руководства

В следующей блок-схеме описаны действия по разработке полнофункционального пакета Advisor. В этом разделе также приводятся пошаговые примеры для лучшего объяснения каждого шага.

![процесс разработки пакета Advisor](../media/server-performance-advisor/spa-dev-guide-dev-flowchart.png)

Пакет Advisor обычно структурирован следующим образом:

Пакет Advisor

Провисионметадата. XML

Сценарии

Main. SQL

Func. SQL

Schema. Man

Каждый пакет Advisor должен иметь файл с именем Провисионметадата. XML. Он определяет основные сведения о пакете Advisor, данные для собраний, уведомления и правила, а также о том, как отчет должен быть сохранен и отображен. Платформа SPA использует эти сведения для создания временной таблицы, а затем передает результаты во временную таблицу в таблицу, к которой пользователи могут обращаться.

Все скрипты SQL отчета должны быть сохранены во вложеннойпапке с именем Scripts. Для целей обслуживания рекомендуется сохранять разные объекты базы данных в разных файлах SQL Server. В качестве главной точки входа должна быть хотя бы одна хранимая процедура.

> [!NOTE]
> Файл Schema. Man не требуется, если пакет Advisor не собирает трассировки ETW. Этот файл схемы используется для описания схемы событий ETW и для расшифровки событий ETW.

### <a name="defining-basic-information"></a>Определение основных сведений

В этом разделе описываются некоторые основные элементы, составляющие пакет Advisor, включая Провисионметадата. XML и атрибуты.

Ниже приведен пример заголовка для файла Провисионметадата. XML.

``` syntax
<advisorPack
xmlns="http://microsoft.com/schemas/ServerPerformanceAdvisor/ap/2010"
name="Microsoft.ServerPerformanceAdvisor.CoreOS.V2"
displayName="Microsoft CoreOS Advisor Pack V2"
description="Microsoft CoreOS Advisor Pack"
author="Microsoft"
version="1.0"
frameworkversion="3.0"
minOSversion="6.0"
reportScript="ReportScript">
</advisorPack>
```

### <a name="advisor-pack-version"></a>Версия пакета Advisor

имя атрибута: **версия**

Разработчики пакета Advisor могут определить основную и дополнительную версии пакета Advisor:

* Основная версия обычно включает значительные улучшения. Результаты, созданные старой версией, могут быть несовместимы с новой. Настоятельно рекомендуем включить основную версию в имя пакета Advisor.

* SPA позволяет обновлять дополнительные версии при наличии только незначительных изменений без проблем с совместимостью данных.

Дополнительные сведения об управлении версиями см. в разделе [Дополнительные разделы](#bkmk-advancedtopics).

### <a name="script-entry-point"></a>Создать скрипт для точки входа

имя атрибута: **репортскрипт**

Платформа SPA выполняет поиск основного имени хранимой процедуры из точки входа скрипта и выполняет его безопасным образом.

### <a name="other-attributes"></a>Другие атрибуты

Ниже приведены некоторые другие атрибуты, которые можно использовать для распознавания пакета Advisor:

* Отображаемое имя: **DisplayName**

* Описание: **Описание**

* Автор: **Автор**

* Версия платформы: **фрамеворкверсион** (по умолчанию — 3,0)

* Минимальная версия операционной системы: **миносверсион** (зарезервировано для будущего расширения)

* Уведомление о потерянном событии: **шовевентлостварнинг**

### <a href="" id="bkmk-definedatacollector"></a>Определение группы сборщиков данных

Группа сборщиков данных определяет данные производительности, которые платформа SPA должна получать с целевого сервера. Он поддерживает параметры реестра, WMI, счетчики производительности, файлы с целевого сервера и ETW.

``` syntax
<advisorPack>
<dataSourceDefinition xmlns="http://microsoft.com/schemas/ServerPerformanceAdvisor/dc/2010">
 <dataCollectorSet duration="10">
<registryKeys>
 ?<registryKey>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Power\User\PowerSchemes\\</registryKey>
</registryKeys>
<managementpaths>
 ?<path>Root\Cimv2:select * FROM Win32_DiskDrive</path>
</managementpaths>
<performanceCounters interval="2">
 ?<performanceCounter>\PhysicalDisk(*)\Avg. Disk sec/Transfer</performanceCounter>
</performanceCounters>
<files>
 ?<path>%windir%\System32\inetsrv\config\applicationHost.config</path>
</files>
<providers>
 ?<provider session="NT Kernel Logger" guid="{9E814AAD-3204-11D2-9A82-006008A86939}" keywordsany="06010201" keywordsAll="00000000" level="00000000" />
</providers>
 </dataCollectorSet>
</dataSourceDefinition>
</advisorPack>
```

Атрибут **Duration** набора **&lt;данных «сборщик мусора/&gt;** в предыдущем примере» определяет продолжительность сбора (единица измерения времени в секундах). значение **Duration** является обязательным атрибутом. Этот параметр определяет длительность сбора, используемую счетчиками производительности и ETW.

### <a name="collect-registry-data"></a>Получение данных реестра

Данные реестра можно получить из следующих кустов реестра:

* КОРНЕВОЙ\_УЗЕЛ КЛАССОВ HKEY\_

* \_Текущая\_конфигурация hKey

* HKey\_текущего\_пользователя

* HKEY\_ЛОКАЛЬНЫЙ\_КОМПЬЮТЕР

* ПОЛЬЗОВАТЕЛИ\_HKEY

Чтобы получить параметр реестра, укажите полный путь к имени значения: MyKey\_\_значения MyValue для локального компьютера\\hKey\\

Чтобы получить все параметры в разделе реестра, укажите полный путь к разделу реестра: MyKey\_локального\_компьютераhKey\\\\

Чтобы собрать все значения в разделе реестра и его подразделах (PLA рекурсивно собирает данные реестра), используйте две обратные косые черты для разделителя последнего пути: MyKey\_локального\_компьютераhKey\\\\\\

Чтобы получить данные реестра с удаленного компьютера, включите имя компьютера в начало пути реестра: MyKey\_\_значения MyValue для локального компьютера\\hKey\\

Например, у вас может быть раздел реестра, который выглядит следующим образом:

``` syntax
Windows registry editor version 5.00

[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Power\User\PowerSchemes]
"activePowerScheme"="db310065-829b-4671-9647-2261c00e86ef"

[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Power\User\PowerSchemes\db310065-829b-4671-9647-2261c00e86ef]
"Description"=
 FriendlyName = Power Source Optimized 

HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Power\User\PowerSchemes\db310065-829b-4671-9647-2261c00e86ef \0012ee47-9041-4b5d-9b77-535fba8b1442\6738e2c4-e8a5-4a42-b16a-e040e769756e
"ACSettingIndex"=dword:000000b4
"DCSettingIndex"=dword:0000001e
```

Пример 1: Возвращать только активные Поверсчемес и их значения:

``` syntax
<registryKey>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Power\User\PowerSchemes</registryKey>
```

Пример 2: Возвращает все пары "ключ — значение" по этому пути:

> [!NOTE]
> PLA выполняется с учетными данными пользователя. Для некоторых разделов реестра требуются учетные данные администратора. Перечисление останавливается, когда ему не удается получить доступ к каким-либо подразделам.

``` syntax
<registryKey>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Power\User\PowerSchemes\\</registryKey>
```

Все собранные данные будут импортированы во временную таблицу с именем  **\#параметра registrykeys работать** перед выполнением скрипта SQL-отчета. В следующей таблице показаны результаты, например 2.

KeyName | кэйтипеид | Значение
------ | ----- | -------
HKEY_LOCAL_MACHINE. ..\Поверсчемес | 1 | db310065-829b-4671-9647-2261c00e86ef
\db310065-829b-4671-9647-2261c00e86ef\Description | 2 | |
\db310065-829b-4671-9647-2261c00e86ef\FriendlyName | 2 | Оптимизированный источник питания
...\6738e2c4-e8a5-4a42-b16a-e040e769756e\ACSettingIndex | 4 | 180
...\6738e2c4-e8a5-4a42-b16a-e040e769756e\DCSettingIndex | 4 | 30

Схема для таблицы **#registryKeys** выглядит следующим образом:

Имя столбца | Тип данных SQL | Описание
-------- | -------- | --------
KeyName | Nvarchar (300) NOT NULL | Полный путь к разделу реестра
кэйтипеид | Smallint, не РАВНый NULL | Внутренний идентификатор типа
Значение | Nvarchar (4000) NOT NULL | Все значения

Столбец **кэйтипеид** может иметь один из следующих типов:

id | Type
--- | ---
1 | Строка
2 | експандстринг
3 | Бинарный
4 | DWord
5 | двордбижендиан
6 | Ссылка
7 | мултиплестринг
8 | ресаурцелист
9 | фуллресаурцедескриптор
10 | ресаурцерекуирементслист
11 | QWORD

### <a name="collect-wmi"></a>Собирайте Инструментарий WMI

Можно добавить любой запрос WMI. Дополнительные сведения о написании запросов WMI см. в разделе [WQL (SQL для WMI)](https://msdn.microsoft.com/library/windows/desktop/aa394606.aspx). В следующем примере запрашиваются расположение файла подкачки:

``` syntax
<path>Root\Cimv2:select * FROM Win32_PageFileUsage</path>
```

Запрос в приведенном выше примере возвращает одну запись:

Заголовок | Имя | пеакусаже
----- | ----- | -----
к:\пажефиле.сис | к:\пажефиле.сис | 215

Поскольку Инструментарий WMI возвращает таблицу с разными столбцами, при импорте собранных данных в базу данных SPA выполняет нормализацию данных и добавляется в следующие таблицы:

**\#Таблица Вмиобжектс**

SequenceID | Пространство имен | ClassName | RelativePath | вмикуерид
----- | ----- | ----- | ----- | -----
10 | Root\Cimv2 | Win32_PageFileUsage | Win32_PageFileUsage. имя =<br>C:\\pagefile. sys | 1

**\#Таблица Вмиобжектспропертиес**

id | запрос
--- | ---
1 | Root\Cimv2: SELECT * FROM Win32_PageFileUsage

**\#Таблица Вмикуериес**

id | запрос
--- | ---
1 | Root\Cimv2: SELECT * FROM Win32_PageFileUsage

**\#Схема таблицы Вмиобжектс**

Имя столбца | Тип данных SQL | Описание
--- | --- | ---
SequenceId | Int, не NULL | Сопоставить строку и ее свойства
Пространство имен | Nvarchar (200) NOT NULL | Пространство имен WMI
ClassName | Nvarchar (200) NOT NULL | Имя класса WMI
RelativePath | Nvarchar (500) не равно NULL | Относительный путь WMI
вмикуерид | Int, не NULL | Сопоставьте ключ #WmiQueries

**\#Схема таблицы Вмиобжектпропертиес**

Имя столбца | Тип данных SQL | Описание
--- | --- | ---
SequenceId | Int, не NULL | Сопоставить строку и ее свойства
Имя | Nvarchar (1000) не равно NULL | Имя свойства
Значение | Nvarchar (4000) NULL | Значение текущего свойства

**\#Схема таблицы Вмикуериес**

Имя столбца | Тип данных SQL | Описание
--- | --- | ---
Id | Int, не NULL | > уникальный идентификатор запроса
запрос | Nvarchar (4000) NOT NULL | Исходная строка запроса в метаданных для инициализации

### <a name="collect-performance-counters"></a>Получение счетчиков производительности

Ниже приведен пример того, как можно получить счетчик производительности.

``` syntax
<performanceCounters interval="1">
  <performanceCounter>\PhysicalDisk(*)\Avg. Disk sec/Transfer</performanceCounter>
</performanceCounters>
```

Атрибут **Interval** является обязательным глобальным параметром для всех счетчиков производительности. Он определяет интервал (единица измерения времени в секундах) сбора данных о производительности.

В предыдущем примере счетчик \\«физический диск (\*)\\» имеет значение AVG. Время обращения к диску (сек.) "будет запрашиваться каждую секунду.

Может существовать два экземпляра: Всего и 0**C:  **\_** D:** , а выходные данные могут выглядеть следующим образом:

timestamp | Категория | CounterName | Значение экземпляра _Total | Значение экземпляра 0 C: ЧЕТЫРЕХМЕРНОГО
---- | ---- | ---- | ---- | ----
13:45:52.630 | PhysicalDisk | Ср. С диска (сек) | 0.00100008362473995 |0.00100008362473995
13:45:53.629 | PhysicalDisk | Ср. С диска (сек) | 0.00280023414927187 | 0.00280023414927187
13:45:54.627 | PhysicalDisk | Ср. С диска (сек) | 0.00385999853230048 | 0.00385999853230048
13:45:55.626 | PhysicalDisk | Ср. С диска (сек) | 0.000933297607934224 | 0.000933297607934224

Чтобы импортировать данные в базу данных, данные будут нормализованы в таблицу с именем  **\#PerformanceCounter**.

категоридисплайнаме | InstanceName | каунтердисплайнаме | Значение
---- | ---- | ---- | ----
PhysicalDisk | _Total | Ср. С диска (сек) | 0.00100008362473995
PhysicalDisk | 0 C: ЧЕТЫРЕХМЕРНОГО | Ср. С диска (сек) | 0.00100008362473995
PhysicalDisk | _Total | Ср. С диска (сек) | 0.00280023414927187
PhysicalDisk | 0 C: ЧЕТЫРЕХМЕРНОГО | Ср. С диска (сек) | 0.00280023414927187
PhysicalDisk | _Total | Ср. С диска (сек) | 0.00385999853230048
PhysicalDisk | 0 C: ЧЕТЫРЕХМЕРНОГО | Ср. С диска (сек) | 0.00385999853230048
PhysicalDisk | _Total | Ср. С диска (сек) | 0.000933297607934224
PhysicalDisk | 0 C: ЧЕТЫРЕХМЕРНОГО | Ср. С диска (сек) | 0.000933297607934224

**Примечание** . Локализованные имена, такие как **категоридисплайнаме** и **каунтердисплайнаме**, зависят от языка интерфейса, используемого на целевом сервере. Старайтесь не использовать эти поля, если требуется создать независимый от языка пакет Advisor.

Схема таблицы  **\#PerformanceCounter**

Имя столбца | Тип данных SQL | Описание
---- | ---- | ---- | ----
timestamp | datetime2 (3) NOT NULL | Собранное время и Дата в формате UNC
Категория | Nvarchar (200) NOT NULL | Имя категории
категоридисплайнаме | Nvarchar (200) NOT NULL | Имя локализованной категории
InstanceName | Nvarchar (200) NULL | Имя экземпляра
CounterName | Nvarchar (200) NOT NULL | Имя счетчика
каунтердисплайнаме | Nvarchar (200) NOT NULL | Имя локализованного счетчика
Значение | Float NOT NULL | Собранное значение

### <a name="collect-files"></a>Собирать файлы

Пути могут быть абсолютными или относительными. Имя файла может включать символ-шаблон (\*) и вопросительный знак (?). Например, чтобы получить все файлы во временной папке, можно указать c:\\Temp.\\\* Подстановочный знак применяется к файлам в указанной папке.

Если вы хотите также получать файлы из вложенных папок указанной папки, используйте две обратные косые черты для последнего разделителя папок, например\\c: Temp.\\\\\*

Вот пример, который запрашивает файл **ApplicationHost. config** :

``` syntax
<path>%windir%\System32\inetsrv\config\applicationHost.config</path>
```

Результаты можно найти в таблице с именем  **\#Files**, например:

куерипас | FullPath | парентпас | имя_файла | Content
----- | ----- | ----- | ----- | -----
% WINDIR%\... \аппликатионхост.конфиг |C:\Windows<br>\... \аппликатионхост.конфиг | C:\Windows<br>\... \конфиг | applicationHost. Confi хранится | 0x3C3F78

**\#Схема таблицы файлов**

Имя столбца | Тип данных SQL | Описание
---- | ---- | ----
куерипас | Nvarchar (300) NOT NULL | Исходный оператор запроса
FullPath | Nvarchar (300) NOT NULL | Абсолютный путь к файлу и имя файла
парентпас | Nvarchar (300) NOT NULL | Путь к файлу
имя_файла | Nvarchar (300) NOT NULL | Имя файла
Content | Varbinary (MAX) NULL | Содержимое файла в двоичном формате

### <a name="defining-rules"></a>Определение правил

После сбора достаточного объема данных с помощью PLA на целевом сервере пакет Advisor может использовать эти данные для проверки, а также краткий обзор системных администраторов.

Правила предоставляют краткий обзор производительности сервера. Они выделяют проблемы и предоставляют рекомендации. Вы можете получить список всех правил, которые необходимо проверить для пакета Advisor. Например, если вы хотите разработать пакет Advisor для операционной системы, возможные правила могут включать:

* Является ли режим энергопотребления ЦП энергосбережением

* Находится ли сервер в виртуализованной среде

* Есть ли нагрузка на дисковые операции ввода-вывода

Правила содержат следующие элементы:

* Зависимое пороговое значение (настраиваемая часть правила)

* Определение правила (предупреждения и рекомендации)

Вот пример простого правила:

``` syntax
<advisorPack>

  <reportDefinition>
    <thresholds>
      <threshold  />
    </thresholds>
    <rules>
      <rule  />
      </rule>
    </rules>
  </reportDefinition>
</advisorPack>
```

### <a name="threshold"></a>Пороговое значение

Пороговое значение — это настраиваемый фактор, который позволяет системным администраторам принимать решение о том, когда правило должно показывать хорошее или неверное состояние. В следующем примере показано правило обнаружения свободного места на системном диске и предупреждение, если объем свободного места меньше 10 ГБ.

``` syntax
<threshold name="freediskSize" caption="Free Disk Size (GB)" description="Free Disk Size  value="10" />
```

Однако в этом случае системный администратор имеет меньше жесткого диска. Он считает, что 5 ГБ свободного пространства все еще может быть хорошим условием, и ему не нужно выводить предупреждение. Он может обновить значение по умолчанию с 10 до 5 с помощью консоли SPA, не прибегая к разработке пакета Advisor.

Введение порогового значения помогает системным администраторам быстро изменять значение без необходимости изменения пакета Advisor.

В этом примере требуются все атрибуты, кроме **Description** . Для **value**можно использовать любое число.

Пороговое значение можно совместно использовать в правилах.

### <a name="alerts-and-recommendations"></a>Оповещения и рекомендации

Определение правила не затрагивает вычисления логики. Он определяет, как может выглядеть пользовательский интерфейс и как сценарий отчета SQL Server передает результаты в пользовательский интерфейс.

Правило состоит из трех частей:

* Предупреждение (подпись правила)

* Рекомендация (Совет)

* Связанное пороговое значение (необязательная информация о зависимостях)

Ниже приведен пример правила.

``` syntax
<rule name="freediskSize" caption="Free Disk Size on System Drive" description="This rule checks free disk size on system drive ">
<advice name="SuccessAdvice" level="Success" message="No issue found.">No Recommendation.</advice>
<advice name="WarningAdvice" level="Warning" message="Not enough free space on system drive.">
Install OS on larger disk.</advice>
<dependencies>
 <threshold ref="freediskSize"/>
</dependencies>
</rule>
```

Вы можете определить столько советов, сколько нужно, и обычно вы определяете рекомендации. **Уровень** рекомендаций может быть " **успешно** " или " **предупреждение**".

Можно связать с любым количеством пороговых значений. Можно даже привязать к пороговому значению, которое не относится к текущему правилу. Связывание позволяет консоли SPA легко управлять пороговыми значениями.

Имя правила и рекомендации являются ключами, и они уникальны в области действия. Ни одно из двух правил не может иметь одно и то же имя, и ни одна из двух рекомендаций в одном правиле не может иметь одно и то же имя. Эти имена будут очень важны при написании отчета SQL Script. Можно вызвать \[dbo\].\[ Сетнотификатион\] API для задания состояния правила.

### <a name="defining-ui-display-elements"></a>Определение элементов интерфейса, отображаемых в пользовательском интерфейсе

После определения правил системные администраторы могут просматривать сводку отчета. Однако часто системным администраторам требуются статистические данные, и они хотят проверить источники данных, которые использовались в правилах производительности.

Продолжая работу с предыдущим примером, пользователь знает, достаточно ли свободного места на системном диске. Пользователи также могут заинтересовать фактический размер свободного пространства. Для хранения и вывода таких результатов используется отдельная группа значений. Несколько отдельных значений можно сгруппировать и отобразить в таблице в консоли SPA. Таблица содержит только два столбца, имя и значение, как показано здесь.

Имя | Значение
---- | ----
Свободный размер диска на системном диске (в ГБ) | 100
Общий размер установленного диска (ГБ) | 500 

Если пользователь хочет просмотреть список всех жестких дисков, установленных на сервере, и размер диска, можно вызвать значение списка, содержащее три столбца и несколько строк, как показано ниже.

Disk | Свободный размер диска (ГБ) | Общий размер (ГБ)
---- | ---- | ----
0 | 100 | 500
1 | 20 | 320

В пакете Advisor может быть много таблиц (одиночные группы значений и таблицы значений списка). Для Организации и классификации этих таблиц можно использовать раздел.

В целом, существует три типа элементов пользовательского интерфейса:

* [Священ](#bkmk-ui-section)

* [Одиночные группы значений](#bkmk-ui-svg)

* [список таблиц значений](#bkmk-ui-lvt)

Ниже приведен пример, демонстрирующий элементы пользовательского интерфейса:

``` syntax
<advisorPack>
<dataSourceDefinition/>
<reportDefinition>
 <datatypes>
<datatype .../>
 </datatypes>
 <thresholds/>
 <rule/>
 <sections>
<section .../>
 </sections>
 <singleValues>
<singleValue .../>
 </singleValues>
 <listValues>
<listValue .../>
 </listValues>
</reportDefinition>
</advisorPack>
```

### <a href="" id="bkmk-ui-section"></a>Священ

Раздел предназначен исключительно для макета пользовательского интерфейса. Он не участвует в каких либо логических вычислениях. Каждый отдельный отчет содержит набор разделов верхнего уровня, у которых нет родительского раздела. Разделы верхнего уровня представлены в отчете в виде вкладок. Разделы могут иметь подразделы, не более 10 уровней. Все подразделы в разделах верхнего уровня представлены в расширяемых областях. Раздел может содержать несколько подразделов, отдельные группы значений и таблицы значений списка. Отдельные группы значений и таблицы значений списка представляются в виде таблиц.

Ниже приведен пример раздела верхнего уровня.

``` syntax
<section name="CPU" caption="CPU"/>
```

Имя раздела должно быть уникальным. Он используется в качестве ключа, который может быть связан с другими разделами, отдельными группами значений и таблицами значений списка.

В следующем примере имеется атрибут **Parent**, который указывает на раздел CPU. Кпуфактс является дочерним по отношению к разделу с именем CPU. **родительский элемент** должен ссылаться на имя предыдущей секции; в противном случае это может привести к созданию цикла.

``` syntax
<section name="CPUFacts" caption="Facts" parent="CPU"/>
```

Следующая группа с одним значением имеет атрибут, **раздел**и может указывать на любой раздел в зависимости от структуры пользовательского интерфейса.

``` syntax
<singleValue name="CPUInformation" section="CPUFacts" caption="Physical CPU Information"> </singleValue>
```

### <a name="data-types"></a>Типы данных

Одна группа значений и таблица значений списка содержат различные типы данных, такие как String, int и float. Так как эти значения хранятся в базе данных SQL Server, можно определить тип данных SQL для каждого свойства данных. Однако определение типа данных SQL довольно сложно. Необходимо указать длину или точность, которая может быть подвержена изменениям.

Для определения логических типов данных можно использовать первый дочерний элемент  **&lt;reportDefinition/&gt;** , который позволяет определить сопоставление типа данных SQL и логического типа.

В следующем примере определяются два типа данных. Одна **строка** , а другая — **компаникоде**.

``` syntax
<datatype name="string" = sqltype="nvarchar(4000)" />
<datatype name="companyCode" sqltype="nvarchar(100)" />
```

Имя типа данных может быть любой допустимой строкой. Ниже приведен список допустимых типов данных SQL:

* bigint

* binary

* версий

* char

* date

* datetime

* datetime2

* datetimeoffset

* decimal

* float

* ssNoversion

* money

* nchar

* ISNUMERIC

* nvarchar

* real

* smalldatetime

* smallint

* smallmoney

* time

* tinyint

* uniqueidentifier

* varbinary

* varchar

Дополнительные сведения об этих типах данных SQL см. в разделе [типы данных (Transact-SQL)](https://msdn.microsoft.com/library/ms187752.aspx).

### <a href="" id="bkmk-ui-svg"></a>Одиночные группы значений

Одна группа значений группирует несколько отдельных значений, которые представлены в таблице, как показано здесь.

``` syntax
<singleValue name="Systemoverview" section="SystemoverviewSection" caption="Facts">
<value name="OsName" type="string" caption="Operating system" description="WMI: Win32_OperatingSystem/Caption"/>
<value name="Osversion" type="string" caption="OS version" description="WMI: Win32_OperatingSystem/version"/>
<value name="OsLocation" type="string" caption="OS location" description="WMI: Win32_OperatingSystem/SystemDrive"/>
</singleValue>
```

В предыдущем примере мы определили одну группу значений. Это дочерний узел раздела **системовервиевсектион**. Эта группа имеет одиночные значения **OsName**, **OSVersion**и **ослокатион**.

Единственное значение должно иметь атрибут глобального уникального имени. В этом примере атрибутом глобального уникального имени является **системовервиев**. Уникальное имя будет использоваться для создания соответствующего представления для пользовательского отчета. Каждое представление содержит префикс **VW**, например ввсистемовервиев.

Хотя можно определить несколько отдельных групп значений, два имени одного значения не могут быть одинаковыми, даже если они находятся в разных группах. Имя единственного значения используется в отчете SQL-скрипта для установки значения соответствующим образом.

Для каждого отдельного значения можно определить тип данных. Допустимые входные данные для **типа** определяются в  **&lt;типе данных/&gt;** . Окончательный отчет может выглядеть следующим образом:

**Информации**

Имя | Значение
--- | ---
Операционная система | &lt;_значение будет задано скриптом отчета_&gt;
Версия ОС | &lt;_значение будет задано скриптом отчета_&gt;
Расположение ОС | &lt;_значение будет задано скриптом отчета_&gt;

Атрибут **Caption** для **&lt;value/&gt;** представлен в первом столбце. Значения в столбце значение задаются в будущем отчетом скрипта через \[dbo.\[ \] Сетсинглевалуе\]. Атрибут **Description** для **&lt;value/&gt;** отображается в подсказке. Обычно подсказка показывает пользователям источник данных. Дополнительные сведения о подсказках см. в разделе [подсказки](#bkmk-tooltips).

### <a href="" id="bkmk-ui-lvt"></a>список таблиц значений

Определение значения списка аналогично определению таблицы.

``` syntax
<listValue name="NetworkAdapterInformation" section="NetworkIOFacts" caption="Physical network adapter information">
<column name="NetworkAdapterId" type="string" caption="ID" description="WMI: Win32_NetworkAdapter/DeviceID"/>
<column name="NetworkAdapterName" type="string" caption="Name" description="WMI: Win32_NetworkAdapter/Name"/>
<column name="type" type="string" caption="type" description="WMI: Win32_NetworkAdapter/Adaptertype"/>
<column name="Speed" type="decimal" caption="Speed (Mbps)" description="WMI: Win32_NetworkAdapter/Speed"/>
<column name="MACaddress" type="string" caption="MAC address" description="WMI: Win32_NetworkAdapter/MACaddress"/>
</listValue>
```

Имя значения списка должно быть глобально уникальным. Это имя станет именем временной таблицы. В предыдущем примере таблица с именем \#нетворкадаптеринформатион будет создана на этапе инициализации среды выполнения, который содержит все описанные столбцы. Как и в случае с одним именем значения, имя значения списка также используется как часть имени пользовательского представления, например Ввнетворкадаптеринформатион.

@type&lt;столбца/&gt; определяется&lt;типом данных/&gt;

Макет пользовательского интерфейса для окончательного отчета может выглядеть следующим образом:

**Сведения о физическом сетевом адаптере**

id | Имя | Type | Скорость (Мбит/с) | MAC-адрес;
--- | --- | --- | --- | ---
 | <br> | | |
 | | | |


Атрибут **Caption в** &gt;столбце/ отображается как &lt;имя столбца, а атрибут **Description** столбца/&gt; отображается в виде подсказки для соответствующего заголовка столбца. &lt; Обычно подсказка показывает пользователю источник данных. Дополнительные сведения см. в разделе [подсказки](#bkmk-tooltips).

В некоторых случаях таблица может содержать много столбцов и лишь несколько строк, поэтому переключение столбцов и строк сделает таблицу гораздо лучше. Чтобы поменять местами столбцы и строки, можно добавить следующий атрибут стиля:

``` syntax
<listValue style="Transpose"  
```

### <a name="defining-charting-elements"></a>Определение элементов построения диаграмм

Можно выбрать любой ключ статистики и просмотреть значения на диаграмме с предысторией или на диаграмме трендов. Существует два типа статистики:

* **Статическая статистика** Единственное значение, известное во время разработки. Например, свободное место на системном диске может быть статической статистикой.

* **Динамическая статистика** Во время разработки может быть неизвестным. Например, среднее использование ЦП каждым ядром является динамической статистикой, поскольку неизвестно, сколько ядер ЦП может быть в системе во время разработки.

Ключ статистики имеет ограничение, что данные должны быть совместимы с типом данных Double. Это может быть целое число, десятичное значение или строка, которую можно преобразовать в тип Double.

SPA использует одну группу значений для поддержки статической статистики и таблицы значений списка для поддержки динамической статистики. В следующих разделах описывается определение статических статистических и динамических ключей статистики.

### <a name="static-statistics"></a>Статическая статистика

Как упоминалось ранее, статическая статистика представляет собой одно значение. Логически любое отдельное значение может быть определено как статическая статистика. Однако нет смысла просматривать одно значение, которое не может быть приведено к числовому типу. Чтобы определить статическую статистику, можно просто **Добавить атрибут в** соответствующий один ключ значения, как показано ниже:

``` syntax
<value name="freediskSize" type="int" trendable="true"  
```

### <a name="dynamic-statistics"></a>Динамическая статистика

Динамические ключи статистики неизвестны во время разработки, поэтому количество возможных значений неизвестно. Однако, поскольку значения списка хранятся в нескольких строках, можно было бы легко использовать таблицу значений списка для хранения динамической статистики.

Например, если необходимо отобразить диаграммы для средней загрузки ЦП различных ядер, можно определить таблицу со столбцами для **CpuId** и **аверажекпуусаже**:

``` syntax
<listValue name="CpuPerformance">
<column name="CpuId" type="string" caption="CPU ID" columntype="Key"/>
<column name="AverageCpuUsage" type="decimal" caption="Average" columntype="Value"/>
</listValue>
```

Другой атрибут **ColumnType**может быть **ключевым**, **значением**или информационным. Тип данных ключевого столбца должен быть Double или Double. В **ключевом** столбце нельзя вставлять одни и те же ключи в таблицу. Эти ограничения не имеют **значений** или **информационных** столбцов.

Статистические значения хранятся в столбцах **значений** .

**Информационные** столбцы подобны обычным столбцам в обычных таблицах значений списков. По умолчанию используется тип столбца « **информационный** », если он не указан. Такие столбцы не влияют на количество ключей статистики или участвуют в вычислениях, связанных с статистикой.

Продолжая работу с предыдущим примером, если сервер имеет два ядра ЦП, результат в таблице может выглядеть следующим образом:

CpuId | аверажекпуусаже
:---: | :---:
0 | 10
1 | 30

В то же время платформа SPA создает два ключа статистики. Один для ЦП 0, а другой — для ЦП 1.

В следующем примере показано, что поддерживается несколько столбцов **значений** с несколькими **ключевыми** столбцами.

CounterName | InstanceName | Average | Sum
--- | :---: | :---: | :---:
% загруженности процессора | _Total | 10 | 20
% загруженности процессора | CPU0 | 20 | 30 

В этом примере у вас есть два **ключевых** столбца и два столбца **значений** . SPA создает два ключа статистики для столбца среднего и два ключа для столбца Sum. Ключи статистики:

* CounterName (% загруженности процессора)/instanceName\_(всего)/среднее

* CounterName (% загруженности процессора)/InstanceName (CPU0)/среднее

* CounterName (% загруженности процессора)/instanceName\_(всего)/Sum

* CounterName (% загруженности процессора)/InstanceName (CPU0)/Sum

CounterName и InstanceName объединяются как один ключ. Комбинированный ключ не может иметь дублирование.

SPA создает много ключей статистики. Некоторые из них могут быть не интересны, и вам может потребоваться скрыть их из пользовательского интерфейса. SPA позволяет разработчикам создавать фильтры для отображения только полезных статистических ключей.

в предыдущем примере системные администраторы могут заинтересовать только те ключи, в которых значение instanceName равно \_Total или CPU1. Фильтр можно определить следующим образом:

``` syntax
<listValue name="CpuPerformance">
<column name="CounterName" type="string" columntype="Key"/>
<column name="InstanceName" type="string" columntype="Key">
 <trendableKeyValues>
<value>_Total</value>
<value>CPU1</value>
 </trendableKeyValues>
</column>
<column name="Average" type="decimal" columntype="Value"/>
<column name="Sum" type="decimal" columntype="Value"/>
</listValue>
```

**трендаблекэйвалуес/можно&gt; определить в любом ключевом столбце. &lt;** Если для одного ключевого столбца настроен такой фильтр, применяется логика.

### <a name="developing-report-scripts"></a>Разработка скриптов отчетов

После определения метаданных для инициализации можно приступить к написанию скрипта отчета, который является хранимой процедурой T-SQL.

В заголовке "Инициализация метаданных" есть атрибуты **Name** и **репортскрипт** , как показано ниже:

``` syntax
<advisorPack name="Microsoft.ServerPerformanceAdvisor.CoreOS.V1" reportScript="ReportScript"  
```

Основной сценарий отчета называется путем объединения атрибутов **Name** и **репортскрипт** . В следующем примере это будет \[Microsoft. серверперформанцеадвисор. CoreOS. v2.\[ \] Репортскрипт\].

``` syntax
create PROCEDURE [Microsoft.ServerPerformanceAdvisor.CoreOS.V2].[ReportScript] AS SET NOCOUNT ON

- Set alert and notification

- Prepare data for report view
```

Атрибут **Name** будет использоваться в качестве имени схемы базы данных, например пространства имен. Это правило применяется ко всем остальным объектам базы данных, принадлежащим к текущему пакету Advisor, таким как значение списка и хранимые процедуры.

Преимущества использования этого имени схемы перед объектами базы данных включают в себя:

* Предотвращение конфликта имен для разных пакетов Advisor

* Обеспечение большей безопасности

В базе данных SQL Server имя схемы по умолчанию — **dbo**. Учетные данные владельца базы данных обычно требуются для обработки объектов базы данных в **dbo**. Если не создать схему для каждого пакета Advisor, то, скорее всего, два пакета Advisor будут определять значение списка с тем же именем. Это должно быть несущественным, так как для решения этой проблемы можно ввести имя схемы. Кроме того, гораздо проще отменить инициализацию пакета Advisor. Поскольку объект пакета Advisor принадлежит схеме, отличной от **dbo**, это позволяет Spa использовать для доступа к ним более низкую привилегию пользователя.

Сценарий обычного отчета выполняет следующие действия:

* Обращается к собранным данным необработанных данных

* Выполняет вычисления на основе необработанных данных

* Изменение оповещений и рекомендаций

* Подготавливает данные для представления отчета

### <a name="access-raw-collected-data"></a>Доступ к собранным данным необработанных данных

Все собранные данные импортируются в следующие соответствующие таблицы. Дополнительные сведения о схеме таблицы см. в разделе [Определение набора сборщиков данных](#bkmk-definedatacollector).

* реестра

    * \#Параметра registrykeys работать

* WMI

    * \#вмиобжектс

    * \#вмиобжектпропертиес

    * \#вмикуериес

* Счетчик производительности

    * \#PerformanceCounters

* Файл

    * \#Файла

* Трассировка событий Windows

    * \#Событиях

    * \#евентпропертиес

### <a name="set-rule-status"></a>Задать состояние правила

\[Dbo.\]\[ Сетнотификатион\] API задает состояние правила, поэтому в пользовательском интерфейсе можно увидеть значок " **успешно** " или " **предупреждение** ".

* @ruleNamenvarchar (50)

* @adviceNamenvarchar (50)

Сообщения об оповещениях и рекомендациях хранятся в XML-файле метаданных инициализации. Это упрощает управление сценарием отчета.

Изначально каждое правило имеет состояние н/д. С помощью этого API можно задать состояние правила, указав имя Совета. В качестве состояния правила будет использоваться уровень имени Совета.

Помните, что мы определили следующее правило ранее:

``` syntax
<rule name="freediskSize" caption="Free Disk Size on System Drive" description="This rule checks free disk size on the system drive ">
<advice name="SuccessAdvice" level="Success" message="No issue found.">No recommendation.</advice>
<advice name="WarningAdvice" level="Warning" message="Not enough free space on system drive.">Install the operating system on a larger disk.</advice>
</rule>
```

Если объем свободного пространства меньше 2 ГБ, необходимо установить правило на уровень **предупреждения** . Скрипт SQL будет выглядеть следующим образом:

``` syntax
if (@freediskSizeInGB < 2)
BEGIN
    exec dbo.SetNotification N'freediskSize', N'WarningAdvice'
END
ELSE
BEGIN
    exec dbo.SetNotification N'freediskSize', N'SuccessAdvice'
END 
```

### <a name="get-threshold-value"></a>Получение порогового значения

\[Dbo.\]\[ Пороговое значение\] API получает пороговые значения:

* @keynvarchar (50)

* @valueвывод с плавающей запятой

> [!NOTE]
> Пороговые значения — это пары "имя-значение", на которые можно ссылаться в любых правилах. Системные администраторы могут использовать консоль SPA для настройки порогов.

 Продолжая работу с предыдущим примером, для порогового значения определение будет выглядеть следующим образом:

``` syntax
<thresholds>
  <threshold name="freediskSize" caption="Free Disk Size (GB)" description="Free Disk Size  value="10" />
</thresholds>
<rule name="freediskSize" caption="Free Disk Size on System Drive" description="This rule checks free disk size on system drive ">
<advice name="SuccessAdvice" level="Success" message="No issue found.">No recommendation.</advice>
<advice name="WarningAdvice" level="Warning" message="Not enough free space on the system drive.">
Install the operating system on a larger disk.</advice>
<dependencies>
 <threshold ref="freediskSize"/>
</dependencies>
</rule>
```

Скрипт отчета можно изменить, как показано ниже:

``` syntax
DECLARE @freediskSize FLOat
exec dbo.GetThreshold N freediskSize , @freediskSize output

if (@freediskSizeInGB < @freediskSize)

```

### <a name="set-or-remove-the-single-value"></a>Установка или удаление одного значения

\[Dbo.\]\[ Сетсинглевалуе\] API задает одно значение:

* @keynvarchar (50)

* @valueвариант\_SQL

Это значение может выполняться несколько раз для одного ключа значения. Последнее значение сохраняется.

В следующем примере показаны некоторые определенные одиночные значения:

``` syntax
<singleValue section="Systemoverview" caption="Facts">
<value name="OsName" type="string" caption="Operating System" description="WMI: Win32_OperatingSystem/Caption"/>
<value name="Osversion" type="string" caption="OS version" description="WMI: Win32_OperatingSystem/version"/>
<value name="OsLocation" type="string" caption="OS Location" description="WMI: Win32_OperatingSystem/SystemDrive"/>
</singleValue>
```

Затем можно задать одно значение, как показано ниже:

``` syntax
exec dbo.SetSingleValue N OsName ,  Windows 7 
exec dbo.SetSingleValue N Osversion ,  6.1.7601 
exec dbo.SetSingleValue N OsLocation ,  c:\ 
```

В редких случаях может потребоваться удалить результат, заданный ранее с помощью \[dbo.\[ \] API\] ремовесинглевалуе.

* @keynvarchar (50)

Чтобы удалить ранее заданное значение, можно использовать следующий скрипт.

``` syntax
exec dbo.removeSingleValue N Osversion 
```

### <a name="get-data-collection-information"></a>Получение сведений о сборе данных

\[Dbo.\]\[ \] Функция IsCollection Возвращает время, указанное пользователем для сбора данных в секундах:

* @durationвыходные данные int

Вот пример скрипта отчета:

``` syntax
DECLARE @duration int
exec dbo.GetDuration @duration output
```

\[Dbo.\]\[ Внутренний\] API возвращает интервал счетчика производительности. Он может вернуть значение NULL, если текущий отчет не содержит данных счетчика производительности.

* @intervalвыходные данные int

Вот пример скрипта отчета:

``` syntax
DECLARE @interval int
exec dbo.GetInterval @interval output
```

### <a name="set-a-list-value-table"></a>Задание таблицы значений списка

Отсутствует API для обновления таблиц значений списка. Однако вы можете напрямую обращаться к таблицам значений списка. на этапе инициализации для каждого значения списка будет создана соответствующая временная таблица.

В следующем примере показана таблица значений списка.

``` syntax
<listValue name="NetworkAdapterInformation" section="NetworkIOFacts" caption="Physical Network Adapter Information">
<column name="NetworkAdapterId" type="string" caption="ID" description="WMI: Win32_NetworkAdapter/DeviceID"/>
<column name="NetworkAdapterName" type="string" caption="Name" description="WMI: Win32_NetworkAdapter/Name"/>
<column name="type" type="string" caption="type" description="WMI: Win32_NetworkAdapter/Adaptertype"/>
<column name="Speed" type="decimal" caption="Speed (Mbps)" description="WMI: Win32_NetworkAdapter/Speed"/>
<column name="MACaddress" type="string" caption="MAC address" description="WMI: Win32_NetworkAdapter/MACaddress"/>
</listValue>
```

Затем можно написать скрипт SQL для вставки, обновления или удаления результатов:

``` syntax
INSERT INTO #NetworkAdapterInformation (
  NetworkAdapterId,
  NetworkAdapterName,
  type,
  Speed,
  MACaddress
)
VALUES (

)
```

## <a name="development-and-debugging"></a>Разработка и отладка


### <a name="writing-logs"></a>Запись журналов

При наличии дополнительных сведений, которые необходимо сообщить системным администраторам, можно создать журналы. Если для конкретного отчета имеется журнал, в заголовке отчета будет отображаться желтый баннер. В следующем примере показано, как можно создать журнал:

``` syntax
exec dbo.WriteSystemLog N'Any information you want to show to the system administrators , N Warning 
```

Первый параметр — это сообщение, которое должно отображаться в журнале. Вторым параметром является уровень ведения журнала. Допустимыми входными данными для второго параметра могут быть **информационные**, **warning**или **Error**.

### <a name="debug"></a>Отладка

Консоль SPA может работать в двух режимах: Отладка или выпуск. Режим выпуска по умолчанию используется и очищает все собранные необработанные данные после создания отчета. Режим отладки сохраняет все необработанные данные в общей папке и базе данных, что позволяет отлаживать Скрипт отчета в будущем.

**Отладка скрипта отчета**

1.  Установите Microsoft SQL Server Management Studio (SSMS).

2.  После запуска SSMS подключитесь к localhost\\SQLExpress. Имейте в виду, что необходимо использовать localhost, а не. . В противном случае запуск отладчика может оказаться невозможным в SQL Server.

3.  Выполните следующий скрипт, чтобы включить режим отладки:

    ``` syntax
    USE SPADB
    UPdate dbo.Configurations
    SET Value = N'true'
    WHERE Name = N'Debugmode'
    ```

4.  Запустите консоль SPA и запустите пакет Advisor, который требуется отладить.

5.  Дождитесь завершения задачи. Если отчет создан успешно, вернитесь в среду SSMS и найдите последнюю задачу.

    ``` syntax
    select TOP 1 * FROM dbo.Tasks OrdER BY Id DESC
    ```

    Например, выходные данные могут выглядеть следующим образом:

    Id | SessionId | адвисорипаккажеид | репортстатусид | ластупдатетиме | срешолдверсионид
    :---: | :---: | :---: | :---: | :---: | :---:
    12 | 17 | 1 | 2 | 2011-05-11 05:35:24.387 | 1

6.  Можно выполнить следующий скрипт столько раз, сколько нужно для выполнения скрипта отчета с идентификатором 12:

    ``` syntax
    exec dbo.DebugReportScript 12
    ```

    **Примечание** . Можно также нажать клавишу F11, чтобы перейти к предыдущему оператору и выполнить отладку.



Выполнение \[dbo.\]\[ Дебугрепортскрипт\] возвращает несколько результирующих наборов, включая:

1.  Microsoft SQL Server сообщений и журналов пакетов Advisor

2.  Результаты правил

3.  Ключи и значения статистики

4.  Одиночные значения

5.  Все таблицы значений списка

## <a name="best-practices"></a>Рекомендации

### <a name="naming-convention-and-styles"></a>Соглашение об именовании и стили

|                                                                 Регистр символов в стиле Pascal                                                                 |                       Регистр в стиле Camel                        |             Верхний регистр             |
|-----------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------|-----------------------------------|
| <ul><li>Имена в Провисионметадата. XML</li><li>Хранимые процедуры</li><li>Функции</li><li>Имена представлений</li><li>Имена временных таблиц</li></ul> | <ul><li>Имена параметров</li><li>Локальные переменные</li></ul> | Использовать для всех зарезервированных ключевых слов SQL |

### <a name="other-recommendations"></a>Другие рекомендации

* Переместите наиболее логические фрагменты в другие хранимые процедуры и определяемые пользователем функции.

* Сделайте основной сценарий как можно более кратким для целей обслуживания.

* Используйте полное имя объекта SQL.

* Обрабатывать код SQL с учетом регистра.

* Добавьте **SET NOCOUNT ON** в начало каждой хранимой процедуры.

* Рассмотрите возможность использования временных таблиц для пересылки огромного объема данных.

* Чтобы завершить процесс при возникновении ошибки, рассмотрите возможность использования инструкции **Set\_Commit Abort on** .

* Всегда включайте основной номер версии в отображаемое имя пакета Advisor.

## <a href="" id="bkmk-advancedtopics"></a>Дополнительные разделы

### <a name="run-multiple-advisor-packs-simultaneously"></a>Одновременное выполнение нескольких пакетов Advisor

SPA поддерживает одновременное выполнение нескольких пакетов Advisor. Это особенно полезно, когда необходимо одновременно рассмотреть производительность операционной системы службы IIS (IIS) и основной. Пакет советника по работе с ОС может также использовать многие средства для собраний данных, используемые пакетом советника по IIS. Если два или более пакета Advisor выполняются на одном целевом компьютере, SPA не соберет одни и те же данные дважды.

В следующем примере показан рабочий процесс для запуска двух пакетов Advisor.

![Запуск нескольких пакетов Advisor](../media/server-performance-advisor/spa-dev-guide-multi-advisor-packs.png)

Набор сборщиков данных слияния предназначен только для сбора данных счетчиков производительности и ETW. Применяются следующие правила слияния:

1. SPA принимает наибольшую продолжительность в качестве нового периода.

2. При наличии конфликтов слияния следуют следующие правила.

   1. В качестве нового интервала следует использовать наименьший интервал.

   2. Взять супер набор счетчиков производительности. Например, с **процессом\*()\\% времени процессора** и **процессом (\*)\\\*,\\\*Process ()\\*\\** Возвращает больше данных, поэтому **процесс (\*)\\% загруженности процессора** и **процесса\*(\\)\\** * удаляется из объединенного набора сборщиков данных.

### <a name="collect-dynamic-data"></a>Получение динамических данных

SPA требует определенного набора сборщиков данных во время разработки. Не всегда возможно знать, какие данные необходимы для создания отчета, так как динамические данные и путь запроса неизвестны до тех пор, пока их зависимые данные не будут доступны.

Например, если необходимо перечислить все понятные имена сетевых адаптеров, сначала необходимо запросить Инструментарий WMI для перечисления всех сетевых адаптеров. Каждый возвращаемый объект WMI имеет путь к разделу реестра, где хранится понятное имя. Путь к разделу реестра неизвестен во время разработки. В этом случае требуется поддержка динамических данных.

Чтобы перечислить все сетевые адаптеры, можно использовать следующий запрос WMI с помощью Windows PowerShell:

``` syntax
Get-WmiObject -Namespace Root\Cimv2 -query "select PNPDeviceID FROM Win32_NetworkAdapter" | forEach-Object { Write-Output $_.PNPDeviceID }
```

Он возвращает список объектов сетевого адаптера. Каждый объект имеет свойство с именем **пнпдевицеид**, которое поддерживает относительный путь к разделу реестра. Вот пример выходных данных предыдущего запроса:

``` syntax
ROOT\*ISatAP\0001
PCI\VEN_8086&DEV_4238&SUBSYS_11118086&REV_35\4&372A6B86&0&00E4
ROOT\*IPHTTPS\0000

```

Чтобы найти значение **FriendlyName** , откройте редактор реестра и перейдите к параметру реестра, объединив **\_перечисление\\\_\\\\\\CurrentControlSetлокальногокомпьютераhKey.** с каждой строкой в предыдущем примере. Например: **HKey\_локальныйкомпьютер\_система\\CurrentControlSetEnum\\ rootIPHTTPS0000\\.\\\\\\\***

Чтобы преобразовать предыдущие шаги в защищенные метаданные, Добавьте скрипт в следующем примере кода:

``` syntax
<advisorPack>
<dataSourceDefinition xmlns="http://microsoft.com/schemas/ServerPerformanceAdvisor/dc/2010">
 <dataCollectorSet >
<registryKeys>
 ?<registryKey>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Enum\$(NetworkAdapter.PNPDeviceID)\FriendlyName</registryKey>
</registryKeys>
<managementpaths>
 ?<path name="NetworkAdapter">Root\Cimv2:select PNPDeviceID FROM Win32_NetworkAdapter</path>
</managementpaths>
```

В этом примере сначала необходимо добавить WMI-запрос в манажементпасс и определить имя ключа **сетевого адаптера**. Затем добавьте раздел реестра и ссылку на **сетевого адаптера** с помощью синтаксиса **$ (сетевого адаптера. пнпдевицеид)** .

В следующей таблице определяется, поддерживает ли сборщик данных в SPA поддержку динамических данных, а также возможность ссылок на них другими сборщиками данных.

Тип данных | Поддержка динамических данных | Можно ссылаться
--- | :---: | :---:
раздел реестра | Да | Да
WMI | Да | Да
Файл | Да | Нет
Счетчик производительности | Нет | Нет
Трассировка событий Windows | Нет | Нет

Для сборщика данных WMI каждый объект WMI имеет множество присоединенных атрибутов. Любой тип объекта WMI всегда имеет три атрибута: \_\_Пространство имен \_, \_класс и \_релпас. \_

Чтобы определить сборщик данных, на который ссылаются другие сборщики данных, назначьте атрибут **Name** с уникальным ключом в файле провисионметадата. XML. Этот ключ используется зависимыми собирающими данными для создания динамических данных.

Вот пример для раздела реестра:

``` syntax
<registryKey  name="registry">HKEY_LOCAL_MACHINE </registryKey>
```

Пример для WMI:

``` syntax
<path name="wmi">Root\Cimv2:select PNPDeviceID FROM Win32_NetworkAdapter</path>
```

Чтобы определить зависимый сборщик данных, используется следующий синтаксис: $ ( *{Name}* . *{Attribute}* ).

*{Name}* и *{Attribute}* — это заполнители.

Когда Spa собирает данные с целевого сервера, он динамически заменяет шаблон $ (\*.\*) фактически собранными данными из сборщика эталонных данных (раздел реестра или инструментарий WMI), например:

``` syntax
<registryKey>HKEY_LOCAL_MACHINE\$(registry.key)\ </registryKey>
<registryKey  name="registry">HKEY_LOCAL_MACHINE\$(wmi.Relativeregistrypath)\ </registryKey>
<path name="wmi"> </path>
<file>$(wmi.FileName)</file>
```

**Примечание** . SPA поддерживает неограниченную глубину ссылки, но при наличии слишком большого количества уровней учитывайте нагрузку на производительность. Убедитесь, что циклическая ссылка или самостоятельная ссылка не поддерживаются.

### <a name="versioning-limitations"></a>ограничения управления версиями

SPA поддерживает сброс и дополнительные обновления версий. Эти процессы используют один и тот же алгоритм. Процесс заключается в обновлении всех объектов базы данных и пороговых значений, но при этом сохраняются существующие данные. Это может быть обновление до более поздней версии или понижение до более ранней версии. Выберите пакет Advisor и нажмите кнопку **Сброс** в диалоговом окне **Настройка пакетов Advisor** в SPA, чтобы сбросить или применить обновления.

Эта функция в основном используется для незначительных обновлений. Вы не можете радикально изменить элементы интерфейса, отображаемые в пользовательском интерфейсе. Если вы хотите внести значительные изменения, необходимо создать другой пакет Advisor. Основную версию следует включать в имя пакета Advisor.

Ограничения по дополнительным версиям **не позволяют выполнять** следующие действия.

* Изменение имени схемы

* Изменение типа данных любой отдельной группы значений или столбцов таблицы значений списка

* Добавить или удалить пороговые значения

* Добавление или удаление правил

* Добавить или удалить Совет

* Добавление или удаление одиночных значений

* Добавление или удаление значений списка

* Добавление или удаление столбца значений списка

### <a href="" id="bkmk-tooltips"></a>Подсказки

Почти все атрибуты **описания** будут отображаться в консоли Spa в виде подсказки.

для таблицы значений списка можно добиться подсказок на основе строк, добавив следующий атрибут:

``` syntax
<listValue descriptionColumn="Description">
<column name="Name"/>
<column name="Description"/>
</listValue>
```

Атрибут **дескриптионколумн** ссылается на имя столбца. В этом примере столбец Description не отображается как физический столбец. Однако он отображается как подсказка при наведении указателя мыши на каждую строку первого столбца.

Рекомендуется, чтобы в подсказке отображался источник данных для пользователя. Ниже приведены форматы для отображения источников данных.

Источник данных | Формат | Пример
--- | --- | ---
WMI | WMI: &lt;поле&gt;WMICLASS/&lt;&gt; | ИНТЕРФЕЙСА Win32_OperatingSystem и заголовок
Счетчик производительности | Перфкаунтер: &lt;CategoryName&gt;имя_экземпляра/&lt;&gt; | Перфкаунтер: Процесс/% загруженности процессора
реестра | реестр: &lt;регистеркэй&gt; | реестра хклм\софтваре\микрософт<br>\\ASP.NET\\рутвер
файл конфигурации | ConfigFile &lt;FilePath&gt;;\[ Формате &lt;Формате&gt;\]<br>**Примечание**<br>XPath является необязательным и является допустимым только в том случае, если файл является XML-файлом. | ConfigFile: WINDIR%\\system32\\инетсрв\конфиг\\ApplicationHost. config<br>XPath: Configuration&frasl;System. Server<br>&frasl;хттппротокол&frasl;@allowKeepAlive
Трассировка событий Windows | ТРАССИРОВК &lt;Provider/&gt;(ключевые слова) | ТРАССИРОВК Трассировка ядра Windows (процесс, NET)

### <a name="table-collation"></a>Параметры сортировки таблицы

Когда пакет Advisor станет более сложным, можно создать собственные переменные таблицы или временные таблицы для хранения промежуточных результатов в скрипте отчета.

Сортировка строковых столбцов может быть проблематичной, так как создаваемые параметры сортировки таблицы могут отличаться от создаваемых платформой SPA. Если сопоставить два строковых столбца в разных таблицах, может появиться ошибка параметров сортировки. Чтобы избежать этой проблемы, всегда следует определять строку параметров сортировки столбца как **SQL\_Latin1\_General\_CP1\_\_CI, как** при определении таблицы.

Здесь показано, как определить переменную таблицу:

``` syntax
DECLARE @filesIO TABLE (
 Name nvarchar(500) COLLatE SQL_Latin1_General_CP1_CI_AS,
 AverageFileAccessvolume float,
 AverageFileAccessCount float,
 Filepath nvarchar(500) COLLatE SQL_Latin1_General_CP1_CI_AS
)
```

### <a name="collect-etw"></a>Получение ETW

Здесь описано, как определить ETW в файле Провисионметадата. XML:

``` syntax
<dataSourceDefinition>
  <providers>
    <provider session="NT Kernel Logger" guid="{9E814AAD-3204-11D2-9A82-006008A86939}"/>
  </providers>
</dataSourceDefinition>
```

Для сбора ETW можно использовать следующие атрибуты поставщика:

Атрибут | Type | Описание
--- | --- | ---
guid | Код GUID | GUID поставщика
сеанс | строка | Имя сеанса ETW (необязательно, требуется только для событий ядра)
кэйвордсани | Hex | Любые ключевые слова (необязательно, без префикса 0x)
кэйвордсалл | Hex | Все ключевые слова (необязательно)
свойства | Hex | Свойства (необязательно)
уровень | Hex | Level (необязательно)
bufferSize | int | Размер буфера (необязательно)
флуштиме | int | Время записи на диск (необязательно)
максбуффер | int | Максимальный буфер (необязательно)
минбуффер | int | Минимальный буфер (необязательно)

Ниже показаны две выходные таблицы.

**\#Схема таблицы событий**

Имя столбца | Тип данных SQL | Описание
--- | --- | ---
SequenceID | Int, не NULL | Идентификатор последовательности корреляции
евенттипеид | Int, не NULL | Идентификатор типа события (см. [dbo]. [ Евенттипес])
Идентификатор | BigInt, не NULL | Идентификатор процесса
Tидентификатор | BigInt, не NULL | Идентификатор потока
timestamp | datetime2, не РАВНый NULL | timestamp
кернелтиме | BigInt, не NULL | Время ядра
усертиме | BigInt, не NULL | Время пользователя

**\#Схема таблицы Евентпропертиес**

Имя столбца | Тип данных SQL | Описание
--- | --- | ---
SequenceID | Int, не NULL | Идентификатор последовательности корреляции
Имя | Nvarchar (100) | Имя свойства
Значение | Nvarchar (4000) | Значение

### <a name="etw-schema"></a>Схема ETW

Схему ETW можно создать, запустив Tracerpt. exe в качестве ETL-файла. Создается файл Schema. Man. Так как формат ETL-файла зависит от компьютера, следующий сценарий работает только в следующих ситуациях:

1.  Запустите сценарий на компьютере, где собирается соответствующий ETL-файл.

2.  Или запустите сценарий на компьютере с той же операционной системой и установленными компонентами.

``` syntax
tracerpt *.etl -export
```

## <a name="glossary"></a>Глоссарий


В этом документе используются следующие термины:

**Пакет Advisor**

Пакет Advisor — это коллекция метаданных и скриптов SQL, которые обрабатывают журналы производительности, собранные с целевого сервера. Затем пакет Advisor создает отчеты на основе данных журнала производительности. Метаданные в пакете Advisor определяют данные, которые должны быть собраны с целевого сервера для измерения производительности. Метаданные также определяют набор правил, пороговые значения и формат отчета. Чаще всего пакет Advisor написан специально для одной роли сервера, например службы IIS (IIS).

**Консоль SPA**

Консоль SPA ссылается на Спаконсоле. exe, который является центральным компонентом советника по производительности сервера. SPA не требуется запускать на тестируемом целевом сервере. Консоль SPA содержит все пользовательские интерфейсы для SPA, от настройки проекта до выполнения анализа и просмотра отчетов. По разработке, SPA является двусторонним приложением. Консоль SPA содержит слой пользовательского интерфейса и часть уровня бизнес-логики. Консоль SPA планирует и обрабатывает запросы на анализ производительности.

**Платформа SPA**

SPA содержит две основные части: платформу и пакеты Advisor. Платформа SPA предоставляет все пользовательские интерфейсы, обработку журналов производительности, конфигурацию, обработку ошибок, API-интерфейсы баз данных и процедуры управления.

**Проект SPA**

Проект SPA — это база данных, содержащая все сведения о целевых серверах, пакетах Advisor и отчетах анализа производительности, которые создаются на целевых серверах для пакетов Advisor. Вы можете сравнивать и просматривать журналы и тенденции в рамках одного проекта SPA. Пользователь может создать более одного проекта. Проекты SPA независимы друг от друга и не имеют общих данных для проектов.

**Целевой сервер**

Целевой сервер — это физический компьютер или виртуальная машина под управлением Windows Server с определенными ролями сервера, такими как IIS.

**Сеанс анализа данных**

Сеанс анализа данных — это анализ производительности на указанном целевом сервере. Сеанс анализа данных может включать несколько пакетов Advisor. Наборы сборщиков данных из этих пакетов Advisor объединяются в единый набор сборщиков данных. Все журналы производительности для одного сеанса анализа данных собираются в один и тот же период времени. Анализ отчетов, созданных пакетами Advisor, выполняющимися в одном сеансе анализа данных, может помочь пользователям понять общую ситуацию с производительностью и определить основные причины проблем с производительностью.

**Трассировка событий для Windows**

[Трассировка событий](https://msdn.microsoft.com/library/windows/desktop/bb968803.aspx) Windows (ETW) — это высокопроизводительная, масштабируемая, экономичная система трассировки, предоставляемая в операционных системах Windows. Он предоставляет возможности профилирования и отладки, которые можно использовать для устранения неполадок в различных сценариях. SPA использует события ETW в качестве источника данных для создания отчетов о производительности. Общие сведения о ETW см. [в статье улучшение отладки и настройка производительности с помощью ETW](https://msdn.microsoft.com/magazine/cc163437.aspx).

**Запрос WMI**

Инструментарий управления Windows (WMI) (WMI) — это инфраструктура для данных управления и операций в операционных системах Windows. Можно создавать сценарии или приложения WMI для автоматизации задач администрирования на удаленных компьютерах. Инструментарий WMI также предоставляет данные управления другим частям операционной системы и продуктам. SPA использует сведения о классе WMI и точки данных в качестве источников для создания отчетов о производительности.

**Счетчики производительности**

Счетчики производительности используются для предоставления сведений о том, насколько хорошо работает операционная система, приложение, служба или драйвер. Данные счетчиков производительности позволяют определить узкие места системы и настроить производительность системы и приложений. Операционная система, сеть и устройства предоставляют данные счетчиков, которые приложение может использовать для предоставления пользователям графического представления о том, насколько хорошо работает система. SPA использует сведения о счетчиках производительности и точки данных в качестве источников для создания отчетов о производительности.

**журналы и оповещения производительности**

Журналы и оповещения производительности (PLA) — это встроенная служба в операционной системе Windows. Она предназначена для накопления журналов и трассировок производительности, а также создает предупреждения о производительности при выполнении определенных триггеров. PLA можно использовать для получения счетчиков производительности, трассировки событий Windows (ETW), запросов WMI, разделов реестра и файлов конфигурации. PLA также поддерживает удаленный сбор данных с помощью удаленных вызовов процедур (RPC). Пользователь определяет группу сборщиков данных, которая содержит сведения о собираемых данных, частоте сбора данных, продолжительности сбора данных, фильтрах и расположении для сохранения файлов результатов. SPA использует PLA для получения всех данных о производительности целевых серверов.

**Один отчет**

Один отчет — это отчет SPA, созданный на основе одного сеанса анализа данных для одного пакета Advisor на одном целевом сервере. Он может содержать уведомления и различные разделы данных.

**Параллельный отчет**

Параллельный отчет — это отчет SPA, который сравнивает два отдельных отчета для одного и того же пакета Advisor. Эти два отчета могут формироваться с разных целевых серверов или из отдельных запусков анализа производительности на одном целевом сервере. Параллельный отчет создает возможность сравнить два отчета, чтобы помочь пользователям определить аномальное поведение или параметры в одном из отчетов. Параллельный отчет содержит уведомления и различные разделы данных. В каждом разделе данные из обоих отчетов отображаются рядом друг с другом.

**Диаграмма тенденций**

Диаграмма тренда — это отчет SPA, который используется для исследования повторяющихся закономерностей проблем с производительностью. Многие повторяющиеся проблемы с производительностью вызваны тем, что запланированные серверные изменения загружаются с сервера или с клиентских компьютеров, что может происходить ежедневно или еженедельно. SPA обеспечивает 24-часовой график тренда и диаграмму тенденций за семь дней для выявления этих проблем.

Пользователь может выбрать один или несколько рядов данных за раз, то есть числовое значение в рамках одного отчета, например **среднее общее использование ЦП**. точнее говоря, числовое значение — это скалярное значение от одного сервера, созданного одним ТД в определенный экземпляр времени. SPA группирует эти значения в 24 группы, по одному на каждый час дня (семь для отчета в течение 7 дней, по одному на каждый день недели). SPA вычисляет средние, минимальные, максимальные и стандартные отклонения для каждой группы.

**Историческая диаграмма**

Историческая диаграмма — это отчет SPA, который используется для отображения изменений в определенных числовых значениях в отдельных отчетах для заданной пары "сервер-пакет Advisor" с течением времени. Пользователь может выбрать несколько рядов данных и отобразить их вместе на исторических диаграммах, чтобы понять корреляцию между разными рядами данных.

**Ряд данных**

Ряды данных — это числовые данные, собранные из одного источника данных за определенный период времени. Один и тот же источник означает, что данные должны поступать с одного целевого сервера, например средней длины очереди запросов для служб IIS на одном сервере.

**Правил**

Правила — это сочетания логики, пороговых значений и описаний. Они представляют потенциальную угрозу производительности. Каждый пакет Advisor содержит несколько правил. Каждое правило запускается процессом создания отчета. Правило применяет логику и пороговые значения к данным в отдельном отчете. Если условия соблюдены, выдается предупреждающее уведомление. В противном случае для уведомления задается состояние **ОК** . Если правило не применяется, уведомление устанавливается в состояние Неприменимо (**НД**).

**Уведомления**

Уведомление — это информация, которую правило отображает пользователям. Он включает в себя состояние правила (**ОК**, **НД**или **предупреждение**), имя правила и возможные рекомендации для устранения проблем с производительностью.
