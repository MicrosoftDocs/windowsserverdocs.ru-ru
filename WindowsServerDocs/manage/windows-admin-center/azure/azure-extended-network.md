---
title: Расширение локальных подсетей в Azure с помощью расширенной сети Azure
description: Расширение локальных подсетей в Azure с помощью расширенной сети Azure
ms.technology: manage
ms.topic: article
author: grcusanz
ms.author: grcusanz
ms.date: 12/17/2019
ms.localizationpriority: medium
ms.prod: windows-server
ms.openlocfilehash: 29e370da31b02a475f0fdd5d7914348189ca616b
ms.sourcegitcommit: 6a245fefdf958bfc0aeb69f7a887d11a07bdcd23
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/12/2020
ms.locfileid: "94570359"
---
# <a name="extend-your-on-premises-subnets-into-azure-using-azure-extended-network"></a>Расширение локальных подсетей в Azure с помощью расширенной сети Azure

> Применяется к: Windows Admin Center, ознакомительная версия Windows Admin Center

## <a name="overview"></a>Обзор

Расширенная сеть Azure позволяет растянуть локальную подсеть в Azure, чтобы разрешить локальным виртуальным машинам оставаться исходные локальные частные IP-адреса при миграции в Azure.

Эта сеть расширяется с помощью двунаправленного туннеля ВКСЛАН между двумя виртуальными машинами Windows Server 2019, работающими в качестве виртуальных устройств, работающих локально и в Azure, каждый из которых также подключен к подсети, которую необходимо расширить.
Для каждой подсети, которую вы собираетесь расширить, требуется одна пара устройств. Несколько подсетей можно расширить с помощью нескольких пар.

> [!NOTE]
> Расширенную сеть Azure следует использовать только для компьютеров, IP-адреса которых не могут изменяться при миграции в Azure. Всегда лучше изменить IP-адрес и подключить его к подсети, которая полностью существует в Azure, если это возможно.

## <a name="planning"></a>Планирование

Чтобы подготовиться к использованию расширенной сети Azure, необходимо указать подсеть, которую нужно растянуть, а затем выполнить следующие действия.

### <a name="capacity-planning"></a>Планирование ресурсов

Вы можете расширить до 250 IP-адресов с помощью расширенной сети Azure. Вы можете рассчитывать на суммарную пропускную способность около 700 Мбит/с с некоторой вариативностью в зависимости от скорости ЦП виртуальных сетевых устройств Azure.

### <a name="configuration-in-azure"></a>Настройка в Azure

Перед использованием центра администрирования Windows необходимо выполнить следующие действия на портале Azure:

1. В дополнение к подсетям, необходимым для подключения шлюза, создайте в Azure виртуальную сеть, которая содержит по крайней мере две подсети. Одна из создаваемых подсетей должна использовать ту же подсеть CIDR, что и локальная подсеть, которую требуется расширить. Подсеть должна быть уникальной в домене маршрутизации, чтобы она не перекрывались с локальными подсетями.

2. Настройте шлюз виртуальной сети для использования подключения типа "сеть — сеть" или ExpressRoute, чтобы подключить виртуальную сеть к локальной сети.

3. Создайте виртуальную машину Windows Server 2019 в Azure, которая может выполнять вложенную виртуализацию. Это один из двух виртуальных устройств. Подключите основной сетевой интерфейс к маршрутизируемой подсети и второй сетевой интерфейс к расширенной подсети.

4. Запустите виртуальную машину, включите роль Hyper-V и перезагрузите систему. Пример:

    ```powershell
    Install-WindowsFeature -Name Hyper-V -IncludeManagementTools -Restart
    ```

5. Создайте на виртуальной машине два внешних коммутатора и подключите их к каждому из сетевых интерфейсов. Пример:

    ```powershell
    New-VMSwitch -Name "External" -AllowManagementOS $true -NetAdapterName "Ethernet"
    New-VMSwitch -Name "Extended" -AllowManagementOS $true -NetAdapterName "Ethernet 2"
    ```

### <a name="on-premises-configuration"></a>Локальная конфигурация

Кроме того, необходимо выполнить некоторые ручные настройки в локальной инфраструктуре, в том числе создать виртуальную машину в качестве локального виртуального устройства:

1. Убедитесь, что подсети доступны на физическом компьютере, на котором будет развернута локальная виртуальная машина (виртуальное устройство). Сюда входит подсеть, которую требуется расширить, и вторая подсеть, которая является уникальной и не перекрывается с подсетями в виртуальной сети Azure.

2. Создайте виртуальную машину Windows Server 2019 в любом гипервизоре, поддерживающем вложенную виртуализацию. Это локальный виртуальный модуль. Рекомендуется создать его как виртуальную машину высокой доступности в кластере. Подключите виртуальный сетевой адаптер к маршрутизируемой подсети и вторым виртуальным сетевым адаптером к расширенной подсети.

3. Запустите виртуальную машину, а затем выполните эту команду из сеанса PowerShell на виртуальной машине, чтобы включить роль Hyper-V, и перезапустите виртуальную машину:

    ```powershell
    Install-WindowsFeature -Name Hyper-V -IncludeManagementTools -Restart
    ```

4. Выполните следующие команды в сеансе PowerShell на виртуальной машине, чтобы создать два внешних коммутатора на виртуальной машине, и подключите их к каждому из сетевых интерфейсов:

    ```powershell
    New-VMSwitch -Name "External" -AllowManagementOS $true -NetAdapterName "Ethernet"
    New-VMSwitch -Name "Extended" -AllowManagementOS $true -NetAdapterName "Ethernet 2"
    ```

### <a name="additional-prerequisites"></a>Дополнительные требования

При наличии брандмауэра между локальной сетью и Azure необходимо настроить его для поддержки асимметричной маршрутизации. Это могут быть действия для отключения случайного нумерации номеров и включения обхода состояния TCP. Для выполнения этих действий обратитесь к документации поставщика брандмауэра.

## <a name="deploy"></a>Развернуть

Развертывание управляется с помощью центра администрирования Windows.

### <a name="install-and-configure-windows-admin-center"></a>Установка и настройка центра администрирования Windows

1. [Скачайте и установите центр администрирования Windows](../understand/windows-admin-center.md) на любой компьютер, на котором может работать центр администрирования Windows, кроме двух созданных ранее виртуальных устройств.

2. В центре администрирования Windows выберите **Параметры** (в правом верхнем углу страницы) > **расширения**. Затем выберите **расширения** :

    ![Снимок экрана, показывающий вкладку "доступные расширения" параметров](../media/azure-extended-network/installed-extensions.png)

3. На вкладке **Доступные расширения** выберите **Расширенная сеть Azure** , а затем нажмите кнопку **установить**.

    Через несколько секунд появится сообщение об успешной установке.

4. [Подключите центр администрирования Windows к Azure](azure-integration.md), если вы еще этого не сделали. Если пропустить этот шаг сейчас, мы попросим вас сделать это позже в процессе.

5. В центре администрирования Windows последовательно выберите **все подключения**  >  **добавить** , а затем щелкните **Добавить** в плитке **Windows Server** . Введите имя сервера (и учетные данные при необходимости) для локального виртуального устройства.

    ![Снимок экрана центра администрирования Windows, демонстрирующий средство расширенной сети Azure в диспетчер сервера на локальном виртуальном устройстве](../media/azure-extended-network/azure-extended-network.png).

6. Чтобы начать, щелкните " **Расширенная сеть Azure** ". В первый раз отобразится обзор и кнопка установки:

    ![Образ —](../media/azure-extended-network/azure-extended-network-intro.png)

### <a name="deploy-azure-extended-network"></a>Развертывание расширенной сети Azure

1. Нажмите кнопку **настроить** , чтобы начать настройку.

2. Нажмите кнопку **Далее** , чтобы перейти к обзору.

3. На панели **отправить пакет** необходимо скачать пакет агента расширенной сети Azure и передать его в виртуальное устройство. Следуйте инструкциям на панели.

    > [!IMPORTANT]
    > Прокрутите вниз, если это необходимо, и нажмите кнопку " **Отправить** " перед нажатием кнопки **"далее": Extended-Network установки**.

4. Выберите подсеть CIDR локальной сети, которую требуется расширить. Список подсетей считывается из виртуального устройства. Если вы не подключили виртуальный модуль к правильному набору подсетей, в этом списке не появится требуемая подсеть CIDR.

5. После выбора подсети CIDR нажмите кнопку **Далее** .

6. Выберите подписку, группу ресурсов и виртуальную сеть, в которую вы расширяете:

    ![Сеть Azure](../media/azure-extended-network/azure-network.png)

    Регион (расположение Azure) и подсеть выбираются автоматически. Нажмите кнопку Далее: Extended-Network Настройка шлюза, чтобы выполнить продолжение.

7. Теперь вы настроите виртуальные устройства. Сведения о локальном шлюзе должны быть заполнены автоматически:

    ![локальный сетевой шлюз](../media/azure-extended-network/on-premises-network-gateway.png)

    Если он выглядит правильно, можно нажать кнопку **Далее**.

8. Для виртуального устройства Azure необходимо выбрать группу ресурсов и виртуальную машину для использования:

    ![Сетевой шлюз Azure](../media/azure-extended-network/azure-network-gateway.png)

9. Выбрав виртуальную машину, необходимо также выбрать подсеть шлюза Azure Extended-Network Gateway CIDR. Затем нажмите кнопку **Далее: развернуть**.

10. Просмотрите сводные данные и нажмите кнопку **развернуть** , чтобы начать процесс развертывания. Развертывание займет примерно 5-10 минут. После завершения развертывания вы увидите следующую панель для управления расширенными IP-адресами и состоянием " **ОК** ":

    ![Установка завершена](../media/azure-extended-network/installation-complete.png)

## <a name="manage"></a>Управление

Для каждого IP-адреса, который должен быть доступен в расширенной сети, необходимо настроить. Можно настроить до 250 адресов для расширения.
Расширение адреса

1. Щелкните **Добавить IPv4-адреса** :

    ![Добавление IPv4-адресов](../media/azure-extended-network/add-ipv4-addresses.png)

2. Вы увидите всплывающее меню **Добавить новые IPv4-адреса** справа:

    ![Панель добавления IPv4-адресов](../media/azure-extended-network/add-ipv4-addresses-panel.png)

3. Используйте кнопку **Добавить** , чтобы вручную добавить адрес. Адреса, которые вы добавляете в локальную среду, будут доступны в адресах Azure, добавляемых в список адресов Azure, и наоборот.

4. Расширенная сеть Azure сканирует сеть для обнаружения IP-адресов и заполняет списки предложений на основе этой проверки. Чтобы расширить эти адреса, необходимо использовать раскрывающийся список и установить флажок рядом с обнаруженным адресом. Не все адреса будут обнаружены. При необходимости используйте кнопку **Добавить** , чтобы вручную добавить адреса, которые не обнаруживаются автоматически.

    ![Добавление панели IPv4-адресов с информацией](../media/azure-extended-network/add-ipv4-addresses-panel-filled.png)

5. По завершении нажмите кнопку **Отправить** . Вы увидите, что состояние изменится на " **Обновление** ", " **ход выполнения** " и, наконец, вернитесь к " **ОК** " после завершения настройки.

    Теперь ваши адреса расширены. Используйте кнопку Добавить IPv4-адреса, чтобы добавить дополнительные адреса в любое время. Если IP-адрес больше не используется в обоих концах расширенной сети, установите флажок рядом с ним и выберите Удалить IPv4-адреса.

Если вы больше не хотите использовать расширенную сеть Azure, нажмите кнопку **удалить расширенную сеть Azure** . Это приведет к удалению агента из двух виртуальных устройств и удалению расширенных IP-адресов. Сеть будет перестанет быть расширена. Если вы хотите начать использовать расширенную сеть еще раз, необходимо будет повторно запустить программу установки после ее удаления.

## <a name="troubleshooting"></a>Диагностика

Если при развертывании расширенной сети Azure появляется сообщение об ошибке, выполните следующие действия.

1. Убедитесь, что оба виртуальных устройства используют Windows Server 2019.

2. Убедитесь, что вы не используете центр администрирования Windows на одном из виртуальных устройств. Рекомендуется запускать центр администрирования Windows из локальной сети.

3. Убедитесь, что вы можете удаленно войти в локальную виртуальную машину из шлюза центра администрирования Windows с помощью `enter-pssession` .

4. Если между Azure и локальной средой есть брандмауэр, убедитесь, что он разрешает трафик UDP для выбранного порта (по умолчанию 4789). Используйте такое средство, как Ктстраффик, для настройки прослушивателя и отправителя. Убедитесь, что трафик может быть отправлен в обоих направлениях по указанному порту.

5. Используйте пктмон, чтобы убедиться, что пакеты отправлены и получены должным образом. Запустите пктмон на каждом виртуальном устройстве:

    ```powershell
    Pktmon start –etw
    ```

6. Запустите конфигурацию расширенной сети Azure, а затем отключите трассировку:

    ```powershell
    Pktmon stop
    Netsh trace convert input=<path to pktmon etl file>
    ```

7. Откройте текстовый файл, созданный на каждом виртуальном устройстве, и найдите UDP-трафик по указанному порту (по умолчанию — 4789). Если вы видите трафик, отправленный из локального виртуального устройства, но не полученный виртуальным модулем Azure, необходимо проверить маршрутизацию и брандмауэр между устройствами. Если вы видите трафик, отправленный из локальной среды в Azure, вы увидите, что виртуальный модуль Azure отправит пакет в ответе. Если этот пакет никогда не получается локальным виртуальным устройством, необходимо убедиться, что маршрутизация правильна, а брандмауэр не блокирует трафик.

### <a name="diagnosing-the-data-path-after-initial-configuration"></a>Диагностика пути к данным после начальной настройки

После настройки расширенной сети Azure дополнительные проблемы, которые могут возникнуть, обычно возникают из-за блокировки трафика брандмауэрами или превышения MTU в случае временной ошибки.

1. Убедитесь, что оба виртуальных устройства работают и работают.

2. Убедитесь, что на каждом из виртуальных устройств работает агент расширенной сети Azure:

    ```powershell
    get-service extnwagent
    ```

3. Если состояние не выполняется, его можно запустить с помощью:

    ```powershell
    start-service extnwagent
    ```

4. Используйте паккетмон, как описано в шаге 5 выше, при отправке трафика между двумя виртуальными машинами в расширенной сети для проверки того, что трафик получен виртуальными устройствами, отправлен через настроенный UDP-порт, а затем получен и переадресован другим виртуальным устройством.
