---
title: Рекомендации по устранению неполадок KMS
description: Содержит сведения о службе KMS и предлагает инструменты и методики для устранения неполадок, связанных с активацией.
ms.topic: troubleshooting
ms.date: 9/24/2019
ms.technology: server-general
author: Teresa-Motiv
ms.author: v-tea
manager: dcscontentpm
ms.localizationpriority: medium
ms.openlocfilehash: a089e0efb54af86f97595d8863926525a8416fea
ms.sourcegitcommit: d5e27c1f2f168a71ae272bebf8f50e1b3ccbcca3
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/23/2020
ms.locfileid: "86960466"
---
# <a name="guidelines-for-troubleshooting-the-key-management-service-kms"></a>Рекомендации по устранению неполадок службы управления ключами (KMS)

В процессе развертывания многие корпоративные клиенты настраивают службу управления ключами (KMS), чтобы включить активацию Windows в своей среде. Это простой процесс настройки узла KMS, после завершения которого клиенты KMS обнаруживают узел и пытаются выполнить активацию самостоятельно. Но что произойдет, если этот процесс не заработает? Что делать дальше? В этой статье описываются ресурсы, необходимые для устранения проблемы. Дополнительные сведения о записях журнала событий и сценарии Slmgr.vbs см. в [техническом справочнике по активации корпоративных лицензий](/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/dn502529(v=ws.11)).

## <a name="kms-overview"></a>Общие сведения о KMS

Начнем с быстрого повторения материала об активации KMS. Служба KMS использует модель "клиент — сервер". По сути, она напоминает DHCP. Вместо передачи IP-адресов клиентам по их запросу KMS обеспечивает активацию продукта. Служба KMS также использует модель продления, в которой клиенты пытаются выполнить повторную активацию через равные промежутки времени. Существуют две роли: узел *KMS* и клиент *KMS*.

- На **узле KMS** работает служба активации. Именно он обеспечивает активацию в среде. Чтобы настроить узел KMS, необходимо установить ключ KMS из центра поддержки корпоративных лицензий (VLSC), а затем активировать службу.
- **Клиент KMS** — это операционная система Windows, которая развернута в среде и должна быть активирована. Клиенты KMS могут работать под управлением любого выпуска Windows, использующего активацию корпоративных лицензий. Клиенты KMS поставляются с предварительно установленным ключом, который называется универсальным ключом многократной установки (GVLK) или ключом установки клиента KMS. Наличие GVLK означает, что данная система — клиент KMS. Клиенты KMS используют записи SRV DNS (_vlmcs._tcp) для определения узла KMS. Затем клиенты автоматически пытаются обнаружить и использовать эту службу для самостоятельной активации. В течение 30-дневного льготного периода они пытаются выполнить активацию каждые два часа. После активации клиенты KMS пытаются продлевать активацию каждые семь дней.

При устранении неполадок, возможно, придется рассмотреть обе стороны (узел и клиент), чтобы выяснить, что происходит.

## <a name="kms-host"></a>Узел KMS

Существуют две области, которые необходимо изучить на узле KMS. Сначала проверьте состояние службы лицензий на программное обеспечение узла. Во вторых, с помощью Просмотра событий проверьте наличие событий, связанных с лицензированием или активацией.

### <a name="slmgrvbs-and-the-software-licensing-service"></a>Сценарий Slmgr.vbs и служба лицензий на программное обеспечение

Чтобы просмотреть подробные выходные данные службы лицензий на программное обеспечение, откройте окно командной строки с повышенными привилегиями и введите в нем **slmgr.vbs/dlv**. На следующем снимке экрана показаны результаты выполнения этой команды на одном из узлов KMS в корпорации Майкрософт.

![Выходные данные Slmgr для узла KMS](./media/ee939272.kms_slmgr_output(en-us,technet.10).png)

Ниже приведены наиболее важные поля для устранения неполадок. Искомые сведения могут быть разными в зависимости от устраняемой проблемы.

- **Сведения о версии**. В верхней части файла выходных данных **slmgr.vbs/dlv** указана версия службы лицензий на программное обеспечение. Она может быть полезна для того, чтобы узнать, установлена ли актуальная версия службы. Например, обновления для службы KMS в Windows Server 2003 поддерживают разные ключи узла KMS. Эти данные можно использовать, чтобы оценить, является ли версия актуальной и поддерживает ли она ключ узла KMS, который вы пытаетесь установить. Дополнительные сведения об этих обновлениях см. в разделе [Обновление для Windows Vista и Windows Server 2008 для KMS-активации расширения поддержки для Windows 7 и Windows Server 2008 R2](https://support.microsoft.com/help/968912/an-update-is-available-for-windows-vista-and-for-windows-server-2008-t).
- **Имя**. Указывает выпуск Windows, установленный в системе узла KMS. Это может быть важно для устранения проблем с добавлением или изменением ключа узла KMS (например, чтобы убедиться, что этот ключ поддерживается в текущем выпуске ОС).
- **Описание**. Здесь отображается установленный ключ. Используйте это поле, чтобы проверить, какой ключ использован для активации службы и подходит ли он для развернутых клиентов KMS.
- **License Status** (Состояние лицензии). Это состояние системы узла KMS. Значение должно быть **Лицензировано**. Любое другое значение означает, что произошла ошибка и может потребоваться повторная активация узла.
- **Current Count** (Текущее количество). Отображаемое число будет находиться в диапазоне от **0** до **50**. Счетчик является накопительным для нескольких операционных систем. Он указывает количество допустимых систем, которые выполняли попытки активации в течение 30-дневного периода.

  Если число равно **0**, то либо служба была активирована только недавно, либо нет допустимых клиентов, подключенных к узлу KMS.

  Значение счетчика не будет превышать **50**, независимо от того, сколько допустимых систем имеется в среде. Это обусловлено тем, что задано кэширование только удвоенного максимального числа клиентов согласно политике максимального числа лицензий, возвращаемой клиентом KMS. Политика максимального числа лицензий на сегодняшний день задается клиентской ОС Windows, и для активации узла KMS требуется не менее **25** клиентов. Таким образом, максимальное число клиентов на узле KMS составляет 2x25, то есть 50. Обратите внимание на то, что в средах, содержащих только клиенты KMS для Windows Server, максимальное число клиентов на узле KMS составит **10**. Это обусловлено тем, что порог для выпусков Windows Server равен **5** (а 2x5 равно 10).

  Распространенная проблема, связанная с числом клиентов: в среде имеются активированный узел KMS и достаточное количество клиентов, но число клиентов не превышает единицу. Основная проблема заключается в том, что развернутый образ клиента настроен неправильно (**sysprep /generalize**) и в системах нет уникальных идентификаторов клиентского компьютера (CMID). Дополнительные сведения см. в разделах [Клиент KMS](#kms-client) и [Текущее количество KMS не увеличивается при добавлении новой Windows Vista или Windows 7 на клиентских компьютерах в сети](https://support.microsoft.com/help/929829/the-kms-current-count-does-not-increase-when-you-add-new-windows-vista). Один из наших инженеров по эскалации технических проблем также описал эту проблему в блоге: [KMS Host Client Count not Increasing Due to Duplicate CMID’S](/archive/blogs/askcore/kms-host-client-count-not-increasing-due-to-duplicate-cmids) (Число клиентов KMS не увеличивается из-за одинаковых CMID).

  Еще одна причина, по которой число может не увеличиться, заключается в том, что в среде слишком много узлов KMS, и количество клиентов распределено по всем ним.
- **Listening on Port** (Ожидание передачи данных через порт). Для обмена данными с KMS используется анонимный RPC. По умолчанию клиенты используют TCP-порт 1688 для подключения к узлу KMS. Убедитесь, что этот порт открыт между клиентами KMS и узлом KMS. Вы можете изменить или настроить порт на узле KMS. Во время обмена данными узел KMS отправляет значение порта клиентам KMS. Если вы измените порт на клиенте KMS, то при подключении клиента к узлу значение порта будет перезаписано.

Нас часто спрашивают о разделе "Cumulative requests" (Совокупные запросы) в выходных данных **slmgr.vbs /dlv**. Обычно эти данные не помогают в устранении неполадок. Узел KMS хранит текущую запись состояния каждого клиента KMS, который пытается выполнить активацию или повторную активацию. Неудачные запросы указывают на клиенты KMS, которые не поддерживаются узлом KMS. Например, если клиент KMS для Windows 7 пытается выполнить активацию на узле KMS, который был активирован с помощью ключа KMS для Windows Vista, то активация завершится ошибкой. В строках "Requests with License Status" (Запросы с состоянием лицензии) описаны все возможные состояния лицензии: прошлые и текущее. С точки зрения устранения неполадок эти данные важны, только если это число не увеличивается должным образом. В этом случае должно расти число неудачных запросов. Это означает, что следует проверить ключ продукта, который был использован для активации системы узла KMS. Кроме того, обратите внимание на то, что значения совокупных запросов сбрасываются только при переустановке системы узла KMS.

### <a name="useful-kms-host-events"></a>Полезные события узла KMS

#### <a name="event-id-12290"></a>Идентификатор события 12290

Узел KMS регистрирует событие с идентификатором 12290, когда клиент KMS обращается к узлу для активации. Событие с идентификатором 12290 содержит значительный объем информации, которую можно использовать, чтобы выяснить, какого типа клиент обращался к узлу и почему произошла ошибка. Приведенный ниже сегмент записи события с идентификатором 12290 взят из журнала событий службы управления ключами узла KMS.

![Событие KMS 12290](./media/ee939272.kms_12290_event(en-us,technet.10).png)

Описание события содержит следующие сведения.

- **Минимальное число клиентов, необходимое для активации**. Клиент KMS сообщает, что для активации число клиентов на узле KMS должно быть равно **5**. Это означает, что это операционная система Windows Server, хотя и не указывается ее конкретный выпуск. Если клиенты не активируются, убедитесь, что на узле достаточное число клиентов.
- **Идентификатор клиентского компьютера (CMID)** . Это уникальное значение в каждой системе. Если это значение не является уникальным, значит, образ для дистрибутива был неправильно подготовлен (**sysprep /generalize**). Эта проблема проявляется на сервере службы KMS так: количество клиентов не увеличивается, даже если в среде их достаточно. Дополнительные сведения см. в разделе [Текущее количество KMS не увеличивается при добавлении новой Windows Vista или Windows 7 на клиентских компьютерах в сети](https://support.microsoft.com/help/929829/the-kms-current-count-does-not-increase-when-you-add-new-windows-vista).
- **Состояние лицензии и время до истечения срока состояния**. Это текущее состояние лицензии клиента. Оно поможет вам отличить клиента, который пытается выполнить активацию впервые, от клиента, который пытается выполнить повторную активацию. Запись времени показывает, сколько еще клиент останется в этом состоянии, если ничего не изменится.

Если при устранении неполадок с клиентом не удается обнаружить на узле KMS соответствующее событие с идентификатором 12290, то клиент не подключается к узлу KMS. Ниже приведены некоторые причины, по которым может отсутствовать запись события с идентификатором 12290.

- Произошел сбой сети.
- Узел не разрешается или не зарегистрирован в DNS.
- Брандмауэр блокирует TCP-порт 1688.
   Этот порт может быть заблокирован во многих местах в среде, в том числе в самой системе узла KMS. По умолчанию на узле KMS задано исключение брандмауэра для KMS, но оно не включается автоматически. Необходимо включить это исключение.
- Журнал аудита заполнен.

Клиенты KMS регистрируют два соответствующих события — с идентификаторами 12288 и 12289. Дополнительные сведения об этих событиях см. в разделе [Клиент KMS](#kms-client).

#### <a name="event-id-12293"></a>Идентификатор события 12293

Еще одно значимое событие, которое следует искать на узле KMS, — событие с идентификатором 12293. Это событие означает, что узел не опубликовал необходимые записи в DNS. Эта ситуация вызывает сбои, и ее наличие необходимо проверить *после* установки узла и *перед* развертыванием клиентов. Дополнительные сведения о проблемах с DNS см. в статье [Общие процедуры устранения неполадок с KMS и DNS](common-troubleshooting-procedures-kms-dns.md).

## <a name="kms-client"></a>Клиент KMS

На клиентах для устранения неполадок активации используются одни и те же инструменты (Slmgr и Просмотр событий).

### <a name="slmgrvbs-and-the-software-licensing-service"></a>Сценарий Slmgr.vbs и служба лицензий на программное обеспечение

Чтобы просмотреть подробные выходные данные службы лицензий на программное обеспечение, откройте окно командной строки с повышенными привилегиями и введите в нем **slmgr.vbs/dlv**. На следующем снимке экрана показаны результаты выполнения этой команды на одном из узлов KMS в корпорации Майкрософт.

![Выходные данные Slmgr для клиента KMS](./media/ee939272.kms_client_slmgr_output(en-us,technet.10).png)

Ниже приведен список наиболее важных полей для устранения неполадок. Искомые сведения могут быть разными в зависимости от устраняемой проблемы.

- **Имя**. Это значение указывает выпуск Windows, установленный в системе клиента KMS. Используйте его, чтобы убедиться, что версия Windows, которую вы пытаетесь активировать, может использовать KMS. Например, наша служба технической поддержки сталкивалась с инцидентами, в которых клиенты пытались установить ключ установки клиента KMS в выпуске Windows, не использующем активацию корпоративных лицензий, например Windows Vista Ultimate.
- **Описание**. Это значение — установленный ключ. VOLUME_KMSCLIENT указывает, что установлен ключ установки клиента KMS (или GVLK) (конфигурация по умолчанию для носителя для корпоративных лицензий) и что эта система автоматически пытается выполнить активацию с помощью узла KMS. Если вы видите что-то другое, например MAK, то вам потребуется переустановить GVLK, чтобы настроить эту систему в качестве клиента KMS. Можно вручную установить ключ с помощью команды **slmgr.vbs /ipk &lt;*GVLK*&gt;** (как описано в разделе [Ключи установки клиента KMS](kmsclientkeys.md)) или использовать средство управления активацией корпоративных лицензий (VAMT). Сведения о том, как получить и испольщзовать VAMT, приведены в [техническом справочнике по средству управления активацией корпоративных лицензий (VAMT)](/windows/deployment/volume-activation/volume-activation-management-tool).
- **Partial Product Key** (Частичный ключ продукта). Как и поле **Name** (Имя), эти сведения можно использовать, чтобы определить, установлен ли на компьютере правильный ключ установки клиента KMS (иными словами, что ключ соответствует операционной системе, установленной на клиенте KMS). По умолчанию правильный ключ содержится в системах, созданных с помощью носителя с портала центра поддержки корпоративных лицензий (VLSC). В некоторых случаях клиенты могут использовать активацию с помощью ключа многократной активации (MAK), пока в среде достаточное количество систем для поддержки активации KMS. На этих системах необходимо установить ключ установки клиента KMS, чтобы перевести их с использования MAK на использование KMS. Используйте VAMT для установки этого ключа и убедитесь, что применен правильный ключ.
- **License Status** (Состояние лицензии). Это значение показывает состояние системы клиента KMS. Для системы, которая была активирована с помощью KMS, это должно быть значение **Licensed** (Лицензировано). Любое другое значение может указывать на проблему. Например, если узел KMS работает правильно и клиент KMS не активируется (например, он остается в состоянии **Grace** (Льготный период)), возможно, клиент не может связаться с системой узла (например, из-за проблемы с брандмауэром, сбоя сети или чего-то подобного).
- **Идентификатор клиентского компьютера (CMID)** . Каждый клиент KMS должен иметь уникальный идентификатор CMID. Как упоминалось в разделе [Узел KMS](#kms-host), распространена следующая проблема с количеством клиентов: в среде имеются активированный узел KMS и достаточное количество клиентов, но число клиентов не превышает **1**. Дополнительные сведения см. в разделе [Текущее количество KMS не увеличивается при добавлении новой Windows Vista или Windows 7 на клиентских компьютерах в сети](https://support.microsoft.com/help/929829/the-kms-current-count-does-not-increase-when-you-add-new-windows-vista).
- **KMS Machine Name from DNS** (Имя компьютера KMS из DNS). Это значение содержит полное доменное имя узла KMS, которое клиент успешно использовал для активации, и TCP-порт, используемый для связи.
- **KMS Host Caching** (Кэширование узла KMS). Окончательное значение указывает, включено ли кэширование. По умолчанию оно включено. Это означает, что клиент KMS сохраняет в кэше имя узла KMS, которое использовалось для активации, и непосредственно взаимодействует с этим узлом (вместо запроса DNS), когда наступает время повторной активации. Если клиент не может связаться с кэшированным узлом KMS, он отправляет запрос в DNS для обнаружения нового узла KMS.

### <a name="useful-kms-client-events"></a>Полезные события клиента KMS

#### <a name="event-id-12288-and-event-id-12289"></a>Идентификаторы событий 12288 и 12289

После успешной активации или повторной активации клиента KMS он регистрирует два события — с идентификаторами 12288 и 12289. Приведенный ниже сегмент записи события с идентификатором 12288 взят из журнала событий службы управления ключами клиента KMS.

![Событие клиента KMS с идентификатором 12288](./media/ee939272.client_12288(en-us,technet.10).png)

Если отображается только событие с идентификатором 12288 (без соответствующего события с идентификатором 12289), это означает, что клиенту KMS не удалось подключиться к узлу KMS, узел KMS не ответил или клиент не получил ответ. В этом случае убедитесь, что узел KMS доступен для обнаружения и что клиенты KMS могут с ним связаться.

Наиболее важная информация в событии с идентификатором 12288 — это данные в разделе "Info" (Информация). Например, в этом разделе показано текущее состояние клиента, а также полное доменное имя и TCP-порт, использованные клиентом при попытке активации. Полное доменное имя можно использовать для устранения неполадок, из-за которых количество клиентов на узле KMS не увеличивается. Например, если клиентам доступно слишком много узлов KMS (как подлинных, так и мошеннических систем), то количество клиентов может распределяться по всем ним.

Неудачная активация не всегда означает, что для клиента имеется событие с идентификатором 12288, а события с идентификатором 12289 нет. При неудачной или повторной активации могут присутствовать оба эти события. В этом случае необходимо изучить второе событие, чтобы выяснить причину сбоя.

![Событие клиента KMS с идентификатором 12289](./media/ee939272.client_12289(en-us,technet.10).png)

В разделе "Info" (Информация) события с идентификатором 12289 содержатся следующие сведения.

- **Флаг активации**. Это значение указывает, успешно выполнена активация (**1**) или произошел сбой (**0**).
- **Текущее число клиентов на узле KMS**. Это значение отражает значение счетчика на узле KMS, когда клиент пытается выполнить активацию. Если активация завершается сбоем, это может быть вызвано недостаточным значением счетчика для данной клиентской операционной системы или недостаточным количеством систем в среде для значения счетчика.

## <a name="what-does-support-ask-for"></a>Что следует сообщить сотруднику службы поддержки?

При обращении в службу поддержки для устранения неполадок активации инженер службы поддержки обычно запрашивает следующие сведения.

- Выходные данные команды **Slmgr.vbs /dlv**, выполненной на узле KMS и клиентских системах KMS. Если вы используете Wscript или Cscript для выполнения команды, можно нажать клавиши CTRL+C, чтобы скопировать выходные данные, а затем вставить их в Блокнот, чтобы отправить их сотруднику службы поддержки.
- Журналы событий с узла KMS (журнал службы управления ключами) и из клиентских систем KMS (журнал приложений).

## <a name="additional-references"></a>Дополнительные ссылки
- [Ask the Core Team: #Activation](/archive/blogs/askcore/kms-host-client-count-not-increasing-due-to-duplicate-cmids) (Вопрос группе разработчиков основных компонентов: #Activation)
