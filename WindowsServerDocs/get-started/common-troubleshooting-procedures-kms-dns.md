---
title: Общие процедуры устранения неполадок с KMS и DNS
description: ''
ms.topic: article
ms.date: 07/22/2019
ms.technology: server-general
ms.assetid: ''
author: Teresa-Motiv
ms.author: v-tea
ms.localizationpriority: medium
ms.openlocfilehash: 12e3c1fa82a567c43507df2f2ffd72595c3903ba
ms.sourcegitcommit: af80963a1d16c0b836da31efd9c5caaaf6708133
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/30/2019
ms.locfileid: "68664896"
---
# <a name="common-troubleshooting-procedures-for-kms-and-dns-issues"></a>Общие процедуры устранения неполадок с KMS и DNS

Вы можете попробовать выполнить некоторые из этих инструкций, если выполняется одно или несколько из следующих условий.

- Для установки одной из следующих операционных систем используется корпоративный&nbsp;носитель и универсальный ключ многократной установки.
   - Windows Server 2019
   - Windows Server 2016
   - Windows Server 2012 R2
   - Windows Server 2012
   - Windows Server 2008 R2
   - Windows Server 2008
   - Windows 10
   - Windows 8.1
   - Windows 8
- Мастеру активации не удается подключиться к главному компьютеру KMS.

При попытке активировать клиентскую систему мастер активации использует DNS для размещения соответствующего компьютера, на котором работает программное обеспечение KMS. Если мастер запрашивает DNS и не находит запись DNS для главного компьютера узла KMS, он сообщает об ошибке.   

<a id="list"></a>Чтобы найти инструкции, соответствующие вашим условиям, просмотрите следующий список.

- Если вам не удается установить узел KMS или использовать активацию KMS, [попробуйте изменить ключ продукта на MAK](#change-the-product-key-to-an-mak).
- Если вам нужно установить и настроить узел KMS, [попробуйте настроить узел KMS для активации клиентов](#configure-a-kms-host-for-the-clients-to-activate-against).
- Если клиенту не удается определить существующий узел KMS, выполните следующие инструкции по устранению неполадок с конфигурациями маршрутизации. Процедуры перечислены по возрастанию сложности:
  - [проверьте основное IP-подключение к DNS-серверу](#verify-basic-ip-connectivity-to-the-dns-server);
  - [проверьте конфигурацию узла KMS](#verify-the-configuration-of-the-kms-host);  
  - [определите тип проблемы с маршрутизацией](#determine-the-type-of-routing-issue);
  - [проверьте конфигурацию DNS](#verify-the-dns-configuration);
  - [создайте запись SRV KMS вручную](#manually-create-a-kms-srv-record);
  - [вручную назначьте узел KMS клиенту KMS](#manually-assign-a-kms-host-to-a-kms-client);
  - [настройте узел KMS для публикации в нескольких доменах DNS](#configure-the-kms-host-to-publish-in-multiple-dns-domains).

## <a name="change-the-product-key-to-an-mak"></a>Изменение ключа продукта на MAK

Если по какой-то причине вам не удается установить узел KMS или использовать активацию KMS, попробуйте изменить ключ продукта на MAK. Если вы скачали образы Windows с сайта Microsoft Developer Network (MSDN) или TechNet, номера SKU, перечисленные под носителем, обычно связаны с корпоративными лицензиями на носители, а предоставленный ключ продукта является ключом MAK.

Чтобы изменить ключ продукта на MAK, сделайте следующее:

1. Откройте окно командной строки с повышенными правами. Для этого нажмите клавиши Windows+X, щелкните правой кнопкой мыши элемент **Командная строка** и выберите **Запуск от имени администратора**. При появлении запроса на ввод или подтверждение пароля администратора введите пароль или подтвердите его.
2. В командной строке выполните следующую команду:
   ```cmd
    slmgr -ipk xxxxx-xxxxx-xxxxx-xxxxx-xxxxx
   ```
   > [!NOTE]
   > Заполнитель **xxxxx-xxxxx-xxxxx-xxxxx-xxxxx** представляет ключ продукта MAK.  

[Вернитесь к списку инструкций](#list).

## <a name="configure-a-kms-host-for-the-clients-to-activate-against"></a>Настройка узла KMS для активации клиентов

Для активации клиентов KMS нужно настроить узел KMS. Если в вашей среде нет узлов KMS, установите и активируйте их с помощью соответствующего ключа узла KMS. Настроив компьютер в сети для размещения программного обеспечения KMS, опубликуйте параметры DNS.

Сведения о настройке узла KMS см. в инструкциях по [активации с помощью службы управления ключами](https://docs.microsoft.com/windows/deployment/volume-activation/activate-using-key-management-service-vamt) и [установке и настройке VMAT](https://docs.microsoft.com/windows/deployment/volume-activation/install-configure-vamt).

[Вернитесь к списку инструкций](#list).

## <a name="verify-basic-ip-connectivity-to-the-dns-server"></a>Проверка основного IP-подключения к DNS-серверу

Проверьте основное IP-подключение к DNS-серверу с помощью команды ping. Для этого выполните следующие действия как на клиенте KMS, на котором возникла ошибка, так и на узле KMS:

1. Откройте окно командной строки с повышенными правами.
1. В командной строке выполните следующую команду:
   ```cmd
   ping <DNS_Server_IP_address>
   ```
   > [!NOTE]
   > Если выходные данные этой команды не содержат фразу Reply from, это указывает на проблему с сетью или DNS, которую необходимо устранить, прежде чем можно будет переходить к другим инструкциям, описанным в этой статье. Узнайте больше об устранении неполадок TCP/IP при сбое проверки связи с DNS-сервером в [расширенном руководстве по устранению неполадок с TCP/IP](https://docs.microsoft.com/windows/client-management/troubleshoot-tcpip).

[Вернитесь к списку инструкций](#list).

## <a name="verify-the-configuration-of-the-kms-host"></a>Проверка конфигурации узла KMS

Проверьте реестр сервера узла службы KMS, чтобы определить, выполняется ли его регистрация в DNS. По умолчанию сервер узла службы KMS динамически регистрирует запись SRV DNS каждые 24 часа. 
> [!IMPORTANT]
> Внимательно выполните действия, описанные в этом разделе. Неправильное изменение реестра может привести к серьезным проблемам. Перед внесением изменений [создайте резервную копию реестра для его восстановления](https://support.microsoft.com/en-us/help/322756) в случае возникновения проблем.  

Для проверки сделайте следующее:
1. Откройте редактор реестра. Для этого щелкните правой кнопкой мыши **Пуск**, выберите **Выполнить**, введите **regedit** и нажмите клавишу ВВОД.
1. Найдите подраздел **HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\SL** и проверьте значение записи **DisableDnsPublishing**. Эта запись может иметь следующие значения:
   - **0** или не определено (по умолчанию). Сервер узла KMS регистрирует запись SRV каждые 24 часа.
   - **1**. Сервер узла KMS не регистрирует записи SRV автоматически. Если ваша реализация не поддерживает динамические обновления, см. руководство по [созданию записи SRV KMS вручную](#manually-create-a-kms-srv-record).  
1. Если запись **DisableDnsPublishing** отсутствует, создайте ее (тип — DWORD). Если динамическая регистрация допускается, оставьте неопределенное значение или укажите **0**.

[Вернитесь к списку инструкций](#list).

## <a name="determine-the-type-of-routing-issue"></a>Определение типа проблемы с маршрутизацией

Вы можете определить, связана ли проблема с разрешением имен или записью SRV, с помощью следующих команд.  

1. На клиенте KMS откройте окно командной строки с повышенными правами.  
1. В командной строке введите следующие команды:
   ```cmd
   cscript \windows\system32\slmgr.vbs -skms <KMS_FQDN>:<port>
   cscript \windows\system32\slmgr.vbs -ato
   ```
   > [!NOTE]
   > В этой команде <KMS_FQDN> представляет полное доменное имя (FQDN) главного компьютера KMS, а \<port\> представляет TCP-порт, используемый KMS.  

   Если эти команды помогли устранить проблему, значит проблема была в записи SRV. Вы можете устранить ее с помощью одной из команд, описанных в инструкциях по [назначению узла KMS клиенту KMS вручную](#manually-assign-a-kms-host-to-a-kms-client).  

1. Если проблема не устранена, выполните следующие команды:
   ```cmd
   cscript \windows\system32\slmgr.vbs -skms <IP Address>:<port>
   cscript \windows\system32\slmgr.vbs -ato
   ```
   > [!NOTE]
   > В этой команде \<IP Address\> представляет IP-адрес главного компьютера KMS, а \<port\> представляет TCP-порт, используемый KMS.  

   Если эти команды помогли устранить проблему, это указывает на возможную проблему с разрешением имен. Дополнительные сведения об устранении неполадок см. в инструкциях по [проверке конфигурации DNS](#verify-the-dns-configuration).

1. Если ни одна из этих команд не устраняет проблему, проверьте конфигурацию брандмауэра компьютера. Любой обмен данными для активации между клиентами KMS и узлом KMS, происходит с использованием TCP-порта 1688. Брандмауэры должны разрешать обмен данными через порт 1688 как на клиенте KMS, так и на узле KMS.

[Вернитесь к списку инструкций](#list).

## <a name="verify-the-dns-configuration"></a>Проверка конфигурации DNS

>[!NOTE]
> Если не указано иное, выполните следующие действия на клиенте KMS, где возникла соответствующая ошибка.

1. Откройте окно командной строки с повышенными правами.
1. В командной строке выполните следующую команду:
   ```cmd
   IPCONFIG /all
   ```
1. В результатах команды изучите следующие сведения:
   - назначенный IP-адрес клиентского компьютера KMS;
   - IP-адрес основного DNS-сервера, используемого клиентским компьютером KMS;
   - IP-адрес основного шлюза по умолчанию, используемого клиентским компьютером KMS;
   - список DNS-суффиксов, используемых клиентским компьютером KMS.
1. Убедитесь, что записи SRV узла KMS зарегистрированы в DNS. Для этого выполните следующие действия:  
   1. Откройте окно командной строки с повышенными правами.
   1. В командной строке выполните следующую команду:
      ```cmd
      nslookup -type=all _vlmcs._tcp>kms.txt
      ```
   1. Откройте файл KMS.txt, созданный командой. Этот файл должен содержать одну или несколько записей, которые выглядят примерно так:
       ```
       _vlmcs._tcp.contoso.com SRV service location:
       priority = 0
       weight = 0
       port = 1688 svr hostname = kms-server.contoso.com
       ```
       > [!NOTE]
       > В этой записи contoso.com представляет домен узла KMS.
      1. Проверьте IP-адрес, имя узла, порт и домен узла KMS.
      1. Если эти записи **_vlmcs** существуют и содержат ожидаемые имена узла KMS, перейдите к инструкциям по [назначению узла KMS клиенту KMS вручную](#manually-assign-a-kms-host-to-a-kms-client).  
      > [!NOTE]
      > Если команда [**nslookup**](https://docs.microsoft.com/windows-server/administration/windows-commands/nslookup) находит узел KMS, это не значит, что клиент DNS может найти узел KMS. Если команда **nslookup** находит узел KMS, но активация с помощью узла KMS по-прежнему не удается, проверьте другие параметры DNS, включая основной суффикс DNS и список суффиксов DNS.
1. Убедитесь, что список включает суффикс домена DNS, связанный с узлом KMS. В противном случае перейдите к инструкциям по [настройке узла KMS для публикации в нескольких доменах DNS](#configure-the-kms-host-to-publish-in-multiple-dns-domains).

[Вернитесь к списку инструкций](#list).

## <a name="manually-create-a-kms-srv-record"></a>Создание записи SRV KMS вручную

Чтобы вручную создать запись SRV для узла KMS, использующего DNS-сервер Майкрософт, сделайте следующее:

1. Откройте на DNS-сервере диспетчер DNS. Чтобы открыть диспетчер DNS, щелкните **Пуск**, **Администрирование** и **Служба DNS**.
1. Выберите DNS-сервер, на котором необходимо создать запись ресурса SRV.
1. В дереве консоли разверните узел **Зоны прямого просмотра**, щелкните правой кнопкой мыши домен и выберите **Другие новые записи**.
1. Прокрутите список вниз, выберите **Расположение службы (запись SRV)** и щелкните **Создать запись**.
1. Введите следующие сведения:
   - служба — **_VLMCS**;
   - протокол — **_TCP**;
   - номер порта — **1688**;
   - узел, на котором размещена служба — **&lt;*FQDN узла KMS*&gt;** .
1. По окончании щелкните **ОК** и **Готово**.

Чтобы вручную создать запись SRV для узла KMS, использующего совместимый с BIND 9.x DNS-сервер, следуйте инструкциям по настройке этого DNS-сервера и предоставьте следующие сведения для записи SRV:

- имя — &nbsp; **_vlmcs._TCP**;
- тип — &nbsp;**SRV**;
- Priority: **0**
- Weight: **0**
- Port: **1688**;
- имя узла — **&lt;*FQDN или преобразованное имя узла KMS*&gt;** .

> [!NOTE]
> KMS не использует значения **приоритета** или **веса**. Но запись должна содержать их.

Чтобы включить для совместимого с BIND 9.x DNS-сервера поддержку автоматической публикации KMS, включите для него обновление записей ресурсов с узлов KMS. Например, добавьте следующую строку в определение зоны в файле Named.conf или Named.conf.local:

```cmd
allow-update { any; };
```
## <a name="manually-assign-a-kms-host-to-a-kms-client"></a>Назначение узла KMS клиенту KMS вручную

По умолчанию клиенты KMS используют процесс автоматического обнаружения. При этом клиент KMS запрашивает у DNS список серверов, которые опубликовали записи SRV _vlmcs в зоне членства клиента. DNS возвращает список узлов KMS в случайном порядке. Клиент выбирает узел KMS и пытается открыть на нем сеанс. Если попытка удается, клиент кэширует имя узла KMS и попытается использовать его для следующей попытки продления. В случае сбоя клиент случайным образом выбирает другой узел KMS. Мы настоятельно рекомендуем использовать процесс автоматического обнаружения.  

Но вы также можете назначить узел KMS определенному клиенту KMS. Для этого выполните следующие действия.

1. На клиенте KMS откройте окно командной строки с повышенными правами.
1. В зависимости от реализации выполните одно из следующих действий:
   - Чтобы назначить узел KMS с помощью FQDN, выполните следующую команду:
     ```cmd
     cscript \windows\system32\slmgr.vbs -skms <KMS_FQDN>:<port>
     ```
   - Чтобы назначить узел KMS с помощью IPv4, выполните следующую команду:
     ```cmd
     cscript \windows\system32\slmgr.vbs -skms <IPv4Address>:<port>
     ```
    - Чтобы назначить узел KMS с помощью IPv6, выполните следующую команду:
      ```cmd
      cscript \windows\system32\slmgr.vbs -skms <IPv6Address>:<port>
      ```
    - Чтобы назначить узел KMS с помощью NetBIOS, выполните следующую команду:
      ```cmd
      cscript \windows\system32\slmgr.vbs -skms <NETBIOSName>:<port>
      ```
   - Чтобы вернуться к автоматическому обнаружению на клиенте KMS, выполните следующую команду:
     ```cmd
     cscript \windows\system32\slmgr.vbs -ckms
     ```
     > [!NOTE]
     > В этих командах используются следующие заполнители:
     >- **<KMS_FQDN>**  — полное доменное имя (FQDN) главного компьютера KMS;
     >- **\<\>IPv4Address** — IP-адрес версии 4 главного компьютера KMS;
     >- **\<\>IPv6Address** — IP-адрес версии 6 главного компьютера KMS;
     >- **\<\>NETBIOSName** — имя NetBIOS главного компьютера KMS;
     >- **\<port\>**  — TCP-порт, используемый KMS.  

## <a name="configure-the-kms-host-to-publish-in-multiple-dns-domains"></a>Настройка узла KMS для публикации в нескольких доменах DNS

> [!IMPORTANT]
> Внимательно выполните действия, описанные в этом разделе. Неправильное изменение реестра может привести к серьезным проблемам. Перед внесением изменений [создайте резервную копию реестра для его восстановления](https://support.microsoft.com/help/322756) в случае возникновения проблем.

Как описано в инструкциях по [назначению узла KMS клиенту KMS вручную](#manually-assign-a-kms-host-to-a-kms-client), клиенты KMS обычно используют процесс автоматического обнаружения для обнаружения узлов KMS. Для этого необходимо, чтобы записи SRV _vlmcs были доступными в зоне DNS клиентского компьютера KMS. Зона DNS соответствует либо основному DNS-суффиксу компьютера, либо одному из следующих компонентов:
- для компьютеров, присоединенных к домену, — домену компьютера, назначенному системой DNS (например, DNS AD DS);
- для компьютеров, входящих в рабочую группу — домену компьютера, назначенному протоколом DHCP. Это доменное имя определяется параметром с кодом, имеющим значение 15, как определено в RFC 2132.

По умолчанию узел KMS регистрирует свои записи SRV в зоне DNS, которая соответствует домену главного компьютера KMS. Например, предположим, что узел KMS присоединяется к домену contoso.com. В этом сценарии узел KMS регистрирует свою запись SRV _vmlcs в зоне DNS contoso.com. Таким образом, запись идентифицирует службу как VLMCS._TCP.CONTOSO.COM.

Если узел и клиенты KMS используют разные зоны DNS, вам нужно включить для узла KMS автоматическую публикацию записей SRV в нескольких доменах DNS. Для этого выполните следующие действия:

1. На узле KMS откройте редактор реестра. 
1. Найдите и выберите подраздел **HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\SL**.
1. В разделе **Сведения** щелкните правой кнопкой мыши пустую область, а затем выберите **Создать** и **Мультистроковый параметр**.
1. В качестве имени новой записи введите **DnsDomainPublishList**.
1. Щелкните правой кнопкой мыши новую запись **DnsDomainPublishList** и выберите **Изменить**.
1. В диалоговом окне **Редактирование мультистроки** введите в отдельную строку каждый суффикс домена DNS, который KMS публикует, и щелкните **ОК**.
   > [!NOTE]
   > В Windows Server 2008 R2 формат для **DnsDomainPublishList** отличается. Сведения см. в техническом справочнике по активации корпоративных лицензий.
1. Используйте средство администрирования служб, чтобы перезапустить службу лицензирования программного обеспечения. Эта операция создает записи SRV.
1. Убедитесь, что клиент KMS может связаться с настроенным узлом KMS, используя стандартную процедуру. Убедитесь, что клиент KMS правильно определяет узел KMS как по имени, так и по IP-адресу. Если какая-либо из этих проверок завершится неудачей, изучите эту проблему с сопоставителем клиентов DNS.
1. Чтобы очистить все ранее кэшированные имена узлов KMS на клиенте KMS, откройте окно командной строки с повышенными правами на клиенте KMS и выполните следующую команду:
   ```cmd
   cscript C:\Windows\System32\slmgr.vbs -ckms
   ```
