---
title: Устранение неполадок клиентов ADBA
description: Пошаговое руководство по устранению неполадок при активации Windows.
ms.topic: troubleshooting
ms.date: 09/24/2019
ms.technology: server-general
author: Teresa-Motiv
ms.author: v-tea
manager: dcscontentpm
ms.localizationpriority: medium
ms.openlocfilehash: d56b2d002b0403971dc50fab639f77bddf1f8809
ms.sourcegitcommit: d5e27c1f2f168a71ae272bebf8f50e1b3ccbcca3
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/23/2020
ms.locfileid: "86959886"
---
# <a name="example-troubleshooting-active-directory-based-activation-adba-clients-that-do-not-activate"></a>Пример: Устранение неполадок клиентов активации на основе Active Directory (ADBA), которые не активируются

> [!NOTE]
> Эта статья была первоначально опубликована в блоге TechNet 26 марта 2018 года.

Всем привет. Меня зовут Майк Каммер, и я уже два года участвую в проекте Platforms PFE корпорации Майкрософт. Недавно я помог клиенту развернуть Windows Server 2016 в своей среде. Мы также использовали эту возможность, чтобы перенести их методику активации с сервера KMS на [активацию на основе Active Directory](/previous-versions/windows/hh852637(v=win.10)).

Следуя правильной процедуре внесения любых изменений, мы начали миграцию в тестовой среде клиента. Мы начали развертывание, следуя инструкциям, приведенным в этой отличной записи блога Чарити Шелборн: [Active Directory-Based Activation vs. Key Management Services](https://techcommunity.microsoft.com/t5/Core-Infrastructure-and-Security/Active-Directory-Based-Activation-vs-Key-Management-Services/ba-p/256016) (Активация на основе Active Directory и службы управления ключами). Контроллеры домена в нашей тестовой среде работали под управлением Windows Server 2012 R2, поэтому нам не нужно было подготавливать лес. Мы установили роль на контроллере домена Windows Server 2012 R2 и выбрали активацию на основе Active Directory в качестве метода активации корпоративных лицензий. Мы установили ключ KMS и присвоили ему имя "KMS AD Activation ( ** LAB)". Мы довольно точно следовали инструкциям в записи блога.

Сначала мы создали четыре виртуальных машины: две под управлением Windows 2016 Standard и две под управлением Windows 2016 Datacenter. На этом этапе все шло замечательно и все было довольны. Мы создали физический сервер под управлением Windows 2016 Standard, и он правильно активировался. Тут и сказочке конец.

Ха-ха! Шучу! Все было не так просто. На самом деле установка и настройка были очень простыми, так что эта часть была простой и понятной. Я вернулся в офисе в понедельник, и оказалось, что все виртуальные машины, которые я создал неделей раньше, не активированы. Эй! Это же не правильно. Я вернулся к физическому компьютеру, и он был в порядке. Я отправился к клиенту, чтобы обсудить, что произошло. Конечно, первым вопросом был: "Что изменилось за выходные?" И, как обычно, в ответ я услышал: "Ничего". На этот раз действительно ничего не изменилось, и нам пришлось выяснить, что же происходило.

Я подошел к одному из проблемных серверов, открыл командную строку и проверил выходные данные команды **slmgr /ao-list**. Параметр **/ao-list** отображает все объекты активации в Active Directory.

![Изображение команды slmgr](./media/032618_1700_Troubleshoo1.png)

![Изображение результатов выполнения команды slmgr](./media/032618_1700_Troubleshoo2.png)

Результаты показывают, что имеются два объекта активации: один для Windows Server 2012 R2 и один для недавно созданного ключа KMS AD Activation ( ** LAB), который является лицензией на Windows Server 2016. Это подтверждает, что конфигурация Active Directory правильно настроена для активации клиентов KMS для Windows.

Зная, что команда **slmgr** — мой надежный помощник для активации лицензий, я продолжил использовать ее с разными параметрами. Я пробовал параметр **/dlv**, который отображает подробные сведения о лицензиях. Все выглядело хорошо. Я использовал версию Windows Server 2016 Standard и были указаны идентификатор активации, идентификатор установки, URL-адрес проверки и даже частичный ключ продукта.

![Изображение результатов выполнения команды slmgr /dlv](./media/ActivationTroubleshoot2b.jpg)

Кто-нибудь заметил, что я пропустил на этом этапе? Мы вернемся к этому, когда я расскажу о других своих действиях по устранению неполадок, но достаточно сказать, что ответ находится на этом снимке экрана.

Теперь я думал, что по какой-то причине ключ поврежден, поэтому я использовал параметр **/upk**, который удаляет текущий ключ. Хотя ключ действительно удаляется, это далеко не лучший способ. Перезагрузка сервера перед получением нового ключа может оставить сервер в неработоспособном состоянии. Я обнаружил, что параметр **/ipk** (что я сделаю позже при устранении неполадок) перезаписывает существующий ключ и является намного более безопасным путем. Учитесь на моих промахах!

![Изображение команды slmgr /upk и ее результата](./media/032618_1700_Troubleshoo3.png)

Я выполнил команду с параметром **/dlv**, чтобы просмотреть подробные сведения о лицензиях. К сожалению, ничего полезного я не узнал, а просто увидел ошибку "ключ продукта не найден". Ну конечно, ключа нет, ведь я только что удалил его!

![Изображение команды slmgr /dlv и ее результата](./media/032618_1700_Troubleshoo4.png)

Я понял, что вероятность успеха невелика, но пытался использовать параметр **/ato**, который должен активировать Windows на известных серверах KMS (или Active Directory, что тоже возможно). И опять ошибка "продукт не найден".

![Изображение команды slmgr /ato и ее результата](./media/032618_1700_Troubleshoo5.png)

Моей следующей мыслью было, что иногда помогает остановка и запуск службы, поэтому я испробовал это. Мне нужно было остановить и запустить службу платформы защиты программного обеспечения Майкрософт (службу SPPSvc). В командной строке с правами администратора я использовал проверенные команды **net stop** и **net start**. Сначала я было решил, что служба не работает и проблема именно в этом.

![Изображение результатов выполнения команд net stop и net start](./media/032618_1700_Troubleshoo6.png)

Но нет. После запуска службы и попытки повторной активации Windows я по-прежнему получал сообщение об ошибке "продукт не найден".

Затем я просмотрел журнал событий приложений на одном из проблемных серверов. Я обнаружил ошибку, связанную с активацией лицензии, событие с идентификатором 8198 и кодом 0x8007007B.

![Изображение сведений о событии с идентификатором 8198](./media/032618_1700_Troubleshoo7.png)

При поиске этого кода я нашел статью, в которой написано, что мой код ошибки указывает на неправильный синтаксис имени файла, имени каталога или метки тома. Почитав методы, описанные в статье, я понял, что они не очень подходят для моего случая. Когда я выполнил команду **nslookup -type=all _vlmcs._tcp**, я нашел имеющийся сервер KMS (в среде все еще было много компьютеров под управлением Windows 7 и Windows Server 2008, поэтому он был необходим), а также пять контроллеров домена. Это означает, что неполадка не связана с DNS, и проблемы возникли где-то еще.

![Изображение результатов выполнения команды nslookup](./media/032618_1700_Troubleshoo8.png)

Итак, я знал, что DNS в порядке. Служба Active Directory правильно настроена в качестве источника активации с помощью KMS. Мой физический сервер активирован правильно. Возможно, проблема связана только с виртуальными машинами? Интересное примечание: в тот момент мой клиент говорит мне, что кто-то в другом отделе также решил создать более десятка виртуальных машин Windows Server 2016. Итак, я полагаю, что теперь у меня есть еще десяток серверов, которые не активируются. Но нет! Эти серверы активировались без проблем.

Что же, я снова взялся за команду **slmgr**, чтобы узнать, как активировать этих монстров. На этот раз я собирался использовать параметр **/ipk**, который позволит установить ключ продукта. Я перешел на [этот сайт](/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/jj612867(v=ws.11)), чтобы получить соответствующие ключи для версии Windows Server 2016 Standard. Некоторые из моих серверов работают под управлением версии Datacenter, но мне нужно было сначала исправить этот сервер.

![Изображение списка ключей установки клиента KMS](./media/032618_1700_Troubleshoo9.png)

Я использовал параметр **/ipk** для установки ключа продукта, выбрав ключ Windows Server 2016 Standard.

![Изображение команды slmgr /ipk и ее результатов](./media/032618_1700_Troubleshoo10.png)

Здесь я записал только результаты для версии Datacenter, но они такие же. Для принудительной активации я использовал параметр **/ato**. Мы получаем чудесное сообщение о том, что продукт был успешно активирован!

![Изображение команды slmgr /ato и ее результата](./media/032618_1700_Troubleshoo11.png)

Еще раз воспользовавшись параметром **/dlv**, можно было увидеть, что мы выполнили активацию с помощью Active Directory.

![Изображение команды slmgr /dlv и ее результата](./media/032618_1700_Troubleshoo12.png)

Итак, что же пошло не так? Почему мне пришлось удалить установленный ключ и добавить эти универсальные ключи, чтобы обеспечить правильную активацию этих компьютеров? Почему десяток (или около того) других компьютеров был активирован без каких-либо проблем? Как я уже говорил, я пропустил кое-что важное на начальных этапах изучения проблемы. Я был в сильном недоумении, поэтому обратился к Чарити из первоначальной записи блога, чтобы узнать, сможет ли она помочь. Она сразу же обнаружила проблему и помогла мне понять, что я упустил с самого начала.

Ключ был в описании в выходных данных команды с параметром **/dlv**. Описание содержало следующее: Windows® Operating System, RETAIL Channel. Я видел это и решил, что канал RETAIL означал, что лицензия была приобретена и имела допустимый ключ.

![Изображение результатов выполнения команды slmgr /dlv с выделенными сведениями о канале](./media/032618_1700_Troubleshoo13.png)

Если взглянуть на выходные данные команды с параметром **/dlv**, выполненной на правильно активированном сервере, можно заметить, что в описании уже указан канал VOLUME_KMSCLIENT. Это дает нам понять, что это действительно корпоративная лицензия.

![Изображение результатов выполнения команды slmgr /dlv с выделенными сведениями о канале](./media/032618_1700_Troubleshoo14.png)

Что же означает канал RETAIL? Это означает, что носителем, использованным для установки операционной системы, был ISO-файл с сайта MSDN. Я вернулся к клиенту и спросил, существует ли вероятность того, что в сети есть второй ISO-файл Windows Server 2016. Оказалось, что да, в сети есть другой ISO-файл, который использовался для создания десятка других компьютеров. Они сравнили эти два ISO-файла — и, разумеется, образ, который мне предоставили для создания виртуальных серверов, оказался ISO-файлом MSDN. Они удалили этот ISO-файл MSDN из сети, и теперь все наши серверы были активированы и можно было не беспокоиться о сбое активации в будущих сборках.

Надеюсь, эта история была полезна и вы можете сэкономить немного своего времени.

Майк
