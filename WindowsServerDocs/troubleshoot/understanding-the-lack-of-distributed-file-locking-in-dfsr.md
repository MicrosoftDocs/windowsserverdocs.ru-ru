---
title: Основные сведения об отсутствии механизма блокировки файлов, распределенных по серверам, в DFSR
description: В этой статье рассматривается отсутствие механизма блокирования распределенных файлов с несколькими узлами в Windows, а именно в папках, реплицируемых с помощью DFSR.
ms.date: 06/10/2020
author: Deland-Han
ms.author: delhan
ms.topic: troubleshooting
ms.openlocfilehash: 9def2be46000671c5ca725683437afaae8a8a366
ms.sourcegitcommit: d1815253b47e776fb96a3e91556fd231bef8ee6d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/29/2021
ms.locfileid: "99042540"
---
# <a name="understanding-the-lack-of-distributed-file-locking-in-dfsr"></a>Основные сведения об отсутствии механизма блокировки файлов, распределенных по серверам, в DFSR

В этой статье рассматривается отсутствие механизма блокирования распределенных файлов с несколькими узлами в Windows, а именно в папках, реплицируемых с помощью DFSR.

## <a name="some-background"></a>Некоторый фон

  - Распределенная блокировка файлов — это понятие наличия нескольких копий файла на нескольких компьютерах и открытие одного файла для записи. все остальные копии блокируются. Это предотвращает изменение файла на нескольких серверах одновременно несколькими пользователями.
  - Репликация распределенная файловая система. [Служба DFSR](/previous-versions/windows/desktop/dfsr/distributed-file-system-replication--dfsr-) работает с несколькими главными структурами, основанными на состоянии. При репликации на основе состояния каждый сервер в составе системы с несколькими хозяевами применяет обновления к своей реплике по мере поступления, без обмена файлами журналов (вместо этого для поддержания сведений о актуальности используются векторы версий). После первоначальной синхронизации никто не будет использовать ни один сервер, поэтому он является высокодоступным и очень гибким в различных сетевых топологиях.
  - [SMB](/openspecs/windows_protocols/ms-smb/f210069c-7086-4dc2-885e-861d837df688) — это общий протокол, используемый в Windows для доступа к файлам по сети. В упрощенных терминах это протокол клиент-сервер, который использует перенаправитель для того, чтобы удаленные файловые системы могли выглядеть локальными файловыми системами. Это не относится к Windows и довольно распространено — в известном некотором примере используется Samba, который позволяет Linux, Mac и другим операционным системам работать в качестве клиентов и серверов SMB, а также участвовать в сетях Windows.


Очень важно четко разлагаться на том, где DFSR и SMB Live находятся в среде реплицируемых данных. SMB позволяет пользователям обращаться к своим файлам и не имеет сведений о службе DFSR. Аналогичным образом, служба DFSR (использующая протокол RPC) поддерживает синхронизацию файлов между серверами и не имеет сведений о протоколе SMB. Не путайте распределенную блокировку, как определено в этой записи и [уступающей блокировке](/windows/win32/fileio/opportunistic-locks).

Итак, вот там, где это можно сделать, — это Бритс.

Так как пользователи могут изменять данные на нескольких серверах, и, поскольку каждый Windows Server знает только о блокировании файла, *а* так как [DFSR не известно об этих блокировках на других серверах](/previous-versions/windows/it-pro/windows-server-2003/cc773238(v=ws.10)), пользователям может быть перезаписано изменение друг друга. В службе DFSR используется алгоритм конфликтов "побеждает в последнюю очередь", поэтому пользователь должен потерять и сохранить изменения в прошлом. Копия потерянного файла чуккед в папку *конфликтандделетед* .

Теперь это гораздо *менее* распространено, чем люди, например, подозревать. Обычно значения true Shared Files изменяются в локальной среде. в офисе филиала или в той же строке небольших помещений. Как правило, они работают людьми в одной команде, поэтому люди обычно знают, что сотрудники изменяют данные. И так как они обычно находятся на одном и том же сайте, вероятность того, что все пользователи, работающие с общим документом, будет использовать один и тот же сервер. Windows SMB обрабатывает ситуацию. Если пользователь заблокирован для изменения, а его коллега пытается изменить его, другой пользователь получит сообщение об ошибке следующего вида:

![Снимок экрана: диалоговое окно "используемый файл" с сообщением об ошибке, сообщающим о том, что это действие не может быть выполнено, так как файл открыт в другой программе.](./media/understanding-the-lack-of-distributed-file-locking-in-dfsr/1.jpg)

И если приложение, открывающее файл, действительно является очень разумным, как в Word 2007, оно может предоставить вам следующее:

![Снимок экрана: диалоговое окно "используемый файл" с тремя действиями, которые можно выполнить, если файл заблокирован другим пользователем.](./media/understanding-the-lack-of-distributed-file-locking-in-dfsr/2.jpg)

DFSR имеет механизм для заблокированных файлов, но только в собственном контексте сервера. DFSR не будет реплицировать файл, если его локальная копия имеет монопольную блокировку. Но это не мешает любому другому серверу изменять файл.

Вернемся к разделу, *но существует вопрос* о том, что общие данные изменены географически, и для некоторых людей они довольно прохладное. Иногда мы запросили, почему служба DFSR не обрабатывает эту блокировку и занимает все это с волновой волшебной палочкой. Оказывается, это интересный и сложный сценарий для решения для системы репликации с несколькими хозяевами. Рассмотрим их.

## <a name="third-party-solutions"></a>Сторонние решения

Существуют некоторые решения для поставщиков, которые принимают на себя эту проблему, которая обычно проходит через один или несколько следующих методов \* :

  - Использование механизма брокера

> Наличие центрального "трафика COP" позволяет одному серверу учитывать все остальные серверы и файлы, заблокированные пользователями. К сожалению, это также означает, что в распределенной системе блокировки часто встречается единственная точка отказа.

![Схема, демонстрирующая использование механизма брокера.](./media/understanding-the-lack-of-distributed-file-locking-in-dfsr/3.png)

  - Требование для полностью перенаправленной сети

> Поскольку центральный компонент Service Broker должен иметь возможность взаимодействовать со всеми серверами, участвующими в репликации файлов, это устраняет возможность обрабатывать сложные сетевые топологии. Топологии кольца и топологии с несколькими концентраторами и звезды обычно невозможны. В сети, не являющейся полностью маршрутизацией, некоторые серверы не могут напрямую связываться друг с другом или с участником-посредником и могут общаться только с партнером, который может взаимодействовать с другим сервером, и так далее. Это нормально в среде с несколькими хозяевами, но не с механизмом брокера.

![Схема, показывающая требование для полностью перенаправленной сети.](./media/understanding-the-lack-of-distributed-file-locking-in-dfsr/4.png)

  - Ограничено парой серверов

> Некоторые решения ограничивают топологию парой серверов, чтобы упростить их распределенный механизм блокировки. В более крупных средах это может быть нецелесообразно.

  - Использование агентов на клиентах и серверах
  - Не использовать репликацию с несколькими хозяевами
  - Не используйте кластеры MS
  - Использование специализированных устройств


***\** _ Обратите внимание, что я говорю, как правило\! Не следует относиться к угрозам смерти, так как у вас есть решение, которое не реализует один или несколько из этих методов \! _

## <a name="deeper-thoughts"></a>Более глубокие мысли

По мере того как вы думаете об этой неполадке, некоторые фундаментальные проблемы начинают обрезаться. Например, если у нас есть четыре сервера с данными, которые могут быть изменены пользователями на четырех сайтах, а подключение WAN к одному из них переходит в режим «вне сети», то что мы делаем? Пользователи по-прежнему могут получить доступ к своим отдельным серверам, но они должны быть разрешены? Мы не хотим, чтобы они выполняли конфликтующие изменения, но мы определенно хотим, чтобы они продолжали работать и совершать наши деньги. Если на этом этапе изменения будут блокироваться произвольно, пользователи не смогут работать даже несмотря на то, что на самом деле возникают конфликты\! Нет способа сообщить другим серверам, что файл используется, и вернуться в квадрат.

![Схема, показывающая результаты частичного сбоя сети.](./media/understanding-the-lack-of-distributed-file-locking-in-dfsr/5.png)

Затем есть сам SMB и обработка ошибок блокировок отчетов. В действительности мы не можем изменить, как SMB сообщает о нарушениях совместного доступа, так как мы разбивает массу приложений, и клиенты все равно не понимают новые расширенные сообщения об ошибках. Такие приложения, как Word 2007, проводят некоторую хитрость, чтобы выяснить, кто блокирует файлы, но подавляющее большинство приложений не знает, кто использует файл (или даже если он существует). Действительно.). Таким образом, когда пользователь получает сообщение "Этот файл используется", он не является особенно практичным – должны ли они вызывать службу поддержки? Имеет ли служба поддержки доступ ко всем файловым серверам, чтобы узнать, какие пользователи обращаются к файлам? Неудобных.

Поскольку для обеспечения высокой доступности требуется несколько хозяев, система брокера является менее предпочтительной. может потребоваться что-то, которое работает на всех серверах, что позволяет им обмениваться данными даже через неполностью маршрутизированные сети. Это потребует очень сложных приемов синхронизации. Это приведет к увеличению нагрузки на сеть (хотя, возможно, не слишком много), и необходимо будет очень быстро убедиться, что пользователь не удерживает его работы. Он должен аутрун саму репликацию файлов. на самом деле, может потребоваться привязать к репликации каким-то образом. Он также должен учитывать сбои сервера, связанные с сетью, а не сбои сервера.

![Схема, демонстрирующая блокировку и репликацию на пять серверов.](./media/understanding-the-lack-of-distributed-file-locking-in-dfsr/6.png)

Затем мы вернемся к Специальному клиентскому программному обеспечению для этого сценария, который лучше понимает блокировки и может предоставить пользователю некоторую полезную информацию ("Go Call Лилия in Accounting и сообщить ему, что он должен выпустить этот документ", "к сожалению, топология блокировки файлов будет нарушена, и администратор не сможет открыть этот файл до его исправления" и т. д. Этот способ хорошо воспроизводить миллионы приложений, работающих в Windows, определенно будет интереснее. Существует множество операционных систем, которые не поддерживаются или не получают программное обеспечение — Windows 2000 выходит за пределы основной поддержки и XP вскоре будет. Клиенты Linux и Mac не имели этого программного обеспечения до тех пор, пока они не были настолько важны, поэтому клиенту пришлось бы надеяться, что они посчитали что-то аналогичными.

## <a name="more-inforamtion"></a>Дополнительные сведения

Теперь самый простой способ управления этой ситуацией в DFSR заключается в использовании пространств имен DFS для указания пользователям на предсказуемые расположения с согласованным пространством имен. Правильно настроив топологию сайта ДФСН и соединения с сервером, вы принудительно придаете пользователям общий доступ к одному и тому же локальному серверу и разрешает им доступ только к удаленным компьютерам, когда их сервер "Main" не работает. Для большинства сред это работает довольно хорошо. В качестве альтернативы DFSR можно выбрать SharePoint из-за своей системы извлечения и возврата. BranchCache (в Windows Server 2008 R2 и Windows 7) может быть вариантом, так как он предназначен для ускорения чтения файлов в ветви ветвей, но в конце этого срока данные по-прежнему будут использоваться только на одном сервере — дополнительные сведения см. [здесь](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/jj127252(v=ws.11)). И опять же, эти поставщики имеют свои решения.

