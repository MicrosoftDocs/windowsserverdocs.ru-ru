---
title: Как определить минимальную промежуточную область, требуемую для реплицированной папки
description: В этой статье приведены краткие справочные сведения о том, как вычислить минимальную промежуточную область, необходимую для правильной работы DFSR.
ms.prod: windows-server
ms.technology: server-general
ms.date: 06/10/2020
author: Deland-Han
ms.author: delhan
ms.openlocfilehash: 5e5bfdbb90d2b3e631aaa020a173eca779f0d6b3
ms.sourcegitcommit: fa9a8badf4eb366aeeca7d2905e2cad711ee8dae
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/11/2020
ms.locfileid: "84715008"
---
# <a name="how-to-determine-the-minimum-staging-area-dfsr-needs-for-a-replicated-folder"></a>Как определить минимальную промежуточную область, требуемую для реплицированной папки

В этой статье приведены краткие справочные сведения о том, как вычислить минимальную промежуточную область, необходимую для правильной работы DFSR. Если значения меньше этих значений, репликация может замедлиться или вообще останавливаться. 

Помните, что это *лишь минимум*. При рассмотрении размера промежуточной области более крупнее область промежуточного хранения, вплоть до размера реплицированной папки. Дополнительные сведения о том, почему важно иметь область промежуточного хранения, см. в подразделе "как определить наличие проблемы с промежуточной областью" и записи блога, связанные в конце этой статьи.

> [!Note]
> Кроме того, у нас есть исправление, помогающее вычислить промежуточные размеры. [Обновление для интерфейса управления репликация DFS (DFSR) доступно](https://support.microsoft.com/kb/2607047)

## <a name="rules-of-thumb"></a>Правила бегунка

**Windows Server 2003 R2** — квота промежуточной области должна быть в размере 9 самых больших файлов в реплицированной папке.

**Windows Server 2008 и 2008 R2** — квота промежуточной области должна быть максимально большой, чем размер файлов в реплицированной папке (32).

Начальная репликация будет значительно больше использовать промежуточную область, чем однодневная репликация. При наличии свободного места на диске настоятельно рекомендуется задать промежуточную область, превышающую минимальную в ходе начальной репликации.

## <a name="where-do-i-get-powershell"></a>Где получить PowerShell?

PowerShell входит в Windows 2008 и более поздних версий. Необходимо установить PowerShell на Windows Server 2003. Вы можете скачать PowerShell для Windows 2003 [здесь](https://support.microsoft.com/kb/968930).

## <a name="how-do-you-find-these-x-largest-files"></a>Как найти эти X самых крупных файлов?

Используйте сценарий PowerShell, чтобы найти 32 или 9 самых крупных файлов и определить количество гигабайтов, на которые они добавляются (благодаря нед Пайл для команд PowerShell). Я на самом деле представлю три сценария PowerShell. Каждый из них полезен самостоятельно; Однако наиболее полезным является число 3.

1. Выполните следующую команду:  
   ```Powershell
   Get-ChildItem c:\\temp -recurse | Sort-Object length -descending | select-object -first 32 | ft name,length -wrap –auto
   ```
   
   Эта команда возвращает имена файлов и размер файлов в байтах. Полезно, если вы хотите узнать, какие файлы 32 являются крупнейшими в реплицированной папке, чтобы вы могли «посетить» своих владельцев.

2. Выполните следующую команду:  
   ```Poswershell
   Get-ChildItem c:\\temp -recurse | Sort-Object length -descending | select-object -first 32 | measure-object -property length –sum
   ```
   Эта команда возвращает общее число байтов в 32 самых крупных файлов в папке, не указывая имена файлов.

3. Выполните следующую команду:  
   ```Poswershell
   $big32 = Get-ChildItem c:\\temp -recurse | Sort-Object length -descending | select-object -first 32 | measure-object -property length –sum
   
   $big32.sum /1gb
   ```
   Эта команда получает общее число байтов в 32 самых крупных файлов в папке и выполняет математические вычисления для преобразования байтов в гигабайты. Эта команда состоит из двух отдельных строк. Их можно вставить одновременно в командную оболочку PowerShell или выполнить обратно.

## <a name="manual-walkthrough"></a>Пошаговое руководство

Чтобы продемонстрировать процесс и, надеюсь, понять, что мы делаем, я собираюсь вручную пройти по каждой части.

Выполнение команды 1 возвратит результаты, аналогичные приведенным ниже. В этом примере для краткости используются только 16 файлов. Всегда используйте 32 для операционных систем Windows 2008 и более поздних версий и 9 для Windows 2003 R2

### <a name="example-data-returned-by-powershell"></a>Пример данных, возвращаемых PowerShell

<table>
<tbody>
<tr class="odd">
<td>name</td>
<td>Длина</td>
</tr>
<tr class="even">
<td><strong>File5.zip</strong></td>
<td>10286089216</td>
</tr>
<tr class="odd">
<td><strong>archive.zip</strong></td>
<td>6029853696</td>
</tr>
<tr class="even">
<td><strong>BACKUP.zip</strong></td>
<td>5751522304</td>
</tr>
<tr class="odd">
<td> <strong>file9.zip</strong></td>
<td>5472683008</td>
</tr>
<tr class="even">
<td><strong>MENTOS.zip</strong></td>
<td>5241586688</td>
</tr>
<tr class="odd">
<td><strong>File7.zip</strong></td>
<td>4321264640</td>
</tr>
<tr class="even">
<td><strong>file2.zip</strong></td>
<td>4176765952</td>
</tr>
<tr class="odd">
<td><strong>frd2.zip</strong></td>
<td>4176765952</td>
</tr>
<tr class="even">
<td><strong>BACKUP.zip</strong></td>
<td>4078994432</td>
</tr>
<tr class="odd">
<td><strong>File44.zip</strong></td>
<td>4058424320</td>
</tr>
<tr class="even">
<td><strong>file11.zip</strong></td>
<td>3858056192</td>
</tr>
<tr class="odd">
<td><strong>Backup2.zip</strong></td>
<td>3815138304</td>
</tr>
<tr class="even">
<td><strong>BACKUP3.zip</strong></td>
<td>3815138304</td>
</tr>
<tr class="odd">
<td><strong>Current.zip</strong></td>
<td>3576931328</td>
</tr>
<tr class="even">
<td><strong>Backup8.zip</strong></td>
<td>3307488256</td>
</tr>
<tr class="odd">
<td><strong>File999.zip</strong></td>
<td>3274982400</td>
</tr>
</tbody>
</table>

### <a name="how-to-use-this-data-to-determine-the-minimum-staging-area-size"></a>Как использовать эти данные для определения минимального размера промежуточной области:

  - Name = имя файла.
  - Длина = байт
  - Один гигабайт = 1073741824 байт

Сначала необходимо суммировать общее число байтов. Далее разделите итог на 1073741824. Я предлагаю использовать Excel или электронную таблицу для выполнения математических действий.

### <a name="example"></a>Пример

В примере выше общее число байтов = 75241684992. Чтобы получить минимальную квоту промежуточной области, необходимо разделить 75241684992 на 1073741824.

> 75241684992/1073741824 = 70,07 ГБ

На основе этих данных я настроил промежуточную область на 71 ГБ, если округлить до ближайшего целого числа.

### <a name="real-world-scenario"></a>Реальный сценарий:

Хотя пошаговое руководство является интересным, это, скорее всего, не самое лучшее в использовании время для самостоятельного выполнения математических операций. Чтобы автоматизировать процесс, используйте команду 3 из приведенных выше примеров. Результаты будут выглядеть следующим образом:

> [![Эскиз](https://msdnshared.blob.core.windows.net/media/TNBlogsFS/prod.evol.blogs.technet.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/00/58/02/metablogapi/8204.image_thumb_02CB3914.png "изображение")](https://msdnshared.blob.core.windows.net/media/TNBlogsFS/prod.evol.blogs.technet.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/00/58/02/metablogapi/0876.image_03A39EFE.png)

Используя пример команды 3 без каких-либо дополнительных усилий, за исключением округления до ближайшего целого числа, я могу определить, что требуется квота промежуточной области размером 6 ГБ для d: \\ документация.

## <a name="do-i-need-to-reboot-or-restart-the-service-for-the-changes-to-be-picked-up"></a>Требуется ли перезагрузка или перезапуск службы, чтобы изменения были отобраны?

Для вступления в силу изменений в квоте промежуточной области не требуется перезагрузка или перезапуск службы. Необходимо будет подождать, пока репликация AD и цикл опроса AD DFSR применят изменения.

## <a name="how-to-determine-if-you-have-a-staging-area-problem"></a>Как определить наличие проблемы с промежуточной областью

Вы обнаружите проблемы с промежуточной областью, отслеживая конкретные идентификаторы событий на серверах DFSR. Список событий — 4202, 4204, 4206, 4208 и 4212. Тексты этих событий перечислены ниже. Важно различать 4202 и 4204 и другие события. При нормальных условиях работы можно регистрировать большое количество событий 4202 и 4204. Сосчитайте о событиях 4202 и 4204 как аналога с пульсом, тогда как 4206, 4208 и 4212 подобны сундуканым сложностям. Ниже я объясню, как интерпретировать события 4202 и 4204 ниже.

### <a name="staging-area-events"></a>События промежуточной области

> Идентификатор события: **4202**  
> Серьезность: **предупреждение**
> 
> Служба репликация DFS обнаружила, что промежуточное пространство, используемое для реплицированной папки по локальному пути (путь), превышает верхний предел. Служба попытается удалить самые старые промежуточные файлы. Это может повлиять на производительность.
> 
> Идентификатор события: **4204**  
> Серьезность: **информационная**
> 
> Служба репликация DFS успешно удалила старые промежуточные файлы для реплицированной папки по локальному пути (путь). Промежуточное пространство теперь ниже верхнего предела.
> 
> Идентификатор события: **4206**  
> Серьезность: **предупреждение**
> 
> Службе репликация DFS не удалось очистить старые промежуточные файлы для реплицированной папки по локальному пути (путь). Возможно, службе не удастся реплицировать некоторые крупные файлы, и реплицированная папка может оказаться несинхронизированной. Служба автоматически попытается повторить очистку промежуточного пространства за (x) минут. Служба может запустить очистку раньше, если обнаружит, что некоторые промежуточные файлы были разблокированы.
> 
> Идентификатор события: **4208**  
> Серьезность: **предупреждение**
> 
> Служба репликация DFS обнаружила, что использование промежуточного пространства превышает квоту промежуточного хранения для реплицированной папки по локальному пути (путь). Возможно, службе не удастся реплицировать некоторые крупные файлы, и реплицированная папка может оказаться несинхронизированной. Служба будет пытаться автоматически очищать промежуточное пространство.
> 
> Идентификатор события: **4212**  
> Серьезность: **Ошибка**
> 
> Службе репликация DFS не удалось реплицировать реплицированную папку по локальному пути (путь), так как промежуточный путь является недопустимым или недоступен.

## <a name="what-is-the-difference-between-4202-and-4208"></a>В чем разница между 4202 и 4208?

События 4202 и 4208 имеют похожий текст; т. е. Служба DFSR обнаружила, что использование промежуточной области превышает верхний предел. Разница заключается в том, что 4208 регистрируется после выполнения очистки промежуточной области, а промежуточная квота по-прежнему превышена. 4202 является нормальным и ожидаемым событием, тогда как 4208 является ненормальным и требует вмешательства.

## <a name="how-many-4202-4204-events-are-too-many"></a>Сколько 4202 событий 4204 слишком много?

Один ответ на этот вопрос отсутствует. В отличие от событий 4206, 4208 или 4212, которые всегда являются неправильными и свидетельствуют о необходимости выполнения действий, события 4202 и 4204 происходят в нормальных условиях работы. Просмотр многих событий 4202 и 4204 *может* указывать на проблему. Необходимо учитывать следующее:

1.  Является ли реплицированная папка (RF) ведением журнала 4202, выполняющего начальную репликацию? Если да, то в журнале регистрируется событие 4202 и 4204. В ходе начальной репликации эти данные необходимо свести к максимально возможному объему, указав максимально возможную область промежуточного хранения.
2.  Простая проверка общего числа событий 4202 не является достаточной. Необходимо выяснить, сколько записано в журнал на каждый RF. Если регистрировать события 20 4202 в течение одного RF в течение 24-часового периода. Однако если у вас есть 20 реплицируемых папок и имеется одно событие для каждой папки, то это хорошо.
3.  Чтобы установить тенденции, необходимо изучить несколько дней данных.

Как правило, я юристом клиентов на то, чтобы на каждую реплицированную папку в день было не более 1 4202 событий в течение обычного рабочего состояния. "Обычная" означает, что начальная репликация не происходит. Я основан на этом:

1.  Время, затраченное на очистку промежуточной области, — время, потраченное на репликацию файлов. Репликация приостановлена во время очистки промежуточной области.
2.  Использование DFSR из полной промежуточной области для подключения к удаленному рабочему столу и между файлами, а также для репликации одних и тех же файлов другим участникам
3.  Чем больше 4202 и 4204 событий, тем выше вероятность того, что вы зарегистрируетесь в условии, где DFSR не удается очистить промежуточную область, или придется преждевременно очищать файлы из промежуточной области.
4.  4206, 4208 и 4212, в моем опыте всегда предшествует и следует большое число событий 4202 и 4204.

Хотя разрешение всего 1 4202 событий на каждую радиочастоту в день является консервативным, это значительно сокращает вероятность возникновения проблем с промежуточной областью и более эффективно использует ресурсы сервера DFSR в целях репликации файлов.


