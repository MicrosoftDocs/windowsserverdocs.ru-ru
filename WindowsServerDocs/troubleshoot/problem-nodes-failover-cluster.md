---
title: Проблема с удалением узла
description: В этой статье описываются проблемы, возникающие при удалении узлов из активного членства отказоустойчивого кластера.
ms.date: 05/28/2020
author: Deland-Han
ms.author: delhan
ms.topic: troubleshooting
ms.openlocfilehash: aaecdeca4ec875a86c795438ba0c121932b4123b
ms.sourcegitcommit: 40905b1f9d68f1b7d821e05cab2d35e9b425e38d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/06/2021
ms.locfileid: "97947220"
---
# <a name="having-a-problem-with-nodes-being-removed-from-active-failover-cluster-membership"></a>Возникла проблема с узлами, удаляемыми из активного членства отказоустойчивого кластера

В этой статье рассказывается, как устранить проблемы, при которых узлы удаляются из активного членства отказоустойчивого кластера случайным образом.

## <a name="symptoms"></a>Симптомы

При возникновении проблемы в журнале системных событий отображаются события, подобные зарегистрированным:

![Событие 1135](media/problem-nodes-failover-cluster/1135-1.png)

Это событие будет зарегистрировано на всех узлах в кластере, за исключением узла, который был удален. Причина этого события заключается в том, что один из узлов кластера пометил этот узел как недоступный. Затем он уведомляет все остальные узлы события. Когда узлы будут уведомлены, они не будут продолжать работу и будут прервать подключения пульса к узлу вниз.

## <a name="what-caused-the-node-to-be-marked-down"></a>Что привело к тому, что узел помечается вниз

Все узлы отказоустойчивого кластера Windows 2008 или 2008 R2 взаимодействуют друг с другом по сетям, которые настроены на разрешение сетевого подключения к кластеру в этой сети. Узлы будут отсылать пакеты пульса по этим сетям всем остальным узлам. Эти пакеты должны быть получены другими узлами, после чего ответ отправляется обратно. Каждый узел в кластере имеет собственные тактовые импульсы, которые он будет отслеживать, чтобы убедиться, что сеть работает, а другие узлы — нет. Приведенный ниже пример должен помочь уточнить это:

![Узлы](media/problem-nodes-failover-cluster/Node2.png)

Если какой-либо из этих пакетов не возвращается, то конкретный период пульса считается неудачным. Например, W2K8-R2-NODE2 отправляет запрос и получает ответ от W2K8-R2-NODE1 к пакету пульса, чтобы определить сеть и узел.  Если W2K8-R2-NODE1 отправляет запрос в W2K8-R2-NODE2 и W2K8-R2-NODE1 не получает ответ, он считается потерянным пульсом, а W2K8-R2-NODE1 отслеживает его.  Этот пропущенный ответ может иметь W2K8-R2-NODE1 отображать сеть до тех пор, пока не будет получен другой запрос пульса.

По умолчанию узлы кластера ограничены пятью сбоями за 5 секунд, прежде чем подключение будет отмечено как отключенное. Таким образом, если W2K8-R2-NODE1 не получает ответ пять раз за период времени, он считает, что конкретный маршрут к W2K8-R2-NODE2 будет отключен. Если другие маршруты по-прежнему считаются готовыми к работе, W2K8-R2-NODE2 будет оставаться активным участником.

Если все маршруты отмечены как отключенные для W2K8-R2-NODE2, они удаляются из активного членства отказоустойчивого кластера, а событие 1135, которое отображается в первом разделе, заносится в журнал. В W2K8-R2-NODE2 служба кластеров завершается, а затем перезапускается, что позволяет попытаться повторно присоединиться к кластеру.

Дополнительные сведения о том, как обрабатывались определенные маршруты с тремя или более узлами, см. в разделе ["секционированный" блог кластерных сетей](/archive/blogs/askcore/partitioned-cluster-networks) , написанный Джеффом Хьюз.

## <a name="now-that-we-know-how-the-heartbeat-process-works-what-are-some-of-the-known-causes-for-the-process-to-fail"></a>Теперь, когда мы узнали, как работает процесс пульса, Каковы некоторые из известных причин сбоя процесса

1. Фактические сбои сетевого оборудования. Если пакет теряет связь между узлами, произойдет сбой пульса. Это будет раскрываться при трассировке сети на обоих узлах.

2. Возможно, профиль для сетевых подключений передается из домена в общедоступный и обратно в домен. Во время перехода этих изменений сетевые операции ввода-вывода могут быть заблокированы. Можно проверить, есть ли в этом случае, просмотрев операционный журнал сетевого профиля. Этот журнал можно найти, открыв Просмотр событий и перейдя к: Applications and Services Логс\микрософт\виндовс\нетворкпрофиле\оператионал. Просмотрите события в этом журнале на узле, который был упомянут в событии с ИДЕНТИФИКАТОРом 1135, и проверьте, не изменился ли профиль в данный момент. Если да, ознакомьтесь с статьей в базе знаний [профиль сетевой папки меняется с "домен" на "общедоступный" в Windows 7 или в Windows Server 2008 R2](https://support.microsoft.com/help/2524478/the-network-location-profile-changes-from-domain-to-public-in-windows).

3. На серверах включен протокол IPv6, но для входящих и исходящих подключений в брандмауэре Windows отключены следующие два правила:

    - Основы сетей — объявление обнаружения соседей
    - Основы сетей — запрос поиска соседей

4. Кроме того, антивирусное программное обеспечение может конфликтовать с этим процессом. Если вы подозреваете это, протестируйте его путем отключения или удаления программного обеспечения. Сделайте это в свой собственный риск, так как на этом этапе вы не будете защищены от вирусов.

5. Причиной этого может быть задержка в сети. Пакеты могут не быть потеряны между узлами, но они могут не получить достаточно быстрых узлов до истечения времени ожидания.

6. IPv6 — это протокол по умолчанию, который будет использоваться отказоустойчивой кластеризацией для периодических сигналов. Собственно пульс — это Одноадресный сетевой пакет UDP, который взаимодействует через порт 3343. Если имеются коммутаторы, брандмауэры или маршрутизаторы, которые не настроены должным образом, чтобы разрешить этот трафик, можно столкнуться с такими проблемами.

7. Эта проблема также может быть вызвана обновлением политики безопасности IPsec. Конкретная ситуация заключается в том, что во время обновления групповой политики IPSec все сопоставления безопасности (SAs) IPsec размещаются в брандмауэре Windows в повышенной безопасности (WFAS). Хотя это происходит, все сетевые подключения блокируются. При повторном согласовании сопоставлений безопасности в случае возникновения задержек при выполнении проверки подлинности с Active Directory эти задержки (когда все сетевые подключения блокируются) также будут блокировать пульсы кластера от получения и вызвать мониторинг работоспособности кластера для обнаружения узлов в случае, если они не отвечают пороговому значению 5 секунд.

8. Устаревшие или устаревшие драйверы сетевой карты и/или встроенное по.  Иногда непростая Настройка сетевой карты или коммутатора также может привести к потере пульса.

9. В современных сетевых картах и виртуальных сетевых адаптерах может возникать потеря пакетов.  Это можно отслеживать, открыв системный монитор и добавив счетчик "Network интерфаце\паккетс Received".  Этот счетчик является кумулятивным и увеличивается только до перезагрузки сервера.  Отображение большого количества пакетов, отброшенных здесь, может быть подписано на то, что буферы приема на сетевой карте слишком низкие или что сервер работает медленно и не может обрабатывать входящий трафик.  Каждый изготовитель сетевой карты выбирает, следует ли предоставлять эти параметры в свойствах сетевой карты, поэтому необходимо обратиться к веб-сайту производителя, чтобы узнать, как увеличить эти значения, и использовать рекомендованные значения.  Если вы используете VMware, в следующем блоге вы узнаете об этом чуть подробнее, в том числе о том, как определить, является ли проблема проблемой, а также о том, как перейти к статье по VMWare на основе изменяемых параметров.

    [Узлы, удаляемые из состава отказоустойчивого кластера в VMWare ESX](/archive/blogs/askcore/nodes-being-removed-from-failover-cluster-membership-on-vmware-esx)

Это наиболее распространенные причины, по которым регистрируются эти события, но могут быть и другие причины. В этом блоге было предоставлено подробное представление о процессе, а также приводятся идеи, которые следует искать. Некоторые из этих значений приводят к их максимальным значениям, чтобы попытаться предотвратить эту проблему.

|Параметр|По умолчанию|Диапазон|
|---|---|---|
|**SameSubnetDelay**|1000 мс|250-2000 мс|
|**CrossSubnetDelay**|1000 мс|250-4000 мс|
|**SameSubnetThreshold**|5|3-10|
|**CrossSubnetThreshold**|5|3-10|
||||

Увеличение этих значений до максимального значения может привести к удалению события и узла, но просто маскирует проблему. Что-то не решает. Лучше всего найти основную причину сбоев пульса и получить исправление. Единственная реальная потребность в увеличении этих значений — в сценарии с несколькими сайтами, где узлы находятся в разных местах, и задержка сети не может быть преодолена.
