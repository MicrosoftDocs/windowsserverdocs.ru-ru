---
title: Управление трафиком на основе географического расположения на основных серверах с помощью политики DNS
description: Этот раздел является частью руководств по сценариям политики DNS для Windows Server 2016.
manager: brianlic
ms.prod: windows-server
ms.technology: networking-dns
ms.topic: article
ms.assetid: ef9828f8-c0ad-431d-ae52-e2065532e68f
ms.author: lizross
author: eross-msft
ms.openlocfilehash: 5c74ca9fe60374d1bc1396d95c2e34cc5cd1fdd6
ms.sourcegitcommit: da7b9bce1eba369bcd156639276f6899714e279f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/26/2020
ms.locfileid: "80317766"
---
# <a name="use-dns-policy-for-geo-location-based-traffic-management-with-primary-servers"></a>Управление трафиком на основе географического расположения на основных серверах с помощью политики DNS

>Область применения: Windows Server (Semi-Annual Channel), Windows Server 2016

С помощью этого раздела вы узнаете, как настроить политику DNS, чтобы разрешить основным DNS-серверам отвечать на запросы клиентов DNS на основе географического расположения клиента и ресурса, к которому клиент пытается подключиться, предоставляя клиенту IP-адрес. адрес ближайшего ресурса.  
  
>[!IMPORTANT]  
>В этом сценарии показано, как развернуть политику DNS для управления трафиком на основе географического расположения при использовании только основных DNS-серверов. Можно также выполнять управление трафиком на основе географического расположения при наличии основного и дополнительного DNS-серверов. При наличии первичного и вторичного развертывания сначала выполните действия, описанные в этом разделе, а затем выполните действия, описанные в разделе [Использование политики DNS для управления трафиком на основе географического расположения с первичными и вторичными развертываниями](primary-secondary-geo-location.md).

С помощью новых политик DNS можно создать политику DNS, которая позволяет DNS-серверу отвечать на запросы клиентов, запрашивающие IP-адрес сервера. Экземпляры веб-сервера могут находиться в разных центрах обработки данных в разных физических расположениях. DNS может оценить расположение клиента и веб-сервера, а затем ответить на запрос клиента, предоставив клиенту IP-адрес веб-сервера, который физически расположен ближе к клиенту.  

Для управления ответами DNS-сервера на запросы от DNS-клиентов можно использовать следующие параметры политики DNS. 

- **Подсеть клиента**. Имя предопределенной клиентской подсети. Используется для проверки подсети, из которой был отправлен запрос.
- **Транспортный протокол**. Транспортный протокол, используемый в запросе. Возможные значения: **UDP** и **TCP**.
- **Протокол Интернета**. Сетевой протокол, используемый в запросе. Возможные значения: **IPv4** и **IPv6**.
- **IP-адрес интерфейса сервера**. IP-адрес сетевого интерфейса DNS-сервера, получившего запрос DNS.
- **Полное доменное имя**. Полное доменное имя (FQDN) записи в запросе с возможностью использования подстановочной карты.
- **Тип запроса**. Тип запрашиваемой записи (A, SRV, TXT и т. д.).
- **Время суток**. Время суток, когда получен запрос. 
  
Для формулировки выражений политики можно сочетать следующие критерии с логическим оператором (и/или). При совпадении этих выражений ожидается, что политики выполняют одно из следующих действий.
 
- **Игнорировать**. DNS-сервер автоматически удаляет запрос.          
- **Запретить**. DNS-сервер отвечает на запрос с ответом на сбой.          
- **Разрешить**. DNS-сервер реагирует на ответ с управляемым трафиком.          
  
##  <a name="geo-location-based-traffic-management-example"></a><a name="bkmk_example"></a>Пример управления трафиком на основе географического расположения

Ниже приведен пример того, как можно использовать политику DNS для обеспечения перенаправления трафика на основе физического расположения клиента, выполняющего запрос DNS.   
  
В этом примере используются две вымышленные компании — облачные службы Contoso, которые предоставляют решения для веб-приложений и размещения в домене. и службы Woodgrove Food, которые предоставляют услуги по доставке пищи в нескольких городах по всему миру и имеют веб-сайт с именем woodgrove.com.  
  
Облачные службы Contoso имеют два центра обработки данных — один в США, а другой — в Европе. В Европейском центре обработки данных размещен Портал заказов на продукты для woodgrove.com.   
  
Чтобы клиенты woodgrove.com могли отвечать на запросы с веб-сайта, компания Woodgrove хочет, чтобы европейские клиенты направлялись в центр обработки данных США и американские клиенты, направляемые в центре обработки данных. Клиенты, расположенные в любом месте мира, могут направляться в любой из центров обработки данных.   
  
Этот сценарий показан на следующем рисунке.  
  
![Пример управления трафиком на основе географического расположения](../../media/DNS-Policy-Geo1/dns_policy_geo1.png)  
  
##  <a name="how-the-dns-name-resolution-process-works"></a><a name="bkmk_works"></a>Как работает процесс разрешения имен DNS  
  
Во время процесса разрешения имен пользователь пытается подключиться к www.woodgrove.com. В результате получается запрос на разрешение DNS-имени, который отправляется на DNS-сервер, настроенный в свойствах сетевого подключения на компьютере пользователя. Как правило, это DNS-сервер, предоставляемый локальным поставщиком услуг Интернета, который выступает в качестве сопоставителя кэширования, и называется ЛДНС.   
  
Если DNS-имя отсутствует в локальном кэше ЛДНС, сервер ЛДНС перенаправляет запрос на DNS-сервер, который является полномочным для woodgrove.com. Полномочный DNS-сервер отвечает запрошенной записи (www.woodgrove.com) на сервер ЛДНС, который, в свою очередь, кэширует запись локально перед отправкой на компьютер пользователя.  
  
Поскольку облачные службы Contoso используют политики DNS-сервера, полномочный DNS-сервер, на котором размещается contoso.com, настроен для возврата ответов, управляемых трафиком географического расположения. Это приводит к направлению европейских клиентов на Европейский центр обработки данных и направление клиентов в центр обработки данных США, как показано на рисунке.  
  
В этом случае полномочный DNS-сервер обычно видит запрос на разрешение имен, поступающий с сервера ЛДНС, и очень редко с компьютера пользователя. По этой причине исходный IP-адрес в запросе разрешения имен, как видно на полномочном DNS-сервере, является сервером ЛДНС, а не компьютером пользователя. Однако использование IP-адреса сервера ЛДНС при настройке ответов на запросы географического расположения обеспечивает адекватный расчет географического расположения пользователя, так как пользователь выполняет запрос к DNS-серверу своего местного поставщика услуг Интернета.  
  
>[!NOTE]  
>Политики DNS используют IP-адрес отправителя в пакете UDP/TCP, который содержит запрос DNS. Если запрос достигает сервера-источника через несколько прыжков или ЛДНС, политика учитывает только IP последнего сопоставителя, от которого DNS-сервер получает запрос.  
  
##  <a name="how-to-configure-dns-policy-for-geo-location-based-query-responses"></a><a name="bkmk_config"></a>Настройка политики DNS для ответов на запросы на основе географического расположения  
Чтобы настроить политику DNS для ответов на запросы на основе географического расположения, необходимо выполнить следующие действия.  
  
1. [Создание подсетей клиента DNS](#bkmk_subnets)  
2. [Создание областей зоны](#bkmk_scopes)  
3. [Добавление записей в области зоны](#bkmk_records)  
4. [Создание политик](#bkmk_policies)  
  
>[!NOTE]  
>Эти действия необходимо выполнить на DNS-сервере, который является полномочным для зоны, которую требуется настроить. Членство в **DnsAdmins**(или аналогичное) требуется для выполнения следующих процедур.  
  
В следующих разделах приведены подробные инструкции по настройке.  
  
>[!IMPORTANT]  
>В следующих разделах приведены примеры команд Windows PowerShell, которые содержат примеры значений для многих параметров. Перед выполнением этих команд обязательно замените примеры значений в этих командах значениями, подходящими для вашего развертывания.  
  
### <a name="create-the-dns-client-subnets"></a><a name="bkmk_subnets"></a>Создание подсетей клиента DNS  
  
Первым шагом является указание подсетей или пространства IP-адресов регионов, для которых необходимо перенаправить трафик. Например, если требуется перенаправить трафик для США и Европы, необходимо найти подсети или пространства IP-адресов этих регионов.  
  
Эти сведения можно получить из карт географических IP-адресов. На основе этих дистрибутивов геоip-адресов необходимо создать "подсети клиента DNS". Подсеть клиента DNS — это логическая группа подсетей IPv4 или IPv6, из которой отправляются запросы на DNS-сервер.  
  
Для создания подсетей клиента DNS можно использовать следующие команды Windows PowerShell.  
  
      
    Add-DnsServerClientSubnet -Name "USSubnet" -IPv4Subnet "192.0.0.0/24"  
      
    Add-DnsServerClientSubnet -Name "EuropeSubnet" -IPv4Subnet "141.1.0.0/24"  
      
  
Дополнительные сведения см. в разделе [Add-днссерверклиентсубнет](https://docs.microsoft.com/powershell/module/dnsserver/add-dnsserverclientsubnet?view=win10-ps).  
  
### <a name="create-zone-scopes"></a><a name="bkmk_scopes"></a>Создание областей зоны  
После настройки подсетей клиента необходимо секционировать зону, трафик которой необходимо перенаправить на две разные области зоны, по одной области для каждой настроенной подсети клиента DNS.   
  
Например, если вы хотите перенаправить трафик для DNS-имени www.woodgrove.com, необходимо создать две разные области зоны в зоне woodgrove.com, одну для США и одну для Европы.  
  
Область зоны — это уникальный экземпляр зоны. Зона DNS может иметь несколько областей зоны, при этом каждая область зоны содержит собственный набор записей DNS. Одна и та же запись может присутствовать в нескольких областях с разными IP-адресами или IP-адресами.  
  
>[!NOTE]  
>По умолчанию область зоны существует в зонах DNS. Эта область зоны имеет то же имя, что и зона, а устаревшие операции DNS работают в этой области.   
  
Для создания областей зоны можно использовать следующие команды Windows PowerShell.  
  
      
    Add-DnsServerZoneScope -ZoneName "woodgrove.com" -Name "USZoneScope"  
      
    Add-DnsServerZoneScope -ZoneName "woodgrove.com" -Name "EuropeZoneScope"  

Дополнительные сведения см. в разделе [Add-днссерверзонескопе](https://docs.microsoft.com/powershell/module/dnsserver/add-dnsserverzonescope?view=win10-ps).  
  
### <a name="add-records-to-the-zone-scopes"></a><a name="bkmk_records"></a>Добавление записей в области зоны  
Теперь необходимо добавить записи, представляющие узел веб-сервера, в две области зоны.   
  
Например, **усзонескопе** и **еуропезонескопе**. В Усзонескопе можно добавить запись www.woodgrove.com с IP-адресом 192.0.0.1, который находится в центре обработки данных США. в Еуропезонескопе можно добавить ту же запись (www.woodgrove.com) с IP-адресом 141.1.0.1 в Европейском центре обработки данных.   
  
Для добавления записей в области зоны можно использовать следующие команды Windows PowerShell.  
  
      
    Add-DnsServerResourceRecord -ZoneName "woodgrove.com" -A -Name "www" -IPv4Address "192.0.0.1" -ZoneScope "USZoneScope  
      
    Add-DnsServerResourceRecord -ZoneName "woodgrove.com" -A -Name "www" -IPv4Address "141.1.0.1" -ZoneScope "EuropeZoneScope"  
  
  
  
В этом примере необходимо также использовать следующие команды Windows PowerShell для добавления записей в область зоны по умолчанию, чтобы обеспечить доступ к веб-серверу woodgrove.com из любого из двух центров обработки данных.  
    
    Add-DnsServerResourceRecord -ZoneName "woodgrove.com" -A -Name "www" -IPv4Address "192.0.0.1"   
      
    Add-DnsServerResourceRecord -ZoneName "woodgrove.com" -A -Name "www" -IPv4Address "141.1.0.1"
      
 
Параметр **зонескопе** не включается при добавлении записи в область по умолчанию. Это то же самое, что и добавление записей в стандартную зону DNS.  
  
Дополнительные сведения см. в разделе [Add-днссерверресаурцерекорд](https://docs.microsoft.com/powershell/module/dnsserver/add-dnsserverresourcerecord?view=win10-ps).  
  
### <a name="create-the-policies"></a><a name="bkmk_policies"></a>Создание политик  
После создания подсетей, разделов (областей зоны) и добавления записей необходимо создать политики, соединяющие подсети и секции, чтобы при получении запроса из источника в одной из подсетей клиента DNS возвращался ответ запроса. правильная область действия зоны. Для сопоставления области зоны по умолчанию не требуются никакие политики.   
  
Для создания политики DNS, связывающей подсети клиента DNS и области зоны, можно использовать следующие команды Windows PowerShell.   
  
      
    Add-DnsServerQueryResolutionPolicy -Name "USPolicy" -Action ALLOW -ClientSubnet "eq,USSubnet" -ZoneScope "USZoneScope,1" -ZoneName "woodgrove.com"  
      
    Add-DnsServerQueryResolutionPolicy -Name "EuropePolicy" -Action ALLOW -ClientSubnet "eq,EuropeSubnet" -ZoneScope "EuropeZoneScope,1" -ZoneName "woodgrove.com"  
     
Дополнительные сведения см. в разделе [Add-днссерверкуериресолутионполици](https://docs.microsoft.com/powershell/module/dnsserver/add-dnsserverqueryresolutionpolicy?view=win10-ps).  
  
Теперь на DNS-сервере настроены необходимые политики DNS для перенаправления трафика на основе географического расположения.  
  
Когда DNS-сервер получает запросы на разрешение имен, DNS-сервер оценивает поля в DNS-запросе на соответствие настроенным политикам DNS. Если исходный IP-адрес в запросе разрешения имен соответствует любой из политик, область связанной зоны используется для ответа на запрос, а пользователь направляется к ресурсу, который является географически ближайшим к ним.   
  
Вы можете создавать тысячи политик DNS в соответствии с требованиями к управлению трафиком, а все новые политики применяются динамически, без перезапуска DNS-сервера во входящих запросах.  
  
  
