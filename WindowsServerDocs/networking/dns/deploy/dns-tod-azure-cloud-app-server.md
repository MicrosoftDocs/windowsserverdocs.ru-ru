---
title: Получение ответов DNS на основе времени дня с помощью сервера облачных приложений Azure
description: Этот раздел является частью руководств по сценариям политики DNS для Windows Server 2016.
manager: brianlic
ms.prod: windows-server
ms.technology: networking-dns
ms.topic: article
ms.assetid: 4846b548-8fbc-4a7f-af13-09e834acdec0
ms.author: pashort
author: shortpatti
ms.openlocfilehash: 4307ce1512980277af819e0710e0447d8dbac8c4
ms.sourcegitcommit: 6aff3d88ff22ea141a6ea6572a5ad8dd6321f199
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/27/2019
ms.locfileid: "71406197"
---
# <a name="dns-responses-based-on-time-of-day-with-an-azure-cloud-app-server"></a>Получение ответов DNS на основе времени дня с помощью сервера облачных приложений Azure

>Область применения: Windows Server (Semi-Annual Channel), Windows Server 2016

С помощью этого раздела вы узнаете, как распределять трафик приложений между различными географически распределенными экземплярами приложения с помощью политик DNS, основанных на времени суток. 

Этот сценарий полезен в ситуациях, когда требуется направить трафик в один часовой пояс на альтернативные серверы приложений, например веб-серверы, размещенные на Microsoft Azure, которые находятся в другом часовом поясе. Это позволяет распределять трафик между экземплярами приложения во время пиковых периодов, когда основные серверы перегружаются с трафиком. 

> [!NOTE]
> Сведения об использовании политики DNS для интеллектуальных ответов DNS без использования Azure см. в статье [Использование политики DNS для интеллектуальных ответов DNS в зависимости от времени суток](Scenario--Use-DNS-Policy-for-Intelligent-DNS-Responses-Based-on-the-Time-of-Day.md). 

## <a name="example-of-intelligent-dns-responses-based-on-the-time-of-day-with-azure-cloud-app-server"></a>Пример интеллектуальных ответов DNS на основе времени суток с сервером облачных приложений Azure

Ниже приведен пример того, как можно использовать политику DNS для балансировки трафика приложения в зависимости от времени суток.

В этом примере используется одна вымышленная компания, подарочные службы Contoso, которые предоставляют Интернет-решения для электронной коммерции по всему миру с помощью своего Web-узла, contosogiftservices.com. 

Веб-сайт contosogiftservices.com размещается только в одном локальном центре обработки данных в Сиэтле (с общедоступным IP-адресом 192.68.30.2). 

DNS-сервер также находится в локальном центре обработки данных. 

Благодаря недавнему всплеску в бизнесе contosogiftservices.com имеет большее количество посетителей каждый день, и некоторые клиенты сообщали о проблемах доступности служб. 

Службы подарков компании Contoso выполняют анализ сайта и обнаруживают, что каждый вечер в промежутке между 6 и 9 РМ по местному времени — это всплеск трафика на веб-сервер в Сиэтле. Веб-сервер не может масштабироваться для поддержки увеличенного трафика в часы пиковой нагрузки, что приводит к отказу в обслуживании для клиентов. 

Чтобы гарантировать, что contosogiftservices.com клиенты получают возможность реагирования с веб-сайта, службы подарков компании Contoso решили, что в течение этого времени будет выплата за \(виртуальной машины\) на Microsoft Azure для размещения копии своего веб-сервера.  

Подарочные службы Contoso получают общедоступный IP-адрес из Azure для виртуальной машины (192.68.31.44) и разрабатывают автоматизацию для развертывания веб-сервера каждый день в Azure между 5-10, что позволяет использовать один час в течение одного часа.

> [!NOTE]
> Дополнительные сведения о виртуальных машинах Azure см. в [документации по виртуальным машинам](https://azure.microsoft.com/documentation/services/virtual-machines/) . 

DNS-серверы настроены с областями зоны и политиками DNS таким образом, что каждые 5-9 PM каждый день отправляется 30% запросов на экземпляр веб-сервера, работающего в Azure.

Этот сценарий показан на следующем рисунке.

![Политика DNS для ответов времени суток](../../media/DNS-Policy-Tod2/dns_policy_tod2.jpg)  

## <a name="how-intelligent-dns-responses-based-on-time-of-day-with-azure-app-server-works"></a>Как интеллектуальные ответы DNS на основе времени суток с работой сервера приложений Azure
 
В этой статье показано, как настроить DNS-сервер для ответа на запросы DNS с двумя разными IP-адресами сервера приложений — один веб-сервер находится в Сиэтле, а другой — в центре обработки данных Azure.

После настройки новой политики DNS, основанной на пиковых часах от 6 до 9 PM в Сиэтле, DNS-сервер отправляет 70 за одно увеличение ответов DNS клиентам, содержащим IP-адрес в Сиэтле, и тридцать за каждое увеличение ответов DNS на топологи. NTS, содержащий IP-адрес веб сервера Azure, таким образом направляя трафик клиента на новый веб-сервер Azure и предотвращая перегрузку веб-сервера в Сиэтле. 

В любое другое время суток выполняется обычная обработка запросов, и ответы отправляются из области зоны по умолчанию, которая содержит запись для веб-сервера в локальном центре обработки данных. 

Срок жизни, равный 10 минутам в записи Azure, обеспечивает истечение срока действия записи из кэша ЛДНС перед удалением виртуальной машины из Azure. Одно из преимуществ такого масштабирования заключается в том, что вы можете размещать данные DNS в локальной среде и выполнять масштабирование в Azure по мере необходимости.

## <a name="how-to-configure-dns-policy-for-intelligent-dns-responses-based-on-time-of-day-with-azure-app-server"></a>Настройка политики DNS для интеллектуальных ответов DNS на основе времени суток с сервером приложений Azure

Чтобы настроить политику DNS для времени суток с балансировкой нагрузки приложений на основе запросов, необходимо выполнить следующие действия.

- [Создание областей зоны](#create-the-zone-scopes)
- [Добавление записей в области зоны](#add-records-to-the-zone-scopes)
- [Создание политик DNS](#create-the-dns-policies)

> [!NOTE]
> Эти действия необходимо выполнить на DNS-сервере, который является полномочным для зоны, которую требуется настроить. Членство в DnsAdmins (или аналогичное) требуется для выполнения следующих процедур. 

В следующих разделах приведены подробные инструкции по настройке.

> [!IMPORTANT]
> В следующих разделах приведены примеры команд Windows PowerShell, которые содержат примеры значений для многих параметров. Перед выполнением этих команд обязательно замените примеры значений в этих командах значениями, подходящими для вашего развертывания. 


### <a name="create-the-zone-scopes"></a>Создание областей зоны

Область зоны — это уникальный экземпляр зоны. Зона DNS может иметь несколько областей зоны, при этом каждая область зоны содержит собственный набор записей DNS. Одна и та же запись может присутствовать в нескольких областях с разными IP-адресами или IP-адресами. 

> [!NOTE]
> По умолчанию область зоны существует в зонах DNS. Эта область зоны имеет то же имя, что и зона, а устаревшие операции DNS работают в этой области. 

Приведенный ниже пример команды можно использовать для создания области зоны для размещения записей Azure.

```
Add-DnsServerZoneScope -ZoneName "contosogiftservices.com" -Name "AzureZoneScope"
```

Дополнительные сведения см. в разделе [Add-днссерверзонескопе](https://docs.microsoft.com/powershell/module/dnsserver/add-dnsserverzonescope?view=win10-ps) .

### <a name="add-records-to-the-zone-scopes"></a>Добавление записей в области зоны
Следующим шагом является добавление записей, представляющих узел веб-сервера, в области зоны. 

В Азурезонескопе запись www.contosogiftservices.com добавляется с IP-адресом 192.68.31.44, который находится в общедоступном облаке Azure. 

Аналогичным образом в области зоны по умолчанию \(contosogiftservices.com\)добавляется запись \(www.contosogiftservices.com\) с IP-адресом 192.68.30.2 веб-сервера, работающего в локальном центре обработки данных в Сиэтле.

Во втором приведенном ниже командлете параметр – Зонескопе не включается. По этой причине записи добавляются в Зонескопе по умолчанию. 

Кроме того, срок жизни записи для виртуальных машин Azure хранится в 600S (10 минут), чтобы ЛДНС не кэшировать его в течение более длительного времени, что может помешать балансировке нагрузки. Кроме того, виртуальные машины Azure доступны в течение 1 дополнительного часа в качестве случайного обстоятельства, чтобы даже клиенты с кэшированными записями могли разрешаться.

```
Add-DnsServerResourceRecord -ZoneName "contosogiftservices.com" -A -Name "www" -IPv4Address "192.68.31.44" -ZoneScope "AzureZoneScope" –TimeToLive 600

Add-DnsServerResourceRecord -ZoneName "contosogiftservices.com" -A -Name "www" -IPv4Address "192.68.30.2"
```

Дополнительные сведения см. в разделе [Add-днссерверресаурцерекорд](https://docs.microsoft.com/powershell/module/dnsserver/add-dnsserverresourcerecord?view=win10-ps).  

### <a name="create-the-dns-policies"></a>Создание политик DNS 
После создания областей зоны можно создать политики DNS, которые распределяют входящие запросы между этими областями, чтобы выполнить следующее.

1. С 6 до 9 по дням, 30% клиентов получают IP-адрес сервера в центре обработки данных Azure в ответе DNS, в то время как 70% клиентов получают IP-адрес локального веб-сервера в Сиэтле.
2. В то же время все клиенты получают IP-адрес локального сервера в Сиэтле.

Время суток должно быть выражено в местном времени DNS-сервера.

Для создания политики DNS можно использовать приведенный ниже пример команды.

```
Add-DnsServerQueryResolutionPolicy -Name "Contoso6To9Policy" -Action ALLOW -ZoneScope "contosogiftservices.com,7;AzureZoneScope,3" –TimeOfDay “EQ,18:00-21:00” -ZoneName "contosogiftservices.com" –ProcessingOrder 1
```

Дополнительные сведения см. в разделе [Add-днссерверкуериресолутионполици](https://docs.microsoft.com/powershell/module/dnsserver/add-dnsserverqueryresolutionpolicy?view=win10-ps).  
  
Теперь на DNS-сервере настроены необходимые политики DNS для перенаправления трафика на веб-сервер Azure на основе времени суток. 

Обратите внимание на выражение:

`
 -ZoneScope "contosogiftservices.com,7;AzureZoneScope,3" –TimeOfDay “EQ,18:00-21:00” 
`

Это выражение настраивает DNS-сервер с помощью комбинации Зонескопе и Weight, которая сообщает DNS-серверу о необходимости отправки IP-адреса в Сиэтле 70 за увеличение времени, при этом IP-адрес сервера Azure будет равен тридцати за раз в секунду.

Вы можете создавать тысячи политик DNS в соответствии с требованиями к управлению трафиком, а все новые политики применяются динамически, без перезапуска DNS-сервера во входящих запросах.
