---
title: Обзор DNS-сервера рассылки
description: В этом разделе приводится краткий обзор DNS-имен для рассылки
manager: laurawi
ms.prod: windows-server
ms.technology: networking-dns
ms.topic: article
ms.assetid: f9c313ac-bb86-4e48-b9b9-de5004393e06
ms.author: greglin
author: greg-lindsay
ms.openlocfilehash: f43c1978e193cbb2212966ab519b002d9fed45f5
ms.sourcegitcommit: ccd38245f1b766be005d0c257962f756ff0c4e76
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/19/2020
ms.locfileid: "92175802"
---
# <a name="anycast-dns-overview"></a>Обзор DNS-сервера рассылки

>Область применения: Windows Server (половина ежегодного канала), Windows Server 2016, Windows Server 2019

В этом разделе содержатся сведения о том, как работает DNS-процесс с некотором созданием

## <a name="what-is-anycast"></a>Что такое рассылки по номеру?

Произвольная копия — это технология, которая предоставляет несколько путей маршрутизации к группе конечных точек, каждому из которых назначен один и тот же IP-адрес. Каждое устройство в группе объявляет один и тот же адрес в сети, и для выбора наилучшего назначения используются протоколы маршрутизации.

По отдельности позволяет масштабировать службу без отслеживания состояния, например DNS или HTTP, размещая несколько узлов за одним IP-адресом и используя маршрутизацию с одинаковой ценой (ECMP) для прямого трафика между этими узлами. Рассылка по отдельности отличается от одноадресной рассылки, в котором каждая конечная точка имеет собственный отдельный IP-адрес. 

## <a name="why-use-anycast-with-dns"></a>Зачем использовать имя для рассылки с DNS?

С помощью DNS-сервера несозданной рассылки можно включить DNS-сервер или группу серверов для реагирования на запросы DNS на основе географического расположения DNS-клиента. Это может повысить время отклика DNS и упростить параметры DNS-клиента. Кроме того, служба DNS предоставляет дополнительный уровень избыточности и помогает защититься от атак типа "отказ в обслуживании" DNS. 

### <a name="how-anycast-dns-works"></a>Как работает служба DNS для многопроцессорной рассылки

Для отправки запросов DNS на предпочитаемый DNS-сервер или группу DNS-серверов (например, группы DNS-серверов, управляемых подсистемой балансировки нагрузки) служба DNS с нежелательной рассылкой работает с помощью протоколов маршрутизации, таких как протокол BGP (BGP). Это позволяет оптимизировать обмен данными по DNS, получая ответы DNS с DNS-сервера, ближайшего к клиенту.

С помощью рассылки по отдельности серверы, которые находятся в нескольких географических расположениях, каждый объявляет один идентичный IP-адрес их локальному шлюзу (маршрутизатору). Когда DNS-клиент инициирует запрос к адресу рассылки до первого получателя, оцениваются доступные маршруты, и запрос DNS отправляется в предпочтительное расположение. Как правило, это ближайшее расположение, основанное на топологии сети. См. следующий пример.

![DNS с произвольной адресацией](../../media/Anycast/anycast.png)

**Рис. 1**. четыре DNS-сервера, расположенные на разных сайтах в сети, каждый объявляет один и тот же IP-адрес рассылки (черные стрелки) сети. Клиентское устройство DNS отправляет запрос на IP-адрес незаполненной рассылки. Сетевые устройства анализируют доступные маршруты и отправляют клиентский запрос DNS в ближайшее расположение (синяя стрелка). 

Чаще всего DNS используется для маршрутизации трафика DNS для многих глобальных служб DNS. Например, система корневого DNS-сервера в значительной степени зависит от пересылок по DNS. Кроме того, по отдельности работает с различными протоколами маршрутизации и может использоваться исключительно в интрасетях.

## <a name="windows-server-native-bgp-anycast-demo"></a>Демонстрация собственного первого рассылки BGP Windows Server

В следующей процедуре показано, как можно использовать собственный протокол BGP в Windows Server с DNS-адресом нестандартной рассылки.  

### <a name="requirements"></a>Требования

- Одно физическое устройство с установленной ролью Hyper-V.
  - Windows Server 2012 R2, Windows 10 или более поздней версии.
- 2 клиентские виртуальные машины (любая операционная система).
  - Рекомендуется установить средства привязки для DNS, такие как "подробно".
- 3 виртуальных машин сервера (Windows Server 2016 или Windows Server 2019).
  - Если модуль Лупбаккадаптер Windows PowerShell еще не установлен на виртуальных машинах сервера (DC001, DC002), для установки этого модуля временно требуется доступ к Интернету.

### <a name="hyper-v-setup"></a>Установка Hyper-V

Настройте сервер Hyper-V следующим образом:

- 2 настроены частные сети виртуальных коммутаторов
  - Макет Интернет-сети 131.253.1.0/24.
  - Макет внутренней сети 10.10.10.0/24
- 2 клиентские виртуальные машины подключены к сети 131.253.1.0/24.
- 2 виртуальные машины сервера подключены к сети 10.10.10.0/24.
- 1 сервер имеет два сетевых подключения и подключен к сетям 131.253.1.0/24 и 10.10.10.0/24.

### <a name="virtual-machine-network-configuration"></a>Конфигурация сети виртуальной машины

Настройте параметры сети на виртуальных машинах со следующими параметрами:

1.  CLIENT1, КЛИЕНТ2
  - CLIENT1:131.253.1.1
  - КЛИЕНТ2:131.253.1.2
  - Маска подсети: 255.255.255.0
  - DNS: 51.51.51.51
  - Шлюз: 131.253.1.254
2.  Шлюз (Windows Server)
  - NIC1:131.253.1.254, подсеть 255.255.255.0
  - NIC2:10.10.10.254, подсеть 255.255.255.0
  - DNS: 51.51.51.51
  - Шлюз: 131.253.1.100 (для демонстрации можно пропустить)
3.  DC001 (Windows Server)
  - NIC1:10.10.10.1
  - Подсеть: 255.255.255.0
  - DNS: 10.10.10.1
  - Шлюз: 10.10.10.254
4.  DC002 (Windows Server)
  - NIC1:10.10.10.2
  - Подсеть 255.255.255.0
  - DNS: 10.10.10.2 *
  - Шлюз: 10.10.10.254

   * Сначала используйте 10.10.10.1 для DNS при выполнении присоединение к домену для DC002, чтобы можно было выбрать домен Active Directory в DC001.

### <a name="configure-dns"></a>Настройка DNS

Используйте диспетчер сервера и консоль управления DNS или Windows PowerShell, чтобы установить следующие роли сервера и создать статическую зону DNS на каждом из двух серверов.

1.  DC001, DC002
  - Установка служб домен Active Directory и повышение уровня до контроллера домена (необязательно)
  - Установка роли DNS (обязательно)
  - Создайте статическую зону (не интегрированную в AD) с именем **Zone. TST** как в DC001, так и в DC002
    - Добавьте **сервер** единого статического имени записи в зоне типа "txt".
    - Данные (текст) для записи TXT в DC001 = **DC001**
    - Данные (текст) для записи TXT в DC002 = **DC002**

### <a name="configure-loopback-adapters"></a>Настройка адаптеров замыкания на себя

Введите следующие команды в командной строке Windows PowerShell с повышенными привилегиями в DC001 и DC002, чтобы настроить адаптеры замыкания на себя. 

> [!NOTE]
> Для работы команды **Install-Module** требуется доступ к Интернету. Это можно сделать, временно назначив виртуальную машину внешней сети в Hyper-V.

```PowerShell
$primary_interface = (Get-NetAdapter |?{$_.Status -eq "Up" -and !$_.Virtual}).Name
$loopback_ipv4 = '51.51.51.51'
$loopback_ipv4_length = '32'
$loopback_name = 'Loopback'
Install-Module -Name LoopbackAdapter -MinimumVersion 1.2.0.0 -Force
Import-Module -Name LoopbackAdapter
New-LoopbackAdapter -Name $loopback_name -Force
$interface_loopback = Get-NetAdapter -Name $loopback_name
$interface_main = Get-NetAdapter -Name $primary_interface
Set-NetIPInterface -InterfaceIndex $interface_loopback.ifIndex -InterfaceMetric "254" -WeakHostReceive Enabled -WeakHostSend Enabled -DHCP Disabled
Set-NetIPInterface -InterfaceIndex $interface_main.ifIndex -WeakHostReceive Enabled -WeakHostSend Enabled
Set-NetIPAddress -InterfaceIndex $interface_loopback.ifIndex -SkipAsSource $True
Get-NetAdapter $loopback_name | Set-DNSClient –RegisterThisConnectionsAddress $False
New-NetIPAddress -InterfaceAlias $loopback_name -IPAddress $loopback_ipv4 -PrefixLength $loopback_ipv4_length -AddressFamily ipv4
Disable-NetAdapterBinding -Name $loopback_name -ComponentID ms_msclient
Disable-NetAdapterBinding -Name $loopback_name -ComponentID ms_pacer
Disable-NetAdapterBinding -Name $loopback_name -ComponentID ms_server
Disable-NetAdapterBinding -Name $loopback_name -ComponentID ms_lltdio
Disable-NetAdapterBinding -Name $loopback_name -ComponentID ms_rspndr
```

### <a name="virtual-machine-routing-configuration"></a>Конфигурация маршрутизации виртуальной машины

Используйте следующие команды Windows PowerShell на виртуальных машинах, чтобы настроить маршрутизацию.

1.  Шлюз
```PowerShell
Install-WindowsFeature RemoteAccess -IncludeManagementTools
Install-RemoteAccess -VpnType RoutingOnly
Add-BgpRouter -BgpIdentifier “10.10.10.254” -LocalASN 8075
Add-BgpPeer -Name "DC001" -LocalIPAddress 10.10.10.254 -PeerIPAddress 10.10.10.1 -PeerASN 65511 –LocalASN 8075
```

2.  DC001
```PowerShell
Install-WindowsFeature RemoteAccess -IncludeManagementTools
Install-RemoteAccess -VpnType RoutingOnly
Add-BgpRouter -BgpIdentifier “10.10.10.1” -LocalASN 65511
Add-BgpPeer -Name "Labgw" -LocalIPAddress 10.10.10.1 -PeerIPAddress 10.10.10.254 -PeerASN 8075 –LocalASN 65511
Add-BgpCustomRoute -Network 51.51.51.0/24
```

3.  DC002
```PowerShell
Install-WindowsFeature RemoteAccess -IncludeManagementTools
Install-RemoteAccess -VpnType RoutingOnly
Add-BgpRouter -BgpIdentifier "10.10.10.2" -LocalASN 65511
Add-BgpPeer -Name "Labgw" -LocalIPAddress 10.10.10.2 -PeerIPAddress 10.10.10.254 -PeerASN 8075 –LocalASN 65511
Add-BgpCustomRoute -Network 51.51.51.0/24
```

### <a name="summary-diagram"></a>Сводная диаграмма

![DNS с произвольной адресацией](../../media/Anycast/anycast-lab.png)

**Рис. 2**. Настройка Lab для собственной демонстрации DNS для собственного первого получателя BGP

## <a name="anycast-dns-demonstration"></a>Демонстрация произвольного DNS


1.  Проверка маршрутизации BGP на сервере шлюза

    PS C: \> Get-BgpRouteInformation

    Дестинатионнетворк NextHop Леарнедфромпир State Локалпреф MED<br>
    ------------------ -------    --------------- ----- --------- ---<br>
    51.51.51.0/24 10.10.10.1 DC001<br>
    51.51.51.0/24 10.10.10.2 DC002<br>

2.  На компьютере КЛИЕНТ1 и КЛИЕНТ2 убедитесь, что вы можете получить доступ к 51.51.51.51.

    PS C: \> ping 51.51.51.51

    Проверка связи 51.51.51.51 с 32 байт данных:<br>
    Ответ от 51.51.51.51: bytes = 32 Time<1 мс TTL = 126<br>
    Ответ от 51.51.51.51: bytes = 32 Time<1 мс TTL = 126<br>
    Ответ от 51.51.51.51: bytes = 32 Time<1 мс TTL = 126<br>
    Ответ от 51.51.51.51: bytes = 32 Time<1 мс TTL = 126

    Статистика проверки связи для 51.51.51.51:<br>
    Пакетов: Отправлено = 4, получено = 4, потеряно = 0 (0% потерь),<br>
    Приблизительное время кругового пути в миллисекундах:<br>
    Минимум = 0 мс, максимум = 0 мс, Average = 0 мс

    > [!NOTE]
    > Если проверка связи не будет выполнена, также проверьте, нет ли правил брандмауэра, блокирующих ICMP.

3.  На компьютере КЛИЕНТ1 и КЛИЕНТ2 используйте nslookup или Query для запроса записи TXT. Ниже показаны примеры обоих типов.

    PS C: \> углубление Server. Zone. TST txt + Short<br>
    PS C: \> nslookup-Type = txt Server. Zone. TST 51.51.51.51

    Один клиент будет отображать "DC001", а другой клиент будет отображать "DC002", подтверждая, что неоднократная проверка правильно работает.  Кроме того, можно выполнять запросы с сервера шлюза.

4.  Затем отключите адаптер Ethernet на DC001.

    PS C: \> (Get-NetAdapter). Безымян<br>
    Замыкание на себя<br>
    Ethernet 2<br>
    PS C: \> Disable-NetAdapter "Ethernet 2"<br>
    Подтвердить<br>
    Вы действительно хотите выполнить это действие?<br>
    Disable-NetAdapter "Ethernet 2"<br>
    [Y] Да [A] Да для всех [N] нет [L] No ко всем [S] приостановить [?] Справка (по умолчанию — "Y"):<br>
    PS C: \> (Get-NetAdapter). Состояние<br>
    Up<br>
    Отключен

5.  Убедитесь, что DNS-клиенты, которые ранее получали ответы от DC001, перешли на DC002.

    PS C: \> nslookup-Type = txt Server. Zone. TST 51.51.51.51<br>
    Сервер: неизвестно<br>
    Адрес: 51.51.51.51<br>

    Server. Zone. TST Text =

    "DC001"<br>
    PS C: \> nslookup-Type = txt Server. Zone. TST 51.51.51.51<br>
    Сервер: неизвестно<br>
    Адрес: 51.51.51.51<br>

    Server. Zone. TST Text =

    "DC002"

6.  Убедитесь, что сеанс BGP отключен от DC001 с помощью Get-BgpStatistics на сервере шлюза.
7.  Снова включите адаптер Ethernet в DC001 и убедитесь, что сеанс BGP восстановлен, а клиенты получили ответы DNS от DC001.

> [!NOTE]
> Если подсистема балансировки нагрузки не используется, отдельный клиент будет использовать тот же внутренний DNS-сервер, если он доступен. При этом создается единообразный путь BGP для клиента. Дополнительные сведения см. в разделе 4.4.3 RFC4786: [Equals-Cost paths](https://tools.ietf.org/html/rfc4786#page-10).

## <a name="frequently-asked-questions"></a>Часто задаваемые вопросы

Вопрос. является ли DNS-сервер нежелательной рассылки хорошим решением для использования в локальной среде DNS?<br>
Ответ. несамостоятельный DNS-сервер легко работает с локальной службой DNS. Тем не менее, для масштабирования службы DNS не *требуется перезагрузка* по рассылок.
 
Вопрос. Каково влияние реализации незаполненного кода DNS в среде с большим числом (например, >50) контроллеров домена? <br>
Ответ. прямое воздействие на функциональность отсутствует. Если используется балансировщик нагрузки, дополнительная настройка контроллеров домена не требуется.
 
Вопрос. является ли конфигурация DNS с несамостоятельным обслуживанием, поддерживаемая службой поддержки пользователей Майкрософт?<br>
Ответ. Если для пересылки запросов DNS используется не подсистема балансировки нагрузки Майкрософт, корпорация Майкрософт будет поддерживать проблемы, связанные со службой DNS-сервера. Сведения о проблемах, связанных с пересылкой DNS, см. в поставщике подсистемы балансировки нагрузки. 
 
Вопрос. Какова рекомендуемая версия DNS с большим числом (например, >50) контроллеров домена?<br>
О. рекомендуется использовать подсистему балансировки нагрузки в каждом географическом расположении. Подсистемы балансировки нагрузки, как правило, предоставляются внешним поставщиком. 

Вопрос. Существуют ли аналогичные функции в DNS и Azure DNSах с одинаковыми функциями?<br>
Ответ. Azure DNS использует рассылки по отдельности. Чтобы использовать Azure DNS рассылки, настройте подсистему балансировки нагрузки для перенаправления запросов на сервер Azure DNS. 