---
title: Устранение неполадок DNS-серверов
description: В этой статье рассказывается, как устранять неполадки DNS с сервера.
manager: dcscontentpm
ms.topic: article
ms.author: delhan
ms.date: 8/8/2019
author: Deland-Han
ms.openlocfilehash: ce4a3f4a183478cd250159f1953a0fd2193f6de6
ms.sourcegitcommit: dfa48f77b751dbc34409aced628eb2f17c912f08
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/07/2020
ms.locfileid: "87964080"
---
# <a name="troubleshooting-dns-servers"></a>Устранение неполадок DNS-серверов

В этой статье описывается, как устранять неполадки на DNS-серверах.

## <a name="check-ip-configuration"></a>Проверка IP-конфигурации

1. Выполните `ipconfig /all` команду из командной строки и проверьте IP-адрес, маску подсети и шлюз по умолчанию.

2. Проверьте, является ли DNS-сервер полномочным для имени, которое ищется. Если это так, см. раздел [Проверка на наличие проблем с достоверными данными](#checking-for-problems-with-authoritative-data).

3. Выполните следующую команду.

   ```cmd
   nslookup <name> <IP address of the DNS server>
   ```
   Например:
   ```cmd
   nslookup app1 10.0.0.1
   ```
   Если вы получаете ответ об ошибке или истечении времени ожидания, см. раздел [Проверка проблем с рекурсией](#checking-for-recursion-problems).

4. Очистка кэша сопоставителя. Для этого выполните следующую команду в окне командной строки с правами администратора:

   ```cmd
   dnscmd /clearcache
   ```
   Или в окне администрирования PowerShell выполните следующий командлет:
   ```powershell
   Clear-DnsServerCache
   ```

5. Повторите шаг 3.

## <a name="check-dns-server-problems"></a>Проверка неполадок DNS-сервера

### <a name="event-log"></a>Журнал событий

Проверьте следующие журналы, чтобы узнать, есть ли записанные ошибки:

- Приложение

- Система

- DNS-сервер

### <a name="test-by-using-nslookup-query"></a>Тестирование с помощью запроса nslookup

Выполните следующую команду и проверьте, доступен ли DNS-сервер с клиентских компьютеров.

```cmd
nslookup <client name> <server IP address>
```

- Если сопоставитель возвращает IP-адрес клиента, у сервера нет проблем.

- Если сопоставитель возвращает ответ "сбой сервера" или "Запрос отклонен", зона может быть приостановлена или сервер может быть перегружен. Чтобы узнать, приостановлен ли он, перейдите на вкладку Общие окна свойств зоны в консоли DNS.

Если сопоставитель возвращает ответ "запрос на превышение времени ожидания сервера" или "нет ответа от сервера", возможно, служба DNS не запущена. Попробуйте перезапустить службу DNS-сервера, введя следующую команду в командной строке на сервере:

```cmd
net start DNS
```

Если проблема возникает при запуске службы, сервер может не прослушивать IP-адрес, который использовался в запросе nslookup. На вкладке **интерфейсы** страницы свойств сервера консоли DNS администраторы могут ограничить DNS-сервер прослушиванием только выбранных адресов. Если DNS-сервер настроен для ограничения службы указанным списком настроенных IP-адресов, то возможно, что IP-адрес, используемый для связи с DNS-сервером, отсутствует в списке. Можно попробовать использовать другой IP-адрес в списке или добавить IP-адрес в список.

В редких случаях DNS-сервер может иметь расширенную конфигурацию безопасности или брандмауэра. Если сервер расположен в другой сети, доступной только через промежуточный узел (например, маршрутизатор фильтрации пакетов или прокси-сервер), DNS-сервер может использовать нестандартный порт для прослушивания и получения клиентских запросов. По умолчанию программа nslookup отправляет запросы на DNS-серверы через порт UDP 53. Поэтому, если DNS-сервер использует любой другой порт, запросы nslookup завершатся ошибкой. Если вы считаете, что это может быть проблема, проверьте, используется ли промежуточный фильтр для блокировки трафика на хорошо известных портах DNS. Если это не так, попробуйте изменить фильтры пакетов или правила портов в брандмауэре, чтобы разрешить трафик через порт UDP/TCP 53.

## <a name="checking-for-problems-with-authoritative-data"></a>Проверка на наличие проблем с достоверными данными

Проверьте, является ли сервер, который возвращает неверный ответ, основным сервером для зоны (основным сервером-источником для зоны или сервером, который использует интеграцию Active Directory для загрузки зоны) или сервер, на котором размещена дополнительная копия зоны.

### <a name="if-the-server-is-a-primary-server"></a>Если сервер является сервером-источником

Проблема может быть вызвана ошибкой пользователя при вводе пользователем данных в зону. Кроме того, это может быть вызвано проблемой, которая влияет на Active Directory репликацию или динамическое обновление.

### <a name="if-the-server-is-hosting-a-secondary-copy-of-the-zone"></a>Если на сервере размещается дополнительная копия зоны

1. Изучите зону на главном сервере (сервере, с которого этот сервер извлекает зоны).

   > [!NOTE]
   >Чтобы определить, какой сервер является главным сервером, проверьте свойства дополнительной зоны в консоли DNS.

   Если на главном сервере указано неправильное имя, перейдите к шагу 4.

2. Если на главном сервере указано правильное имя, убедитесь, что серийный номер на главном сервере меньше или равен серийному номеру на сервере-получателе. Если это так, измените либо главный сервер, либо сервер-получатель так, чтобы серийный номер на главном сервере был больше, чем серийный номер на сервере-получателе.

3. На сервере-получателе выполните принудительную пересылку зоны с помощью консоли DNS или выполните следующую команду:

   ```cmd
   dnscmd /zonerefresh <zone name>
   ```

   Например, если зона — corp.contoso.com, введите: `dnscmd /zonerefresh corp.contoso.com` .

4. Изучите сервер-получатель еще раз, чтобы узнать, правильно ли передана зона. В противном случае у вас, вероятно, возникает проблема с переносом зоны. Дополнительные сведения см. в статье [проблемы зонных передач](#zone-transfer-problems).

5. Если зона была передана правильно, проверьте, правильно ли указаны данные. В противном случае данные в основной зоне неверны. Проблема может быть вызвана ошибкой пользователя при вводе пользователем данных в зону. Кроме того, это может быть вызвано проблемой, которая влияет на Active Directory репликацию или динамическое обновление.

## <a name="checking-for-recursion-problems"></a>Проверка проблем с рекурсией

Чтобы рекурсия работала успешно, все DNS-серверы, используемые в пути рекурсивного запроса, должны иметь возможность отвечать и пересылать правильные данные. Если это не так, рекурсивный запрос может завершиться ошибкой по одной из следующих причин:

- Время ожидания запроса истекло, прежде чем его можно будет завершить.

- Сервер, используемый во время запроса, не отвечает.

- Сервер, используемый во время запроса, предоставляет неверные данные.

Начните устранение неполадок на сервере, который использовался в исходном запросе. Проверьте, пересылает ли этот сервер запросы на другой сервер, изучив вкладку **серверы пересылки** в свойствах сервера в консоли DNS. Если флажок **включить серверы пересылки** установлен и в списке присутствует один или несколько серверов, этот сервер перенаправляет запросы.

Если этот сервер пересылает запросы на другой сервер, проверьте наличие проблем, влияющих на сервер, на который сервер пересылает запросы. Чтобы проверить наличие проблем, см. раздел [Проверка неполадок DNS-сервера](#check-dns-server-problems). Когда этот раздел предписывает выполнить задачу на клиенте, выполните его на сервере.

Если сервер находится в работоспособном состоянии и может пересылать запросы, повторите этот шаг и проверьте сервер, на который сервер пересылает запросы.

Если этот сервер не перенаправляет запросы на другой сервер, проверьте, может ли этот сервер запрашивать корневой сервер. Для этого выполните следующую команду:

```cmd
nslookup
server <IP address of server being examined>
set q=NS
 ```

- Если сопоставитель возвращает IP-адрес корневого сервера, возможно, имеется разорванное делегирование между корневым сервером и именем или IP-адресом, который вы пытаетесь разрешить. Следуйте инструкциям по [тестированию неработающей процедуры делегирования](#test-a-broken-delegation) , чтобы определить, где находится неработающее делегирование.

- Если сопоставитель возвращает ответ "запрос на превышение времени ожидания сервера", проверьте, указывает ли корневые ссылки на работоспособность корневых серверов. Для этого используйте [для просмотра текущей процедуры корневых ссылок](#to-view-the-current-root-hints) . Если корневые ссылки указывают на работающие корневые серверы, возможно, возникла проблема с сетью или сервер может использовать расширенную конфигурацию брандмауэра, которая не позволяет арбитру конфликтов запрашивать сервер, как описано в разделе [Проверка проблем DNS-сервера](#check-dns-server-problems) . Также возможно, что рекурсивное время ожидания по умолчанию слишком мало.

### <a name="test-a-broken-delegation"></a>Тестирование неработающего делегирования

Начните тесты в следующей процедуре, запросив допустимый корневой сервер. Этот тест позволяет выполнить запрос всех DNS-серверов из корня к серверу, который тестируется для неработающего делегирования.

1. В командной строке на тестируемом сервере введите следующее:

   ```cmd
   nslookup
   server <server IP address>
   set norecursion
   set querytype= <resource record type>
   <FQDN>
   ```
   > [!NOTE]
   >Тип записи ресурса — это тип записи ресурса, для которой был выполнен запрос в исходном запросе, а полное доменное имя — полное доменное имя, для которого выполнялись запросы (заканчивающиеся точкой).

2. Если ответ содержит список записей ресурсов "NS" и "A" для делегированных серверов, повторите шаг 1 для каждого сервера и используйте IP-адрес из записей ресурсов "A" в качестве IP-адреса сервера.

   - Если ответ не содержит запись ресурса NS, делегирование будет разорвано.

   - Если ответ содержит записи ресурсов "NS", но нет записей ресурсов "A", введите " **задать рекурсию**" и выполните запрос по отдельности для записей ресурсов "a" серверов, перечисленных в записях NS. Если вы не нашли по меньшей мере один допустимый IP-адрес записи ресурса "A" для каждой записи ресурса NS в зоне, то у вас есть неработающее делегирование.

3. Если вы определили, что вы используете неработающее делегирование, исправьте его, добавив или обновив запись ресурса "A" в родительской зоне, используя допустимый IP-адрес для соответствующего DNS-сервера для делегированной зоны.

### <a name="to-view-the-current-root-hints"></a>Просмотр текущих корневых ссылок

1. Запустите консоль DNS.

2. Добавьте или подключитесь к DNS-серверу, который не прошел рекурсивный запрос.

3. Щелкните правой кнопкой мыши сервер и выберите пункт **Свойства**.

4. Щелкните корневые ссылки.

Проверьте наличие базовых подключений к корневым серверам.

- Если правильно настроены корневые ссылки, убедитесь, что DNS-сервер, используемый в разрешении имен с ошибками, может проверить связь с корневыми серверами по IP-адресу.

- Если корневые серверы не отвечают на проверку связи по IP-адресу, IP-адреса для корневых серверов могли измениться. Однако нередко можно увидеть перенастройку корневых серверов.

## <a name="zone-transfer-problems"></a>Проблемы с зонными ошибками

Выполните следующие проверки:

- Проверьте Просмотр событий как для основного, так и для дополнительного DNS-сервера.

- Проверьте главный сервер, чтобы узнать, не отклоняется ли отправка для обеспечения безопасности.

- Проверьте вкладку **зонные передачи** свойств зоны в консоли DNS. Если сервер ограничит передачу зоны на список серверов, например на вкладке **серверы имен** в свойствах зоны, убедитесь, что сервер-получатель находится в этом списке. Убедитесь, что сервер настроен на отправку зонных передач.

- Проверьте наличие проблем на главном сервере, выполнив действия, описанные в разделе [Проверка проблем DNS-сервера](#check-dns-server-problems) . Когда появится запрос на выполнение задачи на клиенте, выполните задачу на сервере-получателе.

- Проверьте, не работает ли на сервере-получателе другая реализация сервера DNS, например BIND. Если это так, проблема может быть вызвана одной из следующих причин:

  - Главный сервер Windows может быть настроен для отправки быстрых зонных передач, но сервер-получатель стороннего производителя может не поддерживать быструю передачу зоны. В этом случае отключите передачу данных на главном сервере в консоли DNS, установив флажок **включить вторичные базы** данных-получатели на вкладке **Дополнительно** свойств сервера.

  - Если зона прямого просмотра в Windows Server содержит тип записи (например, запись SRV), которую сервер-получатель не поддерживает, то на сервере-получателе могут возникнуть проблемы с извлечением зоны.

Проверьте, работает ли на главном сервере другая реализация DNS-сервера, например BIND. Если да, то возможно, что зона на главном сервере содержит несовместимые записи ресурсов, которые Windows не распознает.

Если на главном или вторичном сервере используется другая реализация DNS-сервера, проверьте оба сервера, чтобы убедиться, что они поддерживают одни и те же функции. Можно проверить Windows Server на консоли DNS на вкладке **Дополнительно** страницы Свойства сервера. В дополнение к полю включить вторичные получатели привязок на этой странице содержится раскрывающийся список **Проверка имен** . Это позволяет выбрать принудительное соответствие требованиям RFC для символов в DNS-именах.

