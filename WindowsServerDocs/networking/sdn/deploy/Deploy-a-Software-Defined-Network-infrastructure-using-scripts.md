---
title: Развертывание инфраструктуры программно определяемой сети, с помощью сценариев
description: В этом разделе описывается, как развернуть инфраструктуру Microsoft программно-определяемой сети (SDN) с помощью сценариев в Windows Server 2016.
manager: dougkim
ms.prod: windows-server-threshold
ms.service: virtual-network
ms.technology: networking-sdn
ms.topic: get-started-article
ms.assetid: 5ba5bb37-ece0-45cb-971b-f7149f658d19
ms.author: pashort
author: shortpatti
ms.date: 08/23/2018
ms.openlocfilehash: dabfe3de4cc307723ff7e614fb73e3903e74aeb2
ms.sourcegitcommit: 0d0b32c8986ba7db9536e0b8648d4ddf9b03e452
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2019
ms.locfileid: "59844625"
---
# <a name="deploy-a-software-defined-network-infrastructure-using-scripts"></a>Развертывание инфраструктуры программно-конфигурируемой сети с помощью скриптов

>Относится к: Windows Server (полугодовой канал), Windows Server 2016

В этом разделе вы развернуть инфраструктуру Microsoft программно-определяемой сети (SDN) с помощью скриптов. В инфраструктуру входит высокой доступности (HA) сетевого контроллера, высокого уровня ДОСТУПНОСТИ программного обеспечения нагрузки Подсистему балансировки / MUX, виртуальные сети и связанные списки управления доступом (ACL). Кроме того еще один скрипт развертывает рабочую нагрузку клиента для проверки своей инфраструктуре SDN.  
  
Если вы хотите рабочих нагрузок клиентов для взаимодействия за пределами своих виртуальных сетях, вы можете настроить правила преобразования сетевых адресов SLB, туннели шлюза сайт-сайт или переадресации 3-го уровня для маршрутизации между виртуальными и физическими рабочих нагрузок.  
  
Можно также развернуть инфраструктуру SDN с помощью Virtual Machine Manager (VMM). Дополнительные сведения см. в разделе [Настройка инфраструктуры программно определяемой сети (SDN) в структуре VMM](https://technet.microsoft.com/system-center-docs/vmm/scenario/sdn-overview).  

  
## <a name="pre-deployment"></a>Перед развертыванием  
  
> [!IMPORTANT]  
> Перед началом развертывания необходимо планирование и настроить узлы и физической сетевой инфраструктуры. Дополнительные сведения см. в разделе [Планирование программно-конфигурируемой инфраструктуры](../../sdn/plan/Plan-a-Software-Defined-Network-Infrastructure.md).  
  
Все узлы Hyper-V должны иметь установленным Windows Server 2016.  
  
## <a name="deployment-steps"></a>Шаги развертывания  
Сначала настроить виртуальный коммутатор Hyper-V (физических серверов) и назначение IP-адресов на узле Hyper-V. Может использоваться любой тип хранилища, совместимого с Hyper-V, общей или локальной.  

### <a name="install-host-networking"></a>Установка сети узлов  

1. Установите последние версии сетевых драйверов для оборудования сетевого Адаптера.  
2. Установка роли Hyper-V на всех узлах (Дополнительные сведения см. в разделе [начало работы с Hyper-V в Windows Server 2016](https://docs.microsoft.com/windows-server/virtualization/hyper-v/get-started/Get-started-with-Hyper-V-on-Windows).   
  
   ```PowerShell
   Install-WindowsFeature -Name Hyper-V -ComputerName <computer_name> -IncludeManagementTools -Restart
   ```  
    
3. Создайте виртуальный коммутатор Hyper-V.<p>Например, использовать одно и то же имя коммутатора для всех узлов, **sdnSwitch**. Настройте по крайней мере один сетевой адаптер, или если с помощью НАБОРА, настроить по крайней мере два сетевых адаптера. Максимальное распространение входящих данных возникает при использовании двух сетевых адаптеров.  

   ```PowerShell
   New-VMSwitch "<switch name>" -NetAdapterName "<NetAdapter1>" [, "<NetAdapter2>" -EnableEmbeddedTeaming $True] -AllowManagementOS $True
   ```  
   >[!TIP] 
   >Если у вас есть отдельные сетевые адаптеры управления, можно пропустить шаги 4 и 5.

3. См. в разделе планирования ([планирование инфраструктуры программно-определяемой сети](../../sdn/plan/../../sdn/plan/../../sdn/plan/Plan-a-Software-Defined-Network-Infrastructure.md)) и обратитесь к администратору сети, чтобы получить идентификатор виртуальной локальной сети VLAN управления. Подключите виртуальный сетевой адаптер управления вновь созданного виртуального коммутатора, виртуальной локальной сети управления. Этот шаг можно пропустить, если в вашей среде не используются теги виртуальной локальной сети.  
   
   ```PowerShell
   Set-VMNetworkAdapterIsolation -ManagementOS -IsolationMode Vlan -DefaultIsolationID <Management VLAN> -AllowUntaggedTraffic $True
   ```  
 
4. См. в разделе планирования ([планирование инфраструктуры программно-определяемой сети](../../sdn/plan/../../sdn/plan/../../sdn/plan/Plan-a-Software-Defined-Network-Infrastructure.md)) и работать с администратору сети для использования либо DHCP или статические IP-адрес назначения для назначения IP-адрес виртуального сетевого адаптера управления вновь созданного объекта виртуальный коммутатор. В следующем примере показано, как создать статический IP-адрес и присвоить виртуальный сетевой адаптер управления vswitch.:  
 
   ```PowerShell
   New-NetIPAddress -InterfaceAlias "vEthernet (<switch name>)" -IPAddress <IP> -DefaultGateway <Gateway IP> -AddressFamily IPv4 -PrefixLength <Length of Subnet Mask - for example: 24>
   ```  
      
5. [Необязательно] Развертывание виртуальной машины к узлу доменных служб Active Directory ([Установка служб Active Directory домена (уровень 100)](https://technet.microsoft.com/library/hh472162.aspx) и DNS-сервер.  
   
    1. Подключите виртуальную машину Active Directory и DNS-сервера для управления виртуальной локальной сети:
    
       ```PowerShell
       Set-VMNetworkAdapterIsolation -VMName "<VM Name>" -Access -VlanId <Management VLAN> -AllowUntaggedTraffic $True  
       ```   

   2. Установка доменных служб Active Directory и DNS.  

   >[!NOTE]
   >Сетевой контроллер поддерживает сертификаты X.509 и Kerberos для проверки подлинности. В этом руководстве используются оба механизма проверки подлинности для разных целей (несмотря на то, что необходим только один).  
        
6. Присоедините все узлы Hyper-V к домену. Убедитесь, сервер DNS для сетевого адаптера, который имеет IP-адрес, назначенного точкам управления сети, DNS-сервер, который может разрешать имя домена. 

   ```PowerShell   
   Set-DnsClientServerAddress -InterfaceAlias "vEthernet (<switch name>)" -ServerAddresses <DNS Server IP>  
   ```
   
   1. Щелкните правой кнопкой мыши **запустить**, нажмите кнопку **системы**, а затем нажмите кнопку **изменить параметры**.  
   2. Нажмите кнопку **Изменить**.  
   В. Нажмите кнопку **домена** и укажите имя домена.  
   Г. Нажмите кнопку **ОК**.  
   Д. Введите имя и пароль, учетные данные пользователя при появлении запроса.  
   f. Перезагрузите сервер.  
  
### <a name="validation"></a>Проверка  
Используйте следующие шаги, чтобы проверить, на которых размещены сети правильности настройки.  

1. Убедитесь, что коммутатор виртуальной Машины успешно создан.  
      
   ```PowerShell
   Get-VMSwitch "<switch name>"
   ```  

2. Убедитесь, что виртуальный сетевой адаптер управления в коммутатор виртуальной Машины подключен к виртуальной локальной сети управления:  

   >[!NOTE]
   >Смысл, только в том случае, если трафик управления и клиента, совместно использовать одна сетевая карта.    
      
   ```PowerShell
   Get-VMNetworkAdapterIsolation -ManagementOS
   ```

3. Проверьте, все узлы Hyper-V и ресурсов внешнего управления, например, DNS-серверы.<p>Убедитесь, что они доступны с помощью проверки связи, используя их IP-адреса управления и/или полное доменное имя (FQDN).   
      
   ``ping <Hyper-V Host IP>``  
   ``ping <Hyper-V Host FQDN>``  

4. Выполните следующую команду на узле развертывания и укажите полное ДОМЕННОЕ имя каждого узла Hyper-V, чтобы обеспечить учетные данные Kerberos предоставляет доступ ко всем серверам.  
      
   ``winrm id -r:<Hyper-V Host FQDN>``  
      
### <a name="nano-installation-requirements-and-notes"></a>Требования к установке Nano и примечания  

Если вы используете Nano в качестве узлов Hyper-V (физических серверов) для развертывания, ниже приведены дополнительные требования.  

1. Все узлы Nano потребуется установить пакет DSC с языковым пакетом.  
   
    - Microsoft-NanoServer-DSC-Package.cab  
    - Microsoft-NanoServer-DSC-Package_en-us.cab
   
    ``dism /online /add-package /packagepath:<Path> /loglevel:4``  

2. SDN Express скрипты должны запускаться с узла не Nano (Windows Server Core или Windows Server с графическим интерфейсом пользователя). Рабочие процессы PowerShell не поддерживаются в Nano.  

3.  Вызов Северный API сетевого контроллера с помощью PowerShell или оболочки REST NC (которые используют Invoke-WebRequest и Invoke-RestMethod) должны выполняться с узла не Nano.  
   
         
### <a name="run-sdn-express-scripts"></a>Запуск скриптов SDN Express  
  
1. Перейдите к [репозиторий GitHub Microsoft SDN](https://github.com/Microsoft/SDN.git) для файлов установки.

2. Скачайте файлы установки из репозитория на компьютере указанного развертывания. Нажмите кнопку **клонировать или скачать** и нажмите кнопку **загрузить ZIP-ФАЙЛ**.  
 
   >[!NOTE]
   >Компьютер указанного развертывания должен быть под управлением Windows Server 2016 или более поздней версии.
 
3. Разверните на ZIP-файл и скопируйте **SDNExpress** папку на компьютере развертывания `C:\` папки.  
  
4. Общий ресурс `C:\SDNExpress` папке, что "**SDNExpress**" с разрешением для **все** для **чтения и записи**.  
  
5. Перейдите к `C:\SDNExpress` папки.<p>Вы увидите следующие папки:  

   |Имя папки|Описание|  
   |---------------|---------------|  
   |AgentConf|Содержит чистые копии OVSDB схем, используемых агентом узла SDN на каждом узле Windows Server 2016 Hyper-V для программы сетевой политики.|  
   |Сертификаты.|Временный общее расположение для файла сертификата сетевого Контроллера.|  
   |Изображений|Пустые, Разместите здесь образ vhdx для Windows Server 2016|  
   |Инструменты|Служебные программы для устранения неполадок и отладки.  Скопировать узлов и виртуальных машин.  Мы рекомендуем вы установите сетевой монитор или Wireshark здесь, чтобы он был доступен при необходимости.|  
   |Сценарии|Скрипты развертывания.<br /><br />-   **SDNExpress.ps1**<br />    Развертывает и настраивает fabric, включая виртуальные машины сетевого контроллера, виртуальные машины SLB/Mux, пулы шлюза и соответствующие пулы виртуальных машин шлюза HNV.<br />-   **FabricConfig.psd1**<br />    Шаблон файла конфигурации для скрипта SDNExpress.  Это будет выполнена настройка для вашей среды.<br />-   **SDNExpressTenant.ps1**<br />    Развертывает на примере клиента рабочей нагрузки в виртуальной сети с VIP-адрес с балансировкой нагрузки.<br />    Также позволяет подготовить один или несколько сетевых подключений (VPN-подключения S2S IPSec, GRE, L3) на шлюзах edge поставщик службы, подключенные к рабочей нагрузке ранее созданного клиента. Шлюзы IPSec и GRE доступны для подключения через соответствующий виртуальный IP-адрес IP-адрес и шлюз переадресации L3 через соответствующий пул адресов.<br />    Этот скрипт можно использовать для удаления соответствующей конфигурации с возможностью отмены также.<br />-   **TenantConfig.psd1**<br />    Файл конфигурации шаблона для рабочих нагрузок клиента и конфигурации шлюза S2S.<br />-   **SDNExpressUndo.ps1**<br />    Очищает fabric среды и сбрасывает ее в первоначальное состояние.<br />-   **SDNExpressEnterpriseExample.ps1**<br />    Позволяет подготовить один или несколько корпоративных средах сайта с помощью одного шлюза удаленного доступа и (необязательно) один соответствующий enterprise виртуальной машины для каждого сайта. Шлюзы enterprise IPSec или GRE подключается к соответствующий Виртуальный IP-адрес шлюза поставщика службы для установления туннели S2S. Шлюз переадресации L3 подключается через соответствующий IP-адрес однорангового узла. <br />            Этот скрипт можно использовать для удаления соответствующей конфигурации с возможностью отмены также.<br />-   **EnterpriseConfig.psd1**<br />    Файл конфигурации шаблона для корпоративного шлюза сайта для сайта и конфигурация виртуальной Машины клиента.|  
   |TenantApps|Файлы, используемые для развертывания клиента пример рабочей нагрузки.|  
   ---
  
6. Убедитесь, Windows Server 2016, vhdx-файл находится в **образы** папки.  
  
7. Настраивать, изменяя файл SDNExpress\scripts\FabricConfig.psd1 **<< замените >>** теги с определенными значениями в соответствии с вашей инфраструктуры лаборатории, включая имена узлов, доменные имена, имена пользователей и пароли, и сведения о сети для сети, перечисленные в разделе планирования сети.  

8. Создайте запись узла A в DNS NetworkControllerRestIP и NetworkControllerRestName (полного доменного ИМЕНИ).  

9. Запустите сценарий, как пользователь с правами администратора домена:  
      
   ``SDNExpress\scripts\SDNExpress.ps1 -ConfigurationDataFile FabricConfig.psd1 -Verbose``  
      
10. Чтобы отменить все операции, выполните следующую команду:  
      
    ``SDNExpress\scripts\SDNExpressUndo.ps1 -ConfigurationDataFile FabricConfig.psd1 -Verbose``  
      
#### <a name="validation"></a>Проверка  

При условии, что скрипта SDN Express выполнена до завершения без сообщающий о любых ошибках, можно выполнить следующий шаг, чтобы обеспечить ресурсы структуры правильности развертывания и доступны для развертывания клиента.  

Используйте [средства диагностики](https://docs.microsoft.com/windows-server/networking/sdn/troubleshoot/troubleshoot-windows-server-software-defined-networking-stack) чтобы убедиться в отсутствии ошибок каких-либо ресурсов структуры в сетевом контроллере.  
      
   ``Debug-NetworkControllerConfigurationState -NetworkController <FQDN of Network Controller Rest Name>``  
        
   
### <a name="deploy-a-sample-tenant-workload-with-the-software-load-balancer"></a>Развертывание на примере рабочей нагрузки клиента с помощью подсистемы балансировки нагрузки  
    
Теперь, когда были развернуты ресурсы структуры, вы можете проверить ваш SDN развертывания end-to-end, развернув на примере рабочей нагрузки клиента. Эта рабочая нагрузка клиента состоит из двух виртуальных подсетей (веб-уровня и уровня базы данных) защищенные с помощью правил списка управления доступом (ACL), с помощью брандмауэра распределенных SDN. Веб-уровня виртуальной подсети доступен через SLB/MUX, с помощью адреса виртуальный IP-адрес (VIP). Сценарий автоматически развертывает две виртуальные машины веб-уровня и одна база данных уровня виртуальной машины и подключает их виртуальные подсети.  
  
1.  Настраивать, изменяя файл SDNExpress\scripts\TenantConfig.psd1 **<< замените >>** теги с определенными значениями (например: Имя образа виртуального жесткого диска, имя REST сетевого контроллера, имя виртуального коммутатора, и т.д., как уже определен в файле FabricConfig.psd1)  

2.  Запустите скрипт. Пример:  

    ``SDNExpress\scripts\SDNExpressTenant.ps1 -ConfigurationDataFile TenantConfig.psd1 -Verbose``  

3.  Чтобы отменить конфигурацию, выполните тот же сценарий с **отменить** параметра. Пример:  

    ``SDNExpress\scripts\SDNExpressTenant.ps1 -Undo -ConfigurationDataFile TenantConfig.psd1 -Verbose``  

#### <a name="validation"></a>Проверка  

Для проверки успешности развертывания клиента, сделайте следующее:

1. Войдите в виртуальную машину уровня базы данных и попробуйте проверить связь с IP-адрес одного из виртуальной машины веб-уровня (Убедитесь, что брандмауэр Windows отключен в виртуальные машины веб-уровня).  

2. Проверка ресурсов клиентов сетевого контроллера на наличие ошибок. Выполните следующую команду из любой узел Hyper-V с помощью подключения третьего уровня для сетевого контроллера:  
      
   ``Debug-NetworkControllerConfigurationState -NetworkController <FQDN of Network Controller REST Name>``

3. Чтобы убедиться, что Подсистема балансировки нагрузки работает правильно, выполните следующую команду из любой узел Hyper-V:
    
   ``wget <VIP IP address>/unique.htm -disablekeepalive -usebasicparsing``
   
   где `<VIP IP address>` является Виртуальный IP-адрес, настроенные в файле TenantConfig.psd1 веб-уровня. 

   >[!TIP]
   >Поиск `VIPIP` переменной в TenantConfig.psd1.

   Выполняет раз высокая для переключения между доступными частные интерфейсы подсистемы балансировки нагрузки см. в разделе. Можно также наблюдать за этим поведением с помощью веб-браузер. Перейдите по адресу `<VIP IP address>/unique.htm`. Закройте обозревателя и откройте новый экземпляр и снова перейдите. Вы увидите на синий и зеленый страницах, альтернативный, за исключением случаев, когда обозреватель кэширует страницы до истечения срока кэша.

---