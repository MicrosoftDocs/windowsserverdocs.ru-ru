---
title: Развертывание программно-определяемой сетевой инфраструктуры с помощью сценариев
description: В этом разделе описывается развертывание инфраструктуры программно-определяемой сети (SDN) с помощью сценариев в Windows Server 2016.
manager: grcusanz
ms.topic: get-started-article
ms.assetid: 5ba5bb37-ece0-45cb-971b-f7149f658d19
ms.author: anpaul
author: AnirbanPaul
ms.date: 08/23/2018
ms.openlocfilehash: 244f18baefa0be9b9b392682e48931e7d4e195b8
ms.sourcegitcommit: d08965d64f4a40ac20bc81b14f2d2ea89c48c5c8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/08/2020
ms.locfileid: "96865623"
---
# <a name="deploy-a-software-defined-network-infrastructure-using-scripts"></a>Развертывание инфраструктуры программно-конфигурируемой сети с помощью скриптов

> Применяется к: Windows Server (Semi-Annual Channel), Windows Server 2016

В этом разделе описывается развертывание инфраструктуры программно-определяемой сети (SDN) с помощью сценариев. Инфраструктура включает сетевой контроллер высокой доступности (HA), высокодоступное программное обеспечение Load Balancer (SLB)/МУКС, виртуальные сети и связанные списки управления доступом (ACL). Кроме того, другой сценарий развертывает рабочую нагрузку клиента для проверки инфраструктуры SDN.

Если вы хотите, чтобы рабочие нагрузки клиента взаимодействовали за пределами своих виртуальных сетей, можно настроить правила NAT SLB, туннели шлюза "сеть — сеть" или перенаправление уровня 3 для маршрутизации между виртуальными и физическими рабочими нагрузками.

Можно также развернуть инфраструктуру SDN с помощью Virtual Machine Manager (VMM). Дополнительные сведения см. [в разделе Настройка инфраструктуры программно-определяемой сети (SDN) в структуре VMM](/system-center/vmm/deploy-sdn).

## <a name="pre-deployment"></a>Перед развертыванием

> [!IMPORTANT]
> Перед началом развертывания необходимо спланировать и настроить узлы и инфраструктуру физической сети. Дополнительные сведения см. в статье, посвященной [планированию инфраструктуры программно-конфигурируемой сети](../../sdn/plan/Plan-a-Software-Defined-Network-Infrastructure.md).

На всех узлах Hyper-V должен быть установлен Windows Server 2016.

## <a name="deployment-steps"></a>Шаги по развертыванию
Начните с настройки виртуального коммутатора (физических серверов) узла Hyper-v и назначения IP-адресов. Можно использовать любой тип хранилища, совместимый с Hyper-V, Shared или local.

### <a name="install-host-networking"></a>Установка сети узла

1. Установите последние версии сетевых драйверов, доступных для сетевого оборудования.

2. Установите роль Hyper-V на всех узлах (Дополнительные сведения см. в статье [Начало работы с Hyper-v в Windows Server 2016](../../../virtualization/hyper-v/get-started/get-started-with-hyper-v-on-windows.md).

   ```PowerShell
   Install-WindowsFeature -Name Hyper-V -ComputerName <computer_name> -IncludeManagementTools -Restart
   ```

3. Создайте виртуальный коммутатор Hyper-V.<p>Используйте одно и то же имя коммутатора для всех узлов, например **сднсвитч**. Настройте по крайней мере один сетевой адаптер или, если используется набор, настройте по крайней мере два сетевых адаптера. Максимальное количество входящих подключений происходит при использовании двух сетевых интерфейсов.

   ```PowerShell
   New-VMSwitch "<switch name>" -NetAdapterName "<NetAdapter1>" [, "<NetAdapter2>" -EnableEmbeddedTeaming $True] -AllowManagementOS $True
   ```

   > [!TIP]
   > Вы можете пропустить шаги 4 и 5, если у вас есть отдельные сетевые адаптеры управления.

3. Обратитесь к разделу планирование ([планирование программно-определяемой сетевой инфраструктуры](../../sdn/plan/../../sdn/plan/../../sdn/plan/Plan-a-Software-Defined-Network-Infrastructure.md)) и обратитесь к администратору сети для получения идентификатора виртуальной ЛС виртуальной ЛС управления. Подключите vNIC управления созданного виртуального коммутатора к виртуальной ЛС управления. Этот шаг можно опустить, если в среде не используются теги VLAN.

   ```PowerShell
   Set-VMNetworkAdapterIsolation -ManagementOS -IsolationMode Vlan -DefaultIsolationID <Management VLAN> -AllowUntaggedTraffic $True
   ```

4. Ознакомьтесь с разделом планирования (планирование[программно-определяемой сетевой инфраструктуры](../../sdn/plan/../../sdn/plan/../../sdn/plan/Plan-a-Software-Defined-Network-Infrastructure.md)) и обратитесь к администратору сети для назначения IP-адреса vNICу управления только что созданной vSwitch. В следующем примере показано, как создать статический IP-адрес и назначить его vNIC управления vSwitch:

   ```PowerShell
   New-NetIPAddress -InterfaceAlias "vEthernet (<switch name>)" -IPAddress <IP> -DefaultGateway <Gateway IP> -AddressFamily IPv4 -PrefixLength <Length of Subnet Mask - for example: 24>
   ```

5. Используемых Разверните виртуальную машину для размещения служб домен Active Directory ([установите службы домен Active Directory Services (уровень 100)](../../../identity/ad-ds/deploy/install-active-directory-domain-services--level-100-.md) и DNS-сервер.

    а. Подключите виртуальную машину Active Directory или DNS-сервера к виртуальной ЛС управления:

    ```PowerShell
    Set-VMNetworkAdapterIsolation -VMName "<VM Name>" -Access -VlanId <Management VLAN> -AllowUntaggedTraffic $True
    ```

   b. Установите службы домен Active Directory и DNS.

   > [!NOTE]
   > Сетевой контроллер поддерживает сертификаты Kerberos и X. 509 для проверки подлинности. В этом руководством используются оба механизма проверки подлинности для разных целей (хотя требуется только один).

6. Присоедините все узлы Hyper-V к домену. Убедитесь, что запись DNS-сервера для сетевого адаптера с IP-адресом, назначенным сети управления, указывает на DNS-сервер, который может разрешить доменное имя.

   ```PowerShell
   Set-DnsClientServerAddress -InterfaceAlias "vEthernet (<switch name>)" -ServerAddresses <DNS Server IP>
   ```

   а. Щелкните правой кнопкой мыши **Пуск**, выберите пункт **система**, а затем щелкните **изменить параметры**.
   b. Нажмите кнопку **Изменить**.
   c. Щелкните **домен** и укажите имя домена.  "" "d. Нажмите кнопку **ОК**.
   д) При появлении запроса введите имя пользователя и пароль.
   е) Перезапустите сервер.

### <a name="validation"></a>Проверка

Выполните следующие действия, чтобы проверить правильность настройки сети узла.

1. Убедитесь, что коммутатор виртуальной машины успешно создан:

   ```PowerShell
   Get-VMSwitch "<switch name>"
   ```

2. Убедитесь, что vNIC управления на коммутаторе виртуальной машины подключен к виртуальной ЛС управления:

   > [!NOTE]
   > Уместно, только если трафик управления и клиента имеет общую сетевую карту.

   ```PowerShell
   Get-VMNetworkAdapterIsolation -ManagementOS
   ```

3. Проверьте все узлы Hyper-V и внешние ресурсы управления, например DNS-серверы.<p>Убедитесь, что они доступны через проверку связи, используя свой IP-адрес управления и (или) полное доменное имя (FQDN).

   ```
   ping <Hyper-V Host IP>
   ping <Hyper-V Host FQDN>
   ```

4. Выполните следующую команду на узле развертывания и укажите полное доменное имя каждого узла Hyper-V, чтобы учетные данные Kerberos использовались для доступа ко всем серверам.

   ```
   winrm id -r:<Hyper-V Host FQDN>
   ```

### <a name="run-sdn-express-scripts"></a>Выполнение скриптов SDN Express

1. Перейдите в [репозиторий Microsoft Sdn GitHub](https://github.com/Microsoft/SDN.git) для файлов установки.

2. Скачайте файлы установки из репозитория на указанный компьютер развертывания. Щелкните **клонировать или скачать** , а затем щелкните **скачать ZIP-файл**.

   > [!NOTE]
   > Указанный компьютер развертывания должен работать под Windows Server 2016 или более поздней версии.

3. Разверните ZIP-файл и скопируйте папку **сднекспресс** в папку компьютера развертывания `C:\` .

4. Предоставьте общий доступ к `C:\SDNExpress` папке "**сднекспресс**" с разрешением на **чтение и запись** для **всех пользователей** .

5. Перейдите к папке `C:\SDNExpress`.<p>Вы увидите следующие папки:

   | Имя папки | Описание |
   |--|--|
   | ажентконф | Содержит новые копии схем ОВСДБ, которые используются агентом узла SDN на каждом узле Windows Server 2016 Hyper-V для программирования сетевой политики. |
   | Сертификаты. | Временное общее расположение для файла сертификата NC. |
   | Изображения | Пусто, поместите здесь образ Windows Server 2016 VHDX |
   | Инструменты | Служебные программы для устранения неполадок и отладки.  Копируются на узлы и виртуальные машины.  Рекомендуем поместить сетевой монитор или Wireshark, чтобы он был доступен при необходимости. |
   | Сценарии | Скрипты развертывания.<p> - **SDNExpress.ps1**<br>Развертывает и настраивает структуру, включая виртуальные машины сетевого контроллера, виртуальные машины мультиплексора SLB, пулы шлюзов и виртуальные машины шлюза HNV, соответствующие пулам.<br /> - **FabricConfig.psd1**<br>Шаблон файла конфигурации для скрипта Сднекспресс. Это будет настраиваться для вашей среды.<br /> - **SDNExpressTenant.ps1**<br>Развертывает пример рабочей нагрузки клиента в виртуальной сети с виртуальным IP-адресом с балансировкой нагрузки.<br>Также подготавливает одно или несколько сетевых подключений (IPSec S2S VPN, GRE, L3) к шлюзам поставщиков услуг, подключенным к ранее созданной рабочей нагрузке клиента. Шлюзы IPSec и GRE доступны для подключения по соответствующему IP-адресу виртуальной ЛС, а шлюз перенаправления L3 — по соответствующему пулу адресов.<br>Этот скрипт можно использовать для удаления соответствующей конфигурации с параметром отмены.<br /> - **TenantConfig.psd1**<br>Файл конфигурации шаблона для рабочей нагрузки клиента и конфигурации шлюза S2S.<br /> - **SDNExpressUndo.ps1**<br>Очищает среду структуры и сбрасывает ее в начальное состояние.<br /> - **SDNExpressEnterpriseExample.ps1**<br>Подготавливает одну или несколько сред корпоративного сайта с одним шлюзом удаленного доступа и (необязательно) одну соответствующую корпоративную виртуальную машину на сайт. Корпоративные шлюзы IPSec или GRE подключаются к соответствующему ВИРТУАЛЬному IP-адресу шлюза поставщика услуг для установки туннелей S2S. Шлюз перенаправления L3 подключается через соответствующий IP-адрес однорангового узла. <br> Этот скрипт можно использовать для удаления соответствующей конфигурации с параметром отмены.<br /> - **EnterpriseConfig.psd1**<br>Файл конфигурации шаблона для корпоративного шлюза "сеть — сеть" и Конфигурация виртуальной машины клиента. |
   | тенантаппс | Файлы, используемые для развертывания примеров рабочих нагрузок клиента. |

6. Убедитесь, что VHDX-файл Windows Server 2016 находится в папке **Images** .

7. Настройте файл SDNExpress\scripts\FabricConfig.psd1, изменив **<< замените >>** Теги на конкретные значения в соответствии с инфраструктурой лаборатории, включая имена узлов, имена доменов, имя пользователя и пароль, а также сведения о сети для сетей, перечисленных в разделе Планирование сети.

8. Создайте запись узла A в DNS для Нетворкконтроллеррестнаме (FQDN) и Нетворкконтроллеррестип.

9. Запустите сценарий от имени пользователя с учетными данными администратора домена:

   ```
   SDNExpress\scripts\SDNExpress.ps1 -ConfigurationDataFile FabricConfig.psd1 -Verbose
   ```

10. Чтобы отменить все операции, выполните следующую команду:

   ```
    SDNExpress\scripts\SDNExpressUndo.ps1 -ConfigurationDataFile FabricConfig.psd1 -Verbose
   ```


#### <a name="validation"></a>Проверка

Предполагая, что сценарий SDN Express завершил работу без сообщения об ошибках, можно выполнить следующие действия, чтобы убедиться, что ресурсы структуры развернуты правильно и доступны для развертывания клиента.

Используйте [средства диагностики](../troubleshoot/troubleshoot-windows-server-software-defined-networking-stack.md) , чтобы убедиться в отсутствии ошибок в ресурсах структуры в сетевом контроллере.

   ```
   Debug-NetworkControllerConfigurationState -NetworkController <FQDN of Network Controller Rest Name>
   ```


### <a name="deploy-a-sample-tenant-workload-with-the-software-load-balancer"></a>Развертывание примера рабочей нагрузки клиента с помощью программной подсистемы балансировки нагрузки

Теперь, когда ресурсы структуры развернуты, можно проверить комплексное развертывание SDN, развернув пример рабочей нагрузки клиента. Эта Рабочая нагрузка клиента состоит из двух виртуальных подсетей (веб-уровень и уровень базы данных), защищенных с помощью правил списка управления доступом (ACL) с использованием распределенного брандмауэра SDN. Виртуальную подсеть веб-уровня можно получить с помощью SLB или МУЛЬТИПЛЕКСОРа, используя виртуальный IP-адрес (VIP). Сценарий автоматически развертывает две виртуальные машины веб-уровня и одну виртуальную машину уровня базы данных и подключает их к виртуальным подсетям.

1. Настройте файл SDNExpress\scripts\TenantConfig.psd1, изменив **<< замените >>** Теги на конкретные значения (например, имя образа VHD, имя сети сетевого контроллера, имя vSwitch и т. д., как ранее было определено в файле FabricConfig.psd1).

2. Выполните скрипт. Пример:

   ```
   SDNExpress\scripts\SDNExpressTenant.ps1 -ConfigurationDataFile TenantConfig.psd1 -Verbose
   ```

3. Чтобы отменить настройку, выполните тот же сценарий с параметром **Undo** . Пример:

   ```
   SDNExpress\scripts\SDNExpressTenant.ps1 -Undo -ConfigurationDataFile TenantConfig.psd1 -Verbose
   ```

#### <a name="validation"></a>Проверка

Чтобы проверить успешность развертывания клиента, выполните следующие действия.

1. Войдите на виртуальную машину уровня базы данных и попробуйте проверить связь с IP-адресом одной из виртуальных машин веб-уровня (убедитесь, что брандмауэр Windows отключен на виртуальных машинах веб-уровня).

2. Проверьте ресурсы клиента сетевого контроллера на наличие ошибок. Выполните следующую команду из любого узла Hyper-V с подключением уровня 3 к сетевому контроллеру:

   ```
   Debug-NetworkControllerConfigurationState -NetworkController <FQDN of Network Controller REST Name>
   ```

3. Чтобы убедиться, что балансировщик нагрузки работает правильно, выполните следующую команду с любого узла Hyper-V:

   ```
   wget <VIP IP address>/unique.htm -disablekeepalive -usebasicparsing
   ```

   где `<VIP IP address>` — это IP-адрес виртуального IP-адреса уровня, настроенный в файле TenantConfig.psd1.

   > [!TIP]
   > Найдите `VIPIP` переменную в TenantConfig.psd1.

   Выполните это несколько раз, чтобы увидеть переключение подсистемы балансировки нагрузки между доступными DIP. Это поведение можно также просмотреть с помощью веб-браузера. Перейдите по адресу `<VIP IP address>/unique.htm`. Закройте браузер и откройте новый экземпляр и повторите обзор. Вы увидите синюю страницу и альтернативу зеленой страницей, за исключением случаев, когда браузер кэширует страницу до истечения времени ожидания кэша.
