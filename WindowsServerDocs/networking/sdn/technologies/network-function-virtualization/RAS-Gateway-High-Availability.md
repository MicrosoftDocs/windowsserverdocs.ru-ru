---
title: Высокая доступность шлюза RAS-сервера
description: С помощью этого раздела вы узнаете о конфигурациях высокого уровня доступности для многоклиентского шлюза RAS в Windows Server 2016.
manager: grcusanz
ms.prod: windows-server
ms.technology: networking-sdn
ms.topic: get-started-article
ms.assetid: 34d826c9-65bc-401f-889d-cf84e12f0144
ms.author: anpaul
author: AnirbanPaul
ms.openlocfilehash: 774f0f4299bb5acbe7314080dd1314f74574d16d
ms.sourcegitcommit: b00d7c8968c4adc8f699dbee694afe6ed36bc9de
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/08/2020
ms.locfileid: "80859617"
---
# <a name="ras-gateway-high-availability"></a>Высокая доступность шлюза RAS-сервера

>Область применения: Windows Server (Semi-Annual Channel), Windows Server 2016

С помощью этого раздела вы узнаете о конфигурациях высокого уровня доступности для многоклиентского шлюза RAS для программно-определяемой сети (SDN).  
  
В этом разделе содержатся следующие подразделы:  
  
-   [Обзор шлюза RAS](#bkmk_overview)  
  
-   [Общие сведения о пулах шлюзов](#bkmk_pools)  
  
-   [Обзор развертывания шлюза RAS](#bkmk_deployment)  
  
-   [Интеграция шлюза RAS с сетевым контроллером](#bkmk_integration)  
  
## <a name="ras-gateway-overview"></a><a name="bkmk_overview"></a>Обзор шлюза RAS  
Если ваша организация является поставщиком облачных служб (CSP) или предприятием с несколькими клиентами, вы можете развернуть шлюз RAS в многоклиентский режим, чтобы обеспечить маршрутизацию сетевого трафика между виртуальными и физическими сетями, включая Интернет.  
  
Шлюз RAS можно развернуть в многоклиентном режиме в качестве пограничной шлюза для маршрутизации сетевого трафика клиентов клиента в виртуальные сети и ресурсы клиента.  
  
При развертывании нескольких экземпляров виртуальных машин шлюза RAS, обеспечивающих высокую доступность и отработку отказа, развертывается пул шлюзов. В Windows Server 2012 R2 все виртуальные машины шлюза были сформированы в одном пуле, что значительно усложняет логическое разделение развертывания шлюза.  Шлюз Windows Server 2012 R2 предлагает для виртуальных машин шлюза 1:1 избыточное развертывание, что привело к невозможности использования доступной емкости для VPN-подключений типа "сеть — сеть" (S2S).  
  
Эта проблема решена в Windows Server 2016, который предоставляет несколько пулов шлюзов, которые могут иметь различные типы для логического разделения. Новый режим избыточности в M + N обеспечивает более эффективную конфигурацию отработки отказа.  
  
Дополнительные сведения о шлюзе RAS см. в разделе [шлюз RAS](../../../../remote/remote-access/ras-gateway/RAS-Gateway.md).  
  
## <a name="gateway-pools-overview"></a><a name="bkmk_pools"></a>Общие сведения о пулах шлюзов  
В Windows Server 2016 шлюзы можно развернуть в одном или нескольких пулах.  
  
На следующем рисунке показаны различные типы пулов шлюзов, которые обеспечивают маршрутизацию трафика между виртуальными сетями.  
  
![Пулы шлюзов RAS](../../../media/RAS-Gateway-High-Availability/ras_pools.png)  
  
Каждый пул имеет следующие свойства.  
  
-   Каждый пул имеет резервирование M + N. Это означает, что количество виртуальных машин активного шлюза зарезервировано числом "N" виртуальных машин резервного шлюза. Значение N (Резервные шлюзы) всегда меньше или равно M (активные шлюзы).  
  
-   Пул может выполнять любую из отдельных функций шлюза: протокол IKE версии 2 (IKEv2) S2S, уровня 3 (L3) и протокола GRE, или пул может выполнять все эти функции.  
  
-   Можно назначить один общедоступный IP-адрес всем пулам или подмножеству пулов. Это значительно сокращает количество общедоступных IP-адресов, которые необходимо использовать, так как все клиенты могут подключаться к облаку по одному IP-адресу. В разделе, посвященном высокой доступности и балансировке нагрузки, описывается, как это работает.  
  
-   Вы можете легко масштабировать пул шлюзов, добавляя или удаляя виртуальные машины шлюза в пуле. Удаление или добавление шлюзов не приводит к нарушению работы служб, предоставляемых пулом. Также можно добавлять и удалять целые пулы шлюзов.  
  
-   Подключения одного клиента могут завершаться на нескольких пулах и в пуле. Однако если у клиента есть подключения, завершающие работу в пуле **всех** типов, он не может подписываться на другие пулы **всех** типов или отдельных шлюзов.  
  
Пулы шлюзов также обеспечивают гибкость для включения дополнительных сценариев:  
  
-   Пулы с одним клиентом. Вы можете создать один пул для использования одним клиентом.  
  
-   При продаже облачных служб через каналы партнеров (торговых посредников) можно создать отдельные наборы пулов для каждого торгового посредника.  
  
-   Несколько пулов могут предоставлять одну и ту же функцию шлюза, но разные емкости. Например, можно создать пул шлюзов, поддерживающий высокую пропускную способность и низкую пропускную способность подключений S2S.  
  
## <a name="ras-gateway-deployment-overview"></a><a name="bkmk_deployment"></a>Обзор развертывания шлюза RAS  
На следующем рисунке показано типичное развертывание шлюза RAS поставщиком облачных служб (CSP).  
  
![Обзор развертывания шлюза RAS](../../../media/RAS-Gateway-High-Availability/ras_csp_deploy.png)  
  
С этим типом развертывания пулы шлюзов развертываются за Load Balancer программного обеспечения (SLB), что позволяет CSP назначать один общедоступный IP-адрес для всего развертывания. Несколько подключений шлюза клиента могут завершаться на нескольких пулах шлюзов, а также на нескольких шлюзах в пуле. Это проиллюстрировано подключениями по протоколу IKEv2 S2S на приведенной выше схеме, но они также применимы и к другим функциям шлюза, например к шлюзам L3 и GRE.  
  
На рисунке устройство BGP MT — это многоклиентский шлюз RAS с BGP. Для динамической маршрутизации используется протокол BGP для клиентов. Маршрутизация для клиента централизована — это единая точка, называемая отражательом маршрутов (RR), которая обрабатывает пиринг BGP для всех сайтов клиентов. Сама запись ресурса распределяется по всем шлюзам в пуле. Это приводит к конфигурации, в которой подключения клиента (пути к данным) прерываются на нескольких шлюзах, но запись ресурса для клиента (путь управления точками пиринга BGP) находится только на одном из шлюзов.  
  
Маршрутизатор BGP отделен на схеме, чтобы определить концепцию централизованной маршрутизации. Реализация BGP шлюза также обеспечивает транзитную маршрутизацию, которая позволяет облаку работать в качестве точки передачи для маршрутизации между двумя сайтами клиента. Эти возможности BGP применимы ко всем функциям шлюза.  
  
## <a name="ras-gateway-integration-with-network-controller"></a><a name="bkmk_integration"></a>Интеграция шлюза RAS с сетевым контроллером  
Шлюз RAS полностью интегрирован с сетевым контроллером в Windows Server 2016. При развертывании шлюза RAS и сетевого контроллера сетевой контроллер выполняет следующие функции.  
  
-   Развертывание пулов шлюзов  
  
-   Настройка подключений клиентов в каждом шлюзе  
  
-   Переключение сетевого трафика на резервный шлюз в случае сбоя шлюза  
  
В следующих разделах содержатся подробные сведения о шлюзе RAS и сетевом контроллере.  
  
-   [Подготовка и балансировка нагрузки подключений шлюза (IKEv2, L3 и GRE)](#bkmk_provisioning)  
  
-   [Высокий уровень доступности для IKEv2 S2S](#bkmk_ike)  
  
-   [Высокий уровень доступности для GRE](#bkmk_gre)  
  
-   [Высокий уровень доступности для шлюзов пересылки L3](#bkmk_l3)  
  
### <a name="provisioning-and-load-balancing-of-gateway-connections-ikev2-l3-and-gre"></a><a name="bkmk_provisioning"></a>Подготовка и балансировка нагрузки подключений шлюза (IKEv2, L3 и GRE)  
Когда клиент запрашивает подключение к шлюзу, запрос отправляется сетевому контроллеру. Сетевой контроллер настраивается со сведениями обо всех пулах шлюзов, включая емкость каждого пула и каждого шлюза в каждом пуле. Сетевой контроллер выбирает правильный пул и шлюз для подключения. Этот выбор основан на требованиях к пропускной способности для подключения. Сетевой контроллер использует алгоритм наилучшего соответствия для эффективного выбора подключений в пуле. В данный момент также назначена точка пиринга BGP для подключения, если это первое подключение клиента.  
  
После того как сетевой контроллер выберет шлюз RAS для подключения, сетевой контроллер подготавливает необходимую конфигурацию для подключения к шлюзу. Если подключение является S2S-подключением по протоколу IKEv2, сетевой контроллер также подготавливает правило преобразования сетевых адресов (NAT) в пуле SLB. Это правило NAT в пуле SLB направляет запросы на соединение от клиента к назначенному шлюзу. Клиенты отличаются исходным IP-адресом, который должен быть уникальным.  
  
> [!NOTE]  
> Подключения L3 и GRE обходят SLB и подключаются непосредственно к назначенному шлюзу RAS.  Для этих подключений необходимо правильно настроить маршрутизатор удаленной конечной точки (или другое устройство стороннего производителя) для подключения к шлюзу RAS.  
  
Если для подключения включена маршрутизация BGP, то пиринг BGP инициируется шлюзом RAS, а маршруты обмениваются между локальным и облачным шлюзами. Маршруты, полученные по протоколу BGP (или статически настроенные маршруты, если BGP не используется), отправляются на сетевой контроллер. Затем сетевой контроллер применяет маршруты к узлам Hyper-V, на которых установлены виртуальные машины клиента. На этом этапе трафик клиента можно направить на правильный локальный сайт. Сетевой контроллер также создает связанные политики виртуализации сети Hyper-V, которые указывают расположения шлюзов и обслуживают их на узлах Hyper-V.  
  
### <a name="high-availability-for-ikev2-s2s"></a><a name="bkmk_ike"></a>Высокий уровень доступности для IKEv2 S2S  
Шлюз RAS в пуле состоит из подключений и пиринга BGP для разных клиентов. Каждый пул имеет "активные шлюзы" и "N" Резервные шлюзы.  
  
Сетевой контроллер обрабатывает сбой шлюзов следующим образом.  
  
-   Сетевой контроллер постоянно проверяет связь со шлюзами во всех пулах и может обнаружить неисправность или сбой шлюза. Сетевой контроллер может обнаружить следующие типы сбоев шлюза RAS.  
  
    -   Сбой виртуальной машины шлюза RAS  
  
    -   Сбой узла Hyper-V, на котором выполняется шлюз RAS  
  
    -   Сбой службы шлюза RAS  
  
    Сетевой контроллер хранит конфигурацию всех развернутых активных шлюзов. Конфигурация состоит из параметров подключения и параметров маршрутизации.  
  
-   В случае сбоя шлюза он влияет на подключения клиентов в шлюзе, а также на подключения клиентов, расположенные на других шлюзах, но запись ресурса находится на шлюзе, который не работает. Время простоя последних подключений меньше первого. Когда сетевой контроллер обнаруживает неисправный шлюз, он выполняет следующие задачи.  
  
    -   Удаляет маршруты затронутых подключений с узлов вычислений.  
  
    -   Удаляет политики виртуализации сети Hyper-V на этих узлах.  
  
    -   Выбирает резервный шлюз, преобразует его в активный шлюз и настраивает шлюз.  
  
    -   Изменяет сопоставления NAT в пуле SLB, чтобы они указывали на подключения к новому шлюзу.  
  
-   Одновременно, как только конфигурация поступает на новый активный шлюз, подключения IKEv2 S2S и пиринг BGP устанавливаются повторно. Подключения и пиринг BGP могут инициироваться либо облачным шлюзом, либо локальным шлюзом. Шлюзы обновляют маршруты и отправляют их на сетевой контроллер. После того как сетевой контроллер узнает о новых маршрутах, обнаруженных шлюзами, сетевой контроллер отправляет маршруты и связанные политики виртуализации сети Hyper-V на узлы Hyper-V, где находятся виртуальные машины клиентов, на которых произошел сбой. Эта активность сетевого контроллера аналогична ситуации новой настройки подключения, но она выполняется только в масштабе большей масштабируемости.  
  
### <a name="high-availability-for-gre"></a><a name="bkmk_gre"></a>Высокий уровень доступности для GRE  
Процесс ответа шлюза RAS от сетевого контроллера, включая обнаружение сбоев, копирование конфигурации подключения и маршрутизации в резервный шлюз, отработка отказа маршрутизации BGP/static для затронутых подключений (включая списание и повторное подключение маршрутов на узлах вычислений и повторное пиринг BGP) и перенастройка политик виртуализации сети Hyper-V на выпусках вычислений — одинаковая для шлюзов и подключений GRE. Однако повторное установление соединений GRE происходит по-разному, а в решении высокой доступности для GRE есть некоторые дополнительные требования.  
  
![Высокий уровень доступности для GRE](../../../media/RAS-Gateway-High-Availability/ras_ha.png)  
  
Во время развертывания шлюза каждой виртуальной машине шлюза RAS назначается динамический IP-адрес (DIP). Кроме того, каждой виртуальной машине шлюза также назначается виртуальный IP-адрес (VIP) для обеспечения высокой доступности GRE. Виртуальные IP-адреса назначаются только шлюзам в пулах, которые могут принимать подключения GRE, а не к пулам, отличным от GRE. Назначенные виртуальные IP-адреса объявляются в верхней части коммутаторов стойки (TOR) с помощью протокола BGP, что затем дополнительно объявляет VIP в физической сети облака. Это сделает шлюзы доступными для удаленных маршрутизаторов или сторонних устройств, где находится другой конец подключения GRE. Этот пиринг BGP отличается от пиринга BGP на уровне клиента для обмена маршрутами клиента.  
  
Во время подготовки подключения GRE сетевой контроллер выбирает шлюз, настраивает конечную точку GRE на выбранном шлюзе и возвращает обратно виртуальный IP-адрес назначенного шлюза. Затем этот виртуальный IP-адрес настраивается в качестве адреса туннельного туннеля GRE на удаленном маршрутизаторе.  
  
При сбое шлюза сетевой контроллер копирует виртуальный IP-адрес шлюза со сбоем и другие данные конфигурации в резервный шлюз. Когда резервный шлюз станет активным, он объявляет виртуальный IP-адрес коммутатору TOR и далее в физическую сеть. Удаленные маршрутизаторы по-прежнему соединяют туннели GRE с одним и тем же виртуальным IP-адресом, и инфраструктура маршрутизации гарантирует, что пакеты будут направляться в новый активный шлюз.  
  
### <a name="high-availability-for-l3-forwarding-gateways"></a><a name="bkmk_l3"></a>Высокий уровень доступности для шлюзов пересылки L3  
Шлюз перенаправления третьего уровня виртуализации сети Hyper-V — это мост между физической инфраструктурой в центре обработки данных и виртуализированной инфраструктурой в облаке виртуализации сети Hyper-V. На многоклиентном шлюзе перенаправления L3 каждый клиент использует собственную логическую сеть с меткой VLAN для подключения к физической сети клиента.  
  
Когда новый клиент создает новый шлюз L3, шлюз сетевого контроллера Service Manager выбирает доступную виртуальную машину шлюза и настраивает новый интерфейс клиента, используя IP-адрес (из логической сети, обозначенного тегом VLAN клиента), с высоким уровнем доступности. ). IP-адрес используется как одноранговый IP-адрес на удаленном шлюзе (физической сети) и является следующим прыжком для доступа к сети виртуализации сети Hyper-V клиента.  
  
В отличие от сетевых подключений по протоколу IPsec или GRE, параметр TOR не будет динамически изучать помеченную сетью виртуальную ЛС. Для обеспечения сквозного подключения необходимо настроить маршрутизацию для сети с отметкой VLAN клиента на коммутаторе TOR и всех промежуточных коммутаторах и маршрутизаторах между физической инфраструктурой и шлюзом.  Ниже приведен пример конфигурации виртуальной сети CSP, как показано на рисунке ниже.  
  
|Сеть|Подсеть|ИД ВИРТУАЛЬНОЙ ЛС|Шлюз по умолчанию|  
|-----------|----------|-----------|-------------------|  
|Логическая сеть Contoso L3|10.127.134.0/24|1001|10.127.134.1|  
|Логическая сеть Woodgrove третьего уровня|10.127.134.0/24|1002|10.127.134.1|  
  
Ниже приведены примеры конфигураций шлюза клиента, как показано на рисунке ниже.  
  
|Имя клиента|IP-адрес шлюза L3|ИД ВИРТУАЛЬНОЙ ЛС|Одноранговый IP-адрес|  
|---------------|-------------------------|-----------|-------------------|  
|Contoso|10.127.134.50|1001|10.127.134.55|  
|Woodgrove|10.127.134.60|1002|10.127.134.65|  
  
Ниже приведена иллюстрация этих конфигураций в центре обработки данных CSP.  
  
![Высокий уровень доступности для шлюзов пересылки L3](../../../media/RAS-Gateway-High-Availability/ras_fwdgw.png)  
  
Сбои шлюза, обнаружение сбоев и процесс отработки отказа шлюза в контексте шлюза перенаправления L3 аналогичны процессам для шлюзов RAS IKEv2 и GRE. Разница заключается в способе обработки внешних IP-адресов.  
  
Когда состояние виртуальной машины шлюза станет неработоспособным, сетевой контроллер выбирает один из резервных шлюзов из пула и повторно подготавливает сетевые подключения и маршрутизацию на резервном шлюзе. При перемещении подключений IP-адрес "высокодоступного" шлюза перенаправления L3 также перемещается на новую виртуальную машину шлюза вместе с IP-адресом BGP в пространстве ЦС.  
  
Так как IP-адрес пиринга уровня L3 перемещается на новую виртуальную машину шлюза во время отработки отказа, удаленная физическая инфраструктура снова сможет подключаться к этому IP-адресу, а затем достигать рабочей нагрузки виртуализации сети Hyper-V. Для динамической маршрутизации BGP при перемещении IP-адреса BGP из центра сертификации в новую виртуальную машину шлюза удаленный маршрутизатор BGP может повторно установить пиринг и снова изучить все маршруты виртуализации сети Hyper-V.  
  
> [!NOTE]  
> Необходимо отдельно настроить параметры TOR и все промежуточные маршрутизаторы, чтобы использовать логическую сеть с тегами для взаимодействия с клиентами. Кроме того, отработка отказа L3 ограничивается только стойками, которые настроены таким образом. По этой причине пул шлюзов L3 должен быть тщательно настроен, а Настройка вручную должна быть выполнена отдельно.  
  


