---
title: Высокая доступность шлюза RAS-сервера
description: Дополнительные сведения о конфигурации высокого уровня доступности для Мультитенантного шлюза RAS для программно определяемой сети (SDN) в Windows Server 2016 можно использовать в этом разделе.
manager: brianlic
ms.custom: na
ms.prod: windows-server-threshold
ms.reviewer: na
ms.suite: na
ms.technology: networking-sdn
ms.tgt_pltfrm: na
ms.topic: get-started-article
ms.assetid: 34d826c9-65bc-401f-889d-cf84e12f0144
ms.author: pashort
author: shortpatti
ms.openlocfilehash: 8ce515ceeb7ab6989ef18055f312983a6518a1a1
ms.sourcegitcommit: 0d0b32c8986ba7db9536e0b8648d4ddf9b03e452
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2019
ms.locfileid: "59847765"
---
# <a name="ras-gateway-high-availability"></a>Высокая доступность шлюза RAS-сервера

>Относится к: Windows Server (полугодовой канал), Windows Server 2016

Дополнительные сведения о конфигурации высокого уровня доступности для Мультитенантного шлюза RAS для программно определяемой сети (SDN) можно использовать в этом разделе.  
  
Эта статья содержит следующие разделы.  
  
-   [Обзор шлюза RAS](#bkmk_overview)  
  
-   [Общие сведения о пулах шлюза](#bkmk_pools)  
  
-   [Обзор развертывания шлюза RAS](#bkmk_deployment)  
  
-   [Интеграция шлюза удаленного доступа с помощью сетевого контроллера](#bkmk_integration)  
  
## <a name="bkmk_overview"></a>Обзор шлюза RAS  
Если ваша организация — поставщик облачных служб (CSP) или предприятия с несколькими клиентами, вы можете развернуть шлюз удаленного доступа в мультитенантном режиме для обеспечения Маршрутизация трафика в сети и из виртуальными и физическими сетями, включая Интернет.  
  
Вы можете развернуть шлюз удаленного доступа в мультитенантном режиме как шлюз edge маршрутизировать трафик клиента клиента для клиента виртуальные сети и ресурсы.  
  
При развертывании нескольких экземпляров виртуальных машин шлюза удаленного доступа, обеспечения высокой доступности и отработки отказа, вы развертываете пул шлюзов. В Windows Server 2012 R2 шлюз, виртуальные машины формат один пул, который немного затруднено логическое разделение развертывания шлюза.  Шлюз Windows Server 2012 R2 предлагается развертывание 1:1 избыточность для виртуальных машин, которые привело заниженных использования свободного дискового пространства для сайтами (S2S) к VPN-подключений шлюза.  
  
Эта проблема устранена в Windows Server 2016, который предоставляет несколько пулов шлюза — который может быть разных типов для логического разделения. Новый режим избыточностью M + N позволяет более эффективно конфигурации отработки отказа.  
  
Дополнительные сведения о шлюза RAS см. в разделе [шлюза RAS](../../../../remote/remote-access/ras-gateway/RAS-Gateway.md).  
  
## <a name="bkmk_pools"></a>Общие сведения о пулах шлюза  
В Windows Server 2016 вы можете развернуть шлюзы в один или несколько пулов.  
  
Ниже показаны различные виды пулов шлюзов, которые обеспечивают маршрутизацию трафика между виртуальными сетями.  
  
![Пулы шлюза RAS](../../../media/RAS-Gateway-High-Availability/ras_pools.png)  
  
Каждый пул имеет следующие свойства.  
  
-   Каждый пул имеет избыточностью M + N. Это означает, что меня "число виртуальных машин шлюза active резервное копирование по номеру" n "виртуальные машины ожидания шлюза. Значение N (резервный шлюзы) всегда будет меньше или равно M (активные шлюзы).  
  
-   Пул можно выполнить любую из функций, отдельные шлюза — протокол IKE версия 2 (IKEv2) S2S, третьего уровня (L3) и протоколом (GRE) - или пуле можно выполнять все эти функции.  
  
-   Можно назначить один общедоступный IP-адрес для всех пулов или подмножество пулов. Это позволит в значительной мере уменьшает количество общедоступных IP-адресов, которые необходимо использовать, так как это может быть подключение к облаку на один IP-адрес всех клиентов. В разделе ниже высокий уровень доступности и балансировки нагрузки описывает, как это работает.  
  
-   Можно легко масштабировать пул шлюзов вверх или вниз путем добавления или удаления виртуальных машин шлюза в пуле. Удаления или добавления шлюзов не нарушить работу службы, которые предоставляются с помощью пула. Кроме того, можно также добавлять и удалять весь пулов шлюзов.  
  
-   Подключения к одному клиенту может завершить работу по нескольким пулам и несколько шлюзов в пуле. Тем не менее если клиент использует завершающуюся подключений **все** введите пул шлюзов, его нельзя подписаться на другие **все** типа или отдельного типа пулов шлюзов.  
  
Пулы шлюза также обеспечивают гибкость, чтобы включить дополнительные сценарии:  
  
-   Пулы одним клиентом — можно создать один пул для использования одного клиента.  
  
-   Если вы продаете облачных служб через партнеров (торгового посредника), можно создать отдельные наборы пулов для каждого торгового посредника.  
  
-   Несколько пулов можно указать ту же функцию шлюза, но различные мощности. Например можно создать пул шлюзов, который поддерживает высокую пропускную способность и низкую пропускную способность IKEv2 S2S-подключений.  
  
## <a name="bkmk_deployment"></a>Обзор развертывания шлюза RAS  
На следующем рисунке показано типичное развертывание шлюза RAS поставщика облачных служб (CSP).  
  
![Обзор развертывания шлюза RAS](../../../media/RAS-Gateway-High-Availability/ras_csp_deploy.png)  
  
С этим типом развертывания пулы шлюза развертываются за программное обеспечение нагрузки Подсистему балансировки, позволяющий CSP назначить один общедоступный IP-адрес для всего развертывания. Несколько подключений шлюза клиента может завершить несколько пулов шлюзов -, а также несколько шлюзов в пуле. Это показано через подключения IKEv2 S2S на схеме выше, но то же самое применимо к другим функциям шлюза, таких как шлюзы уровня 3 и GRE.  
  
На рисунке MT BGP устройство работает с использованием BGP Мультитенантного шлюза RAS. Мультитенантные BGP используется для динамической маршрутизации. Маршрутизация для клиента централизован - единой точки, называется рефлектор маршрутов (RR), обрабатывает пиринга BGP для всех клиентских сайтов. RR, сам распределяется по все шлюзы в пуле. Это приводит к конфигурации, где завершить соединения клиента (путь к данным) на несколько шлюзов, но запись Ресурса для клиента (BGP пиринг точка - путь в системе управления) только на одном из шлюзов.  
  
Маршрутизатор BGP разделена на схеме остроконечные централизованной маршрутизации. Реализации протокола BGP шлюза также Транзитная маршрутизация, позволяющее облаке в качестве транзитного пункта для маршрутизации между двумя клиентских сайтов. Эти возможности BGP применимы ко всем функциям шлюза.  
  
## <a name="bkmk_integration"></a>Интеграция шлюза удаленного доступа с помощью сетевого контроллера  
Шлюз RAS полностью интегрирован с сетевого контроллера в Windows Server 2016. При развертывании шлюза RAS и сетевом контроллере, сетевой контроллер выполняет следующие функции.  
  
-   Развертывание пулов шлюзов  
  
-   Настройку подключений клиента на каждом шлюзе  
  
-   Переключение сетевой трафик передается резервный шлюз в случае сбоя шлюза  
  
Следующие разделы предоставляют подробные сведения о шлюза RAS и сетевом контроллере.  
  
-   [Подготовка и балансировка нагрузки подключений шлюза (IKEv2, L3 и GRE)](#bkmk_provisioning)  
  
-   [Высокий уровень доступности для IKEv2 S2S](#bkmk_ike)  
  
-   [Высокий уровень доступности для GRE](#bkmk_gre)  
  
-   [Высокий уровень доступности для уровня 3 пересылки шлюзов](#bkmk_l3)  
  
### <a name="bkmk_provisioning"></a>Подготовка и балансировка нагрузки подключений шлюза (IKEv2, L3 и GRE)  
Когда клиент запрашивает подключения шлюза, запрос отправляется к сетевому контроллеру. Сетевой контроллер выполняется настройка сведений о всех пулов шлюза, включая емкость каждого пула и у каждого шлюза в каждом пуле. Сетевой контроллер выбирает правильные пула и шлюза для подключения. Этот выбор зависит от пропускной способности требований к подключению. Сетевой контроллер использует алгоритм «best fit» эффективно подбор подключений в пул. Точку пиринга BGP для подключения также обозначается в настоящее время, если это первое подключение клиента.  
  
После того как сетевой контроллер выберет шлюз RAS для подключения, сетевой контроллер подготавливает необходимой конфигурации для подключения к шлюзу. Если подключение установлено подключение IKEv2 S2S, сетевой контроллер также подготовку правила преобразования сетевых адресов (NAT) в пуле SLB; Это правило преобразования сетевых адресов в пуле SLB направляет запросы на подключение от клиента к предназначенным шлюзом. Клиенты различаются по исходный IP-адрес, который должен быть уникальным.  
  
> [!NOTE]  
> Подключения уровня 3 и GRE обходить SLB и напрямую связываться с указанного шлюза RAS.  Для этих подключений требуются, что маршрутизатор удаленной конечной точки (или другое устройство третьих лиц) должны быть правильно настроены для подключения с помощью шлюза RAS.  
  
Если включена маршрутизация BGP для подключения, а затем пиринга BGP инициируется шлюза RAS - и маршруты передаются между локальной и облачной шлюзов. Маршруты, обучаются по BGP (или, которые статически настроенных маршрутов, если не используется BGP) отправляются на сетевом контроллере. Сетевой контроллер, затем настраивает маршруты вниз, чтобы узлы Hyper-V, на которых установлены клиентские виртуальные машины. На этом этапе можно перенаправить трафик клиента правильный на локальном сайте. Сетевой контроллер также создает связанные политики виртуализации сети Hyper-V, определяющих расположение шлюза и настраивает их вниз, чтобы узлы Hyper-V.  
  
### <a name="bkmk_ike"></a>Высокий уровень доступности для IKEv2 S2S  
Шлюз RAS в пуле состоит как из соединения и пиринга BGP разных клиентов. Каждый пул имеет меня "Активные шлюзы и шлюзы резервный" n ".  
  
Сетевой контроллер корректно реагирует на сбой шлюзов следующим образом.  
  
-   Сетевой контроллер постоянно проверок связи шлюзов во всех пулах и может обнаруживать шлюза, которая выполнила или регистрации сбоя. Сетевой контроллер может обнаруживать следующие типы сбоев шлюза RAS.  
  
    -   Сбой виртуальной Машины шлюза RAS  
  
    -   Сбой узла Hyper-V, на котором работает шлюз RAS  
  
    -   Сбой службы шлюза RAS  
  
    Сетевой контроллер сохраняет конфигурацию всех развернутых шлюзов active. Конфигурация состоит из параметров подключения и настройки маршрутизации.  
  
-   В случае сбоя шлюза влияет на подключения клиента к шлюзу, а также подключения клиента, расположенные на другие шлюзы, но которых RR находится на шлюза со сбоем. Время простоя. последний соединений меньше, чем первый. Сетевой контроллер, обнаружив шлюза со сбоем, он выполняет следующие задачи.  
  
    -   Удаляет маршруты соответствующих подключений от вычислительных узлов.  
  
    -   Удалит все политики виртуализации сети Hyper-V на этих узлах.  
  
    -   Выбирает резервный шлюз, преобразует его в активный шлюз и настраивает шлюза.  
  
    -   Изменение сопоставлений NAT в пуле SLB для точки подключения к новому шлюзу.  
  
-   Одновременно как появится конфигурацию на новый активный шлюз подключения IKEv2 S2S и пиринга BGP, снова устанавливается. Подключения и пиринга BGP может быть инициировано облачным шлюзом или локальный шлюз. Шлюзы обновите маршруты и отправлять их в сетевой контроллер. После сетевого контроллера определяет новый маршруты, обнаруженные шлюзов, сетевой контроллер отправляет маршруты и соответствующие политики виртуализации сети Hyper-V узлов Hyper-V которых размещаются виртуальные машины клиентов повлиять сбой. Аналогично это действие сетевого контроллера в случае новой установки подключения она происходит только в большем масштабе.  
  
### <a name="bkmk_gre"></a>Высокий уровень доступности для GRE  
Процесс ответ отработки отказа шлюза RAS сетевым контроллером - включая обнаружение сбоев, копирование подключения и маршрутизации в резервный шлюз, на другой ресурс для маршрутизации BGP (или) статического затронутые подключений (включая списания и повторно магистраль маршрутов на вычислительные узлы и повторно пиринга BGP), и повторной настройки политик виртуализации сети Hyper-V на вычислительных узлах — одинаков для GRE шлюзов и подключений. Повторную установку подключений GRE происходит по-разному, но и решение высокого уровня доступности для GRE имеет некоторые дополнительные требования.  
  
![Высокий уровень доступности для GRE](../../../media/RAS-Gateway-High-Availability/ras_ha.png)  
  
Во время развертывания шлюза Каждая виртуальная машина шлюза RAS назначается динамический IP-адрес (DIP). Кроме того у каждого шлюза виртуальной Машины также назначается виртуальный IP-адрес (VIP) для обеспечения высокой доступности GRE. Виртуальные IP-адреса назначаются, только для шлюзов в пулах, которые могут принимать подключения GRE, а не к пулы не GRE. Назначить VIP-адресов, объявляются в верхнюю часть коммутаторов (tor), с использованием протокола BGP, в которой Дополнительно объявляет VIP-адресов в облаке физической сети. В результате шлюзы доступен из удаленного маршрутизаторов или устройств сторонних размещения другом конце подключения GRE. Этот пиринг BGP отличается от уровня клиента сеансов BGP для обмена маршрутами клиента.  
  
Во время подготовки подключения GRE сетевой контроллер выбирает шлюз, настраивает конечную точку GRE для выбранного шлюза и возвращено виртуальный IP-адрес, назначенный шлюза. Затем этот виртуальный IP-адрес настроен как назначение адресов туннеля GRE на удаленном маршрутизаторе.  
  
В случае сбоя шлюза сетевого контроллера копирует виртуальный IP-адрес шлюза со сбоем и другие данные конфигурации для ожидания шлюза. Когда резервный шлюз становится активным, он объявляет виртуальный IP-адрес для своего коммутатора TOR и дальнейшего физической сети. Для подключения туннели GRE же виртуальный IP-адрес по-прежнему удаленные маршрутизаторы и инфраструктуре маршрутизации гарантирует, что пакеты направляются в новый активный шлюз.  
  
### <a name="bkmk_l3"></a>Высокий уровень доступности для уровня 3 пересылки шлюзов  
Шлюз переадресации L3 виртуализации сети Hyper-V представляет собой мост между физической инфраструктурой в центре обработки данных и виртуализированной инфраструктурой в облаке виртуализации сети Hyper-V. В мультитенантном шлюзе переадресации L3 каждый клиент использует собственную виртуальной локальной сети с тегами логической сети для подключения к физической сети клиента.  
  
Когда новый клиент создает новый шлюз L3, сетевой контроллер шлюз Service Manager выбирает шлюз, доступных виртуальной Машине и настраивает новый интерфейс клиента высокой доступности адреса клиента (ак) пространства IP-адрес (из клиента виртуальной локальной сети с тегами логической сети ). IP-адрес используется в качестве однорангового IP-адрес шлюза удаленного (физической сети) и является следующий прыжок для доступа к сети клиента виртуализации сети Hyper-V.  
  
В отличие от сетевых подключений IPsec или GRE коммутатора TOR не узнаете сеть с тегами виртуальной локальной сети клиента динамически. Маршрут для сети с тегами виртуальной локальной сети клиента должна быть настроена на коммутаторе TOR и все промежуточные коммутаторы и маршрутизаторы между физической инфраструктуры и шлюзом для обеспечения сквозного подключения.  Ниже приведен пример конфигурации CSP виртуальной сети, как показано на следующем рисунке.  
  
|Network|Подсеть|ИД виртуальной ЛС|Шлюз по умолчанию|  
|-----------|----------|-----------|-------------------|  
|Логическую сеть Contoso L3|10.127.134.0/24|1001|10.127.134.1|  
|Логическую сеть Woodgrove L3|10.127.134.0/24|1002|10.127.134.1|  
  
Ниже приведены примеры конфигураций шлюза клиента, как показано на следующем рисунке.  
  
|Имя клиента|IP-адреса шлюза уровня 3|ИД виртуальной ЛС|IP-адрес узла|  
|---------------|-------------------------|-----------|-------------------|  
|Contoso|10.127.134.50|1001|10.127.134.55|  
|Woodgrove|10.127.134.60|1002|10.127.134.65|  
  
Ниже приведен на рисунке этих конфигураций в центре обработки данных CSP.  
  
![Высокий уровень доступности для уровня 3 пересылки шлюзов](../../../media/RAS-Gateway-High-Availability/ras_fwdgw.png)  
  
Сбои шлюза, обнаружение сбоев и процесс перехода на другой ресурс шлюза в контексте L3 шлюза перенаправления похоже на процессы для IKEv2 и шлюзов RAS GRE. Приведены различия в обработке внешних IP-адресов являются.  
  
Когда переходит в неработоспособное состояние виртуальной Машины шлюза, сетевой контроллер выбирает один из режима ожидания шлюзов из пула и выполняет повторное провизионирование сетевые подключения и маршрутизации на резервный шлюз. Высокой перемещения на подключения, шлюз переадресации L3 доступный ЦС пространства IP-адрес также перемещается в новый шлюз виртуальной Машины вместе с пространстве ак BGP IP-адрес клиента.  
  
Так как адрес IP-адрес Пиринга уровня 3 перемещается в новый шлюз виртуальной Машины при отработке отказа, удаленного физической инфраструктуры способен попытку соединиться с этого IP-адреса и, как следствие, нагрузки виртуализации сети Hyper-V. Для динамической маршрутизации BGP, как ЦС пространство IP-адреса BGP перемещается в новый шлюз виртуальной Машины, удаленного маршрутизатора BGP можно повторно установить пиринг и узнайте все маршруты виртуализации сети Hyper-V, еще раз.  
  
> [!NOTE]  
> Для использования с тегами логической сетью виртуальной ЛС для обмена данными клиента, необходимо отдельно настроить коммутаторы TOR и все промежуточные маршрутизаторы. Кроме того L3 отработки отказа будет ограничен только той стойке, которые настроены таким образом. По этой причине пул шлюзов L3 должна быть тщательно настроена, и ручной настройки должен выполняться по отдельности.  
  


