---
title: Техническое описание виртуализации сети Hyper-V в Windows Server 2016
description: Этот раздел содержит технические сведения о виртуализации сети Hyper-V в Windows Server 2016
manager: brianlic
ms.custom: na
ms.prod: windows-server-threshold
ms.reviewer: na
ms.service: virtual-network
ms.suite: na
ms.technology: networking-sdn
ms.tgt_pltfrm: na
ms.topic: article
ms.assetid: 9efe0231-94c1-4de7-be8e-becc2af84e69
ms.author: pashort
author: shortpatti
ms.openlocfilehash: b33c96ff7150b0dc4f6f93d2fa24741c9762a799
ms.sourcegitcommit: afb0602767de64a76aaf9ce6a60d2f0e78efb78b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/20/2019
ms.locfileid: "67282287"
---
# <a name="hyper-v-network-virtualization-technical-details-in-windows-server-2016"></a>Техническое описание виртуализации сети Hyper-V в Windows Server 2016

>Относится к:  Windows Server 2016

Виртуализация серверов позволяет нескольким серверам работать одновременно на едином физическом узле; при этом указанные серверы остаются взаимно изолированными. По существу, каждая виртуальная машина работает как единственный сервер на данном физическом компьютере.  

Виртуализация сети обеспечивает те же возможности, в которых несколько виртуальных сетей (потенциально с перекрывающимися IP-адресами) запускается на том же физической сетевой инфраструктуры и каждой виртуальной сети работает, если это единственный виртуальный сети, работающей общей сетевой инфраструктуре. Рисунок 1 демонстрирует эти отношения.  

![Виртуализация серверов в сравнении с виртуализацией сетей](../../../media/hyper-v-network-virtualization-technical-details-in-windows-server/VNetF1.gif)  

Рисунок 1. Виртуализация серверов в сравнении с виртуализацией сетей  

## <a name="hyper-v-network-virtualization-concepts"></a>Концепции виртуализации сетей Hyper-V  
В виртуализации сети Hyper-V (HNV) заказчика или клиент определяется как «владелец» набор IP-подсетей, которые развертываются в enterprise или datacenter. Клиентом может быть корпорация или предприятие с несколькими отделами или бизнес-единицы в частном центре обработки данных, которые требуют сетевой изоляции или клиента в центре общих данных, которое размещено у поставщика услуг. Каждый клиент может иметь один или несколько [виртуальные сети](#VirtualNetworks) в центре обработки данных и каждой виртуальной сети состоит из одного или нескольких [подсети виртуальной](#VirtualSubnets).  

Существует две реализации HNV, которые будут доступны в Windows Server 2016. HNVv1 и HNVv2.  

-   **HNVv1**  

    HNVv1 совместима с Windows Server 2012 R2 VMM и System Center 2012 R2 Virtual Machine Manager (). Конфигурация для HNVv1 полагается на управление WMI и командлеты Windows PowerShell (в виде System Center VMM) для определения параметров изоляции и адреса клиента (ак) — виртуальная сеть — к сопоставлениям физический адрес (PA) и маршрутизации. Дополнительные компоненты не были добавлены HNVv1 в Windows Server 2016 и мы планируем нет новых функций.  

    • НАСТРОЙТЕ карт и HNV V1 не совместимы с платформой.

    o для использования высокого уровня ДОСТУПНОСТИ NVGRE шлюзы пользователей нужно либо использовать группы LBFO или не группа. или

    o приведена сетевого контроллера для развернутых шлюзов с помощью НАБОРА объединенные коммутатора.


-   **HNVv2**  

    Значительное количество новых функций, включаются в HNVv2, который реализуется с помощью Azure виртуальный фильтрации платформы (VFP) расширения коммутатора Hyper-V переадресации. HNVv2 полностью интегрирован с Microsoft Azure Stack, которая включает новый сетевой контроллер в стек программно определяемой сети (SDN).  Политика виртуальной сети определяется по Microsoft [сетевого контроллера](../../../sdn/technologies/network-controller/Network-Controller.md) с помощью RESTful северный (NB) API и подключении к агенту узла с помощью нескольких южного Intefaces (SBI) включая OVSDB. Политика программы агента узла в расширение VFP коммутатора Hyper-V, где он установлен принудительно.  

    > [!IMPORTANT]  
    > Этот раздел посвящен HNVv2.  

### <a name="VirtualNetworks"></a>Виртуальная сеть  

-   Каждой виртуальной сети состоит из одного или нескольких виртуальных подсетей. Виртуальная сеть формирует изоляционные границы, где виртуальные машины в виртуальной сети могут взаимодействовать друг с другом только. В большинстве случаев эта изоляция был принудительно применен через виртуальные ЛС, отделенные друг от друга диапазон IP-адресов и 802.1Q тег или идентификатор виртуальной локальной сети. Но с HNV, изоляция обеспечивается применением инкапсуляция NVGRE или VXLAN для создания наложения сети с возможностью перекрытие подсетей IP-адрес несколькими пользователями или клиентами.  

-   Каждая виртуальная сеть имеет уникальный маршрутизации домена идентификатор (RDID) на узле. Этот RDID примерно сопоставляется идентификатор ресурса для идентификации виртуальной сети ресурс REST в сетевом контроллере. Ресурс REST виртуальной сети имеется ссылка с универсальный код ресурса (URI) пространства имен с добавлением идентификатором ресурса.  

### <a name="VirtualSubnets"></a>Виртуальные подсети  

-   Виртуальная подсеть реализует семантику подсети IP уровня 3 для виртуальных машин одной виртуальной подсети. Виртуальная подсеть форм доменом рассылки (аналогично виртуальной локальной сети) и изоляция обеспечивается с помощью поля идентификатора сети VXLAN (VNI) или идентификатор сети клиента NVGRE (TNI).  

-   Каждая виртуальная подсеть принадлежит к одной виртуальной сети (RDID), и ей назначается уникальный виртуальной подсети идентификатор (VSID) с помощью ключа TNI или VNI в заголовке инкапсулированного пакета. VSID должен быть уникальным в пределах центра обработки данных и находится в диапазоне от 4096 до 2 ^ 24-2.  

Ключевым преимуществом виртуальной сети и домена маршрутизации является наличие заказчикам возможность переноса собственных сетевых топологий (например, IP-подсети) в облако. На рисунке 2 представлен пример, в котором компания Contoso располагает двумя раздельными сетями: сетью R&D и сетью Sales. Поскольку у данных сетей разные ID доменов маршрутизации, они не могут взаимодействовать друг с другом. Таким образом, сеть R&D компании Contoso изолирована от сети Sales той же компании. Сеть R&D компании Contoso содержит три виртуальные подсети. Отметим, что как RDID, так и VSID в центре регистрации и обработки данных уникальны.  

![Клиентские сети и виртуальные подсети](../../../media/hyper-v-network-virtualization-technical-details-in-windows-server/VNetF6.gif)  

Рисунок 2. Клиентские сети и виртуальные подсети  

**Пересылка уровня 2**  

На рис. 2 виртуальные машины в VSID 5001 могут иметь свои пакеты, передаваемые для виртуальных машин, которые уже присутствуют в VSID 5001 через коммутатор Hyper-V. Входящих пакетов из виртуальной машины в VSID 5001 отправляются конкретных VPort коммутатора Hyper-V. Правила входящего трафика (например encap) и сопоставления (например, заголовок инкапсуляции) применяются коммутатором Hyper-V для этих пакетов. Пакеты затем перенаправляются в разных VPort на коммутаторе Hyper-V (если целевой виртуальной машине подключен к одному узлу) или к другому коммутатору Hyper-V на другой узел (если целевой виртуальной машине находится на другом узле).  

**Маршрутизация 3 уровня**  

Аналогичным образом виртуальные машины в VSID 5001 могут иметь свои пакеты, перенаправленные к виртуальным машинам в VSID 5002 или VSID 5003 маршрутизатором распределенных HNV, которая присутствует в каждом узле Hyper-V виртуальный коммутатор. При доставке пакет Hyper-V переключения, HNV обновляет VSID входящего пакета в vsid конечной виртуальной машины. Исключительным условием для этого является нахождение обоих VSID в пределах одного RDID.  Таким образом виртуальные сетевые адаптеры с RDID1 не может отправлять пакеты на виртуальные сетевые адаптеры с RDID2 без проходящий через шлюз.  

> [!NOTE]  
> В описании потока пакетов выше термин «виртуальная машина» фактически означает, что виртуальный сетевой адаптер на виртуальной машине. Как правило, виртуальная машина имеет лишь один виртуальный сетевой адаптер. В этом случае слова «виртуальная машина» и «виртуальный сетевой адаптер» можно по сути означает то же.  

Каждая виртуальная подсеть определяет подсеть IP уровня 3 и границы домена рассылки уровня 2 (У2) аналогично VLAN. При передаче пакета виртуальной машины HNV использует репликации одноадресной рассылки (UR) для создается копия исходного пакета, а затем замените IP-адрес назначения и MAC с адреса каждой виртуальной машины, которые находятся в том же VSID.  

> [!NOTE]  
> После выпуска Windows Server 2016, многоадресных пакетов широковещательной передачи и подсеть будет осуществляться с помощью репликации одноадресной рассылки. Многоадресная маршрутизация между подсетями и IGMP не поддерживаются.  

Помимо представления домена рассылки, VSID обеспечивает изоляцию. Виртуальный сетевой адаптер в виртуализации сети подключен к порту коммутатора Hyper-V, должны быть правила ACL применяется непосредственно к порту (ресурс REST virtualNetworkInterface) или в виртуальной подсети (VSID), частью которого она является.  

Порт коммутатора Hyper-V должно быть создано правило ACL применяется. Этот список управления Доступом может быть ВОЗМОЖНЫМ ALL, DENY ALL или быть более точными, разрешая только определенных типов трафика на основе сопоставления 5 кортежей (исходный IP-адрес, конечный IP-адрес, порт источника, порт назначения, протокол).  

> [!NOTE]  
> Расширения коммутатора Hyper-V не будут работать с HNVv2 в новый стек программно определяемой сети (SDN). HNVv2 реализуется с помощью расширения коммутатора Azure виртуальной платформы фильтрации (VFP), который не может использоваться в сочетании с любое другое расширение коммутатора независимых поставщиков.  

## <a name="switching-and-routing-in-hyper-v-network-virtualization"></a>Переключение и маршрутизации виртуализации сети Hyper-V  
HNVv2 реализует правильный переключение второго уровня (L2) и маршрутизации семантика третьего уровня (L3) работать так же, как физического коммутатора или маршрутизатора будет работать. Когда виртуальная машина подключена к виртуальной сетью HNV пытается установить соединение с другой виртуальной машины в одной виртуальной подсети (VSID), необходимо сначала научиться ЦС MAC-адрес удаленной виртуальной машины. Если имеется запись ARP для целевой виртуальной машине IP-адреса в таблице ARP исходной виртуальной машины, используется MAC-адрес из этой записи. Если запись не существует, исходная виртуальная машина будет отправлять широковещательный с запросом на MAC-адрес, соответствующие IP-адрес целевой виртуальной машине должны быть возвращены. Коммутатор Hyper-V перехватит этот запрос и отправить его агент узла. Агент узла будет выглядеть в своей локальной базы данных для соответствующей MAC-адреса для виртуальной машины запрошенного назначения IP-адреса.  

> [!NOTE]  
> Агент узла, выполняющем роль сервера OVSDB, используется вариант VTEP схемы для хранения сопоставления ак — АП, MAC таблиц и т. д.  

Если MAC-адрес, агент узла внедряет ответ ARP и отправляет его на виртуальной машине. После сетевого стека виртуального компьютера имеет все необходимые L2 данные заголовка, кадр передается соответствующий порт Hyper-V на коммутаторе V. На внутреннем уровне коммутатора Hyper-V проверяет этот кадр правила сопоставления кортеж N, V-порт и применяет некоторые преобразования в кадр, на основе следующих правил. Самое главное набор преобразований для инкапсуляции применяется для создания заголовка инкапсуляция, с помощью NVGRE или VXLAN, в зависимости от политики, заданные на сетевой контроллер. В зависимости от политики, запрограммированные в составе агентом узла сопоставления ак — АП используется и для определения IP-адрес узла Hyper-V где находится целевой виртуальной машине. Коммутатор Hyper-V обеспечивает правильный правила маршрутизации и теги виртуальной локальной сети применяются к внешнего пакета, чтобы оно достигало удаленный адрес PA.  

Если виртуальной машины, подключенные к виртуальной сети HNV хочет создать подключение к виртуальной машине в другой виртуальной подсети (VSID), пакет должен перенаправляться соответствующим образом. HNV предполагается топологии типа "звезда", где имеется только один IP-адрес в пространстве ак, используемого в качестве следующего прыжка для доступа к все префиксы IP-адрес (одно значение по умолчанию значения маршрута/шлюз). В настоящее время это потребует ограничением один маршрут по умолчанию и маршруты не по умолчанию не поддерживаются.  

### <a name="routing-between-virtual-subnets"></a>Маршрутизация между виртуальными подсетями  
В физической сети IP-подсеть является доменом уровня 2 (у2), где компьютеры (виртуальные и физические) могут напрямую взаимодействовать друг с другом. L2 домен является доменом рассылки, где записи ARP (map адрес IP:MAC) обучаются с помощью запросов ARP, передаваемого через все интерфейсы и ARP ответы отправляются обратно в запрашивающий узел. Компьютер использует сведения о MAC, узнали из ответа ARP, чтобы полностью создать кадр L2, включая заголовки Ethernet. Тем не менее если IP-адрес находится в другой подсети L3, ARP-запрос выходит за рамки этого L3. Вместо этого интерфейс L3 маршрутизатор (шлюз следующего прыжка, или значение по умолчанию) с IP-адресом в подсети источника должны реагировать на эти запросы ARP с собственным MAC-адресом.  

В стандартную сеть Windows администратора можно создать статические маршруты и назначить их сетевого интерфейса. Кроме того «шлюз» обычно настраивается для следующего прыжка IP-адрес для интерфейса, куда должны отправляться пакеты, предназначенные для маршрута по умолчанию (0.0.0.0/0). Пакеты отправляются с этим шлюзом по умолчанию, если определенные маршруты не существуют. По сути это маршрутизатор для физической сети.  HNV использует встроенный маршрутизатор, который является частью узла и имеет интерфейс в каждый VSID для создания распределенного маршрутизатора виртуальной сети.  

Поскольку HNV предполагает топологии «звезда», распределенный маршрутизатор HNV действует как шлюз единый по умолчанию для всего трафика между виртуальными подсетями, являющимися частью одной и той же сети VSID. Адрес, используемый по умолчанию шлюз по умолчанию для наименьший IP-адрес в VSID и назначается распределенный маршрутизатор HNV. Это распределенный маршрутизатор позволяет очень эффективный способ для всего трафика в сети VSID маршрутизироваться должным образом, так как каждый узел может напрямую направлять трафик в соответствующий узел без посредников.  Это тем более верно, если две виртуальные машины из одной сети, но из разных виртуальных подсетей виртуальных машин находятся на одном физическом узле.  Как вы узнаете позже в этом разделе, пакету нет необходимости покидать физический узел.  

### <a name="routing-between-pa-subnets"></a>Маршрутизация между подсетями PA  
В отличие от HNVv1, который выделен один АП IP-адрес для каждой виртуальной подсети (VSID) HNVv2 теперь использует один АП IP-адрес на члена команды сетевой Адаптер Switch-Embedded коммутаторов (SET). Развертывание по умолчанию предполагается, что двух Сетевых карт и назначает два PA IP-адреса для каждого узла. Один узел имеет IP-адресов PA, назначенный из одной логической подсети поставщика (АП) на той же виртуальной сети. Две виртуальные машины клиента в одной виртуальной подсети действительно может располагаться на двух разных узлов, которые подключены к два логических подсетей другого поставщика. HNV создает внешний IP-адрес заголовки инкапсулированный пакет на основе сопоставления ак — АП. Тем не менее он полагается на стеке TCP/IP узла для ARP для шлюза по умолчанию PA, а затем построение внешнего заголовки Ethernet, в зависимости от ответа ARP. Как правило этот ответ ARP поступают из интерфейса SVI физического коммутатора или маршрутизатора L3 где узел подключен. HNV таким образом полагается на маршрутизаторе L3 для маршрутизации инкапсулированные пакеты между поставщика логических подсетей и виртуальных локальных сетей.  

### <a name="routing-outside-a-virtual-network"></a>Маршрутизация за пределами виртуальной сети  
Развертывание большинства клиентских сетей требует, чтобы среда виртуализации сети Hyper-V была связана с ресурсами, не включенными в среду виртуализации сети Hyper-V. Шлюзы виртуализации сетей необходимы для обеспечения возможности связи между этими двумя средами. Инфраструктур, требующие использования шлюза HNV включают частное облако и гибридное облако. По сути шлюзы HNV требуются для третьего уровня маршрутизации между внутренними и внешними сетями (физического) (включая NAT) или между различными сайтами и/или облака (частный или общедоступный), которые используют туннель IPSec VPN или GRE.  

Шлюзы могут иметь различные физические конструктивные параметры. Они могут быть основаны на Windows Server 2016, в коммутатор верхнего уровня (TOR), действующего в качестве шлюза VXLAN, получить доступ через виртуальный IP-адрес (VIP), объявленные подсистему балансировки нагрузки, включаться в другие существующие сетевые устройства, или может быть новым автономным сетевым устройством .  

Дополнительные сведения о параметрах шлюза удаленного доступа Windows, см. в разделе [шлюза RAS](../../../../remote/remote-access/ras-gateway/RAS-Gateway.md).  

## <a name="packet-encapsulation"></a>Инкапсуляция пакета  
В виртуализации сети Hyper-V каждый виртуальный сетевой адаптер связан с двумя IP-адресами:  

-   **Адрес клиента** (ЦС) IP-адрес, назначенный клиенту, на основе инфраструктуры своей интрасети. Этот адрес позволяет клиенту обмениваться сетевым трафиком с виртуальной машины, как если бы он не были перенесены общедоступного или частного облака. АК является видимым для виртуальной машины и доступным для клиента.  

-   **Адрес поставщика** (АП) IP-адрес, назначенный поставщиком услуг хостинга или Администраторы центров обработки данных, на основе инфраструктуры своей физической сети. АП появляется в сети в виде пакетов. Обмен ими производится с сервером Hyper-V, на котором размещается виртуальная машина. АП является видимым в физической сети, но не для виртуальной машины.  

АК обслуживают топологию клиентской сети, которая виртуализируется и лишается привязки к фактическим адресам и топологии базовой физической сети, как это реализовано для АП. На следующей схеме представлены концептуальные взаимоотношения АК виртуальных машин и АП сетевых инфраструктур как результат виртуализации сетей.  

![Концептуальная диаграмма виртуализации сетей в пределах физической инфраструктуры](../../../media/hyper-v-network-virtualization-technical-details-in-windows-server/VNetF2.gif)  

Рисунок 6. Концептуальная диаграмма виртуализации сетей в пределах физической инфраструктуры  

На схеме виртуальные машины клиента отправляют пакеты данных в пространстве ак, которые просматривают инфраструктуру физической сети через собственные виртуальные сети, или «туннели». В приведенном выше примере данные туннели может рассматриваться в «конвертами» вокруг пакетов данных Contoso и Fabrikam с зелеными (адресами типа АП), которые доставляются с узла-источника в левом узел назначения в правой части. Ключом является то, каким образом данные узлы определяют «адреса отправки» (АП), соответствующие Contoso и Fabrikam ЦС, как переходит вокруг пакетов формируется «конверт» и как узлы назначения можно развертывать пакеты и предоставлять Contoso и Fabrikam Назначение виртуальной машины правильно.  

Ключевые аспекты виртуализации сетей объясняются при помощи простой аналогии:  

-   АК каждой виртуальной машины сопоставляется с АП физического узла. С одним АП может быть связано несколько АК.  

-   Виртуальные машины отправляют пакеты данных в пространствах ак, которые помещаются в «конверт» с парой АП источника и назначения на основе сопоставления.  

-   Сопоставления АК — АП должны позволять узлам производить дифференциацию пакетов для различных клиентских виртуальных машин.  

В результате механизм виртуализации сетей сводится к виртуализации сетевых адресов, используемых виртуальными машинами. Сетевой контроллер отвечает за сопоставление адресов и сопоставления базы данных, с помощью схемы MS_VTEP поддерживает агент узла. В следующем разделе описывается собственно механизм виртуализации адресов.  

## <a name="network-virtualization-through-address-virtualization"></a>Виртуализация сетей при помощи виртуализации адресов  
Реализует HNV дополнительных сетей клиентов с помощью сетевой виртуализации Generic Routing Encapsulation (NVGRE) или виртуальные расширяемые локальной сети (VXLAN).  VXLAN используется по умолчанию.  

### <a name="virtual-extensible-local-area-network-vxlan"></a>Расширяемая виртуальной локальной сети (VXLAN)  
Виртуальные расширяемые локальной сети (VXLAN) ([RFC 7348](https://www.rfc-editor.org/info/rfc7348)) протокола широко используется на рынке с поддержкой от поставщиков, таких как Cisco, Brocade, Arista, Dell, HP и другим пользователям. Протокол VXLAN использует в качестве транспорта UDP. Конечный порт UDP, назначенном IANA для VXLAN является 4789 и UDP-порт источника должен быть хэш сведения из внутреннего пакета для распространения ECMP. После заголовка UDP VXLAN заголовок добавляется в пакет, который включает зарезервированное поле 4 байта, за которым следует поле 3 байта для VXLAN сетевой идентификатор (VNI) - VSID - следуют другой зарезервированное поле 1 байт. После заголовка VXLAN добавляется исходным блоком L2 ЦС (без кадра протокола Ethernet ЦС FCS).  

![Заголовок пакета VXLAN](../../../media/hyper-v-network-virtualization-technical-details-in-windows-server/VXLAN-packet-header.png)  

### <a name="generic-routing-encapsulation-nvgre"></a>Универсальной инкапсуляции при маршрутизации (NVGRE)  
Этот механизм виртуализации сети использует Generic Routing Encapsulation (NVGRE) как часть заголовка туннеля. В NVGRE пакет виртуальной машины инкапсулируется в другой пакет. Заголовок этого нового пакета снабжается необходимыми IP-адресами источника и назначения типа АП в дополнение к ID виртуальной подсети, хранящемуся в ключевом поле заголовка GRE, как показано на рисунке 7.  

![Инкапсуляция NVGRE](../../../media/hyper-v-network-virtualization-technical-details-in-windows-server/VNetF3.gif)  

Рисунок 7. Виртуализация сетей — инкапсуляция NVGRE  

Идентификатор виртуальной подсети позволяет узлам идентифицировать клиентскую виртуальную машину для каждого отдельного пакета, несмотря на то, что АП и ЦС по пакеты могут перекрываться. Это позволяет всем виртуальным машинам одного узла совместно использовать единый АП, как показано на рисунке 7.  

Совместное использование АП оказывает серьезное воздействие на масштабируемость сети. Количество IP- и MAC-адресов, требующих запоминания сетевой инфраструктурой, может быть существенно снижено. Например, если на каждом конечном узле имеется в среднем 30 виртуальных машин, количество IP- и MAC-адресов, требующих запоминания сетевой инфраструктурой, снижается на коэффициент 30. ID виртуальной подсети, включенные в пакеты, также позволяют производить простую корреляцию пакетов под фактических клиентов.  

АП, совместное использование схемы для Windows Server 2012 R2 — одного АП на VSID каждого узла. Для Windows Server 2016 схема — одного АП на член команды сетевой Адаптер.  

С Windows Server 2016 и более поздних версиях Hyper-v полностью поддерживает NVGRE и VXLAN изначально; он не требует обновления имеющегося или приобретения нового сетевого оборудования, например сетевых карт (сетевых адаптеров), коммутаторов или маршрутизаторов. Это потому, что эти пакеты в сети будут обычным IP-пакетом в пространстве АП, которая совместима с современной сетевой инфраструктурой.  Тем не менее чтобы получить максимально эффективно использовать производительности поддерживается сетевых адаптеров с последних версиях драйверов, которые поддерживают Разгрузка задач.  

## <a name="multi-tenant-deployment-example"></a>Пример развертывания нескольких клиентов  
В примере ниже показан пример развертывания двух клиентов, находящихся в облачный центр обработки данных с использованием взаимоотношений адресов ак-АП, определяемых с помощью политик сети.  

![Пример развертывания нескольких клиентов](../../../media/hyper-v-network-virtualization-technical-details-in-windows-server/VNetF5.png)  

Рисунок 8. Пример развертывания нескольких клиентов  

Рассмотрим пример, приведенный на рисунке 8. До перехода к размещению в службе IaaS, обеспеченной провайдером:  

-   Компания Contoso задействовала SQL Server (с именем **SQL**) по IP-адресу 10.1.1.11 и веб-сервер (с именем **Web**) по IP-адресу 10.1.1.12, который использует свой SQL Server для транзакций базы данных.  

-   Компания Fabrikam задействовала SQL Server, также имеющий имя **SQL** и назначенный IP-адрес 10.1.1.11, и веб-сервер, тоже именуемый **Web** и имеющий IP-адрес 10.1.1.12, который использует свой SQL Server для транзакций базы данных.  

Предполагается, что поставщик услуг ранее создал у логической сети поставщика (АП), через сетевой контроллер в соответствии с их топологии физической сети. Сетевой контроллер выделяет два PA IP-адреса из логической подсети префикс IP-адреса, где узлы подключены. Сетевой контроллер также указывает соответствующие тега виртуальной локальной сети, чтобы применить IP-адреса.  

Затем с помощью сетевого контроллера, Contoso и Fabrikam переместили создавать свои виртуальной сети и подсети, которые содержатся в логической сети поставщика (АП), указанное поставщиком услуг размещения. Компании Contoso и Fabrikam переместили свои серверы SQL Server и соответствующие веб-серверы в одно и то же размещение в службе IaaS, обеспеченной поставщиком, где, по случайному совпадению, они задействовали виртуальные машины **SQL** на узле 1 (Host 1) Hyper-V и виртуальные машины **Web** (IIS7) на узле 2 (Host 2) Hyper-V. Все виртуальные машины сохраняют свои исходные внутрисетевые IP-адреса (свои АК).  

Обе компании назначаются следующие ID виртуальной подсети (VSID) сетевым контроллером, как показано ниже.  Агент узла на каждом узле Hyper-V получает выделенный PA IP-адреса из сетевого контроллера и создает два виртуальных сетевых адаптеров узла PA в секцию сети не по умолчанию. Сетевому интерфейсу назначается каждому из этих виртуальных сетевых адаптеров узла, где АП IP-адрес назначается, как показано ниже:  

-   Компании Contoso виртуальные машины, VSID и адреса типа АП: **VSID** — 5001, **SQL PA** — 192.168.1.10, **Web PA** — 192.168.2.20  

-   Fabrikam Corp виртуальные машины, VSID и адреса типа АП: **VSID** — 6001, **SQL PA** — 192.168.1.10, **Web PA** — 192.168.2.20  

Сетевой контроллер настраивает все политики сети (включая сопоставления ак — АП), чтобы агент узла SDN, который будет поддерживать политики в постоянном хранилище (в таблицах базы данных OVSDB).  

Когда виртуальная машина Web компании Contoso (10.1.1.12) на узле 2 Hyper-V создает подключение TCP к SQL Server по адресу 10.1.1.11, происходит следующее:  

-   ARPs виртуальной Машины для места назначения MAC-адрес 10.1.1.11  

-   Расширение VFP в виртуальный коммутатор перехватывает этот пакет и отправляет его в агент узла SDN  

-   Агент узла SDN ищет в хранилище политики для MAC-адрес 10.1.1.11  

-   При обнаружении MAC агент узла внедряет ответ ARP на виртуальную машину  

-   Если MAC не найден, ответ не отправляется, а записи ARP на виртуальной машине для 10.1.1.11 помечается как недоступный.  

-   Виртуальная машина теперь создает пакет TCP с правильные заголовки ЦС Ethernet и IP-адрес и отправляет его в виртуальный коммутатор  

-   VFP, расширение в виртуальный коммутатор переадресации обрабатывает этот пакет через VFP уровни (описаны ниже) назначен виртуальный коммутатор исходный порт, на котором пакет был получен и создает новую запись потока в таблице единой потока VFP  

-   Ядро VFP выполняет поиск правила соответствия или таблицу потоков для каждого слоя (например, слой виртуальной сети), на основе заголовков IP и Ethernet.  

-   Из этих правил на уровне виртуальной сети ссылается на пробел сопоставления ак — АП и выполняет инкапсуляцию.  

-   На уровне виртуальной сети, вместе с VSID указывается тип инкапсуляции (VXLAN или NVGRE).  

-   В случае инкапсуляции VXLAN с VSID 5001 в заголовке VXLAN создается внешний заголовок в UDP.  
    Внешний заголовок в IP-адрес создается с исходный и конечный адрес PA, назначаемые 2 узла Hyper-V (192.168.2.20) и 1 узла Hyper-V (192.168.1.10) соответственно в зависимости от хранилища политик агент узла SDN.  

-   Этот пакет, затем передаются в уровне PA маршрутизации в VFP.  

-   Слой PA маршрутизации в VFP будет ссылаться секция сети, используется для трафика пространстве АП и идентификатор виртуальной локальной сети и использовать стек TCP/IP узла для отправки пакетов PA на узле 1 Hyper-V правильно.  

-   При получении инкапсулированного пакета узел 1 Hyper-V получает пакет в секции сети PA и отправлять их в виртуальный коммутатор.  

-   VFP обрабатывает пакет через нее VFP слоев и создания потока записи в таблице единой потока VFP.  

-   Модуль VFP соответствует правилам ingres на уровне виртуальной сети и отсекает внешнего инкапсулированный пакет Ethernet, IP-адрес и VXLAN заголовки.  

-   Ядро VFP затем пересылает его порт виртуального коммутатора, к которому подключен целевая виртуальная машина.  

Аналогичный процесс для трафика между Fabrikam Corp **Web** и виртуальными машинами **SQL** использует параметры политики HNV для корпорации Fabrikam Corp. В результате при использовании HNV виртуальные машины компании Fabrikam и Contoso взаимодействуют так, как если бы находились в своих интрасетях компаний. При этом они не могут взаимодействовать друг с другом, даже несмотря на то, что используют одинаковые IP-адреса.  

Раздельные адреса (клиентского доступа и адреса типа АП), параметры политики узлов Hyper-V и преобразование адресов между ЦС и АП трафика входящего и исходящего трафика виртуальных машин изолируют эти комплекты серверов с помощью ключа NVGRE или VLXAN VNID. Более того, сопоставления виртуализации и преобразование лишают архитектуру виртуальной сети привязки к инфраструктуре физической сети. Хотя **SQL** и **Web** компании Contoso и **SQL** и **Web** компании Fabrikam располагаются в их собственных подсетях IP АК (10.1.1/24), их физическое развертывание происходит на двух узлах в разных подсетях АП: 192.168.1/24 и 192.168.2/24 соответственно. Суть в том, что перекрестно-подсетевое выделение виртуальных машин и динамическая миграция становятся возможными с применением виртуализации сети Hyper-V.  

## <a name="hyper-v-network-virtualization-architecture"></a>Архитектура виртуализации сетей Hyper-V  
В Windows Server 2016 HNVv2 реализуется с помощью Azure виртуальный фильтрации платформы (VFP) которого является расширением NDIS фильтрации в коммутаторе Hyper-V. Ключевым принципом VFP — это подсистема обработки потока действие совпадение с внутренних API, предоставляемый в агент узла SDN для программирования политики сети. Сам агент узла SDN получает по каналам связи OVSDB и Подсистемамми WCF политики сети из сетевого контроллера. Мало того, политики виртуальной сети (например сопоставления ак — АП) программируется с использованием VFP, но дополнительные политики, такие как списки управления доступом, QoS и т. д.  

Иерархии объектов для виртуального коммутатора и расширение переадресации VFP выглядит так:  

-   виртуальный коммутатор  

    -   Внешний сетевой Адаптер управления  

    -   Сетевой Адаптер аппаратную разгрузку  

    -   Глобальные правила переадресации  

    -   Port  

        -   Пересылка слой для закрепления волосы исходящего трафика  

        -   Списки пространства для сопоставления и пулы NAT  

        -   Таблицу единой потоков  

        -   Слой VFP  

            -   Таблица потока  

            -   Группа  

            -   Правило  

                -   Правила могут ссылаться на пробелы  

В VFP слоя создается для каждого типа политики (например, виртуальная сеть), а затем — универсальный набор таблиц/поток правила. Он не поддерживает все встроенные функции определенные правила пока будет назначен для этого слоя для реализации такой функциональности. Каждый слой назначается приоритет и слои назначаются к порту по в порядке возрастания приоритета. Правила организованы в группы, преимущественно основаны на направление и семейство IP-адресов. Группы, также присваивается приоритет и максимум одно правило из группы может соответствовать определенного потока.  

Пересылка логики vSwitch с расширением VFP выглядит следующим образом:  

-   Обработка входящего трафика (входящий трафик из точки зрения пакета, поступающих на порт)  

-   Пересылка  

-   Обработка исходящего трафика (исходящий трафик с точки зрения пакета, оставляя порт)  

VFP поддерживает внутреннее MAC переадресации типов инкапсуляция NVGRE и VXLAN, а также внешнее перенаправление MAC на основе виртуальной локальной.  

Расширение VFP имеет медленно path и быстрого перехода для прохождения пакетов. Первый пакет в потоке должен проходить все группы правил в каждом слое и сделать правило подстановки, который является ресурсоемкой операцией. Тем не менее последовательность, зарегистрированный в таблице единой потока со списком действий (на основе правил сопоставления) все последующие пакеты обрабатываются на основе единой последовательности записей таблицы.  

Политики HNV запрограммирован агентом узла. Каждый сетевой адаптер виртуальной машины настраивается с IPv4-адрес. Существуют АК, используемые для связи виртуальных машин друг с другом, они поступают в IP-пакетах из этих виртуальных машин. HNV инкапсулирует кадр ЦС, в кадр АП, основываясь на политиках сетевой виртуализации, хранятся в базе данных агент узла.  

![Архитектура HNV](../../../media/hyper-v-network-virtualization-technical-details-in-windows-server/VNetF7.png)  

Рисунок 9. Архитектура HNV  

## <a name="summary"></a>Сводка  
Центры регистрации и обработки данных на основе технологии облака могут обеспечивать множество преимуществ, например улучшенную масштабируемость и более эффективное использование ресурсов. Реализация этих потенциальных преимуществ требует применения технологии, посвященной принципиальному решению проблем многоклиентской масштабируемости в динамической среде. Виртуализация сети Hyper-V создана для решения этих проблем и повышения рабочей эффективности центров обработки данных за счет разделения топологий виртуальной и физической сетей. HNV, основываясь на основе существующего стандарта, выполняется в современного центра обработки данных и работает с существующей инфраструктурой VXLAN. Клиенты с HNV можно объединять свои центры обработки данных в частное облако или относительно легко расширять свои центры обработки данных в среде поставщика услуг размещения сервера с помощью гибридного облака.  

## <a name="BKMK_LINKS"></a>См. также  
Дополнительные сведения о HNVv2 см. следующие ссылки:  


|       Тип содержимого       |                                                                                                                                              Ссылок                                                                                                                                              |
|--------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Ресурсы сообщества**  |                                                                -   [Блог по архитектуре частного облака](https://blogs.technet.com/b/privatecloud)<br />-Задайте вопросы. [cloudnetfb@microsoft.com](mailto:%20cloudnetfb@microsoft.com)                                                                |
|         **RFC**          |                                                                   -   [ЧЕРНОВОМ документе RFC](https://www.ietf.org/id/draft-sridharan-virtualization-nvgre-07.txt)<br />-   [VXLAN - RFC 7348](https://www.rfc-editor.org/info/rfc7348)                                                                    |
| **Связанные технологии** | -Техническое описание виртуализации сетей Hyper-V в Windows Server 2012 R2, см. в разделе [техническое описание виртуализации сетей Hyper-V](https://technet.microsoft.com/library/jj134174.aspx)<br />-   [Сетевой контроллер](../../../sdn/technologies/network-controller/Network-Controller.md) |

