---
title: Технические сведения о виртуализации сети Hyper-V в Windows Server 2016
description: В этом разделе содержатся технические сведения о виртуализации сети Hyper-V в Windows Server 2016.
manager: grcusanz
ms.topic: article
ms.assetid: 9efe0231-94c1-4de7-be8e-becc2af84e69
ms.author: anpaul
author: AnirbanPaul
ms.openlocfilehash: 94d45dd04708d58d880f3dcbc7a65e9586e02a29
ms.sourcegitcommit: 68444968565667f86ee0586ed4c43da4ab24aaed
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/07/2020
ms.locfileid: "87994412"
---
# <a name="hyper-v-network-virtualization-technical-details-in-windows-server-2016"></a>Технические сведения о виртуализации сети Hyper-V в Windows Server 2016

>Область применения: Windows Server 2016

Виртуализация серверов позволяет нескольким серверам работать одновременно на едином физическом узле; при этом указанные серверы остаются взаимно изолированными. По существу, каждая виртуальная машина работает как единственный сервер на данном физическом компьютере.

Виртуализация сети обеспечивает аналогичную возможность, при которой несколько виртуальных сетей (потенциально с перекрывающимися IP-адресами) выполняются в одной и той же физической сетевой инфраструктуре, и каждая виртуальная сеть работает так, как если бы это единственная виртуальная сеть, работающая в общей сетевой инфраструктуре. Рисунок 1 демонстрирует эти отношения.

![Виртуализация серверов в сравнении с виртуализацией сетей](../../../media/hyper-v-network-virtualization-technical-details-in-windows-server/VNetF1.gif)

Рисунок 1. Виртуализация серверов в сравнении с виртуализацией сетей

## <a name="hyper-v-network-virtualization-concepts"></a>Концепции виртуализации сетей Hyper-V
В виртуализации сети Hyper-V (HNV) пользователь или клиент определяется как "владелец" набора IP-подсетей, развернутых на предприятии или в центре обработки данных. Клиент может быть организацией или предприятием с несколькими подразделениями или подразделениями в частном центре обработки данных, которым требуется изоляция сети, или клиент в общедоступном центре управления данными, размещенном в поставщике услуг. Каждый клиент может иметь одну или несколько [виртуальных сетей](#VirtualNetworks) в центре обработки данных, а каждая виртуальная сеть состоит из одной или нескольких [виртуальных подсетей](#VirtualSubnets).

Существует две реализации HNV, которые будут доступны в Windows Server 2016: HNVv1 и HNVv2.

-   **HNVv1**

    HNVv1 совместим с Windows Server 2012 R2 и System Center 2012 R2 Virtual Machine Manager (VMM). Конфигурация для HNVv1 зависит от управления WMI и командлетов Windows PowerShell (с помощью System Center VMM) для определения параметров изоляции и адреса клиента (CA) — сопоставления виртуальной сети с физическим адресом (PA) и маршрутизации. В HNVv1 в Windows Server 2016 не были добавлены дополнительные функции, и новые функции не планируется.

    *   Установка Teaming и HNV v1 несовместима платформой.

    o чтобы использовать шлюзы HA NVGRE, пользователи должны либо использовать команду LBFO, либо не какую-либо команду. Или

    o использовать развернутые шлюзы сетевого контроллера с параметром "настроить объединенный коммутатор".


-   **HNVv2**

    В HNVv2 включено значительное количество новых функций, которое реализуется с помощью расширения переадресации платформы виртуальных фильтров Azure (VFP) в коммутаторе Hyper-V. HNVv2 полностью интегрирован с Microsoft Azure Stack, который включает новый сетевой контроллер в стеке программно-определяемой сети (SDN).  Политика виртуальной сети определяется через [сетевой контроллер](../../../sdn/technologies/network-controller/Network-Controller.md) Майкрософт с помощью API-интерфейса RESTful обмена (NetBIOS) и подключен к агенту узла через несколько подсистемамми ИНТЕФАЦЕС (ликвидный SBI), включая овсдб. Политика программы агента узла в расширении VFP коммутатора Hyper-V, где он применяется.

    > [!IMPORTANT]
    > Этот раздел посвящен HNVv2.

### <a name="virtual-network"></a><a name="VirtualNetworks"></a>Виртуальная сеть

-   Каждая виртуальная сеть состоит из одной или нескольких виртуальных подсетей. Виртуальная сеть образует границу изоляции, в которой виртуальные машины в виртуальной сети могут взаимодействовать друг с другом. Традиционно Эта изоляция была применена с помощью виртуальных ЛС с разделенным диапазоном IP-адресов и 802.1ным тегом q или ИДЕНТИФИКАТОРом виртуальной ЛС. Но при использовании HNV изоляция применяется с помощью инкапсуляции NVGRE или ВКСЛАН для создания сетей наложения с возможностью перекрытия IP-подсетей между клиентами или клиентами.

-   Каждая виртуальная сеть имеет уникальный идентификатор домена маршрутизации (РДИД) на узле. Этот РДИД примерно соответствует ИДЕНТИФИКАТОРу ресурса для идентификации ресурса RESTFUL виртуальной сети в сетевом контроллере. Ссылка на ресурс RESTFUL виртуальной сети указывается с помощью пространства имен универсального кода ресурса (URI) с добавленным ИДЕНТИФИКАТОРом ресурса.

### <a name="virtual-subnets"></a><a name="VirtualSubnets"></a>Виртуальные подсети

-   Виртуальная подсеть реализует семантику подсети IP уровня 3 для виртуальных машин одной виртуальной подсети. Виртуальная подсеть образует Широковещательный домен (аналогичный виртуальной ЛС) и обеспечивает строгую изоляцию, используя поле Идентификатор клиента NVGRE (ТНИ) или идентификатор ВКСЛАН сети (вни).

-   Каждая виртуальная подсеть принадлежит одной виртуальной сети (РДИД) и ей назначается уникальный идентификатор виртуальной подсети (VSID), использующий ключ ТНИ или вни в заголовке инкапсулированного пакета. VSID должен быть уникален в пределах центра обработки данных и находится в диапазоне от 4096 до 2 ^ 24 – 2.

Ключевым преимуществом виртуальной сети и домена маршрутизации является то, что он позволяет клиентам использовать собственные топологии сети (например, IP-подсети) в облаке. На рисунке 2 представлен пример, в котором компания Contoso располагает двумя раздельными сетями: сетью R&D и сетью Sales. Поскольку у данных сетей разные ID доменов маршрутизации, они не могут взаимодействовать друг с другом. То есть Contoso R&D NET изолирован от Contoso Sales, несмотря на то, что оба они принадлежат Contoso Corp. contoso R&D NET содержит три виртуальные подсети. Отметим, что как RDID, так и VSID в центре регистрации и обработки данных уникальны.

![Клиентские сети и виртуальные подсети](../../../media/hyper-v-network-virtualization-technical-details-in-windows-server/VNetF6.gif)

Рисунок 2. Клиентские сети и виртуальные подсети

**Пересылка уровня 2**

На рис. 2 виртуальные машины в VSID 5001 могут пересылать пакеты на виртуальные машины, которые также находятся в VSID 5001 с помощью коммутатора Hyper-V. Входящие пакеты от виртуальной машины в VSID 5001 отправляются в определенную впорт на коммутаторе Hyper-V. Правила входящего трафика (например, енкап) и сопоставления (например, заголовок инкапсуляции) применяются коммутатором Hyper-V для этих пакетов. Затем пакеты пересылаются в другой впорт коммутатора Hyper-V (если Целевая виртуальная машина подключена к тому же узлу) или на другой коммутатор Hyper-V на другом узле (если Целевая виртуальная машина находится на другом узле).

**Маршрутизация уровня 3**

Аналогичным образом виртуальные машины в VSID 5001 могут маршрутизировать пакеты на виртуальные машины в VSID 5002 или VSID 5003 с помощью распределенного маршрутизатора HNV, который содержится в каждой VSwitch узла Hyper-V. При доставке пакета коммутатору Hyper-V HNV обновляет VSID входящего пакета на VSID целевой виртуальной машины. Исключительным условием для этого является нахождение обоих VSID в пределах одного RDID.  Поэтому виртуальные сетевые адаптеры с RDID1 не могут передавать пакеты в виртуальные сетевые адаптеры с помощью RDID2 без обхода шлюза.

> [!NOTE]
> В описании потока пакетов выше термин "виртуальная машина" фактически означает виртуальный сетевой адаптер на виртуальной машине. Как правило, виртуальная машина имеет лишь один виртуальный сетевой адаптер. В этом случае слова "виртуальная машина" и "виртуальный сетевой адаптер" могут концептуально указывать на то же самое.

Каждая виртуальная подсеть определяет подсеть IP уровня 3 и границы домена рассылки уровня 2 (У2) аналогично VLAN. Когда виртуальная машина выполняет широковещательную рассылку пакета, HNV использует одноадресную репликацию (UR), чтобы создать копию исходного пакета и заменить IP-адрес назначения и MAC адресами каждой виртуальной машины, находящийся в одном VSID.

> [!NOTE]
> При отгрузке Windows Server 2016 многоадресная репликация и широковещательная рассылка подсетей будут реализованы. Подсеть, многоадресная маршрутизация и протокол IGMP не поддерживаются.

Помимо представления домена рассылки, VSID обеспечивает изоляцию. Виртуальный сетевой адаптер в HNV подключен к порту коммутатора Hyper-V, который будет применять правила ACL непосредственно к порту (ресурсу Виртуалнетворкинтерфаце) или к виртуальной подсети (VSID), частью которой он является.

Для порта коммутатора Hyper-V должно быть применено правило ACL. Этот список ACL может быть разрешать все, ЗАПРЕЩАть все или быть более конкретным, чтобы разрешить только определенные типы трафика, основанные на пяти кортежах (исходный IP-адрес, IP-адрес назначения, порт источника, порт назначения, протокол).

> [!NOTE]
> Расширения коммутаторов Hyper-V не будут работать с HNVv2 в новом стеке программно-определяемой сети (SDN). HNVv2 реализуется с помощью расширения коммутатора виртуальной платформы фильтрации Azure (VFP), которое не может использоваться совместно с любым другим расширением коммутатора стороннего производителя.

## <a name="switching-and-routing-in-hyper-v-network-virtualization"></a>Переключение и маршрутизация в виртуализации сети Hyper-V
HNVv2 реализует правильное переключение уровня 2 (L2) и семантику маршрутизации уровня 3 (L3), чтобы работать точно так же, как физический коммутатор или маршрутизатор. Когда виртуальная машина, подключенная к виртуальной сети HNV, пытается установить подключение к другой виртуальной машине в той же виртуальной подсети (VSID), сначала необходимо узнать MAC-адрес ЦС удаленной виртуальной машины. Если имеется запись ARP для IP-адреса целевой виртуальной машины в таблице ARP исходной виртуальной машины, используется MAC-адрес из этой записи. Если запись не существует, исходная виртуальная машина отправит широковещательную ARP-запрос, соответствующий IP-адресу целевой виртуальной машины, который будет возвращен. Коммутатор Hyper-V перехватит этот запрос и отправит его агенту узла. Агент узла будет искать в своей локальной базе данных соответствующий MAC-адрес для запрошенной конечной виртуальной машины.

> [!NOTE]
> Агент узла, выполняющий роль сервера ОВСДБ, использует вариант схемы ВТЕП для хранения сопоставлений CA-PA, таблицы MAC и т. д.

Если MAC-адрес доступен, агент узла вставляет ответ ARP и отправляет его обратно на виртуальную машину. После того как сетевой стек виртуальной машины будет иметь все необходимые сведения о заголовке L2, этот кадр будет отправлен соответствующему порту Hyper-V на коммутаторе V. На внутреннем уровне коммутатор Hyper-V проверяет этот кадр на соответствие правилам сопоставления N-кортежам, назначенным V-порту, и применяет определенные преобразования к кадру на основе этих правил. Что важнее всего, набор преобразований инкапсуляции применяется для создания заголовка инкапсуляции с помощью NVGRE или ВКСЛАН в зависимости от политики, определенной на сетевом контроллере. В зависимости от политики, запрограммированной агентом узла, для определения IP-адреса узла Hyper-V, на котором находится целевая виртуальная машина, используется сопоставление CA-PA. Коммутатор Hyper-V гарантирует, что к внешнему пакету применяются правильные правила маршрутизации и теги VLAN, чтобы они достигли удаленного адреса PA.

Если виртуальная машина, подключенная к виртуальной сети HNV, хочет создать подключение с виртуальной машиной в другой виртуальной подсети (VSID), пакет необходимо маршрутизировать соответствующим образом. HNV предполагает топологию типа "звезда", где в пространстве ЦС имеется только один IP-адрес, используемый в качестве следующего прыжка для получения всех префиксов IP-адресов (то есть один маршрут или шлюз по умолчанию). В настоящее время ограничение на использование одного маршрута по умолчанию и маршрутов не по умолчанию не поддерживается.

### <a name="routing-between-virtual-subnets"></a>Маршрутизация между виртуальными подсетями
В физической сети IP-подсеть — это домен уровня 2 (L2), где компьютеры (виртуальные и физические) могут напрямую взаимодействовать друг с другом. Домен уровня L2 — это Широковещательный домен, в котором записи ARP (схема IP-адресов MAC) обрабатываются через запросы ARP, которые проходят вещание на всех интерфейсах и ответы ARP отправляются обратно на запрашивающий узел. Компьютер использует информацию MAC, полученную из ответа ARP, для полного создания кадра L2, включая заголовки Ethernet. Однако если IP-адрес находится в другой подсети L3, запрос ARP не пересекает эту границу L3. Вместо этого интерфейс маршрутизатора L3 (следующий прыжок или шлюз по умолчанию) с IP-адресом в исходной подсети должен отвечать на эти запросы ARP с собственным MAC-адресом.

В стандартной сети Windows администратор может создавать статические маршруты и назначать их сетевому интерфейсу. Кроме того, "шлюз по умолчанию" обычно настраивается как IP-адрес следующего прыжка в интерфейсе, куда отправляются пакеты, предназначенные для маршрута по умолчанию (0.0.0.0/0). Пакеты отправляются в этот шлюз по умолчанию, если не существует конкретных маршрутов. По сути это маршрутизатор для физической сети.  HNV использует встроенный маршрутизатор, который является частью каждого узла и имеет интерфейс в каждой VSID, чтобы создать распределенный маршрутизатор для виртуальных сетей.

Так как HNV предполагает топологию типа "звезда", распределенный маршрутизатор HNV выступает в качестве единого шлюза по умолчанию для всего трафика, который проходит между виртуальными подсетями, которые являются частью одной сети VSID. Адрес, используемый в качестве шлюза по умолчанию, по умолчанию имеет самый низкий IP-адрес в VSID и назначается распределенному маршрутизатору HNV. Этот распределенный маршрутизатор обеспечивает очень эффективный способ маршрутизации всего трафика в VSID сети, так как каждый узел может напрямую направить трафик на соответствующий узел, не требуя посредника.  Это тем более верно, если две виртуальные машины из одной сети, но из разных виртуальных подсетей виртуальных машин находятся на одном физическом узле.  Как вы узнаете позже в этом разделе, пакету нет необходимости покидать физический узел.

### <a name="routing-between-pa-subnets"></a>Маршрутизация между подсетями PA
В отличие от HNVv1, которые выделили один IP-адрес PA для каждой виртуальной подсети (VSID), HNVv2 теперь использует по одному IP-адресу PA для каждого члена группы поддержки сетевых карт (SET). Развертывание по умолчанию предполагает команду с двумя сетевыми картами и назначает два IP-адреса PA на узел. С одним узлом IP-адреса PA назначены из одной логической подсети поставщика (PA) в одной виртуальной ЛС. Две виртуальные машины клиента в одной виртуальной подсети на самом деле могут находиться на двух разных узлах, подключенных к двум разным логическим подсетям поставщика. HNV будет формировать внешние заголовки IP-адресов для инкапсулированного пакета на основе сопоставления CA-PA. Однако он полагается на стек TCP/IP узла на ARP для шлюза PA по умолчанию, а затем создает внешние заголовки Ethernet на основе ответа ARP. Как правило, этот ответ ARP поступает от интерфейса сви на физическом коммутаторе или на маршрутизаторе L3, подключенном к узлу. Таким образом, HNV полагается на маршрутизатор L3 для маршрутизации инкапсулированных пакетов между логическими подсетями поставщика или виртуальными ЛС.

### <a name="routing-outside-a-virtual-network"></a>Маршрутизация за пределами виртуальной сети
Развертывание большинства клиентских сетей требует, чтобы среда виртуализации сети Hyper-V была связана с ресурсами, не включенными в среду виртуализации сети Hyper-V. Шлюзы виртуализации сетей необходимы для обеспечения возможности связи между этими двумя средами. Инфраструктурам, требующим HNV Gateway, относятся частное облако и гибридное облако. По сути, шлюзы HNV необходимы для маршрутизации уровня 3 между внутренней и внешней (физической) сетями (включая NAT) или между разными сайтами и (или) облаками (частными или общедоступными), которые используют туннель IPSec или GRE.

Шлюзы могут иметь различные физические конструктивные параметры. Они могут быть созданы на базе Windows Server 2016, включены в начало ключа стойки (TOR), действующего в качестве шлюза ВКСЛАН, доступ к которому осуществляется через виртуальный IP-адрес (VIP), объявленный подсистемой балансировки нагрузки, в другие существующие сетевые устройства или как новое автономное сетевое устройство.

Дополнительные сведения о параметрах шлюза RAS в Windows см. в разделе [шлюз RAS](../../../../remote/remote-access/ras-gateway/RAS-Gateway.md).

## <a name="packet-encapsulation"></a>Инкапсуляция пакета
В виртуализации сети Hyper-V каждый виртуальный сетевой адаптер связан с двумя IP-адресами:

-   **Адрес клиента** (CA) IP-адрес, назначенный клиентом в зависимости от инфраструктуры интрасети. Этот адрес позволяет клиенту обмениваться сетевым трафиком с виртуальной машиной, как будто он не был перемещен в общедоступное или частное облако. АК является видимым для виртуальной машины и доступным для клиента.

-   **Адрес поставщика** (PA) — IP-адрес, назначенный поставщиком услуг размещения или администратором центра обработки данных на основе физической сетевой инфраструктуры. АП появляется в сети в виде пакетов. Обмен ими производится с сервером Hyper-V, на котором размещается виртуальная машина. АП является видимым в физической сети, но не для виртуальной машины.

АК обслуживают топологию клиентской сети, которая виртуализируется и лишается привязки к фактическим адресам и топологии базовой физической сети, как это реализовано для АП. На следующей схеме представлены концептуальные взаимоотношения АК виртуальных машин и АП сетевых инфраструктур как результат виртуализации сетей.

![Концептуальная диаграмма виртуализации сетей в пределах физической инфраструктуры](../../../media/hyper-v-network-virtualization-technical-details-in-windows-server/VNetF2.gif)

Рисунок 6. Концептуальная схема виртуализации сетей относительно физической инфраструктуры

На схеме виртуальные машины клиента отправляют пакеты данных в пространстве ЦС, которые проходят по физической сетевой инфраструктуре через собственные виртуальные сети или "туннели". В приведенном выше примере туннели можно рассматривать как "конверты" вокруг пакетов данных Contoso и Fabrikam с зелеными метками доставки (адреса PA), которые должны доставляться с исходного узла слева на узел назначения справа. Основное место заключается в том, как узлы определяют адреса доставки (PA), соответствующие Contoso и ЦС Fabrikam, способ размещения конверта в пакетах, а также то, как конечные узлы могут разворачивать пакеты, а также правильно доставляться в виртуальные машины Contoso и Fabrikam.

Ключевые аспекты виртуализации сетей объясняются при помощи простой аналогии:

-   АК каждой виртуальной машины сопоставляется с АП физического узла. С одним АП может быть связано несколько АК.

-   Виртуальные машины отправляют пакеты данных в пространствах ЦС, которые помещаются в "Конверт" с парой источника и назначения PA на основе сопоставления.

-   Сопоставления АК — АП должны позволять узлам производить дифференциацию пакетов для различных клиентских виртуальных машин.

В результате механизм виртуализации сетей сводится к виртуализации сетевых адресов, используемых виртуальными машинами. Сетевой контроллер отвечает за сопоставление адресов, а агент узла обслуживает базу данных сопоставления с помощью схемы MS_VTEP. В следующем разделе описывается собственно механизм виртуализации адресов.

## <a name="network-virtualization-through-address-virtualization"></a>Виртуализация сетей при помощи виртуализации адресов
HNV реализует перекрытие сетей клиентов с помощью общей инкапсуляции маршрутизации сети (NVGRE) или виртуальной расширяемой локальной сети (ВКСЛАН).  По умолчанию используется ВКСЛАН.

### <a name="virtual-extensible-local-area-network-vxlan"></a>Виртуальная расширяемая локальная сеть (ВКСЛАН)
Виртуальный расширяемый протокол наращиваемой локальной сети (ВКСЛАН) ([RFC 7348](https://www.rfc-editor.org/info/rfc7348)) широко распространен на рынке, благодаря поддержке от таких поставщиков, как Cisco, Ариста, Dell, HP и др. Протокол ВКСЛАН использует UDP в качестве транспорта. Назначенный IANA порт назначения UDP для ВКСЛАН — 4789, а порт источника UDP должен представлять собой хэш информации из внутреннего пакета, который будет использоваться для распространения ECMP. После заголовка UDP к пакету добавляется заголовок ВКСЛАН, который включает в себя зарезервированное 4-байтовое поле, за которым следует 3-байтовое поле для идентификатора сети ВКСЛАН (вни)-VSID, за которым следует еще одно зарезервированное поле из 1 байта. После заголовка ВКСЛАН к исходному кадру центра сертификации L2 (без пакета сертификации Ethernet для CA) не добавляется.

![Заголовок пакета ВКСЛАН](../../../media/hyper-v-network-virtualization-technical-details-in-windows-server/VXLAN-packet-header.png)

### <a name="generic-routing-encapsulation-nvgre"></a>Универсальная Инкапсуляция маршрутизации (NVGRE)
Этот механизм виртуализации сети использует универсальную инкапсуляцию маршрутизации (NVGRE) в качестве части заголовка туннеля. В NVGRE пакет виртуальной машины инкапсулируется внутри другого пакета. Заголовок этого нового пакета снабжается необходимыми IP-адресами источника и назначения типа АП в дополнение к ID виртуальной подсети, хранящемуся в ключевом поле заголовка GRE, как показано на рисунке 7.

![Инкапсуляция NVGRE](../../../media/hyper-v-network-virtualization-technical-details-in-windows-server/VNetF3.gif)

Рисунок 7. Виртуализация сетей — инкапсуляция типа NVGRE

ИДЕНТИФИКАТОР виртуальной подсети позволяет узлам обнаруживать виртуальную машину клиента для любого пакета, несмотря на то, что PA и ЦС в пакетах могут перекрываться. Это позволяет всем виртуальным машинам одного узла совместно использовать единый АП, как показано на рисунке 7.

Совместное использование АП оказывает серьезное воздействие на масштабируемость сети. Количество IP- и MAC-адресов, требующих запоминания сетевой инфраструктурой, может быть существенно снижено. Например, если на каждом конечном узле имеется в среднем 30 виртуальных машин, количество IP- и MAC-адресов, требующих запоминания сетевой инфраструктурой, снижается на коэффициент 30. ID виртуальной подсети, включенные в пакеты, также позволяют производить простую корреляцию пакетов под фактических клиентов.

Схема совместного доступа PA для Windows Server 2012 R2 — один PA для каждого VSID на каждом узле. Для Windows Server 2016 схема является одним участником команды PA для каждой сетевой карты.

В Windows Server 2016 и более поздних версиях HNV полностью поддерживает NVGRE и ВКСЛАН. Он не требует обновления или приобретения нового сетевого оборудования, например сетевых адаптеров (сетевые адаптеры), коммутаторов или маршрутизаторов. Это обусловлено тем, что эти пакеты в сети являются обычными IP-пакетами в пространстве PA, совместимым с современной сетевой инфраструктурой.  Тем не менее, чтобы обеспечить оптимальную производительность, используйте Поддерживаемые сетевые карты с последними драйверами, поддерживающими разгрузку задач.

## <a name="multi-tenant-deployment-example"></a>Пример развертывания нескольких клиентов
На следующей схеме показан пример развертывания двух клиентов, расположенных в облачном центре обработки данных, с отношением CA-PA, определенным сетевыми политиками.

![Пример развертывания нескольких клиентов](../../../media/hyper-v-network-virtualization-technical-details-in-windows-server/VNetF5.png)

Рисунок 8. Пример архитектуры обслуживания нескольких развертываний одним экземпляром приложения

Рассмотрим пример, приведенный на рисунке 8. До перехода к размещению в службе IaaS, обеспеченной провайдером:

-   Компания Contoso задействовала SQL Server (с именем **SQL**) по IP-адресу 10.1.1.11 и веб-сервер (с именем **Web**) по IP-адресу 10.1.1.12, который использует свой SQL Server для транзакций базы данных.

-   Компания Fabrikam задействовала SQL Server, также имеющий имя **SQL** и назначенный IP-адрес 10.1.1.11, и веб-сервер, тоже именуемый **Web** и имеющий IP-адрес 10.1.1.12, который использует свой SQL Server для транзакций базы данных.

Предполагается, что поставщик услуг размещения ранее создал логическую сеть поставщика (PA) через сетевой контроллер в соответствии с топологией физической сети. Сетевой контроллер выделяет два IP-адреса PA из префикса IP-адресов логической подсети, к которому подключены узлы. Сетевой контроллер также указывает соответствующий тег VLAN для применения IP-адресов.

Используя сетевой контроллер, Contoso Corp и Fabrikam Corp, создайте свою виртуальную сеть и подсети, которые поддерживаются логической сетью поставщика (PA), заданной поставщиком услуг размещения. Компании Contoso и Fabrikam переместили свои серверы SQL Server и соответствующие веб-серверы в одно и то же размещение в службе IaaS, обеспеченной поставщиком, где, по случайному совпадению, они задействовали виртуальные машины **SQL** на узле 1 (Host 1) Hyper-V и виртуальные машины **Web** (IIS7) на узле 2 (Host 2) Hyper-V. Все виртуальные машины сохраняют свои исходные внутрисетевые IP-адреса (свои АК).

Обеим компаниям назначается сетевой контроллер следующим ИДЕНТИФИКАТОРом виртуальной подсети (VSID), как показано ниже.  Агент узла на каждом узле Hyper-V получает выделенные IP-адреса PA из сетевого контроллера и создает два узла PA vNIC в сетевом сегменте, отличном от по умолчанию. Сетевой интерфейс назначается каждому из этих vNIC узлов, где IP-адрес PA назначается, как показано ниже.

-   Виртуальные машины Contoso Corp VSID и PAs: **VSID** — 5001, **SQL PA** — 192.168.1.10, **Web PA** — 192.168.2.20

-   Виртуальные машины Fabrikam Corp VSID и PAs: **VSID** — 6001, **SQL PA** — 192.168.1.10, **Web PA** — 192.168.2.20

Сетевой контроллер подключают все политики сети (включая сопоставление CA-PA) с агентом узла SDN, который будет поддерживать политику в постоянном хранилище (в таблицах базы данных ОВСДБ).

Когда веб-машина Contoso Corp (10.1.1.12) на узле Hyper-V (узел 2) создает подключение TCP к SQL Serverу в 10.1.1.11, происходит следующее:

-   АРПС виртуальной машины для MAC-адреса назначения 10.1.1.11

-   Расширение VFP в vSwitch перехватывает этот пакет и отправляет его агенту узла SDN.

-   Агент узла SDN ищет в своем хранилище политик MAC-адрес для 10.1.1.11.

-   Если найден MAC, агент узла внедряет ответ ARP обратно в виртуальную машину.

-   Если компьютер MAC не найден, ответ не отправляется, а запись ARP в виртуальной машине для 10.1.1.11 отмечается как недоступная.

-   Теперь виртуальная машина конструирует пакет TCP с правильными заголовками Ethernet и IP-адреса ЦС и отправляет его в vSwitch.

-   Расширение переадресации VFP в vSwitch обрабатывает этот пакет через уровни VFP (описанные ниже), назначенные исходному порту vSwitch, в котором получен пакет, и создает новую запись потока в таблице унифицированных потоков VFP.

-   Подсистема VFP выполняет поиск соответствия правил или таблицы последовательности для каждого слоя (например, уровня виртуальной сети) на основе заголовков IP и Ethernet.

-   Сопоставленное правило на уровне виртуальной сети ссылается на пространство сопоставления CA-PA и выполняет инкапсуляцию.

-   Тип инкапсуляции (ВКСЛАН или NVGRE) указывается на уровне виртуальной сети вместе с VSID.

-   В случае инкапсуляции ВКСЛАН внешний заголовок UDP создается с VSID 5001 в заголовке ВКСЛАН.
    Заголовок внешнего IP-адреса создается с исходным и целевым адресом PA, назначенным узлу Hyper-V 2 (192.168.2.20) и Hyper-V host 1 (192.168.1.10) соответственно в соответствии с хранилищем политик агента узла SDN.

-   Затем этот пакет передается на уровень маршрутизации PA в VFP.

-   Уровень маршрутизации PA в VFP будет ссылаться на сетевую ячейку, используемую для трафика PA-Space и идентификатора виртуальной ЛС, и использовать стек TCP/IP узла для правильной пересылки пакета PA на узел Hyper-V 1.

-   После получения инкапсулированного пакета узел Hyper-V host 1 получает пакет из секции сети PA и пересылает его в vSwitch.

-   VFP обрабатывает пакет через свои уровни VFP и создает новую запись потока в таблице унифицированных потоков VFP.

-   Подсистема VFP соответствует правилам приема на уровне виртуальной сети и удаляет заголовки Ethernet, IP и ВКСЛАН внешнего инкапсулированного пакета.

-   Затем подсистема VFP пересылает пакет порту vSwitch, к которому подключена Целевая виртуальная машина.

Аналогично осуществляется трафик между виртуальными машинами **Web** и **SQL** компании Fabrikam с использованием параметров политики виртуализации сети Hyper-V для компании Fabrikam. В результате при помощи виртуализации сети Hyper-V виртуальные машины компаний Fabrikam и Contoso взаимодействуют так же, как при их расположении в исходных интрасетях. При этом они не могут взаимодействовать друг с другом, даже несмотря на то, что используют одинаковые IP-адреса.

Отдельные адреса (CAs и PAs), параметры политики узлов Hyper-V и преобразование адресов между ЦС и PA для входящего и исходящего трафика виртуальной машины изолируют эти наборы серверов, используя либо ключ NVGRE, либо ВЛКСАН ВНИД. Более того, сопоставления виртуализации и преобразование лишают архитектуру виртуальной сети привязки к инфраструктуре физической сети. Хотя **SQL** и **Web** компании Contoso и **SQL** и **Web** компании Fabrikam располагаются в их собственных подсетях IP АК (10.1.1/24), их физическое развертывание происходит на двух узлах в разных подсетях АП: 192.168.1/24 и 192.168.2/24 соответственно. Суть в том, что перекрестно-подсетевое выделение виртуальных машин и динамическая миграция становятся возможными с применением виртуализации сети Hyper-V.

## <a name="hyper-v-network-virtualization-architecture"></a>Архитектура виртуализации сетей Hyper-V
В Windows Server 2016 HNVv2 реализуется с помощью виртуальной платформы фильтрации Azure (VFP), которая является расширением фильтрации NDIS в коммутаторе Hyper-V. Ключевым понятием VFP является то, что подсистема обработки совпадений с внутренним интерфейсом API, предоставляемым агенту узла SDN для программирования сетевой политики. Сам агент узла SDN получает сетевую политику от сетевого контроллера по каналам связи ОВСДБ и WCF Подсистемамми. Не только политика виртуальной сети (например, сопоставление CA-PA) запрограммирована с помощью VFP, но и дополнительной политики, такой как ACL, QoS и т. д.

Иерархия объектов для расширения "переадресация vSwitch и VFP" является следующей:

-   vSwitch

    -   Управление внешним сетевым адаптером

    -   Разгрузка аппаратных карт

    -   Глобальные правила пересылки

    -   Порт

        -   Уровень перенаправления для перекрестных закрепления

        -   Списки пробелов для сопоставлений и пулов NAT

        -   Унифицированная таблица потока

        -   Уровень VFP

            -   Таблица Flow

            -   Группа

            -   Правило

                -   Правила могут ссылаться на пробелы

В VFP создается слой для каждого типа политики (например, виртуальная сеть), который является универсальным набором таблиц правил или потоков. Она не имеет никаких встроенных функций, пока для реализации таких функций не назначены определенные правила. Каждому слою назначается приоритет, и уровни назначаются порту по возрастанию приоритета. Правила организованы в группы в основном в зависимости от направления и семейства IP-адресов. Группам также назначается приоритет и не более, одно правило из группы может соответствовать заданному потоку.

Логика пересылки для vSwitch с расширением VFP выглядит следующим образом:

-   Обработка входящих данных (входящий трафик с точки зрения пакета, поступающего в порт)

-   Сылая

-   Обработка исходящих данных (исходящий с точки зрения пакета, который выходит из порта)

VFP поддерживает внутреннюю пересылку MAC для типов инкапсуляции NVGRE и ВКСЛАН, а также для внешних пересылок на основе MAC VLAN.

Расширение VFP имеет медленный и быстрый путь для обхода пакетов. Первый пакет в последовательности должен проходить все группы правил на каждом уровне и выполнять поиск правил, который является дорогостоящей операцией. Однако после регистрации последовательности в таблице унифицированного потока со списком действий (на основе соответствующих правил) все последующие пакеты будут обрабатываться на основе записей таблицы унифицированного потока.

Политика HNV запрограммирована агентом узла. Для каждого сетевого адаптера виртуальной машины настраивается IPv4-адрес. Существуют АК, используемые для связи виртуальных машин друг с другом, они поступают в IP-пакетах из этих виртуальных машин. HNV инкапсулирует кадр ЦС в кадре PA на основе политик виртуализации сети, хранящихся в базе данных агента узла.

![Архитектура HNV](../../../media/hyper-v-network-virtualization-technical-details-in-windows-server/VNetF7.png)

Рисунок 9. Архитектура HNV

## <a name="summary"></a>Сводка
Центры регистрации и обработки данных на основе технологии облака могут обеспечивать множество преимуществ, например улучшенную масштабируемость и более эффективное использование ресурсов. Реализация этих потенциальных преимуществ требует применения технологии, посвященной принципиальному решению проблем многоклиентской масштабируемости в динамической среде. Виртуализация сети Hyper-V создана для решения этих проблем и повышения рабочей эффективности центров обработки данных за счет разделения топологий виртуальной и физической сетей. Основываясь на существующем стандартном HNV, он работает в современном центре обработки данных и работает с существующей инфраструктурой ВКСЛАН. Теперь клиенты с HNV могут консолидировать свои центры обработки данных в частное облако или легко расширить их центры обработки данных до среды поставщика размещенного сервера с помощью гибридного облака.

## <a name="see-also"></a><a name="BKMK_LINKS"></a> См. также
Дополнительные сведения о HNVv2 см. по следующим ссылкам:


|       Тип содержимого       |                                                                                                                                              Ссылки                                                                                                                                              |
|--------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Ресурсы сообщества**  |                                                                -   [Блог по архитектуре частного облака](https://blogs.technet.com/b/privatecloud)<br />— Задать вопросы:[cloudnetfb@microsoft.com](mailto:%20cloudnetfb@microsoft.com)                                                                |
|         **RFC**          |                                                                   -   [NVGRE черновик RFC](https://www.ietf.org/id/draft-sridharan-virtualization-nvgre-07.txt)<br />-   [ВКСЛАН — RFC 7348](https://www.rfc-editor.org/info/rfc7348)                                                                    |
| **Связанные технологии** | Дополнительные технические сведения о виртуализации сети Hyper-V в Windows Server 2012 R2 см. в статье [технические подробности о виртуализации сетей Hyper-v](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/jj134174(v=ws.11)) .<br />-   [Сетевой контроллер](../../../sdn/technologies/network-controller/Network-Controller.md) |