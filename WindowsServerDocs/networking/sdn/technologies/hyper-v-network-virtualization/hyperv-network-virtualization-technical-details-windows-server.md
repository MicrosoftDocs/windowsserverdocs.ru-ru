---
title: Техническое описание виртуализации сети Hyper-V в Windows Server 2016
description: В этом разделе содержатся технические сведения о виртуализации сети Hyper-V в Windows Server 2016
manager: brianlic
ms.custom: na
ms.prod: windows-server-threshold
ms.reviewer: na
ms.service: virtual-network
ms.suite: na
ms.technology:
- networking-sdn
ms.tgt_pltfrm: na
ms.topic: article
ms.assetid: 9efe0231-94c1-4de7-be8e-becc2af84e69
ms.author: pashort
author: shortpatti
ms.openlocfilehash: af2b2a0b151601124bb473c465e7d5a97f2b9150
ms.sourcegitcommit: 19d9da87d87c9eefbca7a3443d2b1df486b0b010
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2018
---
# <a name="hyper-v-network-virtualization-technical-details-in-windows-server-2016"></a>Техническое описание виртуализации сети Hyper-V в Windows Server 2016

>Область применения: Windows Server 2016

Виртуализация серверов позволяет нескольким серверам работать одновременно на едином физическом узле; еще экземпляров сервера изолированы друг от друга. По существу, каждая виртуальная машина работает, как будто это единственный сервер на физическом компьютере.  
  
Виртуализация сетей обеспечивает аналогичную возможность, в какие несколько виртуальных сетей (с потенциальным перекрытием IP-адресов) выполнить на том же физической сетевой инфраструктуры и каждой виртуальной сети работает как единственная виртуальная сеть в общей сетевой инфраструктуре. Рисунок 1 демонстрирует эти отношения.  
  
![Виртуализация серверов в сравнении с виртуализацией сетей](../../../media/hyper-v-network-virtualization-technical-details-in-windows-server/VNetF1.gif)  
  
Рисунок 1: Виртуализация серверов в сравнении виртуализация сети  
  
## <a name="hyper-v-network-virtualization-concepts"></a>Концепции виртуализации сетей Hyper-V  
В виртуализации сети Hyper-V (HNV) клиент или клиента определяется как «владелец» набор IP-подсетей, развернутых в enterprise или datacenter. Клиент может быть корпорация или предприятие с нескольких отделов или бизнес-единицы в частном центре обработки данных, требующих сетевой изоляции или клиента в центре общих данных, который размещается поставщиком услуг. Каждый клиент может иметь один или несколько [виртуальные сети](#VirtualNetworks) в центре обработки данных и каждой виртуальной сети состоит из одного или нескольких [подсети виртуальной](#VirtualSubnets).  
  
Существует два варианта реализации HNV, которые будут доступны в Windows Server 2016: HNVv1 и HNVv2.  
  
-   **HNVv1**  
  
    HNVv1 совместима с Windows Server 2012 R2 и диспетчера виртуальных машин System Center 2012 R2 (VMM). Конфигурация для HNVv1 зависит от управления WMI и командлеты Windows PowerShell (добиться с помощью System Center VMM) для определения параметров изоляции и адреса клиента (ак) - виртуальной сети - сопоставление физических адресов (АП) и маршрутизации. Не имеет дополнительных возможностей были добавлены HNVv1 в Windows Server 2016 и планируются никаких новых функций.  
    
    • НАСТРОИТЬ объединение и не HNV V1 совместимы платформы.
    
    O, чтобы пользователи шлюзы ВЫСОКОДОСТУПНЫЕ NVGRE либо использовать LBFO команды или не рабочей группы. Или
    
    шлюзы ниже сетевой контроллер развернутых o с НАБОРОМ объединенных коммутатора.

  
-   **HNVv2**  
  
    Значительное количество новых функций, включаются в HNVv2 реализуется с помощью Azure виртуальная платформа фильтрации (VFP) расширения коммутатора Hyper-V переадресации. HNVv2 полностью интегрирован с Microsoft Azure Stack, включающий новый сетевой контроллер в стеке программно-конфигурируемые сети (SDN).  Определить политики виртуальной сети с помощью Microsoft [сетевой контроллер](../../../sdn/technologies/network-controller/Network-Controller.md) с помощью RESTful северный (NB) API и подключении для агента узла через несколько Южный Intefaces (SBI) включая OVSDB. Политика агента узла программы в VFP расширения коммутатора Hyper-V, которой оно реализуется.  
  
    > [!IMPORTANT]  
    > В этом разделе основное внимание уделяется HNVv2.  
  
### <a name="VirtualNetworks"></a>Виртуальной сети  
  
-   Каждый виртуальный сетевой состоит из одного или нескольких виртуальных подсетей. Виртуальная сеть формирует изоляционные границы которых виртуальных машин в виртуальной сети могут связываться друг с другом только. В большинстве случаев этот тип изоляции существовало через виртуальные ЛС с обособленной диапазон IP-адресов и 802.1Q тег или ИД виртуальной ЛС. Но с HNV, изоляция обеспечивается с помощью инкапсуляция NVGRE или VXLAN для создания сети наложения с перекрывающимися IP-подсетей между пользователям или клиентам возможность.  
  
-   Каждый виртуальный сетевой имеет уникальный маршрутизации домена идентификатор (RDID) на узле. Это RDID примерно сопоставляется с ИД ресурсов для идентификации виртуальной сети REST ресурс в сетевой контроллер. Виртуальный сетевой ресурс REST указывается с помощью имен универсальный код ресурса (URI) с помощью присоединенных идентификатор ресурса.  
  
### <a name="VirtualSubnets"></a>Виртуальные подсети  
  
-   Виртуальная подсеть реализует семантику подсети IP уровня 3 для виртуальных машин в одной виртуальной подсети. Виртуальная подсеть форм доменом рассылки (аналогично виртуальной локальной сети) и изоляция обеспечивается с помощью поля идентификатор сети клиента NVGRE (TNI) или идентификатор сети VXLAN (VNI).  
  
-   Каждая виртуальная подсеть принадлежит к одной виртуальной сети (RDID), и ей назначается уникальный виртуальной подсети идентификатор (VSID) с помощью ключа TNI или VNI в заголовке инкапсулированный пакет. VSID должен быть уникальным в центре обработки данных и находится в диапазоне от 4096 до 2 ^ 24-2.  
  
Ключевое преимущество использования виртуальной сети и домена маршрутизации — что это позволяет клиентам перенести топологию своих собственных сетей (например, IP-подсети) в облаке. На рис. 2 приведен пример, в котором компания Contoso располагает двумя раздельными сетями: сетью R & D и сетью продаж. Поскольку у данных сетей разные ID доменов маршрутизации, они не могут взаимодействовать друг с другом. То есть сеть R & D изолирована от сети Sales даже в том случае, если компании Contoso Корпорация Contoso R & D содержит три виртуальные подсети. Обратите внимание, что как RDID, так и VSID уникальным в центре обработки данных.  
  
![Клиентские сети и виртуальные подсети](../../../media/hyper-v-network-virtualization-technical-details-in-windows-server/VNetF6.gif)  
  
Рисунок 2: Клиентские сети и виртуальные подсети  
  
**Перенаправление для уровня 2**  
  
На рис. 2 виртуальные машины в VSID 5001 могут иметь свои пакеты, перенаправляться на виртуальные машины, которые также VSID 5001 через коммутатор Hyper-V. Входящие пакеты из виртуальной машины с VSID 5001 отправляются определенных VPort коммутатора Hyper-V. Коммутатором Hyper-V для этих пакетов применяются правила входящего (например, encap) и сопоставления (например, заголовок encapsulation). Пакеты затем пересылаются либо другой VPort на коммутатор Hyper-V (если целевой виртуальной машины подключен к одному узлу) или другой коммутатор Hyper-V на другой узел (если целевой виртуальной машины находится на другой узел).  
  
**Уровень 3 маршрутизации**  
  
Аналогичным образом виртуальные машины в VSID 5001 могут иметь свои пакеты, по HNV распределенный маршрутизатор, который присутствует в каждом узле Hyper-V виртуальный коммутатор маршрутизация на виртуальных машинах в VSID 5002 или VSID 5003. При предоставлении Hyper-V пакет коммутатор, HNV обновляет VSID входящего пакета в vsid конечной виртуальной машины. Это происходит только нахождение обоих Vsid в пределах одного RDID.  Таким образом виртуальные сетевые адаптеры с RDID1 не могут отправлять пакеты на виртуальные сетевые адаптеры с RDID2 без передачи через шлюз.  
  
> [!NOTE]  
> В описании потока пакетов выше термин «виртуальная машина» фактически означает виртуальный сетевой адаптер на виртуальной машине. Распространенный случай, имеет виртуальной машины только один виртуальный сетевой адаптер. В этом случае понятия «виртуальной машины» и «виртуальный сетевой адаптер» можно концептуально взаимозаменяемыми.  
  
Каждая виртуальная подсеть определяет подсеть IP уровня 3 и границы домена рассылки уровня 2 (у2) аналогично VLAN. При передаче пакета виртуальной машиной HNV использует репликации одноадресной передачи (UR) создайте копию исходный пакет и заменить конечный IP-адрес и MAC адреса каждой виртуальной машины, которые находятся в одном VSID.  
  
> [!NOTE]  
> Когда поставляется Windows Server 2016, многоадресных пакетов вещания и подсети будет осуществляться с помощью одноадресная репликация в. Не поддерживаются многоадресную маршрутизацию между подсетями и IGMP.  
  
Помимо представления домена рассылки, VSID обеспечивает изоляцию. Виртуальный сетевой адаптер в виртуализации сети, подключенные к порту коммутатора Hyper-V, имеющих правила списков ACL, которые применяются непосредственно к порту (virtualNetworkInterface REST ресурс) или виртуальной подсети (VSID), из которых она входит.  
  
Порт коммутатора Hyper-V должен иметь правила списков ACL применяется. Этот ACL может быть разрешить всем, запретить всем или более конкретные, чтобы разрешить только определенных типов трафика, на основе сопоставления 5-фрагментному (исходный IP-адрес, конечный IP-адрес, порт источника, порт назначения, протокола).  
  
> [!NOTE]  
> Расширения коммутатора Hyper-V не будут работать с HNVv2 в новый стек программно-конфигурируемые сети (SDN). HNVv2 реализуется с помощью расширения коммутатора Azure виртуальная платформа фильтрации (VFP), который не может использоваться совместно с любым другим расширением коммутатора стороннего производителя.  
  
## <a name="switching-and-routing-in-hyper-v-network-virtualization"></a>Переключение и маршрутизация при виртуализации сети Hyper-V  
HNVv2 реализует правильный Переключение уровня 2 (у2) и маршрутизации семантику уровня 3 (уровня 3) работать так же, как физический переключатель, или маршрутизатор будет работать. Если виртуальная машина подключена к к виртуальной сети HNV пытается подключиться к другой виртуальной машины в одной виртуальной подсети (VSID), его необходимо сначала Узнайте ЦС MAC-адрес удаленного виртуальной машины. Если имеется запись ARP для виртуальной машины назначения IP-адреса в таблице ARP исходной виртуальной машины, используется MAC-адрес из этой записи. Если запись не существует, исходной виртуальной машины будет отправлено широковещательный с запросом к MAC-адрес, соответствующий виртуальной машины назначения IP-адреса должны быть возвращены. Коммутатор Hyper-V перехватит этот запрос и отправить его агента узла. Агент узла будет искать в свою локальную базу данных для соответствующего MAC-адреса IP-адрес запрошенной конечной виртуальной машины.  
  
> [!NOTE]  
> Агент узла, который выступает в качестве сервера OVSDB использует variant VTEP схемы для хранения сопоставления ак — АП, MAC таблицы и т. д.  
  
Если доступна MAC-адрес, агент узла вставляет ответом ARP и отправляет восстановить виртуальную машину. После сетевой стек виртуальной машины имеет все необходимые L2 заголовка, соответствующего порта Hyper-V на коммутаторе V отправляются кадра. Внутренне коммутатора Hyper-V проверяет этот фрейм по правилам сопоставления N-фрагментному, назначенный порту V и применяет некоторые преобразования кадра, на основе этих правил. Важнее всего набора преобразований инкапсуляция применяется для создания заголовок инкапсуляции, с помощью NVGRE или VXLAN, в зависимости от политики, определенных на сетевого контроллера. На основе политики запрограммировано на агент узла, сопоставления ак — АП используется и для определения IP-адрес узла Hyper-V размещения виртуальной машины назначения. Коммутатор Hyper-V обеспечивает правильный правила маршрутизации и теги виртуальной локальной сети применяются к внешней пакетов, достигнет удаленный адрес PA.  
  
Если виртуальной машиной, подключенной к виртуальной сети HNV хочет создать соединение с виртуальной машиной в другой виртуальной подсети (VSID), пакет должен направляться соответствующим образом. HNV предполагается топологии звезды где имеется только один IP-адрес в пространстве ак, используется в качестве следующего прыжка для достижения все префиксы IP (значение один маршрут или шлюз). В настоящее время это применяет ограничение один маршрут по умолчанию и маршруты не по умолчанию не поддерживаются.  
  
### <a name="routing-between-virtual-subnets"></a>Маршрутизация между виртуальными подсетями  
В физической сети IP-подсеть является доменом уровня 2 (у2), в котором компьютеры (виртуальные и физические) могут связываться друг с другом напрямую. L2 домен является доменом рассылки, где записи ARP (IP:MAC адресов сопоставляются) будут получены с помощью запросы ARP, передаваемого на все интерфейсы и ответов ARP отправляются запрашивающего узла. Компьютер использует сведения MAC, узнали от ответа ARP полностью создать кадра L2, включая заголовки Ethernet. Тем не менее если IP-адрес находится в другой подсети уровня 3, ARP-запрос не переходят этой границы уровня 3. Вместо этого интерфейса маршрутизатора уровня 3 (следующего прыжка или основной шлюз) с IP-адрес источника подсети должен отвечать на эти запросы ARP с собственный MAC-адрес.  
  
В стандартной сети Windows, администратор может создать статические маршруты и назначьте их сетевого интерфейса. Кроме того обычно «шлюз» настроен для следующего прыжка IP-адрес для интерфейса, куда должны отправляться пакеты, предназначенные для маршрута по умолчанию (0.0.0.0/0). Пакеты отправляются на этот шлюз по умолчанию, если определенные маршруты не существует. Обычно это маршрутизатор для физической сети.  HNV использует встроенный маршрутизатор, который является частью узла и имеет интерфейс в каждом VSID для создания распределенного маршрутизатора виртуальной сети.  
  
Поскольку HNV предполагается Звездообразная топология, распределенный маршрутизатор HNV действует как шлюз по умолчанию один для всех типов трафика между виртуальными подсетями, являющимися частью одной и той же сети VSID. Адрес используется в качестве шлюза по умолчанию наименьшее IP-адрес в VSID и назначается распределенного маршрутизатора HNV. Это распределенного маршрутизатора обеспечивает весьма эффективный способ для всех типов трафика в сети VSID направляться соответствующим образом, так как каждый узел может напрямую направлять трафик в соответствующий узел без посредников.  Это особенно актуально, когда две виртуальные машины из одной сети виртуальных Машин, но из разных виртуальных подсетей находятся на одном физическом узле.  Как вы узнаете позже в этом разделе, пакету нет необходимости покидать физический узел.  
  
### <a name="routing-between-pa-subnets"></a>Маршрутизация между подсетями АП  
В отличие от HNVv1, выделенная одного АП IP-адрес для каждой виртуальной подсети (VSID) HNVv2 теперь использует один адрес IP-адресов PA. для каждого члена группы сетевых КАРТ объединение Switch-Embedded (SET). Развертывания по умолчанию предполагается, что двух Сетевых карт и присваивает два АП IP-адреса для каждого узла. Один узел имеет АП IP-адреса, назначенного с одной логической подсети поставщика (АП) на той же виртуальной сети. Две виртуальные машины клиентов в одной виртуальной подсети действительно может находиться на двух разных узлах, которые подключены к два логических подсетей другого поставщика. HNV будет строить внешнего IP заголовки инкапсулированный пакет на основе сопоставления ак — АП. Тем не менее использует стек TCP/IP узла для ARP АП шлюз по умолчанию и затем создает внешний заголовки Ethernet, в зависимости от ответа ARP. Как правило этот ответ ARP поступают интерфейса SVI на физических коммутатором или маршрутизатором уровня 3 места подключения узла. Поэтому зависит от уровня 3 маршрутизатор для маршрутизации инкапсулированные пакеты между подсетями логических поставщика HNV и виртуальных локальных сетей.  
  
### <a name="routing-outside-a-virtual-network"></a>Маршрутизация за пределами виртуальной сети  
Развертывание большинства клиентских сетей требует связи в среде HNV с ресурсы, которые не являются частью среды HNV. Шлюзы виртуализации сетей необходимы для обеспечения связи между этими двумя средами. Инфраструктуры, требующие использования шлюза HNV включают частное облако и гибридное облако. В основном шлюзы HNV необходимы для уровня 3 маршрутизации между внутренней и внешней сетях (физический) (включая NAT) или между различными сайтами и/или облаков (частный или общедоступный), которые используют туннель IPSec VPN или GRE.  
  
Шлюзы могут иметь различные физические конструктивные параметры. Они могут быть основаны на Windows Server 2016, встроены в верхней стойки (TOR) коммутатора выступающие в качестве шлюза VXLAN, доступ через виртуальный IP-адресов (VIP) объявленных балансировки нагрузки, включаться в другие существующие сетевые устройства, или может быть новым автономным сетевым устройством.  
  
Дополнительные сведения о параметрах шлюза RAS-сервера Windows см. в разделе [шлюза RAS-сервера](../../../../remote/remote-access/ras-gateway/RAS-Gateway.md).  
  
## <a name="packet-encapsulation"></a>Инкапсуляция пакета  
Каждый виртуальный сетевой адаптер в виртуализации сети связан с двумя IP-адресами:  
  
-   **Адрес клиента** (ЦС) IP-адрес, назначаемый клиентом на основе инфраструктуры своей интрасети. Данный адрес позволяет клиенту обмениваться сетевым трафиком с виртуальной машины, как если бы не факта ее перемещения общедоступного или частного облака. АК является видимым для виртуальной машины и доступным для клиента.  
  
-   **Адрес поставщика** (АП) IP-адрес, назначенный поставщиком услуг размещения и администраторам центров обработки данных, на основе инфраструктуры своей физической сети. АП появляется в сетевых пакетов, обмен ими производится с сервером под управлением Hyper-V, на котором размещается виртуальная машина. АП является видимым в физической сети, но не для виртуальной машины.  
  
Ак обслуживают топологию клиентской сети, которая виртуализируется и лишается фактические топологии базовой физической сети и адреса, как это реализовано для АП. На следующей схеме показаны концептуальные взаимоотношения ак виртуальных машин и АП сетевых инфраструктур как результат виртуализации сетей.  
  
![Концептуальная схема виртуализации сетей относительно физической инфраструктуры](../../../media/hyper-v-network-virtualization-technical-details-in-windows-server/VNetF2.gif)  
  
Рисунок 6: Концептуальная схема виртуализации сетей относительно физической инфраструктуры  
  
На данной схеме виртуальные машины клиента отправляют пакеты данных в пространстве ак, которые просматривают инфраструктуру физической сети через собственные виртуальные сети, или «туннели». В приведенном выше примере данные туннели можно сравнить с «конвертами» вокруг пакетов данных Contoso и Fabrikam с зелеными индексами (адресами типа АП), которые доставляются с узла-источника в левой части на узел назначения в правой. Ключ является то, каким образом данные узлы определяют «адреса отправки» (АП), соответствующие Contoso и Fabrikam ЦС, как «конверт» put вокруг пакетов, и как узлы назначения разворачивают пакеты и предоставлять на виртуальные машины Contoso и Fabrikam назначения правильно.  
  
Ключевые аспекты виртуализации сетей помощи простой аналогии:  
  
-   Каждая виртуальная машина ЦС сопоставляется с АП физического узла Может существовать несколько центров сертификации, связанных с одним АП.  
  
-   Виртуальные машины отправляют пакеты данных в пространствах ак, которые заключаются в «конверт» и снабжаются парой АП источника и назначения на основе произведенного сопоставления.  
  
-   Сопоставления ак — АП должны позволять узлам производить дифференциацию пакетов для различных клиентских виртуальных машин.  
  
В результате механизм виртуализации сетей сводится к виртуализации сетевых адресов, используемым виртуальными машинами. Сетевой контроллер отвечает за сопоставление адресов, а также агент узла поддерживает сопоставление базы данных, с помощью схемы MS_VTEP. В следующем разделе описывается собственно механизм виртуализации адресов.  
  
## <a name="network-virtualization-through-address-virtualization"></a>Виртуализация сетей при помощи виртуализации адресов  
HNV реализует накладывать сетей клиента с помощью сети виртуализации универсального Routing Encapsulation (NVGRE) и виртуальные расширяемые локальной сети (VXLAN).  VXLAN используется по умолчанию.  
  
### <a name="virtual-extensible-local-area-network-vxlan"></a>Расширяемые виртуальной локальной сети (VXLAN)  
Виртуальные расширяемые локальной сети (VXLAN) ([RFC 7348](http://www.rfc-editor.org/info/rfc7348)) протокола широкое распространение на рынке с поддержкой из поставщиков, таких как Cisco, Brocade, Arista, Dell, HP и другие. VXLAN протокол UDP использует в качестве транспорта. Назначенный IANA UDP-порт назначения для VXLAN 4789 и UDP-порт источника должны отображаться сведения из внутреннего пакета для распространения ECMP хэш. После заголовка UDP заголовка VXLAN добавляется пакет, который включает в себя зарезервированное 4-байтовых поле, за которым следует 3 байтом для VXLAN сети идентификатор (VNI) - VSID - следуют другой зарезервированное поле 1 байта. После заголовка VXLAN добавляется исходного кадра L2 ЦС (без кадре Ethernet ЦС FCS).  
  
![Заголовок VXLAN пакета](../../../media/hyper-v-network-virtualization-technical-details-in-windows-server/VXLAN-packet-header.png)  
  
### <a name="generic-routing-encapsulation-nvgre"></a>Инкапсуляции маршрутов (NVGRE)  
Этот механизм виртуализации сети использует Generic Routing Encapsulation (NVGRE) как часть заголовка туннеля. В механизме NVGRE пакет виртуальной машины инкапсулируется в другой пакет. Заголовок этого нового пакета снабжается соответствующие адресами источника и назначения IP-адресов PA. в дополнение к ID виртуальной подсети, хранящемуся в ключевом поле заголовка GRE, как показано на рисунке 7.  
  
![Инкапсуляция NVGRE](../../../media/hyper-v-network-virtualization-technical-details-in-windows-server/VNetF3.gif)  
  
На рис. 7: Виртуализация сетей — инкапсуляция NVGRE  
  
ID виртуальной подсети позволяет узлам идентифицировать клиентскую виртуальную машину для каждого отдельного пакета, даже в случае АП и ак на пакетах могут перекрываться. Это позволяет всем виртуальным машинам одного узла совместно использовать единый АП, как показано на рисунке 7.  
  
Совместное использование АП оказывает серьезное воздействие на масштабируемость сети. Количество IP- и MAC-адресов, требующих запоминания сетевой инфраструктурой может быть существенно снижено. Например если на каждом конечном узле имеется в среднем 30 виртуальных машин, количество IP- и MAC-адресов, требующих запоминания сетевой инфраструктурой, снижается на коэффициент 30. ID виртуальной подсети, включенные в пакеты также позволяют производить простую корреляцию пакетов под фактических клиентов.  
  
АП, общий доступ к схему для Windows Server 2012 R2 — одного АП на VSID для каждого узла. Для Windows Server 2016 схема является одного АП на члена группы сетевых КАРТ.  
  
Windows Server 2016 и более поздних версий HNV полностью поддерживает NVGRE и VXLAN сразу после установки; он не требует обновления имеющегося или приобретения нового сетевого оборудования, например сетевых карт (сетевых адаптеров), коммутаторов или маршрутизаторов. Это обусловлено этих пакетов по сети обычным IP-пакетом в пространстве АП, совместимом с современной сетевой инфраструктурой.  Тем не менее для получения максимальной эффективности использования производительности поддерживается сетевых адаптеров с последние версии драйверов, поддерживающих технологии разгрузки задач.  
  
## <a name="multi-tenant-deployment-example"></a>Пример развертывания нескольких клиентов  
Следующей схеме представлен пример развертывания двух клиентов, размещенных в облаке центра обработки данных с взаимоотношений адресов ак-АП, определяемых политикой сети.  
  
![Пример развертывания нескольких клиентов](../../../media/hyper-v-network-virtualization-technical-details-in-windows-server/VNetF5.png)  
  
Рисунок 8: Пример развертывания нескольких клиентов  
  
Рассмотрим пример на рис. 8. До перехода к поставщику услуг размещения в службе IaaS, обеспеченной:  
  
-   Компания Contoso задействовала SQL Server (с именем **SQL**) по IP-адресу 10.1.1.11 и веб-сервер (с именем **Web**) по IP-адресу 10.1.1.12, который использует свой SQL Server для транзакций базы данных.  
  
-   Компания Fabrikam задействовала SQL Server, также называется **SQL** и назначенный IP-адрес 10.1.1.11 и веб-сервер, тоже именуемый **Web** также по IP-адрес 10.1.1.12, который использует свой SQL Server для транзакций базы данных.  
  
Мы предполагаем, что поставщик услуг размещения ранее создала поставщика (АП) логической сети с помощью сетевого контроллера в соответствии с их топологии физической сети. Сетевой контроллер предоставляет два АП IP-адреса из префикса логической подсети IP-адреса, где узлы подключены. Сетевой контроллер также указывает, соответствующего тега виртуальной локальной сети для применения IP-адресов.  
  
Затем с помощью сетевого контроллера, компании Contoso и Fabrikam создавать свои виртуальной сети и подсети, которые содержатся в логической сети поставщика (АП), указанный поставщиком услуг размещения. Компании Contoso и Fabrikam переместили свои соответствующие серверы SQL Server и веб-серверы для того же поставщика услуг размещения общей службы IaaS, где, по случайному совпадению, они задействовали **SQL** виртуальных машин на узле 1 Hyper-V и **Web** виртуальных машин (IIS7) на узле 2 Hyper-V. Все виртуальные машины сохраняют свои исходные внутрисетевые IP-адреса (свои ак).  
  
Обеим компаниям назначаются следующие ID виртуальной подсети (VSID) с сетевого контроллера, как показано ниже.  Агент узла на каждом из узлов Hyper-V получает выделенный АП IP-адреса из сетевого контроллера и создает две виртуальные сетевые карты узла PA в секцию сети не по умолчанию. Сетевой интерфейс назначаются для каждого из этих виртуальные сетевые карты узла, которой назначена АП IP-адрес, как показано ниже:  
  
-   Виртуальные машины компании Contoso VSID и АП: **VSID** — 5001, **АП SQL** — 192.168.1.10, **Web АП** — 192.168.2.20  
  
-   Виртуальные машины компании Fabrikam VSID и АП: **VSID** — 6001, **SQL АП** — 192.168.1.10, **Web АП** — 192.168.2.20  
  
Сетевой контроллер настраивает все политики сети (включая сопоставления ак — АП), чтобы агент SDN узла, который будет поддерживать политики в постоянном хранилище (в таблицах базы данных OVSDB).  
  
Когда виртуальная машина Web компании Contoso (10.1.1.12) на узле 2 Hyper-V создает TCP-подключение к SQL Server адресу 10.1.1.11, происходит следующее:  
  
-   ARPs виртуальной Машины для места назначения MAC-адрес 10.1.1.11  
  
-   Расширение VFP в виртуальный коммутатор перехватывает этот пакет и отправляет его на агент узла SDN  
  
-   Агент узла SDN выглядит в своем хранилище политики для MAC-адрес 10.1.1.11  
  
-   Если найден MAC агента узла вставляет ARP ответ обратно виртуальной Машины  
  
-   Если MAC не найден, отправляется нет ответа, а запись ARP в виртуальной Машине для 10.1.1.11 помечен недоступен.  
  
-   Виртуальная машина теперь выполняет построение пакета TCP с правильный заголовков ЦС Ethernet и IP-адреса и отправляет его на виртуальный коммутатор  
  
-   Этот пакет через VFP уровни (описано ниже) назначены исходный виртуальный коммутатор порт, на котором был получен пакет и создает новую запись потока в таблице единый поток VFP обрабатывает расширении переадресации VFP в виртуальный коммутатор  
  
-   Модуль VFP выполняет поиск правила соответствия или таблицу потоков для каждого уровня (например, уровень виртуальной сети), на основе заголовков IP и Ethernet.  
  
-   Соответствующие правила в слое виртуальной сети ссылается на пространство сопоставления ак — АП и выполняет инкапсуляция.  
  
-   Тип инкапсуляции (VXLAN или NVGRE) заданный в слое VNet вместе с VSID.  
  
-   В случае инкапсуляция VXLAN с VSID 5001 в заголовке VXLAN создается внешний заголовок UDP.  
    Адрес PA источника и назначения, назначенного узле 2 Hyper-V (192.168.2.20) и узел 1 Hyper-V (192.168.1.10) соответственно основании хранилище политики агента узла SDN создан внешний IP-заголовке.  
  
-   Этот пакет затем направляются на уровень АП маршрутизации в VFP.  
  
-   Уровень АП маршрутизации в VFP будет ссылаться секция сети, используется для трафика пространства АП и идентификатор виртуальной локальной сети и использовать стек TCP/IP узла для отправки пакетов АП на узел 1 Hyper-V правильно.  
  
-   При получении инкапсулированного пакета узел 1 Hyper-V для получения пакета в секции АП сети и отправлять их в виртуальный коммутатор.  
  
-   VFP обрабатывает пакет через его VFP слоев и создайте новую запись потока в таблице VFP единый поток.  
  
-   Модуль VFP соответствует правилам ingres в слое виртуальной сети и отделяет отключение внешнего инкапсулированный пакет Ethernet, IP и VXLAN заголовки.  
  
-   Модуль VFP пересылает пакет порт виртуальный коммутатор, к которому подключен назначения виртуальной Машины.  
  
Аналогичный процесс для трафика между Fabrikam Corp **Web** и **SQL** виртуальных машин использует параметры политики HNV для корпорации Fabrikam Corp. В результате с виртуальными машинами HNV, компании Fabrikam и Contoso взаимодействуют так как если бы они находились в своих интрасетях. Они не могут взаимодействовать друг с другом, даже если они используют одинаковые IP-адреса.  
  
Раздельные адреса (ак и АП), параметры политики узлов Hyper-V и преобразование адресов ак и АП трафика входящего и исходящего трафика виртуальных машин изолируют эти комплекты серверов с помощью ключа NVGRE или VLXAN VNID. Кроме того сопоставления виртуализации и преобразование лишают привязки архитектуру виртуальной сети с инфраструктурой физической сети. Несмотря на то что Contoso **SQL** и **Web** и Fabrikam **SQL** и **Web** располагаются в их собственных подсетях IP (10.1.1/24), их физическое развертывание происходит на двух узлах в разных АП подсетей, 192.168.1/24 и 192.168.2/24, соответственно. Суть в том, что перекрестно подсетевое выделение виртуальных машин и Динамическая миграция становятся возможными с HNV.  
  
## <a name="hyper-v-network-virtualization-architecture"></a>Архитектура виртуализации сетей Hyper-V  
В Windows Server 2016 HNVv2 реализуется с помощью Azure виртуальная платформа фильтрации (VFP) которого является расширением фильтрации NDIS в коммутаторе Hyper-V. Главный принцип VFP, что подсистемы обработки потока соответствия действий с внутренним API для агента узла SDN программирования политики сети. Агент узла SDN сам получает политики сети из сетевого контроллера через каналы связи OVSDB и Южный WCF. Не только является политики виртуальной сети (например сопоставления ак — АП) запрограммированы использование VFP, но дополнительные политики, такие как списки управления доступом, QoS и т. д.  
  
Иерархии объектов для виртуального коммутатора и расширении переадресации VFP выглядит следующим образом:  
  
-   виртуальный коммутатор  
  
    -   Внешний сетевой Адаптер управления  
  
    -   Технологии разгрузки оборудования сетевого Адаптера  
  
    -   Глобальные правила перенаправления  
  
    -   Порт  
  
        -   Переадресации для закрепления ограничитель слой исходящего трафика  
  
        -   Списки пространства для сопоставления и пулы NAT  
  
        -   Таблица единый поток  
  
        -   Уровень VFP  
  
            -   Таблицу потоков  
  
            -   Группы  
  
            -   Правило  
  
                -   Правила можно добавлять ссылки на пространства  
  
В VFP слой создается для каждого типа политики (например, виртуальная сеть) и является общий набор таблиц поток или правила. Он не имеет никаких встроенных функциональных возможностей до этого уровня для реализации таких функций, назначаются определенные правила. Работоспособность каждого уровня назначается приоритет и слои назначенный порту по возрастанию приоритет. Правила упорядочены по группам в соответствии с главным образом на направление текста и семейство адресов IP. Группы назначены приоритет и не более одного правила из группы может соответствовать данного потока.  
  
Логика переадресации виртуальный коммутатор с расширением VFP выглядит следующим образом:  
  
-   Обработка входящих (входящего с точки зрения пакетов, поступающих в порт)  
  
-   Переадресации  
  
-   Обработка исходящего (исходящую с точки зрения пакетов, оставляя порт)  
  
VFP поддерживает внутреннее MAC переадресации для типов инкапсуляция NVGRE и VXLAN, а также внешнего пересылки на основе виртуальной ЛС MAC.  
  
Расширение VFP имеет медленный путь и fast-path для прохождения пакета. Первого пакета в потоке должен проходить через все групп правил на каждом уровне, а затем выполните правило поиска, который является ресурсоемкой операцией. Однако после регистрации поток в таблице единый поток со списком действий (на основе правил, соответствие) все последующие пакеты будут обработаны на основе записей таблицы единый поток.  
  
Агент узла запрограммирован политики HNV. Каждый сетевой адаптер виртуальной машины настраивается с IPv4-адрес. Они являются ЦС, который будет использоваться виртуальными машинами для связи друг с другом, и они поступают в IP-пакетах из виртуальных машин. HNV инкапсулирует кадра ЦС в кадре АП, основываясь на политиках сетевой виртуализации, хранятся в базе данных агента узла.  
  
![Архитектура HNV](../../../media/hyper-v-network-virtualization-technical-details-in-windows-server/VNetF7.png)  
  
Рисунок 9: Архитектура HNV  
  
## <a name="summary"></a>Сводка  
Центры обработки данных на основе облака могут обеспечивать множество преимуществ, например улучшенную масштабируемость и более эффективное использование ресурсов. Реализация этих потенциальных преимуществ требует применения технологии, посвященной принципиальному решению проблем многоклиентской масштабируемости в динамической среде. Виртуализация создана для решения этих проблем, а также для повышения эксплуатационной эффективности центра обработки данных за счет разделения топологии виртуальной сети для топологии физической сети. Построенная на основе существующего стандарта, HNV выполняется в современных центров обработки данных и работает в существующую инфраструктуру VXLAN. Клиентов с HNV, можно объединять свои центры обработки данных в частное облако или относительно легко расширять свои центры обработки данных до среды поставщика размещения сервера с гибридным облаком.  
  
## <a name="BKMK_LINKS"></a>См. также:  
Чтобы узнать больше о HNVv2 см. следующие ссылки:  
  
|Тип содержимого|Ссылки|  
|----------------|--------------|  
|**Ресурсы сообщества**|-   [Блог по архитектуре частного облака](http://blogs.technet.com/b/privatecloud)<br />-Задавайте вопросы:[cloudnetfb@microsoft.com](mailto:%20cloudnetfb@microsoft.com)|  
|**RFC**|-   [ЧЕРНОВОЙ документ RFC](http://www.ietf.org/id/draft-sridharan-virtualization-nvgre-07.txt)<br />-   [VXLAN - RFC 7348](http://www.rfc-editor.org/info/rfc7348)|  
|**Связанных технологиях**|-Техническое описание виртуализации сетей Hyper-V в Windows Server 2012 R2, в разделе [техническое описание виртуализации сетей Hyper-V](https://technet.microsoft.com/library/jj134174.aspx)<br />-   [Сетевой контроллер](../../../sdn/technologies/network-controller/Network-Controller.md)|  
  


