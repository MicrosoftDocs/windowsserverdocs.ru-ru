

## <a name="windows-server-2016-improvements"></a>Улучшения в Windows Server 2016
### <a name="windows-time-service-and-ntp"></a>Служба времени Windows и NTP
Windows Server 2016 имеет улучшенные алгоритмы, используемые для правильного времени и условного локальные часы для синхронизации с UTC.  NTP использует 4 значения для вычисления смещение времени, в зависимости от метки времени клиента запрос/ответ и запрос/ответ сервера.  Тем не менее сети кишат и может быть всплески данные из NTP из-за перегрузки сети и других факторов, влияющих на задержки в сети.  Алгоритмы Windows 2016 в среднем шума с помощью нескольких различных способов в стабильной точности и актуальности часов.  Кроме того источника мы используем для ссылки на точное время улучшенные API, которые обеспечивают лучшее разрешение.  С этими улучшениями мы смогли достичь 1 мс точности времени UTC в домене.

### <a name="hyper-v"></a>Hyper-V
Windows 2016 повысила службы TimeSync Hyper-V. Усовершенствования включают более точные исходное время на VM start "или" Восстановление виртуальной Машины "и" исправление задержки прерываний для примеров, предоставленные w32time.  Это улучшение позволяет оставаться 10µs с узла с помощью RMS, (корневой среднеквадратическая, указывающий дисперсия), из 50µs, даже на компьютере с 75% нагрузки. Дополнительные сведения см. в разделе [архитектура Hyper-V](https://msdn.microsoft.com/library/cc768520.aspx).

> [!NOTE]
> Нагрузки был создан с помощью prime95 теста производительности с помощью взаимосвязанных профиля.

Кроме того уровень первого уровня, который узел сообщает о гостевой является более прозрачной.  Ранее узла должны выводиться фиксированной иерархической 2, независимо от его точность.  Изменения в Windows Server 2016 узел хостинга stratum 1 больше, чем stratum узла, что приводит к более подходящего момента для гостевые виртуальные машины.  Stratum узла определяется w32time, используя обычные средства на основе времени ее источника.  Гости найти наиболее точную часы, а не по умолчанию используется узел 2016 Windows, присоединенный к домену.  Было по этой причине мы рекомендуем вручную отключить параметр поставщика времени Hyper-V для машин, входящих в домен Windows 2012 R2 и ниже.

### <a name="monitoring"></a>Мониторинг
Счетчики монитора производительности были добавлены.  Они позволяют создавать базовый план, наблюдения и диагностики точность времени.  Эти счетчики включают:

Счетчик|Описание|
----- | ----- |
Вычислить смещение времени|   Абсолютный сдвига по времени между системных часов и источник времени, как вычисляется по служба W32Time в микросекундах. Если доступен новый образец допустимым, вычисляемый времени обновляется временное смещение указано в образце. Это смещение локальные часы реального времени. W32Time инициирует Коррекция часы, с использованием смещения и обновляет от вычисляемого времени между примеры оставшиеся смещение времени, который должен применяться к локальные часы. Точность часов можно отследить с помощью этого счетчика производительности с низким интервалом опроса (например: 256 секунд или меньше) и найти значение счетчика может быть меньше, чем ограничение точность требуемой часов.|
Настройки частоты часов| Настройки частоты абсолютный часов, выполненные локальные системные часы с W32Time в частях каждого billion. Этот счетчик помогает визуализировать действий по W32time.|
Задержка NTP|    Последние задержка приема-передачи, из-за NTP-клиента в получении ответа от сервера, в микросекундах. Это время, затраченное на клиенте NTP между передачи запрос на NTP-сервером и получения допустимый ответ от сервера. Этот счетчик помогает характеризовать задержки, возникающей при работе с NTP-клиента. Большего размера или изменяющиеся циклические операции можно добавить вычисления времени NTP, которые в свою очередь может повлиять на точность синхронизации времени через NTP шума.|
Число источников клиента NTP|    Активный номер источников времени NTP, используется NTP-клиента. Это число active, уникальных IP-адресов серверов времени, которые отвечают на запросы клиента. Это число может быть больше или меньше настроенного одноранговых узлов, в зависимости от разрешения имен одноранговых узлов и существующая reach функция в DNS.|
NTP-сервер входящие запросы|   Число запросов, полученных сервером NTP (запросов/сек).|
Ответы исходящего сервера NTP|  Число запросов, ответы на NTP-сервер (ответов в секунду).|

Первых трех счетчиков целевых сценариях для устранения неполадок точности.  Устранение неполадок точность времени и NTP раздел ниже, в разделе [рекомендации](#BestPractices), имеет более подробно.
3 последних счетчики охватывают NTP-серверов. они полезные when определения нагрузки и базовые показатели текущей производительности.

### <a name="configuration-updates-per-environment"></a>Обновления конфигурации каждой среды
Ниже описаны изменения в конфигурации по умолчанию между Windows 2016 и более ранние версии для каждой роли.  Параметры для Windows Server 2016 и Юбилейное обновление Windows 10 (сборка 14393), теперь являются уникальными, поэтому существует, отображаются как отдельные столбцы. 

|Роль|Параметр|Windows Server 2016|Windows 10|Windows Server 2012 R2</br>Windows Server 2008 R2</br>Windows 10|
|---|---|---|---|---|
|**Автономный или Nano Server**||||
| |*Сервер времени*|Time.Windows.com|Н/Д|Time.Windows.com|
| |*Частота опроса*|64 - 1024 секунд|Н/Д|Один раз в неделю|
| |*Тактовой частоты обновления*|Один раз в секунду|Н/Д|Один раз в час|
|**Автономный клиент**||||
| |*Сервер времени*|Н/Д|Time.Windows.com|Time.Windows.com|
| |*Частота опроса*|Н/Д|Один раз в день|Один раз в неделю|
| |*Тактовой частоты обновления*|Н/Д|Один раз в день|Один раз в неделю|
|**Контроллер домена**||||
| |*Сервер времени*|ОСНОВНОЙ КОНТРОЛЛЕР ДОМЕНА/GTIMESERV|Н/Д|ОСНОВНОЙ КОНТРОЛЛЕР ДОМЕНА/GTIMESERV|
| |*Частота опроса*|64-1024 секунд|Н/Д|1024 - 32768 секунд|
| |*Тактовой частоты обновления*|Один раз в день|Н/Д|Один раз в неделю|
|**Рядовой сервер домена**||||
| |*Сервер времени*|DC|Н/Д|DC|
| |*Частота опроса*|64-1024 секунд|Н/Д|1024 - 32768 секунд|
| |*Тактовой частоты обновления*|Один раз в секунду|Н/Д|Каждые 5 минут|
|**Клиент член домена**||||
| |*Сервер времени*|Н/Д|DC|DC|
| |*Частота опроса*|Н/Д|1204 - 32768 секунд|1024 - 32768 секунд|
| |*Тактовой частоты обновления*|Н/Д|Каждые 5 минут|Каждые 5 минут|
|**Гость Hyper-V**||||
| |*Сервер времени*|Выбирает наилучший вариант, в зависимости от первого уровня узла и время сервера|Выбирает наилучший вариант, в зависимости от первого уровня узла и время сервера|Значения по умолчанию для узла|
| |*Частота опроса*|На основе роли выше|На основе роли выше|На основе роли выше|
| |*Тактовой частоты обновления*|На основе роли выше|На основе роли выше|На основе роли выше|

>[!NOTE]
>Linux в Hyper-V, см. в разделе [позволяя Linux для использования временем узла Hyper-V](#AllowingLinux) разделе ниже.

### <a name="impact-of-increased-polling-and-clock-update-frequency"></a>Влияние повышения опроса и тактовой частоты обновления
Чтобы обеспечить более точное время, увеличиваются значения по умолчанию для опроса частоты и обновления часов, чему мы можем чаще внести незначительные изменения.  Это приведет к увеличению трафика UDP/NTP, тем не менее, эти пакеты будут небольшой, поэтому следует быть очень мало или его отсутствием высокоскоростное связей. Тем не менее, это преимущество, время должно быть лучше на широкий спектр оборудования и среды.

Для устройств резервного аккумулятора повышение частоты опроса могут возникнуть проблемы.  Батареи устройства не храните времени при отключенной.  При возобновлении, может потребоваться часто исправления часы.  Повышение частоты опроса приведет часов работать нестабильно, а также может использовать больше возможностей.  Корпорация Майкрософт рекомендует не изменять параметры клиента по умолчанию.

Контроллеры домена должно как минимум повлиять даже с умножением последствия увеличение обновления из клиентов NTP в домене AD.  NTP имеет гораздо меньшее потребление ресурсов, по сравнению с другими протоколами и граничной влияние.  Скорее всего для достижения ограничения для другие функциональные возможности домена перед понижает расширенные настройки для Windows Server 2016.  Active Directory используйте безопасный NTP, что обычно менее точно, чем простой NTP синхронизировать время, но мы убедились, что он будет Масштабирование до первого уровня двух клиентов от основной контроллер домена.

Консервативная плана необходимо зарезервировать 100 NTP запросов в секунду на ядро.  Например домен, состоящий из 4 контроллеры домена с 4 ядра, можно для обслуживания 1600 NTP запросов в секунду.  Если у вас есть 10 k клиенты, настроенные для синхронизации времени каждые 64 секунд, а запросы равномерно со временем, вы увидите 10 000/64, или около 160 запросов в секунду, распределены между все контроллеры домена.  Это легко попадает в нашей 1600 NTP запросов в секунду на основе данного примера.  Это консервативной рекомендации по планированию и конечно с зависимостями большой сети, скорости процессора и загрузке так, чтобы всегда базовых показателей и тестирования в своих средах.

Также важно отметить, что если контроллеры доменов работают под управлением с значительную нагрузку ЦП, более 40%, это почти наверняка добавить шум NTP ответов и влияют на точность времени в вашем домене.  Опять же необходимые для тестирования в среде, чтобы понять фактические результаты.

## <a name="time-accuracy-measurements"></a>Точность измерения времени
### <a name="methodology"></a>Методология
Для измерения точности времени для Windows Server 2016, мы использовали различные средства, методы и сред.  Эти методы можно использовать для измерения и настройка среды, а также определить, если результаты точности соответствовать вашим требованиям. 

Наши часами исходного домена состоял из двух серверов NTP высокой точности с оборудования GPS.  Мы также используется отдельная ссылка тестового компьютера для измерения, которые также были установлены другого производителя оборудования GPS высокой точности.  В некоторых случаях тестирования необходимо будет источником точных и надежных часов для использования в качестве ссылки в дополнение к источник времени вашего домена.

Мы использовали четырьмя разными методами, можно измерить точность с физическими и виртуальными машинами. Несколько методы, предоставленные независимыми означает, что для проверки результатов.


1. Локальные часы, что обусловлено w32tm, измерить наших ссылку теста компьютер с отдельной оборудования GPS.  
2.  Мера NTP запросы проверки связи от NTP-сервера к клиентам, использующим W32tm «stripchart»
3.  Мера NTP запросов проверки связи от клиента к NTP-сервер, с помощью W32tm «stripchart»
4.  Между узлом и гостей с помощью счетчика отметки времени (TSC) результаты мер Hyper-V.  Этот счетчик распределяется между секциями и системное время в обоих разделов.  Мы вычислили разница между временем узла и время клиента на виртуальной машине.  Затем мы используем TSC часы для интерполяции время узла из гостевой ОС, так как размеры не происходят одновременно.  Кроме того мы используем TSV часов отделяют задержки и задержки в API.

W32tm является встроенной функцией, но другим средствам, которые мы использовали в процессе тестирования доступны для Microsoft репозитория в GitHub, как открытый исходный код для тестирования и использования.  Вики-сайте в репозитории есть Дополнительные сведения, в которых описываются способы использования средств для выполнения измерения.

> [https://github.com/Microsoft/Windows-Time-Calibration-Tools](https://github.com/Microsoft/Windows-Time-Calibration-Tools)

В приведенных ниже результатах тестирования — это подмножество измерений, которые мы внесли в одном из тестовых сред.  Они иллюстрируют точности, поддерживаемой на начало временной иерархии и клиент дочернего домена в конце иерархии времени.  Это сравнивается с тех же компьютерах в топологии на основе 2012 для сравнения.

### <a name="topology"></a>Топология
Для сравнения мы протестировали Windows Server 2012 R2 и Windows Server 2016 на основе топологии.  Обеих топологиях состоят из двух физических компьютерах узла Hyper-V, которые ссылаются на компьютере с Windows Server 2016 с помощью установленного оборудования GPS часов.  На каждом узле выполняется 3 присоединенных к домену гостевых систем windows, которые упорядочиваются в соответствии с следующую топологию.  Линии представляют иерархию времени, а также протокола или транспорта, который используется.

![Служба времени Windows](../media/Windows-Time-Service/Windows-2016-Accurate-Time/topology1.png)

![Служба времени Windows](../media/Windows-Time-Service/Windows-2016-Accurate-Time/topology2.png)

### <a name="graphical-results-overview"></a>Обзор графических результатов
Следующие две диаграммы представления времени точности для двух отдельных элементов в домене, на основе топологии выше.  Каждый граф отображает Windows Server 2012 R2 и 2016 результаты накладывается, который визуально показывает улучшения.  Точность была меру в гостевом компьютере по сравнению с узла.  Графические данные представляет собой подмножество всего набора тестов, мы сделали и отображает его лучшем случае и самым худшим сценариям.  

![Служба времени Windows](../media/Windows-Time-Service/Windows-2016-Accurate-Time/topology3.png)

### <a name="performance-of-the-root-domain-pdc"></a>Производительность корневого домена основного контроллера домена
Корневой PDC синхронизируется узлу Hyper-V (с помощью VMIC), который используется Windows Server 2016, с помощью оборудования GPS, проверенные быть точным и стабильными.  Это является важным требованием для 1 ms точности, которое отображается как зеленый затененную область.

![Служба времени Windows](../media/Windows-Time-Service/Windows-2016-Accurate-Time/chart1.png)

### <a name="performance-of-the-child-domain-client"></a>Производительность клиента дочернего домена
Клиент дочерних доменов, присоединяется к дочернего домена PDC, в который взаимодействует с основным контроллером домена корневого.  Времени также находится в пределах 1 мс требование.

![Служба времени Windows](../media/Windows-Time-Service/Windows-2016-Accurate-Time/chart2.png)


### <a name="long-distance-test"></a>Междугороднее теста
Следующая диаграмма сравнивает 1 прыжка виртуальной сети, чтобы 6 прыжков физической сети с помощью Windows Server 2016.  Две диаграммы наложенные на друг с другом с прозрачностью для отображения перекрывающихся данных.  Все большее число прыжков сети означает большее время задержки и увеличить время отклонения.  Диаграммы увеличенной и поэтому 1 границы ms, представленный Зеленая область имеет больший размер.  Как вы видите, время, по-прежнему в пределах 1 мс с через несколько прыжков.  Отрицательно сдвигом, который показывает асимметрию сети.  Конечно отличается каждой сети, и измерения зависит от множества факторов окружающей среды.

![Служба времени Windows](../media/Windows-Time-Service/Windows-2016-Accurate-Time/chart3.png)

## <a name="BestPractices"></a>Рекомендации по точные хронометраж
### <a name="solid-source-clock"></a>Часы сплошной источника
Время машин будет настолько надежным, как часы источника, которые она синхронизируется с.  Чтобы добиться 1 мс точности, вам потребуется оборудование GPS или appliance времени в сети, необходимо сослаться как часы основного источника.  Использовать по умолчанию time.windows.com, может не предоставлять стабильными и локальным источником.  Кроме того как вы получаете еще больше отдаленными от источника часы, сети влияет на точность.  С часами главного источника в каждой data center необходим для наибольшей точностью.

### <a name="hardware-gps-options"></a>Параметры оборудования GPS
Существуют различные решения оборудования, которые может предложить точное время.  Как правило решения уже сегодня основаны на антенны GPS.  Существуют также рекламу на радио и решений удаленного доступа, с помощью выделенной строки.  Они подключить к сети как устройство или подключите ПК, например Windows с помощью PCIe или USB-устройства.  Различные варианты будут предоставлять различные уровни точности и как всегда, результаты зависят от среды.  Переменные, которые влияют на точность включают доступности GPS, стабильности сети и загрузки и Компьютерного оборудования.  Это все важные факторы при выборе источника часов, которая как мы уже говорилось, является требованием для стабильной и точное время.

### <a name="domain-and-synchronizing-time"></a>Домен и синхронизация времени
Члены домена использует доменную структуру, чтобы определить компьютер, на котором они использовать в качестве источника для синхронизации времени.  Каждый член домена будет найти другой компьютер для синхронизации с и сохраните его как источник времени.  Каждый тип члена домена следует другой набор правил, чтобы найти источник времени для синхронизации времени.  Основной контроллер домена в корне леса является источником часов по умолчанию для всех доменов.  Ниже перечислены различные роли и высокий уровень описание уровня поиска источника.


- **Контроллер домена с ролью PDC** — этот компьютер является достоверным источником времени для домена. Он будет иметь время отображалось максимально точно в домене и необходимо синхронизировать с контроллером домена в родительском домене, за исключением в случаях когда [GTIMESERV](#GTIMESERV) включена роль. 
- **Любой другой контроллер домена** — этот компьютер будет выступать в качестве источника времени для клиентов и рядовых серверов в домене. Контроллер домена могут синхронизироваться с основным контроллером домена свой собственный домен или любого контроллера домена в его родительским доменом.
- **Клиенты и рядовых серверах** — этот компьютер можно синхронизировать с контроллера домена или контроллер домена из собственного домена или контроллера домена или контроллер домена в родительском домене.

Исходя из доступных кандидатов, оценки системы позволяет найти лучший источник времени.  В учетной записи эта система обеспечивает надежность источника времени и соответствующее ей относительное местоположение.  Это происходит после при время служба запущена.  Если требуется более тонко управлять как синхронизирует время, можно добавить серверы подходящий момент в определенных местах или добавление избыточности.  См. в разделе [укажите локальный надежных время службы с помощью GTIMESERV](#GTIMESERV) Дополнительные сведения.

#### <a name="mixed-os-environments-win2012r2-and-win2008r2"></a>ОС смешанных средах (Win2012R2 и Win2008R2)
Хотя чистую среду домен Windows Server 2016 не требуется для лучшей точностью, все еще существуют преимущества в смешанной среде.  Развертывание Windows Server 2016 Hyper-V в Windows 2012 домене смогут воспользоваться преимуществами Гости, из-за улучшений, которые мы упоминали выше, но только если Гости также являются Windows Server 2016.  Windows Server 2016 основной контроллер домена, будут иметь возможность предоставлять более точное время из-за улучшенные алгоритмы, будет работать стабильнее источника.  Как замена основной контроллер домена не может быть приемлемым вариантом, можно использовать вместо этого контроллера домена Windows Server 2016 с [GTIMESERV](#GTIMESERV) наката набора, что было бы обновления в точности для вашего домена.  Обеспечивает лучшее время подчиненных времени клиентам возможности контроллера домена Windows Server 2016, тем не менее, он не только источник времени NTP.

Кроме того, как уже говорилось тактовая частота опроса и обновления были изменены с помощью Windows Server 2016.  Их также можно менять вручную для контроллеров доменов низкого уровня или примененных посредством групповой политики.  Хотя мы не проверяли работу этих конфигураций, они должны вести себя в Win2008R2 и Win2012R2 и предоставлять некоторые преимущества.

Версии раньше, чем Windows Server 2016 несколько проблем, сохранение точное время, сохранение, что привело к системе время именно сразу после корректировку.  По этой причине получения примеры времени точный источник NTP часто и сглаживание локальные часы с данными приводит к меньшего размера смещение в часах системы в точку внутри выборку, приводит к более подходящего момента, размещая на версий ОС нижнего уровня. Лучше всего наблюдаемых точность была примерно 5 мс NTP клиента Windows Server 2012 R2, настроены параметры высокой точности, синхронизации времени с точные Windows 2016 NTP-сервера.

В ситуации с участием гостевой контроллеров домена примеры TimeSync Hyper-V может препятствовать операциям домена синхронизацию времени.  Это больше не должно быть проблемой для гостей Server 2016, работающих на узлах Server 2016 Hyper-V.

Чтобы отключить службу TimeSync Hyper-V из предоставлять примеры для w32time, настройте следующий раздел реестра гостевой:

    HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\W32Time\TimeProviders\VMICTimeProvider 
    "Enabled"=dword:00000000

#### <a name="AllowingLinux"></a>Позволяя Linux для использования временем узла Hyper-V
Для гостевых систем Linux, работающих в Hyper-V клиенты обычно настроены для использования управляющую программу NTP для синхронизации времени с NTP-серверы.  Если дистрибутив Linux поддерживает протокол версии 4 TimeSync и гостевой виртуальной машины Linux имеет включена служба интеграции TimeSync, оно синхронизируется с временем узла. Это может привести к несогласованности раз, запоминая, если включены оба метода.

Чтобы синхронизировать исключительно с временем узла, рекомендуется отключить функцию синхронизации времени NTP с помощью:

- Отключение NTP-серверы, в файл ntp.conf
- или отключение управляющую программу NTP

В этой конфигурации сервер времени равен этого узла.  Частоту опроса составляет 5 секунд и от его тактовой частоты обновления также составляет 5 секунд.

Чтобы синхронизировать исключительно по NTP, рекомендуется отключить службу интеграции TimeSync в гостевой ОС.

> [!NOTE]
> Примечание.  Поддержка для точном времени с помощью гостевых ОС Linux требует это функция, которая поддерживается только в последней вышестоящего ядра Linux, и это не так, то, что еще широко доступны через все дистрибутивы Linux. См. в статье [виртуальных машин поддерживается Linux и FreeBSD для Hyper-V в Windows](https://technet.microsoft.com/windows-server-docs/virtualization/hyper-v/supported-linux-and-freebsd-virtual-machines-for-hyper-v-on-windows) Дополнительные сведения о распределениях поддержки.

#### <a name="GTIMESERV"></a>Укажите местное время надежные службы с помощью GTIMESERV
Можно указать один или несколько контроллеров домена как часы в точный источник с помощью GTIMESERV, хороший сервер времени, флаги.  К примеру определенные контроллеры домена с оборудования GPS могут оказаться помеченными как GTIMESERV.  Это будет гарантировать, что домен ссылается на часы на основе оборудования GPS.

> [!NOTE]
> Дополнительные сведения о флагах домена можно найти в [документации протокола MS-ADTS](https://msdn.microsoft.com/library/mt226583.aspx).

TIMESERV является другой связанных домена службы флаг, который указывает является ли компьютер в настоящее время заслуживающие доверия, который можно изменить, если контроллер домена теряет подключение.  Контроллер домена в этом состоянии возвращает «Неизвестный Stratum» при запросе через NTP.  После нескольких попыток, контроллер домена будет войти в службу времени событий системы событий 36.

Если вы хотите настроить контроллер домена как GTIMESERV, это можно настроить вручную с помощью следующей команды.  В этом случае контроллер домена использует другой компьютеры как синхронизирующий.  Это может быть устройства или выделенный компьютер.

    w32tm /config /manualpeerlist:”master_clock1,0x8 master_clock2,0x8” /syncfromflags:manual /reliable:yes /update

> [!NOTE]
> Дополнительные сведения см. в разделе [служба времени Windows](https://technet.microsoft.com/library/cc731191.aspx)

Если контроллер домена имеет установленного оборудования GPS, необходимо использовать следующие действия для отключения NTP-клиента и включения NTP-сервером.

Начните с отключения NTP-клиента и включите NTP-сервер, с помощью изменения этих разделов реестра.

    reg add HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\w32time\TimeProviders\NtpClient /v Enabled /t REG_DWORD /d 0 /f

    reg add HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\w32time\TimeProviders\NtpServer /v Enabled /t REG_DWORD /d 1 /f

После этого перезапустите службу времени Windows

    net stop w32time && net start w32time

Наконец вы указываете, что этот компьютер имеет одному надежного источника, используя.
   
    w32tm /config /reliable:yes /update

Чтобы проверить, что изменения были выполнены правильно, необходимо выполнить следующие команды, которые влияют на результаты, показанные ниже. 

    w32tm /query /configuration

Значение|Ожидаемому параметру|
----- | ----- |
AnnounceFlags|  5 (локальный)|
NTP-сервер   |(Local)|
DllName |C:\WINDOWS\SYSTEM32\w32time. Библиотеки DLL (локальный)|
Enabled |1 (локальный)|
NTP-клиент|  (Local)|

    w32tm /query /status /verbose

Значение|  Ожидаемому параметру|
----- | ----- |
Первого уровня|    1 (основная ссылка - синхронизирована с часами переключатель)|
ReferenceId|    0x4C4F434C (имя источника:  «LOCAL»)|
Source| Часов локального CMOS|
Смещение этапа|   0.0000000s|
Роль сервера|    576 (надежную службу времени)|

#### <a name="windows-server-2016-on-3rd-party-virtual-platforms"></a>Windows Server 2016 на 3-й сторонних поставщиков виртуальных платформах
Если сервер Windows виртуальный, по умолчанию низкоуровневая оболочка отвечает за предоставление времени.  Но члены должны иметь синхронизации с контроллером домена в порядке, для правильной работы в Active Directory присоединенных к домену.  Лучше всего отключить виртуализацию любое время между гостевой ОС и узлом любой стороны виртуального платформ.

#### <a name="discovering-the-hierarchy"></a>Обнаружение иерархии
Так как цепочку иерархии времени синхронизирующий источником является динамическим в домене, и согласование, вам потребуется запросить состояние конкретного компьютера, чтобы понять, что это источник времени, а также цепочки с часами главного источника.  Это может помочь в выявлении проблемы во время синхронизации.

Предоставил вам требуется устранить неполадки, определенному клиенту; Первый шаг — понять его источником времени с помощью этой команды w32tm.

    w32tm /query /status

Результаты отображаются в источнике, помимо прочего.  Источник указывает, с которым синхронизации времени в домене.  Это первый шаг этой иерархии времени машин.
Далее используем запись источника выше и использовать параметр /StripChart для следующего источника времени в цепочке.

    w32tm /stripchart /computer:MySourceEntry /packetinfo /samples:1

Также полезно, следующая команда перечислены каждого контроллера домена, его можно найти в указанном домене и выводит результат, который позволяет определить каждого участника.  Эта команда будет включать машин, которые были настроены вручную.
    
    w32tm /monitor /domain:my_domain

С помощью списка, можно отслеживать результаты через домен и иерархии, а также приведены смещение времени на каждом этапе.  Определив точки, где смещение времени получает значительно хуже, можно выявить корне неправильное время.  Оттуда можно попытаться понять, почему это время является неправильным, включив [ведения журнала w32tm](#W32Logging). 

#### <a name="using-group-policy"></a>С помощью групповой политики
Можно использовать групповую политику для выполнения более строгие точности, к примеру, для назначения клиентов для использования определенных NTP-серверы или ОС управления как нижнего уровня настраиваются при виртуализации.  
Ниже приведен список возможных сценариев и соответствующие параметры групповой политики.

**Виртуализированные доменов** — для управления виртуализированных контроллеров домена в Windows 2012 R2, чтобы они синхронизировать время с помощью своего домена, а не с узлом Hyper-V, вы можете отключить этот параметр реестра.   Для основного контроллера домена вы не хотите отключить запись как на узле Hyper-V будет доставлять наиболее стабильной источника времени.  Запись реестра необходимо перезапустить службы w32time после его изменения.

    [HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\W32Time\TimeProviders\VMICTimeProvider]
    "Enabled"=dword:00000000

**Загружает конфиденциальных точность** — для времени точность чувствительных рабочих нагрузок, можно настроить группы компьютеров, чтобы задать NTP-серверы, и любые параметры, связанные с времени, таких как частота обновлений опроса и часов.  Обычно это делается в домене, но для большего контроля можно ориентироваться на определенных компьютерах, который будет указывать на синхронизирующий.

Параметр групповой политики|   Новое значение|
----- | ----- |
NTP-сервер|  ClockMasterName 0x8|
MinPollInterval|    6 – 64 секунд|
MaxPollInterval|    6|
UpdateInterval| 100 – один раз в секунду|
EventLogFlags|  3 — все специальные время ведения журнала|

> [!NOTE]
> Параметры NTP-сервер и EventLogFlags расположены поставщиков Service\Time System\Windows времени, с помощью параметров настройки клиента Windows NTP.  Три другие находятся в System\Windows службой времени, используя глобальные параметры конфигурации.

**Удаленный точность конфиденциальных загружает удаленного** — для систем в доменах ветви для экземпляра розничной торговли и индустрии платежных кредит (PCI), Windows использует данные текущего сайта и источник времени локатора Контроллеров домена для поиска локального контроллера домена, при отсутствии вручную NTP настроить.  Эта среда требует 1 секунды, точности, который использует быстрее конвергенции правильное время.  Этот параметр позволяет службе w32time часы перемещения в обратном направлении.  Если это допустимо и соответствует вашим требованиям, можно создать следующую политику.   Как и в любой среде, гарантирует для тестирования и базовой сети. 

Параметр групповой политики|   Новое значение|
----- | ----- |
MaxAllowedPhaseOffset|  1, если более чем на секунду, значение часов правильное время.|

Параметр MaxAllowedPhaseOffset находится в разделе System\Windows службой времени, используя глобальные параметры конфигурации.

> [!NOTE]
> Дополнительные сведения о групповой политике и соответствующие записи, см. в разделе [средства службы времени Windows](windows-time-service-tools-and-settings.md) и параметры статьи на сайте TechNet.

## <a name="azure-and-windows-iaas-considerations"></a>Рекомендации по Azure и Windows IaaS

### <a name="azure-virtual-machine-active-directory-domain-services"></a>Виртуальная машина Azure: Доменные службы Active Directory
Если на виртуальной Машине Azure под управлением доменных служб Active Directory является частью существующей локальной леса Active Directory, затем TimeSync(VMIC) должен быть отключен. Это позволяет обеспечить все контроллеры домена в лесу, физических и виртуальных, использовать иерархию синхронизации один раз. См. рекомендации Технический документ по практике [«под управлением доменных контроллеров в Hyper-V»](https://technet.microsoft.com/library/virtual_active_directory_domain_controller_virtualization_hyperv.aspx)

### <a name="azure-virtual-machine-domain-joined-machine"></a>Виртуальная машина Azure: компьютер, присоединенный к домену
При размещении компьютера, который входит в домен в существующий лес Active Directory, виртуальной или физической, рекомендуется отключить TimeSync для гостевой ОС и убедитесь, что для синхронизации с контроллером домена с помощью настройке времени для W32Time Тип = NTP5

### <a name="azure-virtual-machine-standalone-workgroup-machine"></a>Виртуальная машина Azure: Отдельного компьютера рабочей группы
Если на виртуальной Машине Azure не присоединен к домену, и не является его контроллером домена, рекомендуется оставить конфигурацию по умолчанию время и синхронизировать с узлом виртуальной машиной.

## <a name="windows-application-requiring-accurate-time"></a>Windows требуется точное время приложения
### <a name="time-stamp-api"></a>Метка времени API
Программы, которые требуют наибольшую точности времени UTC, а не ход времени, должны использовать [GetSystemTimePreciseAsFileTime API](https://msdn.microsoft.com/library/windows/desktop/Hh706895.aspx).  Это гарантирует, что приложение получает системное время, что обусловлено служба времени Windows.

### <a name="udp-performance"></a>Производительность UDP
Если у вас есть приложение использует UDP-соединения для важно свести к минимуму задержки, а транзакции, некоторые связанные записи реестра, можно использовать для настройки диапазона портов должны быть исключены из порта базовой фильтрации.  Это улучшит задержки и увеличить пропускную способность.  Тем не менее изменения в реестр, должны быть ограничены опытными администраторами.  Кроме того эта работа вокруг исключает, защищенным брандмауэром порты.  Приведены в статье ниже дополнительные сведения.

Для Windows Server 2012 и Windows Server 2008 необходимо сначала установить исправление.  Вы можете обратиться к статье базы Знаний. [Число утерянных датаграмм при запуске приложение-получатель многоадресной рассылки в Windows 8 и Windows Server 2012](https://support.microsoft.com/kb/2808584)

### <a name="update-network-drivers"></a>Обновления драйверов сети
Некоторые поставщики сети имеют обновления драйверов, которые повышения производительности в отношении задержки драйвера и буферизации пакеты UDP.  Обратитесь к поставщику сети для просмотра при наличии обновления, которые помогут с пропускной способностью UDP.

## <a name="logging-for-auditing-purposes"></a>Ведение журнала для целей аудита
Для соблюдения норм трассировки времени вы можете вручную архивировать w32tm журналы, журналы событий и данные системного монитора.  Позже архивные сведения можно использовать для подтверждения соответствия требованиям на момент времени в прошлом.  Следующие факторы используются для указания точности.


1. Часы точности с помощью счетчиков системного монитора вычисляется смещение времени.  Это показывает, часы, с использованием в требуемой точности.
2.  Источник времени, вам нужен ответ однорангового «из» в журналах w32tm.   Следующий текст сообщения-это IP-адрес или VMIC, который описывает источник и далее в цепочке ссылок часов для проверки.
3.  Clock с помощью журналов w32tm, чтобы проверить, что состояние условие «Дисциплина ClockDispl: \*Наклон\*время\*«выполняется.  Это означает, что во время этого w32tm активен.

### <a name="event-logging"></a>Ведение журнала событий
Чтобы получить описание функциональности, необходимо также сведения о журнале событий.  Сбор системных событий и фильтрации на сервер времени, Microsoft-Windows-Kernel-загрузки, Microsoft-Windows-Kernel-General, можно обнаружить, если существуют другие влияет на то, которые были изменены время, к примеру, третьим лицам.  Эти журналы, может потребоваться исключить внешние помех.  Групповая политика может повлиять на какие журналы событий записываются в журнал.  Дополнительные сведения см в разделе выше на с помощью групповой политики.

### <a name="W32Logging"></a>Ведение журнала отладки W32Time
Чтобы включить w32tm для целей аудита, следующая команда включает ведение журнала, показывающий периодические обновления часов и указывает часы источника.  Перезапустите службу, чтобы включить ведение журнала для новых.  

Дополнительные сведения см. в разделе [способы включения ведения журнала в службу времени Windows для отладки](https://support.microsoft.com/kb/816043).

    w32tm /debug /enable /file:C:\Windows\Temp\w32time-test.log /size:10000000 /entries:0-73,103,107,110

### <a name="performance-monitor"></a>Системный монитор
Службы времени Windows Server 2016 предоставляет счетчики производительности, которые могут использоваться для сбора ведения журнала аудита.  Они могут регистрироваться локально или удаленно.  Можно записать смещение времени компьютера и счетчики задержка кругового пути.  
И, как любой счетчик производительности удаленного мониторинга и создания оповещений с помощью System Center Operations Manager.  К примеру, можно использовать оповещение для alarm вы, если смещение времени отличается от требуемой точности.  [Пакет управления System Center](https://social.technet.microsoft.com/wiki/contents/articles/15251.system-center-management-pack-authoring-guide.aspx) подробнее.

### <a name="windows-traceability-example"></a>Пример отслеживания Windows
Из файлов журналов w32tm требуется проверить два фрагмента информации.  Первый — Указание, что файл журнала в настоящее время является условие часов.  Это подтверждает, что часы на компьютере был условие, заданное служба времени Windows во время спорных.

    151802 20:18:32.9821765s - ClockDispln Discipline: *SKEW*TIME* - PhCRR:223 CR:156250 UI:100 phcT:65 KPhO:14307
    151802 20:18:33.9898460s - ClockDispln Discipline: *SKEW*TIME* - PhCRR:1 CR:156250 UI:100 phcT:64 KPhO:41
    151802 20:18:44.1090410s - ClockDispln Discipline: *SKEW*TIME* - PhCRR:1 CR:156250 UI:100 phcT:65 KPhO:38

Самое главное, что вы видите сообщения с ClockDispln Дисциплина, который является проверки w32time префиксом взаимодействует с системных часов.
 
Далее вам необходимо найти последний отчет в журнале до спорных времени, которая сообщает исходного компьютера, на который в данный момент используется как синхронизирующих импульсов.  Это может быть IP-адрес, имя компьютера или к поставщику VMIC, который указывает, что она синхронизируется с узлом Hyper-v.  Следующий пример предоставляет адрес IPv4 10.197.216.105.

    151802 20:18:54.6531515s - Response from peer 10.197.216.105,0x8 (ntp.m|0x8|0.0.0.0:123->10.197.216.105:123), ofs: +00.0012218s

Теперь, когда вы проверили первая система в цепочку ссылок на время, необходимо изучить файл журнала на ссылки на источник времени и повторите те же действия.  Это продолжается, пока не дойдете до физические часы, таких как GPS или известного источника времени как NIST.  Если синхронизирующих импульсов оборудования GPS, затем журналы из изготовлены могут требовать.

## <a name="network-considerations"></a>Рекомендации по сети
Алгоритмы протокола NTP зависят от симметрии вашей сети.  Как увеличить количество переходов увеличивает вероятность асимметрию.  Существует, трудно предсказать, какие виды проверки точности, вы увидите в соответствии с конкретной средой. 

Монитор производительности и новые счетчики времени Windows в Windows Server 2016 можно использовать для оценки точности вашей среды и базовые планы. Кроме того можно выполнять устранение неполадок, чтобы определить текущее смещение любому компьютеру в сети.

Существует две общие стандарты для точном времени по сети.  PTP ([протокола NTP точности - IEEE 1588](https://www.nist.gov/el/intelligent-systems-division-73500/introduction-ieee-1588)) имеет более жесткими требованиями на сетевую инфраструктуру, но обеспечивают точность вложенных микросекунд.  NTP ([протокола NTP – RFC 1305](https://tools.ietf.org/html/rfc1305)) работает на более широкий сетях и средах, что упрощает управление. 

Windows поддерживает простой NTP (RFC2030) по умолчанию для машин присоединены к домену.  Для компьютеров, присоединенных к домену, мы используем безопасного NTP с именем [MS-SNTP](https://msdn.microsoft.com/library/cc246877.aspx), который использует секреты домена согласование, предоставляющих это быстрее управления NTP прошел проверку подлинности, описанных в RFC1305 и RFC5905.   

Имя домена и протоколы присоединены к домену требуется UDP-порт 123.  Дополнительные сведения о рекомендациях по работе с NTP см [сети время протокола рекомендации текущий рекомендации IETF черновик](https://tools.ietf.org/html/draft-ietf-ntp-bcp-00).

### <a name="reliable-hardware-clock-rtc"></a>Надежные системных часов (RTC)
Windows не не время шага, если определенные границы превышены, но вместо дисциплинах часы.  Это означает, что w32tm настраивает частоту часы с регулярным интервалом, с помощью тактовой частоты обновления, настройки, которые по умолчанию — раз в секунду, Windows Server 2016.  Если часы защищен, это расширение ускоряет работу частоту и если ожидается, он замедляет частоту.  Тем не менее в течение этого времени между корректировки частота часов системных часов — в элементе управления.  Если имеется проблема с помощью встроенного по или системных часов, время на компьютере может стать менее точным.

Это еще одна причина, необходимые для тестирования и базовых показателей в вашей среде.  Если счетчик производительности «Вычислить смещение времени» работа не стабилизируется в точности, который вы используете, может потребоваться убедиться, что встроенного по находится в актуальном состоянии.  Еще одной проверки можно увидеть, если повторяющиеся оборудования воспроизвести ту же проблему.

### <a name="troubleshooting-time-accuracy-and-ntp"></a>Устранение неполадок точность времени и NTP
Можно использовать Discovering разделе иерархии выше, чтобы определить источник неправильное время.  Взглянув на смещение времени, найти точку в иерархии, где время отличается максимум преимуществ от его источника NTP.  Когда вы понимаете, иерархии, необходимо ознакомиться, почему этот источник в определенный момент времени не получает точное время.  

Внимание пользователей в системе, где разные времени, можно использовать эти средства ниже собирать дополнительные сведения помогут определить проблему и найти решение.  UpstreamClockSource ссылку ниже, — часы, обнаруживаемое с помощью «w32tm/config/Status».


- Журналы событий системы
- Включить с помощью ведения журнала: журналы w32tm - w32tm/Debug/Enable /file:C:\Windows\Temp\w32time-test.log /size:10000000 /entries:0-300
- w32Time Registry key HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\W32Time
- Операции в локальной сети
- Счетчики производительности (из локальной системы или UpstreamClockSource)
- W32tm /stripchart /computer:UpstreamClockSource
- UpstreamClockSource PING, чтобы понять, задержки и количество прыжков к источнику
- Tracert UpstreamClockSource

Проблема|    Симптомы|   Разрешение|
----- | ----- | ----- |
Локальные часы TSC может быть нестабильным.| С помощью Perfmon - физического компьютера — синхронизации часов стабильной часов, но вы по-прежнему видеть, что несколько 100us каждые 1 – 2 минут. |   Обновления встроенного по или проверить другое оборудование не отображает ту же проблему.|
Задержки в сети|    W32tm stripchart отображает RoundTripDelay более чем 10 мс.  Вариант в шума причиной задержки, размером до ½ время кругового пути, например задержки, только в одном направлении.</br></br>UpstreamClockSource работает через несколько прыжков, путем проверки СВЯЗИ.  Значение срока ЖИЗНИ должно быть близким к 128.</br></br>Используйте команду Tracert для поиска задержку при каждом прыжке.    | Найти источник ближе часов для времени.  Одно из решений — установить часы источника в одном сегменте или вручную указывать на источник часов, ближе к ним.  Для сценария домена добавьте компьютер с ролью GTimeServ. |  
Не удалось надежно подключиться к источнику NTP|    W32tm /stripchart периодически возвращает «Истекло время ожидания запроса»    |NTP-источник не отвечает|
NTP-источник не отвечает|    Проверьте счетчики системного монитора для число исходного клиента NTP, входящие запросы сервера NTP NTP Server исходящих ответов и определить потребление по сравнению с базовые значения.|    Использование счетчиков производительности сервера, определите, изменилась ли нагрузки относительно базовые значения.</br></br>Существуют ли сетевой проблемы перегрузки?|
Контроллер домена, не используя наиболее точный формат|    Изменения в топологии или недавно добавленных master часы.|   w32tm/resync /rediscover|
Базовыми работать часам клиента| Служба времени событий 36 в журнал системных событий и/или текст в файле журнала, указывающая, что: Счетчик «количество источник времени NTP клиента», переходе с 1 на 0|Устранение неполадок вышестоящего источника и понять, работает ли он проблемы с производительностью.|

### <a name="baselining-time"></a>Время задания базовых показателей
Задание базовых показателей важно, чтобы вы могли во-первых, оценивать производительность и точность сети и при возникновении проблем в будущем сравнение с базовыми показателями.  Вы захотите базовых показателей корневого основного контроллера домена или компьютеры, помеченные GTIMESRV.  Также рекомендуется вы базовых показателей основного контроллера домена в каждом лесу.  Наконец, выберите любой важных контроллеров домена или машин, имеющих интересными характеристиками, например расстояния или высокой нагрузкой и базовых показателей этих.

Это также полезно для базовых показателей Windows Server 2016 и 2012 R2, однако имеется w32tm /stripchart только как средство, которые можно использовать для сравнения, так как Windows Server 2012 R2 не содержит счетчики производительности.  Следует выбрать две машины с теми же характеристиками, или обновить компьютер, а также сравнить результаты после обновления.  Дополнение замеры времени Windows имеет дополнительные сведения о том, как сделать подробные измерениях между 2016 и 2012.

С помощью всех w32time счетчиков производительности, сбор данных по крайней мере в течение недели.  Это будет гарантировать, что у вас есть достаточно ссылки, чтобы учесть различные в сети со временем и достаточно обеспечить уверенность в том, что точность времени стабильна операции выполнения.

### <a name="ntp-server-redundancy"></a>Избыточность сервера NTP
Ручной настройки NTP-сервер, используемый с машин присоединены к домену или основной контроллер домена наличие более одного сервера — это мера хорошая избыточность, в случае доступности.  Он может также привести к большую точность, при условии, что все источники, точность и стабильность.  Тем не менее, топологии также не предусмотрена, или источники времени не являются стабильными, полученный точность может быть хуже, поэтому следует соблюдать осторожность.  Поддерживаемые серверы w32time вручную может ссылаться на время равно 10. 

## <a name="leap-seconds"></a>Корректировочных секунд
Срок действия Земли меняется с течением времени, из-за события climatic и геологическое. Как правило объект variation используется около секунды каждые несколько лет. Каждый раз, когда отступления от atomic времени становится слишком большим, исправление одну секунду (вверх или вниз) вставлены, вызывается секунда. Это делается так, что разница никогда не превышает 0.9 секунд. Это исправление будет объявлено о шесть месяцев до фактического исправления. До Windows Server 2016 службы времени Microsoft неожиданного корректировочных секунд, но полагаться на службу внешних времени, чтобы устранить эту. С точностью увеличения времени, Windows Server 2016 Корпорация Майкрософт работает над более подходящее решение для проблемы секунда.

## <a name="secure-time-seeding"></a>Защита время заполнения
Служба W32Time в Server 2016 включена функция защиты присвоение начальных значений времени. Эта функция определяет приблизительное текущее время из исходящих подключений SSL.  Это значение времени позволяет отслеживать локальные системные часы и исправьте все ошибки валовой. Дополнительные сведения о функции в [этой записи блога](https://blogs.msdn.microsoft.com/w32time/2016/09/28/secure-time-seeding-improving-time-keeping-in-windows/).  В развертываниях с источников времени надежные и хорошо отслеживаемых компьютеров, включая операции наблюдения для смещения времени вы можете не использовать функцию защиты присвоение начальных значений времени и вместо этого полагаются на существующей инфраструктуры. 

Вы функцию можно отключить, выполнив следующие действия:

1.  Присвойте значение конфигурации реестра UtilizeSSLTimeData 0 на определенном компьютере:

    reg add HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\w32time\Config /v UtilizeSslTimeData /t REG_DWORD /d 0 /f


2.  Если вы не сможете перезагрузить компьютер немедленно из-за какой-либо причине, можно уведомить служба W32time об обновлении конфигурации. Это останавливает мониторинг времени и принудительного применения на основе времени данных, собранных из SSL-подключения. 

    W32tm.exe /config /update

3.  Перезагрузить компьютер немедленно делает эффективный параметр и вызывает его, чтобы остановить сбор данных времени с SSL-подключения.  Последняя часть имеет очень небольшой объем затрат и не должен представлять собой проблему производительности.

4.  Чтобы применить этот параметр во всем домене, задайте значение UtilizeSSLTimeData в параметр групповой политики W32time 0 и параметр публикации.  При параметре забирается клиента групповой политики, служба W32time уведомляется, и он перестанет времени отслеживать и использовании данных времени SSL принудительного применения. Сбор данных времени SSL будет останавливаться при перезагрузке каждой машины. Если ваш домен имеет переносимой тонкий ноутбуков и планшетных ПК и других устройств, может потребоваться исключить таких машин из изменении этой политики. Со временем столкнутся с этих устройств разряду батареи и необходимости заполнения Secure время возможностей для начальной загрузки своего времени.


