---
title: Улучшения точности времени в Windows Server 2016
description: В Windows Server 2016 улучшены алгоритмы, используемые для корректировки времени и условий для синхронизации локального времени с временем в формате UTC.
author: dahavey
ms.author: dahavey
ms.date: 10/17/2018
ms.topic: article
ms.openlocfilehash: f7593b085dd07694bf7d51d2712501bea612e9af
ms.sourcegitcommit: b5b040a47cf48c94852de9aad8b91475f891d2f7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/18/2020
ms.locfileid: "88563404"
---
# <a name="time-accuracy-improvements-for-windows-server-2016"></a>Улучшения точности времени в Windows Server 2016

В Windows Server 2016 улучшены алгоритмы, используемые для корректировки времени и условий для синхронизации локального времени с временем в формате UTC. В NTP для расчета смещения времени, основанного на временных метках запроса/ответа клиента и запроса/ответа сервера, используются 4 значения. Однако сети имеют помехи, и в данных от NTP могут наблюдаться пиковые нагрузки из-за перегрузки сети и других факторов, влияющих на задержку сети. Алгоритмы Windows 2016 уравновешивают этот шум с помощью ряда различных методов, в результате которых время является стабильным и точным. Кроме того, источник, используемый для точного времени, ссылается на улучшенный API, который обеспечивает лучшее разрешение. С помощью этих улучшений мы сможем достичь точности 1 мс с учетом времени в формате UTC для всего домена.

## <a name="hyper-v"></a>Hyper-V

В Windows 2016 улучшено службу Hyper-V TimeSync. К улучшениям относятся более точное начальное время при запуске или восстановлении ВМ и коррекция задержки прерывания для образцов, предоставленных в w32time. Это улучшение позволяет нам не выходить за пределы 10 мкс на узле с RMS (среднее квадратичное значение, которое указывает на отклонение) с 50 мкс, даже на машине с 75 % загрузкой. Для получения дополнительных сведений см. раздел [Архитектура Hyper-V](https://msdn.microsoft.com/library/cc768520.aspx).

> [!NOTE]
> Загрузку создано с помощью теста производительности prime95 с использованием сбалансированного профиля.

Кроме того, уровень страты, который узел предоставляет гостевой системе, является более прозрачным. Ранее узел предоставлял фиксированную страту 2, независимо от его точности. По мере изменений в Windows Server 2016 узел сообщает о страте, большей за страту узла, что приводит к улучшению времени для виртуальных гостевых систем. Страта узла определяется w32time через стандартные средства, основываясь на исходном времени. Присоединенные к домену гостевые системы Windows 2016 будут находить наиболее точные часы, а не стандартные часы узла. По этой причине мы рекомендуем вручную отключить параметр поставщика времени Hyper-V для компьютеров, находящихся в домене в Windows 2012 R2 и более ранних версий.

## <a name="monitoring"></a>Мониторинг

Добавлены счетчики монитора производительности С их помощью вы можете установить базовые показатели, отслеживать и устранять неполадки с точностью времени. Эти счетчики включают:

|Счетчик|Описание|
|----- | ----- |
|Смещение вычисляемого времени| Абсолютное смещение времени между системным временем и выбранным источником времени, вычисленное службой W32Time в микросекундах. При наличии нового допустимого примера вычисленное время обновляется с использованием смещения времени, указанного в примере. Это фактическое смещение времени локальных часов. Служба W32Time инициирует исправление часов с помощью этого смещения и обновляет вычисленное время между выборками с оставшимся смещением времени, которое необходимо применить к локальным часам. С помощью этого счетчика производительности с низким интервалом опроса (например, 256 секунд или меньше) можно отследить точность часов и найти значение счетчика, которое является меньше требуемого предельного значения.|
|Настройка тактовой частоты| Настройка абсолютной тактовой частоты, выполненная в локальных системных часах W32Time в частях на миллиард. Этот счетчик помогает визуализировать действия, выполняемые службой W32Time.|
|Задержка кругового пути NTP| Последняя задержка кругового пути, которая возникла в NTP-клиенте при получении ответа от сервера в микросекундах. Это время, затраченное на NTP-клиенте с момента передачи запроса серверу NTP и до получения допустимого ответа от сервера. Этот счетчик помогает определять задержки, испытываемые NTP-клиентом. Увеличение или изменение кругового пути может привести к появлению помех в вычислениях времени NTP, что, в свою очередь, может повлиять на точность синхронизации времени через NTP.|
|Число источников NTP-клиента| Активное число источников времени NTP, используемых NTP-клиентом. Это число активных, уникальных IP-адресов серверов времени, которые отвечают на запросы этого клиента. Это число может быть больше или меньше числа настроенных одноранговых узлов и зависит от разрешения DNS для имен одноранговых узлов и текущих возможностей охвата.|
|Входящие запросы NTP-сервера| Число запросов, полученных NTP-сервером (запросов/сек).|
|Исходящие ответы NTP-сервера| Число запросов, на которые ответил NTP-сервер (ответов/сек).|

Первые 3 счетчика предназначены для устранения неполадок с точностью. Ниже, в секции "Устранения неполадок с точностью времени и NTP", разделе "Рекомендации", приведены более подробные сведения.
Последние 3 счетчика охватывают сценарии NTP-сервера и полезны при определении нагрузки и задания базовых показателей текущей производительности.

## <a name="configuration-updates-per-environment"></a>Обновления конфигурации для каждой среды

Ниже описаны изменения конфигурации по умолчанию между Windows 2016 и предыдущими версиями для каждой роли. Параметры для Windows Server 2016 и юбилейного обновления Windows 10 (сборка 14393) теперь являются уникальными, поэтому они отображаются как отдельные столбцы.

|Роль|Параметр|Windows Server 2016|Windows 10|Windows Server 2012 R2<br>Windows Server 2008 R2<br>Windows 10|
|---|---|---|---|---|
|**Автономный сервер или Nano Server**||||
| |Сервер времени|time.windows.com|Н/Д|time.windows.com|
| |Частота опроса|64–1024 секунд|Н/Д|Один раз в неделю|
| |Периодичность обновления часов|Один раз в секунду|Н/Д|Один раз в час|
|**Автономный клиент**||||
| |Сервер времени|Н/Д|time.windows.com|time.windows.com|
| |Частота опроса|Н/Д|Один раз в день|Один раз в неделю|
| |Периодичность обновления часов|Н/Д|Один раз в день|Один раз в неделю|
|**Контроллер домена**||||
| |Сервер времени|PDC/GTIMESERV|Н/Д|PDC/GTIMESERV|
| |Частота опроса|64 — 1024 секунд|Н/Д|1024 — 32768 секунд|
| |Периодичность обновления часов|Один раз в день|Н/Д|Один раз в неделю|
|**Рядовой сервер домена**||||
| |Сервер времени|DC|Н/Д|DC|
| |Частота опроса|64 — 1024 секунд|Н/Д|1024 — 32768 секунд|
| |Периодичность обновления часов|Один раз в секунду|Н/Д|Запускается каждые 5 мин.|
|**Клиент членов домена**||||
| |Сервер времени|Н/Д|DC|DC|
| |Частота опроса|Н/Д|1204 — 32768 секунд|1024 — 32768 секунд|
| |Периодичность обновления часов|Н/Д|Запускается каждые 5 мин.|Запускается каждые 5 мин.|
|**Гостевой сервер Hyper-V**||||
| |Сервер времени|Выбор наилучшего параметра на основе страты сервера узла и времени|Выбор наилучшего параметра на основе страты сервера узла и времени|По умолчанию используется узел|
| |Частота опроса|На основе указанной выше роли|На основе указанной выше роли|На основе указанной выше роли|
| |Периодичность обновления часов|На основе указанной выше роли|На основе указанной выше роли|На основе указанной выше роли|

>[!NOTE]
>Для Linux в Hyper-V см. раздел "Разрешение использования Linux с временем узла Hyper-V" ниже.

## <a name="impact-of-increased-polling-and-clock-update-frequency"></a>Влияние увеличенной частоты опроса и обновления часов

Чтобы обеспечить более точное время, значения по умолчанию для частоты опроса и обновления часов увеличиваются, что позволяет нам чаще вносить небольшие изменения. Это приведет к увеличению трафика UDP/NTP, однако поскольку эти пакеты небольшие, они не будут оказывать влияния на широкополосные связи. В тоже время преимущество заключается в лучшей оптимизации времени на более широком спектре оборудования и сред.

Увеличение частоты опроса для устройств с батарейным питанием может вызвать проблемы. Устройства с батарейным питанием не сохраняют время, при выключении. После возобновления их работы может потребоваться частое исправление времени. Увеличение частоты опроса приведет к тому, что часы будут нестабильными и могут начать использовать больше энергии. Корпорация Майкрософт рекомендует не изменять параметры клиента по умолчанию.

На контроллеры домена следует оказывать минимальное влияние даже при многократном увеличении количества обновлений от NTP-клиентов в домене AD. По сравнению с другими протоколами NTP имеет гораздо меньшее потребление ресурсов и незначительное воздействие. Вы с большей вероятностью достигнете ограничений для других функциональных возможностей домена, нежели будете затронуты улучшенными настройками Windows Server 2016. Active Directory действительно использует защищенный NTP, который имеет обыкновение синхронизировать время менее точно, чем простой NTP, но мы проверили, что он будет масштабироваться до клиентов в двух стратах от PDC.

Для консервативного плана необходимо резервировать 100 NTP-запросов в секунду на ядро. Например, домен, состоящий из 4 контроллеров домена с 4 ядрами каждый, должен обслуживать 1600 NTP-запросов в секунду. Если бы у вас было 10 000 клиентов, настроенных на синхронизацию времени раз в 64 секунды, и запросы принимались бы равномерно с течением времени, вы бы увидели 10 000/64 или около 160 запросов в секунду, распределенных по всем контроллерам домена. Это легко укладывается в наши 1600 NTP-запросов/сек на основе этого примера. Это консервативные рекомендации по планированию и, они конечно, сильно зависят от вашей сети, скоростей процессора и нагрузок, так как всегда являются базовыми и тестовыми в ваших средах.

Также важно отметить, что если контроллеры домена работают с значительной загрузкой ЦП, более 40 %, это почти наверняка добавит шум в NTP-ответы и повлияет на точность времени в домене. Опять же, чтобы понять фактические результаты, необходимо протестировать их в своей среде.

## <a name="time-accuracy-measurements"></a>Измерения точности времени

### <a name="methodology"></a>Методика

Чтобы измерить точность времени для Windows Server 2016, мы использовали разнообразные средства, методы и среды. Эти методы можно использовать для измерения и настройки среды и определения соответствия результатов точности требованиям.

Время работы часов-источника домена состояло из двух NTP-серверов высокой точности с оборудованием GPS. Мы также использовали отдельный эталонный тестовый компьютер для измерений, в котором также установлено высокоточное GPS-оборудование от другого производителя. Для некоторых целей тестирования потребуется точный и надежный источник времени, который будет использоваться в качестве ссылки в дополнение к источнику времени домена.

Мы использовали четыре разных метода для измерения точности как физических, так и виртуальных машин. Многочисленные методы предоставляют независимые средства проверки результатов.

1. Измерение локальных часов, настроенных с помощью w32tm, на контрольной машине, которая имеет отдельное оборудование GPS.

2. Измерение проверок связи NTP между NTP-сервером и клиентом с помощью команды w32tm "stripchart"

3. Измерение проверок связи NTP между клиентом и NTP-сервером с помощью команды w32tm "stripchart"

4. Измерение результатов Hyper-V с узла на гостевой сервер с помощью счетчика отметки времени (TSC). Этот счетчик совместно используется обоими разделами и системным временем в обоих разделах. Мы рассчитали разницу между временем узла и временем клиента на виртуальной машине. Затем мы используем часы TSC для интерполяции времени основного элемента от гостевой системы, так как измерения не происходят одновременно. Кроме того, мы используем задержки и время ожидания коэффициента TSV в API.

Команда W32tm является встроенной, но другие инструменты, которые мы использовали во время тестирования, доступны для репозитория Microsoft на GitHub в качестве открытого исходного кода для тестирования и использования. Дополнительные сведения о том, как использовать инструменты для проведения измерений, см. в статье [Средства для калибровки времени в Windows](https://github.com/Microsoft/Windows-Time-Calibration-Tools)

Показанные ниже результаты теста представляют собой подмножество измерений, сделанных в одной из тестовых сред. Они иллюстрируют точность, сохраняемую в начале временной иерархии, и клиента дочернего домена в конце временной иерархии. Эти сведения сопоставляются с теми же машинами в топологии 2012 года для сравнения.

### <a name="topology"></a>Топология

Для сравнения мы тестировали топологию на основе Windows Server 2012 R2 и Windows Server 2016. Обе топологии состоят из двух физических хост-компьютеров Hyper-V, которые ссылаются на компьютер Windows Server 2016 с установленным оборудованием времени GPS. Каждый узел запускает 3 присоединяемых к домену гостевых ОС Windows, упорядоченные в соответствии со следующей топологией. Строки представляют собой иерархию времени и используемый протокол или транспорт.

![Схема топологии службы времени Windows](../media/Windows-Time-Service/Windows-2016-Accurate-Time/topology1.png)

![Схема топологии службы времени Windows](../media/Windows-Time-Service/Windows-2016-Accurate-Time/topology2.png)

### <a name="graphical-results-overview"></a>Обзор графических результатов

Следующие два графика представляют точность времени для двух конкретных членов домена на основе топологии выше. Каждый график отображает результаты работы Windows Server 2012R2 и 2016, которые накладываются друг на друга, что наглядно демонстрирует улучшения. Точность измерено на основе сравнения гостевого компьютера с узлом. Графические данные представляют собой подмножество всех выполненных тестов и показывает наилучшие и наихудшие случаи.

![Схема топологии службы времени Windows](../media/Windows-Time-Service/Windows-2016-Accurate-Time/topology3.png)

### <a name="performance-of-the-root-domain-pdc"></a>Производительность PDC корневого домена

Корневой PDC синхронизируется с узлом Hyper-V (с использованием VMIC), который представляет собой Windows Server 2016 с оборудованием GPS, признанным как точное и стабильное. Это критически важное требование для точности в 1 мс, которое отображается в виде зеленой затененной области.

![Служба времени Windows](../media/Windows-Time-Service/Windows-2016-Accurate-Time/chart1.png)

### <a name="performance-of-the-child-domain-client"></a>Производительность клиента дочернего домена

Клиент дочернего домена подключен к PDC дочернего домена, который подключается к корневому PDC. Время его выполнения также должно быть задано в 1 мс.

![Служба времени Windows](../media/Windows-Time-Service/Windows-2016-Accurate-Time/chart2.png)

### <a name="long-distance-test"></a>Проверка на дальних расстояниях

Следующая таблица сравнивает 1 прыжок в виртуальной сети с 6 физическими прыжками в сеть с Windows Server 2016. Два графика накладываются друг на друга, используя прозрачную текстуру для отображения перекрывающихся данных. Увеличение прыжков в сети означает более высокую задержку и большее отклонения во времени. Диаграмма увеличена, поэтому границы 1 мс, представленные зеленой областью, больше. Как видите, время по-прежнему находится в пределах 1 мс с несколькими прыжками. Это отрицательное смещение, которое демонстрирует асимметрию сети. Разумеется, каждая сеть отличается, и измерения зависят от множества факторов среды.

![Служба времени Windows](../media/Windows-Time-Service/Windows-2016-Accurate-Time/chart3.png)

## <a name="best-practices-for-accurate-timekeeping"></a>Рекомендации для точного учета хронометража

### <a name="solid-source-clock"></a>Часы с твердотельным источником

Время машины будет настолько хорошим, как и исходные часы, с которыми он синхронизируется. Чтобы достичь точности в 1 мс, вам потребуется оборудование GPS или устройство времени в сети, на которое вы ссылаетесь в качестве часов главного источника. Использование значения по умолчанию time.windows.com может не предоставить стабильный источник локального времени. Кроме того, как только вы начнете удалятся от источника, сеть повлияет на точность. Для наилучшей точности необходимо наличие часов главного источника в каждом центре обработки данных.

### <a name="hardware-gps-options"></a>Параметры оборудования GPS

Существуют различные аппаратные решения, которые могут предложить точное время. Как правило, современные решения основаны на антеннах GPS. Существуют также решения для радио- и коммутируемых модемов, использующие выделенные линии. Они присоединяются к сети как устройство или подключаются к компьютеру, например, к Windows через устройство PCIe или USB. Различные параметры обеспечивают разные уровни точности, и, как и всегда, результаты зависят от конкретной среды. Переменные, влияющие на точность, включают в себя доступность GPS, стабильность и загрузку сети, а также аппаратное обеспечение ПК. Это факторы важны при выборе исходных часов, которые, как мы упоминали, являются обязательным требованием для стабильного и точного времени.

### <a name="domain-and-synchronizing-time"></a>Домен и время синхронизации

Члены домена используют доменную иерархию для определения компьютера-источника для синхронизации времени. Каждый член домена найдет другой компьютер для синхронизации и сохранит его в качестве источника времени. Каждый тип членов домена следует разным наборам правил, чтобы найти источник синхронизации времени. PDC в корне леса является стандартным источником времени для всех доменов. Ниже перечислены различные роли и общее описание того, как они находят источник.

- **Контроллер домена с ролью PDC** — этот компьютер является полномочным источником времени для домена. Он будет иметь наиболее точное время в домене и должен синхронизироваться с контроллером домена в родительском домене, за исключением случаев, когда включена роль GTIMESERV.
- **Любой другой контроллер домена** — этот компьютер будет работать в качестве источника времени для клиентов и рядовых серверов в домене. Контроллер домена может синхронизироваться с PDC своего собственного домена или с любым контроллером домена своего родительского домена.
- **Клиентские и рядовые серверы** — этот компьютер может синхронизироваться с любым контроллером домена или PDC в своем домене, или контролером домена или PDC в родительском домене.

Система оценки используется для поиска лучшего источника времени на основе доступных кандидатов. Эта система учитывает надежность источника времени и его относительное расположение. Это происходит один раз при запуске службы. Если требуется более точное управление синхронизацией времени, можно добавить хорошие серверы времени в определенные расположения или добавить избыточность. Дополнительные сведения см. в разделе "Указание надежной локальной службы времени с помощью GTIMESERV".

#### <a name="mixed-os-environments-win2012r2-and-win2008r2"></a>Смешанные среды ОС (Win2012R2 и Win2008R2)

Хотя для наилучшей точности требуется чистая среда домена Windows Server 2016, использование смешанной среды все еще приносит преимущества. Развертывание Hyper-V Windows Server 2016 в домене Windows 2012 позволит получить доступ к гостям из-за описанных выше улучшений, но только в том случае, если гости также относятся к Windows Server 2016. Основной контроллер домена Windows Server 2016 будет более стабильным источником, поскольку может предоставить более точное время из-за улучшенных алгоритмов. Замена основного контроллера домена может быть невозможной. Вместо этого вы можете добавить контроллер домена Windows Server 2016 с набором данных GTIMESERV, который будет обновляться точно так же, как для вашего домена. Контроллеры домена Windows Server 2016 могут обеспечить лучшее время для клиентов в нисходящем времени, однако его качество будет зависеть от его исходного NTP.

Как указано выше, частоту опроса и обновления часов изменено с помощью Windows Server 2016. Их можно изменить вручную на контроллерах домена нижнего уровня или применить с помощью групповой политики. Хотя мы не тестировали эти конфигурации, их поведение в Win2008R2 и Win2012R2 должно быть хорошим и приносить некоторые преимущества.

Версии до Windows Server 2016 имели множество проблем с сохранением точного времени, что приводило к смещению системного времени сразу после внесения изменений. Благодаря этому, частое получение временных примеров из точного источника NTP и выравнивание локальных часов с данными приводит к меньшему смещению в их системных часах в период внутренней выборки, что позволяет лучше удерживать время на нисходящих версиях операционных систем. Наилучшей наблюдаемой точностью стало примерно 5 мс, когда клиент NTP Windows Server 2012R2, настроенный через параметры высокой точности, синхронизировал свое время с точным NTP сервером Windows 2016.

В некоторых сценариях, использующих гостевые контроллеры домена, примеры TimeSync Hyper-V могут нарушить синхронизацию времени домена. Это не должно быть проблемой для гостевых серверов 2016, работающих на узлах-V сервера Hyper 2016.

Чтобы отключить предоставление примеров в w32time для службы Hyper-V TimeSync, установите следующий ключ гостевого реестра: `HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\W32Time\TimeProviders\VMICTimeProvider
 "Enabled"=dword:00000000`.

#### <a name="allowing-linux-to-use-hyper-v-host-time"></a>Разрешение использования Linux с временем узла Hyper-V

Для гостевых ОС Linux в Hyper-V клиенты обычно настроены на использование управляющей программы NTP для синхронизации времени с NTP-серверами. Если дистрибутив Linux поддерживает протокол TimeSync версии 4, а на гостевой виртуальной машине Linux включена служба интеграции TimeSync, то она будет синхронизироваться с временем узла. Это может привести к несоответствию по времени, если оба метода включены.

Для синхронизации только с временем размещения рекомендуется отключить синхронизацию времени NTP одним из следующих способов:

- Отключение всех NTP-серверов в файле ntp.conf

- или отключение управляющей программы NTP

В этой конфигурации параметр сервера времени является этим узлом. Частота опроса составляет 5 секунд, также, как и частота обновления часов.

Для синхронизации только по протоколу NTP рекомендуется отключить службу интеграции TimeSync в гостевой системе.

> [!NOTE]
> Примечание. Для обеспечения точного времени с гостевыми ОС Linux требуется функция, которая поддерживается только в последних версиях вышестоящих ядер Linux, и она пока недоступна для всех дистрибутивов Linux. Дополнительные сведения о дистрибутивах поддержки см. в разделе [Supported Linux and FreeBSD virtual machines for Hyper-V on Windows](../../virtualization/hyper-v/supported-linux-and-freebsd-virtual-machines-for-hyper-v-on-windows.md) (Поддерживаемые виртуальные машины Linux и FreeBSD для Hyper-V в Windows).

#### <a name="specify-a-local-reliable-time-service-using-gtimeserv"></a>Указание надежной локальной службы времени с помощью GTIMESERV

Вы можете указать один или несколько контроллеров домена в качестве точных исходных часов с помощью GTIMESERV, сервера точного времени, флагов. Например, определенные контроллеры домена, оснащенные оборудованием GPS, можно пометить как GTIMESERV. Это гарантирует, что домен будет ссылаться на часы на основе оборудования GPS.

> [!NOTE]
> Дополнительные сведения о флагах домена можно найти в документации по протоколу [[MS-ADTS]: Active Directory Technical Specification](/openspecs/windows_protocols/ms-winerrata/fe563333-6e4f-4198-9bf5-741a523cd0d7) ([MS-ADTS]: технические характеристики по Active Directory).

TIMESERV — это еще один связанный флаг доменных служб, который указывает, является ли машина в настоящее время полномочной, и возможны ли изменения в случае потери связи с контроллером домена. Контроллер домена в этом состоянии будет возвращать значение "Unknown Stratum" (Неизвестная страта) при запросе через NTP. После нескольких попыток контроллер домена запишет в журнал системное событие службы времени 36.

Если вы хотите настроить контроллер домена как GTIMESERV, его можно настроить вручную с помощью следующей команды. В этом случае контроллер домена использует другие компьютеры в качестве главных часов. Это может быть устройство или выделенный компьютер.

```
w32tm /config /manualpeerlist:"master_clock1,0x8 master_clock2,0x8" /syncfromflags:manual /reliable:yes /update
```

> [!NOTE]
> Дополнительные сведения см. в разделе [Configure the Windows Time Service](/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/cc731191(v=ws.10)) (Настройка Службы времени Windows).

Если на контроллере домена установлено оборудование GPS, необходимо выполнить следующие действия, чтобы отключить NTP-клиент и включить NTP-сервер.

Для начала отключите NTP-клиент и включите NTP-сервер, используя эти изменения в разделе реестра.

```
reg add HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\w32time\TimeProviders\NtpClient /v Enabled /t REG_DWORD /d 0 /f

reg add HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\w32time\TimeProviders\NtpServer /v Enabled /t REG_DWORD /d 1 /f
```

Затем перезапустите службу времени Windows

```
net stop w32time && net start w32time
```

Наконец, вы указываете, что этот компьютер использует надежный источник времени.

```
w32tm /config /reliable:yes /update
```

Чтобы убедиться, что изменения выполнены правильно, можно выполнить показанные ниже команды, которые влияют на результаты.

```
w32tm /query /configuration

Value|Expected Setting|
----- | ----- |
AnnounceFlags| 5 (Local)|
NtpServer |(Local)|
DllName |C:\WINDOWS\SYSTEM32\w32time.DLL (Local)|
Enabled |1 (Local)|
NtpClient| (Local)|

w32tm /query /status /verbose

Value| Expected Setting|
----- | ----- |
Stratum| 1 (primary reference - syncd by radio clock)|
ReferenceId| 0x4C4F434C (source name: "LOCAL")|
Source| Local CMOS Clock|
Phase Offset| 0.0000000s|
Server Role| 576 (Reliable Time Service)|
```

#### <a name="windows-server-2016-on-3rd-party-virtual-platforms"></a>Windows Server 2016 на виртуальных платформах сторонних производителей

Если Windows виртуализирована, по умолчанию за предоставление времени отвечает гипервизор. Но, чтобы служба Active Directory работала корректно, присоединенные к домену члены должны быть синхронизированы с контроллером домена. Рекомендуется отключить любые временные виртуализации между гостевой системой и узлом любых виртуальных платформ сторонних производителей.

#### <a name="discovering-the-hierarchy"></a>Обнаружение иерархии

Так как цепочка временных иерархий к источнику главных часов в домене является динамической и согласованной, чтобы понять источник времени компьютера и привязать его к часам главного источника, необходимо запросить состояние этого определенного компьютера. Это поможет диагностировать проблемы синхронизации времени.

Если вы хотите диагностировать конкретного клиента, то первым шагом будет определение его источника времени с помощью этой команды w32tm.

```
w32tm /query /status
```

В результатах кроме прочего отображается исходный код. Исходный код указывает, с каким средством синхронизируется время в домене. Это первый этап иерархии времени этого компьютера.
Далее для поиска следующего источника времени в цепочке используйте исходную запись выше и параметр /StripChart.

```
w32tm /stripchart /computer:MySourceEntry /packetinfo /samples:1
```

Кроме того, следующая команда выводит список всех контроллеров домена, которые она может найти в указанном домене, и выводит результат, который позволяет определить каждого участника. Эта команда будет содержать компьютеры, настроенные вручную.

 w32tm /monitor /domain:my_domain

Используя список, вы можете проследить результаты через домен и понять иерархию, а также смещение во времени на каждом шаге. Находясь в точке, где смещение времени значительно хуже, можно определить корень неверного времени. Здесь можно попытаться определить, почему это время неверно, включив ведение журнала w32tm.

#### <a name="using-group-policy"></a>Использование групповой политики
Вы можете использовать групповую политику для достижения более высокой точности, например, назначая клиентов на использование определенных NTP-серверов или контролируя, как настраиваются операционные системы нижнего уровня при виртуализации.
Ниже приведен список возможных сценариев и соответствующих параметров групповой политики.

**Виртуализированные домены** Для контроля контроллеров виртуального домена в Windows 2012R2 с целью синхронизации их времени с доменом, а не с узлом Hyper-V, можно отключить эту запись реестра.  Для основного контроллера домена запись отключать не нужно, так как узел Hyper-V будет предоставлять наиболее стабильный источник времени. Для записи реестра необходимо перезапустить службу w32time после ее изменения.

 [HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\W32Time\TimeProviders\VMICTimeProvider] "Enabled"=dword:00000000

**Нагрузка с учетом точности** Для рабочих нагрузок с учетом точности времени можно настроить группы компьютеров для задания NTP-серверов и любых связанных параметров времени, таких как частота опроса и обновления времени. Обычно это обрабатывается доменом, но для большего контроля вы можете нацеливать определенные компьютеры непосредственно на главные часы.

Параметр групповой политики| Новое значение|
----- | ----- |
NtpServer| ClockMasterName,0x8|
MinPollInterval| 6 — 64 секунд|
MaxPollInterval| 6|
UpdateInterval| 100 — раз в секунду|
EventLogFlags| 3 — специальное ведение журнала|

> [!NOTE]
> Настройки NtpServer и EventLogFlags находятся в System\Служба времени Windows\Time Providers в настройках параметров NTP-клиента Windows. Остальные 3 находятся в System\Служба времени Windows Time Service с использованием глобальных параметров конфигурации.

**Удаленная точность чувствительных удаленных загрузок**. Для систем в доменах филиалов для розничной торговли и кредитных платежей (PCI) Windows использует сведения о текущем сайте и средстве обнаружения контроллеров домена для поиска локального контроллера домена, если не настроен ручной источник времени NTP. Эта среда требует точность в 1 секунду, которая использует более быстрое схождение в нужное время. Этот параметр позволяет службе w32time перевести часы назад. Если это приемлемо и соответствует вашим требованиям, можно создать следующую политику.  Как и в любой другой среде, обязательно протестируйте и определите базовый показатель своей сети.

Параметр групповой политики| Новое значение|
----- | ----- |
MaxAllowedPhaseOffset| 1, если больше чем на секунду, установите часы на коррекцию времени.|

Параметр MaxAllowedPhaseOffset находится в System\Служба времени Windows с использованием глобальных параметров конфигурации.

> [!NOTE]
> Дополнительные сведения о групповой политике и связанных с ней записях см. в статье [Windows Time Service Tools and Settings](windows-time-service-tools-and-settings.md) (Средства и параметры Службы времени Windows) и в статье "Параметры" на TechNet.

## <a name="azure-and-windows-iaas-considerations"></a>Рекомендации по Azure и IaaS для Windows

### <a name="azure-virtual-machine-active-directory-domain-services"></a>Виртуальная машина Azure: Доменные службы Active Directory
Если виртуальная машина Azure, на которой работают доменные службы Active Directory, является частью существующего локального леса Active Directory, TimeSync (VMIC) следует отключить. Это позволит всем контроллерам домена в лесу, как физическому, так и виртуальному, использовать единую иерархию синхронизации. Ознакомьтесь с рекомендациями ["Running Domain Controllers in Hyper-V"](/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/dd363553(v=ws.10)) (Запуск контроллеров домена в Hyper-V)

### <a name="azure-virtual-machine-domain-joined-machine"></a>Виртуальная машина Azure: компьютеры, присоединенные к домену
Если вы размещаете присоединенный к домену компьютер в существующем виртуальном или физическом лесу Active Directory, рекомендуется отключить TimeSync для гостя и убедиться, что служба W32Time настроена на синхронизацию с контроллером домена с помощью настройки времени для Type=NTP5.

### <a name="azure-virtual-machine-standalone-workgroup-machine"></a>Виртуальная машина Azure: автономный компьютер рабочей группы
Если виртуальная машина Azure не присоединена к домену или не является контроллером домена, рекомендуется использовать конфигурацию времени по умолчанию и синхронизировать виртуальную машину с узлом.

## <a name="windows-application-requiring-accurate-time"></a>Приложение Windows, нуждающееся в точном времени
### <a name="time-stamp-api"></a>Метка времени в формате API
Программам, требующим наибольшей точности относительно UTC, а не прохождения времени, следует использовать [API GetSystemTimePreciseAsFileTime](/windows/win32/api/sysinfoapi/nf-sysinfoapi-getsystemtimepreciseasfiletime). Это гарантирует, что приложение получит системное время, которое определяется Службой времени Windows.

### <a name="udp-performance"></a>Производительность UDP
Если у вас есть приложение, использующее связь по протоколу UDP для транзакций и важно сокращать задержку, есть некоторые связанные записи реестра, которые можно использовать для настройки диапазона портов, исключаемых из порта базовой системы фильтрации. Это уменьшит задержку и увеличит пропускную способность. Однако изменения в реестре должны быть ограничены опытными администраторами. Кроме того, это исключает защиту от использования портов брандмауэром. Дополнительные сведения см. в приведенной ниже справочной статье.

Для Windows Server 2012 и Windows Server 2008 необходимо сначала установить исправление. Вы можете сослаться на эту статью в базе знаний: [Datagram loss when you run a multicast receiver application in Windows 8 and in Windows Server 2012](https://support.microsoft.com/kb/2808584) (Потери датаграмм при запуске многоадресного приложения получателя в Windows 8 и Windows Server 2012)

### <a name="update-network-drivers"></a>Обновление сетевых драйверов
Некоторые поставщики сети имеют обновления драйверов, повышающие производительность с точки зрения задержки драйвера и буферизации пакетов UDP. Обратитесь к поставщику сети, чтобы узнать, есть ли обновления для получения помощи по пропускной способности UDP.

## <a name="logging-for-auditing-purposes"></a>Ведение журнала для целей аудита
Для соответствия с правилами трассировки времени журналы w32tm журналы событий и сведения об мониторе производительности можно архивировать вручную. Позднее архивированные данные можно использовать для подтверждения соответствия в определенное время в прошлом. Для указания точности используются следующие факторы.

1. Точность времени с помощью счетчика вычисляемого времени смещения производительности монитора. Он показывает часы с требуемой точностью.
2. Источник часов ищет "одноранговый ответ от" в журналах w32tm.  За текстом сообщения следует указать IP-адрес или VMIC, который описывает источник времени и следующие в цепочке эталонные часы для проверки.
3. Состояние условия часов с помощью журналов w32tm для проверки того, что "Дисциплина ClockDispl: \*SKEW\*TIME\*" происходит. Это указывает на то, что w32tm в это время активен.

### <a name="event-logging"></a>Ведение журналов событий
Для получения полной истории потребуется также информация журнала событий. Благодаря сбору журнала системных событий и выполнению фильтрации на сервере Time-Server, Microsoft-Windows-Kernel-Boot, Microsoft-Windows-Kernel General, вы сможете обнаружить, есть ли другие влияния, которые изменили время, например, сторонние организации. Эти журналы могут потребоваться для того, чтобы исключить внешние помехи. Групповая политика может влиять на то, какие журналы событий записываются в журнал. Дополнительные сведения см. в разделе, посвященном использованию групповой политики.

### <a name="w32time-debug-logging"></a><a name="W32Logging"></a>Ведение журнала отладки W32time
Следующая команда включает ведение журнала, который показывает периодические обновления часов и указывает на исходные часы, чтобы включить функцию w32tm для аудита. Перезапустите службу, чтобы включить новое ведение журнала.

Дополнительные сведения см. в статье [Как включить отладку входа в службу времени Windows](https://support.microsoft.com/kb/816043).

 w32tm /debug /enable /file:C:\Windows\Temp\w32time-test.log /size:10000000 /entries:0-73,103,107,110

### <a name="performance-monitor"></a>Системный монитор
Служба времени Windows Windows Server 2016 предоставляет счетчики производительности, которые можно использовать для сбора журналов аудита. Их можно регистрировать локально или удаленно. Вы можете записать счетчики смещения времени компьютера и кругового пути.
Поэтому вы можете отслеживать их удаленно, как и любой другой счетчик производительности, и создавать оповещения с помощью System Center Operations Manager. Вы можете, например, использовать оповещение для сообщения о том, что смещение времени отклоняется от требуемой точности. [Пакет управления System Center](https://www.microsoft.com/download/details.aspx?id=44231) содержит дополнительные сведения.

### <a name="windows-traceability-example"></a>Пример с трассировкой Windows
В файле журнала w32tm необходимо проверить два фрагмента информации. Первый указывает, что в настоящее время файл журнала является условием времени. Это доказывает, что в обсуждаемое время ваше время синхронизировано Службой времени Windows.

 151802 20:18:32.9821765s — Дисциплина ClockDispln: *ОТКЛОНЕНИЕ*ВРЕМЕНИ* — PhCRR:223 CR:156250 UI:100 phcT:65 KPhO:14307 151802 20:18:33.9898460s — Дисциплина ClockDispln *ОТКЛОНЕНИЕ*ВРЕМЕНИ* — PhCRR:1 CR:156250 UI:100 phcT:64 KPhO:41 151802 20:18:44.1090410s — Дисциплина ClockDispln *ОТКЛОНЕНИЕ*ВРЕМЕНИ* — PhCRR:1 CR:156250 UI:100 phcT:65 KPhO:38

Основным моментом является то, что вы видите сообщения с префиксом "Дисциплина ClockDispln", который является доказательством того, что w32time взаимодействует с вашими системными часами.

Далее вам нужно найти последний отчет в журнале перед обсуждаемым временем, который сообщает об исходном компьютере, используемом в настоящее время в качестве эталонных часов. Это может быть IP-адрес, имя компьютера или поставщик VMIC, который указывает на то, что он синхронизируется с узлом для Hyper-V. В следующем примере предоставляется IPv4-адрес 10.197.216.105.

 151802 20:18:54.6531515s — Отклик от узла 10.197.216.105,0x8 (ntp.m|0x8|0.0.0.0:123->10.197.216.105:123), ofs: +00.0012218s

Теперь, когда первая система в цепочке эталонного времени проверена, необходимо изучить файл журнала на источнике эталонного времени и повторить те же действия. Это продолжается, пока не будут получены физические часы, например GPS или известный источник времени, такой как NIST. Если в качестве эталонного времени используется GPS-оборудование, также могут потребоваться журналы из производства.

## <a name="network-considerations"></a>Требования к сети
Алгоритмы протокола NTP зависят от симметрии вашей сети. По мере увеличения количества сетевых прыжков возрастает вероятность асимметрии. Поэтому трудно предсказать, какие типы точности вы увидите в ваших конкретных условиях.

Монитор производительности и новые счетчики Службы времени в Windows Server 2016 можно использовать для оценки точности ваших сред и создания базовых показателей. Кроме того, можно выполнить устранение неполадок, чтобы определить текущее смещение любого компьютера в сети.

Существует два общих стандарта для точного времени по сети. PTP ([Протокол точного времени — IEEE 1588](https://www.nist.gov/el/intelligent-systems-division-73500/introduction-ieee-1588)) имеет более строгие требования к сетевой инфраструктуре, но часто может обеспечить точность до субмикросекунд. NTP ([Протокол сетевого времени — RFC 1305](https://tools.ietf.org/html/rfc1305)) работает в более широком спектре сетей и сред, что упрощает управление.

Windows по умолчанию поддерживает простой NTP-сервер (RFC2030) для компьютеров, не присоединенных к домену. Для компьютеров, присоединенных к домену, мы используем защищенный NTP-сервер, именуемый [MS-SNTP](/openspecs/windows_protocols/ms-sntp/8106cb73-ab3a-4542-8bc8-784dd32031cc), который использует согласованные секреты домена, которые предоставляют преимущества управления по сравнению с проверкой подлинности NTP, которые описаны в RFC1305 и RFC5905.

Для протоколов домена и не присоединенных к домену протоколов требуется UDP-порт 123. Дополнительные сведения о рекомендациях по использованию NTP см. в статье [Network Time Protocol Best Current Practices IETF Draft](https://tools.ietf.org/html/draft-ietf-ntp-bcp-00) (Черновик советов и рекомендаций IETF по протоколу сетевого времени).

### <a name="reliable-hardware-clock-rtc"></a>Надежные часы оборудования (RTC)

Windows не выполняет перевода времени, если только не превышены определенные границы, а регулирует часы. Это означает, что команда w32tm настраивает частоту часов на постоянный интервал, используя параметр частоты обновления часов, который по умолчанию устанавливается как один раз в секунду с Windows Server 2016. Если часы отстают, то они ускоряют частоту, а если спешат, то замедляют их. Однако во время настройки тактовой частоты контролируются аппаратные часы. Если возникает проблема с прошивкой или аппаратными часами, время на компьютере может стать менее точным.

Это еще одна причина, по которой вам необходимо протестировать и установить базовые показатели в вашей среде. Если счетчик производительности "Смещение в расчете времени" не стабилизируется до целевой точности, вам может потребоваться проверить актуальность встроенного ПО. В качестве еще одного теста можно посмотреть, создает ли дубликат аппаратного обеспечения ту же самую проблему.

### <a name="troubleshooting-time-accuracy-and-ntp"></a>Устранение неполадок с точностью времени и NTP

Чтобы понять источник неточного времени, можно воспользоваться приведенным выше разделом "Обнаружение иерархии". Просматривая смещение времени, найдите точку в иерархии, где время отличается от исходного NTP-источника. Как только вы поймете иерархию, вы захотите попытаться понять, почему этот конкретный источник времени не получает точного времени.

Если сосредоточиться на системе с другим временем, вы можете использовать приведенные ниже средства для сбора дополнительных сведений, помогающих определить и найти решение проблемы. Приведенная ниже ссылка на UpstreamClockSource представляет собой часы, обнаруженные с помощью команды "w32tm /config /status".

- Журналы системных событий
- Включение ведения журнала с помощью:журналы w32tm — w32tm /debug /enable /file:C:\Windows\Temp\w32time-test.log /size:10000000 /entries:0-300
- Ключ реестра w32Time HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\W32Time
- Трассировки локальной сети
- Счетчики производительности (с локального компьютера или UpstreamClockSource)
- W32tm /stripchart /computer:UpstreamClockSource
- Проверка связи UpstreamClockSource для понимания задержки и числа прыжков до источника
- Трассировка UpstreamClockSource

Проблема| Симптомы| Разрешение|
----- | ----- | ----- |
| Локальные часы TSC не стабильны.| Вы стабилизируете часы с помощью "Perfmon — Физический компьютер — Синхронизация времени" синхронизации часов, но по-прежнему видите каждые 1-2 минуты из нескольких 100US. | Обновление встроенного ПО или проверка другого оборудования не отображает одну и ту же ошибку.|
| Задержка сети| Функция stripchart команды W32tm отображает RoundTripDelay более 10 мс. Вариации задержки вызывают шумы размером до ½ длительности кругового пути, например задержку только в одном направлении.<br><br>UpstreamClockSource — это несколько прыжков, как указано проверкой связи. Срок жизни должен быть близок к 128.<br><br>Используйте Tracert для поиска задержки на каждом прыжке.  | Найдите более близкий источник часов для времени. Одно из решений — установить исходные часы в том же сегменте или вручную указать на исходные часы, географически расположенные ближе. Для сценария домена добавьте компьютер с ролью GTimeServ. |
Не удается надежно связаться с источником NTP| W32tm /stripchart периодически возвращает "Превышен интервал ожидания для запроса" |NTP-источник не отвечает|
NTP-источник не отвечает| Проверьте счетчики Perfmon для подсчета источников NTP-клиентов, входящих запросов NTP-сервера, исходящих ответов NTP-сервера и определите использование по сравнению с базовыми показателями.| С помощью счетчиков производительности сервера определите, изменилась ли нагрузка по сравнению с базовыми показателями.<br><br>Существуют ли проблемы из-за перегрузки сети?|
Контроллер домена не использует наиболее точные часы| Измените топологию или недавно добавленные часы, задающие время.| w32tm /resync /rediscover|
В клиентских часах выполняется смещение| Событие 36 в службе времени в журнале системных событий и (или) текст в файле журнала с описанием: Значение счетчика "Число источников времени NTP-клиента" от 1 до 0|Устраните неполадки в вышестоящем источнике и выясните, не возникли ли проблемы с производительностью.|

### <a name="baselining-time"></a>Задание базовых показателей для времени

Задания базовых показателей важно для оценки производительности и точности сети и дальнейшего сравнения с базовыми показателями при возникновении проблем. Вы захотите задать базовые показатели для корневого основного контроллера домена или всех компьютеров, помеченных с помощью GTIMESRV. Мы также рекомендуем задать базовые показатели для PDC в каждом лесу. Наконец, выберите критически важные контроллеры домена или компьютеры, имеющие интересные характеристики, такие как расстояние или большие нагрузки и задайте для них базовые показатели.

Полезно также задать базовые показатели для Windows Server 2016 и 2012 R2, однако в качестве средства для сравнения можно использовать только w32tm /stripchart, так как в Windows Server 2012 R2 нет счетчиков производительности. Следует выбрать два компьютера с одинаковыми характеристиками или обновить компьютер и сравнить результаты после обновления. Приложение Windows Time Measurements имеет дополнительные сведения о том, как выполнять подробные измерения между 2016 и 2012.

Соберите данные по крайней мере за неделю, используя счетчики производительности w32time, . Это обеспечит наличие достаточной ссылки на учетную запись в сети с течением времени и достаточное количество запусков для обеспечения уверенности в стабильной точности времени.

### <a name="ntp-server-redundancy"></a>Избыточность NTP-сервера

Для ручной настройки NTP-сервера, используемой с компьютерами, не присоединенными к домену или PDC, наличие более одного сервера является хорошей мерой избыточности в случае доступности. Это также может обеспечить лучшую точность, предполагая, что все источники являются точными и стабильными. Однако если топология не спроектирована надлежащим образом или источники времени не являются стабильными, полученная точность может быть хуже, поэтому рекомендуется соблюдать осторожность. Ограничение на поддерживаемые серверы времени w32time, на которые можно ссылаться вручную — 10.

## <a name="leap-seconds"></a>Корректировочные секунды

Период вращения Земли со временем меняется под влиянием климатических и геологических явлений. Обычно разница во времени составляет около секунды за каждые пару лет. Всякий раз, когда отклонение от атомного времени становится слишком большим, происходит поправка на одну секунду (вверх или вниз), называемая корректировочной секундой. Это делается таким образом, что разница никогда не превысит 0,9 секунд. Это исправление объявляется за шесть месяцев до фактического исправления. До появления Windows Server 2016 Служба времени Microsoft не знала о корректировочных секундах, но для этого исправления полагалась на внешнюю службу времени. С увеличением точности времени Windows Server 2016 корпорация Майкрософт работает над более подходящим решением для проблем с корректировочной минутой.

## <a name="secure-time-seeding"></a>Безопасное заполнение времени

W32Time в Server 2016 включает функцию безопасного заполнения времени. Эта функция определяет приблизительное текущее время от исходящих SSL-подключений. Это значение времени используется для отслеживания часов локальной системы и исправления грубых ошибок. Дополнительные сведения о функции можно узнать в [Secure Time Seeding — improving time keeping in Windows](/archive/blogs/w32time/secure-time-seeding-improving-time-keeping-in-windows) (Безопасное заполнение времени — улучшение учета времени в Windows). В развертываниях с надежными источниками времени и хорошо наблюдаемыми компьютерами, которые включают мониторинг смещения времени, функцию безопасного заполнения времени можно не использовать, и вместо этого полагаться на существующую инфраструктуру.

Вы можете отключить эту функцию, выполнив следующие действия.

1. Установите значение конфигурации реестра UtilizeSSLTimeData равным 0 на определенном компьютере:

    ```
    reg add HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\w32time\Config /v UtilizeSslTimeData /t REG_DWORD /d 0 /f
    ```

2. Если вы не можете перезагрузить компьютер немедленно по какой-либо причине, вы можете уведомить службу W32Time об обновлении конфигурации. Это остановит мониторинг и принудительное применение на основе данных времени, собранных из SSL-соединений.

    ```
    W32tm.exe /config /update
    ```

3. После перезагрузки компьютера параметр сразу же вступает в силу, а также приводит к остановке сбора любых данных времени с SSL-соединений. Последняя часть имеет очень небольшие временные затраты и не должна быть проблемой производительности.

4. Чтобы применить этот параметр ко всему домену, задайте значение UtilizeSSLTimeData в параметре групповой политики W32Time на значение "0" и опубликуйте параметр. Если параметр выбирается клиентом групповой политики, служба W32Time получает уведомление и прекращает мониторинг и принудительное применение с помощью данных времени SSL. Сбор данных времени SSL будет прерван при каждой перезагрузке компьютера. Если в вашем домене есть портативные тонкие ноутбуки/планшеты и другие устройства, вы можете исключить такие компьютеры из этой политики. В конечном итоге эти устройства столкнуться с саморазрядом батареи и для увеличения их времени потребуется функция "Безопасное заполнение времени".