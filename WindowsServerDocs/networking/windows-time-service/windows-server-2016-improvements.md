---
title: Улучшения Windows Server 2016
description: В Windows Server 2016 улучшены алгоритмы, используемые для корректировки времени и условия для синхронизации локальных часов с временем в формате UTC.
author: dcuomo
ms.author: dacuo
manager: dougkim
ms.date: 10/17/2018
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: networking
ms.openlocfilehash: 34d05a8058db366714c0ff4fed0b7d80b9150aa4
ms.sourcegitcommit: e2b565ce85a97c0c51f6dfe7041f875a265b35dd
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/19/2019
ms.locfileid: "69626387"
---
## <a name="windows-server-2016-improvements"></a>Улучшения Windows Server 2016

### <a name="windows-time-service-and-ntp"></a>Служба времени Windows и NTP
В Windows Server 2016 улучшены алгоритмы, используемые для корректировки времени и условия для синхронизации локальных часов с временем в формате UTC.  NTP использует 4 значения для вычисления смещения времени на основе меток времени клиента запрос/ответ, а также запроса или ответа сервера.  Однако сети имеют помехи, и в данных от NTP могут воздержаться пиковые нагрузки из-за перегрузки сети и других факторов, влияющих на задержку сети.  Алгоритмы Windows 2016 усреднены за этот шум с помощью ряда различных методов, которые приводят к стабильным и точным часам.  Кроме того, источник, используемый для точного времени, ссылается на Улучшенный API, который обеспечивает лучшее решение.  С помощью этих улучшений мы сможем достичь одной MS-точности с учетом времени в формате UTC для всего домена.

### <a name="hyper-v"></a>Hyper-V
В Windows 2016 была улучшена служба Hyper-V Тимесинк. Улучшения включают более точное начальное время при запуске виртуальной машины, восстановление ВМ и исправление задержки прерываний для примеров, предоставляемых в W32Time.  Это улучшение позволяет нам оставаться в 10μsе узла с RMS, (среднее значение в квадрате, означающее дисперсию), 50 μс, даже на компьютере с 75% нагрузки. Дополнительные сведения см. в статье [архитектура Hyper-V](https://msdn.microsoft.com/library/cc768520.aspx).

> [!NOTE]
> Загрузка была создана с использованием Prime95 теста производительности с использованием сбалансированного профиля.

Кроме того, уровень Стратум, который узел сообщает гостевой системе, является более прозрачным.  Ранее узел представит фиксированный Стратум из 2, независимо от его точности.  С учетом изменений в Windows Server 2016 узел сообщает о Стратум, который больше, чем Стратум узла, что приводит к повышению времени для виртуальных гостевых систем.  Узел Стратум определяется с помощью W32Time через обычные средства в зависимости от времени его источника.  Присоединенные к домену гости Windows 2016 будут находить наиболее точные часы, а не по умолчанию для узла.  По этой причине мы рекомендуем вручную отключить параметр поставщика времени Hyper-V для компьютеров, участвующих в домене в Windows 2012 R2 и ниже.

### <a name="monitoring"></a>Отслеживание
Счетчики системного монитора были добавлены.  Они позволяют выполнять базовые показатели, отслеживать и устранять точность времени.  Эти счетчики включают:

Счетчик|Описание|
----- | ----- |
Смещение вычисленного времени|   Абсолютное смещение времени между системным временем и выбранным источником времени, вычисленное службой W32Time в микросекундах. Если доступен новый допустимый пример, то вычисленное время обновляется с использованием смещения времени, указанного в примере. Это фактическое смещение времени локальных часов. Служба W32Time инициирует исправление часов с помощью этого смещения и обновляет вычисленное время между выборками с оставшимся смещением времени, которое необходимо применить к локальным часам. Точность часов можно отвести с помощью этого счетчика производительности с низким интервалом опроса (например, 256 секунд или меньше) и найти значение счетчика меньше требуемого предельного значения.|
Корректировка тактовой частоты| Абсолютная корректировка тактовой частоты, выполненная в часы локальной системы с помощью W32Time в штуках за миллиард. Этот счетчик помогает визуализировать действия, выполняемые службой W32Time.|
Задержка обмена данными NTP|    Последняя задержка приема-передачи, которая возникла в клиенте NTP при получении ответа от сервера в микросекундах. Это время, затраченное на NTP-клиент между передачей запроса серверу NTP и получением допустимого ответа от сервера. Этот счетчик помогает придерживаться задержек NTP-клиента. Увеличение или изменение обращений может привести к появлению шума в вычислениях времени NTP, что, в свою очередь, может повлиять на точность синхронизации времени через NTP.|
Число источников NTP-клиентов|    Активное число источников времени NTP, используемых NTP-клиентом. Это число активных, уникальных IP-адресов серверов времени, которые отвечают на запросы этого клиента. Это число может быть больше или меньше, чем настроенные одноранговые узлы, в зависимости от разрешения DNS имен одноранговых узлов и текущих возможностей REACH.|
Входящие запросы NTP-сервера|   Число запросов, полученных NTP-сервером (запросов/с).|
Исходящие ответы NTP-сервера|  Число запросов, на которые ответил NTP-сервер (ответов/с).|

Первые 3 счетчика предназначены для устранения проблем с точностью.  В [разделе рекомендации по](#BestPractices)диагностике времени и NTP ниже приведены более подробные сведения.
Последние 3 счетчика охватывают сценарии NTP-сервера и полезны при определении нагрузки и задания базовых показателей текущей производительности.

### <a name="configuration-updates-per-environment"></a>Обновления конфигурации для каждой среды
Ниже описаны изменения конфигурации по умолчанию между Windows 2016 и предыдущими версиями для каждой роли.  Параметры для Windows Server 2016 и годовщина обновления Windows 10 (сборка 14393) теперь являются уникальными, поэтому они отображаются как отдельные столбцы. 

|Role|Параметр|Windows Server 2016|Windows 10|Windows Server 2012 R2</br>Windows Server 2008 R2</br>Windows 10|
|---|---|---|---|---|
|**Автономный или Nano Server**||||
| |*Сервер времени*|time.windows.com|Н/Д|time.windows.com|
| |*Периодичность опроса*|64-1024 секунд|Н/Д|Один раз в неделю|
| |*Частота обновления часов*|Один раз в секунду|Н/Д|Один раз в час|
|**Автономный клиент**||||
| |*Сервер времени*|Н/Д|time.windows.com|time.windows.com|
| |*Периодичность опроса*|Н/Д|Один раз в день|Один раз в неделю|
| |*Частота обновления часов*|Н/Д|Один раз в день|Один раз в неделю|
|**Контроллер домена**||||
| |*Сервер времени*|PDC/ГТИМЕСЕРВ|Н/Д|PDC/ГТИМЕСЕРВ|
| |*Периодичность опроса*|64-1024 секунд|Н/Д|1024-32768 секунд|
| |*Частота обновления часов*|Один раз в день|Н/Д|Один раз в неделю|
|**Сервер члена домена**||||
| |*Сервер времени*|DC|Н/Д|DC|
| |*Периодичность опроса*|64-1024 секунд|Н/Д|1024-32768 секунд|
| |*Частота обновления часов*|Один раз в секунду|Н/Д|Каждые 5 минут|
|**Клиент члена домена**||||
| |*Сервер времени*|Н/Д|DC|DC|
| |*Периодичность опроса*|Н/Д|1204-32768 секунд|1024-32768 секунд|
| |*Частота обновления часов*|Н/Д|Каждые 5 минут|Каждые 5 минут|
|**Гостевой сервер Hyper-V**||||
| |*Сервер времени*|Выбор наилучшего параметра на основе Стратум сервера узла и времени|Выбор наилучшего параметра на основе Стратум сервера узла и времени|По умолчанию используется узел|
| |*Периодичность опроса*|На основе указанной выше роли|На основе указанной выше роли|На основе указанной выше роли|
| |*Частота обновления часов*|На основе указанной выше роли|На основе указанной выше роли|На основе указанной выше роли|

>[!NOTE]
>Для Linux в Hyper-V см. раздел [разрешение использования Linux для работы с узлом Hyper-v](#AllowingLinux) ниже.

### <a name="impact-of-increased-polling-and-clock-update-frequency"></a>Влияние увеличенной частоты опроса и обновления часов
Чтобы обеспечить более точное время, значения по умолчанию для частоты опроса и обновления часов увеличиваются, что позволяет нам чаще вносить небольшие изменения.  Однако это приведет к большему трафику UDP/NTP, но эти пакеты будут небольшими, так что они не будут оказывать влияния на широкополосные каналы. Однако преимущество заключается в том, что время должно быть лучше на более широком спектре оборудования и сред.

Для устройств с резервным аккумулятором увеличение частоты опроса может вызвать проблемы.  Устройства с батареей не сохраняют время, когда оно выключено.  Когда они возобновляются, может потребоваться частое исправление часов.  Увеличение частоты опроса приведет к тому, что часы будут нестабильными и могут также использовать больше энергии.  Корпорация Майкрософт рекомендует не изменять параметры клиента по умолчанию.

Контроллеры домена должны быть минимально затронуты даже с ростом влияния улучшенных обновлений с NTP-клиентов в домене AD.  По сравнению с другими протоколами и значительным влиянием на NTP-ресурсы снижает потребление ресурсов.  Скорее всего, вы найдете ограничения для других функциональных возможностей домена, прежде чем они будут затронуты улучшенными параметрами Windows Server 2016.  Active Directory использует защищенный NTP-клиент, который, как правило, выполняет синхронизацию менее точно, чем простой NTP, но мы проверили, что масштабирование будет масштабироваться до двух Стратум с основного контроллера домена.

Для консервативного плана необходимо резервировать 100 NTP-запросов в секунду на ядро.  Например, домен, состоять из 4 контроллеров домена с 4 ядрами, должен иметь возможность обслуживать 1600 NTP-запросов в секунду.  При наличии 10 000 клиентов, настроенных для синхронизации времени один раз в 64 секунд, и запросы получаются единообразно с течением времени, вы увидите примерно 10000/64 или около 160 запросов в секунду, распределенных по всем контроллерам домена.  Это легко в 1600 NTP-запросов в секунду на основе этого примера.  Они являются консервативными рекомендациями по планированию и имеют большую зависимость от сети, скорости процессора и загрузок, так как всегда базовые показатели и тест в средах.

Также важно отметить, что если контроллеры домена работают с значительной загрузкой ЦП, более 40%, это почти наверняка добавит шум в NTP-ответы и повлияет на точность времени в домене.  Опять же, необходимо протестировать в своей среде, чтобы понять фактические результаты.

## <a name="time-accuracy-measurements"></a>Измерения точности времени
### <a name="methodology"></a>Методологии
Чтобы измерить точность времени для Windows Server 2016, мы использовали разнообразные средства, методы и среды.  Эти методы можно использовать для измерения и настройки среды и определения соответствия результатов точности требованиям. 

Время работы с исходным кодом домена состояло из двух NTP-серверов высокой точности с оборудованием GPS.  Мы также использовали отдельный эталонный тестовый компьютер для измерений, в котором также установлено оборудование GPS с высокой точностью, установленное у другого производителя.  Для некоторых целей тестирования вам потребуется точный и надежный источник часов, который будет использоваться в качестве ссылки в дополнение к источнику часов домена.

Мы использовали четыре разных метода для измерения точности как физических, так и виртуальных машин. Для проверки результатов можно указать несколько методов.


1. Измерьте локальные часы, которые задается с помощью w32tm, на нашем эталонном тесте, который имеет отдельное оборудование GPS.  
2.  Измерение NTP-проверок связи между NTP-сервером и клиентами с помощью команды w32tm "стрипчарт"
3.  Измерение NTP-проверок связи между клиентом и NTP-сервером с помощью команды w32tm "стрипчарт"
4.  Измерьте результаты Hyper-V с узла на гостевой сервер с помощью счетчика отметки времени (TSC).  Этот счетчик совместно используется обеими секциями и системным временем в обеих секциях.  Мы расчитали разницу между временем узла и временем клиента на виртуальной машине.  Затем мы используем часы таймера TSC для интерполяции времени размещения от гостя, так как измерения не происходят одновременно.  Кроме того, мы используем задержки и задержки коэффициента TSV в API.

Подсистема w32tm встроена, но другие средства, которые мы использовали во время тестирования, доступны для репозитория Майкрософт на GitHub в качестве открытого кода для тестирования и использования.  ВИКИ-сайт в репозитории содержит дополнительные сведения, описывающие использование средств для измерения.

> [https://github.com/Microsoft/Windows-Time-Calibration-Tools](https://github.com/Microsoft/Windows-Time-Calibration-Tools)

Результаты теста, показанные ниже, представляют собой подмножество измерений, сделанных в одной из тестовых сред.  Они иллюстрируют точность, поддерживаемую в начале иерархии времени, и клиент дочернего домена в конце иерархии времени.  Это сравнивается с теми же компьютерами в топологии на основе 2012 для сравнения.

### <a name="topology"></a>Топология
Для сравнения мы тестировали топологию на основе Windows Server 2012 R2 и Windows Server 2016.  Обе топологии состоят из двух физических компьютеров размещения Hyper-V, которые ссылаются на компьютер Windows Server 2016 с установленным оборудованием GPS Clock.  Каждый узел запускает 3 присоединяемых к домену гостевых ОС Windows, которые упорядочены в соответствии со следующей топологией.  Строки представляют собой иерархию времени и используемый протокол или транспорт.

![Служба времени Windows](../media/Windows-Time-Service/Windows-2016-Accurate-Time/topology1.png)

![Служба времени Windows](../media/Windows-Time-Service/Windows-2016-Accurate-Time/topology2.png)

### <a name="graphical-results-overview"></a>Обзор графических результатов
Следующие два графика представляют точность времени для двух конкретных элементов в домене на основе топологии выше.  На каждом графе отображаются 2012 R2ные результаты Windows Server и 2016, что демонстрирует Визуальные улучшения.  Точность была измерена с-на гостевом компьютере по сравнению с узлом.  Графические данные представляют собой подмножество всех выполненных тестов и показывает наилучшие и худшие случаи.  

![Служба времени Windows](../media/Windows-Time-Service/Windows-2016-Accurate-Time/topology3.png)

### <a name="performance-of-the-root-domain-pdc"></a>Производительность основного контроллера домена в корневом домене
Корневой основной контроллер домена синхронизируется с узлом Hyper-V (с использованием ВМИК), который представляет собой Windows Server 2016 с оборудованием GPS, который признан как точным и стабильным.  Это критически важное требование для 1 MS-точности, которое отображается в виде зеленой затененной области.

![Служба времени Windows](../media/Windows-Time-Service/Windows-2016-Accurate-Time/chart1.png)

### <a name="performance-of-the-child-domain-client"></a>Производительность клиента дочернего домена
Клиент дочернего домена подключен к основному контроллеру домена, который подключается к корневому основному контроллеру доменов.  Время его выполнения также должно быть задано в 1 мс.

![Служба времени Windows](../media/Windows-Time-Service/Windows-2016-Accurate-Time/chart2.png)


### <a name="long-distance-test"></a>Проверка на дальние расстояния
Следующая диаграмма сравнивает 1 прыжк виртуальной сети с 6 последовательными прыжками с Windows Server 2016.  Две диаграммы наложены друг на друга с прозрачностью для отображения перекрывающихся данных.  Увеличение числа прыжков сети означает более высокую задержку и более высокие отклонения времени.  Диаграмма увеличена, поэтому границы 1 мс, представленные зеленой областью, больше.  Как видите, время по-прежнему находится в пределах 1 мс с несколькими прыжками.  Это отрицательное смещение, которое демонстрирует асимметрию сети.  Разумеется, каждая сеть различается, и измерения зависят от множества факторов среды.

![Служба времени Windows](../media/Windows-Time-Service/Windows-2016-Accurate-Time/chart3.png)

## <a name="BestPractices"></a>Рекомендации по точному тимекипинг
### <a name="solid-source-clock"></a>Твердотельные часы с источником
Время машины так же хорошо, как и исходные часы, с которыми он синхронизируется.  Чтобы достичь точности в 1 мс, вам потребуется оборудование GPS или устройство времени в сети, на которое вы ссылаетесь в качестве часов главного источника.  Использование значения по умолчанию time.windows.com не может предоставить стабильный и местный источник времени.  Кроме того, как только вы покинете часы источника, сеть повлияет на точность.  Для наилучшей точности необходимо наличие часов главного источника в каждом центре обработки данных.

### <a name="hardware-gps-options"></a>Параметры оборудования GPS
Существуют различные аппаратные решения, которые могут предложить точное время.  Как правило, решения на сегодняшний день основаны на антеннах GPS.  Существуют также решения для радио и коммутируемых модемов, использующие выделенные линии.  Они присоединяются к сети как устройство или подключаются к компьютеру, например, к Windows через устройство PCIe или USB.  Различные параметры обеспечивают разные уровни точности, и, как и всегда, результаты зависят от конкретной среды.  Переменные, которые влияют на точность, включают в себя доступность GPS, стабильность и загрузку сети и оборудование ПК.  Это все важные факторы при выборе исходных часов, которые, как мы упоминали, являются обязательным требованием для стабильного и точного времени.

### <a name="domain-and-synchronizing-time"></a>Время домена и синхронизация
Члены домена используют доменную иерархию для определения того, какой компьютер используется в качестве источника для синхронизации времени.  Каждый член домена найдет другой компьютер для синхронизации и сохранит его в качестве источника часов.  Каждый тип члена домена соответствует другому набору правил, чтобы найти источник часов для синхронизации времени.  Основной контроллер домена в корне леса является источником часов по умолчанию для всех доменов.  Ниже перечислены различные роли и общее описание того, как они находят источник:


- **Контроллер домена с РОЛЬЮ PDC** — этот компьютер является полномочным источником времени для домена. Оно будет иметь наиболее точное время, доступное в домене, и должно быть синхронизировано с КОНТРОЛЛЕРом домена в родительском домене, за исключением случаев, когда включена роль [гтимесерв](#GTIMESERV) . 
- **Любой другой контроллер домена** — этот компьютер будет работать в качестве источника времени для клиентов и рядовых серверов в домене. Контроллер домена может синхронизироваться с основным контроллером домена или любым КОНТРОЛЛЕРом домена в его родительском домене.
- **Клиенты и рядовые серверы** — этот компьютер может синхронизироваться с любым контроллером домена или основным контроллером домена или контроллером домена или PDC в родительском домене.

На основе доступных кандидатов система оценки используется для поиска лучшего источника времени.  Эта система учитывает надежность источника времени и его относительного расположения.  Это происходит один раз при запуске службы.  Если требуется более точное управление синхронизацией времени, можно добавить хорошие серверы времени в определенные расположения или добавить избыточность.  Дополнительные сведения см. в разделе [Определение локальной надежной службы времени с помощью гтимесерв](#GTIMESERV) .

#### <a name="mixed-os-environments-win2012r2-and-win2008r2"></a>Смешанные среды ОС (Win2012R2 и Win2008R2)
Хотя для наилучшей точности требуется чистая среда домена Windows Server 2016, в смешанной среде все еще есть преимущества.  Развертывание Windows Server 2016 Hyper-V в домене Windows 2012 позволит получить доступ к гостям из-за описанных выше улучшений, но только в том случае, если гости также относятся к Windows Server 2016.  Основной контроллер домена Windows Server 2016 может предоставить более точное время из-за улучшенных алгоритмов, который будет более стабильным источником.  Замена основного контроллера домена может быть невозможной. вместо этого можно добавить Windows Server 2016 DC с набором данных [гтимесерв](#GTIMESERV) , который будет обновляться точно так же, как для вашего домена.  Контроллеры домена Windows Server 2016 могут обеспечить лучшее время для клиентов в нисходящем времени, но это так же хорошо, как и время его исходного NTP.

Кроме того, как указано выше, частота опроса и обновления часов была изменена с помощью Windows Server 2016.  Их можно изменить вручную на контроллеры домена нижнего уровня или применить с помощью групповой политики.  Хотя мы не тестировали эти конфигурации, они должны хорошо вести себя в Win2008R2 и Win2012R2 и предоставлять некоторые преимущества.

В версиях, предшествующих Windows Server 2016, было обнаружено несколько проблем, которые приводят к точному времени, что привело к смещению системного времени сразу после внесения корректировки.  В связи с этим получение примеров времени из точной NTP-источника часто и соблюдение условий местного времени с данными приводит к меньшему смещению системных часов в течение периода внутренней выборки, что приводит к более эффективному хранению версий ОС более высокого уровня. Наиболее хорошо замеченная точность была приблизительно в 5 мс, когда NTP-клиент Windows Server 2012 R2, настроенный с параметрами высокой точности, синхронизирован со временем с точной системы Windows 2016 NTP Server.

В некоторых сценариях, использующих гостевые контроллеры домена, примеры Тимесинк Hyper-V могут нарушить синхронизацию времени домена.  Это не должно быть проблемой для гостевых серверов 2016, работающих на узлах Hyper-V сервера 2016.

Чтобы отключить от службы Hyper-V Тимесинк предоставление образцов для W32Time, установите следующий раздел реестра Guest:

    HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\W32Time\TimeProviders\VMICTimeProvider 
    "Enabled"=dword:00000000

#### <a name="AllowingLinux"></a>Разрешить Linux использовать время узла Hyper-V
Для гостевых ОС Linux в Hyper-V клиенты обычно настроены на использование управляющей программы NTP для синхронизации времени с NTP-серверами.  Если дистрибутив Linux поддерживает протокол Тимесинк версии 4, а на гостевой виртуальной машине Linux включена служба интеграции Тимесинк, то она будет синхронизироваться с временем узла. Это может привести к несовместимости времени при включении обоих методов.

Для синхронизации только с временем размещения рекомендуется отключить синхронизацию времени NTP одним из следующих способов:

- Отключение всех NTP-серверов в файле NTP. conf
- или отключение управляющей программы NTP

В этой конфигурации параметр сервера времени является этим узлом.  Частота опроса составляет 5 секунд, а частота обновления часов — также 5 секунд.

Для синхронизации только по протоколу NTP рекомендуется отключить службу интеграции Тимесинк в гостевой системе.

> [!NOTE]
> Примечание.  Для обеспечения точного времени с гостевыми системами Linux требуется функция, которая поддерживается только в последних версиях восходящих ядер Linux, и она пока недоступна для всех дистрибутивов Linux. Дополнительные сведения о дистрибутивах поддержки см. на [поддерживаемых виртуальных машинах Linux и FreeBSD для Hyper-V в Windows](https://technet.microsoft.com/windows-server-docs/virtualization/hyper-v/supported-linux-and-freebsd-virtual-machines-for-hyper-v-on-windows) .

#### <a name="GTIMESERV"></a>Укажите локальную надежную службу времени с помощью ГТИМЕСЕРВ
Вы можете указать один или несколько контроллеров домена в качестве точных исходных часов с помощью ГТИМЕСЕРВ, хорошего сервера времени, флагов.  Например, определенные контроллеры домена, оснащенные оборудованием GPS, можно пометить как ГТИМЕСЕРВ.  Это гарантирует, что домен будет ссылаться на часы на основе оборудования GPS.

> [!NOTE]
> Дополнительные сведения о флагах домена можно найти в [документации по протоколу MS-ADTS](https://msdn.microsoft.com/library/mt226583.aspx).

ТИМЕСЕРВ — это еще один связанный флаг доменных служб, который указывает, является ли компьютер полномочным, что может измениться, если контроллер домена теряет подключение.  Контроллер домена в этом состоянии будет возвращать значение "Unknown Стратум" при запросе через NTP.  После нескольких попыток контроллер домена запишет в журнал системное событие время события 36.

Если вы хотите настроить контроллер домена как ГТИМЕСЕРВ, его можно настроить вручную с помощью следующей команды.  В этом случае контроллер домена использует другие компьютеры в качестве главного часов.  Это может быть устройство или выделенный компьютер.

    w32tm /config /manualpeerlist:”master_clock1,0x8 master_clock2,0x8” /syncfromflags:manual /reliable:yes /update

> [!NOTE]
> Дополнительные сведения см. [в разделе Настройка службы времени Windows](https://technet.microsoft.com/library/cc731191.aspx) .

Если на контроллере домена установлено оборудование GPS, необходимо выполнить следующие действия, чтобы отключить NTP-клиент и включить NTP-сервер.

Для начала отключите NTP-клиент и включите NTP-сервер, используя эти изменения в разделе реестра.

    reg add HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\w32time\TimeProviders\NtpClient /v Enabled /t REG_DWORD /d 0 /f

    reg add HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\w32time\TimeProviders\NtpServer /v Enabled /t REG_DWORD /d 1 /f

Затем перезапустите службу времени Windows.

    net stop w32time && net start w32time

Наконец, вы указываете, что этот компьютер имеет надежный источник времени с помощью.
   
    w32tm /config /reliable:yes /update

Чтобы убедиться, что изменения выполнены правильно, можно выполнить следующие команды, которые влияют на результаты, показанные ниже. 

    w32tm /query /configuration

Значение|Ожидаемый параметр|
----- | ----- |
аннаунцефлагс|  5 (локальный)|
Сервер   |Языковые|
DllName |C:\WINDOWS\SYSTEM32\w32time. DLL (локальная)|
Enabled |1 (локальный)|
Повторит|  Языковые|

    w32tm /query /status /verbose

Значение|  Ожидаемый параметр|
----- | ----- |
стратум|    1 (первичная ссылка — синхронизирована по радиочасам)|
ReferenceId|    0x4C4F434C (имя источника:  "LOCAL")|
Source| Часы локальной CMOS|
Смещение фазы|   0.0000000 s|
Роль сервера|    576 (надежная служба времени)|

#### <a name="windows-server-2016-on-3rd-party-virtual-platforms"></a>Windows Server 2016 на виртуальных платформах сторонних производителей
Когда Windows виртуализирована, гипервизор по умолчанию отвечает за предоставление времени.  Однако присоединенные к домену члены должны быть синхронизировались с контроллером домена, чтобы Active Directory правильно работать.  Рекомендуется отключить любые временные виртуализации между гостевой системой и узлом любых виртуальных платформ сторонних производителей.

#### <a name="discovering-the-hierarchy"></a>Обнаружение иерархии
Так как цепочка временных иерархий в источнике главных часов является динамической в домене и согласована, необходимо запросить состояние определенного компьютера, чтобы понять его источник времени и привязать к часам главного источника.  Это поможет диагностировать проблемы синхронизации времени.

Вы хотите устранить неполадки определенного клиента; первым шагом является понимание его источника времени с помощью этой команды W32tm.

    w32tm /query /status

В результатах отображается исходный код.  Источник указывает, с кем синхронизируется время в домене.  Это первый этап иерархии времени этого компьютера.
Далее используйте запись источника выше и используйте параметр/Стрипчарт для поиска следующего источника времени в цепочке.

    w32tm /stripchart /computer:MySourceEntry /packetinfo /samples:1

Кроме того, следующая команда выводит список всех контроллеров домена, которые он может найти в указанном домене, и выводит результат, который позволяет определить каждого участника.  Эта команда будет включать компьютеры, настроенные вручную.
    
    w32tm /monitor /domain:my_domain

С помощью списка можно отслеживать результаты в домене и понимать иерархию, а также смещение времени на каждом шаге.  Находясь в точке, где смещение времени значительно хуже, можно определить корень неверного времени.  Здесь можно попытаться понять, почему это время неверно, включив [ведение журнала w32tm](#W32Logging). 

#### <a name="using-group-policy"></a>Использование групповая политика
Групповая политика можно использовать для достижения более высокой точности, например, назначения клиентов для использования определенных NTP-серверов или для управления настройкой операционной системы нижнего уровня при виртуализации.  
Ниже приведен список возможных сценариев и соответствующих параметров групповая политика.

**Виртуализированные домены** . для управления виртуальными контроллерами домена в Windows 2012 R2, чтобы они синхронизировались время с их доменом, а не с узлом Hyper-V, эту запись реестра можно отключить.   Для основного контроллера домена не нужно отключать запись, так как узел Hyper-V будет предоставлять наиболее стабильный источник времени.  Для записи реестра необходимо перезапустить службу W32Time после ее изменения.

    [HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\W32Time\TimeProviders\VMICTimeProvider]
    "Enabled"=dword:00000000

**Загрузка с учетом точности** . для чувствительных к времени рабочих нагрузок можно настроить группы компьютеров для задания NTP-серверов и любых связанных параметров времени, например частоту опроса и обновления часов.  Обычно это обрабатывается доменом, но для более точного управления можно ориентироваться на конкретные компьютеры, чтобы они указывали непосредственно на главные часы.

Параметр групповой политики|   Новое значение|
----- | ----- |
Сервер|  Клоккмастернаме, 0x8|
минполлинтервал|    6 – 64 секунд|
максполлинтервал|    6|
упдатеинтервал| 100 — раз в секунду|
евентлогфлагс|  3 — все особое время ведения журнала|

> [!NOTE]
> Параметры NTP и Евентлогфлагс находятся в разделе Систем\виндовс Time Сервице\тиме providers (Настройка параметров NTP-клиента Windows).  Остальные 3 находятся в разделе Служба времени Систем\виндовс с использованием глобальных параметров конфигурации.

При **удаленной чувствительности с учетом точности удалена** — для систем в доменах филиалов для розничной торговли и кредитных платежей (PCI) Windows использует текущие сведения о сайте и локатор контроллеров домена для поиска локального контроллера домена, если не настроен ручной источник времени NTP. .  Эта среда требует 1 секунды точности, которая использует более быстрое схождение в нужное время.  Этот параметр позволяет службе W32Time переместить часы назад.  Если это приемлемо и соответствует вашим требованиям, можно создать следующую политику.   Как и в случае с любой средой, тестирование и базовое значение сети проверяется. 

Параметр групповой политики|   Новое значение|
----- | ----- |
максалловедфасеоффсет|  1, если больше, чем в секундах, задайте для параметра часы правильное время.|

Параметр Максалловедфасеоффсет находится в разделе Служба времени Систем\виндовс с использованием глобальных параметров конфигурации.

> [!NOTE]
> Дополнительные сведения о групповой политике и связанных с ней записях см. в статье о средствах и параметрах [службы времени Windows](windows-time-service-tools-and-settings.md) на сайте TechNet.

## <a name="azure-and-windows-iaas-considerations"></a>Рекомендации по Azure и IaaS для Windows

### <a name="azure-virtual-machine-active-directory-domain-services"></a>Виртуальная машина Azure: Доменные службы Active Directory
Если виртуальная машина Azure, на которой работает домен Active Directory Services, является частью существующего локального Active Directory леса, то следует отключить Тимесинк (ВМИК). Это позволит всем контроллерам домена в лесу, как физическому, так и виртуальному, использовать единую иерархию синхронизации. См. технический документ ["работа с контроллерами домена в Hyper-V"](https://technet.microsoft.com/library/virtual_active_directory_domain_controller_virtualization_hyperv.aspx) .

### <a name="azure-virtual-machine-domain-joined-machine"></a>Виртуальная машина Azure: Компьютер, присоединенный к домену
Если вы размещаете компьютер, присоединенный к домену в существующем Active Directory лесу, виртуальном или физическом, рекомендуется отключить Тимесинк для гостя и убедиться, что Служба W32Time настроена для синхронизации с контроллером домена с помощью настройки времени для Type = NTP5

### <a name="azure-virtual-machine-standalone-workgroup-machine"></a>Виртуальная машина Azure: Автономный компьютер рабочей группы
Если виртуальная машина Azure не присоединена к домену или не является контроллером домена, рекомендуется использовать конфигурацию времени по умолчанию и синхронизировать виртуальную машину с узлом.

## <a name="windows-application-requiring-accurate-time"></a>Приложение Windows, нуждающееся в точном времени
### <a name="time-stamp-api"></a>API метки времени
Программы, для которых требуется наибольшая точность относительно времени в формате UTC, а не время, должны использовать [API жетсистемтимепреЦисеасфилетиме](https://msdn.microsoft.com/library/windows/desktop/Hh706895.aspx).  Это гарантирует, что приложение получит системное время, которое определяется службой времени Windows.

### <a name="udp-performance"></a>Производительность UDP
Если у вас есть приложение, использующее связь по протоколу UDP для транзакций и важно сокращать задержку, есть некоторые связанные записи реестра, которые можно использовать для настройки диапазона портов, исключаемых из порта базовой системы фильтрации.  Это повысит и задержку, и увеличит пропускную способность.  Однако изменения в реестре должны быть ограничены опытными администраторами.  Кроме того, это исключает защиту от использования портов брандмауэром.  Дополнительные сведения см. в приведенной ниже справочной статье.

Для Windows Server 2012 и Windows Server 2008 необходимо сначала установить исправление.  Вы можете сослаться на эту статью в базе знаний: [Потери датаграмм при запуске многоадресного приложения получателя в Windows 8 и Windows Server 2012](https://support.microsoft.com/kb/2808584)

### <a name="update-network-drivers"></a>Обновление сетевых драйверов
Некоторые поставщики сети имеют обновления драйверов, повышающие производительность с точки зрения задержки драйвера и буферизации пакетов UDP.  Обратитесь к поставщику сети, чтобы узнать, есть ли обновления для получения помощи по пропускной способности UDP.

## <a name="logging-for-auditing-purposes"></a>Ведение журнала для целей аудита
В соответствии с правилами трассировки времени можно вручную архивировать журналы w32tm, журналы событий и сведения об мониторе производительности.  Позднее архивная информация может использоваться для подтверждения соответствия в определенное время в прошлом.  Для указания точности используются следующие факторы.


1. Точность часов с использованием счетчика монитора производительности "время смещения в расчете времени".  Это показывает часы с требуемой точностью.
2.  Источник часов ищет "одноранговый ответ от" в журналах W32tm.   За текстом сообщения следует указать IP-адрес или ВМИК, который описывает источник времени и следующий в цепочке эталонных синхронизирующих импульсов для проверки.
3.  Состояние состояния часов с помощью журналов w32tm для проверки того, что "Клоккдиспл дисциплина: \*Происходит\*отклонение времени\*.  Это означает, что Служба w32tm активна в момент времени.

### <a name="event-logging"></a>Ведение журнала событий
Для получения полной истории потребуется также информация журнала событий.  Благодаря сбору журнала системных событий и фильтрации по времени сервер, Microsoft-Windows-kernel-boot, Microsoft-Windows-kernel-General, вы можете определить, есть ли другие изменения, которые могли изменить время, например третьим лицам.  Эти журналы могут потребоваться для того, чтобы исключить внешние помехи.  Групповая политика может влиять на то, какие журналы событий записываются в журнал.  Дополнительные сведения см. в разделе, посвященном использованию групповая политика.

### <a name="W32Logging"></a>Ведение журнала отладки W32Time
Чтобы включить w32tm для аудита, следующая команда включает ведение журнала, в котором отображаются периодические обновления часов и указываются исходные часы.  Перезапустите службу, чтобы включить новое ведение журнала.  

Дополнительные сведения см. в разделе [Включение ведения журнала отладки в службе времени Windows](https://support.microsoft.com/kb/816043).

    w32tm /debug /enable /file:C:\Windows\Temp\w32time-test.log /size:10000000 /entries:0-73,103,107,110

### <a name="performance-monitor"></a>Системный монитор
Служба времени Windows Windows Server 2016 предоставляет счетчики производительности, которые можно использовать для сбора журналов аудита.  Они могут регистрироваться локально или удаленно.  Можно записать счетчики смещения времени компьютера и кругового пути.  
Как и любой счетчик производительности, вы можете отслеживать их удаленно и создавать оповещения с помощью System Center Operations Manager.  Например, оповещение можно использовать для оповещения о смещении смещения по времени от желаемой точности.  Дополнительные сведения см. в [пакете управления System Center](https://social.technet.microsoft.com/wiki/contents/articles/15251.system-center-management-pack-authoring-guide.aspx) .

### <a name="windows-traceability-example"></a>Пример с трассировкой Windows
В файле журнала w32tm необходимо проверить два фрагмента информации.  Первый — указывает, что в настоящее время файл журнала имеет состояние Clock.  Это подтверждает, что время ожидания в службе времени Windows истекло в случае спорного времени.

    151802 20:18:32.9821765s - ClockDispln Discipline: *SKEW*TIME* - PhCRR:223 CR:156250 UI:100 phcT:65 KPhO:14307
    151802 20:18:33.9898460s - ClockDispln Discipline: *SKEW*TIME* - PhCRR:1 CR:156250 UI:100 phcT:64 KPhO:41
    151802 20:18:44.1090410s - ClockDispln Discipline: *SKEW*TIME* - PhCRR:1 CR:156250 UI:100 phcT:65 KPhO:38

Главным моментом является то, что вы видите сообщения с префиксом Клоккдисплн дисциплина, которая является доказательством, взаимодействующим с системными часами.
 
Затем необходимо найти последний отчет в журнале до момента спорного времени, который сообщает об исходном компьютере, который в данный момент используется в качестве эталонного времени.  Это может быть IP-адрес, имя компьютера или поставщик ВМИК, который указывает на то, что он синхронизируется с узлом для Hyper-V.  В следующем примере предоставляется IPv4-адрес 10.197.216.105.

    151802 20:18:54.6531515s - Response from peer 10.197.216.105,0x8 (ntp.m|0x8|0.0.0.0:123->10.197.216.105:123), ofs: +00.0012218s

Теперь, когда первая система в цепочке времени ссылок проверена, необходимо изучить файл журнала на источнике времени ссылки и повторить те же действия.  Это происходит до тех пор, пока не будут получены физические часы, например GPS или известный источник времени, такой как NIST.  Если в качестве эталонного времени используется GPS-оборудование, то также могут потребоваться журналы из производства.

## <a name="network-considerations"></a>Рекомендации по сети
Алгоритмы NTP-протокола имеют зависимость от симметрии сети.  При увеличении числа прыжков сети вероятность асимметрию возрастает.  В этом случае трудно предсказать, какие типы точности будут отображаться в конкретных средах. 

Системный монитор и новые счетчики времени Windows в Windows Server 2016 можно использовать для оценки точности сред и создания базовых показателей. Кроме того, можно выполнить устранение неполадок, чтобы определить текущее смещение любой машины в сети.

Существует два общих стандарта для точного времени по сети.  PTP ([протокол времени точности-IEEE 1588](https://www.nist.gov/el/intelligent-systems-division-73500/introduction-ieee-1588)) имеет более строгие требования к сетевой инфраструктуре, но часто может обеспечить точность в микросекундах.  NTP ([Сетевой протокол времени — RFC 1305](https://tools.ietf.org/html/rfc1305)) работает в более широком спектре сетей и сред, что упрощает управление. 

Windows по умолчанию поддерживает простой NTP-сервер (RFC2030) для компьютеров, не присоединенных к домену.  Для компьютеров, присоединенных к домену, мы используем защищенный NTP [-сервер](https://msdn.microsoft.com/library/cc246877.aspx), именуемый, который использует согласованные секреты домена, которые обеспечивают преимущество управления по сравнению с проверкой подлинности NTP, описанной в RFC1305 и RFC5905.   

Для протоколов домена и не присоединенных к домену требуется UDP-порт 123.  Дополнительные сведения о рекомендациях по использованию NTP см. в статье [наиболее актуальный черновик IETF по протоколу сетевого времени](https://tools.ietf.org/html/draft-ietf-ntp-bcp-00).

### <a name="reliable-hardware-clock-rtc"></a>Надежные часы оборудования (RTC)
Windows не выполняет шаг времени, если не превышены определенные границы, а задисциплинают часы.  Это означает, что подсистема w32tm настраивает частоту часов с постоянным интервалом, используя параметр частоты обновления часов, который по умолчанию устанавливается один раз в секунду с Windows Server 2016.  Если время отстает от времени, частота снижается, и, если она выполняется заранее, она замедляется.  Однако в это время между настройкой частоты таймера аппаратные часы контролируются.  При наличии проблем с встроенным по или аппаратными часами время на компьютере может стать менее точным.

Это еще одна причина, по которой необходимо протестировать и базовые показатели в вашей среде.  Если значение счетчика производительности "смещение в расчете времени" не стабилизация в отношении целевой платформы, вам может потребоваться проверить актуальность встроенного по.  В качестве другого теста можно увидеть, повторяется ли дублирование оборудования.

### <a name="troubleshooting-time-accuracy-and-ntp"></a>Устранение неполадок с точностью и NTP
Чтобы понять источник неточного времени, можно воспользоваться приведенным выше разделом иерархии.  Просматривая смещение времени, найдите точку в иерархии, где время отличается от ее исходного NTP-источника.  Поняв иерархию, вы захотите понять, почему конкретный источник времени не получает точное время.  

Если сосредоточиться на системе с другим временем, вы можете использовать приведенные ниже средства для сбора дополнительных сведений, помогающих определить и найти решение проблемы.  Приведенная ниже ссылка на Упстреамклокксаурце представляет собой часы, обнаруженные с помощью команды "w32tm/config/Status".


- Журналы системных событий
- Включение ведения журнала с помощью: w32tm Logs-w32tm/Debug/Enable/file: C:\Windows\Temp\w32time-test.log/сизе: 10000000/ентриес: 0-300
- раздел реестра w32Time HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\W32Time
- Трассировки локальной сети
- Счетчики производительности (с локального компьютера или Упстреамклокксаурце)
- W32tm/стрипчарт/компутер: Упстреамклокксаурце
- Проверка связи Упстреамклокксаурце для понимания задержки и числа прыжков до источника
- Упстреамклокксаурце tracert

Проблема|    Симптомы|   Разрешение|
----- | ----- | ----- |
Локальные часы TSC не стабильны.| С помощью PerfMon-Physical Computer — синхронизация синхронизирующих импульсов синхронизации часов, но вы по-прежнему видите, что каждые 1-2 минут из нескольких 100US. |   Обновление встроенного по или проверка другого оборудования не отображает ту же самую ошибку.|
Задержка в сети|    W32tm стрипчарт отображает Раундтрипделай более 10 мс.  Вариация в задержке приводит к тому, что шум будет равен 1/2 времени кругового пути, например задержка, которая находится только в одном направлении.</br></br>Упстреамклокксаурце — это несколько прыжков, как указано командой PING.  Срок жизни должен быть близко к 128.</br></br>Используйте tracert для поиска задержки на каждом прыжке.    | Найдите более близкий источник часов для времени.  Одно из решений — установить исходные часы в том же сегменте или вручную указать на исходные часы, географически расположенные ближе друг к другу.  Для сценария домена добавьте компьютер с ролью Гтимесерв. |  
Не удается надежно связаться с источником NTP|    W32tm/стрипчарт периодически возвращает значение "истекло время ожидания запроса"    |NTP-источник не отвечает|
NTP-источник не отвечает|    Проверьте счетчики системного монитора для счетчика "число источников NTP-клиентов", входящих запросов NTP-сервера, исходящих ответов NTP-сервера и определите использование по сравнению с базовыми планами.|    С помощью счетчиков производительности сервера определите, изменилась ли нагрузка в справочнике по базовым показателям.</br></br>Существуют ли проблемы перегрузки сети?|
Контроллер домена не использует наиболее точные часы|    Изменения в топологии или недавно добавленные часы основного времени.|   w32tm/resync/редисковер|
В клиентских часах выполняется смещение| Время — событие 36 в журнале системных событий и (или) текст в файле журнала с описанием: Значение счетчика "число источников времени NTP-клиента" от 1 до 0|Устраните неполадки в вышестоящем источнике и выясните, не возникли ли проблемы с производительностью.|

### <a name="baselining-time"></a>Время задания базовых показателей
Задания базовых показателей важно, чтобы вы могли сначала оценить производительность и точность сети, а также сравнить с базовыми показателями в будущем при возникновении проблем.  Вам потребуется базовое значение корневого основного контроллера домена или всех компьютеров, помеченных с помощью ГТИМЕСРВ.  Мы также рекомендуем использовать базовый контроллер домена в каждом лесу.  Наконец, выберите критически важные контроллеры домена или компьютеры, имеющие интересные характеристики, такие как расстояние или большие нагрузки и базовые показатели.

Это также полезно для базовых показателей Windows Server 2016 и 2012 R2, однако в качестве средства для сравнения можно использовать только w32tm/стрипчарт, так как в Windows Server 2012 R2 нет счетчиков производительности.  Следует выбрать два компьютера с одинаковыми характеристиками или обновить компьютер и сравнить результаты после обновления.  В дополнение к измерениям времени Windows есть дополнительные сведения о том, как выполнять подробные измерения между 2016 и 2012.

Используя счетчики производительности W32Time, собирайте данные по крайней мере за неделю.  Это обеспечит наличие достаточной ссылки на учетную запись в сети с течением времени и достаточное количество запусков для обеспечения уверенности в стабильной точности времени.

### <a name="ntp-server-redundancy"></a>Избыточность NTP-сервера
Для ручной настройки NTP-сервера, используемой с компьютерами, не присоединенными к домену, или с основным контроллером домена, в случае доступности более одного сервера является хорошей мерой избыточности.  Это также может обеспечить лучшую точность, предполагая, что все источники являются точными и стабильными.  Однако если топология не спроектирована надлежащим образом или источники времени не являются стабильными, полученная точность может быть хуже, поэтому рекомендуется соблюдать осторожность.  Максимальное количество поддерживаемых серверов времени, на которое служба w32time может вручную ссылаться, — 10. 

## <a name="leap-seconds"></a>LEAP секунд
Период вращения Земли изменяется со временем, вызванным событиями климатик и геологической. Как правило, вариант имеет значение около секунды каждые несколько лет. Каждый раз, когда вариации из атомарного времени увеличиваются слишком велики, происходит исправление одной секунды (вверх или вниз), которое называется високосной секундой. Это делается таким образом, что разница никогда не превысит 0,9 секунд. Это исправление объявляется за шесть месяцев до фактического исправления. До выхода Windows Server 2016 служба времени Майкрософт не была осведомлена о високосных секундах, но позаботится об этом с помощью внешней службы времени. С увеличением точности времени Windows Server 2016 Корпорация Майкрософт работает над более подходящим решением для решения проблемы с LEAP.

## <a name="secure-time-seeding"></a>Безопасное заполнение времени
Служба W32Time в сервере 2016 включает функцию заполнения безопасного времени. Эта функция определяет приблизительное текущее время от исходящих SSL-подключений.  Это значение времени используется для отслеживания часов локальной системы и исправления ошибок брутто. Дополнительные сведения о функции см. в [этой записи блога](https://blogs.msdn.microsoft.com/w32time/2016/09/28/secure-time-seeding-improving-time-keeping-in-windows/).  В развертываниях с надежными источниками времени и наблюдаемыми машинами, которые включают мониторинг смещения времени, вы можете не использовать функцию заполнения безопасного времени и вместо этого полагаться на существующую инфраструктуру. 

Вы можете отключить эту функцию, выполнив следующие действия.

1.  Присвойте параметру реестра Утилизесслтимедата значение 0 на определенном компьютере:

    REG Add HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\w32time\Config/v Утилизесслтимедата/t REG_DWORD/d 0/f


2.  Если вы не можете перезагрузить компьютер немедленно по какой-либо причине, вы можете уведомить службу W32Time об обновлении конфигурации. Это останавливает мониторинг и принудительное применение на основе данных времени, собранных из SSL-соединений. 

    W32tm. exe/config/Update

3.  При перезагрузке компьютера параметр вступает в силу немедленно, а также приводит к остановке сбора любых данных времени с SSL-соединений.  Последняя часть имеет очень небольшие издержки и не должна быть проблемой производительности.

4.  Чтобы применить этот параметр ко всему домену, задайте значение Утилизесслтимедата в параметре групповой политики W32Time равным 0 и опубликуйте параметр.  Если параметр выбирается клиентом групповая политика, Служба W32Time получает уведомления, и она прекращает мониторинг и принудительное применение с помощью данных времени SSL. Сбор данных времени SSL будет прерван при каждой перезагрузке компьютера. Если в домене есть портативные компакт-и Планшетные ПК и другие устройства, может потребоваться исключить такие компьютеры из этого изменения политики. В конечном итоге эти устройства заряжается от аккумулятора и для начальной загрузки требуется функция заполнения безопасного времени.


