---
ms.assetid: d1953097-63ea-4a0e-b860-2f3b7c175c41
title: Принцип работы службы времени Windows
description: ''
author: shortpatti
ms.author: pashort
manager: dougkim
ms.date: 05/08/2018
ms.topic: article
ms.prod: windows-server
ms.technology: networking
ms.openlocfilehash: 2bf4a887218cd51e9c10954a75bbc1ba2112647f
ms.sourcegitcommit: 6aff3d88ff22ea141a6ea6572a5ad8dd6321f199
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/27/2019
ms.locfileid: "71405147"
---
# <a name="how-the-windows-time-service-works"></a>Принцип работы службы времени Windows

>Относится к: Windows Server 2016, Windows Server 2012 R2, Windows Server 2012, Windows 10 или более поздней версии

**В этом разделе**  
  
-   [Архитектура службы времени Windows](#windows-time-service-architecture)  
  
-   [Протоколы Время использования службы времени Windows](#windows-time-service-time-protocols)  
  
-   [Процессы и взаимодействия службы времени Windows](#windows-time-service-processes-and-interactions)  
  
-   [Сетевые порты, используемые службой времени Windows](#network-ports-used-by-windows-time-service)  
  
> [!NOTE]  
> В этом разделе объясняется, как работает служба времени Windows (W32Time). Сведения о настройке службы времени Windows см. в разделе [Настройка высокой точности систем](configuring-systems-for-high-accuracy.md).
  
> [!NOTE]  
> В Windows Server 2003 и Microsoft Windows 2000 Server служба каталогов называется Active Directory Directory Service. В Windows Server 2008 и более поздних версиях служба каталогов называется домен Active Directory Services (AD DS). Остальная часть этой статьи относится к AD DS, но эти сведения применимы также и к Active Directory.  
  
Хотя служба времени Windows не является точной реализацией протокола сетевого времени (NTP), она использует комплексный набор алгоритмов, определенных в спецификациях NTP, чтобы гарантировать максимально точную точность часов на компьютерах в сети. В идеале все компьютерные часы в домене AD DS синхронизируются со временем полномочного компьютера. Многие факторы могут повлиять на синхронизацию времени в сети. На точность синхронизации в AD DS часто влияют следующие факторы:  
  
-   Условия сети  
  
-   Точность аппаратных часов компьютера  
  
-   Объем ресурсов ЦП и сети, доступных службе времени Windows  
  
> [!IMPORTANT]  
> До Windows Server 2016 Служба W32Time не была разработана для удовлетворения потребностей приложений, зависящих от времени.  Однако теперь обновления Windows Server 2016 позволяют реализовать решение для точности 1 мс в домене.  Дополнительные сведения см. в разделе [точное время и поддержка windows 2016](accurate-time.md) для [настройки службы времени Windows для сред с высокой точностью](support-boundary.md) .  
  
Компьютеры, которые синхронизируют время, реже или не присоединенные к домену, по умолчанию настроены для синхронизации с time.windows.com.  Поэтому невозможно гарантировать точность времени на компьютерах с непостоянными или отсутствием сетевых подключений.  
  
Лес AD DS имеет предварительно определенную иерархию синхронизации времени. Служба времени Windows синхронизирует время между компьютерами в иерархии с наиболее точными эталонными часами вверху. Если на компьютере настроено более одного источника времени, Windows использует алгоритмы NTP для выбора лучшего источника времени из настроенных источников в зависимости от способности компьютера синхронизироваться с этим источником времени. Служба времени Windows не поддерживает сетевую синхронизацию для широковещательных или одноадресных узлов. Дополнительные сведения об этих функциях NTP см. в документе RFC 1305 в базе данных RFC IETF.  
  
Каждый компьютер, на котором работает служба времени Windows, использует службу для поддержания наиболее точного времени. Компьютеры, являющиеся членами домена, работают как клиент времени по умолчанию, поэтому в большинстве случаев настраивать службу времени Windows не требуется. Однако служба времени Windows может быть настроена на запрос времени от назначенного источника времени, а также может предоставить клиентам время.
  
Степень, в которой точное время компьютера, называется Стратум. Наиболее точный источник времени в сети (например, аппаратные часы) занимает самый низкий уровень Стратум или Стратум один. Этот точный источник времени называется ссылочным временем. NTP-сервер, который получает свое время непосредственно из эталонного времени, занимает Стратум, который находится на одном уровне выше, чем значение ссылочного времени. Ресурсы, получившие время с NTP-сервера, являются двумя шагами, и поэтому они занимают Стратум, который больше, чем самый точный источник времени, и т. д. По мере увеличения числа Стратум компьютера время на его системных часах может стать менее точным. Таким образом, уровень Стратум любого компьютера является признаком того, насколько близко, что компьютер синхронизирован с наиболее точным источником времени.  
  
Когда диспетчер W32Time получает образцы времени, он использует специальные алгоритмы NTP, чтобы определить, какой из выборок времени наиболее подходит для использования. Служба времени также использует другой набор алгоритмов, чтобы определить, какой из настроенных источников времени является наиболее точным. Когда служба времени определила, какой вариант времени лучше, основываясь на приведенных выше условиях, он корректирует скорость местного часов, чтобы она позволяла выполнить согласование в нужное время. Если разница во времени между локальными часами и выбранным образцом точного времени (также называемой разницей во времени) слишком велика для исправления с изменением скорости локальной тактовой частоты, служба времени устанавливает для локальных часов нужное время. Это корректировка частоты часов или прямого часового пояса называется "дисциплина времени".  
  
## <a name="windows-time-service-architecture"></a>Архитектура службы времени Windows  
Служба времени Windows состоит из следующих компонентов:  
  
-   Диспетчер управления службами  
  
-   Service Manager времени Windows  
  
-   Дисциплина времени  
  
-   Поставщики времени  
  
На следующем рисунке показана архитектура службы времени Windows.  
  
**Архитектура службы времени Windows**  
  
![Служба времени Windows](../media/Windows-Time-Service/How-the-Windows-Time-Service-Works/trnt_sec_arcc.gif)
  
Диспетчер управления службами отвечает за запуск и остановку службы времени Windows. Service Manager времени Windows отвечает за запуск действий поставщиков времени NTP, включенных в операционную систему. Service Manager времени Windows управляет всеми функциями службы времени Windows и объединением всех примеров времени. Помимо предоставления сведений о текущем состоянии системы, таких как текущий источник времени или время последнего обновления системных часов, Service Manager времени Windows также отвечает за создание событий в журнале событий.  
  
Процесс синхронизации времени состоит из следующих этапов.  
  
-   Поставщики входных данных запрашивают и получают образцы времени из настроенных источников времени NTP.  
  
-   Эти примеры затем передаются в Service Manager времени Windows, который собирает все образцы и передает их подкомпоненту "дисциплина времени".  
  
-   Подкомпонент "дисциплина по часам" применяет алгоритмы NTP, которые приводят к выбору лучшего образца времени.  
  
-   Подкомпонент "дисциплина по часам" корректирует время системных часов до наиболее точного времени, изменяя частоту часов или напрямую изменяя время.  
  
Если компьютер назначен как сервер времени, он может отправить время на любой компьютер, запрашивающий синхронизацию времени, в любой момент в этом процессе.  
  
## <a name="windows-time-service-time-protocols"></a>Протоколы Время использования службы времени Windows  

Протоколы времени определяют, как тесно синхронизируются часы двух компьютеров. Протокол времени отвечает за определение наилучшей доступной информации о времени и согласование часов, чтобы гарантировать, что в отдельных системах будет поддерживаться единообразное время.  
  
Служба времени Windows использует протокол NTP для синхронизации времени по сети. NTP — это протокол времени в Интернете, включающий алгоритмы дисциплины, необходимые для синхронизации часов. NTP — это более точный протокол, отличный от протокола SNTP, который используется в некоторых версиях Windows; Однако Служба W32Time продолжит поддерживать протокол SNTP, чтобы обеспечить обратную совместимость с компьютерами, на которых работают службы времени на базе SNTP, например Windows 2000.  
  
### <a name="network-time-protocol"></a>Протокол сетевого времени  
Протокол NTP — это протокол синхронизации времени по умолчанию, используемый службой времени Windows в операционной системе. NTP — это отказоустойчивый и высокомасштабируемый протокол времени, который чаще всего используется для синхронизации компьютерных часов с помощью указанной ссылки времени.  
  
Синхронизация времени NTP выполняется в течение определенного периода времени и включает передачу NTP-пакетов по сети. NTP-пакеты содержат метки времени, которые включают образец времени из клиента и сервера, участвующего в синхронизации времени.  
  
NTP использует контрольный таймер, чтобы определить наиболее точное время для использования и синхронизировать все часы в сети с этим эталонным временем. NTP использует всеобщее скоординированное время (UTC) в качестве универсального стандарта для текущего времени. Время в формате UTC не зависит от часовых поясов и позволяет использовать NTP в любом месте мира независимо от параметров часового пояса.  
  
#### <a name="ntp-algorithms"></a>Алгоритмы NTP  
NTP включает два алгоритма: алгоритм фильтрации по часам и алгоритм выбора часов, чтобы помочь службе времени Windows определить наилучший образец времени. Алгоритм фильтрации по часам разработан так, чтобы необходимости просеивания с помощью выборок времени, полученных от запрошенных источников времени, и определения лучших образцов времени из каждого источника. Затем алгоритм выбора часов определяет наиболее точный сервер времени в сети. Эта информация затем передается алгоритму дисциплины времени, который использует информацию, собранную для исправления локальных часов компьютера, а также компенсируя ошибки в связи с задержкой сети и неточностью компьютерных часов.  
  
Алгоритмы NTP наиболее точны в условиях низкой и умеренной нагрузки сети и сервера. Как и в случае с любым алгоритмом, в котором учитывается время транзитного сетевого пути, алгоритмы NTP могут плохо работать в условиях экстремальной перегрузки сети. Дополнительные сведения о алгоритмах NTP см. в документе RFC 1305 в базе данных RFC IETF.  
  
#### <a name="ntp-time-provider"></a>Поставщик времени NTP  
Служба времени Windows — это полный пакет синхронизации времени, который может поддерживать различные аппаратные устройства и протоколы времени. Чтобы включить эту поддержку, служба использует подключаемые поставщики времени. Поставщик времени отвечает за получение точных меток времени (от сети или оборудования) или предоставление этих меток времени другим компьютерам по сети.  
  
Поставщик NTP является стандартным поставщиком времени, включенным в операционную систему. Поставщик NTP соответствует стандартам, указанным в версии NTP 3 для клиента и сервера, и может взаимодействовать с клиентами и серверами SNTP для обеспечения обратной совместимости с Windows 2000 и другими клиентами SNTP. Поставщик NTP в службе времени Windows состоит из следующих двух частей:  
  
-   **Поставщик выходных данных NTP.** Это сервер времени, отвечающий на запросы времени клиента в сети.  
  
-   **Поставщик ввода NTP-поставщика.** Это клиент времени, который получает сведения о времени из другого источника, устройства или NTP-сервера и может возвращать образцы времени, которые полезны для синхронизации локальных часов.  
  
Хотя фактические операции этих двух поставщиков тесно связаны, они отображаются независимо от службы времени. Начиная с Windows 2000 Server, когда компьютер Windows подключен к сети, он настраивается как NTP-клиент. Кроме того, компьютеры, на которых запущена служба времени Windows, пытаются синхронизировать время с контроллером домена или вручную по умолчанию. Это предпочтительные поставщики времени, так как они автоматически доступны и защищают источники времени.  
  
#### <a name="ntp-security"></a>Безопасность NTP  

В лесу AD DS служба времени Windows использует стандартные функции безопасности домена для обеспечения проверки подлинности временных данных. Безопасность пакетов NTP, которые передаются между компьютером, членом домена, и локальным контроллером домена, который выступает в качестве сервера времени, основан на проверке подлинности с использованием общего ключа. Служба времени Windows использует ключ сеанса Kerberos компьютера для создания подписей с проверкой подлинности на NTP-пакетах, отправляемых по сети. Пакеты NTP не передаются в безопасном канале сетевого входа. Вместо этого, когда компьютер запрашивает время с контроллера домена в иерархии доменов, служба времени Windows требует, чтобы время прошло проверку подлинности. Затем контроллер домена возвращает необходимые сведения в формате 64-разрядного значения, которое прошло проверку подлинности с помощью ключа сеанса из службы сетевого входа в систему. Если возвращенный NTP-пакет не подписан с помощью ключа сеанса компьютера или неправильно подписан, то время отклоняется. Все такие ошибки проверки подлинности регистрируются в журнале событий. Таким образом служба времени Windows обеспечивает безопасность данных NTP в AD DSном лесу.  
  
Как правило, клиенты времени Windows автоматически получают точное время для синхронизации из контроллеров домена в том же домене. В лесу контроллеры домена дочернего домена синхронизируют время с контроллерами домена в их родительских доменах. Когда сервер времени возвращает NTP-пакет, прошедший проверку подлинности, на клиент, который запрашивает время, пакет подписывается с помощью ключа сеанса Kerberos, определенного учетной записью междоменного доверия. Учетная запись междоменного доверия создается, когда новый домен AD DS присоединяется к лесу, а служба сетевого входа в систему управляет ключом сеанса. Таким образом, контроллер домена, настроенный как надежный в корневом домене леса, становится источником времени, прошедшего проверку подлинности, для всех контроллеров домена в родительском и дочернем доменах и косвенно для всех компьютеров, расположенных в дереве доменов.  
  
Службу времени Windows можно настроить для работы между лесами, но важно отметить, что эта конфигурация не защищена. Например, NTP-сервер может быть доступен в другом лесу. Однако, поскольку этот компьютер находится в другом лесу, ключ сеанса Kerberos для подписывания и проверки подлинности NTP-пакетов отсутствует. Чтобы обеспечить точную синхронизацию времени с компьютера в другом лесу, клиенту требуется сетевой доступ к этому компьютеру, а служба времени должна быть настроена на использование определенного источника времени, расположенного в другом лесу. Если клиент вручную настроен на доступ к времени с NTP-сервера за пределами собственной доменной иерархии, то NTP-пакеты, передаваемые между клиентом и сервером времени, не проходят проверку подлинности и, следовательно, не являются безопасными. Несмотря на реализацию доверия лесов, служба времени Windows не защищена между лесами. Хотя безопасный канал сетевого входа в систему является механизмом проверки подлинности для службы времени Windows, проверка подлинности в лесах не поддерживается.  
  
#### <a name="hardware-devices-that-are-supported-by-the-windows-time-service"></a>Аппаратные устройства, поддерживаемые службой времени Windows  
Часы на основе оборудования, такие как GPS или радиочастоту, часто используются в качестве устройств с высокоточными эталонными часами. По умолчанию поставщик времени NTP службы времени Windows не поддерживает прямое подключение аппаратного устройства к компьютеру, хотя можно создать программный поставщик независимого времени, поддерживающий этот тип подключения. Этот тип поставщика в сочетании со службой времени Windows может обеспечить надежную и устойчивую ссылку времени.  
  
Устройства, например цесиум часов или ресивер глобальной системы позиционирования (GPS), предоставляют точное текущее время, следуя стандарту, чтобы получить точное определение времени. Цесиум часы чрезвычайно стабильны и не затрагиваются такими факторами, как температура, давление или влажность, но они также очень дороги. Приемник GPS гораздо менее затратен на работу, и он также является точным ссылочным временем. Приемники GPS получают время от вспомогательных ресурсов, которые получают время с цесиум часов. Если не использовать независимый поставщик времени, серверы времени Windows могут получить свое время, подключившись к внешнему NTP-серверу, который подключается к аппаратному устройству с помощью телефона или Интернета. Такие организации, как США Навал Обсерватори, предоставляют NTP-серверы, подключенные к чрезвычайно надежным эталонным часам.  
  
Многие приемники GPS и другие временные устройства могут работать в сети в качестве NTP-серверов. Можно настроить лес AD DS для синхронизации времени с этих внешних устройств, только если они также работают в сети как NTP-серверы. Для этого настройте контроллер домена в качестве эмулятора основного контроллера домена в корне леса, чтобы выполнить синхронизацию с NTP-сервером, предоставленным устройством GPS. Дополнительные сведения см. в разделе [Настройка службы времени Windows в эмуляторе основного контроллера домена в корневом домене леса](https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/cc731191%28v=ws.10%29).  
  
### <a name="simple-network-time-protocol"></a>Простой сетевой протокол времени  
Протокол SNTP — это упрощенный протокол, предназначенный для серверов и клиентов, которым не требуется степень точности, предоставляемая NTP. SNTP — это более элементарная версия NTP — основной протокол времени, используемый в Windows 2000. Так как форматы сетевых пакетов SNTP и NTP идентичны, эти два протокола являются взаимодействующими. Основное различие между ними заключается в том, что SNTP не поддерживает системы управления ошибками и сложные фильтры, предоставляемые NTP. Дополнительные сведения о протоколе простого сетевого времени см. в документе RFC 1769 в базе данных IETF RFC.  
  
### <a name="time-protocol-interoperability"></a>Взаимодействие протокола времени  
Служба времени Windows может работать в смешанной среде компьютеров под управлением Windows 2000, Windows XP и Windows Server 2003, поскольку протокол SNTP, используемый в Windows 2000, совместим с протоколом NTP в Windows XP и Windows Server 2003.  
  
Служба времени в Windows NT Server 4,0, именуемая Тимесерв, синхронизирует время в сети Windows NT 4,0. Тимесерв — это надстройка, доступная в составе *Microsoft Windows NT 4,0 Resource Kit* , которая не обеспечивает степень надежности синхронизации времени, необходимой для Windows Server 2003.  
  
Служба времени Windows может взаимодействовать с компьютерами под управлением Windows NT 4,0, так как они могут синхронизировать время с компьютерами под управлением Windows 2000 или Windows Server 2003. Однако компьютер под управлением Windows 2000 или Windows Server 2003 не обнаруживает серверы времени Windows NT 4,0 автоматически. Например, если в домене настроена синхронизация времени с помощью метода синхронизации на основе иерархии домена и требуется, чтобы компьютеры в иерархии доменов синхронизировались время с контроллером домена Windows NT 4,0, необходимо настроить эти компьютеры вручную для синхронизации с контроллерами домена Windows NT 4,0.  
  
В Windows NT 4,0 используется более простой механизм синхронизации времени, чем используется службой времени Windows. Таким образом, чтобы обеспечить точную синхронизацию времени по сети, рекомендуется обновить все контроллеры домена Windows NT 4,0 до Windows 2000 или Windows Server 2003.  
  
## <a name="windows-time-service-processes-and-interactions"></a>Процессы и взаимодействия службы времени Windows  

Служба времени Windows предназначена для синхронизации часов компьютеров в сети. Процесс синхронизации сетевого времени, называемый также согласованностью времени, происходит по сети, так как каждый компьютер получает доступ к времени с более точного сервера времени. Конвергенция времени подразумевает процесс, с помощью которого полномочный сервер предоставляет текущее время на клиентские компьютеры в виде пакетов NTP. Сведения, содержащиеся в пакете, указывают, необходимо ли выполнить корректировку на текущее время на компьютере, чтобы оно было синхронизировано с более точным сервером.  
  
В рамках процесса конвергенции времени члены домена пытаются синхронизировать время с любым контроллером домена, расположенным в том же домене. Если компьютер является контроллером домена, он пытается выполнить синхронизацию с более полномочным контроллером домена.  
  
Компьютеры под управлением Windows XP Home Edition или компьютеров, которые не присоединены к домену, не пытаются синхронизироваться с доменной иерархией, но по умолчанию настроены на получение времени от time.windows.com.  
  
Чтобы установить компьютер под Windows Server 2003 в качестве полномочного, компьютер должен быть настроен в качестве надежного источника времени. По умолчанию первый контроллер домена, установленный в домене Windows Server 2003, автоматически настраивается в качестве надежного источника времени. Так как это Полномочный компьютер для домена, он должен быть настроен для синхронизации с внешним источником времени, а не с иерархией домена. Кроме того, по умолчанию все остальные члены домена Windows Server 2003 настроены для синхронизации с иерархией домена.  
  
После установки сети Windows Server 2003 можно настроить службу времени Windows на использование одного из следующих параметров синхронизации.  
  
-   Синхронизация на основе иерархии домена  
  
-   Источник синхронизации, указанный вручную  
  
-   Все доступные механизмы синхронизации  
  
-   Без синхронизации.  
  
Каждый из этих типов синхронизации обсуждается в следующем разделе.  
  
### <a name="domain-hierarchy-based-synchronization"></a>Синхронизация на основе иерархии домена  

При синхронизации, основанной на иерархии доменов, иерархия домена AD DS используется для поиска надежного источника, с которым синхронизируется время. На основе иерархии доменов Служба времени Windows определяет точность каждого сервера времени. В лесу Windows Server 2003 компьютер, на котором находится роль хозяина операций эмулятора основного контроллера домена (PDC), расположенный в корневом домене леса, содержит расположение лучшего источника времени, если не настроен другой надежный источник времени. На следующем рисунке показан путь синхронизации времени между компьютерами в иерархии доменов.  
  
**Синхронизация времени в иерархии AD DS**  
@no__t 0Windows время @ no__t-1
  
#### <a name="reliable-time-source-configuration"></a>Конфигурация надежного источника времени  
Компьютер, настроенный как надежный источник времени, определяется как корень службы времени. Корневой сервер службы времени является полномочным сервером для домена и, как правило, настраивается на получение времени с внешнего NTP-сервера или аппаратного устройства. Сервер времени можно настроить в качестве надежного источника времени, чтобы оптимизировать время передачи в иерархии доменов. Если контроллер домена настроен для работы в надежном источнике времени, служба сетевого входа сообщает, что контроллер домена является надежным источником времени при входе в сеть. Когда другие контроллеры домена ищут источник времени для синхронизации, он сначала выбирает надежный источник, если он доступен.  
  
#### <a name="time-source-selection"></a>Выбор источника времени  
Процесс выбора источника времени может создать две проблемы в сети:  
  
-   Дополнительные циклы синхронизации.  
  
-   Увеличенный объем сетевого трафика.  
  
Цикл в сети синхронизации происходит, когда время остается согласованным между группой контроллеров домена, и одно и то же время совместно используется постоянно без повторной синхронизации с другим надежным источником времени. Алгоритм выбора источника времени службы времени Windows предназначен для защиты от проблем такого типа.  
  
Компьютер использует один из следующих методов для задания источника времени для синхронизации.  
  
-   Если компьютер не является членом домена, его необходимо настроить для синхронизации с указанным источником времени.  
  
-   Если компьютер является рядовым сервером или рабочей станцией в домене, по умолчанию он соответствует иерархии AD DS и синхронизирует время с контроллером домена в своем локальном домене, на котором в данный момент запущена служба времени Windows.  
  
Если компьютер является контроллером домена, то он занимает до шести запросов на поиск другого контроллера домена для синхронизации с. Каждый запрос предназначен для определения источника времени с определенными атрибутами, такими как тип контроллера домена, определенное расположение и независимо от того, является ли он надежным источником времени. Источник времени также должен соответствовать следующим ограничениям:  
  
-   Надежный источник времени можно синхронизировать только с контроллером домена в родительском домене.  
  
-   Эмулятор основного контроллера домена может синхронизироваться с надежным источником времени в собственном домене или на любом контроллере в родительском домене.  
  
Если контроллер домена не поддерживает синхронизацию с типом запрашиваемого контроллера домена, запрос не выполняется. Контроллер домена знает, какой тип компьютера может получить время до того, как он сделает запрос. Например, локальный эмулятор основного контроллера домена не пытается запросить три или шесть номера, так как контроллер домена не пытается выполнить синхронизацию с самим собой.  
  
В следующей таблице перечислены запросы, которые контроллер домена выполняет для поиска источника времени и порядок, в котором выполняются запросы.  
  
**Запросы к источнику времени контроллера домена**  
  
|Номер запроса|Контроллер домена|Location|Надежность источника времени|  
|----------------|---------------------|------------|------------------------------|  
|1|Родительский контроллер домена|На месте|Предпочитает надежный источник времени, но он может синхронизироваться с ненадежным источником времени, если он доступен.|  
|2|Локальный контроллер домена|На месте|Синхронизирует только с надежным источником времени.|  
|3|Эмулятор локального основного контроллера домена|На месте|Не применяется.<br /><br />Контроллер домена не пытается выполнить синхронизацию с самим собой.|  
|4|Родительский контроллер домена|Вне сайта|Предпочитает надежный источник времени, но он может синхронизироваться с ненадежным источником времени, если он доступен.|  
|5|Локальный контроллер домена|Вне сайта|Синхронизирует только с надежным источником времени.|  
|6|Эмулятор локального основного контроллера домена|Вне сайта|Не применяется.<br /><br />Контроллер домена не пытается выполнить синхронизацию с самим собой.| 
  
**Примечание**  
  
-   Компьютер никогда не синхронизируется с самим собой. Если компьютер пытается синхронизироваться с локальным эмулятором основного контроллера домена, он не пытается выполнить запросы 3 или 6.  
  
Каждый запрос возвращает список контроллеров домена, которые можно использовать в качестве источника времени. Время Windows назначает каждому контроллеру домена, который запрашивает оценку, исходя из надежности и расположения контроллера домена. В следующей таблице перечислены показатели, назначенные времени Windows каждому типу контроллера домена.  
  
**Определение оценки**  
  
|Состояние контроллера домена|Оценка|  
|----------------------------|---------|  
|Контроллер домена, расположенный на одном сайте|8|  
|Контроллер домена, помеченный как источник надежного времени|4|  
|Контроллер домена, расположенный в родительском домене|2|  
|Контроллер домена, являющийся эмулятором PDC|1|  
  
Когда служба времени Windows определяет, что контроллер домена определил наиболее подходящую оценку, дополнительные запросы не выполняются. Показатели, назначенные службой времени, являются кумулятивными. Это означает, что эмулятор основного контроллера домена, расположенный на том же сайте, получает показатель девяти.  
  
Если в корне службы времени не настроена синхронизация с внешним источником, то время определяется внутренним аппаратным временем компьютера.  
  
### <a name="manually-specified-synchronization"></a>Синхронизация вручную  
Вручную указанная синхронизация позволяет назначить один одноранговый узел или список узлов, с которых компьютер получает время. Если компьютер не является членом домена, его необходимо настроить вручную для синхронизации с указанным источником времени. Компьютер, который является членом домена, по умолчанию настроен для синхронизации из иерархии доменов. Синхронизация, указанная вручную, наиболее полезна для корня леса домена или для компьютеров, которые не присоединены к домену. Определение вручную внешнего NTP-сервера для синхронизации с полномочным компьютером для вашего домена обеспечивает надежное время. Однако настройка полномочного компьютера для домена на синхронизацию с аппаратными часами на самом деле является лучшим решением для обеспечения наиболее точного и безопасного времени в домене.  
  
Указанные вручную источники времени не проходят проверку подлинности, если для них не задан конкретный поставщик времени, и поэтому они уязвимы для злоумышленников. Кроме того, если компьютер выполняет синхронизацию с источником, заданным вручную, а не с помощью контроллера домена, выполняющего проверку подлинности, эти два компьютера могут оказаться несинхронизированными, что приведет к сбою проверки подлинности Kerberos. Это может привести к сбою других действий, для которых требуется проверка подлинности сети, например печать или совместное использование файлов. Если для синхронизации с внешним источником настроен только корень леса, все остальные компьютеры в лесу будут синхронизированы друг с другом, что затрудняет атаки на воспроизведение.  
  
### <a name="all-available-synchronization-mechanisms"></a>Все доступные механизмы синхронизации  

Параметр "все доступные механизмы синхронизации" является наиболее ценным методом синхронизации для пользователей в сети. Этот метод позволяет синхронизироваться с иерархией доменов и может также предоставлять альтернативный источник времени, если иерархия домена становится недоступной в зависимости от конфигурации. Если клиенту не удается синхронизировать время с иерархией домена, источник времени автоматически возвращается к источнику времени, указанному параметром **NTP** . Этот метод синхронизации, скорее всего, обеспечивает точное время для клиентов.  

### <a name="stopping-time-synchronization"></a>Остановка синхронизации времени  
Существуют ситуации, в которых необходимо запретить синхронизацию времени на компьютере. Например, если компьютер пытается выполнить синхронизацию из источника времени в Интернете или с другого сайта через глобальную сеть с помощью коммутируемого подключения, это может повлечь за собой дорогостоящую оплату по телефону. При отключении синхронизации на этом компьютере компьютер не сможет получить доступ к источнику времени через коммутируемое подключение.  
  
Можно также отключить синхронизацию, чтобы предотвратить создание ошибок в журнале событий. Каждый раз, когда компьютер пытается выполнить синхронизацию с недоступным источником времени, он создает ошибку в журнале событий. Если источник времени отключается от сети для запланированного обслуживания и вы не собираетесь перенастраивать клиент для синхронизации из другого источника, можно отключить синхронизацию на клиенте, чтобы предотвратить попытки синхронизации на сервере времени. недоступен.  
  
Рекомендуется отключить синхронизацию на компьютере, который указан в качестве корня сети синхронизации. Это означает, что корневой компьютер доверяет своим локальным часам. Если в корне иерархии синхронизации не установлено значение **nosync** и не удается выполнить синхронизацию с другим источником времени, клиенты не принимают пакеты, отправляемые этим компьютером, так как его время не может быть доверенным.
  
Только серверы, которые являются доверенными для клиентов, даже если они не синхронизированы с другим источником времени, являются теми, которые были идентифицированы клиентом как надежные серверы времени.  
  
### <a name="disabling-the-windows-time-service"></a>Отключение службы времени Windows  
Служба времени Windows (W32Time) может быть полностью отключена. Если вы решили реализовать сторонний продукт синхронизации времени, использующий NTP, необходимо отключить службу времени Windows. Это связано с тем, что всем NTP-серверам требуется доступ к порту UDP 123, если служба времени Windows работает в операционной системе Windows Server 2003, порт 123 остается зарезервированным по времени Windows.  
  
## <a name="network-ports-used-by-windows-time-service"></a>Сетевые порты, используемые службой времени Windows  
Служба времени Windows взаимодействует в сети для определения надежных источников времени, получения сведений о времени и предоставления сведений о времени другим компьютерам. Этот обмен данными выполняется в соответствии с определением RFC и SNTP.  
  
**Назначения портов для службы времени Windows**  
  
|Служебное имя|UDP|TCP|  
|----------------|-------|-------|  
|NTP|123|Н/Д|  
|SNTP|123|Н/Д|  
  
## <a name="see-also"></a>См. также  
[Техническое руководство по службе времени windows](windows-time-service-tech-ref.md)
[средства и параметры службы времени Windows](Windows-Time-Service-Tools-and-Settings.md)
[статья базы знаний Майкрософт 902229](https://go.microsoft.com/fwlink/?LinkId=186066)