---
title: Форматирование команды пктмон
description: Эта страница используется для понимания форматирования и вывода команды пктмон.
ms.topic: how-to
author: khdownie
ms.author: v-kedow
ms.date: 1/20/2021
ms.openlocfilehash: f0ad3d743e41a63a53d8bba2c484f7ed32e4a5d5
ms.sourcegitcommit: 58a13a29869b39b6a6ba0db4d7b9fe1ff8371ea7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/21/2021
ms.locfileid: "98625807"
---
# <a name="pktmon-command-formatting"></a>Форматирование команды пктмон

>Область применения: Windows Server (половина ежегодного канала), Windows Server 2019, Windows 10, Azure Stack ХЦИ, центр Azure Stack, Azure

Монитор пакетов (Пктмон) — это встроенное средство диагностики сети для Windows. Он может использоваться для записи пакетов, обнаружения пакетов, фильтрации пакетов и подсчета. Этот инструмент особенно полезен в сценариях виртуализации, например в сетях контейнеров и SDN, так как он обеспечивает видимость сетевого стека. Монитор пакетов доступен в окне с помощью команды pktmon.exe в вибраниум OS (сборка 19041). С помощью этого раздела можно узнать, как понять синтаксис пктмон, форматирование команд и выходные данные. Полный список команд см. в разделе [синтаксис пктмон](/windows-server/administration/windows-commands/pktmon). 

## <a name="quick-start"></a>Быстрый запуск

Чтобы приступить к работе в универсальных сценариях, выполните следующие действия.

1. Укажите тип пакетов, необходимых для записи, т. е. определенные IP-адреса, порты или протоколы, связанные с пакетом. Затем проверьте синтаксис для применения фильтров захвата и примените фильтры для пакетов, определенных на предыдущем шаге.

   ```PowerShell
   C:\Test> pktmon filter add help
   C:\Test> pktmon filter add <filters>
   ```

2. Запустите запись и включите ведение журнала пакетов.

   ```PowerShell
   C:\Test> pktmon start --etw
   ```

3. Воспроизведите проблему, которую следует диагностировать. Счетчики запросов для подтверждения наличия ожидаемого трафика и получения обобщенного представления о том, как трафик проходит на компьютере.

   ```PowerShell
   C:\Test> pktmon counters
   ```

4. Останавливает запись и получает журналы в формате txt для анализа.

   ```PowerShell
   C:\Test> pktmon stop
   C:\Test> pktmon format <etl file>
   ```

Инструкции по анализу выходных данных txt см. в разделе [анализ выходных данных монитора пакетов](#analyze-packet-monitor-output) .

## <a name="capture-filters"></a>Фильтры записи

Настоятельно рекомендуется применять фильтры перед запуском записи пакетов, так как устранение неполадок с подключением к определенному назначению упрощается при фокусе на одном потоке пакетов. Захват *всего* сетевого трафика может сделать вывод слишком бесшумным для анализа. Чтобы сообщить о пакете, он должен соответствовать всем условиям, указанным по крайней мере в одном фильтре. Одновременно поддерживается до 32 фильтров.

Например, следующий набор фильтров захватывает трафик ICMP с IP-адреса 10.0.0.10, а также любой трафик через порт 53.

```PowerShell
C:\Test> pktmon filter add -i 10.0.0.10 -t icmp
C:\Test> pktmon filter add -p 53
```

### <a name="filtering-capability"></a>Возможность фильтрации

- Монитор пакетов поддерживает фильтрацию по MAC-адресам, IP-адресам, портам, Есертипе, транспортному протоколу и идентификатору виртуальной ЛС. 

- Монитор пакетов не различает источник или назначение, когда дело доходит до MAC-адреса, IP-адреса или фильтров портов. 

- Для дальнейшей фильтрации пакетов TCP можно указать дополнительный список флагов TCP для сопоставления. Поддерживаемые флаги: FIN, SYN, RST, КОМАНДНОМ PSH, ACK, УРГ, ECE и КВР.

  - Например, следующий фильтр будет фиксировать все пакеты SYN, отправленные или полученные IP-адресом 10.0.0.10:

```PowerShell
C:\Test> pktmon filter add -i 10.0.0.10 -t tcp syn
```

- Монитор пакетов может применить фильтр к инкапсулированным внутренним пакетам в дополнение к внешнему пакету, если флаг [-e] был добавлен к любому фильтру. Поддерживаемые методы инкапсуляции: ВКСЛАН, GRE, NVGRE и IP-in-IP. Пользовательский порт ВКСЛАН является необязательным и по умолчанию равен 4789.

Дополнительные сведения см. в разделе [синтаксис фильтра пктмон](/windows-server/administration/windows-commands/pktmon-filter).

## <a name="packet-capture-and-logging"></a>Запись пакетов и ведение журнала

Монитор пакетов может записывать сетевой трафик с ведением журнала пакетов или без него. Дополнительные сведения о захвате трафика без ведения журнала пакетов см. в разделе счетчики пакетов ниже. Чтобы записывать и записывать в журнал пакеты, добавьте параметр **[--ETW]** в команду Start.

Выберите компоненты для отслеживания с помощью параметра **[-c]** . Это могут быть все компоненты, только сетевые карты или список идентификаторов компонентов. Значение по умолчанию — записывать трафик для всех компонентов. Отслеживать пропущенные пакеты только с помощью параметра [-d]. Значение по умолчанию — захват передаваемых и пропущенных пакетов.

Например, следующая команда будет записывать счетчики пакетов для всех сетевых адаптеров, не записывая в журнал пакеты:

```PowerShell
C:\Test> pktmon start -c nics
```

Однако следующая команда захватывает только удаленные пакеты, которые проходят через компоненты 4 и 5, и записывает их в журнал:

```PowerShell
C:\Test> pktmon start --etw -c 4,5 -d
```

### <a name="packet-logging-capability"></a>Возможность ведения журнала пакетов

- Монитор пакетов поддерживает несколько режимов ведения журнала:

  - Циклический: новые пакеты перезапишут самые старые при достижении максимального размера файла. Это режим ведения журнала по умолчанию.
  - Несколько файлов: при достижении максимального размера файла создается новый файл журнала. Файлы журнала нумеруются последовательно: PktMon1. ETL, PktMon2. ETL и т. д. Примените этот режим ведения журнала, чтобы сохранить весь журнал, но будьте осторожны при использовании хранилища. Примечание. Используйте метку времени создания файла для каждого файла журнала в качестве указания на заданный промежуток времени в записи.
  - Реальное время: пакеты отображаются на экране в режиме реального времени. Файл журнала не создается. Нажмите клавиши CTRL + C, чтобы прерывать наблюдение.
  - Память: события записываются в буфер кольцевой памяти. Размер буфера задается с помощью параметра **[-s]** . Содержимое буфера записывается в файл журнала после остановки записи. Используйте этот режим ведения журнала для очень шумных сценариев, чтобы захватывать огромный объем трафика за очень короткий промежуток времени в буфере памяти. При использовании любого другого режима ведения журнала может потеряться часть трафика.

- Укажите объем пакета для записи в параметр **[-p]** . Заносить в журнал весь пакет каждого пакета независимо от его размера, присвоив этому параметру значение 0. Значение по умолчанию — 128 байт, которое должно включать заголовки большинства пакетов.

- Укажите размер файла журнала с помощью параметра **[-s]** . Это будет максимальный размер файла в циклической записи, прежде чем монитор пакетов начнет перезаписывать старые пакеты с новыми. Это также будет максимальный размер каждого файла в многофайлового режима ведения журнала перед тем, как монитор пакетов создаст новый файл для записи следующих пакетов. С помощью этого параметра можно также задать размер буфера для режима ведения журнала в памяти.

Дополнительные сведения см. в разделе [синтаксис пктмон Start](/windows-server/administration/windows-commands/pktmon-start).

## <a name="packet-analysis-and-formatting"></a>Анализ пакетов и форматирование

Монитор пакетов создает файлы журнала в формате ETL. Существует несколько способов форматирования ETL-файла для анализа.

- Преобразуйте журнал в текстовый формат (параметр по умолчанию) и проанализируйте его с помощью текстового редактора, например TextAnalysisTool.NET. Данные пакетов будут отображаться в формате TCPDump. Следуйте указаниям ниже, чтобы узнать, как анализировать выходные данные в текстовом файле.
- Преобразование журнала в формат пкапнг для анализа с помощью [Wireshark](pktmon-pcapng-support.md)*
- Откройте ETL-файл с [сетевой монитор](pktmon-netmon-support.md)*

>[!NOTE]
>* Используйте гиперссылки выше, чтобы узнать, как анализировать и анализировать журналы монитора пакетов в **Wireshark** и **сетевой монитор**.

Дополнительные сведения см. в разделе [Синтаксис формата пктмон](/windows-server/administration/windows-commands/pktmon-format).

### <a name="analyze-packet-monitor-output"></a>Анализ выходных данных монитора пакетов

Монитор пакетов фиксирует моментальный снимок пакета каждым компонентом сетевого стека. Соответственно, будет существовать несколько моментальных снимков каждого пакета (представленного на изображении ниже синим полем).
Каждый из этих моментальных снимков пакетов представлен рядом строк (красного и зеленого прямоугольников). Существует по крайней мере одна строка, содержащая некоторые данные о экземпляре пакета, начиная с метки времени. Сразу после этого по крайней мере одна строка (Полужирная на рисунке ниже) показывает проанализированный необработанный пакет в текстовом формате (без метки времени); Это может быть несколько строк, если пакет инкапсулирован, как и пакет в зеленом поле.

<center>

:::image type="content" source="media/pktmon-log-example.png" alt-text="Пример выходных данных журнала пакета мониторинга пакетов" border="false":::

</center>

Для сопоставления всех моментальных снимков одних и тех же пакетов отслеживайте значения Пктграупид и Пктнумбер (выделены желтым цветом). все моментальные снимки одного пакета должны иметь два общих значения. Значение внешнего вида (выделенное синим цветом) выступает в качестве счетчика для каждого последующего моментального снимка того же пакета. Например, первый моментальный снимок пакета (где пакет впервые появился в сетевом стеке) имеет значение 1 для внешнего вида, следующий моментальный снимок имеет значение 2 и т. д.

Каждый снимок пакета имеет идентификатор компонента (подчеркнутый на изображении выше), обозначающий компонент, связанный с моментальным снимком. Чтобы разрешить имя компонента и параметры, найдите этот идентификатор компонента в списке компонентов в нижней части файла журнала. Часть таблицы Components показана на рисунке ниже, в котором выделяется «компонент 1» в желтом цвете (это компонент, в котором был захвачен последний снимок выше).
Компоненты с 2 краями будут сообщать 2 моментальных снимка на каждом крае (например, моментальные снимки с внешним видом 3 и внешним видом 4).

В нижней части каждого файла журнала представлен список фильтров, как показано на рисунке ниже (выделяется синим цветом). Каждый фильтр отображает указанные параметры (протокол ICMP в примере ниже) и нули для остальных параметров.

<center>

:::image type="content" source="media/pktmon-log-example-components.png" alt-text="Пример выходных компонентов журнала пакета мониторинга пакетов":::

</center>

Для пропущенных пакетов слово «Drop» появляется перед любой из строк, представляющих моментальный снимок, в котором был удален пакет. Каждый отброшенный пакет также предоставляет значение Дропреасон. Этот параметр Дропреасон предоставляет краткое описание причины удаления пакета; Например, несоответствие MTU, отфильтрованная виртуальная ЛС и т. д.

<center>

:::image type="content" source="media/dropped-packet-log-example.png" alt-text="Пример журнала отброшенных пакетов":::

</center>

## <a name="packet-counters"></a>Счетчики пакетов

Счетчики монитора пакетов обеспечивают общее представление сетевого трафика по всему сетевому стеку без необходимости анализировать журнал, что может быть дорогостоящим процессом. Изучите шаблоны трафика, запросив счетчики пакетов с помощью **счетчиков пктмон** после запуска записи монитора пакетов. Сбросьте счетчики в ноль с помощью **пктмон Reset** или отключите мониторинг совместно с помощью **пктмон**.

- Счетчики упорядочиваются с помощью привязок с сетевыми адаптерами в верхней части и с помощью протоколов внизу.
- TX/RX: счетчики разделяются на два столбца для направлений отправки (TX) и приема (RX).  
- Края: компоненты сообщают о распространении пакетов, когда пакет пересекает границу компонента (EDGE). Каждый компонент может иметь один или несколько краев. Драйверы минипорта обычно имеют один верхний край, протоколы имеют один нижний край, а драйверы фильтров имеют верхние и нижние края.  
- Падения: счетчики сброса пакетов включаются в одну и ту же таблицу.

В следующем примере был запущен новый захват, а затем команда **пктмон Counters** использовалась для запроса счетчиков до остановки записи. Счетчики показывают один пакет, который делает его выходом из сетевого стека, начиная от уровня протокола до физического сетевого адаптера, и его ответ возвращается в другом направлении. Если проверка связи или ответ отсутствовали, это легко определить с помощью счетчиков.

<center>

:::image type="content" source="media/pktmon-counters-with-perfect-flow.png" alt-text="Пример счетчика пакетов с точным потоком" border="false":::

</center>

В следующем примере в столбце "Counter" отображаются сведения о падении. Получение последней причины сброса для каждого компонента путем запроса данных счетчиков в формате JSON с помощью **счетчиков пктмон--JSON** или анализа выходного журнала для получения более подробных сведений.

<center>

:::image type="content" source="media/pktmon-counters-drop-example.png" alt-text="Пример счетчика пакетов с удаленным пакетом" border="false":::

</center>

Как показано в этих примерах, счетчики могут предоставить большой объем информации через диаграмму, которая может быть проанализирована простым поиском.

Дополнительные сведения см. в разделе [синтаксис счетчиков пктмон](/windows-server/administration/windows-commands/pktmon-counters).

## <a name="networking-stack-layout"></a>Макет сетевого стека

Изучите структуру сетевого стека с помощью команды **пктмон List**.

:::image type="content" source="media/pktmon-networking-stack-example.png" alt-text="Пример макета сетевого стека" border="false":::

Команда отображает сетевые компоненты (драйверы), упорядоченные по привязкам адаптеров.

Типичная привязка состоит из следующих компонентов:

- Один сетевой адаптер (NIC);
- Несколько (возможно, нуль) драйверов фильтров
- Один или несколько драйверов протоколов (TCP/IP или другие)

Каждый компонент однозначно идентифицируется ИДЕНТИФИКАТОРом компонента монитора пакетов, который используется для наблюдения за отдельными компонентами.

>[!NOTE]
>Идентификаторы не являются постоянными и могут изменяться при перезагрузках, а также при перезапуске драйвера для монитора пакетов.

Дополнительные сведения см. в разделе [пктмон List Syntax](/windows-server/administration/windows-commands/pktmon-list).
