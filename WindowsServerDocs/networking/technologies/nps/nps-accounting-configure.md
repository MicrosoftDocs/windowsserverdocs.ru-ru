---
title: Настройка учета сервера политики сети
description: Этот раздел посвящен текстовый файл и ведения журнала для сервера политики сети в Windows Server 2016 SQL Server.
manager: brianlic
ms.prod: windows-server-threshold
ms.technology: networking
ms.topic: article
ms.assetid: dfde2e21-f3d5-41e8-8492-cb3f0d028afb
ms.author: pashort
author: shortpatti
ms.openlocfilehash: 69341e30d90ee1be29c40d835a4f71fe433c11dc
ms.sourcegitcommit: 19d9da87d87c9eefbca7a3443d2b1df486b0b010
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2018
---
# <a name="configure-network-policy-server-accounting"></a>Настройка учета сервера политики сети

Существует три типа ведения журнала для сервера политики сети \(NPS\):

- **Ведение журнала событий**. В основном используются для аудита и устранения неполадок попытки подключения. Можно настроить ведение журнала с помощью свойств сервера политики сети в консоли сервера политики сети событий сервера политики сети.

- **Ведение журнала запросов учета и проверки подлинности пользователя в локальный файл**. В основном используются для целей анализа и выставления счетов подключения. Также используется в качестве средства анализа системы безопасности, поскольку он предоставляет метод отслеживания действий пользователь-злоумышленник после атаки. Вы можете настроить локального ведение журнала с помощью мастера настройки учета.

- **Ведение журнала проверки подлинности пользователей и учетных запросов к базе данных Microsoft SQL Server XML-совместимую**. Позволяет разрешить несколько серверов политики сети для одного источника данных. Также предоставляет преимущества использования реляционной базы данных. Ведение журнала SQL Server можно настроить с помощью мастера настройки учета.

## <a name="use-the-accounting-configuration-wizard"></a>Используйте мастер настройки учета

С помощью мастера настройки учета, можно настроить следующие четыре параметры учета:

- **Только ведения журнала SQL**. С помощью этого параметра, можно настроить канал передачи данных SQL Server, позволяющий сервера политики сети для подключения и отправки данных учета на сервере SQL Server. Кроме того мастер можно настроить базу данных на сервере SQL Server, чтобы обеспечить совместимость с ведением журнала NPS SQL server базы данных.
- **Ведение текстового журнала только**. С помощью этого параметра, можно настроить сервер политики сети журнала данных учета в текстовый файл.
- **Параллельные ведения журнала**. С помощью этого параметра, можно настроить источник данных SQL Server и базы данных. Можно также настроить текст файла ведение журнала, чтобы сервер политики сети одновременно в текстовый файл и базы данных SQL Server. 
- **Ведение журнала SQL с резервной копией**. С помощью этого параметра, можно настроить источник данных SQL Server и базы данных. Кроме того можно настроить ведение журнала текст, сервер политики сети использует при сбое ведения журнала SQL Server.

Помимо этих параметров ведения журнала SQL Server и ведения текстового журнала позволяют указать продолжает обрабатывать запросы на подключение при сбое ведения журнала сервера политики сети. Вы можете указать это в **ведение журнала раздел действия сбоя** в локальный файл свойства ведения журнала, в свойства ведения журнала сервера SQL, а также при запуске мастера настройки учета.

### <a name="to-run-the-accounting-configuration-wizard"></a>Для запуска мастера настройки учета

Чтобы запустить мастер настройки учета, выполните следующие действия:

1. Откройте консоль сервера политики сети или оснастки NPS Microsoft Management Console (MMC).
2. В дереве консоли щелкните **учет**.
3. В области сведений в **учет**, нажмите кнопку **Настройка учета**.

## <a name="configure-nps-log-file-properties"></a>Настройка свойств файла журнала NPS

Можно настроить сервер политики сети (NPS) для выполнения запросов проверки подлинности, сообщений разрешения доступа, сообщений отказа в доступе, учетных запросов и ответов и периодических обновлений состояния учета службы проверки подлинности удаленного пользователя (RADIUS). Эта процедура позволяет настроить файлы журнала, в которых вы хотите сохранить учетные данные.

Дополнительные сведения об интерпретации файлов журнала см. в разделе [интерпретировать NPS журналов базы данных формат](https://technet.microsoft.com/library/cc771748.aspx).

Чтобы предотвратить заполнение жесткий диск файлы журнала, настоятельно рекомендуется хранить их на раздел, отличный от системного раздела. В этом разделе представлены дополнительные сведения о настройке учета для сервера политики сети:

- Для передачи данных файла журнала для сбора другим процессом, можно настроить сервер политики сети для записи к именованному каналу. Чтобы использовать именованные каналы, задайте папку файла журнала \\.\pipe или \\ComputerName\pipe. Именованный канал сервера программа создает именованный канал называется \\.\pipe\iaslog.log для приема данных. В диалоговом окне "Свойства локального файла", в поле Создать новый файл журнала, выберите никогда (размер файла не ограничен) при использовании именованных каналов.

- Каталог файла журнала могут быть созданы с помощью системные переменные среды (вместо переменных пользователя), такие как % systemdrive % и % systemroot %, % windir %. Например по следующему пути с помощью переменная среды % windir %, находит файл журнала в системном каталоге во вложенной папке \System32\Logs (то есть % windir%\System32\Logs\).

- Изменение форматов файла журнала не приводит должен быть создан новый журнал. Если вы измените форматов файла журнала, файл, который является активным во время изменения будет содержать оба из двух форматов (записи в начале журнала будут иметь старый формат, и записи в конец журнала будут иметь новый формат).

- В случае сбоя RADIUS-учет из-за полный жесткого диска или другие причины NPS останавливает обработку запросов на подключение, предотвращая доступ к сетевым ресурсам.

- Сервер политики сети обеспечивает возможность входа в базу данных Microsoft® SQL Server™ в дополнение к или вместо него, ведение журнала в локальный файл.

Членство в группе **"Администраторы домена"** группе является минимальным требованием для выполнения этой процедуры.


### <a name="to-configure-nps-log-file-properties"></a>Чтобы настроить свойства файла журнала на сервере политики сети

1. Откройте консоль сервера политики сети или оснастки NPS Microsoft Management Console (MMC).
2. В дереве консоли щелкните **учет**.
3. В области сведений в **свойства файла журнала**, нажмите кнопку **изменить свойства файла журнала**. **Свойства файла журнала** откроется диалоговое окно.
4. В **свойства файла журнала**на **параметры** вкладке **записывать следующие сведения**, убедитесь, что выбрано журнал достаточно информации для достижения целей учета. Например если журналов требуется корреляция сеансов, установите все флажки.
5. В **сбой действие в журнал**выберите **при сбое ведения журнала отклонять запросы на подключение** Если вы хотите, чтобы остановить обработку сообщений запроса доступа, когда файлы журнала, полный или не доступен для какой-либо причине сервер политики сети. Если требуется, чтобы сервер политики сети, чтобы продолжать обработку запросов на подключение при сбое ведения журнала, не устанавливайте этот флажок.
6. В **свойства файла журнала** диалоговом нажмите кнопку **файла журнала** вкладку.
7. На **файла журнала** вкладке **Directory**, введите расположение, где вы хотите хранить файлы журнала сервера политики сети. По умолчанию — папка systemroot\System32\LogFiles.
    >[!NOTE]
    >Если не указать полный путь оператор в **каталог файла журнала**, будет использоваться путь по умолчанию. Например, если ввести **NPSLogFile** в **каталог файла журнала**, файл находится в папке % systemroot%\System32\NPSLogFile.
8. В **формат**, нажмите кнопку **DTS-совместимый**. При желании можно вместо этого выбрать устаревший формат файла, такие как **ODBC \(Legacy\)** или **IAS \(Legacy\)**.
    >[!NOTE]
    >**ODBC** и **IAS** типы прежней версии файла содержать подмножество информации, которую сервер политики сети отправляет его базы данных SQL Server. **DTS-совместимый** тип файла XML-формат идентична формат XML, сервер политики сети используется для импорта данных в базу данных SQL Server. Таким образом **DTS-совместимый** формат файла обеспечивает более эффективный и завершения передачи данных в базу данных SQL Server standard для сервера политики сети.
9. В **Создание нового файла журнала**, чтобы настроить сервер политики сети, новые файлы журнала создавались через определенные промежутки времени, выберите пункт интервал, который вы хотите использовать:
    - Для больших объемах транзакций и ведения журнала действий щелкните **ежедневно**.
    - Для меньших объемах транзакций и ведения журнала действий щелкните **еженедельно** или **ежемесячный**.
    - Чтобы сохранить все транзакции в один файл журнала, нажмите кнопку **никогда \(unlimited file size\)**.
    - Чтобы ограничить размер каждого файла журнала, нажмите кнопку **достижении этого размера файла журнала**, а затем введите размер файла, после которого создается новый журнал. Размер по умолчанию — 10 мегабайт (МБ).
10. Если требуется, чтобы сервер политики сети, чтобы удалить старые файлы журнала для создания дискового пространства для новых файлов журнала, когда жестком диске недостаточно места, убедитесь, что **при диск заполнен, удалите старые файлы журнала** выбран. Этот параметр недоступен, однако, если значение **Создание нового файла журнала** — **никогда \(unlimited file size\)**. Кроме того Если самый старый файл журнала является текущий файл журнала, он не удаляется.

## <a name="configure-nps-sql-server-logging"></a>Настройка ведения журнала сервера политики сети SQL Server

Эта процедура журнала данных учета RADIUS для локальной или удаленной базы данных под управлением Microsoft SQL Server.

>[!NOTE]
>Сервер политики сети форматирует учетные данные в виде XML-документ, которую он отправляет в **report_event** хранимую процедуру в базе данных SQL Server, указанную папку на сервере политики сети. Для ведения журнала для правильной SQL Server, необходимо иметь хранимую процедуру с именем **report_event** в базе данных SQL Server, чтобы получать и проанализировать XML-документов от сервера политики сети.

Минимальным требованием для выполнения этой процедуры является членство в группе "Администраторы домена" или наличие эквивалентных прав.

### <a name="to-configure-sql-server-logging-in-nps"></a>Настройка ведения журнала на сервере политики сети SQL Server

1. Откройте консоль сервера политики сети или оснастки NPS Microsoft Management Console (MMC).
2. В дереве консоли щелкните **учет**.
3. В области сведений в **свойства ведения журнала SQL Server**, нажмите кнопку **изменить свойства ведения журнала сервера SQL**. **Свойства ведения журнала SQL Server** откроется диалоговое окно.
4. В **записывать следующие сведения**, выберите сведения, в журнале: 
    - Чтобы регистрировать все запросы учета, нажмите кнопку **запросов учета**.
    - Для записи в журнал запросов проверки подлинности, нажмите кнопку **запросы проверки подлинности**.
    - Чтобы записать состояние периодического учета, нажмите кнопку **состояние периодического учета**.
    - Для входа в промежуточное состояние, например промежуточные запросы учета, нажмите кнопку **промежуточное состояние**.
5. Чтобы настроить число одновременных сеансов между сервером политики сети и SQL Server, введите номер в **максимальное число одновременных сеансов**.
6. Для настройки источника данных SQL Server, в **ведения журнала SQL Server**, нажмите кнопку **Настройка**. **Свойства связи данных** откроется диалоговое окно. На **подключения** вкладку, укажите следующее: 
    - Чтобы указать имя сервера, на котором хранится база данных, введите или выберите имя в **выберите или введите имя сервера**.
    - Чтобы указать метод проверки подлинности, используемый для входа сервер, щелкните **встроенные средства безопасности Windows NT используется**. Или щелкните **использовать указанные имя пользователя и пароль**, а затем введите учетные данные в **имя пользователя** и **пароль**.
    - Чтобы разрешить пустого пароля, выберите **пустого пароля**.
    - Чтобы сохранить пароль, щелкните **Разрешить сохранение пароля**.
    - Чтобы указать, какие базы данных для подключения к на компьютере с SQL Server, нажмите кнопку **выберите базу данных на сервере**, а затем выберите имя базы данных из списка.
7. Чтобы проверить соединение между сервера политики сети и SQL Server, выберите **проверить подключение**. Нажмите кнопку **ОК** закрыть **свойства связи данных**.
8. В **сбой действие в журнал**выберите **включите ведение журнала текст для отработки отказа** Если необходимо, чтобы сервер политики сети, чтобы продолжить работу с текстового файла ведение журнала, если ведение журнала SQL Server не удается. 
9. В **сбой действие в журнал**выберите **при сбое ведения журнала отклонять запросы на подключение** Если вы хотите, чтобы остановить обработку сообщений запроса доступа, когда файлы журнала, полный или не доступен для какой-либо причине сервер политики сети. Если требуется, чтобы сервер политики сети, чтобы продолжать обработку запросов на подключение при сбое ведения журнала, не устанавливайте этот флажок.

## <a name="ping-user-name"></a>Имя пользователя ping

Некоторые прокси-серверы RADIUS и серверы доступа к сети периодически отправлять запросы проверки подлинности и учета (известных как запросы проверки связи) и убедитесь, что на NPS-сервер в сети. Эти запросы проверки связи содержатся вымышленные имена пользователей. Если сервер политики сети обрабатывает эти запросы, журналы событий и учета становятся заполненный записей отклонить доступ, что усложняет для отслеживания допустимые записи.

При настройке реестра для **связь имени пользователя**, сервер политики сети соответствует значение записи реестра со значением имя пользователя в запросы проверки связи с помощью других серверов. A **связь имени пользователя** запись реестра Отправка вымышленное имя пользователя (или шаблон имени пользователя, с переменными, который соответствует вымышленное имя пользователя), прокси-сервера RADIUS-серверов и серверов доступа к сети. Когда сервер политики сети получает запросы проверки связи, которые соответствуют **связь имени пользователя** значение записи реестра, сервер политики сети отклоняет запросы проверки подлинности без обработки запроса. Сервер политики сети не будет записывать транзакции с участием вымышленное имя пользователя в все файлы журналов, что облегчает интерпретировать журнала событий.

**Связь имени пользователя** не устанавливается по умолчанию. Необходимо добавить **связь имени пользователя** в реестр. Можно добавить запись в реестр с помощью редактора реестра.

>[!CAUTION]
>Неправильное редактирование реестра может значительно повредить систему. Прежде чем вносить изменения в реестр, следует сделать резервную копию всех ценных данных на компьютере.

### <a name="to-add-ping-user-name-to-the-registry"></a>Чтобы добавить имя пользователя ping в реестр

Имя пользователя ping можно добавить следующий раздел реестра как строковый параметр членом локальной группы администраторов:

`HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\IAS\Parameters`

- **Имя**: `ping user-name`
- **Тип**: `REG_SZ`
- **Данные**: *имя пользователя*

>[!TIP]
>Чтобы указать более одного имени пользователя для **связь имени пользователя** значения, введите шаблон имени, например имя DNS, включая подстановочные знаки в **данные**.
