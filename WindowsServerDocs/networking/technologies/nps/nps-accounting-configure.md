---
title: Настройка учета сервера политики сети
description: В этом разделе содержатся сведения о текстовом файле и SQL Server ведении журналов для сервера политики сети в Windows Server 2016.
manager: dougkim
ms.topic: article
ms.assetid: dfde2e21-f3d5-41e8-8492-cb3f0d028afb
ms.author: lizross
author: eross-msft
ms.date: 05/25/2018
ms.openlocfilehash: efeee9287851cbadd27b10420c670ecb394adb90
ms.sourcegitcommit: 68444968565667f86ee0586ed4c43da4ab24aaed
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/07/2020
ms.locfileid: "87994218"
---
# <a name="configure-network-policy-server-accounting"></a>Настройка учета сервера политики сети

Существует три типа ведения журнала для NPS сервера политики сети \( \) .

- **Ведение журнала событий**. Используется в основном для аудита и устранения неполадок при попытках подключения. Ведение журнала событий NPS можно настроить, получая свойства NPS в консоли NPS.

- **Регистрация запросов проверки подлинности пользователя и учетных данных в локальном файле**. Используется в основном для анализа подключений и выставления счетов. Также полезно в качестве средства для анализа безопасности, поскольку оно предоставляет метод отслеживания действий злоумышленника после атаки. Ведение журнала локального файла можно настроить с помощью мастера настройки учета.

- **Регистрация запросов проверки подлинности и учетных записей пользователей в базе данных, совместимой с XML Microsoft SQL Server**. Используется, чтобы разрешить нескольким серверам службы NPS иметь один источник данных. Также предоставляет преимущества использования реляционной базы данных. Вы можете настроить ведение журнала SQL Server с помощью мастера настройки учета.

## <a name="use-the-accounting-configuration-wizard"></a>Использование мастера настройки учета

С помощью мастера настройки учета можно настроить следующие четыре параметра учета:

- **Только ведение журнала SQL**. С помощью этого параметра можно настроить связь данных с SQL Server, которая позволяет серверу политики сети подключаться к серверу SQL Server и передавать данные учета. Кроме того, мастер может настроить базу данных на SQL Server, чтобы убедиться, что база данных совместима с ведением журнала сервера политики сети SQL Server.
- **Только ведение журнала текста**. С помощью этого параметра можно настроить сервер политики сети для ведения журнала данных учета в текстовом файле.
- **Параллельное ведение журнала**. С помощью этого параметра можно настроить SQL Server связи с данными и базы данных. Кроме того, можно настроить ведение журнала для текстового файла, чтобы серверы NPS одновременно заносятся в текстовый файл и базу данных SQL Server.
- **Ведение журнала SQL с помощью резервного копирования**. С помощью этого параметра можно настроить SQL Server связи с данными и базы данных. Кроме того, можно настроить ведение журнала для текстового файла, используемого NPS при сбое SQL Server ведения журнала.

Помимо этих параметров, как SQL Server ведения журнала, так и ведения журнала текста позволяют указать, будет ли NPS продолжать обрабатывать запросы на подключение при сбое ведения журнала. Это можно указать в разделе " **действие при сбое ведения** журнала" в свойствах ведения журнала локального файла, в свойствах ведения журнала SQL Server и во время работы мастера настройки учета.

### <a name="to-run-the-accounting-configuration-wizard"></a>Запуск мастера настройки учета

Чтобы запустить мастер настройки учета, выполните следующие действия.

1. Откройте консоль NPS или оснастку NPS консоли управления (MMC).
2. В дереве консоли щелкните **учет**.
3. В области сведений в поле **учет**выберите **Настройка учета**.

## <a name="configure-nps-log-file-properties"></a>Настройка свойств файла журнала NPS

Сервер политики сети (NPS) можно настроить на выполнение учетных записей протокол RADIUS (RADIUS) для запросов проверки подлинности пользователей, сообщений о принятии доступа, сообщений об отклонении доступа, запросов на учет и ответов, а также периодического обновления состояния. Эту процедуру можно использовать для настройки файлов журналов, в которых будут храниться данные учета.

Дополнительные сведения об интерпретации файлов журналов см. в разделе [Интерпретация файлов журнала в формате базы данных NPS](/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/cc771748(v=ws.10)).

Чтобы файлы журнала не заполнили жесткий диск, настоятельно рекомендуется размещать их в разделе, отдельном от системного раздела. Ниже приведены дополнительные сведения о настройке учета для сервера политики сети.

- Чтобы отправить данные файла журнала для сбора другим процессом, можно настроить NPS для записи в именованный канал. Чтобы использовать именованные каналы, задайте для папки файла журнала значение \\ .\pipe или \\ компутернаме\пипе.. Серверная программа именованного канала создает именованный канал с именем \\ .\пипе\иаслог.лог для приема данных. В диалоговом окне Свойства локального файла в поле создать новый файл журнала выберите значение никогда (неограниченный размер файла) при использовании именованных каналов.

- Каталог файла журнала может быть создан с помощью системных переменных среды (вместо пользовательских переменных), таких как% SystemDrive%,% systemroot% и% WINDIR%. Например, следующий путь, используя переменную среды% WINDIR%, находит файл журнала в системном каталоге во вложенной папке \System32\Logs (то есть%windir%\System32\Logs \) .

- Переключение форматов файлов журнала не приводит к созданию нового журнала. Если изменить формат файла журнала, то файл, который активен во время изменения, будет содержать смесь двух форматов (записи в начале журнала будут иметь предыдущий формат, а записи в конце журнала будут иметь новый формат).

- Если при выполнении учета RADIUS произошел сбой из-за переполнения жесткого диска или других причин, NPS останавливает обработку запросов на подключение, предотвращая доступ пользователей к сетевым ресурсам.

- Сервер политики сети предоставляет возможность выполнять вход в базу данных Microsoft® SQL Server™ в дополнение к локальному файлу или вместо него.

Членство в группе **"Администраторы домена** " является минимальным требованием для выполнения этой процедуры.


### <a name="to-configure-nps-log-file-properties"></a>Настройка свойств файла журнала NPS

1. Откройте консоль NPS или оснастку NPS консоли управления (MMC).
2. В дереве консоли щелкните **учет**.
3. В области сведений в **свойствах файла журнала**щелкните **изменить свойства файла журнала**. Откроется диалоговое окно **Свойства файла журнала** .
4. В **свойствах файла журнала**на вкладке **Параметры** в поле **заносить в журнал следующие сведения**убедитесь, что выбрано ведение журнала достаточной информации для достижения целей бухгалтерского учета. Например, если в журналах необходимо выполнить корреляцию сеансов, установите флажок все.
5. В окне **действие при сбое ведения журнала**выберите, **Если ведение журнала завершается сбоем,** отменяет запросы на подключение, если требуется, чтобы NPS не обрабатывал обработку сообщений Access, когда файлы журнала заполнены или недоступны по какой-либо причине. Если требуется, чтобы сервер политики сети продолжал обрабатывать запросы на подключение при сбое ведения журнала, не выбирайте этот флажок.
6. В диалоговом окне **Свойства файла журнала** перейдите на вкладку **файл журнала** .
7. На вкладке **файл журнала** в поле **Каталог**введите расположение, в котором нужно хранить файлы журналов NPS. Расположением по умолчанию является папка systemroot\System32\LogFiles.<br>Если в **каталоге файла журнала**не указан полный путь, то используется путь по умолчанию. Например, если ввести **нпслогфиле** в **каталоге файла журнала**, файл будет расположен по адресу%systemroot%\System32\NPSLogFile.
8. В меню **Формат**выберите пункт **Совместимость с DTS**. При желании можно выбрать формат устаревшего файла, например **ODBC \( Legacy \) ** или **IAS \( Legacy \) **.<br>Устаревшие типы файлов **ODBC** и **IAS** содержат подмножество сведений, которые NPS отправляет в свою базу данных SQL Server. Формат XML типа файла, **совместимого с DTS** , идентичен формату XML, который NPS использует для импорта данных в базу данных SQL Server. Таким образом, формат файлов, **совместимый с DTS** , обеспечивает более эффективную и полную перенос данных в стандартную базу данных SQL Server для NPS.
9. В окне **Создание нового файла журнала**для настройки сервера политики сети на запуск новых файлов журнала через определенные интервалы выберите нужный интервал.
    - Для интенсивного объема транзакций и ведения журнала щелкните **ежедневно**.
    - Для меньших объемов транзакций и действий ведения журнала щелкните **еженедельно** или **ежемесячно**.
    - Чтобы сохранить все транзакции в одном файле журнала, установите флажок **не \( ограничивать размер \) файлов**.
    - Чтобы ограничить размер каждого файла журнала, установите флажок **когда размер файла журнала достигнет этого размера**, а затем введите размер файла, после которого создается новый журнал. Размер по умолчанию — 10 мегабайт (МБ).
10. Если вы хотите, чтобы сервер политики сети удалил старые файлы журнала, чтобы создать место на диске для новых файлов журнала, когда жесткий диск приближается к емкости, убедитесь, что выбран параметр **при заполнении диска удалить старые файлы журнала** . Однако этот параметр недоступен, если значение параметра **создать новый файл журнала** **никогда не \( ограничено размером \) файла**. Кроме того, если самый старый файл журнала является текущим файлом журнала, он не удаляется.

## <a name="configure-nps-sql-server-logging"></a>Настройка ведения журнала SQL Server NPS

Эту процедуру можно использовать для записи данных учета RADIUS в локальную или удаленную базу данных, работающую Microsoft SQL Server.

>[!NOTE]
>NPS форматирует данные учета как XML-документ, который отправляется в **report_event** хранимую процедуру в базе данных SQL Server, назначенной в NPS. Чтобы SQL Server ведение журнала работало правильно, в базе данных SQL Server должна быть хранимая процедура с именем **report_event** , которая может принимать и анализировать XML-документы из NPS.

Членство в группе Администраторы домена или эквивалентной является минимальным требованием для выполнения данной процедуры.

### <a name="to-configure-sql-server-logging-in-nps"></a>Настройка ведения журнала SQL Server в NPS

1. Откройте консоль NPS или оснастку NPS консоли управления (MMC).
2. В дереве консоли щелкните **учет**.
3. В области сведений в **SQL Server свойства ведения журнала**щелкните **изменить свойства ведения журнала SQL Server**. Откроется диалоговое окно **Свойства ведения журнала SQL Server** .
4. В **поле записывать в журнал следующие сведения**выберите сведения, которые необходимо заносить в журнал:
    - Чтобы регистрировать все запросы учета, щелкните **запросы на учет**.
    - Чтобы вести журнал запросов проверки подлинности, щелкните **запросы проверки подлинности**.
    - Чтобы зарегистрировать состояние периодического учета, щелкните **периодическое состояние учета**.
    - Чтобы зарегистрировать периодическое состояние, например промежуточные запросы учета, щелкните **периодическое состояние**.
5. Чтобы настроить количество одновременных сеансов, разрешенных между сервером, на котором выполняется сервер политики сети, и SQL Server, введите число в поле **Максимальное число одновременных сеансов**.
6. Чтобы настроить SQL Server источник данных, в **SQL Server ведение журнала**нажмите кнопку **настроить**. Откроется диалоговое окно **Свойства связи данных** . На вкладке **Подключение** укажите следующие настройки.
    - Чтобы указать имя сервера, на котором хранится база данных, введите или выберите имя в поле **выберите или введите имя сервера**.
    - Чтобы указать метод проверки подлинности, используемый для входа на сервер, установите флажок **использовать встроенную безопасность Windows NT**. Или щелкните **использовать определенные имя пользователя и пароль**, а затем введите учетные данные в окне **имя пользователя** и **пароль**.
    - Чтобы разрешить пустой пароль, нажмите кнопку **пустой пароль**.
    - Чтобы сохранить пароль, нажмите кнопку **Разрешить сохранение пароля**.
    - Чтобы указать, к какой базе данных подключаться на компьютере, на котором работает SQL Server, щелкните **выбрать базу данных на сервере**, а затем выберите имя базы данных из списка.
7. Чтобы проверить подключение между NPS и SQL Server, нажмите кнопку **проверить подключение**. Нажмите кнопку **ОК** , чтобы закрыть **Свойства связи данных**.
8. В поле **действие при сбое ведения журнала**выберите параметр **включить ведение журнала текстового файла для отработки отказа** , если требуется, чтобы служба NPS продолжала вести журнал в текстовом файле, если SQL Server ведение журнала
9. В окне **действие при сбое ведения журнала**выберите, **Если ведение журнала завершается сбоем,** отменяет запросы на подключение, если требуется, чтобы NPS не обрабатывал обработку сообщений Access, когда файлы журнала заполнены или недоступны по какой-либо причине. Если требуется, чтобы сервер политики сети продолжал обрабатывать запросы на подключение при сбое ведения журнала, не выбирайте этот флажок.

## <a name="ping-user-name"></a>Имя пользователя проверки связи

Некоторые прокси-серверы RADIUS и серверы доступа к сети периодически отправляют запросы на проверку подлинности и учетные данные (называемые запросами проверки связи) для проверки наличия в сети сервера политики сети. Эти запросы проверки связи включают вымышленные имена пользователей. Когда сервер политики сети обрабатывает эти запросы, журналы событий и учета заполняются записями отклонений доступа, что усложняет отслеживание допустимых записей.

При настройке записи реестра для **проверки связи "имя пользователя**" сервер политики сети сопоставляет значение записи реестра со значением имени пользователя в запросах проверки связи другими серверами. Запись реестра **ping user-name** указывает вымышленное имя пользователя (или шаблон имени пользователя с переменными, которое соответствует вымышленному имени пользователя), отправленному прокси-серверами RADIUS и серверами сетевого доступа. Когда сервер политики сети получает запросы проверки связи, соответствующие значению записи реестра **ping user-name** , сервер политики сети отклоняет запросы на проверку подлинности без обработки запроса. Сервер политики сети не регистрирует транзакции, в которых используется вымышленное имя пользователя, в любом файле журнала, что упрощает интерпретацию журнала событий.

**Имя пользователя ping** не установлено по умолчанию. В реестр необходимо добавить **имя пользователя ping** . Вы можете добавить запись в реестр с помощью редактора реестра.

>[!CAUTION]
>Неправильное редактирование реестра может значительно повредить систему. Перед внесением изменений следует сделать резервную копию всех ценных данных на компьютере.

### <a name="to-add-ping-user-name-to-the-registry"></a>Добавление ping user-name в реестр

Имя пользователя Ping можно добавить в следующий раздел реестра как строковое значение с помощью члена локальной группы "Администраторы":

`HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\IAS\Parameters`

- **Имя**: `ping user-name`
- **Тип**: `REG_SZ`
- **Данные**: *имя пользователя*

>[!TIP]
>Чтобы указать несколько имен пользователей для имени **пользователя ping** , введите в **данные**шаблон имени, например DNS-имя, включая подстановочные знаки.