---
title: BranchCache
description: В этом разделе представлен обзор BranchCache в Windows Server 2016
manager: brianlic
ms.custom: na
ms.prod: windows-server-threshold
ms.reviewer: na
ms.suite: na
ms.technology: networking-bc
ms.tgt_pltfrm: na
ms.topic: article
ms.assetid: a4587cff-c086-49f1-a0bf-cd74b8a44440
ms.author: pashort
author: shortpatti
ms.openlocfilehash: 5540d89827b80a21bf23f6a2aa8f54f09dfde67a
ms.sourcegitcommit: 19d9da87d87c9eefbca7a3443d2b1df486b0b010
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2018
---
# <a name="branchcache"></a>BranchCache

>Область применения: Windows Server (канал точками годовой), Windows Server 2016

В этом разделе, предназначенном для специалистов по информационных технологий (ИТ), краткая информация о службе BranchCache, включая режимы, компоненты, возможности и функции BranchCache, доступные в различных операционных системах BranchCache.

> [!NOTE]
> Дополнение к данному разделу доступна следующая документация по BranchCache.
> 
> - [BranchCache Network Shell и команд Windows PowerShell](../branchcache/BranchCache-Network-Shell-and-Windows-PowerShell-Commands.md)
> -   [Руководство по развертыванию BranchCache](../branchcache/deploy/BranchCache-Deployment-Guide.md)

**Кого могут заинтересовать BranchCache?**

Если вы системный администратор, сети или хранилища Архитектор решений или других ИТ-специалистов, BranchCache может заинтересовать вас в следующих случаях.

- Вы проектируете или поддерживаете ИТ-инфраструктуру для организации, которая имеет два или несколько физических расположений и подключении к глобальной сети (WAN) между филиалами и главным офисом.

- Вы проектируете или поддерживаете ИТ-инфраструктуру в организации, где развернуты облачные технологии и подключения к глобальной сети, используемые для доступа к данным и приложениям в удаленных расположениях.

- Вы хотите оптимизировать использование пропускной способности WAN путем сокращения сетевого трафика между филиалами и главным офисом.

- Вы развернули или планируете развернуть серверы содержимого в главном офисе, которые соответствуют конфигурации, которые описаны в этом разделе.

- В филиалах клиентских компьютеров под управлением Windows 10, Windows 8.1, Windows 8 или Windows 7.

Эта статья содержит следующие разделы:

-   [Что такое BranchCache?](#bkmk_what)

-   [Режимы BranchCache](#BKMK_2)
  
-   [Серверы содержимого с поддержкой BranchCache](#BKMK_3)
  
-   [BranchCache и облако](#BKMK_3a)
  
-   [Версии сведений о содержимом](#bkmk_version)  
  
-   [Обработка обновления содержимого в файлах BranchCache](#bkmk_handles)  
  
-   [Руководство по установке BranchCache](#BKMK_4)  
  
-   [Версии операционных систем для BranchCache](#bkmk_os)  
  
-   [Безопасность BranchCache](#bkmk_security)  
  
-   [Потоки сведений о содержимом и процессы](#bkmk_flow)  
  
-   [Безопасность кэша](#bkmk_cache)  
  
## <a name="bkmk_what"></a>Что такое BranchCache?

BranchCache — это технология оптимизации глобальной сети (WAN) пропускной способности, включенная в некоторые выпуски операционных систем Windows Server 2016 и Windows 10, а также в некоторые выпуски Windows Server 2012 R2, Windows 8.1, Windows Server 2012, Windows 8, Windows Server 2008 R2 и Windows 7. Для оптимизации пропускной способности глобальной сети, когда пользователи обращаются к содержимому на удаленных серверах, BranchCache извлекает содержимое в главном офисе или облаке серверов содержимого и кэширует это содержимое в офисах филиалов, позволяя клиентским компьютерам в филиалах, доступ к содержимому локально, а не через глобальную сеть.
  
В филиалах содержимое хранится либо на серверах, которые настроены для размещения кэша, либо, если сервер не доступно в филиале на клиентских компьютерах, работающих под управлением Windows 10, Windows 8.1, Windows 8 или Windows 7. После того как клиентский компьютер запрашивает и получает данные из главного офиса и содержимое кэшируется в филиале, остальные компьютеры в одном филиале могут получать данные локально, а не загружать содержимое с сервера содержимого по глобальной.

Когда клиентские компьютеры посылают последующие запросы на те же данные, клиенты загружают *сведения о содержимом* с сервера вместо фактического содержимого. Сведения о содержимом состоят из хэшей, которые вычисляются с помощью блоков исходного содержимого и их размер исключительно мал по сравнению с содержимым в исходных данных. Клиентские компьютеры затем используют сведения о содержимом найти содержимое в кэше филиала, который находится на клиентском компьютере или на сервере. Клиентские компьютеры и серверы также используют сведения о содержимом, чтобы защитить кэшированное содержимое неавторизованные пользователи не могли получить доступ.

BranchCache увеличивает производительность конечного пользователя, сокращая время обработки запросов контента для клиентов и серверов в филиалах, а также помогают улучшить производительность сети в результате снижения трафика ГЛОБАЛЬНОЙ сети.

## <a name="BKMK_2"></a>Режимы BranchCache
BranchCache работает в двух режимах: режиме распределенного кэша и режим размещенного кэша.

Если вы развертываете BranchCache в режиме распределенного кэша, кэш содержимого в филиале распределяется между клиентскими компьютерами.

При развертывании BranchCache в режиме размещенного кэша кэш содержимого в филиале размещается на одном или нескольких серверах, которые называются серверами размещенного кэша.

> [!NOTE]
> Вы можете развернуть BranchCache, используя оба режима, однако только один режим можно использовать в одном филиале. Например если у вас есть два филиалов, один из которых есть сервер а в другом — нет, вы можете развернуть BranchCache в режиме размещенного кэша в офисе, содержащего сервер, при развертывании BranchCache в режиме распределенного кэша в офисе, содержащего только клиентские компьютеры.

На следующей иллюстрации Служба BranchCache развернута в обоих режимах.  

![Режимы BranchCache](../media/BranchCache/bc_modes.jpg)

Режим распределенного кэша больше подходит для небольших филиалов, где нет локального сервера для использования в качестве сервера размещенного кэша. Режим распределенного кэша позволяет развернуть BranchCache в филиалах без дополнительного оборудования.

Если в филиале, где вы хотите развернуть BranchCache, есть дополнительная инфраструктура, например один или несколько серверов, работающих под управлением других рабочих нагрузок, развертывание BranchCache в режиме размещенного кэша предпочтительнее по следующим причинам:

### <a name="increased-cache-availability"></a>Повышенная доступность кэша

В режиме размещенного кэша увеличивается эффективность кэша, так как содержимое доступно, даже если клиент, первоначально запросивший и поместивший в кэш данные находится в автономном режиме. Так как сервер размещенного кэша всегда доступен, дополнительные содержимое кэшируется, что обеспечивает значительное увеличение пропускной способности сети WAN и эффективности BranchCache.

### <a name="centralized-caching-for-multiple-subnet-branch-offices"></a>Централизованное кэширование для филиалов с несколькими подсетями


Режим распределенного кэша функционирует в одной подсети. В офисе филиала несколькими подсетями, настроенный для режима распределенного кэша файл, загруженный в одной подсети, будет недоступен клиентским компьютерам в других подсетях. 

По этой причине клиенты в других подсетях, не обладая информацией о том, что файл уже загружен, получают файл с сервера содержимого главного офиса, пользуясь в процессе пропускной способности глобальной сети.

При использовании режима размещенного кэша, однако это не так — все клиенты в филиале с несколькими подсетями могут получить доступ к единому кэшу, который хранится на сервере размещенного кэша, даже если клиенты находятся в разных подсетях. Кроме того BranchCache в Windows Server 2016, Windows Server 2012 R2 и Windows Server 2012 предоставляет возможность развертывания нескольких серверов размещенного кэша на филиал.

> [!CAUTION]
> При использовании службы BranchCache для кэширования файлов и папок SMB не отключайте автономные файлы. Если автономные файлы будут отключены, кэширование BranchCache SMB работать неправильно.

## <a name="BKMK_3"></a>Серверы содержимого с поддержкой BranchCache

При развертывании BranchCache исходное содержимое хранится на серверах с BranchCache содержимого в главном офисе или в облачном центре обработки данных. BranchCache поддерживает следующие типы серверов содержимого.

> [!NOTE]
> Ускоряет загрузку только исходного содержимого — то есть содержимого, которое клиентские компьютеры изначально получают с поддержкой BranchCache сервера содержимого — с BranchCache. Содержимое, которое клиентские компьютеры получают напрямую из других источников, например веб-серверов в Интернете или из центра обновления Windows, не кэшируется клиентским компьютером или серверов размещенного кэша и затем совместно с другим компьютерам в филиале. Если вы хотите ускорить загрузку содержимого из центра обновления Windows, тем не менее, можно установить сервер приложений Windows Server Update Services (WSUS) в главном офисе или в облачном центре обработки данных и настроить его в качестве сервера содержимого BranchCache.

### <a name="web-servers"></a>Веб-серверы

Поддерживаемые веб-службы включают компьютеры под управлением Windows Server 2016, Windows Server 2012 R2, Windows Server 2012 или Windows Server 2008 R2, установленной ролью сервера веб-сервер (IIS), которые используют протокола передачи гипертекста (HTTP) или безопасной HTTP (HTTPS).

Кроме того веб-сервере должен быть установлен компонент BranchCache.

### <a name="file-servers"></a>Файловые серверы

Поддерживаемые файловые серверы включают компьютеры под управлением Windows Server 2016, Windows Server 2012 R2, Windows Server 2012 или Windows Server 2008 R2, имеющие роль сервера файловых служб и Служба BranchCache для сетевых файлов службы роли установлены. 

Эти файловые серверы используют Server Message Block (SMB) для обмена данными между компьютерами. После завершения установки файлового сервера, необходимо также совместное использование папок и генерирование хэша для общих папок с помощью групповой политики или политики локального компьютера, чтобы включить BranchCache.

### <a name="application-servers"></a>Серверы приложений

Поддерживаемые серверы приложений включают компьютеры под управлением Windows Server 2016, Windows Server 2012 R2, Windows Server 2012 или Windows Server 2008 R2 с помощью фоновой интеллектуальной службы передачи (BITS) установлена и включена. 

Кроме того на сервере приложений должен быть установлен компонент BranchCache. В качестве примеров серверов приложений можно развернуть серверы Microsoft Windows Server Update Services (WSUS) и точки распространения филиала Microsoft System Center Configuration Manager в качестве серверов содержимого BranchCache.

## <a name="BKMK_3a"></a>BranchCache и облако

Облако обладает огромным потенциалом с точки зрения сокращения операционных расходов и достижения новых уровней масштабирования, но удаление процессов от людей, которые зависят от их можно увеличить сетевые расходы и снизить эффективность. Пользователям нужна высокая производительность и неважно, где размещаются их приложения и данные. 

BranchCache может увеличить производительность сетевых приложений и снизить потребление пропускной способности с помощью общего кэша данных.  Она также повышает производительность в филиалах и главных офисах, где сотрудники используют серверы, развернутые в облаке.

Так как BranchCache не требуется новое оборудование или изменение топологии сети, это идеальное решение для улучшения связи между офисами и общими или частными облаками.

> [!NOTE]
> Так как некоторые веб-прокси не удается обработать нестандартные заголовки кодирование содержимого, рекомендуется использовать BranchCache Hyper текст передачи протокола безопасной (HTTPS) и не HTTP.
  
=== Дополнительные сведения об облачных технологиях в Windows Server 2016 см. в разделе [программного обеспечения определены сети & #40; SDN & #41;](../sdn/Software-Defined-Networking--SDN-.md).
  
## <a name="bkmk_version"></a>Версии сведений о содержимом

Существует две версии сведений о содержимом:

- Сведения о содержимом, совместимые с компьютерами под управлением Windows Server 2008 R2 и Windows 7 называется версии 1 или версии V1. В сегментации файлов BranchCache версии V1 сегменты файлов крупнее, чем в версии V2 и имеют фиксированный размер. Из-за большого фиксированного размера сегментов когда пользователь вносит изменения меняется длина файла, не только сегмент с изменением недействительными, но все сегменты до конца файла становятся недействительными. Поскольку измененное содержимое и все содержимое после изменения передаются по глобальной следующего вызова для измененного файла другим пользователем в филиале таким образом результатов в ограниченной пропускной способности WAN.

- Сведения о содержимом, совместимые с компьютерами под управлением Windows Server 2016, Windows 10, Windows Server 2012 R2, Windows 8.1, Windows Server 2012 и Windows 8 называется версии 2 или V2. Сведения о содержимом v2 использует меньше размера переменной сегменты, которые более устойчивы к изменениям в файле. Это повышает вероятность того, что сегменты из более старой версии файла можно использовать повторно, когда пользователи обращаются к обновленной версией, из-за которой будет извлекаться только измененная часть файла с сервера содержимого и использование полосы пропускания WAN уменьшатся.

В следующей таблице информация в сведения о содержимом версии, которая используется в зависимости от клиента, сервер содержимого и размещенного кэша серверных операционных систем, используемых в развертывании BranchCache.

> [!NOTE]
> В этой таблице сокращение «ОС» означает операционной системы.

|ОС на клиенте|ОС на сервере содержимого|ОС на сервере размещенного кэша|Сведения о содержимом версии|
|-------------|---------------------|--------------------------|-------------------------------|
|Windows Server 2008 R2 и Windows 7 |Windows Server 2012 или более поздней версии|Windows Server 2012 или более поздней версии; для режима распределенного кэша — нет|V1|
|Windows Server 2012 или более поздней версии; Windows 8 или более поздней версии|Windows Server 2008 R2 |Windows Server 2012 или более поздней версии; для режима распределенного кэша — нет|V1|
|Windows Server 2012 или более поздней версии; Windows 8 или более поздней версии| Windows Server 2012 или более поздней версии| Windows Server 2008 R2 |V1|
|Windows Server 2012 или более поздней версии; Windows 8 или более поздней версии|Windows Server 2012 или более поздней версии|Windows Server 2012 или более поздней версии; для режима распределенного кэша — нет|V2|

После серверы содержимого и серверы размещенного кэша, работающих под управлением Windows Server 2016, Windows Server 2012 R2 и Windows Server 2012, используют версию сведений о содержимом, соответствующий операционной системы на клиенте BranchCache, который запрашивает сведения. 

Когда компьютеры под управлением Windows Server 2012 и Windows 8 или более поздних операционных системах запрашивают содержимое, серверы содержимого и размещенного кэша используют сведения о содержимом V2; Когда компьютеры под управлением Windows Server 2008 R2 и Windows 7 запрашивают содержимое, серверы содержимого и размещенного кэша используют сведения о содержимом версии V1.

>[!IMPORTANT]
>При развертывании BranchCache в режиме распределенного кэша клиенты, использующие различные сведения о содержимом версии не делитесь содержимым друг с другом. Например клиентский компьютер под управлением Windows 7 и клиентский компьютер под управлением Windows 10, которые устанавливаются в одном филиале не делитесь содержимым друг с другом.
  
## <a name="bkmk_handles"></a>Обработка обновления содержимого в файлах BranchCache

При пользователями из филиала компании изменений или обновлений в документы, эти изменения сохраняются непосредственно на сервер содержимого в главном офисе без участия в BranchCache. Это справедливо, пользователь загрузил ли документ с сервера содержимого или извлек его из размещенного или распределенного кэша в филиале.

При запросе измененного файла другим клиентом из филиала новые сегменты файла загружаются с сервера главного офиса и добавляются в размещенный или распределенный кэш в данном филиале. По этой причине пользователи из филиала всегда имеют самым последним версиям кэшированного содержимого.

## <a name="BKMK_4"></a>Руководство по установке BranchCache

Чтобы установить компонент BranchCache или BranchCache для сетевых файлов службы роли для роли сервера файловых служб, можно использовать диспетчер сервера в Windows Server 2016. Можно использовать следующую таблицу для определения, нужно ли устанавливать службу роли или компонент.

|Функциональные возможности|Расположение компьютера|Установить этот элемент BranchCache|
|-----------------|---------------------|------------------------------------|
|Сервер содержимого \ (сервере приложения на базе BITS)|Главный офис или облачный центр обработки данных|Компонент BranchCache|
|\(Web server\) сервера содержимого|Главный офис или облачный центр обработки данных|Компонент BranchCache|
|Сервер содержимого \ (файловый сервер, с помощью SMB protocol\)|Главный офис или облачный центр обработки данных|Служба BranchCache для сетевых файлов службы роли для роли сервера файловых служб|
|Сервер размещенного кэша|Филиал|Компонент BranchCache с включенным режимом сервера размещенного кэша|
|Компьютер с поддержкой BranchCache|Филиал|Установка не требуется; просто включить BranchCache и режим BranchCache \(distributed or hosted\) на клиенте|

Чтобы установить службу роли или компонент, откройте диспетчер серверов и выберите компьютеры, где вы хотите включить функции BranchCache. В диспетчере серверов щелкните **управление**, а затем нажмите кнопку **Добавить роли и компоненты**. **Добавить роли и компоненты** откроется мастер. Запустите мастер и выберите следующие параметры:

- На странице мастера **Выбор типа установки**выберите **Установка на основе ролей или компонентов**.

- На странице мастера **Выбор ролей сервера**, если вы устанавливаете включена служба BranchCache файловым сервером, разверните **файловых служб и служб хранилища** и **файловой службы и службы iSCSI**и выберите **BranchCache для сетевых файлов**.  Для экономии места на диске, можно также выбрать **дедупликации данных** роль службы, а затем продолжите работу с мастером установки и завершения. Если вы не хотите устанавливать включена служба BranchCache файловый сервер, не устанавливайте роль файловых служб и служб хранилища с BranchCache для сетевых файлов службы роли.

- На странице мастера **выберите компоненты**, если вы устанавливаете сервер содержимого, который не находится на файловом сервере или вы устанавливаете сервер размещенного кэша, выберите **BranchCache**и затем продолжите работу с мастером установки и завершения. Если вы не хотите устанавливать сервер содержимого, не файловый сервер или сервер размещенного кэша, не устанавливайте компонент BranchCache.
  
## <a name="bkmk_os"></a>Версии операционных систем для BranchCache

Ниже приведен список операционных систем, поддерживающих различные типы функций BranchCache.

### <a name="operating-systems-for-branchcache-client-computer-functionality"></a>Операционные системы для функцию BranchCache на клиентских компьютерах

В следующих операционных системах BranchCache предоставить поддержку фоновой интеллектуальной службы передачи (BITS), Hyper протокола передачи текста (HTTP) и Server Message Block (SMB).

- Windows 10 Корпоративная

- Windows 10 для образовательных учреждений

- Windows 8.1 Корпоративная

- Windows 8 Корпоративная

- Windows 7 Корпоративная

- Windows 7 Максимальная

В следующих операционных систем BranchCache не поддерживает функции HTTP и SMB, но поддерживает функциональность BranchCache BITS.

-   Windows 10 Pro, BITS поддерживает только

-   Windows 8.1 Профессиональная, BITS поддерживает только

-   Windows 8 Профессиональная, BITS поддерживает только

-   Windows 7 Профессиональная, BITS поддерживает только

> [!NOTE]
> BranchCache не по умолчанию в операционных системах Windows Server 2008 или Windows Vista. В этих операционных системах, тем не менее, если загрузить и установить обновление Windows Management Framework BranchCache функция доступна только протокол фоновой интеллектуальной службы передачи (BITS). Дополнительные сведения и загрузка Windows Management Framework, см. раздел [Windows Management Framework (Windows PowerShell 2.0, WinRM 2.0 и BITS 4.0)](https://go.microsoft.com/fwlink/?LinkId=188677) в https://go.microsoft.com/fwlink/?LinkId=188677.
  
### <a name="operating-systems-for-branchcache-content-server-functionality"></a>Операционные системы для службы BranchCache содержимого функциями сервера

Можно использовать операционных систем семейства Windows Server 2016, Windows Server 2012 R2 и Windows Server 2012 в качестве серверов содержимого BranchCache.

Кроме того семейство операционных систем Windows Server 2008 R2 можно использовать в качестве серверов содержимого BranchCache со следующими исключениями:

- BranchCache не поддерживается в установке основных серверных компонентов Windows Server 2008 R2 Enterprise с Hyper-V.

- BranchCache не поддерживается в установке основных серверных компонентов Windows Server 2008 R2 Datacenter с Hyper-V.

### <a name="operating-systems-for-branchcache-hosted-cache-server-functionality"></a>Операционные системы для BranchCache серверах размещенного кэша

Можно использовать операционных систем семейства Windows Server 2016, Windows Server 2012 R2 и Windows Server 2012, как серверов размещенного кэша BranchCache.

Кроме того следующие операционные системы Windows Server 2008 R2 можно использовать как серверов размещенного кэша BranchCache:

- Windows Server 2008 R2 Enterprise

- Windows Server 2008 R2 Enterprise с Hyper-V

- Windows Server 2008 R2 Enterprise основные серверные компоненты

- Windows Server 2008 R2 Enterprise Установка основных серверных компонентов с помощью Hyper-V

- Windows Server 2008 R2 для систем на базе процессоров Itanium

- Windows Server 2008 R2 Datacenter

- Windows Server 2008 R2 Datacenter с Hyper-V

- Windows Server 2008 R2 Datacenter Установка основных серверных компонентов с помощью Hyper-V

## <a name="bkmk_security"></a>Безопасность BranchCache

В службе BranchCache реализован подход безопасной по своей природе, который обеспечивает абсолютную совместимость с существующей архитектурой сетевой безопасности, не требует установки дополнительного оборудования или сложной настройки безопасности.
  
BranchCache не вмешивается в работу и не изменяет процессов проверки подлинности или авторизации Windows. После развертывания BranchCache проверка подлинности по-прежнему выполняется с помощью учетных данных домена и авторизация с помощью списков управления доступом (ACL) функции остается неизменной. Кроме того другие конфигурации тоже продолжают работать так же, как они до развертывания BranchCache.

Модель безопасности BranchCache основана на создании метаданных в виде серии хэшей. Эти хэши известны также как сведения о содержимом.

После создания сведений о содержимом в обмене сообщениями BranchCache, а не фактические данные используются и передаются с помощью поддерживаемых протоколов (HTTP, HTTPS и SMB).

Кэшированные данные хранятся в зашифрованном виде и может быть недоступна для клиентов, у которых нет прав доступа к содержимому из исходного источника.  Необходимо выполнить проверку подлинности и авторизацию от исходного источника содержимого, прежде чем они смогут получить метаданные содержимого и метаданные содержимого, для доступа к кэшу в филиале, должны иметь клиентов.

### <a name="how-branchcache-generates-content-information"></a>Как BranchCache будет генерировать сведения о содержимом

Так как сведения о содержимом создаются из нескольких элементов, значения этих сведений всегда является уникальным. Сюда относятся следующие элементы:

- Фактическое содержимое (например, веб-страницы или общие файлы), из которого создаются хэши.  

- Параметры конфигурации, такие как хэширования алгоритм и размер блока. Для создания сведений о содержимом, сервер содержимого разделяет содержимое на сегменты, а сегменты — на блоки. BranchCache использует безопасные зашифрованные хэши для идентификации и проверки каждого блока и сегмента с поддержкой алгоритма хэшей SHA256.

- Секрет сервера. Все серверы содержимого должны быть настроены секретом сервера, который представляет собой двоичный параметр случайной длины.

> [!NOTE]
> Использование секрета сервера гарантирует, что клиентские компьютеры не смогут генерировать сведения о содержимом самостоятельно. Это предотвратит с помощью атаки методом подбора с поддержкой BranchCache клиентских компьютеров, чтобы угадать небольшие изменения в содержимом разных версий в ситуации, когда клиент имел доступ к предыдущей версии, но не имеет доступа к текущей версии пользователей-злоумышленников.

### <a name="content-information-details"></a>Подробные сведения о содержимом

BranchCache использует секрет сервера в качестве ключа для создания специфического хэша содержимого, посылаемого авторизованным клиентам. Этот хэш генерируется при применении алгоритма хэширования к комбинированному секрету сервера и хэшу данных.

Этот хэш называется секретом сегмента. BranchCache использует секреты сегментов для защиты обмена данными. Кроме того BranchCache создает список хэшей блоков, который представляет собой список хэшированных блоков данных, и данные хэша, которые генерируются путем хэширования списка хэшей блоков.

Сведения о содержимом содержат следующие:

- Список хэшей блоков:

    `BlockHashi = Hash(dataBlocki)   1<=i<=n`

- Хэш данных (HoD):

    `HoD = Hash(BlockHashList)`

- Секрет сегмента (Kp):

    `Kp = HMAC(Ks, HoD)`

BranchCache использует протоколы Peer Content Caching и Retrieval Framework протокола, чтобы реализовать процессы, необходимые для обеспечения безопасного кэширования и получения данных из кэшей содержимого.

Кроме того Служба BranchCache обрабатывает сведения о содержимом с тем же уровнем безопасности, который используется для обработки и передачи фактического содержимого.

## <a name="bkmk_flow"></a>Потоки сведений о содержимом и процессы

Поток сведений о содержимом и фактического содержимого делится на четыре этапа:

1.  [Процессы BranchCache: содержимое запроса](#BKMK_8)

2.  [Процессы BranchCache: поиск содержимого](#BKMK_9)

3.  [Процессы BranchCache: получение содержимого](#BKMK_10)

4.  [Процессы BranchCache: кэширование содержимого](#BKMK_11)

Эти этапы описаны в следующих разделах.

## <a name="BKMK_8"></a>Процессы BranchCache: содержимое запроса

На первом этапе в филиале клиентский компьютер запрашивает содержимое, например файла или веб-страницы с сервера содержимого в удаленных расположениях, например в главном офисе. Сервер содержимого проверяет, что клиентский компьютер права на получение запрошенного содержимого. Если клиентский компьютер авторизован и клиента и сервера содержимого BranchCache\ включена, сервер содержимого генерирует сведения о содержимом.

Затем сервер содержимого пошлет сведения о содержимом на клиентском компьютере, используя тот же протокол, бы использован для передачи фактического содержимого. 

Например если клиентский компьютер запросил веб-страницу по протоколу HTTP, сервер содержимого пошлет сведения о содержимом с помощью HTTP. По этой причине проводном уровне гарантии безопасности содержимого и на сведения о содержимом, идентичны.

После получения первой части сведений о содержимом (хэша данных и секрета сегмента) клиентский компьютер осуществляет следующие действия:

- Использует секрет сегмента (Kp) в качестве ключа шифрования (Ke).

- Генерирует идентификатор сегмента (HoHoDk) из HoD и Kp.

    `HoHoDk = HMAC(Kp, HoD + C), where C is the ASCII string "MS_P2P_CACHING" with NUL terminator.`

Основной угрозой на этом уровне является риск раскрытия секрета сегмента, однако BranchCache шифрует блоки данных содержимого, чтобы защитить этот секрет. BranchCache реализует это с помощью ключа шифрования, созданного из секрета сегмента содержимого сегмента, в котором расположены блоки содержимого.

Этот подход гарантирует, что объект, не владеющий секретом сервера, не сможет раскрыть фактическое содержимое в блоке данных. Секрет сегмента обрабатывается с тем же уровнем безопасности как сегмент открытого текста, так как знание секрета конкретного сегмента даст объекту возможность получить сегмент от узлов партнеров и расшифровать его. Знание секрета сервера не приведет немедленному получению конкретного открытого текста, но может использоваться для получения определенных типов данных из зашифрованного текста и открытия некоторых частично известных данных для подбора атак методом подбора. Секрет сервера, поэтому следует хранить в тайне.
  
## <a name="BKMK_9"></a>Процессы BranchCache: поиск содержимого

После клиентский компьютер получает сведения о содержимом, клиент использует идентификатор сегмента, чтобы найти запрошенное содержимое в локальном кэше филиала, который распределяется между клиентскими компьютерами или расположен на сервере размещенного кэша.

Если компьютер клиента настроен режим размещенного кэша, он настроен на имя компьютера сервера размещенного кэша и связывается с этим сервером для получения содержимого.

Если клиентский компьютер настроен для режима распределенного кэша, однако содержимое может храниться в нескольких кэшах на нескольких компьютерах в филиале. Клиентский компьютер должен найти, где находится содержимое до загрузки содержимого.

Если они настроены для режима распределенного кэша, клиентские компьютеры определяют расположение содержимого с помощью протокола обнаружения, основанного на протоколе динамического обнаружения веб-служб (WS-Discovery). Клиенты отправляют WS-Discovery многоадресные сообщения "Проба" для обнаружения кэшированное содержимое по сети. Сообщения "Проба" включает идентификатор сегмента, который позволяет клиентам проверить, совпадает ли запрошенное содержимое содержимое, сохраненное в кэше. Клиенты, которые получают исходное сообщение проверки отвечают пославшему запрос клиенту одноадресными сообщениями Проба-соответствие, если идентификатор сегмента соответствует содержимому, которое хранится в локальном кэше.  

Успех процесса WS-Discovery зависит от того, что клиент, который выполняет обнаружение имеет правильные сведения о содержимом, предоставленные сервером содержимого, для содержимого, которое его запрашивает.

Основную угрозу данным этапе запроса содержимого представляет раскрытие сведений, так как доступ к сведениям о содержимом подразумевает авторизованный доступ к содержимому. Чтобы снизить этот риск, в процессе обнаружения не раскрываются сведения о содержимом, кроме идентификатора сегмента, который не раскрывается о сегмент открытого текста, включающий содержимое.

Кроме того другой клиентский компьютер, пользователь-злоумышленник на одной и той же подсети может видеть трафик обнаружения BranchCache к исходному источнику содержимого, проходящий через маршрутизатор.

Если запрашиваемое содержимое не найдено в филиале, клиент запрашивает его непосредственно с сервера содержимого по глобальной.

После получения содержимого оно добавляется в локальный кэш либо на клиентском компьютере, либо на сервере размещенного кэша. В этом случае сведения о содержимом не дадут клиенту или серверу размещенного кэша добавить в локальный кэш любое содержимое, которое не соответствует хэшам. Процесс проверки содержимого на соответствие хэшам гарантирует, что в кэш будет добавлено только допустимое содержимое, и защищает целостность локального кэша.

## <a name="BKMK_10"></a>Процессы BranchCache: получение содержимого

После клиентский компьютер обнаружит нужное содержимое на узле содержимого, который сервер размещенного кэша или клиентский компьютер режим распределенного кэша, клиентский компьютер начинает процесс получения содержимого.

Сначала клиентский компьютер посылает запрос узлу содержимого на первый блок запрашиваемого. Запрос содержит идентификатор сегмента и диапазон блоков, который идентифицирует нужное содержимое. Так как возвращается только один блок, диапазон блоков содержит только один блок. (Запросы на несколько блоков в настоящее время не поддерживаются.) Клиент также сохраняет запрос в своем локальном списке невыполненных запросов.  

При получении действительного сообщения с запросом от клиента, узел содержимого проверяет, существует ли указанный в запросе блок в кэш содержимого узла содержимого.

Если на узле содержимого присутствует блок содержимого, узел посылает ответ, который содержит идентификатор сегмента, идентификатор блока, зашифрованный блок данных и вектор инициализации, используемый для шифрования блока.

Если узел содержимого не распоряжении блок содержимого, узел содержимого отправляет пустое ответное сообщение. Оно информирует клиентского компьютера, что в узле содержимого нет запрашиваемого блока. Пустое ответное сообщение содержит идентификатор сегмента и запрашиваемого блока, а также блок данных нулевого размера.

Когда клиентский компьютер получает ответ от узла содержимого, клиент проверяет, сообщение, соответствующее сообщение запроса в его списке невыполненных запросов. (Идентификатор сегмента и индекс блока должны соответствовать таковым невыполненного запроса.)

Если процесс проверки неудачен и клиентский компьютер не находит соответствующий запрос списке невыполненных запросов, сообщение удаляется клиентского компьютера.

Если процесс проверки удачен и клиентский компьютер находит соответствующий запрос списке невыполненных запросов, блок расшифровывается клиентского компьютера. Затем клиент сравнивает расшифрованный блок с соответствующим хэшем блока из сведений о содержимом, он получил с исходного сервера содержимого.

Если проверка проходит успешно, расшифрованный блок сохраняется в кэше.

Этот процесс повторяется, пока клиент все запрошенные блоки.

> [!NOTE]
> Если целые сегменты содержимого отсутствуют на одном компьютере, протокол извлечения получает и собирает содержимое из нескольких источников: набор распределенного кэша режим клиентским компьютерам с сервера размещенного кэша и — если кэше филиала не содержат полный content - исходного сервера содержимого в главном офисе.

Прежде чем BranchCache пошлет сведения о содержимом или само содержимое, данные шифруются. BranchCache шифрует блок в ответном сообщении. В Windows 7 является алгоритма шифрования по умолчанию BranchCache использует AES-128, ключ шифрования Ke и размер ключа составляет 128 бит, что обусловлено алгоритмом шифрования. 

BranchCache генерирует вектор инициализации, подходящий для алгоритма шифрования и использует ключ шифрования для шифрования блока. Затем BranchCache записывает алгоритм шифрования и вектор инициализации в сообщение. 

Серверы и клиенты никогда не обмениваются, общий доступ к или посылают друг другу ключ шифрования. Клиент получает ключ шифрования с сервера содержимого, на котором находится исходное содержимое. Затем с помощью шифрования алгоритма и вектора инициализации, полученных от сервера, он расшифровывает блок. Нет никакой другой явный способ проверки подлинности или авторизации, встроенные в протокол загрузки.

### <a name="security-threats"></a>Угрозы безопасности

Основные угрозы безопасности на этом уровне включают:

- Незаконное изменение данных:

  *Клиент, предоставляющий данные инициатору запроса, незаконно изменяет данные*. Модель безопасности BranchCache использует хэши, чтобы убедиться, что ни клиент, ни сервер не изменили данные.  

- Раскрытие информации:  

    *BranchCache посылает зашифрованное содержимое любому клиенту, который задает соответствующий идентификатор сегмента*. Идентификаторы сегментов общедоступны, поэтому любой клиент может получить зашифрованное содержимое. Тем не менее если пользователь-злоумышленник получит зашифрованное содержимое, ему необходимо также знать ключ шифрования для расшифровки содержимого. Протокол верхнего уровня выполняет проверку подлинности и передает сведения о содержимом для прошедших проверку подлинности и авторизованным клиентам. Безопасность сведений о содержимом идентична безопасности самого содержимого, и BranchCache никогда не раскрывает сведения о содержимом.  

    *Злоумышленник прослушивает сеть, чтобы получить содержимое*.  BranchCache шифрует все передачи между клиентами с помощью алгоритма AES128 секретным ключом Ke и предотвращает получение передачи данных.  Сведения о содержимом, загружаемые с сервера содержимого защищается точно так же, как сами данные были бы и поэтому не более или менее защищена от раскрытия информации, чем если BranchCache не использовалась вообще.

-   Отказ в обслуживании:

    *Клиент перегружен запросами данных*. Протоколы BranchCache включают счетчики и управления очередью таймеров, чтобы предотвратить перегрузку клиентов.

## <a name="BKMK_11"></a>Процессы BranchCache: кэширование содержимого

На клиентские компьютеры для режима распределенного кэша и серверы размещенного кэша, расположенных в филиалах кэши содержимого создаются по времени мере его получения через ГЛОБАЛЬНУЮ сеть.

Если клиентские компьютеры настроены с использованием режима размещенного кэша, они добавляют содержимое в собственные локальный кэш и предлагают данные серверу размещенного кэша. Протокол размещенного кэша предоставляет механизм для клиентов уведомить сервер размещенного кэша о наличии содержимого или сегмента.

Чтобы отправить содержимое на сервер размещенного кэша, клиент уведомляют сервер о наличии сегмента, который доступен. Затем сервер размещенного кэша получает все сведения о содержимом, связанные с предлагаемым сегментом и загружает нужные блоки в рамках сегмента, фактически требующаяся. Этот процесс повторяется, пока клиент не передаст все нужные сегменты серверу размещенного кэша.

Чтобы обновить сервер размещенного кэша с помощью протокола размещенного кэша, должны выполняться следующие требования:

- Клиентский компьютер требуется набор блоков в рамках сегмента, который он может предложить серверу размещенного кэша. Клиент должен предоставить сведения о содержимом предлагаемого сегмента; Это содержит идентификатор сегмента, хэш данных сегмента, секрет сегмента и список всех хэшей блоков, входящих в сегмент.

- Для размещенного кэша требуются серверы под управлением Windows Server 2008 R2, сервер размещенного кэша, сертификат и связанный закрытый ключ, и центр сертификации (ЦС), выдавший этот сертификат должен доверенным для клиентских компьютеров в филиале. Это позволяет клиенту и серверу успешно участвовать в серверной проверке подлинности HTTPS.

    > [!IMPORTANT]
    > Серверы размещенного кэша, работающих под управлением Windows Server 2016, Windows Server 2012 R2 или Windows Server 2012 не требуют сертификат сервера размещенного кэша и связанный закрытый ключ.  

- Клиентский компьютер настроен на имя компьютера сервера размещенного кэша и номер порта протокола управления передачей (TCP), по которой сервер размещенного кэша прослушивает трафик BranchCache. Сертификат сервера размещенного кэша ограничен этим портом. Имя компьютера сервера размещенного кэша может быть полное доменное имя (FQDN), если на сервере размещенного кэша является членом домена; или может быть NetBIOS-имя компьютера, если на сервере размещенного кэша не является членом домена.

- Клиентский компьютер активно прослушивает входящие запросы блоков. Порт, который он прослушивает, передается как часть сообщения о предложении от клиента серверу размещенного кэша. Это позволяет серверу размещенного кэша использовать протоколы BranchCache для подключения к клиентскому компьютеру и получить блоки данных сегмента.

- На сервере размещенного кэша начинает прослушивать входящие HTTP-запросы во время его инициализации.

- Если сервер размещенного кэша настроен на требование проверки подлинности клиентского компьютера, клиент и сервер размещенного кэша должны поддерживать проверку подлинности HTTPS.

### <a name="hosted-cache-mode-cache-population"></a>Заполнение кэша в режиме размещенного кэша

Процесс добавления содержимого в кэш сервера размещенного кэша в филиале начинается, когда клиент посылает запрос INITIAL_OFFER_MESSAGE, включающий идентификатор сегмента. Идентификатор сегмента в запросе INITIAL_OFFER_MESSAGE используется для получения соответствующего хэша данных сегмента, списка хэшей блоков и секрета сегмента из кэша блока сервера размещенного кэша. Если на сервере размещенного кэша уже есть все сведения о содержимом конкретного сегмента, на запрос initial_offer_message посылается ответ ОК, и запрос на загрузку блоков не посылается.

Если на сервере размещенного кэша нет всех предлагаемых блоков данных, связанных с хэшами блоков в сегменте, на запрос initial_offer_message посылается ответ INTERESTED. Клиент посылает сообщение segment_info_message, из одного сегмента, который предлагается. На сервере размещенного кэша посылает в ответ сообщение ОК и начинает загрузку недостающих блоков с предложившего клиентского компьютера.

Хэш данных сегмента, списка хэшей блоков и секрет сегмента используются для убедитесь, что загружаемое содержимое не было незаконно изменены или иным образом изменены. Загружаемые блоки добавляются в кэш блоков сервера размещенного кэша.

## <a name="bkmk_cache"></a>Безопасность кэша  
Этот раздел содержит сведения о том, как BranchCache защищает кэшированные данные на клиентских компьютерах и серверах размещенного кэша.

### <a name="client-computer-cache-security"></a>Безопасность кэша на клиентском компьютере
Самая серьезная угроза для данных, хранящихся в BranchCache, — незаконное изменение. Если злоумышленник сможет незаконно изменить содержимое и данные, хранящиеся в кэше, затем можно использовать этот ими, чтобы начать атаку на компьютеры, которые используют BranchCache. Злоумышленники могут начать атаку, заменив данные вредоносной программой. BranchCache снижает эту опасность, проверяя все содержимое с помощью хэшей блоков, которые входят в сведения о содержимом. Если злоумышленник попытается незаконно изменить эти данные, он удаляется и заменены действительными данными из исходного источника.

Другая угроза для данных, хранящихся в BranchCache, — раскрытие информации. В режиме распределенного кэша клиент кэширует только то содержимое, что запрашивает сам; Тем не менее эти данные хранятся в виде открытого текста и может быть под угрозой. Чтобы кэшу могла получать доступ только служба BranchCache, локальный кэш защищен разрешениями файловой системы, указанными в ACL. 

Хотя ACL является эффективным средством защиты кэша от несанкционированного, пользователь с правами администратора может получить доступ к кэшу, вручную изменив разрешения, указанные в ACL. BranchCache не защищает от несанкционированного использования учетной записи администратора.

Данные, хранящиеся в кэше содержимого не шифруются, поэтому если утечка данных имеет особую важность, можно использовать технологии шифрования, например BitLocker или шифрованную файловую систему (EFS). Локальный кэш, используемый BranchCache не увеличивает угрозу раскрытия информации, актуальную для компьютера в филиале; кэш содержит только копии файлов, которые присутствуют в незашифрованном виде в другом месте на диске. 

Шифрование всего диска особенно важно в средах, в которых трудно обеспечить физическую безопасность клиентов. Например шифрование всего диска поможет защитить конфиденциальные данные на мобильных компьютерах, которые могут быть удалены из филиала.

### <a name="hosted-cache-server-cache-security"></a>Безопасность кэша на сервере размещенного кэша

В режиме размещенного кэша самой большой угрозой безопасности сервера размещенного кэша является раскрытие информации. В режиме размещенного кэша BranchCache, ведет себя так же, как в режиме распределенного кэша, разрешение файловой системы защищает кэшированные данные. Разница в том, что сервер размещенного кэша хранит все содержимое, которое любой компьютер с поддержкой BranchCache в филиале, а не только данные, которые запрашивает один компьютер. Последствия несанкционированного проникновения в этот кэш могут быть значительно более серьезными, потому что риску подвергается большее количество данных.  
  
В среде размещенного кэша, где сервер размещенного кэша под управлением Windows Server 2008 R2, технологии шифрования, например BitLocker или EFS рекомендуется использовать, если какие-либо из клиентов в филиале доступа к конфиденциальным данным по глобальной. Это также необходимо, чтобы предотвратить физический доступ к размещенному кэшу, так как шифрование диска работает, только если компьютер выключен, когда злоумышленник получил к нему физический доступ.  Если компьютер был включен или находился в спящем режиме, шифрование диска не обеспечит защиту.

> [!NOTE]
> Серверы размещенного кэша, работающих под управлением Windows Server 2016, Windows Server 2012 R2 или Windows Server 2012 шифруют все данные в кэше по умолчанию, поэтому не требуется использование дополнительных технологий шифрования.

Даже если клиент работает в режиме размещенного кэша, он все равно кэширует данные локально, и может потребоваться выполнить действия, чтобы защитить локальный кэш в дополнение к кэшу на сервере размещенного кэша.
