---
title: Подтверждение работоспособности устройств
ms.topic: article
ms.assetid: 8e7b77a4-1c6a-4c21-8844-0df89b63f68d
author: brianlic-msft
ms.author: brianlic
ms.date: 10/12/2016
ms.openlocfilehash: fc5b0a3e3b3da3b329baec37888fd04c9f3adc0e
ms.sourcegitcommit: 68444968565667f86ee0586ed4c43da4ab24aaed
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/07/2020
ms.locfileid: "87995731"
---
# <a name="device-health-attestation"></a>Подтверждение работоспособности устройств

>Область применения. Windows Server 2016

Подтверждение работоспособности устройств (DHA) появилось в ОС Windows 10 в выпуске 1507. Вот что может эта функция:

-    интеграция с платформой управления мобильными устройствами (MDM) Windows 10 с соблюдением [стандартов Open Mobile Alliance (OMA)](http://openmobilealliance.org/);

-    поддержка устройств, для которых во встроенном ПО или отдельно предоставляется доверенный платформенный модуль (TPM);

-    повышение уровня корпоративной безопасности путем отслеживания и подтверждения защиты на аппаратном уровне без существенного роста эксплуатационных расходов.

Начиная с Windows Server 2016, вы сможете запускать службу DHA в роли сервера для вашей организации. Эта статья поможет вам узнать, как установить и настроить роль сервера для подтверждения работоспособности устройств.

## <a name="overview"></a>Обзор

Службы DHA можно использовать для оценки работоспособности таких устройств:

-    устройства под управлением Windows 10 и Windows 10 Mobile, поддерживающие TPM 1.2 или 2.0;
-    локальные устройства с доступом в Интернет, управляемые с помощью Active Directory; устройства без доступа в Интернет, управляемые с помощью Active Directory; устройства, управляемые с помощью Azure Active Directory или гибридного развертывания, включающего Active Directory и Azure Active Directory.


### <a name="dha-service"></a>Служба DHA

Служба DHA проверяет для устройства журналы доверенного платформенного модуля (TPM) и реестра конфигурации платформы (PCR), а затем составляет по ним отчет DHA. Корпорация Майкрософт предлагает три варианта службы DHA.

- **Облачная служба DHA**. Управляемая корпорацией Майкрософт служба DHA предоставляется бесплатно, оснащена географической балансировкой нагрузки и оптимизирована для доступа из разных регионов мира.

- **Локальная служба DHA**. Доступна в формате новой роли сервера, начиная с Windows Server 2016. Она предоставляется бесплатно всем клиентам с лицензией Windows Server 2016.

- **Облачная служба DHA**. На виртуальном узле в Microsoft Azure. Для этого варианта вам нужен виртуальный узел и лицензии для локальной службы DHA.

Служба DHA интегрируется с решениями MDM и предоставляет такие возможности:

-    объединение данных, полученных от устройства (с помощью существующих каналов для управления устройством) с отчетом DHA;
-    повышение надежности и безопасности решений благодаря данным о подтверждении и защите устройств.

Ниже приведен пример того, как можно применить DHA для более надежной защиты активов вашей организации.

1. Создайте политику, которая проверяет такие конфигурации и атрибуты загрузки:
   - Безопасная загрузка
   - BitLocker
   - ELAM
2. Решение MDM применяет эту политику и запускает действия по исправлению на основе данных из отчета DHA.  Например, можно проверить следующее:
   - включена безопасная загрузка, в устройство загружен доверенный код, загрузчик Windows не подвергался изменениям;
   - доверенный загрузчик успешно проверил цифровую подпись ядра Windows и компонентов, которые были загружены при запуске устройства;
   - процесс измеряемой загрузки создал отчет аудита, защищенный доверенным платформенным модулем, который можно проверить удаленно;
   - BitLocker был включен и защищал данные, пока устройство было отключено;
   - ELAM был включен на ранних этапах загрузки и контролировал весь процесс работы.

#### <a name="dha-cloud-service"></a>Облачная служба DHA

Облачная служба DHA предоставляет такие преимущества:

-    просматривает журналы загрузки устройства TCG и PCR, полученные от устройства, зарегистрированного в решении MDM;
-    создает защищенный отчет с контролем изменения данных (отчет DHA) о процессе запуска устройства на основе данных, собранных и защищенных доверенным платформенным модулем, установленным на устройстве;
-    через защищенный коммуникационный канал доставляет отчет DHA на сервер MDM, который запрашивал его.

#### <a name="dha-on-premises-service"></a>Локальная служба DHA

Локальная служба DHA предоставляет все возможности, доступные в облачной службе DHA.  Кроме того, она дает такие дополнительные преимущества:

 - оптимизирует производительность, так как служба DHA работает в собственном центре обработки данных;
 - гарантирует, что отчет DHA не выходит за пределы локальной сети.

#### <a name="dha-azure-cloud-service"></a>Облачная служба DHA Azure

Эта служба предоставляет те же функции, что и локальная служба DHA, но выполняется в виде виртуального узла в Microsoft Azure.

### <a name="dha-validation-modes"></a>Режимы проверки DHA

Локальную службу DHA можно настроить для работы в режиме проверки EKCert или AIKCert. В своем отчете служба DHA указывает, в каком из режимов проверки (AIKCert или EKCert) он был составлен. Если поддерживается актуальность цепочки сертификатов EKCert, режимы проверки AIKCert и EKCert обеспечивают безопасность одинаково успешно.

#### <a name="ekcert-validation-mode"></a>Режим проверки EKCert

Режим проверки EKCert оптимизирован для устройств в организации, которые не подключены к Интернету. Устройства, подключаемые к службе DHA, работающей в режиме проверки EKCert, **не имеют** прямого доступа к Интернету.

Когда DHA работает в режиме проверки EKCert, она основывается на цепочке сертификатов, поддерживаемой в рамках организации. Ее необходимо периодически обновлять (примерно 5–10 раз в год).

Корпорация Майкрософт публикует объединенные пакеты доверенных корневых и промежуточных ЦС всех авторизованных производителей доверенных платформенных модулей в виде общедоступного CAB-архива по мере получения такой информации. Вам следует загрузить этот поток, проверить его целостность и установить его на сервер подтверждения работоспособности устройства.

Пример архива: [https://go.microsoft.com/fwlink/?linkid=2097925](https://go.microsoft.com/fwlink/?linkid=2097925) .

#### <a name="aikcert-validation-mode"></a>Режим проверки AIKCert

Режим проверки AIKCert оптимизирован для производственных сред, которые имеют доступ к Интернету. Устройства, подключаемые к службе DHA, работающей в режиме проверки AIKCert, должны иметь прямой доступ к Интернету и возможность получить сертификат AIK от корпорации Майкрософт.

## <a name="install-and-configure-the-dha-service-on-windows-server-2016"></a>Установка и настройка службы DHA в ОС Windows Server 2016

Следующие разделы помогут вам установить и настроить службу DHA в ОС Windows Server 2016.

### <a name="prerequisites"></a>Предварительные требования

Вот что нужно, чтобы настроить и проверить локальную службу DHA:

- сервер под управлением ОС Windows Server 2016;
- одно или несколько клиентских устройств Windows 10 с доверенным платформенным модулем (1.2 или 2.0) в состоянии готовности, на котором запущена последняя сборка предварительной оценки Windows;
- выбор одного из режимов проверки: EKCert или AIKCert;
- такие сертификаты:
  - **SSL-сертификат DHA** — SSL-сертификат x.509 с экспортируемым закрытым ключом, связанный с доверенным корневым ЦС. Этот сертификат защищает данные DHA "в пути", в том числе при передаче с сервера на сервер (служба DHA и сервер MDM) и от сервера к клиенту (служба DHA и устройство с Windows 10).
  - **Сертификат подписи DHA SSL** — сертификат x.509 с экспортируемым закрытым ключом, связанный с доверенным корневым ЦС. Служба DHA использует этот сертификат для цифрового подписывания.
  - **Сертификат шифрования DHA SSL** — сертификат x.509 с экспортируемым закрытым ключом, связанный с доверенным корневым ЦС. Служба DHA использует этот сертификат для шифрования.


### <a name="install-windows-server-2016"></a>Установка Windows Server 2016

Установите Windows Server 2016 любым удобным для вас способом, например через службы развертывания Windows или с помощью установщика, размещенного на загрузочном носителе, USB-накопителе или в локальной файловой системе. Если вы впервые настраиваете локальную службу DHA, устанавливайте Windows Server 2016 в режиме **Возможности рабочего стола**.

### <a name="add-the-device-health-attestation-server-role"></a>Добавление роли сервера для подтверждения работоспособности устройств

Роль сервера для подтверждения работоспособности устройства и все необходимые зависимости можно установить с помощью диспетчера сервера.

После установки Windows Server 2016 устройство перезапускается и открывает диспетчер сервера. Если этого не произошло, в поле поиска меню **Пуск** найдите и щелкните элемент **Диспетчер сервера**.

1.    Щелкните **Добавить роли и компоненты**.
2.    На странице **Перед работой** нажмите кнопку **Далее**.
3.    На странице **Выбор типа установки** щелкните **Установка ролей или компонентов**, а затем нажмите кнопку **Далее**.
4.    На странице **Выбор целевого сервера** щелкните **Выберите сервер из пула серверов**, затем выберите сервер и нажмите кнопку **Далее**.
5.    На странице **Выбор ролей сервера** установите флажок **Аттестация работоспособности устройств**.
6.    Щелкните **Добавить компоненты**, чтобы установить другие необходимые службы ролей и компоненты.
7.    Щелкните **Далее**.
8.    На странице **Выбор компонентов** нажмите кнопку **Далее**.
9.    На странице **Роль веб-сервера (IIS)** нажмите кнопку **Далее**.
10.    На странице **Выберите службы роли** нажмите кнопку **Далее**.
11.    На странице **Служба аттестации работоспособности устройств** щелкните **Далее**.
12.    На странице **Подтверждение выбранных элементов для установки** нажмите кнопку **Установить**.
13.    После завершения процесса установки нажмите кнопку **Закрыть**.

### <a name="install-the-signing-and-encryption-certificates"></a>Установка сертификатов подписи и шифрования

Для установки сертификатов подписи и шифрования используйте следующий сценарий Windows PowerShell. Дополнительные сведения о отпечатке см. в разделе [как получить отпечаток сертификата](/dotnet/framework/wcf/feature-details/how-to-retrieve-the-thumbprint-of-a-certificate).

```
$key = Get-ChildItem Cert:\LocalMachine\My | Where-Object {$_.Thumbprint -like "<thumbprint>"}
$keyname = $key.PrivateKey.CspKeyContainerInfo.UniqueKeyContainerName
$keypath = $env:ProgramData + "\Microsoft\Crypto\RSA\MachineKeys\" + $keyname
icacls $keypath /grant <username>`:R

#<thumbprint>: Certificate thumbprint for encryption certificate or signing certificate
#<username>: Username for web service app pool, by default IIS_IUSRS
```

### <a name="install-the-trusted-tpm-roots-certificate-package"></a>Установка пакета доверенных сертификатов корневых ЦС для доверенного платформенного модуля

Чтобы установить пакет доверенных сертификатов корневых ЦС для доверенного платформенного модуля, разверните пакет, удалите все цепочки сертификатов, которые не являются доверенными для вашей организации, и запустите команду setup.cmd.

#### <a name="download-the-trusted-tpm-roots-certificate-package"></a>Скачивание пакета доверенных сертификатов корневых ЦС для доверенного платформенного модуля

Перед установкой пакета сертификата можно скачать последний список доверенных корневых сертификатов доверенного платформенного модуля из [https://go.microsoft.com/fwlink/?linkid=2097925](https://go.microsoft.com/fwlink/?linkid=2097925) .

> **Внимание!** Перед установкой пакета проверьте, поставлена ли цифровая подпись корпорации Майкрософт.

#### <a name="extract-the-trusted-certificate-package"></a>Извлечение пакет доверенных сертификатов
Чтобы извлечь пакет доверенных сертификатов, выполните такие команды:
```
mkdir .\TrustedTpm
expand -F:* .\TrustedTpm.cab .\TrustedTpm
```

#### <a name="remove-the-trust-chains-for-tpm-vendors-that-are-not-trusted-by-your-organization-optional"></a>Удалите цепочки доверия тех поставщиков доверенных платформенных модулей, которые *не* являются доверенными для вашей организации (необязательно)

Удалите папки любых цепочек доверия для поставщиков, которые не являются доверенными для вашей организации.

> **Примечание.** В режиме сертификата AIK требуется папка Microsoft для проверки сертификатов AIK, выданных корпорацией Майкрософт.

#### <a name="install-the-trusted-certificate-package"></a>Установка пакета доверенных сертификатов
Для установки пакета доверенных сертификатов запустите сценарий установки из CAB-файла.

```
.\setup.cmd
```

### <a name="configure-the-device-health-attestation-service"></a>Настройка службы подтверждения работоспособности устройств

Для настройки локальной службы DHA можно использовать Windows PowerShell.

```
Install-DeviceHealthAttestation -EncryptionCertificateThumbprint <encryption> -SigningCertificateThumbprint <signing> -SslCertificateStoreName My -SslCertificateThumbprint <ssl> -SupportedAuthenticationSchema "<schema>"

#<encryption>: Thumbprint of the encryption certificate
#<signing>: Thumbprint of the signing certificate
#<ssl>: Thumbprint of the SSL certificate
#<schema>: Comma-delimited list of supported schemas including AikCertificate, EkCertificate, and AikPub
```

### <a name="configure-the-certificate-chain-policy"></a>Настройка политики цепочки сертификатов

Чтобы настроить политику цепочки сертификатов, выполните следующий сценарий Windows PowerShell.

```
$policy = Get-DHASCertificateChainPolicy
$policy.RevocationMode = "NoCheck"
Set-DHASCertificateChainPolicy -CertificateChainPolicy $policy
```

## <a name="dha-management-commands"></a>Команды управления DHA

Ниже приведены некоторые командлеты Windows PowerShell, которые помогут вам управлять службой DHA.

### <a name="configure-the-dha-service-for-the-first-time"></a>Первая настройка службы DHA

```
Install-DeviceHealthAttestation -SigningCertificateThumbprint "<HEX>" -EncryptionCertificateThumbprint "<HEX>" -SslCertificateThumbprint "<HEX>" -Force
```

### <a name="remove-the-dha-service-configuration"></a>Удаление конфигурации службы DHA

```
Uninstall-DeviceHealthAttestation -RemoveSslBinding -Force
```
### <a name="get-the-active-signing-certificate"></a>Получение активного сертификата подписи

```
Get-DHASActiveSigningCertificate
```
### <a name="set-the-active-signing-certificate"></a>Установка активного сертификата подписи

```
Set-DHASActiveSigningCertificate -Thumbprint "<hex>" -Force
```

> **Примечание.** Этот сертификат должен быть развернут на сервере с запущенной службой DHA в хранилище сертификатов **LocalMachine\My**. Когда устанавливается новый активный сертификат подписи, бывший активный сертификат подписи перемещается в список неактивных сертификатов подписи.

### <a name="list-the-inactive-signing-certificates"></a>Получение списка неактивных сертификатов подписи
```
Get-DHASInactiveSigningCertificates
```

### <a name="remove-any-inactive-signing-certificates"></a>Удаление неактивных сертификатов подписи
```
Remove-DHASInactiveSigningCertificates -Force
Remove-DHASInactiveSigningCertificates  -Thumbprint "<hex>" -Force
```

> **Примечание.** В любой момент в службе может существовать только *один* неактивный сертификата (любого типа). Сертификаты следует удалять из списка неактивных сертификатов, когда они больше не требуются.

### <a name="get-the-active-encryption-certificate"></a>Получение активного сертификата шифрования

```
Get-DHASActiveEncryptionCertificate
```

### <a name="set-the-active-encryption-certificate"></a>Установка активного сертификата шифрования

```
Set-DHASActiveEncryptionCertificate -Thumbprint "<hex>" -Force
```

Этот сертификат должен быть развернут на устройстве в хранилище сертификатов **LocalMachine\My**.

Когда устанавливается новый активный сертификат шифрования, бывший активный сертификат шифрования перемещается в список неактивных сертификатов шифрования.

### <a name="list-the-inactive-encryption-certificates"></a>Получение списка неактивных сертификатов шифрования

```
Get-DHASInactiveEncryptionCertificates
```
### <a name="remove-any-inactive-encryption-certificates"></a>Удаление неактивных сертификатов шифрования

```
Remove-DHASInactiveEncryptionCertificates -Force
Remove-DHASInactiveEncryptionCertificates -Thumbprint "<hex>" -Force
```

### <a name="get-the-x509chainpolicy-configuration"></a>Получение конфигурации X509ChainPolicy

```
Get-DHASCertificateChainPolicy
```
### <a name="change-the-x509chainpolicy-configuration"></a>Изменение конфигурации X509ChainPolicy

```
$certificateChainPolicy = Get-DHASInactiveEncryptionCertificates
$certificateChainPolicy.RevocationFlag = <X509RevocationFlag>
$certificateChainPolicy.RevocationMode = <X509RevocationMode>
$certificateChainPolicy.VerificationFlags = <X509VerificationFlags>
$certificateChainPolicy.UrlRetrievalTimeout = <TimeSpan>
Set-DHASCertificateChainPolicy = $certificateChainPolicy
```

## <a name="dha-service-reporting"></a>Создание отчетов в службе DHA

Далее следует список сообщений, которые служба DHA может передавать в решение MDM.

- **200** HTTP OK. Сертификат возвращен.
- **400** . недопустимый запрос. Возможные причины: недопустимый формат запроса, недопустимый сертификат работоспособности, несоответствие подписи сертификата, недопустимый BLOB-объект подтверждения работоспособности или недопустимый BLOB-объект состояния работоспособности. Кроме того, этот ответ содержит сообщение (соответствующее схеме ответа), содержащее код ошибки и сообщение об ошибке, которые можно использовать для диагностики.
- **500** внутренняя ошибка сервера. Это может произойти, если служба по какой-либо причине не может выдавать сертификаты.
- **503**. Система регулирования отклоняет запросы, чтобы предотвратить перегрузку сервера.