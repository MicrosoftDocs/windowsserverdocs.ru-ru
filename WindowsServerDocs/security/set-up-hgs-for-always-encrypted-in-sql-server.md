---
title: Настройка службы защиты узла для Always Encrypted в SQL Server
ms.custom: na
ms.prod: windows-server-threshold
ms.topic: article
manager: dongill
author: rpsqrd
ms.technology: security-guarded-fabric
ms.date: 11/03/2018
ms.openlocfilehash: 74146e854f4183970d2b92bb26babbd1b31f0bc2
ms.sourcegitcommit: f6490192d686f0a1e0c2ebe471f98e30105c0844
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/10/2019
ms.locfileid: "70870355"
---
# <a name="setting-up-the-host-guardian-service-for-always-encrypted-with-secure-enclaves-in-sql-server"></a>Настройка службы защиты узла для Always Encrypted с помощью Secure енклавес в SQL Server 

>Относится к: Windows Server (половина ежегодного канала), Windows Server 2019, SQL Server 2019 Preview
 
[Always encrypted с безопасным енклавес](https://docs.microsoft.com/sql/relational-databases/security/encryption/always-encrypted-enclaves) в предварительной версии SQL Server 2019 — это функция, предназначенная для обеспечения конфиденциальных вычислений с конфиденциальными данными, хранящимися в базе данных. Служба защиты узлов (HGS) играет важную роль в обеспечении безопасности данных, если защищенный анклава, настроенный для Always Encrypted, является анклава памяти на основе виртуализации (VBS). Безопасность анклава памяти VBS зависит от безопасности низкоуровневой оболочки Windows и более широкого уровня безопасности компьютера, размещающего SQL Server. 

Таким образом, прежде чем клиентское приложение базы данных разрешит анклава памяти VBS, используемые Always Encrypted для выполнения вычислений с конфиденциальными данными, приложение должно быть подтверждено доверенной HGS. Аттестация подтверждает, что компьютер, на котором размещается SQL Server, содержит анклава, находится в правильном состоянии и может быть доверенным. В оставшейся части этого раздела мы будем называть компьютер, на котором размещена SQL Server, как просто главный компьютер.

Существует два взаимоисключающих способа аттестации приложения: 

- Аттестация ключа узла разрешает узел, подтверждая, что он владеет известным и надежным закрытым ключом. Для подготовительных сред рекомендуется использовать аттестацию ключа узла и физический компьютер размещения или виртуальную машину поколения 2 с SQL Server.
- Аттестация TPM проверяет измерения оборудования, чтобы убедиться, что узел выполняет только необходимые двоичные файлы и политики безопасности. Для рабочих сред рекомендуется использовать аттестацию TPM и физический хост-компьютер (не виртуальную машину) SQL Server.

Дополнительные сведения о службе защиты узла и ее возможностях см. в статье [Обзор защищенной структуры и экранированных виртуальных машин](https://docs.microsoft.com/windows-server/virtualization/guarded-fabric-shielded-vm/guarded-fabric-and-shielded-vms). Обратите внимание, что несмотря на то, что документы говорят о экранированных виртуальных машинах, эти же средства защиты, архитектура и рекомендации применяются к SQL Server Always Encrypted с помощью VBS енклавес. 

Эта статья поможет вам настроить службу HGS в рекомендуемой конфигурации. 

## <a name="prerequisites"></a>Предварительные требования 

В этом разделе описаны предварительные требования для HGS и хостовых компьютеров. 

### <a name="hgs-servers"></a>Серверы HGS

- 1-3. серверы для запуска HGS. 

  > [!NOTE]
  > Для тестовой или подготовительной среды требуется только 1 сервер HGS.

  Эти серверы должны быть тщательно защищены, так как они определяют, какие компьютеры могут выполнять экземпляры SQL Server, используя Always Encrypted с безопасным енклавес. 
  Рекомендуется, чтобы различные администраторы управляли кластером HGS и выполняли HGS на физическом оборудовании, изолированном от остальной части инфраструктуры, или в отдельных структурах виртуализации или подписках Azure.

  - Windows Server 2019 Standard или Datacenter Edition.
  - 2 ЦП
  - 8 ГБ ОЗУ
  - хранилище 100 ГБ

  Можно использовать [канал долгосрочного обслуживания (LTSC)](https://docs.microsoft.com/windows-server/get-started/semi-annual-channel-overview#long-term-servicing-channel-ltsc) или [полугодовой канал](https://docs.microsoft.com/windows-server/get-started/semi-annual-channel-overview#semi-annual-channel). 
  Чтобы зарегистрироваться и загрузить предварительную версию Windows Server Insider Preview, см. статью [Приступая к работе с программой предварительной оценки Windows](https://insider.windows.com/for-business-getting-started-server/).

- Выберите имя нового Active Directoryного леса, созданного службой защиты узла. 
  HGS не следует присоединять к существующему корпоративному домену и должны иметь отдельные администраторы, управляющие ИТ.   

- Правила брандмауэра и маршрутизации, разрешающие входящий трафик HTTP (TCP 80) или HTTPS (TCP 443) на узлах службы защитника узлов из: 

  - Компьютеры, на которых работает SQL Server
  - Компьютеры, на которых выполняются клиентские приложения базы данных (например, веб-серверы), которые выдают запросы к базе данных и используют Always Encrypted с Secure енклавес. 

### <a name="sql-server-host-machines"></a>SQL Server хостных компьютеров

- Ваш экземпляр SQL Server должен выполняться на компьютере, который соответствует следующим требованиям:

  - Windows 
    - Windows 10 Корпоративная, версия 1809  
    - Windows Server 2019 Datacenter (половина ежегодного канала), версия 1809
    - Windows Server 2019 Datacenter
  - Физический компьютер для рабочей среды или виртуальная машина поколения 2 для тестирования (Обратите внимание, что Azure не поддерживает виртуальные машины поколения 2)
  - Общие требования, перечисленные в [требованиях к оборудованию и программному обеспечению для установки SQL Server](https://docs.microsoft.com/sql/sql-server/install/hardware-and-software-requirements-for-installing-sql-server?view=sql-server-2017).   

  Можно использовать [канал долгосрочного обслуживания (LTSC)](https://docs.microsoft.com/windows-server/get-started/semi-annual-channel-overview#long-term-servicing-channel-ltsc) или [полугодовой канал](https://docs.microsoft.com/windows-server/get-started/semi-annual-channel-overview#semi-annual-channel). 
  Чтобы зарегистрироваться и загрузить предварительную версию Windows Server Insider Preview, см. статью [Приступая к работе с программой предварительной оценки Windows](https://insider.windows.com/for-business-getting-started-server/).

- Требования, относящиеся к выбранному режиму аттестации:
  - **Режим TPM** является самым надежным режимом аттестации и будет использовать ДОВЕРЕННЫЙ ПЛАТФОРМЕННЫЙ модуль (TPM) (TPM) для криптографической проверки того, что хост-компьютеры известны вашему центру обработки данных (с использованием уникального идентификатора из каждого доверенного платформенного модуля), работающего надежного оборудования и встроенного по. конфигурации (с использованием базового модуля TPM) и выполнение надежного ядра и кода пользовательского режима (с помощью управления приложениями в Защитнике Windows). Для использования режима TPM требуется следующее оборудование: 
    - Модуль TPM 2,0 установлен и включен 
    - Безопасная загрузка с включенной политикой безопасной загрузки (Майкрософт) (не включать политику CA стороннего центра безопасных загрузок или какие-либо пользовательские политики)
    - IOMMU (Intel VT-d или AMD IOV) для предотвращения атак с прямым доступом к памяти 

  - **Режим ключа узла** использует пару асимметричных ключей (аналогично ключам SSH) для обнаружения и авторизации компьютеров размещения, которые требуется запускать SQL Server. Этот режим проще в установке и не имеет конкретных требований к оборудованию, но не проверяет программное обеспечение или встроенное по, работающее на хост-компьютерах.  

Чтобы проверить совместимость доверенного платформенного модуля, выполните следующие команды на хост-компьютере, где планируется выполнять SQL Server с помощью Always Encrypted с Secure енклавес. для использования аттестации TPM в списке поддерживаемых Спекверсионс должен присутствовать "2,0":

```powershell
Get-CimInstance -ClassName Win32_Tpm -Namespace root/cimv2/Security/MicrosoftTpm 
```

## <a name="set-up-the-first-hgs-node"></a>Настройка первого узла HGS 

Служба защиты узла работает в конфигурации с высоким уровнем доступности, используя кластер из трех узлов. Рекомендуется полностью настроить один узел перед добавлением других узлов. 

Выполните все приведенные ниже команды в сеансе PowerShell с повышенными привилегиями.

1. [!INCLUDE [Install the HGS server role](../../includes/guarded-fabric-install-hgs-server-role.md)]

2. [!INCLUDE [Install HGS by default](../../includes/install-hgs-default.md)] 

3. [!INCLUDE [Determine a DNN](../../includes/guarded-fabric-initialize-hgs-default-step-one.md)]

   Для Always Encrypted с безопасным енклавес компьютеры размещения, на которых запущены SQL Server и компьютеры, на которых выполняются клиентские приложения базы данных, должны связаться с HGS, хотя только на узлах требуется аттестация.

4. После перезагрузки компьютера будет установлена HGS, а сервер также будет контроллером домена с Active Directory настроенным. 
   Во время настройки Active Directory учетная запись администратора локального компьютера добавляется в группу "Администраторы домена", и только члены этой группы могут входить на контроллер домена.
   Войдите, используя учетную запись администратора домена (например, administrator@bastion.local или бастиона. локал\администратор), или создайте другую учетную запись администратора домена для входа, а затем настройте службу аттестации.
   Вам потребуется выбрать доверенный платформенный модуль или аттестацию ключа узла и выполнить соответствующую команду. 
   В поле Хгссервиценаме укажите DNN, который вы выбрали.

   Для режима TPM:

   ```powershell
   Initialize-HgsAttestation -HgsServiceName 'hgs' -TrustTpm
   ```

   Для режима ключа узла:

   ```powershell
   Initialize-HgsAttestation -HgsServiceName 'hgs' -TrustHostKey 
   ```

5. Убедитесь, что компьютеры размещения, на которых выполняется SQL Server, смогут разрешать DNS-имена новых членов домена HGS, настроив сервер пересылки с корпоративных DNS-серверов на новый контроллер домена HGS. Если вы используете DNS Windows Server, вы можете настроить условный сервер пересылки, выполнив следующие команды в консоли PowerShell с повышенными привилегиями на DNS-сервере в Организации. Замените имена и адреса в синтаксисе Windows PowerShell, как требуется для вашей среды. После добавления дополнительных узлов HGS выполните эту команду еще раз, чтобы добавить их в качестве главных серверов.

   ```powershell
   Add-DnsServerConditionalForwarderZone -Name <HGS domain name> -ReplicationScope "Forest" -MasterServers <IP addresses of HGS servers>
   ```

## <a name="set-up-additional-hgs-nodes-for-production-deployments"></a>Настройка дополнительных узлов HGS для рабочих развертываний

Чтобы добавить узлы в кластер, выполните следующие команды в сеансе PowerShell с повышенными привилегиями. 

1. [!INCLUDE [Install the HGS server role](../../includes/guarded-fabric-install-hgs-server-role.md)]

2. Задайте сопоставитель клиента DNS, чтобы он указывал на основной сервер HGS, чтобы он мог разрешить доменное имя HGS. Если вы используете сервер с возможностями рабочего стола, это можно сделать в центре управления сетями и общим доступом. В Server Core для установки DNS-адреса можно использовать средство **SCONFIG. exe** , параметр 8 или **Set-днсклиентсервераддресс** . 

3. Далее мы повышение этого сервера до контроллера домена. Для выполнения этой задачи потребуются учетные данные администратора домена. После выполнения команды будет предложено ввести пароль в режиме восстановления служб каталогов. 

   ```powershell
   $HgsDomainName = 'bastion.local' 
   $HgsDomainCredential = Get-Credential 
 
   Install-HgsServer -HgsDomainName $HgsDomainName -HgsDomainCredential $HgsDomainCredential -Restart 
   ```

4. [!INCLUDE [Initialize HGS](../../includes/guarded-fabric-initialize-hgs-on-the-node.md)] 

## <a name="configure-hgs-for-https"></a>Настройка HGS для HTTPS 

По умолчанию при инициализации сервера HGS он настраивает веб-сайты IIS для обмена данными только по протоколу HTTP.

> [!NOTE]
> Настройка HTTPS с помощью хорошо известного и доверенного сертификата сервера HGS необходима для предотвращения атак типа "злоумышленник в середине" и поэтому рекомендуется для рабочих развертываний.

[!INCLUDE [Configure HTTPS](../../includes/configure-hgs-for-https.md)] 

> [!NOTE]
> Для Always Encrypted с защищенным енклавес SSL-сертификат должен быть доверенным на обоих хост-компьютерах, где работают SQL Server, а компьютеры, на которых выполняются клиентские приложения базы данных, должны обращаться к HGS. 

## <a name="collect-attestation-info-from-the-host-machines"></a>Получение сведений об аттестации с хостовых компьютеров

После настройки HGS необходимо настроить с помощью сведений об аттестации от хост-компьютеров, чтобы знать, какие компьютеры должны быть разрешены для выполнения конфиденциальных вычислений с помощью Always Encrypted и VBS Secure енклавес. Эти действия зависят от используемого режима аттестации. 

### <a name="collect-tpm-attestation-artifacts"></a>Получение артефактов аттестации TPM 

Если вы используете режим TPM, выполните следующие команды в сеансе PowerShell с повышенными привилегиями на каждом хосте компьютера, чтобы установить поддержку аттестации и получить сведения, необходимые для регистрации в службе защиты узла. 

1. Чтобы установить клиент HGS на размещающем компьютере, установите компонент защищенного узла, который также установит Hyper-V. 
   Хотя виртуальные машины на этом компьютере не будут работать, гипервизор требуется для включения функций безопасности на основе виртуализации, которые изолируют VBS енклавес.

   ```powershell
   Enable-WindowsOptionalFeature -Online -FeatureName HostGuardian -All 
   ```

2. Перезагрузите компьютер при появлении запроса на завершение установки Hyper-V. 
3. Создайте политику целостности кода, чтобы ограничить программное обеспечение, которое может выполняться в системе. 
   Все политики управления приложениями в Защитнике Windows достаточны. 
   Если на сервере выполняется только программное обеспечение Майкрософт, то для вас будет быстро создана политика с помощью следующих команд. 
   Политика будет находиться в режиме аудита, то есть она будет регистрировать в журнале событие с несанкционированным кодом, но не будет работать.  

   ```powershell
   mkdir C:\artifacts
   Copy-Item C:\Windows\Schemas\CodeIntegrity\ExamplePolicies\AllowMicrosoft.xml C:\artifacts\AllowMicrosoft-Audit.xml 
   Set-RuleOption -FilePath C:\artifacts\AllowMicrosoft-Audit.xml -Option 3 
   ConvertFrom-CIPolicy -XmlFilePath C:\artifacts\AllowMicrosoft-Audit.xml -BinaryFilePath C:\artifacts\AllowMicrosoft-Audit.bin 
   Copy-Item C:\artifacts\AllowMicrosoft-Audit.bin C:\Windows\System32\CodeIntegrity\SIPolicy.p7b 
   Restart-Computer 
   ```

   Элемент управления приложениями в Защитнике Windows обладает множеством функций для обеспечения разнообразных показателей безопасности. 
   Если необходимо разрешить программное обеспечение сторонних разработчиков или настроить политику по умолчанию, см. [рекомендации по развертыванию системы управления приложениями в Защитнике Windows](https://docs.microsoft.com/windows/security/threat-protection/windows-defender-application-control/windows-defender-application-control-deployment-guide).   


4. Убедитесь, что на компьютере запущена система безопасности на основе виртуализации, с помощью следующей команды. 
   Вы будете уверены, что VBS выполняется, если в поле Девицегуардсекуритисервицесруннинг указано "Хипервисоренфорцедкодеинтегрити". 
   Если она не запущена, скачайте [средство Device Guard Readiness Tool](https://www.microsoft.com/download/details.aspx?id=53337) и выполните команду "DG_Readiness. ps1-Enable-обязательная политика hvci", чтобы включить его.  
   
   ```powershell
   Get-ComputerInfo -Property DeviceGuard* 
   ```

5. Собирайте идентификатор доверенного платформенного модуля и базовый уровень:

   ```powershell 
   (Get-PlatformIdentifier -Name $env:computername).Save("C:\artifacts\TpmID-$env:computername.xml") 
   Get-HgsAttestationBaselinePolicy -SkipValidation -Path "C:\artifacts\TpmBaseline-$env:computername.tcglog" 
   ```
   
6. Скопируйте файлы XML, ткглог и bin из К:\артифактс на сервер HGS.
7. Если это первый узел доверенного платформенного модуля, добавляемый на сервер HGS, необходимо установить Доверенные корневые сертификаты доверенного платформенного модуля на каждом сервере HGS. 
   Чтобы выполнить этот шаг, следуйте [указаниям в документации по HGS](https://docs.microsoft.com/windows-server/virtualization/guarded-fabric-shielded-vm/guarded-fabric-install-trusted-tpm-root-certificates) .
8. На сервере HGS Авторизуйте этот узел для передачи аттестации. 
   В сценариях ниже предполагается, что 3 файла были скопированы в C:\temp на сервере HGS и что имя компьютера сервера — «Server a». 
   Измените пути и имена в соответствии с собственной средой. 

   ```powershell
   Add-HgsAttestationTpmHost -Name ServerA -Path C:\temp\TpmID-ServerA.xml 
   Add-HgsAttestationTpmPolicy -Name ServerA-Baseline -Path C:\temp\TpmBaseline-ServerA.tcglog 
   Add-HgsAttestationCiPolicy -Name AllowMicrosoft-Audit -Path C:\temp\AllowMicrosoft-Audit.bin 
   ```

9. Теперь ваш первый сервер готов к аттестации! 
   На главном компьютере выполните следующую команду, чтобы сообщить ему, где следует выполнить аттестацию (измените имя DNS для кластера HGS, обычно вы будете использовать имя службы HGS в сочетании с доменным именем HGS). 
   При возникновении ошибки Хостунреачабле убедитесь, что вы можете разрешить и проверить связь с DNS-именами серверов HGS. 

   ```powershell
   Set-HgsClientConfiguration -AttestationServerUrl https://hgs.bastion.local/Attestation -KeyProtectionServerUrl https://hgs.bastion.local/KeyProtection/ 
   ```

10. Результат приведенной выше команды должен показывать, что Аттестатионстатус = пройден. Если это не так, см. статью об ошибках [аттестации](https://docs.microsoft.com/windows-server/virtualization/guarded-fabric-shielded-vm/guarded-fabric-troubleshoot-hosts#attestation-failures) для получения инструкций по устранению этой ошибки.   
11. Повторите шаги 1-10 для каждого главного компьютера. 
    Если используется одинаковое оборудование, вам не нужно захватывать новую политику базовых показателей или конфигурации для каждого компьютера. 
    В базовом плане с первого сервера будут рассмотрены все идентичные настроенные компьютеры, и политику CI можно будет повторно использовать на нескольких компьютерах, пока программное обеспечение Майкрософт является единственным программным обеспечением на компьютере.

### <a name="collecting-host-keys"></a>Идет сбор ключей узла 

> [!NOTE] 
> Аттестация ключа узла рекомендуется только для использования в тестовых средах. Аттестация TPM обеспечивает надежную гарантию, что VBS енклавес обработку конфиденциальных данных на SQL Server выполняет доверенный код, а на компьютерах настроены рекомендуемые параметры безопасности. 

Если вы решили настроить HGS в режиме аттестации ключа узла, необходимо создать и собираются ключи с каждого хостового компьютера и зарегистрировать их в службе защиты узла. 

1. Чтобы получить клиент HGS, установленный на размещающем компьютере, установите компонент защищенного узла, который также установит Hyper-V. 
   Несмотря на то, что виртуальные машины на этом компьютере не будут работать, низкоуровневая оболочка необходима для включения функций безопасности на основе виртуализации, которые изолируют енклавес VBS, Always Encrypted выполняющие запросы. 

   ```powershell
   Enable-WindowsOptionalFeature -Online -FeatureName HostGuardian -All 
   ```

2. Перезагрузите компьютер при появлении запроса на завершение установки Hyper-V.
3. Создание уникального ключа узла и экспорт полученного открытого ключа в файл. 

   ```powershell
   Set-HgsClientHostKey 
   mkdir C:\artifacts 
   Get-HgsClientHostKey -Path C:\artifacts\$env:computername.cer 
   ```
   
   Кроме того, можно указать отпечаток, если вы хотите использовать собственный сертификат. 
   Это может быть полезно, если требуется предоставить общий доступ к сертификату на нескольких компьютерах или использовать сертификат, привязанный к доверенному платформенному модулю или HSM. Ниже приведен пример создания сертификата, привязанного к доверенному платформенному модулю (который предотвращает кражу и использование закрытого ключа на другом компьютере и требует только доверенного платформенного модуля 1,2):

   ```powershell
   $tpmBoundCert = New-SelfSignedCertificate -Subject “Host Key Attestation ($env:computername)” -Provider “Microsoft Platform Crypto Provider”
   Set-HgsClientHostKey -Thumbprint $tpmBoundCert.Thumbprint
   ```

4. Скопируйте ключ узла в службу защиты узла. 
5. Зарегистрируйте ключ узла в любом узле HGS, используя для своей среды соответствующее имя и путь: 

   ```powershell
   Add-HgsAttestationHostKey -Name 'ServerA' -Path C:\temp\ServerA.cer 
   ``` 

6. Теперь ваш первый сервер готов к аттестации! 
   На главном компьютере выполните следующую команду, чтобы сообщить ему, где следует выполнить аттестацию (измените имя DNS для кластера HGS, обычно вы будете использовать имя службы HGS в сочетании с доменным именем HGS). 
   При возникновении ошибки Хостунреачабле убедитесь, что вы можете разрешить и проверить связь с DNS-именами серверов HGS.    

   ```powershell
   Set-HgsClientConfiguration -AttestationServerUrl http://hgs.bastion.local/Attestation -KeyProtectionServerUrl http://hgs.bastion.local/KeyProtection/  
   ```

7. Результат приведенной выше команды должен показывать, что Аттестатионстатус = пройден. 
   Если возникает ошибка Хостунреачабле, это означает, что хост-компьютер не может взаимодействовать с HGS. 
   Убедитесь, что разрешение DNS настроено между хост-компьютером и серверами HGS и что вы можете проверить связь с серверами. 
   Ошибка Унаусоризедхост указывает, что открытый ключ не был зарегистрирован на сервере HGS — повторите шаги 4 и 5, чтобы устранить эту ошибку. 
   Если все остальное не удается, выполните команду Clear-Хгсклиенсосткэй и повторите шаги 3-6.   

8. Повторите шаги 1-7 для каждого сервера, который будет выполняться SQL Server Always Encrypted с помощью VBS енклавес.     


