---
title: Настройка службы защиты узла для постоянного шифрования в SQL Server
ms.custom: na
ms.prod: windows-server-threshold
ms.topic: article
manager: dongill
author: rpsqrd
ms.technology: security-guarded-fabric
ms.date: 11/03/2018
ms.openlocfilehash: 2f800dfa01077287f8200dd8abea0be899776683
ms.sourcegitcommit: 0d0b32c8986ba7db9536e0b8648d4ddf9b03e452
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2019
ms.locfileid: "59866695"
---
# <a name="setting-up-the-host-guardian-service-for-always-encrypted-with-secure-enclaves-in-sql-server"></a>Настройка службы защиты узла для постоянного шифрования с помощью безопасного enclaves в SQL Server 

>Относится к: Windows Server (полугодовой канал), Windows Server 2019, предварительной версии SQL Server 2019
 
[Всегда зашифрованы с помощью безопасного enclaves](https://docs.microsoft.com/sql/relational-databases/security/encryption/always-encrypted-enclaves) в SQL Server 2019 Предварительная версия — это функция, предназначенная для включения конфиденциальных вычисления для конфиденциальных данных, хранящихся в базе данных. Службы Защитника узлов (HGS) играет важную роль в ваши данные хранятся безопасно, при безопасным анклавом, настроенный для Always Encrypted, безопасность на основе виртуализации (VBS) памяти анклава. Безопасность анклава VBS памяти зависит от безопасности низкоуровневой оболочки Windows и, более широко, безопасность компьютера, где размещен SQL Server. 

Таким образом прежде чем приложение базы данных клиента разрешает анклава VBS памяти, используемый для постоянного шифрования для выполнения вычислений с конфиденциальными данными, приложение необходимо оценить, требуется ли с доверенных HGS. Аттестация является доказательством компьютере, где размещен SQL Server, который содержит анклава, находится в правильном состоянии и можно будет считать надежным. Для остальной части этого раздела мы будем называть компьютере, где размещен SQL Server в качестве просто хост-компьютере.

Существует два взаимоисключающих способа для приложения, чтобы оценить, требуется ли: 

- Аттестация ключей узла авторизует узел подтверждая он содержит закрытый ключ, известным и надежным. Аттестация ключей узла и физических хост-компьютере или виртуальной машины поколения 2 под управлением SQL Server рекомендуется подготовительных средах.
- Аттестация доверенного платформенного МОДУЛЯ проверяет оборудования, чтобы убедиться, что узел выполняет только правильные двоичные файлы и политики безопасности измерения. Аттестация доверенного платформенного МОДУЛЯ и физических хост-компьютере (не виртуальная машина) под управлением SQL Server рекомендуется для рабочей среды.

Дополнительные сведения о службе защиты узла и что эта служба позволяет оценить, см. в разделе [защищенных структуры и экранированных виртуальных машин Обзор](https://docs.microsoft.com/windows-server/virtualization/guarded-fabric-shielded-vm/guarded-fabric-and-shielded-vms). Обратите внимание, что несмотря на то, что документы говорит о экранированные виртуальные машины, аналогичные средства защиты, архитектуры и рекомендации применяются к SQL Server Always Encrypted с использованием VBS enclaves. 

Эта статья поможет вам настроить HGS в рекомендуемой конфигурации. 

## <a name="prerequisites"></a>предварительные требования 

В этом разделе рассматриваются предварительные требования к компьютерам с HGS и узла. 

### <a name="hgs-servers"></a>Серверами HGS

- для обеспечения работы HGS серверы 1 – 3. 

  >[!NOTE]
  >Только один сервер HGS является обязательным для тестирования или подготовительной среде.

  Эти серверы должны быть надежно защищены, так как они управляют тем, какие машины могут работать с помощью постоянного шифрования с помощью безопасного enclaves экземпляры SQL Server. 
  Рекомендуется, что различным администраторам управлять кластером HGS и выполнение HGS на физическом оборудовании, изолированным от остальной инфраструктуры, или структура отдельных виртуализации или подписки Azure.

  - Windows Server 2019 Standard или Datacenter edition.
  - 2 процессора
  - 8 ГБ ОЗУ
  - 100 ГБ в хранилище

  Можно использовать либо [канал долгосрочного обслуживания (LTSC)](https://docs.microsoft.com/windows-server/get-started/semi-annual-channel-overview#long-term-servicing-channel-ltsc) или [Semi-Annual Channel](https://docs.microsoft.com/windows-server/get-started/semi-annual-channel-overview#semi-annual-channel). 
  Зарегистрируйтесь и загрузите Windows Server Insider Preview, см. в разделе [Приступая к работе с программой Windows Insider](https://insider.windows.com/for-business-getting-started-server/).

- Выберите имя для нового леса Active Directory, созданные службы защиты узла. 
  HGS не должен быть присоединен к существующей корпоративный домен и должен иметь несколько администраторов, управлять им.   

- Брандмауэр и правила маршрутизации, чтобы разрешить входящий HTTP (TCP 80) или трафик HTTPS (TCP-порт 443) на узлах службы защиты узла из: 

  - Компьютеры под управлением SQL Server
  - Компьютеры под управлением клиентских приложений базы данных (например, веб-серверы), которые выдавать запросы к базе данных и использование постоянного шифрования с безопасной enclaves. 

### <a name="sql-server-host-machines"></a>Хост-компьютеры SQL Server

- Экземпляр SQL Server следует запускать на компьютере, который соответствует следующим требованиям:

  - Windows: 
    - Windows 10 корпоративная версии 1809  
    - Windows Server Datacenter 2019 г. (полугодовой канал), версия 1809
    - Центр обработки данных Windows Server 2019 г.
  - Физический компьютер для производства или виртуальной машины поколения 2 для тестирования (Обратите внимание, что Azure не поддерживает виртуальные машины поколения 2)
  - Общие требования, перечисленные в [оборудованию и программному обеспечению для установки SQL Server](https://docs.microsoft.com/sql/sql-server/install/hardware-and-software-requirements-for-installing-sql-server?view=sql-server-2017).   

  Можно использовать либо [канал долгосрочного обслуживания (LTSC)](https://docs.microsoft.com/windows-server/get-started/semi-annual-channel-overview#long-term-servicing-channel-ltsc) или [Semi-Annual Channel](https://docs.microsoft.com/windows-server/get-started/semi-annual-channel-overview#semi-annual-channel). 
  Зарегистрируйтесь и загрузите Windows Server Insider Preview, см. в разделе [Приступая к работе с программой Windows Insider](https://insider.windows.com/for-business-getting-started-server/).

- Требования, относящиеся к режим выбранного аттестации:
  - **Режим доверенного платформенного МОДУЛЯ** надежный режим аттестации и будут выполнять криптографически проверить, что хост-компьютерах известны вашего центра обработки данных (используя уникальный идентификатор из каждого доверенного платформенного МОДУЛЯ), под управлением доверенным оборудования и встроенного по доверенного платформенного модуля (TPM) конфигурации (с помощью базового доверенного платформенного МОДУЛЯ), работающих под управлением trustworthy ядра и код пользовательского режима (с помощью управления приложениями в Защитнике Windows). Для использования режима доверенного платформенного МОДУЛЯ требуется следующее оборудование: 
    - Модуль TPM 2.0 установлена и включена 
    - Безопасная загрузка включена политика безопасной загрузки Майкрософт (не включайте сторонних ЦС безопасной загрузки политику и пользовательских политик)
    - IOMMU (Intel VT-d или AMD IOV) для предотвращения атак доступа к памяти 

  - **Режим ключа узла** использует пары асимметричных ключей (так как ключи SSH) для идентификации и авторизации хост-компьютеры, для выполнения SQL Server. Этот режим легко настраивается и не поддерживает все собственные требования к оборудованию, но не будет проверять программного обеспечения и встроенного по на хост-компьютеры.  

Чтобы проверить, подходит ли доверенный платформенный модуль, выполните следующие команды на хост-компьютере, где планируется запустить SQL Server с помощью постоянного шифрования с помощью безопасного enclaves. «2.0» должны находиться в списке поддерживаемых SpecVersions для использования аттестации доверенного платформенного МОДУЛЯ:

```powershell
Get-CimInstance -ClassName Win32_Tpm -Namespace root/cimv2/Security/MicrosoftTpm 
```

## <a name="set-up-the-first-hgs-node"></a>Настройте первый узел HGS 

Служба защиты узла работает в высокодоступной конфигурации с помощью 3-узлового кластера. Рекомендуется настроить один узел полностью перед добавлением других узлов. 

Запустите все из следующих команд в сеансе PowerShell с повышенными привилегиями.

1. [!INCLUDE [Install the HGS server role](../../includes/guarded-fabric-install-hgs-server-role.md)]

2. [!INCLUDE [Install HGS by default](../../includes/install-hgs-default.md)] 

3. [!INCLUDE [Determine a DNN](../../includes/guarded-fabric-initialize-hgs-default-step-one.md)]

   Для постоянного шифрования с помощью безопасного enclaves хост-компьютеры под управлением SQL Server и компьютеров, которые запуска клиентских приложений базы данных, их необходимо обратитесь в службу HGS, хотя только хост-компьютеры требуются аттестации.

4. Когда компьютер перезагрузится, HGS будет установлено, и сервер также будет контроллером домена с Active Directory настроена. 
   Во время настройки Active Directory учетной записи администратора локального компьютера добавляется в группу "Администраторы домена", и только члены этой группы можно войти на контроллер домена.
   Вход с помощью учетной записи администратора домена (например, administrator@bastion.local или bastion.local\administrator) или создать другую учетную запись администратора домена для входа, а затем настройте службу аттестации.
   Необходимо будет выбрать аттестации ключей доверенного платформенного МОДУЛЯ или узла и запуск соответствующей команды. 
   Для HgsServiceName укажите DNN, вы выбрали.

   Для режима доверенного платформенного МОДУЛЯ:
   ```powershell
   Initialize-HgsAttestation -HgsServiceName 'hgs' -TrustTpm
   ```

   Для режима ключа узла:
   ```powershell
   Initialize-HgsAttestation -HgsServiceName 'hgs' -TrustHostKey 
   ```

5. Убедитесь, что хост-компьютеры, работающие под управлением SQL Server будет иметь возможность разрешения DNS-имена новых членов домена HGS, настроив сервер пересылки из корпоративной DNS-серверы, на новом контроллере домена HGS. Если вы используете Windows Server DNS, можно настроить сервер условной пересылки, выполнив следующие команды в консоль PowerShell с повышенными привилегиями на DNS-сервере в вашей организации. Замените имена и адреса в синтаксисе Windows PowerShell ниже, при необходимости для вашей среды. Добавив дополнительные узлы HGS, выполните эту команду еще раз, чтобы добавить их в качестве главных серверов.

   ```powershell
   Add-DnsServerConditionalForwarderZone -Name <HGS domain name> -ReplicationScope "Forest" -MasterServers <IP addresses of HGS servers>
   ```

## <a name="set-up-additional-hgs-nodes-for-production-deployments"></a>Настройка дополнительных узлов HGS в рабочей среде

Чтобы добавить узлы в кластер, выполните следующие команды в сеансе PowerShell с повышенными привилегиями. 

1. [!INCLUDE [Install the HGS server role](../../includes/guarded-fabric-install-hgs-server-role.md)]

2. Задайте Сопоставитель DNS-клиента для указания сервера-источника HGS, чтобы он мог разрешить имя домена HGS. Если вы используете сервер с рабочим столом, это можно сделать в центр управления сетями и общим доступом. На Server Core, можно использовать **sconfig.exe** инструмент, 8, параметр или **DnsClientServerAddress набора** задать DNS-адрес. 

3. Далее мы будет повысить уровень этого сервера до контроллера домена. Потребуются учетные данные администратора домена для выполнения этой задачи и будет предложено ввести пароль режима восстановления служб каталогов после выполнения команды. 

   ```powershell
   $HgsDomainName = 'bastion.local' 
   $HgsDomainCredential = Get-Credential 
 
   Install-HgsServer -HgsDomainName $HgsDomainName -HgsDomainCredential $HgsDomainCredential -Restart 
   ```

4. [!INCLUDE [Initialize HGS](../../includes/guarded-fabric-initialize-hgs-on-the-node.md)] 

## <a name="configure-hgs-for-https"></a>Настройка HGS для использования протокола HTTPS 

По умолчанию при инициализации сервера HGS он настраивает веб-сайтов IIS для взаимодействия только протокол HTTP.

>[!NOTE]
>Настройка HTTPS, используя сертификаты серверов HGS хорошо известного и надежного необходима для предотвращения атак man-in--middle и поэтому рекомендуется для рабочих развертываний.

[!INCLUDE [Configure HTTPS](../../includes/configure-hgs-for-https.md)] 

>[!NOTE]
>Для постоянного шифрования с помощью безопасного enclaves SSL-сертификат должен быть доверенным на обоих компьютерах узлов под управлением SQL Server и компьютеров, выполняющих клиентских приложений базы данных, понадобится HGS. 

## <a name="collect-attestation-info-from-the-host-machines"></a>Собирать сведения аттестации с компьютеров узла

После настройки HGS, ему необходимо настроить таким образом, чтобы он знает, какие машины должен быть авторизован для выполнения конфиденциальных вычислений с помощью постоянного шифрования и VBS безопасного enclaves данными Аттестация с хост-компьютерах. Эти действия различаются в зависимости от используемого режима аттестации. 

### <a name="collect-tpm-attestation-artifacts"></a>Собирать артефакты аттестации доверенного платформенного МОДУЛЯ 

Если вы используете режим TPM, выполните следующие команды в сеансе PowerShell с повышенными привилегиями на каждый хост-компьютере установить поддержку аттестации и собирать сведения, необходимые вам для регистрации в службе защиты узла. 

1. Чтобы установить клиент HGS на хост-компьютере, установите компонент защищенный узел, который также будет установлен Hyper-V. 
   Пока вы не будет работать виртуальные машины на этом компьютере, низкоуровневая оболочка необходим для включения функций безопасности на основе виртуализации, которые изолировать VBS enclaves.

   ```powershell
   Enable-WindowsOptionalFeature -Online -FeatureName HostGuardian -All 
   ```

2. Перезагрузите компьютер при появлении запроса для завершения установки Hyper-v. 
3. Создайте политику целостности кода для ограничения того, какое программное обеспечение можно запустить в системе. 
   Достаточно любую политику управления приложениями в Защитнике Windows. 
   Если программное обеспечение Майкрософт выполняются только на сервере, следующие команды быстро создать политику. 
   Эта политика будет находиться в режиме аудита, то есть он будет запись в журнале о несанкционированного программного кода, но не будет препятствовать его выполнения.  

   ```powershell
   mkdir C:\artifacts
   Copy-Item C:\Windows\Schemas\CodeIntegrity\ExamplePolicies\AllowMicrosoft.xml C:\artifacts\AllowMicrosoft-Audit.xml 
   Set-RuleOption -FilePath C:\artifacts\AllowMicrosoft-Audit.xml -Option 3 
   ConvertFrom-CIPolicy -XmlFilePath C:\artifacts\AllowMicrosoft-Audit.xml -BinaryFilePath C:\artifacts\AllowMicrosoft-Audit.bin 
   Copy-Item C:\artifacts\AllowMicrosoft-Audit.bin C:\Windows\System32\CodeIntegrity\SIPolicy.p7b 
   Restart-Computer 
   ```

   Управление приложениями в Защитнике Windows имеет множество функций для охватывают целый ряд postures безопасности. 
   Если вам нужно разрешить сторонних производителей или настройки политики по умолчанию se [руководство по развертыванию управления приложениями в Защитнике Windows](https://docs.microsoft.com/windows/security/threat-protection/windows-defender-application-control/windows-defender-application-control-deployment-guide).   


4. Убедитесь, что безопасность на основе виртуализации запущена на компьютере, выполнив следующую команду. 
   Вы будете знать, что VBS работает, если поля DeviceGuardSecurityServicesRunning «HypervisorEnforcedCodeIntegrity», перечисленных в нем. 
   Если она не запущена, загрузите [средство проверки готовности к Guard устройства](https://www.microsoft.com/download/details.aspx?id=53337) и запустите «DG_Readiness.ps1-включить - HVCI» Чтобы включить его.  
   
   ```powershell
   Get-ComputerInfo -Property DeviceGuard* 
   ```
5. Собирайте идентификатор доверенного платформенного МОДУЛЯ и базовых показателей:

   ```powershell 
   (Get-PlatformIdentifier -Name $env:computername).Save("C:\artifacts\TpmID-$env:computername.xml") 
   Get-HgsAttestationBaselinePolicy -SkipValidation -Path "C:\artifacts\TpmBaseline-$env:computername.tcglog" 
   ```
   
6. Скопируйте xml, tcglog и двоичным файлам из C:\artifacts сервер HGS.
7. Если это первый узел доверенного платформенного МОДУЛЯ, которые вы добавляете сервер HGS, необходимо будет установить доверенных корневых сертификатов доверенного платформенного МОДУЛЯ на каждый сервер HGS. 
   Выполните [руководство по документации HGS](https://docs.microsoft.com/windows-server/virtualization/guarded-fabric-shielded-vm/guarded-fabric-install-trusted-tpm-root-certificates) для выполнения этого шага.
8. На сервере HGS авторизуйте этот узел, чтобы пройти аттестацию. 
   Следующие скрипты предполагают 3 файлы были скопированы C:\temp на сервер HGS, и что имя компьютера сервера является «ServerA». 
   Измените пути и имена в соответствии с собственной среде. 

   ```powershell
   Add-HgsAttestationTpmHost -Name ServerA -Path C:\temp\TpmID-ServerA.xml 
   Add-HgsAttestationTpmPolicy -Name ServerA-Baseline -Path C:\temp\TpmBaseline-ServerA.tcglog 
   Add-HgsAttestationCiPolicy -Name AllowMicrosoft-Audit -Path C:\temp\AllowMicrosoft-Audit.bin 
   ```
9. Первый сервер готов к подтверждающим! 
   На хост-компьютере запустите следующую команду, чтобы указать, куда подтверждающим (Изменение DNS-имя, что и кластер HGS, обычно будет использоваться имя службы HGS в сочетании с доменным именем HGS). 
   Если появится сообщение об ошибке HostUnreachable, убедитесь, вы можете разрешить и проверить связь с DNS-имена серверов HGS. 

   ```powershell
   Set-HgsClientConfiguration -AttestationServerUrl https://hgs.bastion.local/Attestation -KeyProtectionServerUrl https://hgs.bastion.local/KeyProtection/ 
   ```

10. Результат этой команды должны показывать, AttestationStatus = пройден. Если этого не произошло, см. в разделе [сбоев аттестации](https://docs.microsoft.com/windows-server/virtualization/guarded-fabric-shielded-vm/guarded-fabric-troubleshoot-hosts#attestation-failures) рекомендации о том, как устранить эту ошибку.   
11. Повторите шаги 1 – 10 для каждого хост-компьютере. 
    Если вы используете одинаковое оборудование, не потребуется для записи нового шаблона или политика целостности кода для каждой машины. 
    Базового плана из первого сервера будут рассмотрены все одинаково настроенные машины, а политика целостности кода можно использовать повторно между несколькими компьютерами до тех пор, пока программного обеспечения Майкрософт — это только программное обеспечение на компьютере.

### <a name="collecting-host-keys"></a>Сбор ключей узла 

>[!NOTE] 
>Аттестация ключей узла рекомендуется только для использования в тестовой среде. Аттестация доверенного платформенного МОДУЛЯ обеспечивает надежную гарантии, что доверенный код выполняется enclaves VBS обработки конфиденциальных данных на сервере SQL Server и компьютеры настраиваются с рекомендуемыми параметрами безопасности. 

Если вы решили настроить HGS в режиме аттестации ключей узла, необходимо создавать и собирать ключи из каждого хост-компьютере и зарегистрировать их в службе защиты узла. 

1. Чтобы получить клиент HGS, установленный на компьютере размещения, установите компонент защищенный узел, которая также установит Hyper-V. 
   Пока вы не будет работать виртуальные машины на этом компьютере, низкоуровневая оболочка необходим для включения функций безопасности на основе виртуализации, которые изолировать enclaves VBS, выполняющих запросы Always Encrypted. 

   ```powershell
   Enable-WindowsOptionalFeature -Online -FeatureName HostGuardian -All 
   ```

2. Перезагрузите компьютер при появлении запроса для завершения установки Hyper-v.
3. Создайте уникальный ключ и экспортируйте полученный открытый ключ в файл. 

   ```powershell
   Set-HgsClientHostKey 
   mkdir C:\artifacts 
   Get-HgsClientHostKey -Path C:\artifacts\$env:computername.cer 
   ```
   
   Кроме того можно указать отпечаток, если вы хотите использовать собственный сертификат. 
   Это может быть полезно в том случае, если вы хотите совместно использовать сертификат на нескольких компьютерах, или используйте сертификат, связанный с доверенным платформенным Модулем или аппаратный модуль безопасности. Ниже приведен пример создания сертификата привязкой доверенный платформенный модуль (который предотвращает его закрытый ключ украден и использован на другом компьютере и требуется только TPM 1.2):

   ```powershell
   $tpmBoundCert = New-SelfSignedCertificate -Subject “Host Key Attestation ($env:computername)” -Provider “Microsoft Platform Crypto Provider”
   Set-HgsClientHostKey -Thumbprint $tpmBoundCert.Thumbprint
   ```

4. Скопируйте ключ узла службы защиты узла. 
5. Зарегистрируйте ключ узла с любым узлом HGS, используя соответствующие имя и путь для вашей среды: 

   ```powershell
   Add-HgsAttestationHostKey -Name 'ServerA' -Path C:\temp\ServerA.cer 
   ``` 

6. Первый сервер готов к подтверждающим! 
   На хост-компьютере запустите следующую команду, чтобы указать, куда подтверждающим (Изменение DNS-имя, что и кластер HGS, обычно будет использоваться имя службы HGS в сочетании с доменным именем HGS). 
   Если появится сообщение об ошибке HostUnreachable, убедитесь, вы можете разрешить и проверить связь с DNS-имена серверов HGS.    

   ```powershell
   Set-HgsClientConfiguration -AttestationServerUrl http://hgs.bastion.local/Attestation -KeyProtectionServerUrl http://hgs.bastion.local/KeyProtection/  
   ```

7. Результат этой команды должны показывать, AttestationStatus = пройден. 
   Если возникает ошибка HostUnreachable, это означает, что хост-компьютере не могут взаимодействовать с HGS. 
   Убедитесь, что разрешения DNS настраивается между хост-компьютере и серверами HGS и связь с сервером. 
   Ошибка UnauthorizedHost указывает, что открытый ключ не был зарегистрирован сервер HGS — повторите шаги 4 и 5, чтобы устранить эту ошибку. 
   Если ничего не поможет, запустите командлет Clear-HgsClientHostKey и повторите шаги 3 – 6.   

8. Повторите шаги 1 – 7 для каждого сервера, который будет выполняться в SQL Server Always Encrypted с использованием VBS enclaves.     


