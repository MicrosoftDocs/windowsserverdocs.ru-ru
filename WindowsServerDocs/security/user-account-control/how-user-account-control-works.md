---
title: Принципы работы контроля учетных записей
description: Безопасность Windows Server
ms.custom: na
ms.prod: windows-server-threshold
ms.reviewer: na
ms.suite: na
ms.technology: security-tpm
ms.tgt_pltfrm: na
ms.topic: article
ms.assetid: da83ddb2-6182-417c-aa8e-0b47b2e17d13
author: coreyp-at-msft
ms.author: coreyp
manager: dongill
ms.date: 10/12/2016
ms.openlocfilehash: 7f5ad234959ebfe0687b8bc10f9e43f2092252f2
ms.sourcegitcommit: 0d0b32c8986ba7db9536e0b8648d4ddf9b03e452
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2019
ms.locfileid: "59823555"
---
# <a name="how-user-account-control-works"></a>Принципы работы контроля учетных записей

>Область применения. Windows Server (полугодовой канал), Windows Server 2016

Служба контроля учетных записей пользователей позволяет предотвратить ущерб, который могут нанести компьютерам вредоносные программы, а также повысить управляемость рабочими местами, имеющимися в организации. Благодаря контролю учетных записей пользователей приложения и задачи выполняются в безопасном контексте неадминистративной учетной записи до тех пор, пока доступ к системе не будет разрешен администратором. Автоматическая установка неавторизованных приложений блокируется и тем самым предотвращаются нежелательные изменения параметров системы.

## <a name="uac-process-and-interactions"></a>Обработка контроля учетных Записей и взаимодействия
Все приложения, для работы которых требуется маркер доступа администратора, должны запрашивать подтверждение администратора. Существует только одно исключение — это взаимосвязь между родительским и дочерним процессами. Дочерние процессы наследуют маркер доступа пользователя от родительского процесса. При этом как родительский, так и дочерний процессы должны иметь один и тот же уровень целостности. Windows Server 2012 защищает процессы, помечая их уровни целостности. Уровень целостности является мерой доверия. Приложение с «высоким» уровнем целостности — это такое приложение, в котором выполняются задачи по изменению системных данных, например разбиение диска. Приложение с «низким» уровнем целостности выполняет задачи, которые могут подвергать риску операционную систему, например веб-браузер. Приложения с низким уровнем целостности не могут изменять данные в приложениях с высоким уровнем целостности. Если обычный пользователь попытается запустить приложение, требующее маркер доступа администратора, служба контроля учетных записей пользователя запросит действительные учетные данные администратора.

Чтобы лучше понять, как этот процесс происходит, это важно просмотреть подробности процесса входа в систему Windows Server 2012.

### <a name="windows-server-2012-logon-process"></a>Процесс входа в систему Windows Server 2012
Ниже описано, как процесс входа в систему администратора отличается от процесса входа обычного пользователя.

![Иллюстрации, демонстрирующие, как процесс входа в систему для администратора отличается от процесса входа в систему обычного пользователя](../media/How-User-Account-Control-Works/UACWindowsLogonProcess.gif)

По умолчанию как обычные пользователи, так и администраторы получают доступ к ресурсам и запускают приложения в контексте безопасности обычного пользователя. При входе пользователя в систему для этого пользователя создается маркер доступа. Маркер доступа содержит сведения об уровне доступа, предоставленного пользователю, включая специальные идентификаторы безопасности (SID) и привилегии в Windows.

При входе в систему администратора для него создаются два отдельных маркера доступа — маркер доступа обычного пользователя и маркер доступа администратора. Маркер доступа обычного пользователя содержит те же сведения о пользователе, что и маркер доступа администратора, но в нем отсутствуют привилегии администратора Windows и идентификаторы безопасности. Маркер доступа обычного пользователя применяется для запуска приложений, которые не выполняют задач администрирования (приложений обычного пользователя). Маркер доступа обычного пользователя затем используется для отображения рабочего стола (Explorer.exe). Explorer.exe является родительским процессом, от которого все другие запускаемые пользователем процессы наследуют свой маркер доступа. В результате все приложения работают в режиме обычного пользователя до тех пор, пока пользователь не даст согласие или не введет учетные данные для подтверждения возможности использования приложением маркера полного доступа на уровне администратора.

Пользователь, который является членом группы «Администраторы», с помощью маркера доступа обычного пользователя может входить в систему, просматривать интернет-страницы и читать электронную почту. Когда администратор должен выполнить задачу, которая требуется маркер доступа администратора, Windows Server 2012 автоматически запрашивает подтверждение пользователя. Этот запрос называется «запрос на повышение прав». Его работу можно настраивать с помощью оснастки «Локальная политика безопасности» (Secpol.msc) или групповой политики.

> [!NOTE]
> Термин «повышение» используется для обозначения процесса в Windows Server 2012, который запрашивает разрешение пользователя или учетные данные для использования полного доступа администратора.

### <a name="the-uac-user-experience"></a>Взаимодействие UAC с пользователем
Работа обычных пользователей при включенной службе контроля учетных записей пользователей отличается от работы администраторов в режиме одобрения администратором. Рекомендуется использовать более безопасный способ под управлением Windows Server 2012 является сделать первичной учетной записи учетную запись обычного пользователя. Работа в режиме обычного пользователя позволяет максимально повысить уровень безопасности управляемой среды. Используя встроенный в службу контроля учетных записей пользователей компонент повышения прав, обычный пользователь может без труда выполнять задачи администрирования путем ввода действительных учетных данных локальной учетной записи администратора. По умолчанию встроенным в службу контроля учетных записей пользователей компонентом повышения прав является запрос учетных данных.

Альтернативой работе в режиме обычного пользователя является работа в качестве администратора в режиме одобрения администратором. Благодаря встроенному компоненту повышения привилегий контроля учетных записей члены локальной группы «Администраторы» могут с легкостью выполнять задачи администрирования, предоставив соответствующее подтверждение. По умолчанию встроенным в службу контроля учетных записей пользователей компонентом повышения прав для учетной записи администратора в режиме одобрения администратором является запрос согласия. Работу запроса на повышение прав в службе контроля учетных записей пользователей можно настраивать с помощью оснастки «Локальная политика безопасности» (Secpol.msc) или групповой политики.

**Согласия и запрос учетных данных**

С включенным контролем учетных Записей Windows Server 2012 выводит запрос согласия или запрос учетных данных действительной локальной учетной записи администратора перед запуском программы или задачи, которая требует полного доступа администратора. Применение запроса гарантирует невозможность незаметной установки вредоносных программ.

**Запрос согласия**

Запрос согласия выводится при попытке пользователя выполнить задачу, требующую маркера доступа на уровне администратора. Ниже приводится снимок экрана запроса согласия.

![Снимок экрана: Запрос согласия контроля учетных Записей](../media/How-User-Account-Control-Works/UACConsentPrompt.gif)

**Запрос учетных данных**

Запрос учетных данных выводится при попытке обычного пользователя выполнить задачу, требующую маркера доступа на уровне администратора. Работу запроса по умолчанию для обычного пользователя можно настраивать с помощью оснастки «Локальная политика безопасности» (Secpol.msc) или групповой политики. Администраторы также могут потребоваться для предоставлять свои учетные данные, задав контроль учетных записей пользователей: Поведение запроса на повышение прав для администраторов в режиме одобрения администратором политика значение в окно запроса учетных данных.

Ниже приводится снимок экрана с примером запроса учетных данных.

![Снимок экрана с примером запроса учетных данных](../media/How-User-Account-Control-Works/UACCredentialPrompt.gif)

**Запросы на повышение прав**

Запросы на повышение прав выделяются разным цветом в зависимости от приложения, что позволяет быстро оценить возможный риск для безопасности со стороны запускаемого приложения. Когда приложение пытается выполнить с маркером полного доступа администратора, Windows Server 2012 сначала анализирует исполняемый файл, чтобы определить его издателя. Сначала приложения разделяются на три категории, в зависимости от издателя исполняемого файла:  Windows Server 2012, издатель проверен (подписано) и издатель не проверен (подписано). На следующей схеме показано, как Windows Server 2012 определяет, какой цвет запроса на повышение прав для предоставления пользователю.

Запросы на повышение прав кодируются цветом по следующему правилу.

-   Красный фон со значком щита красного: Приложение заблокировано групповой политикой или принадлежит издателю, блокируется.

-   Синим фоном со значком щита синего и красного: Приложение является административным приложением Windows Server 2012, например компонент панели управления.

-   Синим фоном со значком щита синего: Приложение подписано с использованием Authenticode и является доверенным на локальном компьютере.

-   Желтый фон с желтый значок щита: Приложение не подписано или подписано, но еще не признает локального компьютера.

**Значок щита**

Некоторые компоненты панели управления, например **Дата и время**, выполняют как административные операции, так и операции обычного пользователя. Обычные пользователи могут просматривать время и менять часовой пояс, но для изменения локального системного времени требуется маркер полного доступа на уровне администратора. Ниже приводится снимок экрана компонента панели управления **Дата и время**.

![Отображение снимок экрана ** Дата и время свойства ** панели управления](../media/How-User-Account-Control-Works/UACShieldIcon.gif)

Изображение щита на кнопке **Изменить дату и время** указывает на то, что процессу требуется маркер полного доступа на уровне администратора и поэтому перед его запуском будет выведен запрос на повышение прав.

**Защита запроса на повышение прав**

Процесс повышения прав дополнительно защищен тем, что запрос направляется на безопасный рабочий стол. По умолчанию в Windows Server 2012 согласия и запрос учетных данных отображаются на безопасном рабочем столе. Получить доступ к безопасному рабочему столу могут только процессы Windows. Для повышения уровня безопасности, рекомендуется **контроль учетных записей пользователей: Переключение к безопасному рабочему столу при выполнении запроса на повышение прав** включена политика.

Когда исполняемый файл выполняет запрос на повышение прав, происходит переключение интерактивного рабочего стола (рабочего стола пользователя) к безопасному рабочему столу. При переключении к безопасному рабочему столу уменьшается яркость рабочего стола пользователя, появляется запрос на повышение прав, и дальнейшая работа может быть продолжена только после ответа на запрос. Когда пользователь нажимает кнопку Да или нет, рабочий стол обратно переключится рабочего стола пользователя.

Вредоносные программы могут имитировать безопасный рабочий стол, но, когда контроль учетных записей: Поведение запроса на повышение прав для администраторов в режиме одобрения администратором параметра политики задано значение в окно запроса согласия, вредоносная программа не смогут получить повышение прав, если пользователь нажимает кнопку Да на имитации. Если параметр имеет значение в окно запроса учетных данных, вредоносная программа, имитирующая запрос учетных данных можно получить учетные данные от пользователя. Однако при этом вредоносные программы не получают повышенные права, а система имеет другие средства защиты, которые не позволяют им захватить контроль над интерфейсом пользователя даже при раскрытии пароля.

Вредоносные программы могут создавать имитации безопасного рабочего стола, но это может произойти только если пользователь предварительно установил вредоносную программу на компьютер. Процессы, требующие маркера доступа на уровне администратора, не могут быть установлены незаметно при включенном контроле учетных записей пользователя, поэтому пользователь должен явно дать согласие нажатием кнопки **Да** или путем ввода учетных данных администратора. Конкретное поведение запроса на повышение прав в службе контроля учетных записей пользователей зависит от групповой политики.

## <a name="uac-architecture"></a>Архитектура службы контроля учетных записей пользователей
На приведенной ниже схеме показана архитектура службы контроля учетных записей пользователей.

![Схема, архитектура UAC с подробным описанием.](../media/How-User-Account-Control-Works/UACArchitecture.gif)

Чтобы лучше понять каждого компонента, см. таблицу ниже:

|Component|Описание|
|-------|--------|
|**Пользователь**||
|Пользователь выполняет операцию, требующую определенных прав|Если операция вносит изменения в файловую систему или реестр, вызывается функция виртуализации. Все остальные операции вызывают ShellExecute.|
|ShellExecute|ShellExecute вызывает CreateProcess. ShellExecute проверяет, нет ли ошибки ERROR_ELEVATION_REQUIRED в CreateProcess. Если ошибка обнаружена, ShellExecute вызывает службу сведений о приложениях для выполнения требуемой задачи с запросом на повышение прав.|
|CreateProcess|Если приложение требует повышения прав, CreateProcess отклоняет вызов с ошибкой ERROR_ELEVATION_REQUIRED.|
|**Системы**||
|Служба сведений о приложениях|Системная служба, позволяющая запускать приложения, для выполнения которых требуются повышенные привилегии или права пользователя, например локальные задачи администрирования или приложения, требующие более высоких уровней целостности. Служба сведений о приложениях позволяет запускать такие приложения путем создания нового процесса приложения с маркером полного доступа на уровне администратора, когда требуется повышение прав и (в зависимости от групповой политики) на это получено согласие пользователя.|
|Повышение привилегий для установки ActiveX|Если технология ActiveX не установлена, операционная система проверяет уровень ползунка службы контроля учетных записей пользователей. Если технология ActiveX установлена, **контроль учетных записей пользователей: Переключение к безопасному рабочему столу при выполнении запроса на повышение прав** проверяется значение параметра групповой политики.|
|Проверка уровня ползунка службы контроля учетных записей пользователей|Служба контроля учетных записей пользователей теперь имеет четыре уровня уведомлений, которые можно выбирать с помощью ползунка.<br /><br /><ul><li>Высокий<br /><br />    Если ползунок установлен в положение **Всегда уведомлять**, система проверяет, включен ли безопасный рабочий стол.</li><li>Средний<br /><br />    Если ползунок установлен в значение **по умолчанию — Уведомлять только при попытках программ внести изменения в компьютер**, **контроль учетных записей пользователей: Повышение прав только для исполняемых файлов, подписанных и проверенных** проверяется значение параметра политики:<br /><br /><ul><li>Если этот параметр политики включен, то перед тем как разрешить выполнение данного файла, к нему применяется утверждение пути сертификации инфраструктуры открытого ключа (PKI).</li><li>Если этот параметр политики отключен (по умолчанию), то утверждение пути сертификации PKI не применяется до тех пор, пока не будет разрешено выполнение данного исполняемого файла. **Контроль учетных записей пользователей: Переключение к безопасному рабочему столу при выполнении запроса на повышение прав** проверяется значение параметра групповой политики.</li></ul></li><li>Низкий<br /><br />    Если ползунок установлен в положение **Уведомлять только при попытках программ внести изменения в компьютер (не затемнять рабочий стол)**, вызывается CreateProcess.</li><li>Никогда не уведомлять<br /><br />    Если ползунок установлен в значение **никогда не уведомлять при**, запрос будет контроля учетных Записей никогда не уведомлять программы при попытке установить или попытке внести изменения, на компьютере. **Важно!**     Этот параметр использовать не рекомендуется. Этот параметр совпадает со значением параметра **контроль учетных записей пользователей: Поведение запроса на повышение прав для администраторов в режиме одобрения администратором** параметр локальной политики **повышение без запроса**.</li></ul>|
|Безопасный рабочий стол включен|**Контроль учетных записей пользователей: Переключение к безопасному рабочему столу при выполнении запроса на повышение прав** проверяется значение параметра политики:<br /><br />— Если включен безопасный рабочий стол, все запросы на повышение прав перейдите к безопасному рабочему столу, независимо от того, параметры политики запросов для администраторов и обычных пользователей.<br />— Если безопасный рабочий стол не включен, все запросы на повышение прав поступают на рабочем столе интерактивного пользователя, и используются параметры на уровне пользователей для администраторов и обычных пользователей.|
|CreateProcess|CreateProcess вызывает AppCompat, Fusion и функцию обнаружения установщика для проверки, не требуется ли приложению повышение прав. Исполняемый файл проверяется с целью определения требуемого для него уровня выполнения, который хранится в манифесте приложения для данного файла. CreateProcess завершается ошибочно, если требуемый уровень выполнения, указанный в манифесте, не соответствует маркеру доступа, и возвращает ошибку (ERROR_ELEVATION_REQUIRED) в ShellExecute. |
|AppCompat|В базе данных AppCompat хранятся сведения в виде записей о решении проблем совместимости для каждого приложения.|
|Fusion|В базе данных Fusion хранятся сведения из манифестов приложений, представляющие описания этих приложений. Схема манифеста обновлена — в нее добавлено новое поле, содержащее требуемый уровень выполнения.|
|Функция обнаружения установщика|Технология обнаружения установщика служит для обнаружения исполняемых установочных файлов, что позволяет предотвратить выполнение установки незаметно и без согласия пользователя.|
|**Ядро**||
|Виртуализация|Технология виртуализации позволяет предотвратить необъяснимый сбой несовместимых приложений или такой сбой, при котором не удается определить его причину. Служба контроля учетных записей пользователей обеспечивает также виртуализацию файлов и реестра, а также протоколирование приложений, выполняющих запись в защищенные области.|
|Файловая система и реестр|При виртуализации файлов и реестра с разделением по пользователям происходит перенаправление запросов на запись в файлы и реестр, сформированных с разделением по компьютерам, в эквивалентные расположения, разделенные по пользователям. Запросы на чтение перенаправляются сначала в виртуализованные расположения с разделением по пользователям, а затем в расположения с разделением по компьютерам.|

Изменяется на Windows Server 2012 UAC с предыдущих версий Windows. Новый ползунок будет никогда не отключайте UAC полностью. Новый параметр выполняет следующие действия:

-   служба контроля учетных записей останется включенной;

-   все запросы повышения прав, сделанные администраторами, будут автоматически утверждены без отображения запроса UAC;

-   все запросы повышения прав для обычных пользователей будут отклонены.

> [!IMPORTANT]
> Чтобы полностью отключить контроль учетных Записей необходимо отключить политику **контроль учетных записей пользователей: Все администраторы работают в режиме одобрения администратором**.

> [!WARNING]
> Пользовательские приложения не будет работать в Windows Server 2012, при отключении контроля учетных Записей.

### <a name="virtualization"></a>Виртуализация
Системные администраторы на предприятиях стараются защитить свои системы, поэтому многие бизнес-приложения разработаны в расчете на использование только маркера доступа обычного пользователя. Таким образом ИТ-администраторам не придется заменять большую часть приложений, при запуске Windows Server 2012 с включенным контролем учетных Записей.

 Windows Server 2012 включает технологию виртуализации файлов и реестра для приложений, которые не совместимы с UAC и которыми требуется маркер доступа администратора для правильной работы. Виртуализация гарантирует, что даже приложения, которые не совместимы с UAC, совместимы с Windows Server 2012. Когда административное приложение, несовместимое с контролем учетных записей пользователей, пытается выполнить запись в защищенную папку, например Program Files, служба контроля учетных записей предоставляет приложению созданный специально для него виртуализованный вид того ресурса, который оно пытается изменить. Эта виртуализованная копия сохраняется в профиле пользователя. При этом отдельная копия виртуализованного файла создается для каждого пользователя, запускающего несовместимое приложение.

Большинство приложений корректно работают с использованием функций виртуализации. Однако, несмотря на то что виртуализация позволяет работать большинству приложений, она является лишь временным решением проблемы. Разработчикам приложений следует изменить приложения были совместимыми с программой логотип Windows Server 2012 как можно скорее, а не полагаться на виртуализацию файлов, папок и реестра.

Виртуализация не применяется в следующих ситуациях.

1.  Виртуализация не применяется к приложениям, для которых выполнено повышение прав и которые работают с маркером полного доступа на уровне администратора.

2.  Виртуализация поддерживает только 32-разрядные приложения. 64-разрядное приложение с обычными правами при попытке получить дескриптор (уникальный идентификатор) объекта Windows просто получает сообщение об отказе в доступе. Полноценные 64-разрядные приложения Windows обязаны быть совместимыми с контролем учетных записей пользователей и записывать данные в предусмотренные для них расположения.

3.  Виртуализация отключается для приложений, содержащих манифест с атрибутом требуемого уровня выполнения.

### <a name="request-execution-levels"></a>Уровни выполнения запроса
Манифест приложения представляет собой XML-файл, в котором описаны и идентифицированы общие и частные параллельные сборки, с которыми приложение должно связаться во время выполнения. В Windows Server 2012 манифест приложения содержит записи для обеспечения совместимости с контролем учетных Записей. Административные приложения, у которых в манифесте есть запись, запрашивают разрешение пользователя на доступ к его маркеру доступа. Большинство административных приложений, у которых отсутствует в манифесте такая запись, тем не менее могут выполняться без доработки. Для этого можно использовать исправления совместимости приложений. Исправлениями неполадок совместимости являются записи базы данных, которые позволяют приложениям, которые не совместимы с UAC для правильной работы с Windows Server 2012.

Все приложения, совместимые с контролем учетных записей пользователей, должны иметь в своем манифесте запись с требуемым уровнем выполнения. Если приложению требуется административный доступ к системе, его можно пометить, задав для него требуемый уровень выполнения «требуется администратор». Это гарантирует то, что система распознает его как административное приложение и выполнит необходимые действия по повышению прав. Требуемые уровни выполнения определяют права, необходимые приложению.

### <a name="installer-detection-technology"></a>Технология обнаружения установщика
Программы установки — это приложения, предназначенные для развертывания программного обеспечения. Большинство программ установки выполняют запись в системные папки и разделы реестра. В эти защищенные системные расположения выполнять запись обычно имеет право только администратор с помощью технологии обнаружения установщика, что означает, что обычные пользователи не имеют достаточно прав для установки программ. Windows Server 2012 эвристически обнаруживает программы установки и запрашивает учетные данные администратора или утверждения от администратора для запуска с правами доступа. Windows Server 2012 также эвристически обнаруживает обновления и программы для удаления приложений. Одной из задач, решаемых службой контроля учетных записей пользователей, является предотвращение запуска установки приложений незаметно для пользователя и без его согласия, потому что при установке производится запись в защищенные области файловой системы и реестра.

Технология обнаружения установщика применяется только к:

-   32-разрядным исполняемым файлам;

-   приложениям, не имеющим атрибута требуемого уровня выполнения;

-   интерактивным процессам, выполняющимся с правами обычного пользователя с включенной службой контроля учетных записей.

Перед созданием 32-разрядного процесса определяется, не является ли он программой установки. Для этого проверяются следующие атрибуты.

-   В имени файла содержатся ключевые слова: «install», «setup» или «update».

-   Управление версиями ресурсов поля содержат следующие ключевые слова: Поставщика, название компании, имя продукта, описание файла, исходное имя файла, внутреннее имя и имя экспорта.

-   Ключевые слова в параллельном манифесте встроены в исполняемый файл.

-   Ключевые слова в специальных записях StringTable связаны в исполняемом файле.

-   Ключевые атрибуты в данных сценария ресурса связаны в исполняемом файле.

-   Это законченные последовательности байтов внутри исполняемого файла.

> [!NOTE]
> Ключевые слова и последовательности байтов были получены при изучении общих характеристик различных технологий программ установки.

> [!NOTE]
> Контроль учетных записей пользователей: Обнаружение установки приложений и запрос повышения прав политика должна быть включена для обнаружения установщиков и обнаружения программ установки. Этот параметр включен по умолчанию, и его можно настраивать локально, используя оснастку «Локальная политика безопасности» (Secpol.msc), или для домена, OU или определенных групп с помощью групповой политики (Gpedit.msc).


