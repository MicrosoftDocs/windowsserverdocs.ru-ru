---
title: Принципы работы контроля учетных записей
description: Безопасность Windows Server
ms.custom: na
ms.prod: windows-server
ms.reviewer: na
ms.suite: na
ms.technology: security-tpm
ms.tgt_pltfrm: na
ms.topic: article
ms.assetid: da83ddb2-6182-417c-aa8e-0b47b2e17d13
author: coreyp-at-msft
ms.author: coreyp
manager: dongill
ms.date: 10/12/2016
ms.openlocfilehash: f12a690c06a37a6e1c01674bcdb96d0a9010a245
ms.sourcegitcommit: 6aff3d88ff22ea141a6ea6572a5ad8dd6321f199
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/27/2019
ms.locfileid: "71403336"
---
# <a name="how-user-account-control-works"></a>Принципы работы контроля учетных записей

>Область применения: Windows Server (Semi-Annual Channel), Windows Server 2016

Служба контроля учетных записей пользователей позволяет предотвратить ущерб, который могут нанести компьютерам вредоносные программы, а также повысить управляемость рабочими местами, имеющимися в организации. Благодаря контролю учетных записей пользователей приложения и задачи выполняются в безопасном контексте неадминистративной учетной записи до тех пор, пока доступ к системе не будет разрешен администратором. Автоматическая установка неавторизованных приложений блокируется и тем самым предотвращаются нежелательные изменения параметров системы.

## <a name="uac-process-and-interactions"></a>Процесс контроля учетных записей и взаимодействие
Все приложения, для работы которых требуется маркер доступа администратора, должны запрашивать подтверждение администратора. Существует только одно исключение — это взаимосвязь между родительским и дочерним процессами. Дочерние процессы наследуют маркер доступа пользователя от родительского процесса. При этом как родительский, так и дочерний процессы должны иметь один и тот же уровень целостности. Windows Server 2012 защищает процессы, помечая их уровни целостности. Уровень целостности является мерой доверия. Приложение с «высоким» уровнем целостности — это такое приложение, в котором выполняются задачи по изменению системных данных, например разбиение диска. Приложение с «низким» уровнем целостности выполняет задачи, которые могут подвергать риску операционную систему, например веб-браузер. Приложения с низким уровнем целостности не могут изменять данные в приложениях с высоким уровнем целостности. Если обычный пользователь попытается запустить приложение, требующее маркер доступа администратора, служба контроля учетных записей пользователя запросит действительные учетные данные администратора.

Чтобы лучше понять, как происходит этот процесс, важно ознакомиться с подробными сведениями о процессе входа в систему Windows Server 2012.

### <a name="windows-server-2012-logon-process"></a>Процесс входа в систему Windows Server 2012
Ниже описано, как процесс входа в систему администратора отличается от процесса входа обычного пользователя.

![Иллюстрация, демонстрирующая, как процесс входа в систему для администратора отличается от процесса входа для обычного пользователя](../media/How-User-Account-Control-Works/UACWindowsLogonProcess.gif)

По умолчанию как обычные пользователи, так и администраторы получают доступ к ресурсам и запускают приложения в контексте безопасности обычного пользователя. При входе пользователя в систему для этого пользователя создается маркер доступа. Маркер доступа содержит сведения об уровне доступа, предоставленного пользователю, включая специальные идентификаторы безопасности (SID) и привилегии в Windows.

При входе в систему администратора для него создаются два отдельных маркера доступа — маркер доступа обычного пользователя и маркер доступа администратора. Маркер доступа обычного пользователя содержит те же сведения о пользователе, что и маркер доступа администратора, но в нем отсутствуют привилегии администратора Windows и идентификаторы безопасности. Маркер доступа обычного пользователя применяется для запуска приложений, которые не выполняют задач администрирования (приложений обычного пользователя). Маркер доступа обычного пользователя затем используется для отображения рабочего стола (Explorer.exe). Explorer.exe является родительским процессом, от которого все другие запускаемые пользователем процессы наследуют свой маркер доступа. В результате все приложения работают в режиме обычного пользователя до тех пор, пока пользователь не даст согласие или не введет учетные данные для подтверждения возможности использования приложением маркера полного доступа на уровне администратора.

Пользователь, который является членом группы «Администраторы», с помощью маркера доступа обычного пользователя может входить в систему, просматривать интернет-страницы и читать электронную почту. Когда администратору необходимо выполнить задачу, для которой требуется маркер доступа администратора, Windows Server 2012 автоматически запрашивает у пользователя утверждение. Этот запрос называется «запрос на повышение прав». Его работу можно настраивать с помощью оснастки «Локальная политика безопасности» (Secpol.msc) или групповой политики.

> [!NOTE]
> Термин "повышение прав" используется для ссылки на процесс в Windows Server 2012, который предлагает пользователю предоставить согласие или учетные данные для использования полного маркера доступа администратора.

### <a name="the-uac-user-experience"></a>Взаимодействие UAC с пользователем
Работа обычных пользователей при включенной службе контроля учетных записей пользователей отличается от работы администраторов в режиме одобрения администратором. Рекомендуемый и более безопасный способ запуска Windows Server 2012 — сделать учетной записи основного пользователя учетной записью обычного пользователя. Работа в режиме обычного пользователя позволяет максимально повысить уровень безопасности управляемой среды. Используя встроенный в службу контроля учетных записей пользователей компонент повышения прав, обычный пользователь может без труда выполнять задачи администрирования путем ввода действительных учетных данных локальной учетной записи администратора. По умолчанию встроенным в службу контроля учетных записей пользователей компонентом повышения прав является запрос учетных данных.

Альтернативой работе в режиме обычного пользователя является работа в качестве администратора в режиме одобрения администратором. Благодаря встроенному компоненту повышения привилегий контроля учетных записей члены локальной группы «Администраторы» могут с легкостью выполнять задачи администрирования, предоставив соответствующее подтверждение. По умолчанию встроенным в службу контроля учетных записей пользователей компонентом повышения прав для учетной записи администратора в режиме одобрения администратором является запрос согласия. Работу запроса на повышение прав в службе контроля учетных записей пользователей можно настраивать с помощью оснастки «Локальная политика безопасности» (Secpol.msc) или групповой политики.

**Запрос согласия и учетных данных**

Если UAC включен, Windows Server 2012 запрашивает согласие или запрашивает учетные данные действующей учетной записи локального администратора перед запуском программы или задачи, требующей полного маркера доступа администратора. Применение запроса гарантирует невозможность незаметной установки вредоносных программ.

**Запрос согласия**

Запрос согласия выводится при попытке пользователя выполнить задачу, требующую маркера доступа на уровне администратора. Ниже приводится снимок экрана запроса согласия.

![Снимок экрана с запросом на согласие UAC](../media/How-User-Account-Control-Works/UACConsentPrompt.gif)

**Запрос учетных данных**

Запрос учетных данных выводится при попытке обычного пользователя выполнить задачу, требующую маркера доступа на уровне администратора. Работу запроса по умолчанию для обычного пользователя можно настраивать с помощью оснастки «Локальная политика безопасности» (Secpol.msc) или групповой политики. Администраторам также может потребоваться предоставить учетные данные, задав контроль учетных записей: поведение запроса на повышение прав для администраторов в режиме одобрения администратором значение параметра политики для запроса учетных данных.

Ниже приводится снимок экрана с примером запроса учетных данных.

![Снимок экрана, демонстрирующий пример запроса учетных данных UAC](../media/How-User-Account-Control-Works/UACCredentialPrompt.gif)

**Запросы на повышение прав UAC**

Запросы на повышение прав выделяются разным цветом в зависимости от приложения, что позволяет быстро оценить возможный риск для безопасности со стороны запускаемого приложения. Когда приложение пытается запуститься с маркером полного доступа администратора, Windows Server 2012 сначала анализирует исполняемый файл, чтобы определить его издателя. Приложения сначала разделены на три категории, основанные на издателе исполняемого файла: Windows Server 2012, издатель проверен (подписанный), а издатель не прошел проверку (без знака). На следующей схеме показано, как Windows Server 2012 определяет, какой запрос на повышение прав цвета должен быть представлен пользователю.

Запросы на повышение прав кодируются цветом по следующему правилу.

-   Изображение щита красного цвета на красном фоне: приложение заблокировано групповой политикой или принадлежит заблокированному издателю.

-   Синий фон с синим и Золотой значком щита: приложение является административным приложением Windows Server 2012, например элементом панели управления.

-   Изображение щита синего цвета на синем фоне: приложение подписано с использованием Authenticode и является доверенным на локальном компьютере.

-   Изображение щита желтого цвета на желтом фоне: приложение не подписано или подписано, но не является доверенным на локальном компьютере.

**Значок щита**

Некоторые компоненты панели управления, например **Дата и время**, выполняют как административные операции, так и операции обычного пользователя. Обычные пользователи могут просматривать время и менять часовой пояс, но для изменения локального системного времени требуется маркер полного доступа на уровне администратора. Ниже приводится снимок экрана компонента панели управления **Дата и время**.

![Снимок экрана, показывающий свойства * * Дата и время * * элемент панели управления](../media/How-User-Account-Control-Works/UACShieldIcon.gif)

Изображение щита на кнопке **Изменить дату и время** указывает на то, что процессу требуется маркер полного доступа на уровне администратора и поэтому перед его запуском будет выведен запрос на повышение прав.

**Обеспечение безопасности запроса на повышение прав**

Процесс повышения прав дополнительно защищен тем, что запрос направляется на безопасный рабочий стол. Запрос согласия и учетных данных по умолчанию отображается на защищенном рабочем столе в Windows Server 2012. Получить доступ к безопасному рабочему столу могут только процессы Windows. Для повышения уровня безопасности рекомендуется включить параметр политики **Контроль учетных записей пользователей: переключение к безопасному рабочему столу при выполнении запроса на повышение прав**.

Когда исполняемый файл выполняет запрос на повышение прав, происходит переключение интерактивного рабочего стола (рабочего стола пользователя) к безопасному рабочему столу. При переключении к безопасному рабочему столу уменьшается яркость рабочего стола пользователя, появляется запрос на повышение прав, и дальнейшая работа может быть продолжена только после ответа на запрос. Когда пользователь нажимает кнопку Да или нет, Рабочий стол переключается обратно на Рабочий стол пользователя.

Вредоносные программы могут представлять имитацию защищенного рабочего стола, но при выборе параметра политики "контроль учетных записей: поведение запроса на повышение прав для администраторов в режиме одобрения администратором" будет запрашивать согласие, вредоносные программы не получат повышение прав, если пользователь нажмет кнопку "Да". на имитации. Если параметр политики настроен на запрос учетных данных, вредоносная программа, имитирующая запрос учетных данных, может получить учетные данные пользователя. Однако при этом вредоносные программы не получают повышенные права, а система имеет другие средства защиты, которые не позволяют им захватить контроль над интерфейсом пользователя даже при раскрытии пароля.

Вредоносные программы могут создавать имитации безопасного рабочего стола, но это может произойти только если пользователь предварительно установил вредоносную программу на компьютер. Процессы, требующие маркера доступа на уровне администратора, не могут быть установлены незаметно при включенном контроле учетных записей пользователя, поэтому пользователь должен явно дать согласие нажатием кнопки **Да** или путем ввода учетных данных администратора. Конкретное поведение запроса на повышение прав в службе контроля учетных записей пользователей зависит от групповой политики.

## <a name="uac-architecture"></a>Архитектура службы контроля учетных записей пользователей
На приведенной ниже схеме показана архитектура службы контроля учетных записей пользователей.

![Схема, подробно описывающая архитектуру UAC](../media/How-User-Account-Control-Works/UACArchitecture.gif)

Чтобы лучше понять каждый компонент, ознакомьтесь с таблицей ниже.

|Component|Описание|
|-------|--------|
|**Нажат**||
|Пользователь выполняет операцию, требующую определенных прав|Если операция вносит изменения в файловую систему или реестр, вызывается функция виртуализации. Все остальные операции вызывают ShellExecute.|
|ShellExecute|ShellExecute вызывает CreateProcess. ShellExecute проверяет, нет ли ошибки ERROR_ELEVATION_REQUIRED в CreateProcess. Если ошибка обнаружена, ShellExecute вызывает службу сведений о приложениях для выполнения требуемой задачи с запросом на повышение прав.|
|CreateProcess|Если приложение требует повышения прав, CreateProcess отклоняет вызов с ошибкой ERROR_ELEVATION_REQUIRED.|
|**Системой**||
|Служба сведений о приложениях|Системная служба, позволяющая запускать приложения, для выполнения которых требуются повышенные привилегии или права пользователя, например локальные задачи администрирования или приложения, требующие более высоких уровней целостности. Служба сведений о приложениях позволяет запускать такие приложения путем создания нового процесса приложения с маркером полного доступа на уровне администратора, когда требуется повышение прав и (в зависимости от групповой политики) на это получено согласие пользователя.|
|Повышение привилегий для установки ActiveX|Если технология ActiveX не установлена, операционная система проверяет уровень ползунка службы контроля учетных записей пользователей. Если технология ActiveX установлена, проверяется значение параметра групповой политики **Контроль учетных записей пользователей: переключение к безопасному рабочему столу при выполнении запроса на повышение прав**.|
|Проверка уровня ползунка службы контроля учетных записей пользователей|Служба контроля учетных записей пользователей теперь имеет четыре уровня уведомлений, которые можно выбирать с помощью ползунка.<br /><br /><ul><li>Высока<br /><br />    Если ползунок установлен в положение **Всегда уведомлять**, система проверяет, включен ли безопасный рабочий стол.</li><li>Средний<br /><br />    Если ползунок установлен в положение **По умолчанию — уведомлять только при попытках программ внести изменения в компьютер**, проверяется значение параметра политики **Контроль учетных записей: повышение прав только для подписанных и проверенных исполняемых файлов**.<br /><br /><ul><li>Если этот параметр политики включен, то перед тем как разрешить выполнение данного файла, к нему применяется утверждение пути сертификации инфраструктуры открытого ключа (PKI).</li><li>Если этот параметр политики отключен (по умолчанию), то утверждение пути сертификации PKI не применяется до тех пор, пока не будет разрешено выполнение данного исполняемого файла. Проверяется значение параметра групповой политики **Контроль учетных записей пользователей: переключение к безопасному рабочему столу при выполнении запроса на повышение прав**.</li></ul></li><li>Низкий<br /><br />    Если ползунок установлен в положение **Уведомлять только при попытках программ внести изменения в компьютер (не затемнять рабочий стол)** , вызывается CreateProcess.</li><li>Никогда не уведомлять<br /><br />    Если ползунок **никогда не уведомлять**, то запрос UAC никогда не будет уведомлять, когда программа пытается установить или внести какие-либо изменения на компьютере. **Важно.**     Этот параметр не рекомендуется. Данный параметр действует точно так же, как и установка для параметра политики **Контроль учетных записей: поведение запроса на повышение прав для администраторов в режиме одобрения администратором** значения **Повышение прав без запроса**.</li></ul>|
|Безопасный рабочий стол включен|Проверяется значение параметра политики **Контроль учетных записей пользователей: переключение к безопасному рабочему столу при выполнении запроса на повышение прав**.<br /><br />— Если включен безопасный рабочий стол, все запросы на повышение прав переходят на защищенный рабочий стол независимо от параметров политики для администраторов и обычных пользователей.<br />— Если безопасный рабочий стол не включен, все запросы на повышение прав передаются на Рабочий стол интерактивного пользователя, а также используются пользовательские параметры для администраторов и обычных пользователей.|
|CreateProcess|CreateProcess вызывает AppCompat, Fusion и функцию обнаружения установщика для проверки, не требуется ли приложению повышение прав. Исполняемый файл проверяется с целью определения требуемого для него уровня выполнения, который хранится в манифесте приложения для данного файла. CreateProcess завершается ошибочно, если требуемый уровень выполнения, указанный в манифесте, не соответствует маркеру доступа, и возвращает ошибку (ERROR_ELEVATION_REQUIRED) в ShellExecute. |
|AppCompat|В базе данных AppCompat хранятся сведения в виде записей о решении проблем совместимости для каждого приложения.|
|Fusion|В базе данных Fusion хранятся сведения из манифестов приложений, представляющие описания этих приложений. Схема манифеста обновлена — в нее добавлено новое поле, содержащее требуемый уровень выполнения.|
|Функция обнаружения установщика|Технология обнаружения установщика служит для обнаружения исполняемых установочных файлов, что позволяет предотвратить выполнение установки незаметно и без согласия пользователя.|
|**Ядро**||
|Виртуализация|Технология виртуализации позволяет предотвратить необъяснимый сбой несовместимых приложений или такой сбой, при котором не удается определить его причину. Служба контроля учетных записей пользователей обеспечивает также виртуализацию файлов и реестра, а также протоколирование приложений, выполняющих запись в защищенные области.|
|Файловая система и реестр|При виртуализации файлов и реестра с разделением по пользователям происходит перенаправление запросов на запись в файлы и реестр, сформированных с разделением по компьютерам, в эквивалентные расположения, разделенные по пользователям. Запросы на чтение перенаправляются сначала в виртуализованные расположения с разделением по пользователям, а затем в расположения с разделением по компьютерам.|

В Windows Server 2012 UAC внесены изменения по отношению к предыдущим версиям Windows. Новый ползунок никогда не будет полностью отключен от UAC. Новый параметр будет:

-   служба контроля учетных записей останется включенной;

-   все запросы повышения прав, сделанные администраторами, будут автоматически утверждены без отображения запроса UAC;

-   все запросы повышения прав для обычных пользователей будут отклонены.

> [!IMPORTANT]
> Чтобы полностью отключить контроль учетных записей, необходимо отключить политику **Контроль учетных записей: все администраторы работают в режиме одобрения администратором**.

> [!WARNING]
> Настроенные приложения не будут работать в Windows Server 2012, если контроль учетных записей отключен.

### <a name="virtualization"></a>Виртуализация
Системные администраторы на предприятиях стараются защитить свои системы, поэтому многие бизнес-приложения разработаны в расчете на использование только маркера доступа обычного пользователя. В результате ИТ-администраторам не нужно заменять большинство приложений при использовании Windows Server 2012 с включенным UAC.

 Windows Server 2012 включает технологию виртуализации файлов и реестра для приложений, которые не соответствуют требованиям UAC и для правильной работы требуется маркер доступа администратора. Виртуализация гарантирует, что даже те приложения, которые не соответствуют требованиям UAC, совместимы с Windows Server 2012. Когда административное приложение, несовместимое с контролем учетных записей пользователей, пытается выполнить запись в защищенную папку, например Program Files, служба контроля учетных записей предоставляет приложению созданный специально для него виртуализованный вид того ресурса, который оно пытается изменить. Эта виртуализованная копия сохраняется в профиле пользователя. При этом отдельная копия виртуализованного файла создается для каждого пользователя, запускающего несовместимое приложение.

Большинство приложений корректно работают с использованием функций виртуализации. Однако, несмотря на то что виртуализация позволяет работать большинству приложений, она является лишь временным решением проблемы. Разработчики приложений должны изменить свои приложения так, чтобы они соответствовали программе Windows Server 2012 Logo, как можно скорее, а не полагаться на виртуализацию файлов, папок и реестра.

Виртуализация не применяется в следующих ситуациях.

1.  Виртуализация не применяется к приложениям, для которых выполнено повышение прав и которые работают с маркером полного доступа на уровне администратора.

2.  Виртуализация поддерживает только 32-разрядные приложения. 64-разрядное приложение с обычными правами при попытке получить дескриптор (уникальный идентификатор) объекта Windows просто получает сообщение об отказе в доступе. Полноценные 64-разрядные приложения Windows обязаны быть совместимыми с контролем учетных записей пользователей и записывать данные в предусмотренные для них расположения.

3.  Виртуализация отключается для приложений, содержащих манифест с атрибутом требуемого уровня выполнения.

### <a name="request-execution-levels"></a>Уровни выполнения запроса
Манифест приложения представляет собой XML-файл, в котором описаны и идентифицированы общие и частные параллельные сборки, с которыми приложение должно связаться во время выполнения. В Windows Server 2012 манифест приложения включает записи для обеспечения совместимости приложений UAC. Административные приложения, у которых в манифесте есть запись, запрашивают разрешение пользователя на доступ к его маркеру доступа. Большинство административных приложений, у которых отсутствует в манифесте такая запись, тем не менее могут выполняться без доработки. Для этого можно использовать исправления совместимости приложений. Исправления совместимости приложений — это записи базы данных, которые позволяют приложениям, не совместимым с UAC, правильно работать с Windows Server 2012.

Все приложения, совместимые с контролем учетных записей пользователей, должны иметь в своем манифесте запись с требуемым уровнем выполнения. Если приложению требуется административный доступ к системе, его можно пометить, задав для него требуемый уровень выполнения «требуется администратор». Это гарантирует то, что система распознает его как административное приложение и выполнит необходимые действия по повышению прав. Требуемые уровни выполнения определяют права, необходимые приложению.

### <a name="installer-detection-technology"></a>Технология обнаружения установщика
Программы установки — это приложения, предназначенные для развертывания программного обеспечения. Большинство программ установки выполняют запись в системные папки и разделы реестра. В эти защищенные системные расположения выполнять запись обычно имеет право только администратор с помощью технологии обнаружения установщика, что означает, что обычные пользователи не имеют достаточно прав для установки программ. Windows Server 2012 эвристическо обнаруживает программы установки и запрашивает учетные данные администратора или утверждение от пользователя с правами администратора для запуска с правами доступа. Windows Server 2012 также эвристическо обнаруживает обновления и программы, удаляющие приложения. Одной из задач, решаемых службой контроля учетных записей пользователей, является предотвращение запуска установки приложений незаметно для пользователя и без его согласия, потому что при установке производится запись в защищенные области файловой системы и реестра.

Технология обнаружения установщика применяется только к:

-   32-разрядным исполняемым файлам;

-   приложениям, не имеющим атрибута требуемого уровня выполнения;

-   интерактивным процессам, выполняющимся с правами обычного пользователя с включенной службой контроля учетных записей.

Перед созданием 32-разрядного процесса определяется, не является ли он программой установки. Для этого проверяются следующие атрибуты.

-   В имени файла содержатся ключевые слова: «install», «setup» или «update».

-   Поля ресурсов определения версии «Versioning Resource» содержат следующие ключевые слова:  Vendor, Company Name, Product Name, File Description, Original Filename, Internal Name и Export Name.

-   Ключевые слова в параллельном манифесте встроены в исполняемый файл.

-   Ключевые слова в специальных записях StringTable связаны в исполняемом файле.

-   Ключевые атрибуты в данных сценария ресурса связаны в исполняемом файле.

-   Это законченные последовательности байтов внутри исполняемого файла.

> [!NOTE]
> Ключевые слова и последовательности байтов были получены при изучении общих характеристик различных технологий программ установки.

> [!NOTE]
> Чтобы система обнаружения установщика могла выявлять программы установки, должен быть включен параметр политики «Контроль учетных записей: обнаружение установки приложений и запрос на повышение прав». Этот параметр включен по умолчанию, и его можно настраивать локально, используя оснастку «Локальная политика безопасности» (Secpol.msc), или для домена, OU или определенных групп с помощью групповой политики (Gpedit.msc).


