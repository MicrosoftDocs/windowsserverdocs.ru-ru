---
title: "Настройка дополнительной защиты LSA"
description: "Безопасность Windows Server"
ms.custom: na
ms.prod: windows-server-threshold
ms.reviewer: na
ms.suite: na
ms.technology: security-credential-protection
ms.tgt_pltfrm: na
ms.topic: article
ms.assetid: 038e7c2b-c032-491f-8727-6f3f01116ef9
author: coreyp-at-msft
ms.author: coreyp
manager: dongill
ms.date: 10/12/2016
ms.openlocfilehash: fcfb0dab10d28413cf4ad06dd583274f217c91fa
ms.sourcegitcommit: db290fa07e9d50686667bfba3969e20377548504
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/12/2017
---
# <a name="configuring-additional-lsa-protection"></a>Настройка дополнительной защиты LSA

>Область применения: Windows Server (канал точками годовой), Windows Server 2016

В этом разделе для ИТ-специалистов описывается настройка дополнительной защиты для процесса локальной системы безопасности (LSA), чтобы предотвратить внедрение кода, которое может скомпрометировать учетные данные.

LSA, в которую входит процесс локальной безопасности центра сервера службы (LSASS), проверяет пользователей во время локального и удаленного входа и применяет локальные политики безопасности. Операционная система Windows 8.1 предоставляет дополнительную защиту для LSA, предотвращая считывание памяти и внедрение кода незащищенными процессами. Это усиливает безопасность учетных данных, которые хранит LSA и управляет. Параметр защищенного процесса для LSA можно настроить в Windows 8.1, но нельзя настроить в Windows RT 8.1. Если этот параметр используется в сочетании с безопасной загрузкой, то обеспечивается дополнительная защита, поскольку не действует отключение раздела реестра HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa.

### <a name="protected-process-requirements-for-plug-ins-or-drivers"></a>Требования к защищенным процессам для подключаемых модулей и драйверов
Для подключаемого модуля или драйвера LSA для успешной загрузки как защищенный процесс он должен соответствовать следующим условиям.

1.  Проверка подписи

    Защищенный режим требует, что любой подключаемый модуль, загружаемый в LSA имеет цифровую подпись с подпись корпорации Майкрософт. Поэтому все подключаемые модули без подписи, а не подписаны с помощью подписи Майкрософт не будут загружаться в LSA. Примерами таких подключаемых модулей являются драйверы смарт-карт, подключаемые модули для шифрования и фильтры паролей.

    Подключаемые модули LSA, являются драйверами, например драйверы смарт-карты, должны быть подписаны с помощью сертификации WHQL. Дополнительные сведения см. в разделе [подпись выпуска WHQL (драйверы Windows)](https://msdn.microsoft.com/library/windows/hardware/ff553976%28v=vs.85%29.aspx).

    Подключаемые модули LSA, не участвующие в процессе сертификации WHQL, должны быть подписаны с помощью [служба подписей файлов для LSA](https://go.microsoft.com/fwlink/?LinkId=392590).

2.  Соответствие руководству по процессам Microsoft Security Development Lifecycle (SDL)

    Все подключаемые модули должны отвечать руководству по процессам SDL применимо. Дополнительные сведения см. в разделе [приложение Microsoft Security Development Lifecycle (SDL)](https://msdn.microsoft.com/library/windows/desktop/cc307891.aspx).

    Даже подключаемых модулей являются правильную подпись Майкрософт, несоответствия процессу SDL может сделать невозможной загрузку подключаемого модуля.

#### <a name="recommended-practices"></a>Рекомендации
Тщательно проверьте наличие защиты LSA по следующему списку включен перед широким применением функции:

-   Определите все подключаемые модули LSA и драйверы, которые используются в вашей организации. 
    Сюда входят сторонних драйверов и подключаемых модулей, например драйверы смарт-карт и подключаемые модули для шифрования, а также все разработанное внутри программное обеспечение, которое используется для фильтрации паролей или уведомления о смене пароля.

-   Убедитесь, что все подключаемые модули LSA имеют цифровую подпись с сертификатом Майкрософт, чтобы подключаемый модуль не удастся выполнить загрузку.

-   Убедитесь, что все нужные подписи подключаемые модули успешно загружаются в LSA и работают ожидаемым образом.

-   Используйте журналы аудита можно определить подключаемые модули LSA и драйверы, которые не удалось загрузить в качестве защищенного процесса.

## <a name="how-to-identify-lsa-plug-ins-and-drivers-that-fail-to-run-as-a-protected-process"></a>Как определить подключаемые модули LSA и драйверы, которые не удалось загрузить в качестве защищенного процесса
События, описанные в этом разделе, находятся в операционном журнале в папке приложений и служб\microsoft\windows\codeintegrity. Они помогут определить подключаемые модули LSA и драйверы, которые не удалось загрузить из-за подписями. Для управления этими событиями можно использовать **wevtutil** средство командной строки. Сведения об этом средстве см. в разделе [Wevtutil](../../administration/windows-commands/Wevtutil.md).

### <a name="before-opting-in-how-to-identify-plug-ins-and-drivers-loaded-by-the-lsassexe"></a>Перед включением защиты: определение подключаемых модулей и драйверов, загружаемых процессом lsass.exe
Можно использовать в режиме аудита можно определить подключаемые модули LSA и драйверы, которые не будут загружаться в режиме защиты LSA. В режиме аудита система будет создавать события в журнале, определяют все подключаемые модули и драйверы, которые будет невозможно загрузить в LSA, если включена защита LSA. Сообщения заносятся без блокировки подключаемые модули и драйверы.

##### <a name="to-enable-the-audit-mode-for-lsassexe-on-a-single-computer-by-editing-the-registry"></a>Чтобы включить режим аудита для Lsass.exe на одном компьютере с помощью реестра

1.  Откройте редактор реестра (RegEdit.exe) и перейдите в раздел реестра, который находится по адресу: HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\LSASS.exe.

2.  Задайте значение раздела реестра для **AuditLevel =: 00000008**.

3.  Перезагрузите компьютер.

Проанализируйте результаты событие 3065 и событие 3066.

-   **Событие 3065**: это событие записывается, если при проверке целостности кода установлено, что процесс (обычно lsass.exe) пытался загрузить драйвер, который не отвечает требованиям безопасности для общих сеансов. Однако из-за, заданная Системная политика разрешает изображения для загрузки.

-   **Событие 3066**: это событие записывается, если при проверке целостности кода установлено, что процесс (обычно lsass.exe) пытался загрузить драйвер, который не отвечает требованиям к уровню подписи Майкрософт. Однако из-за, заданная Системная политика разрешает изображения для загрузки.

> [!IMPORTANT]
> Эти события не создаются, когда отладчик ядра подключен, который включен в системе.
> 
> Если подключаемый модуль или драйвер содержит общие сеансы, с событие 3065 записывается событие 3066. Удаление общих разделов следует запретить оба события появляться, если подключаемый модуль не отвечает требованиям к уровню подписи Майкрософт.

Чтобы включить режим аудита для нескольких компьютеров в домене, можно использовать клиентское расширение реестра групповой политики для развертывания значение реестра для уровня аудита Lsass.exe. Вам необходимо изменить раздел реестра HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\LSASS.exe.

##### <a name="to-create-the-auditlevel-value-setting-in-a-gpo"></a>Создание параметра AuditLevel в объекте групповой Политики

1.  Откройте консоль управления групповой политикой (GPMC).

2.  Создайте объект новой групповой политики (GPO) связан на уровне домена или связан с подразделением, содержащий учетные записи компьютеров. Или можно выбрать уже развернутый объект групповой Политики.

3.  Щелкните правой кнопкой мыши объект групповой Политики, а затем нажмите кнопку **изменить** чтобы открыть редактор управления групповыми политиками.

4.  Разверните **Конфигурация компьютера**, разверните **предпочтения**, а затем разверните **параметры Windows**.

5.  Щелкните правой кнопкой мыши **реестра**, наведите курсор на **New**, а затем нажмите кнопку **элемента реестра**. **Новые свойства реестра** откроется диалоговое окно.

6.  В **куст** выберите **HKEY_LOCAL_MACHINE.**

7.  В **путь к разделу** перейдите к **SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\LSASS.exe**.

8.  В **имя значения** введите **AuditLevel**.

9. В **тип значения** поле, установите **REG_DWORD**.

10. В **значение** введите **00000008**.

11. Нажмите кнопку **ОК**.

> [!NOTE]
> Объект групповой Политики вступили в силу, изменение объекта групповой Политики, которые должны реплицироваться на все контроллеры домена в домене.

Чтобы включить в программу для дополнительной защиты LSA на нескольких компьютерах, можно использовать клиентское расширение реестра групповой политики, изменив параметр HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa. Инструкции о том, как это сделать см. в разделе [Настройка дополнительной защиты LSA для учетных данных](#BKMK_HowToConfigure) в этом разделе.

### <a name="after-opting-in-how-to-identify-plug-ins-and-drivers-loaded-by-the-lsassexe"></a>После включения защиты: определение подключаемых модулей и драйверов, загружаемых процессом lsass.exe
Можно использовать журнал событий можно определить подключаемые модули LSA и драйверы, которые не удалось загрузить в режиме защиты LSA. Если включен защищенный процесс LSA, система создает журналы событий, определите все подключаемые модули и драйверы, которые не удалось загрузить в LSA.

Проанализируйте результаты события 3033 и события 3063.

-   **Событие 3033**: это событие записывается, если при проверке целостности кода установлено, что процесс (обычно lsass.exe) пытался загрузить драйвер, который не отвечает требованиям к уровню подписи Майкрософт.

-   **Событие 3063**: это событие записывается, если при проверке целостности кода установлено, что процесс (обычно lsass.exe) пытался загрузить драйвер, который не отвечает требованиям безопасности для общих сеансов.

Общие сеансы обычно образуются приемы программирования, позволяющие данным экземпляра взаимодействовать с другими процессами, использующими тот же контекст безопасности. Это может привести к уязвимости системы безопасности.

## <a name="BKMK_HowToConfigure"></a>Настройка дополнительной защиты LSA для учетных данных
На устройствах под управлением Windows 8.1 (с или без безопасной загрузкой или UEFI) конфигурации можно, выполнив процедуры, описанные в этом разделе. Для устройств под управлением Windows RT 8.1 защита lsass.exe всегда включена и ее нельзя выключить.

### <a name="on-x86-based-or-x64-based-devices-using-secure-boot-and-uefi-or-not"></a>На устройствах x86 86 или на базе x64 с помощью безопасную загрузку и UEFI или нет
На x86 86 или на базе x64 устройств, использующих безопасную загрузку и UEFI переменную UEFI во встроенном по UEFI устанавливается, когда защита LSA включается с помощью раздела реестра. Если параметр хранится во встроенном по, переменную UEFI нельзя удалить или изменить в разделе реестра. Необходимо сбросить переменную UEFI.

отключены x86 86 или на базе x64 устройств, которые не поддерживают UEFI и безопасной загрузки, не может хранить конфигурацию для защиты LSA во встроенном по и полагаться исключительно на наличие раздела реестра. В этом сценарии можно отключить защиту LSA с помощью удаленного доступа к устройству.

Чтобы включить или отключить защиту LSA можно использовать следующие процедуры:

##### <a name="to-enable-lsa-protection-on-a-single-computer"></a>Включение защиты LSA на отдельном компьютере

1.  Откройте редактор реестра (RegEdit.exe) и перейдите в раздел реестра, который находится по адресу: HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa.

2.  Задайте значение раздела реестра для: «RunAsPPL» = DWORD: 00000001.

3.  Перезагрузите компьютер.

##### <a name="to-enable-lsa-protection-using-group-policy"></a>Включение защиты LSA с помощью групповой политики

1.  Откройте консоль управления групповой политикой (GPMC).

2.  Создайте новый объект групповой Политики, который связан на уровне домена или связан с подразделением, содержащий учетные записи компьютеров. Или можно выбрать уже развернутый объект групповой Политики.

3.  Щелкните правой кнопкой мыши объект групповой Политики, а затем нажмите кнопку **изменить** чтобы открыть редактор управления групповыми политиками.

4.  Разверните **Конфигурация компьютера**, разверните **предпочтения**, а затем разверните **параметры Windows**.

5.  Щелкните правой кнопкой мыши **реестра**, наведите курсор на **New**, а затем нажмите кнопку **элемента реестра**. **Новые свойства реестра** откроется диалоговое окно.

6.  В **куст** выберите **HKEY_LOCAL_MACHINE**.

7.  В **путь к разделу** перейдите к **SYSTEM\CurrentControlSet\Control\Lsa**.

8.  В **имя значения** введите **RunAsPPL**.

9. В **тип значения** выберите **REG_DWORD**.

10. В **значение** введите **00000001**.

11. Нажмите кнопку **ОК**.

##### <a name="to-disable-lsa-protection"></a>Отключение защиты LSA

1.  Откройте редактор реестра (RegEdit.exe) и перейдите в раздел реестра, который находится по адресу: HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa.

2.  Удалить следующее значение из раздела реестра: «RunAsPPL» = DWORD: 00000001.

3.  Чтобы удалить переменную UEFI, если на устройстве используется безопасная загрузка, используйте средство отключения защищенного процесса локальной системы безопасности (LSA).

    Дополнительные сведения о средстве отключения см. в разделе [загрузить локальной системы безопасности (LSA) защищенного процесса отключения в официальном центре загрузки Майкрософт](https://www.microsoft.com/download/details.aspx?id=40897).

    Дополнительные сведения об управлении безопасной загрузкой см. в разделе [встроенное по UEFI](https://technet.microsoft.com/library/hh824898.aspx).

    > [!WARNING]
    > Когда безопасная загрузка отключена, сбрасываются все конфигурации, относящиеся к UEFI и безопасной загрузке. Выключать безопасную загрузку следует только в том случае, если не удалось отключить защиту LSA всех других способов.

### <a name="verifying-lsa-protection"></a>Проверка защиты LSA
Чтобы определить, если запуска LSA в защищенном режиме при загрузке Windows, найдите следующее событие WinInit в **системы** журнала в разделе **журналы Windows**:

-   12: LSASS.exe запущен как защищенный процесс уровня: 4

## <a name="additional-resources"></a>Дополнительные ресурсы
[Защита учетных данных и управление ими](credentials-protection-and-management.md)

[Служба подписей файлов для LSA](https://go.microsoft.com/fwlink/?LinkId=392590)


