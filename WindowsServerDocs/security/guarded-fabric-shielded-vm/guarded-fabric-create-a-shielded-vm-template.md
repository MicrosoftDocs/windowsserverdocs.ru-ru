---
title: Создание диска шаблона экранированной виртуальной машины Windows
ms.prod: windows-server
ms.topic: article
ms.assetid: 9c8b84e8-1f5a-47a1-83ca-b1dbd801cb0b
manager: dongill
author: rpsqrd
ms.author: ryanpu
ms.technology: security-guarded-fabric
ms.date: 01/29/2019
ms.openlocfilehash: 82725e654fb4c7296b092019db111f9d3debad6d
ms.sourcegitcommit: 771db070a3a924c8265944e21bf9bd85350dd93c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/27/2020
ms.locfileid: "85475391"
---
# <a name="create-a-windows-shielded-vm-template-disk"></a>Создание диска шаблона экранированной виртуальной машины Windows

>Область применения: Windows Server (половина ежегодного канала), Windows Server 2016, Windows Server 2019


Как и в случае с обычными виртуальными машинами, можно создать шаблон виртуальной машины (например, [шаблон виртуальной машины в Virtual Machine Manager (VMM)](https://technet.microsoft.com/system-center-docs/vmm/manage/manage-library-add-vm-templates)), чтобы клиенты и администраторы могли развертывать новые виртуальные машины в структуре с помощью диска шаблона. Так как экранированные виртуальные машины являются зависимыми от безопасности, существуют дополнительные действия по созданию шаблона виртуальной машины, поддерживающего экранирование. В этом разделе описаны действия по созданию диска экранированного шаблона и шаблона виртуальной машины в VMM.

Чтобы понять, как этот раздел соответствует общему процессу развертывания экранированных виртуальных машин, см. раздел [этапы настройки поставщика услуг размещения для защищенных узлов и экранированных виртуальных машин](guarded-fabric-configuration-scenarios-for-shielded-vms-overview.md).

## <a name="prepare-an-operating-system-vhdx"></a>Подготовка VHDX операционной системы

Сначала Подготовьте диск операционной системы, который затем будет запущен с помощью мастера создания диска с экранированным шаблоном. Этот диск будет использоваться в качестве диска операционной системы на виртуальных машинах вашего клиента. Вы можете использовать любые существующие средства для создания этого диска, например, Windows Desktop Image Service Manager (DISM), или вручную настроить виртуальную машину с пустым VHDX-файлом и установить на этот диск ОС. При настройке диска необходимо соблюдать следующие требования, характерные для виртуальных машин версии 2 и экранирования.

| Требование для VHDX | Причина |
|-----------|----|
|Должен быть диском таблицы разделов GUID (GPT) | Требуется для поддержки UEFI виртуальных машин версии 2|
|Тип диска должен быть **базовым** , а не **динамическим**. <br>Примечание. Это относится к типу логического диска, а не к динамически расширяемой функции VHDX, поддерживаемой Hyper-V. | BitLocker не поддерживает динамические диски.|
|Диск содержит по крайней мере два раздела. Один раздел должен включать диск, на котором установлена ОС Windows. Это диск, который шифрование BitLocker будет шифровать. Другой раздел — это активный раздел, который содержит загрузчик и остается незашифрованным, чтобы компьютер можно было запустить.|Требуется для BitLocker|
|Файловая система NTFS | Требуется для BitLocker|
|Операционная система, установленная на VHDX, является одной из следующих:<br>— Windows Server 2019, Windows Server 2016, Windows Server 2012 R2 или Windows Server 2012 <br>— Windows 10, Windows 8.1, Windows 8| Требуется для поддержки виртуальных машин версии 2 и шаблона безопасной загрузки Майкрософт|
|Операционная система должна быть обобщенной (запустите sysprep.exe) | Подготовка шаблонов включает в себя специализацию виртуальных машин для рабочей нагрузки конкретного клиента.|

> [!NOTE]
> Если вы используете VMM, не копируйте диск шаблона в библиотеку VMM на этом этапе.

## <a name="run-windows-update-on-the-template-operating-system"></a>Запуск Центр обновления Windows в операционной системе шаблона

На диске шаблона убедитесь, что в операционной системе установлены все последние обновления Windows. Недавно выпущенные обновления повышают надежность сквозного процесса экранирования — процесса, который может завершиться ошибкой, если шаблон операционной системы не обновлен.

## <a name="prepare-and-protect-the-vhdx-with-the-template-disk-wizard"></a>Подготовка и защита VHDX с помощью мастера создания диска шаблона

Чтобы использовать диск шаблона с экранированными виртуальными машинами, необходимо подготовить и зашифровать диск с помощью BitLocker, используя мастер создания диска экранированного шаблона. Этот мастер создаст хэш для диска и добавит его в каталог подписей тома (VSC). VSC подписывается с помощью указанного сертификата и используется в процессе подготовки, чтобы гарантировать, что диск, развернутый для клиента, не был изменен или заменен на диск, которому не доверяет клиент. Наконец, BitLocker устанавливается в операционной системе диска (если это еще не сделано) для подготовки диска к шифрованию во время подготовки виртуальной машины.

> [!NOTE]
> Мастер создания диска шаблона изменит диск шаблона, указанный на месте. Перед запуском мастера может потребоваться создать копию незащищенного VHDX-файла, чтобы обновить диск позднее. Вы не сможете изменить диск, который был защищен с помощью мастера создания диска шаблонов.

Выполните следующие действия на компьютере под управлением Windows Server 2016, Windows 10 (с установленными средствами удаленного управления сервером, RSAT) или более поздней версии (не обязательно быть защищенным узлом или сервером VMM):

1. Скопируйте обобщенный VHDX, созданный в поле подготовка к использованию [VHDX операционной системы](#prepare-an-operating-system-vhdx) на сервер, если он еще не создан.

2. Для локального администрирования сервера установите компонент **средства экранированной виртуальной машины** из **средства удаленного администрирования сервера** на сервере.

        Install-WindowsFeature RSAT-Shielded-VM-Tools -Restart

    Можно также администрировать сервер с клиентского компьютера, на котором установлена [средства удаленного администрирования сервера Windows 10](https://www.microsoft.com/download/details.aspx?id=45520).

3. Получите или создайте сертификат для подписания VSC для VHDX, который станет диском шаблона для новых экранированных виртуальных машин. Сведения об этом сертификате будут отображаться для клиентов при создании файлов данных экранирования и авторизации дисков, которым они доверяют. Поэтому важно получить этот сертификат из центра сертификации, который будет взаимно доверенным для вас и ваших клиентов. В корпоративных сценариях, где вы одновременно являетесь клиентом и поставщиками услуг размещения и клиента, вы можете использовать этот сертификат из PKI.

    Если вы настраиваете тестовую среду и хотите использовать самозаверяющий сертификат для подготовки диска шаблона, выполните команду, аналогичную следующей:

        New-SelfSignedCertificate -DnsName publisher.fabrikam.com

4. Запустите **Мастер создания шаблона диска** из папки " **Администрирование** " в меню "пуск" или введите **TemplateDiskWizard.exe** в командной строке.

5. На странице **сертификат** нажмите кнопку **Обзор** , чтобы отобразить список сертификатов. Выберите сертификат, с помощью которого будет подготовлен шаблон диска. Нажмите кнопку **ОК**, а затем — **Далее**.

6. На странице виртуальный диск нажмите кнопку **Обзор** , чтобы выбрать подготовленный VHDX-файл, а затем нажмите кнопку **Далее**.

7. На странице Каталог подписей укажите понятное **имя** и версию диска **.** Эти поля позволяют определить диск после его подготовки.

    Например, для **имени диска** можно ввести _WS2016_ и для **Version**, _1.0.0.0_

8. Проверьте параметры на странице мастера Проверка параметров. При нажатии кнопки " **создать**" мастер включит BitLocker на диске шаблона, вычислит хэш диска и создаст каталог сигнатур томов, хранящийся в метаданных VHDX.

    Дождитесь завершения процесса подготовки, прежде чем пытаться подключить или переместить диск шаблона. Выполнение этого процесса может занять некоторое время в зависимости от размера диска.

    > [!IMPORTANT]
    > Диски шаблонов можно использовать только с процессом подготовки защищенной экранированной виртуальной машины.
    > Попытка загрузить обычную (неэкранированную) виртуальную машину с использованием шаблона диска, скорее всего, приведет к неустранимой ошибке (синий экран) и не будет поддерживаться.

9. На странице **Сводка** сведения о шаблоне диска, сертификате, используемом для подписания VSC, и отображается издатель сертификата. Нажмите кнопку **Закрыть**, чтобы выйти из мастера.

Если вы используете VMM, выполните действия, описанные в остальных разделах этой статьи, чтобы включить диск шаблона в шаблон экранированной виртуальной машины в VMM.

## <a name="copy-the-template-disk-to-the-vmm-library"></a>Копирование диска шаблона в библиотеку VMM

Если вы используете VMM, то после создания диска шаблона его необходимо скопировать в общую папку библиотеки VMM, чтобы узлы могли скачивать и использовать диск при подготовке новых виртуальных машин. Используйте следующую процедуру, чтобы скопировать диск шаблона в библиотеку VMM, а затем Обновить библиотеку.

1. Скопируйте VHDX-файл в общую папку библиотеки VMM. Если вы использовали конфигурацию VMM по умолчанию, скопируйте диск шаблона в _ \\ <vmmserver> \мссквммлибрари\вхдс_.

2. Обновите сервер библиотеки. Откройте рабочую область **Библиотека** , разверните узел **серверы библиотеки**, щелкните правой кнопкой мыши сервер библиотеки, который требуется обновить, и выберите команду **Обновить**.

3. Затем укажите VMM с информацией об операционной системе, установленной на диске шаблона:

    a. Найдите только что импортированный диск шаблона на сервере библиотеки в рабочей области **Библиотека** .

    b. Щелкните диск правой кнопкой мыши и выберите пункт **Свойства**.

    c. В поле **Операционная система**разверните список и выберите операционную систему, установленную на диске. При выборе операционной системы VMM указывает, что VHDX-файл не пуст.

    d. Обновив свойства, нажмите кнопку **ОК**.

Маленький значок щита рядом с именем диска обозначает диск как подготовленный диск шаблона для экранированных виртуальных машин. Можно также щелкнуть правой кнопкой мыши заголовки столбцов и переключить **экранированный** столбец, чтобы увидеть текстовое представление, указывающее, предназначен ли диск для обычных или экранированных РАЗВЕРТЫВАНИЙ виртуальных машин.

![Диск шаблона экранированной виртуальной машины](../media/Guarded-Fabric-Shielded-VM/shielded-vm-template-disk.png)

## <a name="create-the-shielded-vm-template-in-vmm-using-the-prepared-template-disk"></a>Создание шаблона экранированной виртуальной машины в VMM с помощью подготовленного диска шаблона

Используя подготовленный диск шаблона в библиотеке VMM, вы можете создать шаблон виртуальной машины для экранированных виртуальных машин. Шаблоны виртуальных машин для экранированных виртуальных машин немного отличаются от традиционных шаблонов виртуальных машин в том, что определенные параметры являются фиксированными (виртуальные машины поколения 2, UEFI и безопасная загрузка и т. д.), а другие недоступны (Настройка клиента ограничена несколькими, выберите Свойства виртуальной машины). Чтобы создать шаблон виртуальной машины, выполните следующие действия.

1. В рабочей области **Библиотека** щелкните **создать шаблон виртуальной машины** на вкладке Главная вверху.

2. На странице **Выбор источника** щелкните **Использовать существующий шаблон виртуальной машины или виртуальный жесткий диск, хранящийся в библиотеке**, а затем нажмите кнопку **Обзор**.

3. В появившемся окне выберите подготовленный диск шаблона из библиотеки VMM. Чтобы упростить поиск подготовленных дисков, щелкните правой кнопкой мыши заголовок столбца и включите **экранированный** столбец. Нажмите кнопку **ОК** , а затем **Далее**.

4. Укажите имя шаблона виртуальной машины и (необязательно) описание, а затем нажмите кнопку **Далее**.

5. На странице **Настройка оборудования** укажите возможности виртуальных машин, созданных на основе этого шаблона. Убедитесь, что по крайней мере одна сетевая карта доступна и настроена в шаблоне виртуальной машины. Единственным способом подключения клиента к экранированной виртуальной машине является использование подключение к удаленному рабочему столу, служба удаленного управления Windows или других предварительно настроенных средств удаленного управления, работающих по сетевым протоколам.

    Если вы решили использовать статические пулы IP-адресов в VMM вместо запуска DHCP-сервера в сети клиента, вам необходимо будет предупредить клиентов с этой конфигурацией. Когда клиент предоставляет файл данных экранирования, который содержит файл автоматической установки для VMM, ему необходимо предоставить специальные значения заполнителя для сведений о пуле статических IP-адресов. Дополнительные сведения о заполнителях VMM в файлах автоматической установки клиента см. в разделе [Создание файла ответов](guarded-fabric-tenant-creates-shielding-data.md#create-an-answer-file).

6. На странице **Настройка операционной системы** VMM будет отображать только несколько параметров для экранированных виртуальных машин, включая ключ продукта, часовой пояс и имя компьютера. Некоторые защищенные сведения, такие как пароль администратора и доменное имя, указываются клиентом через файл данных экранирования (. PDK-файл).

    > [!NOTE]
    > Если вы решили указать ключ продукта на этой странице, убедитесь, что она действительна для операционной системы на диске шаблона. Если используется неверный ключ продукта, создание виртуальной машины завершится ошибкой.

После создания шаблона клиенты могут использовать его для создания новых виртуальных машин. Необходимо убедиться, что шаблон виртуальной машины является одним из ресурсов, доступных роль пользователя "Администратор клиента" (в VMM роли пользователей находятся в рабочей области " **Параметры** ").

## <a name="prepare-and-protect-the-vhdx-using-powershell"></a>Подготовка и защита VHDX с помощью PowerShell

В качестве альтернативы запуску мастера создания диска шаблона можно скопировать диск шаблона и сертификат на компьютер, на котором выполняется RSAT, и запустить программу [Protect-темплатедиск](https://docs.microsoft.com/powershell/module/shieldedvmtemplate/protect-templatedisk?view=win10-ps
) , чтобы начать процесс подписи.
В следующем примере используются имя и сведения о версии, указанные в параметрах _templatename_ и _Version_ .
VHDX-файл, предоставленный для `-Path` параметра, будет перезаписан с обновленным диском шаблона, поэтому перед выполнением команды обязательно создайте копию.

```powershell
# Replace "THUMBPRINT" with the thumbprint of your template disk signing certificate in the line below
$certificate = Get-Item Cert:\LocalMachine\My\THUMBPRINT

Protect-TemplateDisk -Certificate $certificate -Path "WindowsServer2019-ShieldedTemplate.vhdx" -TemplateName "Windows Server 2019" -Version 1.0.0.0
```

Теперь ваш диск шаблона готов к использованию для подготовки экранированных виртуальных машин.
Если вы используете System Center Virtual Machine Manager для развертывания виртуальной машины, теперь можно скопировать VHDX-файл в библиотеку VMM.

Также может потребоваться извлечь каталог подписей тома из VHDX-файлов.
Этот файл используется для предоставления сведений о сертификате подписи, имени диска и версии для владельцев виртуальных машин, которые хотят использовать шаблон.
Необходимо импортировать этот файл в мастер файлов данных экранирования, чтобы авторизовать вас, автор шаблона при наличии сертификата для подписи, чтобы создать этот и будущие диски шаблонов для них.

Чтобы извлечь каталог подписей тома, выполните следующую команду в PowerShell:

```powershell
Save-VolumeSignatureCatalog -TemplateDiskPath 'C:\temp\MyLinuxTemplate.vhdx' -VolumeSignatureCatalogPath 'C:\temp\MyLinuxTemplate.vsc'
```


## <a name="next-step"></a>Следующий шаг

> [!div class="nextstepaction"]
> [Создание файла данных экранирования](guarded-fabric-tenant-creates-shielding-data.md)

## <a name="additional-references"></a>Дополнительные ссылки

- [Пошаговая настройка поставщика служб размещения для защищенных узлов и экранированных виртуальных машин](guarded-fabric-configuration-scenarios-for-shielded-vms-overview.md)
- [Защищенная структура и экранированные виртуальные машины](guarded-fabric-and-shielded-vms-top-node.md)
