---
title: Создание диска шаблона экранированной виртуальной Машины Windows
ms.custom: na
ms.prod: windows-server-threshold
ms.topic: article
ms.assetid: 9c8b84e8-1f5a-47a1-83ca-b1dbd801cb0b
manager: dongill
author: rpsqrd
ms.technology: security-guarded-fabric
ms.date: 01/29/2019
ms.openlocfilehash: d9f07d2e6e93d4f8d198c2fc3b62c28c940bdefb
ms.sourcegitcommit: eaf071249b6eb6b1a758b38579a2d87710abfb54
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/31/2019
ms.locfileid: "66447508"
---
# <a name="create-a-windows-shielded-vm-template-disk"></a>Создание диска шаблона экранированной виртуальной Машины Windows

>Относится к: Windows Server 2019 г., Windows Server (полугодовой канал), Windows Server 2016

Как с обычными виртуальными машинами, можно создать шаблон виртуальной Машины (например, [шаблона виртуальной Машины в Virtual Machine Manager (VMM)](https://technet.microsoft.com/system-center-docs/vmm/manage/manage-library-add-vm-templates)) для упрощения для клиентов и администраторов для развертывания новых виртуальных машин в структуре, с помощью диска шаблона. Поскольку экранированные виртуальные машины находятся конфиденциальные активы, существуют дополнительные шаги для создания шаблона виртуальной Машины, которая поддерживает экранирования. В этом разделе описано, как создать шаблон диска и шаблона виртуальной Машины в VMM.

Чтобы понять, как в этом разделе встраивается в общем процессе развертывания экранированных виртуальных машин, см. в разделе [размещения службы поставщика Пошаговое руководство по настройке защищенных узлов и экранированных виртуальных машин](guarded-fabric-configuration-scenarios-for-shielded-vms-overview.md).

## <a name="prepare-an-operating-system-vhdx"></a>Подготовить операционную систему VHDX

Сначала Подготовьте диска ОС, который выполнит в мастере создания экранированных диска шаблона. Этот диск будет использоваться в качестве диска ОС в виртуальные машины клиента. Средства можно использовать для создания этого диска, например Microsoft Desktop образа Service Manager ими (DISM), или вручную настроить виртуальную Машину с пустым vhdx-ФАЙЛ и установки операционной системы на этом диске. При настройке диск, он должен соответствовать следующим требованиям, которые относятся к версии 2 и/или экранированных виртуальных машин: 

| Требование для vhdx-файлов | `Reason` |
|-----------|----|
|Должны представлять собой диск таблица разделов GUID (GPT) | Для виртуальных машин поколения 2 для поддержки UEFI|
|Тип диска должен быть **основные** в отличие от **динамическое**. <br>Примечание. Это относится к типу логического диска, не «динамически расширяемый» VHDX компонента, поддерживаемого Hyper-V. | BitLocker не поддерживает динамические диски.|
|На диске имеется по крайней мере два раздела. Один из разделов должен содержать диск, на котором установлена Windows. Это диск, который будет шифроваться BitLocker. Второй раздел является активный раздел, который содержит загрузчик и остается незашифрованным, так, чтобы компьютер можно запустить.|Необходимые для BitLocker|
|Используется файловая система NTFS | Необходимые для BitLocker|
|Операционная система, установленная в VHDX является одним из следующих:<br>— Windows Server 2016, Windows Server 2012 R2 или Windows Server 2012 <br>-Windows 10, Windows 8.1, Windows 8| Для поддержки виртуальных машин поколения 2 и шаблон безопасной загрузки Майкрософт|
|Операционная система должна быть обобщенной (выполнения sysprep.exe) | Шаблон для подготовки нужно специализирующийся виртуальных машин для рабочей нагрузки для определенного клиента| 

> [!NOTE]
> Если вы используете VMM, не скопируйте шаблон диска в библиотеку VMM на этом этапе. 

## <a name="run-windows-update-on-the-template-operating-system"></a>Запустите Центр обновления Windows в операционной системе шаблона

На диске шаблона убедитесь, что операционная система имеет все последние обновления Windows. Недавно выпущенные обновления повысить надежность процесса экранирования end-to-end — это процесс, который может завершиться ошибкой, если полный шаблон операционной системы устарела.

## <a name="prepare-and-protect-the-vhdx-with-the-template-disk-wizard"></a>Подготовка и защищать VHDX с мастер шаблонов диска

Чтобы использовать диск шаблона с экранированные виртуальные машины, необходимо подготовить диск и зашифрован с помощью BitLocker с помощью мастера создания экранированных диска шаблона. Мастер создания хэша для диска и его добавления в каталог подписи тома (VSC). VSC подписывается с помощью сертификата, укажите и используется в процессе подготовки для обеспечения не развертываемого клиента диска была изменена или заменить на диск, который не считается доверенным для клиента. Наконец BitLocker устанавливается на диск операционной системы (если он не существует) для подготовки диска для шифрования во время подготовки виртуальной Машины.

> [!NOTE]
> Мастер шаблонов диска предстоит изменить диск шаблона, укажите на месте. Может потребоваться сделать копию незащищенные VHDX перед запуском мастера, чтобы обновить диск позднее. Вы не сможете изменить диск, который был защищен с помощью мастер шаблонов диска.

Выполните следующие действия на компьютере под управлением Windows Server 2016 (не нужно быть защищенный узел или сервер VMM).

1. Скопируйте обобщенный VHDX, созданных в [подготовить операционную систему VHDX](#prepare-an-operating-system-vhdx) к серверу, если он еще не выбран.

2. Для локального администрирования сервера, установите **средства для экранированной виртуальной Машины** функции **средства удаленного администрирования сервера** на сервере.

        Install-WindowsFeature RSAT-Shielded-VM-Tools -Restart
        
    Для администрирования сервера на клиентском компьютере, на котором установлен [средства удаленного администрирования сервера Windows 10](https://www.microsoft.com/en-us/download/details.aspx?id=45520).

3. Получите или создайте сертификат для подписи VSC для vhdx-файлов, который должен стать диск шаблона для новых экранированных виртуальных машин. Сведения об этом сертификате видят клиенты при создании их файлов данных экранирования и разрешаете диски, которым они доверяют. Таким образом очень важно получить этот сертификат в центре сертификации взаимно доверенным и его клиентам. В корпоративных сценариях местонахождения клиента и поставщика услуг размещения рассмотрите возможность выдачи этого сертификата из инфраструктуры открытых КЛЮЧЕЙ.

    Если вы являетесь среды тестирования и просто хотите использовать самозаверяющий сертификат для подготовки диска шаблона, выполните команду, аналогичную следующей:

        New-SelfSignedCertificate -DnsName publisher.fabrikam.com

4. Запуск **мастер шаблонов диска** из **Администрирование** папку, в меню "Пуск" или введя **TemplateDiskWizard.exe** в командной строке.

5. На **сертификат** щелкните **Обзор** для отображения списка сертификатов. Выберите сертификат, с которым необходимо подготовить диск шаблона. Нажмите кнопку **ОК**, а затем — **Далее**.

6. На странице виртуальный диск, щелкните **Обзор** выбрать VHDX, который вы подготовили, а затем **Далее**.

7. На странице "каталог подписи", введите понятное **имя диска** и **версии.** Эти поля присутствуют идентификации диска, когда оно было подготовлено.

    Например, для **имя диска** можно ввести _WS2016_ и **версии**, _1.0.0.0_

8. Просмотрите выбранные параметры на странице просмотрите параметры мастера. При нажатии кнопки **формирования**, мастер будет включить BitLocker на диске шаблона, вычислять хэш диска и создать каталог подписи тома, который хранится в метаданных диска VHDX.

    Подождите, пока процесс подготовки завершен прежде чем подключать или перемещение диска шаблона. Это может занять некоторое время, в зависимости от размера диска.

    > [!IMPORTANT]
    > Диски шаблонов может использоваться только с безопасной экранированной виртуальной Машины, процесс подготовки.
    > Попытки загрузки регулярных (неэкранированной) виртуальной Машины с помощью диска шаблона будет скорее всего, приведет к ошибке stop (синий экран) и не поддерживается.

9. На **Сводка** странице сведения о шаблоне диска, сертификат, используемый для подписывания VSC, и отображается издателя сертификата. Чтобы выйти из мастера, нажмите кнопку **Закрыть**.

Если вы используете VMM, следуйте указаниям в оставшихся разделах этой статьи для включения диска шаблона в шаблон экранированной виртуальной Машины в VMM. 

## <a name="copy-the-template-disk-to-the-vmm-library"></a>Скопируйте шаблон диска в библиотеку VMM

Если вы используете VMM, после создания диска шаблона, необходимо скопировать его в общую папку библиотеки VMM, узлы можно загрузить и использовать его при подготовке новых виртуальных машин. Используйте следующую процедуру, скопируйте шаблон диска в библиотеку VMM и затем обновите библиотеку.

1. Скопируйте vhdx-файл к общей папке библиотеки VMM. Если вы использовали конфигурации VMM по умолчанию, скопируйте диск шаблона для  _\\ <vmmserver>\MSSCVMMLibrary\VHDs_.

2. Обновите сервер библиотеки. Откройте **библиотеки** рабочей области, разверните **серверы библиотек**, щелкните правой кнопкой мыши на сервере библиотеки, которую требуется обновить и нажмите кнопку **обновить**.

3. Затем предоставить сведения об операционной системе, установленной на диске шаблона VMM:

    1. Найдите только что импортированный шаблон диска на сервере библиотеки в **библиотеки** рабочей области.

    2. Щелкните правой кнопкой мыши диск и нажмите кнопку **свойства**.

    В. Для **операционной системы**, разверните список и выберите операционной системы, установленной на диске. Выбор операционной системы указывает VMM VHDX не является пустым.

    Г. Обновив свойства, нажмите кнопку **ОК**.

Небольшой щита рядом с именем диска обозначает диск как диск подготовленный шаблон для экранированных виртуальных машин. Вы можете также щелкнуть правой кнопкой заголовки столбцов и переключить **экранированные** столбец, чтобы увидеть, указывающее, предназначен ли диск в развертываниях виртуальных Машин с равномерным или экранированной текстового представления.

![Диск шаблона экранированной виртуальной машины](../media/Guarded-Fabric-Shielded-VM/shielded-vm-template-disk.png)

## <a name="create-the-shielded-vm-template-in-vmm-using-the-prepared-template-disk"></a>Создание шаблона экранированной виртуальной Машины в VMM, с помощью диска подготовленный шаблон

С помощью диска готовый шаблон в библиотеке VMM вы готовы создать шаблон виртуальной Машины для экранированных виртуальных машин. Шаблоны виртуальных Машин для экранированных виртуальных машин немного отличаются от традиционных шаблонов виртуальных Машин, в том, что некоторые параметры имеют фиксированное значение (создания, включены две виртуальные Машины, UEFI и безопасной загрузки и т. д.), а другие — недоступен (настройки клиента ограничен несколько, выберите его свойства виртуальной машины) . Чтобы создать шаблон виртуальной Машины, выполните следующие действия.

1. В **библиотеки** рабочей области, щелкните **создания шаблонов виртуальных Машин** на вкладке "Главная" вверху.

2. На странице **Выбор источника** щелкните **Использовать существующий шаблон виртуальной машины или виртуальный жесткий диск, хранящийся в библиотеке**, а затем нажмите кнопку **Обзор**.

3. В появившемся окне выберите подготовленный шаблон диска из библиотеки VMM. Чтобы было легко определить, какие диски подготовлены, щелкните правой кнопкой мыши заголовок столбца и включите **экранированные** столбца. Нажмите кнопку **ОК** затем **Далее**.

4. Укажите имя шаблона виртуальной Машины и необязательное описание и нажмите кнопку **Далее**.

5. На **Настройка оборудования** странице, указать возможности виртуальных машин, созданных на основе этого шаблона. Убедитесь, что по крайней мере один сетевой Адаптер недоступен и не настроен на шаблон виртуальной Машины. Единственным способом для клиента для подключения к экранированной виртуальной Машины является через подключение удаленного рабочего стола, удаленного управления Windows или других средств предварительно настроенных удаленного управления, которые работают над сетевых протоколов.

    Если вы решили использовать статические пулы IP-адресов в VMM вместо DHCP-сервера в сети клиента, необходимо будет оповещать клиентов для этой конфигурации. Когда клиент предоставляет файл их данных экранирования, который содержит файл автоматической установки для VMM, им необходимо будет предоставить специальный заполнитель значения сведения пула статических IP-адрес. Дополнительные сведения о VMM текст в файлах автоматической установки клиента, см. в разделе [создайте файл ответов](guarded-fabric-tenant-creates-shielding-data.md#create-an-answer-file). 

6. На **Настройка операционной системы** странице, VMM отображается только несколько параметров для экранированных виртуальных машин, включая ключ продукта, часовой пояс и имя компьютера. Некоторые защищенную информацию, например имя домена и пароль администратора, указывается с помощью клиента через файл данных экранирования (. PDK-файл). 

    > [!NOTE]
    > Если вы решили задать ключ продукта на этой странице, убедитесь, что он является действительным для операционной системы на диске шаблона. Если используется неправильный ключ продукта, произойдет сбой создания виртуальной Машины.

После создания шаблона, клиенты могут использовать его для создания новых виртуальных машин. Вам будет необходимо убедиться, что шаблон виртуальной Машины является одним из ресурсов, доступных для роли пользователя администратора клиента (в VMM, роли пользователей находятся в **параметры** рабочей области).

## <a name="prepare-and-protect-the-vhdx-using-powershell"></a>Подготовка и защищать VHDX, с помощью PowerShell

Как альтернативу запуску мастер шаблонов диска можно скопировать диск шаблона и сертификат на компьютере под управлением RSAT и запустить [TemplateDisk защитить](https://docs.microsoft.com/powershell/module/shieldedvmtemplate/protect-templatedisk?view=win10-ps
) запускать процесс подписи.
В следующем примере используется имя и версия информация, указанная _TemplateName_ и _версии_ параметров.
VHDX, вы предоставляете `-Path` параметр будет быть перезаписан с диском, обновленный шаблон, поэтому не забудьте создать копию перед выполнением команды.

```powershell
# Replace "THUMBPRINT" with the thumbprint of your template disk signing certificate in the line below
$certificate = Get-Item Cert:\LocalMachine\My\THUMBPRINT

Protect-TemplateDisk -Certificate $certificate -Path "WindowsServer2019-ShieldedTemplate.vhdx" -TemplateName "Windows Server 2019" -Version 1.0.0.0
```

На диске шаблона теперь готов для использования для подготовки экранированных виртуальных машин.
Если вы используете System Center Virtual Machine Manager для развертывания виртуальной Машины, можно скопировать VHDX в библиотеку VMM.

Можно также извлечь каталог подписи тома из формата VHDX.
Этот файл используется для предоставления информации о сертификат для подписи, имя диска и версии Владельцы виртуальных Машин, которые хотят воспользоваться шаблоном.
Их необходимо импортировать этот файл в мастере файл данных экранирования, авторизовать вас, автор шаблона посчитать сертификат для подписи, чтобы создать эту и будущих шаблона диски для них.

Чтобы извлечь каталог подписи тома, выполните следующую команду в PowerShell:

```powershell
Save-VolumeSignatureCatalog -TemplateDiskPath 'C:\temp\MyLinuxTemplate.vhdx' -VolumeSignatureCatalogPath 'C:\temp\MyLinuxTemplate.vsc'
```


## <a name="next-step"></a>Дальнейшие действия

> [!div class="nextstepaction"]
> [Создайте файл данных экранирования](guarded-fabric-tenant-creates-shielding-data.md)

## <a name="see-also"></a>См. также

- [Размещение службы поставщика Пошаговое руководство по настройке защищенных узлов и экранированных виртуальных машин](guarded-fabric-configuration-scenarios-for-shielded-vms-overview.md)
- [Защищенная структура и экранированные виртуальные машины](guarded-fabric-and-shielded-vms-top-node.md)
