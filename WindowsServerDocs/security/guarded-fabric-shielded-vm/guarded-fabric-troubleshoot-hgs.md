---
title: Устранение неполадок службы защиты узла
ms.custom: na
ms.prod: windows-server-threshold
ms.topic: article
ms.assetid: 424b8090-0692-49a6-9dc4-3c0e77d74b80
manager: dongill
author: rpsqrd
ms.technology: security-guarded-fabric
ms.openlocfilehash: 2dc9a612fa9760a6ca5f05efe1c287fd0872a1d8
ms.sourcegitcommit: 0d0b32c8986ba7db9536e0b8648d4ddf9b03e452
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2019
ms.locfileid: "59861255"
---
# <a name="troubleshooting-the-host-guardian-service"></a>Устранение неполадок службы защиты узла

> Относится к: Windows Server (полугодовой канал), Windows Server 2016

В этом разделе описываются способы устранения распространенных проблем, возникающих при развертывании или работе сервера службы Защитника узлов (HGS) в защищенной структуре.
Если вы не уверены на характер неполадки, предварительного выполнения try [защищенных диагностики fabric](guarded-fabric-troubleshoot-diagnostics.md) на серверах HGS и узлов Hyper-V, чтобы сузить список потенциально вызывает.

## <a name="certificates"></a>Сертификаты

HGS несколько сертификатов для работы требуются, включая шифрование настроил и подписи сертификата, а также сертификат аттестации управляются HGS, сам.
Если эти сертификаты настроены неправильно, HGS сможет обрабатывать запросы от узлов Hyper-V, желающих подтвердить или разблокировать предохранители ключа для экранированных виртуальных машин.
В следующих разделах описываются распространенные проблемы, связанные с сертификатами, настроенный на HGS.

### <a name="certificate-permissions"></a>Разрешения на сертификат

HGS должен иметь возможность доступа к открытый и закрытый ключи для шифрования и подписывания сертификатов, добавленных к HGS с помощью отпечатка сертификата.
В частности, групповую управляемую учетную запись службы (gMSA), работающей службы HGS требуется доступ к ключам.
Чтобы найти групповой управляемой учетной записи, используемые HGS, выполните следующую команду строки PowerShell с повышенными привилегиями на сервере HGS:

```powershell
(Get-IISAppPool -Name KeyProtection).ProcessModel.UserName
```

Как предоставить доступ учетной записи gMSA для использования закрытого ключа зависит от того, где хранится ключ: на компьютере, где локальный файл сертификата, в аппаратный модуль безопасности (HSM) или с помощью пользовательского хранилища ключей стороннего поставщика.

#### <a name="grant-access-to-software-backed-private-keys"></a>Доступ к данным для закрытых ключей на основе программного обеспечения

Если вы используете самозаверяющий сертификат или сертификат, выданный центром сертификации, который является **не** хранятся в аппаратный модуль безопасности или поставщик пользовательского хранилища ключей, можно изменить разрешения закрытого ключа, выполнив следующие действия:

1. Откройте локальный сертификат manager (certlm.msc)
2. Разверните **личные > сертификаты** и найдите сертификат подписи или шифрования, который требуется обновить.
3. Щелкните сертификат правой кнопкой мыши и выберите **все задачи > Управление закрытыми ключами**.
4. Нажмите кнопку **добавить** предоставить новому пользователю доступ к закрытому ключу выбирать.
5. В средстве выбора объектов, введите имя учетной записи gMSA для HGS см. выше, а затем щелкните **ОК**.
6. Убедитесь, эта учетная запись имеет **чтения** доступ к сертификату.
7. Нажмите кнопку **ОК** чтобы закрыть окно разрешений.

Если выполняются HGS на основных серверных компонентов или удаленном управлении сервером, вы не сможете управление закрытыми ключами, с помощью диспетчера локального сертификата.
Вместо этого необходимо скачать [модуль защищенных Fabric средства PowerShell](https://www.powershellgallery.com/packages/GuardedFabricTools) которого дает возможность управлять разрешениями в PowerShell.

1. Откройте консоль PowerShell с повышенными привилегиями на компьютере Server Core или использовать удаленное взаимодействие PowerShell учетную запись с правами локального администратора HGS.
2. Выполните следующие команды, чтобы установить модуль PowerShell для средства защищенной структуры и предоставления управляемой учетной записи доступа к закрытому ключу.

```powershell
$certificateThumbprint = '<ENTER CERTIFICATE THUMBPRINT HERE>'

# Install the Guarded Fabric Tools module, if necessary
Install-Module -Name GuardedFabricTools -Repository PSGallery

# Import the module into the current session
Import-Module -Name GuardedFabricTools

# Get the certificate object
$cert = Get-Item "Cert:\LocalMachine\My\$certificateThumbprint"

# Get the gMSA account name
$gMSA = (Get-IISAppPool -Name KeyProtection).ProcessModel.UserName

# Grant the gMSA read access to the certificate
$cert.Acl = $cert.Acl | Add-AccessRule $gMSA Read Allow
```

#### <a name="grant-access-to-hsm-or-custom-provider-backed-private-keys"></a>Предоставление доступа к HSM или пользовательского поставщика резервным закрытых ключей

Если ваш сертификат закрытых ключей содержатся в аппаратный модуль безопасности (HSM) или поставщика пользовательского хранилища ключей (KSP), модель разрешений зависит от поставщика конкретного программного обеспечения.
Для получения наилучших результатов обратитесь к документации поставщика или поддерживает сайта сведения о том, как закрытый ключ, обрабатываются разрешения для конкретных устройств и программного обеспечения.

Некоторые аппаратные модули безопасности не поддерживают предоставление конкретного пользователя учетные записи доступа к закрытому ключу; Вместо этого они позволяют доступа учетной записи компьютера для всех ключей в конкретном наборе ключей.
Для таких устройств это обычно достаточно предоставить доступ к компьютеру к ключам и HGS, смогут использовать это подключение.

**Советы по аппаратные модули безопасности**

Ниже приведены рекомендуемые конфигурации параметры позволят вам успешно ключей из аппаратного модуля безопасности использования в службе HGS, Майкрософт и ее партнеров опыт.
Эти советы предназначены для вашего удобства и не гарантируется правильное во время чтения, а также они рекомендованных производителями аппаратного модуля безопасности.
Свяжитесь с производителем аппаратного модуля безопасности точные сведения, относящиеся к конкретному устройству, если у вас есть дополнительные вопросы.

Аппаратный модуль безопасности торговой марки и серии      | Предложение
----------------------|-------------
Gemalto SafeNet       | Убедитесь, что значение свойства использования ключа в файл запроса на сертификат сообщения 0xa0 и позволяя сертификат, используемый для подписывания и шифрования. Кроме того, необходимо предоставить учетную запись gMSA *чтение* доступ к закрытому ключу, используя средство диспетчера локальный сертификат (см. выше).
Thales nShield        | Убедитесь, что каждый узел HGS имеет доступ к системе безопасности, содержащий ключи подписывания и шифрования. Необходимо настроить разрешения для групповой управляемой учетной записи.
Utimaco CryptoServers | Убедитесь, что значение свойства использования ключа в файл запроса на сертификат 0x13, позволяя сертификат, используемый для шифрования, расшифровки и подписи.

### <a name="certificate-requests"></a>Запросы на сертификаты

Если вы используете центр сертификации для выдачи сертификатов в среде инфраструктуры открытых ключей (PKI), необходимо убедиться, что запрос сертификата включает в себя минимальные системные требования для использования HGS этих ключей.

**Сертификаты для подписи**

Свойство CSR | Обязательное значение
-------------|---------------
Алгоритм    | RSA
Размер ключа     | По крайней мере 2048 бит.
Использование ключа    | Подпись/входа/DigitalSignature

**Сертификаты шифрования**

Свойство CSR | Обязательное значение
-------------|---------------
Алгоритм    | RSA
Размер ключа     | По крайней мере 2048 бит.
Использование ключа    | Шифрование или шифрование/DataEncipherment

**Шаблоны служб сертификатов Active Directory**

Если вы используете шаблоны сертификатов служб сертификатов Active Directory (ADCS) для создания сертификатов, которые рекомендуется использовать шаблон со следующими параметрами:

Свойство Template ADCS | Обязательное значение
-----------------------|---------------
Категория поставщика      | Поставщик хранилища ключей
Имя алгоритма         | RSA
Минимальный размер ключа       | 2048
Цель                | Подпись и шифрование
Расширение использования ключа    | Шифрование данных цифровая подпись, шифрование ключей («Разрешить шифрование данных пользователя»)


### <a name="time-drift"></a>Смещение времени

Если время сервера значительно отклонилась от других узлов HGS, так и узлы Hyper-V в защищенной структуре, могут возникнуть проблемы с срок действия сертификата подписавшего аттестации.
Создается и правда о HGS продлить сертификат подписавшего аттестации и используется для подписи сертификатов работоспособности, выданных службой аттестации для защищенных узлов.

Чтобы обновить сертификат подписавшего аттестации, выполните следующую команду в строке PowerShell с повышенными привилегиями.

```powershell
Start-ScheduledTask -TaskPath \Microsoft\Windows\HGSServer -TaskName 
AttestationSignerCertRenewalTask
```

В качестве альтернативы можно выполнить вручную запланированную задачу, открыв **планировщик** (taskschd.msc), перейдя к **Библиотека планировщика заданий > Microsoft > Windows > HGSServer** и запуск задачу с именем **AttestationSignerCertRenewalTask**.

## <a name="switching-attestation-modes"></a>Переключение режима аттестации

При переключении HGS из режима доверенного платформенного МОДУЛЯ в режиме Active Directory или наоборот, используя [HgsServer набора](https://technet.microsoft.com/library/mt652180.aspx) командлета, может занять до 10 минут для каждого узла в кластере HGS, чтобы включить новый режим аттестации.
Это нормальное поведение.
Рекомендуется не удаляйте какие-либо политики, что позволяет узлам из предыдущих режим аттестации, убедитесь, что все узлы подтвердив, успешно используют новый режим аттестации.

**Известная проблема, при переходе из доверенного платформенного МОДУЛЯ в режиме AD**

Если вы инициализации HGS кластера в режиме TPM, а позже переключиться в режим Active Directory, имеется известная проблема, которую будет препятствовать доступу других узлов в кластере HGS переключение на новый режим аттестации.
Чтобы проверить, все серверы HGS используют режим правильный аттестации, выполните `Set-HgsServer -TrustActiveDirectory` **на каждом узле** кластера HGS.
Эта проблема не применяется при переключении из режима доверенного платформенного МОДУЛЯ в режим AD *и* кластера был изначально настроен в режиме AD.

Режим аттестации HGS сервера можно проверить, выполнив [Get-HgsServer](https://technet.microsoft.com/library/mt652162.aspx).

## <a name="memory-dump-encryption-policies"></a>Политики шифрования дампов памяти

Если вы настраиваете политики шифрования дампов памяти и не отображается по умолчанию с HGS дампа политик (Hgs\_NoDumps, Hgs\_DumpEncryption и Hgs\_DumpEncryptionKey) или (командлет политики дампа Add-HgsAttestationDumpPolicy), вполне вероятно, что у вас установлен последним накопительным обновлением.
Чтобы исправить это, [обновить сервер HGS](guarded-fabric-manage-hgs.md#patching-hgs) последнее накопительное обновление Windows и [активировать новые политики аттестации](guarded-fabric-manage-hgs.md#updates-requiring-policy-activation).
Убедитесь, что вы обновить узлы Hyper-V же накопительный пакет обновления перед активацией новые политики аттестации, как узлы, которые не имеют новые возможности шифрования дампа установлен может завершиться неудачей аттестации HGS политики при активации.

## <a name="endorsement-key-certificate-error-messages"></a>Сообщения об ошибках на использование сертификата ключа подтверждения

При регистрации узла с помощью [HgsAttestationTpmHost добавить](https://docs.microsoft.com/powershell/module/hgsattestation/add-hgsattestationtpmhost) командлета, два идентификатора доверенного платформенного МОДУЛЯ извлекаются из файла идентификатор предоставленного платформы: сертификата ключа подтверждения (EKcert) и открытом ключе подтверждения (EKpub).
EKcert изготовителя доверенного платформенного МОДУЛЯ, предоставляя гарантии, что доверенный платформенный модуль является подлинным и изготовителю по цепочке поставок normal.
EKpub уникально идентифицирует этот конкретный модуль и является одним из меры, которые использует HGS, чтобы предоставить доступ для запуска экранированных виртуальных машин на узел.

Вы получите ошибку при регистрации узла доверенного платформенного МОДУЛЯ, если одно из двух условий:
1. Идентификатор файла платформы **не** содержат сертификатом ключа подтверждения
2. Идентификатор файла платформы содержит сертификата ключа подтверждения, но этот сертификат **ненадежный** в системе

Некоторые производители доверенного платформенного МОДУЛЯ не включайте EKcerts в их доверенных платформенных модулей.
Если вы подозреваете, что это в случае с доверенного платформенного МОДУЛЯ, подтверждение с к изготовителю Оборудования, ваш доверенный платформенный модуль не должны иметь EKcert и использовать `-Force` флаг, чтобы вручную зарегистрировать узел с HGS.
Если доверенный платформенный модуль должен иметь EKcert, но он не был найден в файле идентификатор платформы, убедитесь, вы используете консоль PowerShell с привилегиями администратора (с повышенными правами), при выполнении [Get-PlatformIdentifier](https://docs.microsoft.com/powershell/module/platformidentifier/get-platformidentifier) на узле.

Если вы получили ошибку, что ваш EKcert не является доверенным, убедитесь, что у вас есть [установки пакета доверенных сертификатов корневых доверенного платформенного МОДУЛЯ](guarded-fabric-install-trusted-tpm-root-certificates.md) на каждый сервер HGS и корневой сертификат для доверенного платформенного МОДУЛЯ поставщика присутствует в локальном компьютере  **TrustedTPM\_RootCA** хранения. Все применимые промежуточные сертификаты также должны быть установлены в **TrustedTPM\_IntermediateCA** хранить на локальном компьютере.
После установки корневого и промежуточных сертификатов, можно будет выполнять `Add-HgsAttestationTpmHost` успешно.
