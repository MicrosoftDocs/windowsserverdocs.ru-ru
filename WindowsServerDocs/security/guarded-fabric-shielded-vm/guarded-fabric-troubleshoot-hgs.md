---
title: Устранение неполадок службы защиты узла
ms.topic: article
ms.assetid: 424b8090-0692-49a6-9dc4-3c0e77d74b80
manager: dongill
author: rpsqrd
description: Способы решения распространенных проблем, возникающих при развертывании или работе сервера службы защиты узлов (HGS) в защищенной структуре.
ms.author: ryanpu
ms.date: 10/12/2020
ms.openlocfilehash: 398029ed048ac835d23ffebb954baad13970b538
ms.sourcegitcommit: c56e74743e5ad24b28ae81668668113d598047c6
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/13/2020
ms.locfileid: "91987298"
---
# <a name="troubleshooting-the-host-guardian-service"></a>Устранение неполадок службы защиты узла

> Область применения: Windows Server 2019, Windows Server (половина ежегодного канала), Windows Server 2016

В этой статье описываются способы решения распространенных проблем, возникающих при развертывании или работе сервера службы защиты узлов (HGS) в защищенной структуре.
Если вы не уверены в характере проблемы, сначала попробуйте выполнить [защищенную диагностику структуры](guarded-fabric-troubleshoot-diagnostics.md) на серверах HGS и узлах Hyper-V, чтобы сократить возможные причины.

## <a name="certificates"></a>Сертификаты

Для работы HGS требуется несколько сертификатов, включая сертификат шифрования и подписи, настроенные администратором, а также сертификат аттестации, управляемый службой HGS.
Если эти сертификаты настроены неправильно, служба HGS не сможет обслуживать запросы от узлов Hyper-V, желающих подтвердить или разблокировать предохранители ключей для экранированных виртуальных машин.
В следующих разделах рассматриваются распространенные проблемы, связанные с сертификатами, настроенными в HGS.

### <a name="certificate-permissions"></a>Разрешения на сертификат

HGS должна иметь возможность доступа к открытым и закрытым ключам сертификатов шифрования и подписи, добавленных в HGS с помощью отпечатка сертификата.
В частности, групповая управляемая учетная запись службы (gMSA), которая запускает службу HGS, должна иметь доступ к ключам.
Чтобы найти gMSA, используемые службой HGS, выполните следующую команду в командной строке PowerShell с повышенными привилегиями на сервере HGS:

```powershell
(Get-IISAppPool -Name KeyProtection).ProcessModel.UserName
```

Способ предоставления учетной записи gMSA доступа к использованию закрытого ключа зависит от того, где хранится ключ: на компьютере в качестве локального файла сертификата, в аппаратном модуле безопасности (HSM) или с помощью пользовательского поставщика хранилища ключей сторонних поставщиков.

#### <a name="grant-access-to-software-backed-private-keys"></a>Предоставление доступа к закрытым ключам с поддержкой программного обеспечения

Если вы используете самозаверяющий сертификат или сертификат, выданный центром сертификации, который **не** хранится в аппаратном модуле безопасности или поставщике хранилища ключей, можно изменить разрешения закрытого ключа, выполнив следующие действия.

1. Открыть локальный диспетчер сертификатов (certlm. msc)
2. Разверните узел **личные > сертификаты** и найдите сертификат подписывания или шифрования, который требуется обновить.
3. Щелкните сертификат правой кнопкой мыши и выберите **все задачи > управления закрытыми ключами**.
4. Выберите **Добавить** , чтобы предоставить новому пользователю доступ к закрытому ключу сертификата.
5. В средстве выбора объектов введите имя учетной записи gMSA для службы HGS, которое было найдено ранее, а затем нажмите кнопку **ОК**.
6. Убедитесь, что у gMSA есть доступ на **Чтение** сертификата.
7. Нажмите кнопку **ОК** , чтобы закрыть окно разрешения.

Если вы используете HGS в Server Core или управляете сервером удаленно, вы не сможете управлять закрытыми ключами с помощью локального диспетчера сертификатов.
Вместо этого необходимо скачать [модуль защищенных средств структуры PowerShell](https://www.powershellgallery.com/packages/GuardedFabricTools) , который позволит управлять разрешениями в PowerShell.

1. Откройте консоль PowerShell с повышенными привилегиями на компьютере Server Core или используйте удаленное взаимодействие PowerShell с учетной записью с правами локального администратора в HGS.
2. Выполните следующие команды, чтобы установить модуль PowerShell для средств защищенной структуры и предоставить учетной записи gMSA доступ к закрытому ключу.

```powershell
$certificateThumbprint = '<ENTER CERTIFICATE THUMBPRINT HERE>'

# Install the Guarded Fabric Tools module, if necessary
Install-Module -Name GuardedFabricTools -Repository PSGallery

# Import the module into the current session
Import-Module -Name GuardedFabricTools

# Get the certificate object
$cert = Get-Item "Cert:\LocalMachine\My\$certificateThumbprint"

# Get the gMSA account name
$gMSA = (Get-IISAppPool -Name KeyProtection).ProcessModel.UserName

# Grant the gMSA read access to the certificate
$cert.Acl = $cert.Acl | Add-AccessRule $gMSA Read Allow
```

#### <a name="grant-access-to-hsm-or-custom-provider-backed-private-keys"></a>Предоставление доступа к HSM или пользовательским закрытым ключам, защищенным поставщиком

Если закрытые ключи сертификата поддерживаются аппаратным модулем безопасности (HSM) или пользовательским поставщиком хранилища ключей (KSP), модель разрешений будет зависеть от конкретного поставщика программного обеспечения.
Для получения наилучших результатов обратитесь к документации или сайту поддержки вашего поставщика, чтобы узнать, как обрабатываются разрешения закрытого ключа для конкретного устройства или программного обеспечения.
Во всех случаях для gMSA, используемых службой HGS, требуются разрешения на *Чтение* закрытых ключей шифрования, подписания и сертификатов связи, чтобы они могли выполнять операции подписывания и шифрования.

Некоторые аппаратные модули безопасности не поддерживают предоставление определенным учетным записям пользователей доступа к закрытому ключу. Вместо этого они разрешают учетной записи компьютера доступ ко всем ключам в определенном наборе ключей.
Для таких устройств обычно достаточно предоставить компьютеру доступ к ключам, и HGS сможет использовать это подключение.

**Советы по HSM**

Ниже приведены предлагаемые варианты конфигурации для успешного использования ключей с защитой HSM с помощью HGS на основе корпорации Майкрософт и ее партнеров.
Эти советы предназначены для вашего удобства и не обязательно должны быть правильными во время чтения, а также не поддерживаются производителями HSM.
При наличии дополнительных вопросов обратитесь к изготовителю HSM, чтобы получить точную информацию, относящуюся к конкретному устройству.

Фирменная символика или серия HSM      | Предложение
----------------------|-------------
Gemalto компании SafeNet       | Убедитесь, что для свойства использование ключа в файле запроса сертификата задано значение 0x82, что позволяет использовать сертификат для подписывания и шифрования. Кроме того, необходимо предоставить учетной записи gMSA доступ на *Чтение* закрытого ключа с помощью локального диспетчера сертификатов (см. шаги выше).
nCipher nShield        | Убедитесь, что каждый узел HGS имеет доступ к всему миру безопасности, содержащему ключи подписывания и шифрования. Кроме того, вам может потребоваться предоставить gMSA доступ на *Чтение* закрытому ключу с помощью локального диспетчера сертификатов (см. действия выше).
Утимако Криптосерверс | Убедитесь, что для свойства использование ключа в файле запроса сертификата задано значение 0x13, что позволяет использовать сертификат для шифрования, расшифровки и подписывания.

### <a name="certificate-requests"></a>Запросы сертификатов

Если вы используете центр сертификации для выдаче сертификатов в среде инфраструктуры открытых ключей (PKI), необходимо убедиться, что ваш запрос на сертификат включает минимальные требования к использованию этих ключей для HGS.

**Сертификаты подписи**

CSR, свойство | Обязательное значение
-------------|---------------
Алгоритм    | RSA
Размер ключа     | Не менее 2048 бит
Использование ключа    | Сигнатура, подпись или Дигиталсигнатуре

**Сертификаты шифрования**

CSR, свойство | Обязательное значение
-------------|---------------
Алгоритм    | RSA
Размер ключа     | Не менее 2048 бит
Использование ключа    | Шифрование/шифрование/ДатаенЦифермент

**Шаблоны служб сертификатов Active Directory**

Если для создания сертификатов используются шаблоны сертификатов служб Active Directory Certificate Services (ADCS), рекомендуется использовать шаблон со следующими параметрами:

Свойство шаблона ADCS | Обязательное значение
-----------------------|---------------
Категория поставщика      | Поставщик хранилища ключей
Имя алгоритма         | RSA
Минимальный размер ключа       | 2048
Назначение                | Подпись и шифрование
Расширение использования ключа    | Цифровая подпись, шифрование ключей, шифрование данных ("Разрешить шифрование пользовательских данных")


### <a name="time-drift"></a>Смещение времени

Если время сервера сильно изменилось от других узлов HGS или узлов Hyper-V в защищенной структуре, могут возникнуть проблемы с действительным сертификатом подписывания аттестации.
Сертификат подписывания аттестации создается и обновляется в фоновом режиме в HGS и используется для подписи сертификатов работоспособности, выданных защищенным узлам службой аттестации.

Чтобы обновить сертификат подписывания аттестации, выполните следующую команду в командной строке PowerShell с повышенными привилегиями.

```powershell
Start-ScheduledTask -TaskPath \Microsoft\Windows\HGSServer -TaskName
AttestationSignerCertRenewalTask
```

Кроме того, можно вручную запустить запланированную задачу, открыв **планировщик задач** (тасксчд. msc), перейдя в **планировщик задач библиотеку > Microsoft > Windows > HGSServer** и выполнив задачу с именем **аттестатионсигнерцертреневалтаск**.

## <a name="switching-attestation-modes"></a>Переключение режимов аттестации

При переключении HGS из режима TPM в режим Active Directory или наоборот с помощью командлета [Set-HgsServer](https://technet.microsoft.com/library/mt652180.aspx) может потребоваться до 10 минут для каждого узла в кластере HGS, чтобы приступить к принудительному применению нового режима аттестации.
Это нормальное поведение.
Рекомендуется не удалять политики, разрешающие узлы из предыдущего режима аттестации, пока не будет проверено, что все узлы успешно проходят проверку в новом режиме аттестации.

**Известная ошибка при переключении из доверенного платформенного модуля в режим AD**

Если вы инициализируют кластер HGS в режиме TPM, а затем переключились в режим Active Directory, существует известная ошибка, которая не позволяет другим узлам в кластере HGS переключаться на новый режим аттестации.
Чтобы убедиться, что все серверы HGS принудительно используют правильный режим аттестации, выполните `Set-HgsServer -TrustActiveDirectory` **на каждом узле** кластера HGS.
Эта проблема не возникает при переключении из режима TPM в режим AD *и* первоначальной настройки кластера в режиме ad.

Чтобы проверить режим аттестации сервера HGS, запустите [Get-HgsServer](https://technet.microsoft.com/library/mt652162.aspx).

## <a name="memory-dump-encryption-policies"></a>Политики шифрования дампа памяти

Если вы пытаетесь настроить политики шифрования дампа памяти и не видите политики дампа HGS по умолчанию (не \_ дампы HGS, HGS \_ Думпенкриптион и HGS \_ думпенкриптионкэй) или командлета политики дампа (Add-хгсаттестатиондумпполици), скорее всего, не установлено последнее накопительное обновление.
Чтобы устранить эту проблему, [Обновите сервер HGS](guarded-fabric-manage-hgs.md#patching-hgs) до последнего накопительного центра обновления Windows и [активируйте новые политики аттестации](guarded-fabric-manage-hgs.md#updates-requiring-policy-activation).
Перед активацией новых политик аттестации необходимо обновить узлы Hyper-V до одного накопительного обновления, так как на узлах, на которых не установлены новые возможности шифрования дампа, скорее всего, произойдет сбой аттестации после активации политики HGS.

## <a name="endorsement-key-certificate-error-messages"></a>Сообщения об ошибках сертификата ключа подтверждения

При регистрации узла с помощью командлета [Add-хгсаттестатионтпмхост](/powershell/module/hgsattestation/add-hgsattestationtpmhost) из предоставленного файла идентификатора платформы извлекаются два идентификатора доверенного платформенного модуля: сертификат ключа подтверждения (екцерт) и открытый ключ подтверждения (екпуб).
Екцерт определяет изготовителя доверенного платформенного модуля, предоставляя гарантии того, что доверенный платформенный модуль подлинно и проготавливается через цепочку поставок.
Екпуб уникально идентифицирует конкретный доверенный платформенный модуль и является одной из мер, которые использует HGS для предоставления доступа к узлу для запуска экранированных виртуальных машин.

При регистрации узла TPM появится сообщение об ошибке, если выполняется одно из двух условий.
1. Файл идентификатора платформы **не** содержит сертификат ключа подтверждения
2. Файл идентификатора платформы содержит сертификат ключа подтверждения, но этот сертификат **не является доверенным** для вашей системы

Некоторые производители TPM не включают Екцертс в своих доверенных платформенных модулях.
Если вы подозреваете, что это относится к доверенному платформенному модулю, уточните у поставщика вычислительной техники, что у доверенных платформенных модулей нет Екцерт, и используйте `-Force` флаг, чтобы вручную зарегистрировать узел в HGS.
Если у доверенного платформенного модуля должен быть Екцерт, но он не найден в файле идентификатора платформы, убедитесь, что вы используете консоль PowerShell с повышенными правами администратора при запуске [Get-платформидентифиер](/powershell/module/platformidentifier/get-platformidentifier) на узле.

Если вы получили сообщение о том, что Екцерт не является доверенным, убедитесь, что вы [установили пакет доверенных корневых сертификатов доверенного платформенного модуля](guarded-fabric-install-trusted-tpm-root-certificates.md) на каждом сервере HGS и что корневой сертификат для поставщика доверенного платформенного модуля есть в **трустедтпм \_ RootCA** локального компьютера. Все применимые промежуточные сертификаты также необходимо установить в хранилище ** \_ интермедиатека трустедтпм** на локальном компьютере.
После установки корневого и промежуточного сертификатов вы сможете успешно запуститься `Add-HgsAttestationTpmHost` .

## <a name="group-managed-service-account-gmsa-privileges"></a>Права доступа групповой управляемой учетной записи службы (gMSA)

Учетной записи службы HGS (gMSA, используемой для пула приложений службы защиты ключей в IIS) необходимо предоставить права на [Создание аудитов безопасности](/windows/security/threat-protection/security-policy-settings/generate-security-audits) , также известные как `SeAuditPrivilege` . Если эта привилегия отсутствует, начальная конфигурация HGS завершается успешно и IIS запускается, но служба защиты ключей не работает и возвращает ошибку HTTP 500 _("ошибка сервера в приложении/кэйпротектион")._ Кроме того, в журнале событий приложений можно просмотреть следующие сообщения об предупреждениях.
```
System.ComponentModel.Win32Exception (0x80004005): A required privilege is not held by the client
at Microsoft.Windows.KpsServer.Common.Diagnostics.Auditing.NativeUtility.RegisterAuditSource(String pszSourceName, SafeAuditProviderHandle& phAuditProvider)
at Microsoft.Windows.KpsServer.Common.Diagnostics.Auditing.SecurityLog.RegisterAuditSource(String sourceName)
```
or
```
Failed to register the security event source.
   at System.Web.HttpApplicationFactory.EnsureAppStartCalledForIntegratedMode(HttpContext context, HttpApplication app)
   at System.Web.HttpApplication.RegisterEventSubscriptionsWithIIS(IntPtr appContext, HttpContext context, MethodInfo[] handlers)
   at System.Web.HttpApplication.InitSpecial(HttpApplicationState state, MethodInfo[] handlers, IntPtr appContext, HttpContext context)
   at System.Web.HttpApplicationFactory.GetSpecialApplicationInstance(IntPtr appContext, HttpContext context)
   at System.Web.Hosting.PipelineRuntime.InitializeApplication(IntPtr appContext)

Failed to register the security event source.
   at Microsoft.Windows.KpsServer.Common.Diagnostics.Auditing.SecurityLog.RegisterAuditSource(String sourceName)
   at Microsoft.Windows.KpsServer.Common.Diagnostics.Auditing.SecurityLog.ReportAudit(EventLogEntryType eventType, UInt32 eventId, Object[] os)
   at Microsoft.Windows.KpsServer.KpsServerHttpApplication.Application_Start()

A required privilege is not held by the client
   at Microsoft.Windows.KpsServer.Common.Diagnostics.Auditing.NativeUtility.RegisterAuditSource(String pszSourceName, SafeAuditProviderHandle& phAuditProvider)
   at Microsoft.Windows.KpsServer.Common.Diagnostics.Auditing.SecurityLog.RegisterAuditSource(String sourceName)
```
Кроме того, можно заметить, что ни один из командлетов службы защиты ключей (например, [Get-хгскэйпротектионцертификате](/powershell/module/hgskeyprotection/get-hgskeyprotectioncertificate)) не работает, а вместо них возвращает ошибки.

Чтобы устранить эту проблему, необходимо предоставить gMSA "Создание аудитов безопасности" (SeAuditPrivilege). Для этого вы можете использовать либо локальную политику безопасности `SecPol.msc` на каждом узле кластера HGS, либо групповая политика. Кроме того, можно использовать средство [SecEdit.exe](/windows-server/administration/windows-commands/secedit) для экспорта текущей политики безопасности, внести необходимые изменения в файл конфигурации (который является обычным текстом), а затем импортировать его обратно.

> [!NOTE]
> При настройке этого параметра список принципов безопасности, определенных для привилегии, полностью переопределяет значения по умолчанию (они не объединяются). Таким образом, при определении этого параметра политики не забудьте включить в дополнение к добавляемому gMSA владельцев по умолчанию для этой привилегии (сетевая служба и локальная служба).
