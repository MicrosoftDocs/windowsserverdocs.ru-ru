---
title: Устранение неполадок с помощью средства диагностики защищенной структуры
ms.custom: na
ms.prod: windows-server-threshold
ms.topic: article
ms.assetid: 07691d5b-046c-45ea-8570-a0a85c3f2d22
manager: dongill
author: huu
ms.technology: security-guarded-fabric
ms.openlocfilehash: c102fa0503e6aac279235e1243b55e0e3cf81e1d
ms.sourcegitcommit: 0d0b32c8986ba7db9536e0b8648d4ddf9b03e452
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2019
ms.locfileid: "59812415"
---
# <a name="troubleshooting-using-the-guarded-fabric-diagnostic-tool"></a>Устранение неполадок с помощью средства диагностики защищенной структуры

>Относится к: Windows Server 2019 г., Windows Server (полугодовой канал), Windows Server 2016

В этом разделе описывается использование защищенных Fabric средство диагностики для выявления и устранения распространенных ошибок при развертывании, конфигурации и выполняющуюся операцию инфраструктуры защищенной структуры. Сюда входят службы Защитника узлов (HGS), все защищенные узлы и вспомогательные службы, такие как DNS и Active Directory. Средство диагностики можно использовать для выполнения первого на рассмотрение fabric отказа защищенных, предоставляя администраторам отправную точку для устранения сбоев и идентификация неправильно настроенные активов. Это средство не является заменой для звукового приступим операционных защищенной структуры и обслуживает только для быстрой проверки наиболее распространенные неполадки, возникающие во время ежедневных операций.

Документация по командлетах, используемых в этом разделе можно найти на [TechNet](https://technet.microsoft.com/library/mt718834.aspx).

[!INCLUDE [Guarded fabric diagnostics tool](../../../includes/guarded-fabric-diagnostics-tool.md)] 

# <a name="quick-start"></a>Быстрый запуск

Путем вызова следующих из сеанса Windows PowerShell с правами локального администратора, можно диагностировать защищенный узел или узел HGS:
```PowerShell
Get-HgsTrace -RunDiagnostics -Detailed
```
Это автоматически обнаруживает роли текущего узла и диагностике любых соответствующих проблем, которые могут быть обнаружены автоматически.  Отображаются все результаты, сформированные во время этого процесса из-за наличия `-Detailed` переключения.

В оставшейся части этого раздела приводится подробное Пошаговое руководство расширенное использование `Get-HgsTrace` для выполнения задач, например диагностики несколько узлов за один раз и обнаружения сложных неправильной конфигурации между узлами.

## <a name="diagnostics-overview"></a>Общие сведения о диагностике
Защищенная структура диагностики доступны на любом узле с экранированной виртуальной машины связанные средства и компоненты, устанавливаемые, включая узлы под управлением основных серверных компонентов.  В настоящее время диагностики включены следующие компоненты и пакеты.

1. Роль службы защиты узла
2. Поддержка защиты узла Hyper-V
3. Средства экранирования виртуальных машин для управления структурой
4. Средства удаленного администрирования сервера (RSAT)

Это означает, что средства диагностики, будут доступны на всех защищенных узлов, узлов HGS, определенные серверы управления структуры и любые рабочие станции Windows 10 с [RSAT](https://www.microsoft.com/download/details.aspx?id=45520) установлен.  Диагностика может вызываться из любого выше машин с целью диагностики любой защищенный узел или узел HGS в защищенной структуре; с помощью целевых объектов удаленной трассировки, диагностики можно найти и подключиться к узлы, отличные от компьютер под управлением системы диагностики.

Каждого узла, которому назначено системой диагностики называется «target трассировки».  Целевые объекты трассировки идентифицируются по их имена узлов и ролей.  Роли описывают функцию, которую выполняет целевой объект трассировок в защищенной структуре.  В настоящее время трассировки предназначен для поддержки `HostGuardianService` и `GuardedHost` ролей.  Обратите внимание, что это возможно, хост может занимать несколько ролей одновременно, и также поддерживается средствами диагностики, однако это не должна осуществляться в рабочих средах.  Узлы HGS и Hyper-V должен храниться отдельно и distinct в любое время.

Администраторы могут начать все задачи диагностики, выполнив `Get-HgsTrace`.  Эта команда выполняет две роли согласно параметрам, предоставленные во время выполнения: трассировки коллекции и диагностики.  Эти два вместе составляют весь защищенных Fabric средства диагностики.  Если явно не требуется, наиболее полезных диагностики требуют трассировки, которые можно собирать только с учетными данными администратора для целевого объекта трассировки.  Если недостаточно привилегий удерживаемые пользователь, выполняющий сбор данных трассировки, трассировок, требующие повышения прав завершится ошибкой, пока все остальные передаст.  Это позволяет частичного диагностики, в случае выполняет оператор заниженных привилегий "Рассмотрение". 

### <a name="trace-collection"></a>Сбор данных трассировки
По умолчанию `Get-HgsTrace` будет только собирать трассировки и сохранить их во временную папку.  Трассировки имеют вид папки, названные по на конечном узле, заполненный специальный формат файлов, которые описывают, как настроить узел.  Данные трассировки также содержат метаданные, описывающие, как был вызван диагностики для сбора данных трассировки.  Эти данные используется средствами диагностики для повторно заполнить сведения об узле, при выполнении ручного диагностики.

При необходимости можно вручную просмотреть трассировки.  Все форматы являются либо понятное (XML) или может быть легко проверить, используя стандартные средства (например X509 сертификаты и расширения оболочки Windows Crypto).  Тем не менее Обратите внимание, что трассировки не предназначены для диагностики вручную, и всегда эффективно обрабатывать данные трассировки с помощью средств диагностики из `Get-HgsTrace`.

Результаты запуска коллекции трассировки не вносите о том, что для работоспособности данного узла.  Они просто указывают, что трассировки были успешно собраны.  Необходимо использовать средства диагностики класса `Get-HgsTrace` для определения того, если трассировки указывают среде сбоя.

С помощью `-Diagnostic` параметр, можно ограничить сбор данных трассировки только трассировки, необходимые для работы указанного диагностики.  Это уменьшает объем данных, собранных также разрешения, необходимые для вызова диагностики.

### <a name="diagnosis"></a>Диагностика
Собранные данные трассировки можно диагностировать, предоставляемых `Get-HgsTrace` расположение данных трассировки с помощью `-Path` параметра и указание `-RunDiagnostics` переключения.  Кроме того `Get-HgsTrace` за один проход выполнять сбор и диагностики, предоставляя `-RunDiagnostics` коммутатора и список целевых объектов трассировки.  Если целевые объекты не трассировки, текущего компьютера используется как неявный целевого объекта, с его ролью выведен, изучив установленных модулей Windows PowerShell.

Диагностика предоставит результаты в иерархическом формате отображения, какие целевые объекты трассировки, диагностики наборов и отдельных диагностики отвечают за определенного сбоя.  Сбои включать исправления и рекомендаций по устранению неполадки, если определение может быть выполнено в том, какие действия нужно предпринять далее.  По умолчанию передав и несущественных результатов скрыты.  Чтобы просмотреть все, что протестированы с помощью системы диагностики, укажите `-Detailed` переключения.  В результате все результаты отображаются независимо от их состояния.

Можно ограничить набор средства диагностики, которые выполняются с помощью `-Diagnostic` параметра.  Это позволяет указать, какие классы диагностики должны выполняться с учетом целей, трассировки и все остальные подавления.  Доступные классы диагностики примеры сети, рекомендаций и клиентского оборудования.  Обратитесь к [документация по командлетам](https://technet.microsoft.com/library/mt718831.aspx) найти актуальный список доступных средств диагностики.

> [!WARNING]
> Диагностика не являются заменой для strong мониторинга и реагирования на инциденты конвейера.  Доступен пакет System Center Operations Manager для мониторинга защищенной структуре, а также различные каналы журнала событий, которые можно отслеживать, чтобы выявлять проблемы на раннем этапе.  Диагностику можно быстро рассматривать эти сбои и установить порядок действий.

## <a name="targeting-diagnostics"></a>Предназначенные для диагностики

`Get-HgsTrace` работает с целевые объекты трассировки.  Целевой объект трассировки — это объект, соответствующий узел HGS или защищенный узел внутри защищенной структуры.  Он может рассматриваться как расширение `PSSession` который включает информацию, требуются только для диагностики, такие как роль узла в структуре.  Целевые объекты могут быть неявно создан (например диагностики локальный или вручную) или явно с помощью `New-HgsTraceTarget` команды.

### <a name="local-diagnosis"></a>Локальной диагностики

По умолчанию `Get-HgsTrace` ориентированы и на localhost, (т. е. когда командлет вызван метод).  Это упоминается как неявные локальный адрес.  Неявные локальные целевые используется только в том случае, если целевые объекты не указаны в `-Target` параметр и не предварительно существующих трассировок можно найти на `-Path`.

Неявные локальные целевые использует определение роли, чтобы определить, какую роль играет текущего узла в защищенной структуры.  Это зависит от установленных модулей Windows PowerShell, которые примерно соответствуют какие функции были установлены в системе.  Наличие `HgsServer` модуля приведет к целевой объект трассировки, чтобы отключить роль `HostGuardianService` и наличие `HgsClient` модуля приведет к целевой объект трассировки, чтобы отключить роль `GuardedHost`.  Возможно, для данного узла иметь оба модуля, в противном случае он будет рассматриваться как `HostGuardianService` и `GuardedHost`.

Таким образом по умолчанию вызов диагностики для сбора трассировок локально:
```PowerShell
Get-HgsTrace
```
... эквивалентно следующему:
```PowerShell
New-HgsTraceTarget -Local | Get-HgsTrace
```
> [!TIP]
> `Get-HgsTrace` может принимать целевые объекты по конвейеру или непосредственно через `-Target` параметра.  Нет никаких различий между ними с точки зрения операций.

### <a name="remote-diagnosis-using-trace-targets"></a>Целевые объекты трассировки с помощью удаленной диагностики

Существует возможность удаленно диагностировать узла путем создания целевых объектов трассировки с данными удаленного подключения.  Все, что требуется — имя узла и набор учетных данных можно подключаться с помощью удаленного взаимодействия Windows PowerShell.
```PowerShell
$server = New-HgsTraceTarget -HostName "hgs-01.secure.contoso.com" -Role HostGuardianService -Credential (Enter-Credential)
Get-HgsTrace -RunDiagnostics -Target $server
```
В этом примере создается запрос на получение учетных данных удаленного пользователя, а затем диагностики будет выполняться с помощью удаленного узла в `hgs-01.secure.contoso.com` для завершения сбора трассировки.  Получаемые трассировки загружаются для localhost и затем обнаружить.  Результаты диагностики представляются так же, как при выполнении [локальной диагностики](#local-diagnosis).  Аналогичным образом необязательно для указания роли, как его можно неявно определяется модули Windows PowerShell, установленные в удаленной системе.

Диагностика удаленных использует удаленное взаимодействие Windows PowerShell для любой доступ к удаленному узлу.  Таким образом является требованием, что целевой объект трассировки имеют включено удаленное взаимодействие Windows PowerShell (см. в разделе [включить PSRemoting](https://technet.microsoft.com/library/hh849694.aspx)) и что localhost установлено правильно настроен для запуска подключения к целевому объекту.

> [!NOTE]
> В большинстве случаев она необходима только что localhost входить в одном лесу Active Directory, и что используется допустимое имя узла DNS.  Если вы хотите использовать прямые IP-адреса для подключения к вашей среде используются более сложные модели федерации, может потребоваться выполнить дополнительную настройку, такую как задание WinRM [доверенные узлы](https://technet.microsoft.com/library/ff700227.aspx).

Чтобы узнать, что целевой объект трассировки определяется должным образом и настраивается для приема подключений с помощью `Test-HgsTraceTarget` командлета:
```PowerShell
$server = New-HgsTraceTarget -HostName "hgs-01.secure.contoso.com" -Role HostGuardianService -Credential (Enter-Credential)
$server | Test-HgsTraceTarget
```
Эта команда возвращает `$True` , только если `Get-HgsTrace` сможет установить удаленный сеанс диагностики с целевым объектом трассировки.  В случае сбоя этот командлет возвращает сведения о состояния для дальнейшего устранения неполадок подключения удаленного взаимодействия Windows PowerShell.

#### <a name="implicit-credentials"></a>Явных учетных данных

При выполнении удаленной диагностики от пользователя с достаточными правами для удаленного подключения к целевому объекту трассировки, нет необходимости предоставлять учетные данные для `New-HgsTraceTarget`.  `Get-HgsTrace` Командлет будет автоматически повторно использовать учетные данные пользователя, который вызывается командлет при открытии соединения.

> [!WARNING]
> Некоторые ограничения применяются к повторному использованию учетных данных, особенно в том случае, при выполнении, так называемой «второй переход».  Это происходит, когда попытка повторного использования учетных данных из удаленного сеанса на другой компьютер.  Это необходимо для [настроить CredSSP](https://technet.microsoft.com/library/hh849872.aspx) для поддержки этого сценария, но это выходит за рамки защищенной структуры управления и устранения неполадок.

#### <a name="using-windows-powershell-just-enough-administration-jea-and-diagnostics"></a>С помощью Windows PowerShell Just Enough Administration (JEA) и диагностика

Диагностика удаленных поддерживает использование конечных точек JEA с ограниченными возможностями Windows PowerShell. По умолчанию трассировки на удаленных целевых объектов будут подключаться с использованием по умолчанию `microsoft.powershell` конечной точки.  Если у целевого объекта трассировки `HostGuardianService` роли, он также будет использоваться `microsoft.windows.hgs` конечной точки, который настраивается при установке HGS.

Если вы хотите использовать настраиваемую конечную точку, необходимо указать имя конфигурации сеанса при построении целевого трассировки с использованием `-PSSessionConfigurationName` параметров, таких как ниже:

```PowerShell
New-HgsTraceTarget -HostName "hgs-01.secure.contoso.com" -Role HostGuardianService -Credential (Enter-Credential) -PSSessionConfigurationName "microsoft.windows.hgs"
```

#### <a name="diagnosing-multiple-hosts"></a>Диагностика нескольких узлов

Вы можете передать несколько целевых объектов трассировки для `Get-HgsTrace` за один раз.  Это включает в себя сочетание локальных и удаленных целевых объектов.  Каждый целевой объект будет отслеживаться в свою очередь, а затем трассировки из каждого целевого объекта выявляются одновременно.  Средство диагностики можно использовать увеличенный объем сведений развертывания для определения сложных неверные настройки между узлами, которые иначе не были бы выявляемых.  Только с помощью этой функции необходимо указать трассировки с нескольких узлов одновременно (в случае диагностики вручную) или с помощью нацеливания несколько узлов, при вызове `Get-HgsTrace` (в случае удаленной диагностики).

Ниже приведен пример использования удаленную диагностику "Рассмотрение" Структура состоит из двух узлов с HGS и два защищенных узлов, где один из защищенных узлов используются для запуска `Get-HgsTrace`.

```PowerShell
$hgs01 = New-HgsTraceTarget -HostName "hgs-01.secure.contoso.com" -Credential (Enter-Credential)
$hgs02 = New-HgsTraceTarget -HostName "hgs-02.secure.contoso.com" -Credential (Enter-Credential)
$gh01 = New-HgsTraceTarget -Local
$gh02 = New-HgsTraceTarget -HostName "guardedhost-02.contoso.com"
Get-HgsTrace -Target $hgs01,$hgs02,$gh01,$gh02 -RunDiagnostics
```

> [!NOTE]
> Необходимо диагностировать вашей всей защищенной структуры при диагностике нескольких узлов.  Во многих случаях достаточно включить все узлы, которые могут быть задействованы в заданное условие сбоя.  Обычно это подмножество защищенных узлов и некоторое количество узлов из кластера HGS.

## <a name="manual-diagnosis-using-saved-traces"></a>Ручная диагностика с помощью сохраненных трассировок

Иногда может потребоваться повторно выполнить диагностику без сбора трассировок снова, или у вас нет необходимых учетных данных удаленно диагностировать всех узлов в структуре одновременно.  Ручная диагностика — это механизм, по которому можно выполнить в целом fabric "Рассмотрение" с помощью `Get-HgsTrace`, но без использования коллекции удаленных трассировки.

Прежде чем выполнять вручную диагностики, необходимо убедиться, что администраторы каждого узла в структуре, которая будет рассмотрена орудие, готовое выполнять команды от вашего имени.  Выходные данные трассировки диагностики не содержит все сведения, которые обычно можно просматривать как конфиденциальные, тем не менее это ответственность на пользователя, чтобы определить, безопасно предоставлять эту информацию другим пользователям.

> [!NOTE]
> Трассировки не являются анонимными и отобразить конфигурацию сети, параметры PKI и другую конфигурацию, иногда считается конфиденциальной информации.  Таким образом, трассировки должны быть только передаваемые доверенных субъектов в рамках организации и никогда не опубликован для публичного просмотра.

Ниже приведены действия для выполнения ручной диагностики:

1. Запрос, запустить администратор каждого узла `Get-HgsTrace` указание известная `-Path` и список планируется выполнять к получаемые трассировки диагностики.  Пример:

 ```PowerShell
 Get-HgsTrace -Path C:\Traces -Diagnostic Networking,BestPractices
 ```
2. Запрос, что администратор каждого узла в результате получается папка трассировки и отправить его вам.  Этот процесс может быть получена по электронной почте, через общие папки или любой другой механизм, на основе эксплуатационных процедурах, установленных в организации и политик.

3. Объедините все полученные трассировки в одну папку, без содержимого или папки.

    * Например предположим вы ваши Администраторы send вы трассировки, собранные из четыре машины с именем HGS-01, HGS 02, RR1N2608-12 и RR1N2608 13.  Администратор каждого бы отправили Вам папку с тем же именем.  Будет собирать структуру каталогов, который выглядит следующим образом:

      ```
      FabricTraces
      |- HGS-01
      |  |- TargetMetadata.xml
      |  |- Metadata.xml
      |  |- [any other trace files for this host]
      |- HGS-02
      |  |- [...]
      |- RR1N2608-12
      |  |- [...]
      |- RR1N2608-13
         |- [..]
      ```

4. Выполнение диагностики, указав путь к папке собранный трассировки на `-Path` параметра и указание `-RunDiagnostics` коммутатора, а также их диагностики, для которых задаваемые администраторов для сбора данных трассировки.  Диагностика предположит, его невозможно получить доступ к узлам найдена в пути и поэтому будет пытаться использовать только предварительно собранных трассировки.  Если отсутствует или поврежден, все трассировки диагностики только затронутые тесты со сбоем и продолжают выполнение.  Пример:

 ```PowerShell
 Get-HgsTrace -RunDiagnostics -Diagnostic Networking,BestPractices -Path ".\FabricTraces"
 ```

### <a name="mixing-saved-traces-with-additional-targets"></a>Смешивание сохранены трассировок с помощью дополнительных целевых платформ

В некоторых случаях имеется ряд предварительно собранных трассировок, которые вы хотите дополнить трассировок дополнительных узлов.  Существует возможность смешивать предварительно собранные данные трассировки с помощью дополнительных целевых платформ, которые будут трассируется и диагностируются за один вызов диагностики.

Следуя инструкциям для сбора и собирать трассировки папке, указанной выше, вызовите `Get-HgsTrace` с целевыми объектами дополнительные трассировки, не найден в папке предварительно собранной трассировки:

```PowerShell
$hgs03 = New-HgsTraceTarget -HostName "hgs-03.secure.contoso.com" -Credential (Enter-Credential)
Get-HgsTrace -RunDiagnostics -Target $hgs03 -Path .\FabricTraces
``` 

Командлет диагностики определит все предварительно собранных узлы, а также один дополнительный узел, который по-прежнему необходимо отследить и выполнит необходимые трассировки.  Сумма всех предварительно собранных и заново собранные трассировки затем выявляются.  В результате получается папка трассировки будут содержать старой и новой трассировки.
