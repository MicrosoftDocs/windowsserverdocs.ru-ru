---
title: Экранированные виртуальные машины для клиентов - создания данных экранирования для определения экранированной виртуальной Машины
ms.custom: na
ms.prod: windows-server-threshold
ms.topic: article
ms.assetid: 49f4e84d-c1f7-45e5-9143-e7ebbb2ef052
manager: dongill
author: rpsqrd
ms.technology: security-guarded-fabric
ms.date: 01/30/2019
ms.openlocfilehash: 25ed17d964f12c2f497ccde443dad9f8bc253b20
ms.sourcegitcommit: 21165734a0f37c4cd702c275e85c9e7c42d6b3cb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/03/2019
ms.locfileid: "65034672"
---
# <a name="shielded-vms-for-tenants---creating-shielding-data-to-define-a-shielded-vm"></a>Экранированные виртуальные машины для клиентов - создания данных экранирования для определения экранированной виртуальной Машины

>Относится к: Windows Server 2019 г., Windows Server (полугодовой канал), Windows Server 2016

Файл данных экранирования (также называемый файлом данных подготовки, или PDK-файлом) — это зашифрованный файл, который создает клиент или владелец виртуальной машины, чтобы защитить важную информацию о конфигурации виртуальной машины (пароль администратора, протокол удаленного рабочего стола и другие сертификаты с информацией об удостоверениях, учетные данные для присоединения домена и т. д.). Этот раздел содержит сведения о том, как создать файл данных экранирования. Перед созданием файла, необходимо либо получить от поставщика услуг размещения диск шаблона или Создание диска шаблона, как описано в разделе [экранированных виртуальных машин для клиентов - Создание диска шаблона (необязательно)](guarded-fabric-tenant-creates-template-disk.md).

Список и схема содержимого файл данных экранирования, см. в разделе [что данных экранирования и зачем это необходимые?](guarded-fabric-and-shielded-vms.md#what-is-shielding-data-and-why-is-it-necessary).

> [!IMPORTANT]
> На компьютере клиента под управлением Windows Server 2016 следует выполнить действия, описанные в этом разделе. Этой машины не должен быть частью защищенной структуры (то есть не следует настраивать для использования кластера с HGS).

Подготовка к созданию файл данных экранирования, выполните следующие действия:

- [Получение сертификата для удаленного рабочего стола](#obtain-a-certificate-for-remote-desktop-connection)
- [Создайте файл ответов](#create-an-answer-file)
- [Получить файл каталога подписи тома](#get-the-volume-signature-catalog-file)
- [Выберите доверенный структур](#select-trusted-fabrics)

Затем вы можете создать файл данных экранирования:

- [Создать файл данных экранирования и добавить guardians](#create-a-shielding-data-file-and-add-guardians-using-the-shielding-data-file-wizard)


## <a name="obtain-a-certificate-for-remote-desktop-connection"></a>Получение сертификата для удаленного рабочего стола

Так как клиенты только возможность подключения к их экранированные виртуальные машины с помощью удаленного рабочего стола или других средств удаленного управления, очень важно убедиться, что клиенты можно проверить, они подключаются к нужной конечной точке (то есть не «злоумышленник в середине» перехват подключения).

Чтобы убедиться, что вы подключаетесь к нужному серверу рекомендуется установить и настроить сертификат для служб удаленных рабочих столов для представления при инициировании подключения. Клиентского компьютера, подключающегося к серверу проверит ли она доверяет сертификат и Показывать предупреждение, если это не так. Как правило чтобы убедиться, что подключающийся клиент доверяет сертификату, RDP выдают сертификаты PKI клиента. Дополнительные сведения о [с использованием сертификатов служб удаленных рабочих столов](https://technet.microsoft.com/library/dn781533.aspx) можно найти на сайте TechNet.

<!-- The previous link comes from Windows 2012 R2 content, but as of Sept 2016, there isn't a more recent link that covers the same information. -->

> [!NOTE]
> При выборе сертификат протокола удаленного рабочего СТОЛА, чтобы включить в файл данных экранирования, не забудьте использовать групповой сертификат. Один файл данных экранирования может использоваться для создания неограниченное количество виртуальных машин. Так как каждая виртуальная машина будет совместно использовать тот же сертификат, групповой сертификат гарантирует, что сертификат будет действителен, независимо от того, имя узла виртуальной Машины.

Если при оценке экранированные виртуальные машины и не все будет готово запросить сертификат от центра сертификации, можно создать самозаверяющий сертификат на компьютере клиента, выполнив следующую команду Windows PowerShell (где *contoso.com*  является доменом клиента):

``` powershell
$rdpCertificate = New-SelfSignedCertificate -DnsName '\*.contoso.com'
$password = ConvertTo-SecureString -AsPlainText 'Password1' -Force
Export-PfxCertificate -Cert $RdpCertificate -FilePath .\rdpCert.pfx -Password $password
```

## <a name="create-an-answer-file"></a>Создание файла ответов

Так как подписанный диск шаблона в VMM обобщена, клиентов необходимо указать файл ответов для определения их экранированные виртуальные машины во время процесса подготовки. Файл ответов (часто называемые файл автоматической установки) можно настроить виртуальную Машину для его предполагаемой роли: то есть она можно Установка компонентов Windows, зарегистрировать сертификат протокола удаленного рабочего СТОЛА, созданный на предыдущем шаге и выполнение других пользовательских действий. Она также предоставляет необходимые сведения для установки Windows, включая администратора по умолчанию пароль и ключ продукта.

Сведения о получении и использовании **New-ShieldingDataAnswerFile** функция создает файл ответов (Unattend.xml) для создания экранированных виртуальных машин, см. в разделе [Создание файла ответов с помощью Функция новый-ShieldingDataAnswerFile](guarded-fabric-sample-unattend-xml-file.md). При помощи функции вы можете легко создать файл ответов, который отражает выборов в том числе следующие:

- Должен быть присоединен в конце процесса инициализации виртуальной Машины?
- Используется корпоративного лицензирования или определенный ключ продукта на виртуальную Машину?
- Вы используете DHCP или статический IP-адрес?
- Вы будете использовать сертификат протокола удаленного рабочего стола (RDP), который будет использоваться для подтверждения того, что виртуальная машина принадлежит вашей организации?
- Вы хотите запустить сценарий по завершении инициализации?
- Вы используете сервер Desired State Configuration (DSC) для дальнейшей настройки?

Файлы ответов, используемые в файлы данных экранирования будет использоваться на каждой виртуальной Машине, созданной с помощью этого файла данных экранирования. Таким образом следует убедиться, что вы не следует жестко кодировать все сведения, относящиеся к виртуальной Машине в файл ответов. VMM поддерживает некоторые строки подстановки (см. в следующей таблице) в файле автоматической установки для обработки значений специализации, которые могут изменяться из виртуальной Машины к виртуальной Машине. Вам не обязательно использовать их; Тем не менее если они присутствуют VMM будет использовать их.

При создании файла unattend.xml для экранированных виртуальных машин, имейте в виду следующие ограничения:

-   Файл автоматической установки необходимо привести к его отключения после его настройки виртуальной Машины. Это позволяет обеспечить VMM, чтобы знать, когда метод должен сообщить клиенту, что завершения подготовки виртуальной Машины и будет готов к использованию. VMM будет автоматически включите виртуальную Машину обратно после он обнаружит, что он был отключен во время подготовки.

-   Настоятельно рекомендуется настроить, чтобы убедиться, что вы подключаетесь к виртуальной Машине вправо, а не другой компьютер, настроенный для атаки man-in--middle сертификат протокола удаленного рабочего СТОЛА.

-   Убедитесь в том, что для включения удаленного рабочего СТОЛА и соответствующие правила брандмауэра, чтобы доступ к виртуальной Машине после ее настройки. Нельзя использовать консоль VMM для доступа экранированных виртуальных машин, поэтому вам протокола удаленного рабочего СТОЛА для подключения к виртуальной Машине. Если вы предпочитаете управлять системами с помощью удаленного взаимодействия Windows PowerShell, убедитесь, что включен WinRM, слишком.

-   Ниже перечислены строки только подстановки, поддерживаемые в экранированные файлы автоматической установки виртуальной Машины.

| Можно заменить элемент | Строка подстановки |
|-----------|-----------|
| имя_компьютера        | @ComputerName@      |
| Часовой пояс            | @TimeZone@          |
| ProductKey          | @ProductKey@        |
| IPAddr4-1           | @IP4Addr-1@         |
| IPAddr6-1           | @IP6Addr-1@         |
| MACAddr-1           | @MACAddr-1@         |
| Префикс-1-1          | @Prefix-1-1@        |
| NextHop-1-1         | @NextHop-1-1@       |
| Префикс-1-2          | @Prefix-1-2@        |
| NextHop-1-2         | @NextHop-1-2@       |

При использовании строк замены, важно убедиться, что строки будут заполнены во время процесса подготовки виртуальной Машины. Если строки, такой как @ProductKey@ не указывается во время развертывания, оставляя &lt;ProductKey&gt; узел в пустой файл автоматической установки, произойдет сбой процесса специализации, и вы не сможете подключиться к виртуальной Машине.

Кроме того Обратите внимание на то, что строки подстановки сетевых ближе к концу таблицы используются только если вы используете VMM пулы статических IP-адресов. Ваш поставщик услуг должен быть может сообщить, если эти строки подстановки являются обязательными. Дополнительные сведения о статических IP-адресов в VMM шаблонах см. в разделе ниже, в документации VMM:

- [Рекомендации для пулов IP-адресов](https://technet.microsoft.com/system-center-docs/vmm/plan/plan-network#guidelines-for-ip-address-pools) 
- [Настройка пулов статических IP-адресов в структуре VMM](https://technet.microsoft.com/system-center-docs/vmm/manage/manage-network-static-address-pools)

Наконец важно отметить, что процесс развертывания экранированной виртуальной Машины будет шифровать только на диске операционной системы. Если вы развертываете экранированной виртуальной Машины с одного или нескольких дисков с данными, настоятельно рекомендуется добавить команды автоматической установки или параметр групповой политики в домене клиента для автоматического шифрования дисков с данными.

## <a name="get-the-volume-signature-catalog-file"></a>Получить файл каталога подписи тома

Файлы данных экранирования также содержат сведения о дисках, шаблон, которому доверяет клиент. Клиенты приобретают подписи дисков из дисков надежный шаблон в виде файла каталога (VSC) подписи тома. Эти подписи затем проверяются при развертывании новой виртуальной Машины. Если ни один из подписи в файле данных экранирования диске шаблона пытается развернуть с виртуальной Машиной (т. е. она была изменена или поменять местами с другой, потенциально вредоносных диска), процесс подготовки завершится ошибкой.

> [!IMPORTANT]
> Хотя VSC гарантирует, что диск не были незаконно, по-прежнему важно для клиента на доверие на диск в первую очередь. Если вы являетесь клиента и поставщик услуг размещения, обеспечивается диск шаблона, развертывание тестовой виртуальной Машины с помощью этого шаблона диска и запуск ваших собственных средствах (антивирусная программа, сканеров уязвимости и т. д.) для проверки диска является, по сути, в состоянии, которое вы доверяете.

Существует два способа получения VSC диска шаблона:

-  Поставщик услуг размещения (или клиента, если у клиента есть доступ к VMM) использует командлеты VMM PowerShell для сохранения VSC и присваивает ему клиенту. Это можно сделать на любом компьютере с консолью VMM установлен и настроен для управления средой соответствующей структуре VMM. Командлеты PowerShell для сохранения VSC являются:

        $disk = Get-SCVirtualHardDisk -Name "templateDisk.vhdx"
    
        $vsc = Get-SCVolumeSignatureCatalog -VirtualHardDisk $disk
    
        $vsc.WriteToFile(".\templateDisk.vsc")

-  У клиента есть доступ к файлу диска шаблона. Это может быть так, если клиент создает диск шаблона, чтобы загружены у поставщика услуг размещения службы или клиента можно загрузить диск шаблона поставщика услуг размещения. В этом случае без VMM, на рисунке, клиент будет выполните следующий командлет (устанавливается с помощью функции средства для экранированной виртуальной Машины, часть средств удаленного администрирования сервера):

        Save-VolumeSignatureCatalog -TemplateDiskPath templateDisk.vhdx -VolumeSignatureCatalogPath templateDisk.vsc

## <a name="select-trusted-fabrics"></a>Выберите доверенный структур

Последний компонент в файле данных экранирования относится к владельца и guardians виртуальной машины. Guardians используются для определения владельца экранированной виртуальной Машины и защищенной структуре, на которых он авторизован для запуска.

Чтобы авторизовать соответствующей структуре для запуска экранированной виртуальной Машины, необходимо получить метаданные из службы защиты узла поставщика услуг размещения службы. Часто поставщик услуг предоставит эти метаданные через их средства управления. В корпоративном сценарии могут иметь прямой доступ для получения метаданных самостоятельно.

Вы или ваш поставщик услуг можно получить метаданные из HGS, выполнив одно из следующих действий:

-  Получите метаданные непосредственно из HGS, выполнив следующую команду Windows PowerShell, или просмотра на веб-сайт и сохранения XML-файле, который отображается:

        Invoke-WebRequest 'http://hgs.bastion.local/KeyProtection/service/metadata/2014-07/metadata.xml' -OutFile .\RelecloudGuardian.xml

-  Получите метаданные из VMM с помощью командлетов VMM PowerShell.

        $relecloudmetadata = Get-SCGuardianConfiguration

        $relecloudmetadata.InnerXml | Out-File .\RelecloudGuardian.xml -Encoding UTF8

<!-- Note that the VMM PowerShell cmdlets aren't Windows PowerShell, so "VMM PowerShell" is the correct terminology for them. -->

Получите средство защиты файлов метаданных для каждой защищенной структуры, которые вы хотите разрешить ваши экранированные виртуальные машины под управлением перед продолжением.

## <a name="create-a-shielding-data-file-and-add-guardians-using-the-shielding-data-file-wizard"></a>Создать файл данных экранирования и добавить guardians, с помощью мастера файл данных экранирования

Запустите мастер файл данных экранирования для создания файла экранирования (PDK) данных. Здесь вы добавить сертификат протокола удаленного рабочего СТОЛА, файл, каталог подписи тома, опекуном владельца автоматической установки, а Скачанный метаданные, полученные на предыдущем шаге.

1.  Установка **средства удаленного администрирования сервера &gt; средства администрирования компонентов &gt; средства для экранированной виртуальной Машины** на компьютере, с помощью диспетчера серверов или следующую команду Windows PowerShell:

        Install-WindowsFeature RSAT-Shielded-VM-Tools

2.  Откройте мастер файлов данных экранирования в разделе "средства администрирования" меню "Пуск" или выполняется следующий исполняемый файл **C:\\Windows\\System32\\ShieldingDataFileWizard.exe**.

3.  На первой странице используйте второе окно выбора файла, чтобы выбрать расположение и имя файла данных экранирования. Как правило, следует присвоить имя файл данных экранирования после создания сущности, ответственных за виртуальные машины с помощью этих данных экранирования (например, отдел Кадров, ИТ, Финансы) и роли рабочей нагрузкой, он выполняется (для, например файлового сервера, веб-сервер или что-нибудь еще настроены с помощью файла автоматической установки). Оставьте переключатель присвоено **данных для шаблонов экранированные экранирования**.

    > [!NOTE]
    > Мастер файлов данных экранирования можно заметить, приведенных ниже параметров:
    >- **Данные экранирования в экранированные шаблонов**
    >- **Данные экранирования для существующих виртуальных машин и шаблонов, Неэкранированного**<br>
    > Первый вариант используется при создании новых экранированных виртуальных машин на основе экранированных шаблонов. Второй вариант позволяет создать данные экранирования, которые можно использовать только при преобразовании существующих виртуальных машин и создание экранированных виртуальных машин на основе неэкранированного шаблонов.

    ![Экранирование мастер файлов данных, Выбор файла](../media/Guarded-Fabric-Shielded-VM/guarded-host-shielding-data-wizard-01.png)

       Кроме того необходимо выбрать ли виртуальные машины, созданные с помощью этого файла данных экранирования будут по-настоящему экранированных или в режиме «поддержка шифрования». Дополнительные сведения об этих двух параметрах см. в разделе [какие типы виртуальных машин, которые могут выполняться в защищенной структуре используются?](guarded-fabric-and-shielded-vms.md#what-are-the-types-of-virtual-machines-that-a-guarded-fabric-can-run).

    > [!IMPORTANT]
    > Обратить пристальное внимание к следующему шагу, так как он определяет владельца ваши экранированные виртуальные машины, а какие структуры, будет разрешено выполняться на ваши экранированные виртуальные машины.<br>Владение **опекуном владельца** необходим для изменения существующей экранированной виртуальной Машины из **экранированные** для **шифрование поддерживается** или наоборот.
    
4.  Ваша цель на этом шаге включает два этапа:

    - Создайте или выберите опекуном владельца, представляющий вы как владелец виртуальной Машины

    - Импортируйте средство защиты, загруженный из поставщика услуг размещения (или собственную) службы Защитника узлов на предыдущем шаге

    Чтобы указать существующий опекуном владельца, выберите соответствующий защиты из раскрывающегося меню. Только guardians установлен на локальном компьютере с закрытыми ключами без изменений будет отображаться в этом списке. Можно также создать свои собственные опекуном владельца, выбрав **управление локальной Guardians** в нижнем правом углу и выбрав **создать** и завершение работы мастера.

    Затем мы импортировать метаданные Скачанный ранее снова, используя **владельца и заменяющим** страницы. Выберите **управление локальной Guardians** в правом нижнем углу. Используйте **импорта** возможность для импорта файла метаданных защиты. Нажмите кнопку **ОК** после импорта или добавлены все необходимые защитников. Рекомендуется назовите guardians после размещения службы предприятия или поставщика центра обработки данных, они представляют. Наконец выберите все защитников, представляющие центров обработки данных, в котором экранированные ВМ авторизован для запуска. Необходимо снова выберите опекуном владельца. Нажмите кнопку **Далее** после завершения.

    ![Экранирование мастер файлов данных, владельца и guardians](../media/Guarded-Fabric-Shielded-VM/guarded-host-shielding-data-wizard-02.png)

5.  На странице квалификаторы тома, щелкните **добавить** для авторизации диска подписанного шаблона в файл данных экранирования. При выборе VSC в диалоговом окне, она покажет сведения о этот диск имя, версию и сертификат, который использовался для подписания. Повторите эту процедуру для каждого диска шаблона, который вы хотите разрешить.

6.  На **значения специализации** щелкните **Обзор** чтобы выбрать файл unattend.xml, который будет использоваться для уточнения ваших виртуальных машин.

    Используйте **добавить** кнопку внизу, чтобы добавить дополнительные файлы, которые требуются во время процесса специализации PDK-файла. Например, если ваш файл автоматической установки устанавливает сертификат протокола удаленного рабочего СТОЛА на виртуальной Машине (как описано в разделе [Создание файла ответов с помощью функции New-ShieldingDataAnswerFile](guarded-fabric-sample-unattend-xml-file.md)), нужно добавить файл RDPCert.pfx, на которые ссылается Здесь файл автоматической установки. Обратите внимание, что все файлы, указанные здесь будет автоматически копироваться на диске C:\\temp\\ на виртуальной Машине, которая создается. Файл автоматической установки следует ожидать, что файлы должны находиться в этой папке, при указании ссылки на их по пути.

7.  Просмотрите выбранные параметры на следующей странице, а затем нажмите кнопку **формирования**.

8.  Закройте мастер после его завершения.

## <a name="create-a-shielding-data-file-and-add-guardians-using-powershell"></a>Создать файл данных экранирования и добавить guardians, с помощью PowerShell

В качестве альтернативы к мастеру файл данных экранирования, можно запустить [New ShieldingDataFile](https://docs.microsoft.com/powershell/module/shieldedvmdatafile/new-shieldingdatafile?view=win10-ps) создать файл данных экранирования.

Все файлы данных экранирования должны быть настроены правильные владельца и защиты сертификаты для авторизации ваши экранированные виртуальные машины для выполнения в защищенной структуре.
Можно проверить наличие любого guardians установлен локально с [Get-HgsGuardian](https://docs.microsoft.com/en-us/powershell/module/hgsclient/get-hgsguardian?view=win10-ps). Владелец guardians имеют закрытые ключи, а guardians для вашего центра обработки данных обычно нет.

Если вам нужно создать опекуном владельца, выполните следующую команду:

```powershell
New-HgsGuardian -Name "Owner" -GenerateCertificates
```

Эта команда создает пару сертификаты для подписи и шифрования в хранилище сертификатов на локальном компьютере в папке «Экранированных локальных сертификатов виртуальной Машины».
Вам потребуется сертификатов владельца и соответствующие им закрытые ключи для unshield виртуальной машины, поэтому эти сертификаты резервного копирования и защиты от кражи.
Злоумышленник, имеющий доступ к сертификатам владельца их можно использовать для запуска экранированной виртуальной машины или изменения конфигурации безопасности.

Если вам нужно импортировать сведения о защиты из защищенной структуры, где вы хотите запустить виртуальную машину (в основном центре обработки данных, резервного копирования центров обработки данных и др.), выполните следующую команду для каждого [файл метаданных, полученных из защищенной структуры. ](#select-trusted-fabrics).

```powershell
Import-HgsGuardian -Name 'EAST-US Datacenter' -Path '.\EastUSGuardian.xml'
```

> [!TIP]
> Если вы использовали самозаверяющих сертификатов или сертификатов, зарегистрированных с HGS срок действия истек, может потребоваться использовать `-AllowUntrustedRoot` и/или `-AllowExpired` флагов с помощью импорта HgsGuardian команду, чтобы обойти проверку безопасности.

Также необходимо будет [получить каталог подписи тома](#get-the-volume-signature-catalog-file) для каждого диска шаблона, вы хотите использовать с этот файл данных экранирования и [ответов файл данных экранирования](#create-an-answer-file) чтобы разрешить операционной системе завершить его Специализация задач автоматически.
Наконец определите, будут ли виртуальная машина могла быть полностью экранирована "или" только что включил виртуального доверенного платформенного модуля.
Используйте `-Policy Shielded` для полностью экранированной виртуальной Машины или `-Policy EncryptionSupported` для виртуальной Машины, разрешающее подключения простые консольные и PowerShell Direct с поддержкой виртуального доверенного платформенного модуля.

Когда все будет готово, выполните следующую команду, чтобы создать файл данных экранирования:

```powershell
$viq = New-VolumeIDQualifier -VolumeSignatureCatalogFilePath 'C:\temp\marketing-ws2016.vsc' -VersionRule Equals
New-ShieldingDataFile -ShieldingDataFilePath "C:\temp\Marketing-LBI.pdk" -Policy EncryptionSupported -Owner 'Owner' -Guardian 'EAST-US Datacenter' -VolumeIDQualifier $viq -AnswerFile 'C:\temp\marketing-ws2016-answerfile.xml'
```

В приведенной выше команде защиты, с именем «Owner» (полученная из Get-HgsGuardian) будут иметь возможность менять конфигурацию безопасности виртуальной машины в будущем, хотя в «Центре обработки данных Восток США» могут запускать виртуальную Машину, но не изменять его параметры.
При наличии более одного guardian отдельные имена защитников запятыми, такие как `'EAST-US Datacenter', 'EMEA Datacenter'`.
Квалификатор идентификатора тома определяет, доверяете ли вы только точный номер версии (равно) диска шаблона или будущих версий (GreaterThanOrEquals) также.
Сравнение версий учитывать во время развертывания для соответствия имени диска и сертификат для подписи.
Более одного диска шаблона, которому можно доверять, указав разделенный запятыми список томов квалификаторы для `-VolumeIDQualifier` параметра.
И, наконец, если у вас есть другие файлы, которые необходимо сопровождать файл ответов с виртуальной Машиной, используйте `-OtherFile` параметр и укажите разделенный запятыми список путей к файлам.

См. в документации командлета [New ShieldingDataFile](https://docs.microsoft.com/en-us/powershell/module/shieldedvmdatafile/New-ShieldingDataFile?view=win10-ps) и [New VolumeIDQualifier](https://docs.microsoft.com/en-us/powershell/module/shieldedvmdatafile/New-VolumeIDQualifier?view=win10-ps) Дополнительные сведения о дополнительных способах настройки файла данных экранирования.

## <a name="see-also"></a>См. также

- [Развертывание экранированных виртуальных машин](guarded-fabric-configuration-scenarios-for-shielded-vms-overview.md)
- [Защищенная структура и экранированные виртуальные машины](guarded-fabric-and-shielded-vms-top-node.md)
