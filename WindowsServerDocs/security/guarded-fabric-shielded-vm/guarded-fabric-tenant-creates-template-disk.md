---
title: Экранированные виртуальные машины для клиентов — Создание диска шаблона — необязательно
ms.prod: windows-server
ms.topic: article
ms.assetid: c1992f8b-6f88-4dbc-b4a5-08368bba2787
manager: dongill
author: rpsqrd
ms.author: ryanpu
ms.technology: security-guarded-fabric
ms.date: 08/29/2018
ms.openlocfilehash: 1f51a0f90f60847929f6fe46732c98f355a6a859
ms.sourcegitcommit: b00d7c8968c4adc8f699dbee694afe6ed36bc9de
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/08/2020
ms.locfileid: "80856447"
---
# <a name="shielded-vms-for-tenants---creating-a-template-disk-optional"></a>Экранированные виртуальные машины для клиентов — Создание диска шаблона (необязательно)

>Область применения: Windows Server 2019, Windows Server (половина ежегодного канала), Windows Server 2016

Чтобы создать экранированную виртуальную машину, необходимо использовать специально подготовленный подписанный диск шаблона. Метаданные из дисков шаблонов с подписью гарантируют, что диски не изменяются после создания и позволяют клиенту ограничить диски, которые можно использовать для создания экранированных виртуальных машин. Одним из способов предоставления этого диска является создание его для клиента, как описано в этом разделе. 

> [!IMPORTANT]
> При желании вы можете использовать диск шаблона, предоставленный поставщиком услуг размещения. В этом случае важно развернуть тестовую виртуальную машину с помощью этого диска шаблона и запустить собственные средства (антивирусные программы, сканеры уязвимостей и т. д.), чтобы убедиться, что диск действительно находится в надежном состоянии.

## <a name="prepare-an-operating-system-vhdx"></a>Подготовка VHDX операционной системы

Чтобы создать диск экранированного шаблона, сначала необходимо подготовить диск операционной системы, который будет запускаться с помощью мастера создания диска шаблона. Этот диск будет использоваться в качестве диска ОС в экранированных виртуальных машинах. Вы можете использовать любые существующие средства для создания этого диска, например, Windows Desktop Image Service Manager (DISM), или вручную настроить виртуальную машину с пустым VHDX-файлом и установить на этот диск ОС. При настройке диска необходимо соблюдать следующие требования, характерные для виртуальных машин версии 2 и экранирования. 

| Требование для VHDX | Причина |
|-----------|----|
|Должен быть диском таблицы разделов GUID (GPT) | Требуется для поддержки UEFI виртуальных машин версии 2|
|Тип диска должен быть **базовым** , а не **динамическим**. <br>Примечание. Это относится к типу логического диска, а не к динамически расширяемой функции VHDX, поддерживаемой Hyper-V. | BitLocker не поддерживает динамические диски.|
|Диск содержит по крайней мере два раздела. Один раздел должен включать диск, на котором установлена ОС Windows. Это диск, который шифрование BitLocker будет шифровать. Другой раздел — это активный раздел, который содержит загрузчик и остается незашифрованным, чтобы компьютер можно было запустить.|Требуется для BitLocker|
|Файловая система NTFS | Требуется для BitLocker|
|Операционная система, установленная на VHDX, является одной из следующих:<br>— Windows Server 2019, Windows Server 2016, Windows Server 2012 R2 или Windows Server 2012 <br>— Windows 10, Windows 8.1, Windows 8| Требуется для поддержки виртуальных машин версии 2 и шаблона безопасной загрузки Майкрософт|
|Операционная система должна быть обобщенной (запустите Sysprep. exe) | Подготовка шаблонов включает в себя специализацию виртуальных машин для рабочей нагрузки конкретного клиента.| 

> [!NOTE]
> Не копируйте диск шаблона в библиотеку VMM на этом этапе. 

### <a name="required-packages-to-create-a-nano-server-template-disk"></a>Необходимые пакеты для создания диска шаблона Nano Server

Если вы планируете запускать Nano Server в качестве гостевой ОС в экранированных виртуальных машинах, необходимо убедиться, что образ Nano Server содержит следующие пакеты:

- Microsoft-NanoServer-Guest-Package
- Microsoft-NanoServer-SecureStartup-Package:

## <a name="run-windows-update-on-the-template-operating-system"></a>Запуск Центр обновления Windows в операционной системе шаблона

На диске шаблона убедитесь, что в операционной системе установлены все последние обновления Windows. Недавно выпущенные обновления повышают надежность сквозного процесса экранирования — процесса, который может завершиться ошибкой, если шаблон операционной системы не обновлен.

## <a name="sign-and-protect-the-vhdx-with-the-template-disk-wizard"></a>Подписывание и защита VHDX с помощью мастера создания диска шаблона

Чтобы использовать диск шаблона с экранированными виртуальными машинами, диск должен быть подписан и зашифрован с помощью BitLocker. Для этого вы будете использовать мастер создания диска экранированного шаблона. Этот мастер создаст хэш для диска и добавит его в каталог подписей тома (VSC). VSC подписывается с помощью указанного сертификата и используется в процессе подготовки, чтобы гарантировать, что диск, развернутый для клиента, не был изменен или заменен на диск, которому не доверяет клиент. Наконец, BitLocker устанавливается в операционной системе диска (если это еще не сделано) для подготовки диска к шифрованию во время подготовки виртуальной машины.

> [!NOTE]
> Мастер создания диска шаблона изменит диск шаблона, указанный на месте. Перед запуском мастера может потребоваться создать копию незащищенного VHDX-файла, чтобы обновить диск позднее. Вы не сможете изменить диск, который был защищен с помощью мастера создания диска шаблонов.

Выполните следующие действия на компьютере под Windows Server 2016 (не обязательно должен быть защищенным узлом или сервером VMM):

1. Скопируйте обобщенный VHDX, созданный в поле подготовка к использованию [VHDX операционной системы](#prepare-an-operating-system-vhdx) на сервер, если он еще не создан.

2. Установите компонент **средств экранированной виртуальной машины** из **средства удаленного администрирования сервера** на компьютере.

        Install-WindowsFeature RSAT-Shielded-VM-Tools -Restart

3. Получите или создайте сертификат для подписания VHDX-файлов, который станет диском шаблона для новых экранированных виртуальных машин. Сведения об этом сертификате будут включены в файл данных экранирования, который разрешает диск в качестве доверенного диска. Поэтому важно получить этот сертификат из центра сертификации, которому доверяет поставщик услуг размещения. В корпоративных сценариях, где вы одновременно являетесь клиентом и поставщиками услуг размещения и клиента, вы можете использовать этот сертификат из PKI.

    Если вы настраиваете тестовую среду и хотите использовать самозаверяющий сертификат для подписывания диска шаблона, выполните на компьютере команду, аналогичную следующей:

        New-SelfSignedCertificate -DnsName publisher.fabrikam.com

4. Запустите **Мастер создания шаблона диска** из папки " **Администрирование** " в меню "Пуск" или введите **темплатедисквизард. exe** в командной строке.

5. На странице **сертификат** нажмите кнопку **Обзор** , чтобы отобразить список сертификатов. Выберите сертификат для подписи шаблона диска. Нажмите кнопку **ОК**, а затем — **Далее**.

6. На странице виртуальный диск нажмите кнопку **Обзор** , чтобы выбрать подготовленный VHDX-файл, а затем нажмите кнопку **Далее**.

7. На странице Каталог подписей укажите понятное **имя** и версию диска **.** Эти поля позволяют определить диск после его подписания.

    Например, для **имени диска** можно ввести _WS2016_ и для **Version**, _1.0.0.0_

8. Проверьте параметры на странице мастера Проверка параметров. При нажатии кнопки " **создать**" мастер включит BitLocker на диске шаблона, вычислит хэш диска и создаст каталог сигнатур томов, хранящийся в метаданных VHDX.

    Дождитесь завершения процесса подписывания, прежде чем пытаться подключить или переместить диск шаблона. Выполнение этого процесса может занять некоторое время в зависимости от размера диска. 

9. На странице **Сводка** сведения о шаблоне диска, сертификате, используемом для подписи шаблона, и отображается издатель сертификата. Чтобы выйти из мастера, нажмите кнопку **Закрыть**.


Укажите шаблон экранированного диска для поставщика услуг размещения, а также созданный файл данных экранирования, как описано в разделе [Создание данных экранирования для определения экранированной виртуальной машины](guarded-fabric-tenant-creates-shielding-data.md).

## <a name="see-also"></a>См. также:

- [Развертывание экранированных виртуальных машин](guarded-fabric-configuration-scenarios-for-shielded-vms-overview.md)
- [Защищенная структура и экранированные виртуальные машины](guarded-fabric-and-shielded-vms-top-node.md)
