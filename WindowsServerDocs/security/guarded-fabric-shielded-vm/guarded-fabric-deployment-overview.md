---
title: Краткое руководство по развертыванию защищенной структуры
ms.custom: na
ms.prod: windows-server-threshold
ms.topic: article
ms.assetid: e060e052-39a0-4154-90bb-b97cc6dde68e
manager: dongill
author: justinha
ms.author: justinha
ms.technology: security-guarded-fabric
ms.date: 01/30/2019
ms.openlocfilehash: 48ac73e79709f28816ea9eff35361bd54710c66e
ms.sourcegitcommit: f6490192d686f0a1e0c2ebe471f98e30105c0844
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/10/2019
ms.locfileid: "70870527"
---
# <a name="quick-start-for-guarded-fabric-deployment"></a>Краткое руководство по развертыванию защищенной структуры

>Относится к: Windows Server (Semi-Annual Channel), Windows Server 2016

В этом разделе объясняется, что такое защищенная структура, ее требования и Сводка процесса развертывания. Подробные инструкции по развертыванию см. [в разделе Развертывание службы защиты узла для защищенных узлов и экранированных виртуальных машин](https://technet.microsoft.com/windows-server-docs/security/guarded-fabric-shielded-vm/guarded-fabric-deploying-hgs-overview).

Предпочитаете видео? Ознакомьтесь с курсом Microsoft Virtual Academy, который [развертывает экранированные виртуальные машины и защищенную структуру с помощью Windows Server 2016](https://mva.microsoft.com/en-US/training-courses/deploying-shielded-vms-and-a-guarded-fabric-with-windows-server-2016-17131?l=WFLef7vUD_4604300474).

## <a name="what-is-a-guarded-fabric"></a>Что такое защищенная структура

_Защищенная структура_ — это структура Hyper-V Windows Server 2016, способная защищать рабочие нагрузки клиентов от вредоносных программ, выполняемых на узле, а также от системных администраторов. Эти виртуализированные рабочие нагрузки клиента, защищенные как при неактивных, так и в полете, называются _экранированными виртуальными машинами_. 

## <a name="what-are-the-requirements-for-a-guarded-fabric"></a>Каковы требования к защищенной структуре

Требования для защищенной структуры включают:

- **Место для запуска экранированных виртуальных машин, которые свободны от вредоносных программ.**

    Они называются _защищенными узлами_. 
    Защищенные узлы — это узлы Hyper-V Windows Server 2016 Datacenter Edition, которые могут запускать экранированные виртуальные машины, только если они могут доказать, что они работают в известном надежном состоянии, внешнему центру, который называется службой защиты узла (HGS). 
    HGS — это новая роль сервера в Windows Server 2016, которая обычно развертывается как кластер с тремя узлами. 

- **Способ проверки того, что узел находится в работоспособном состоянии.**

    HGS выполняет _аттестацию_, где измеряет работоспособность защищенных узлов.

- **Процесс безопасного освобождения ключей для работоспособных узлов.**

    HGS выполняет _защиту ключа и основные выпуски_, при этом ключи возвращаются к работоспособным узлам.

- **Средства управления для автоматизации безопасной подготовки и размещения экранированных виртуальных машин.**

    При необходимости эти средства управления можно добавить в защищенную структуру:

    - Virtual Machine Manager System Center 2016 (VMM). Рекомендуется использовать VMM, так как он предоставляет дополнительные средства управления, помимо тех, которые вы получаете, используя только командлеты PowerShell, которые входят в состав Hyper-V и защищенных рабочих нагрузок структуры.
    - Service Provider Foundation System Center 2016 (SPF). Это уровень API между Windows Azure Pack и VMM и необходимым условием для использования Windows Azure Pack.
    - Windows Azure Pack предоставляет хороший графический веб-интерфейс для управления защищенной структурой и экранированными виртуальными машинами. 

На практике одно решение должно быть выполнено заранее: [режим аттестации](guarded-fabric-and-shielded-vms.md#attestation-modes-in-the-guarded-fabric-solution) , используемый защищенной структурой. Существует два способа: два взаимоисключающих режима, с помощью которых HGS может измерять работоспособность узла Hyper-V. При инициализации HGS необходимо выбрать режим:  

- Аттестация ключа узла, или режим ключей, менее безопасна, но проще в освоении  
- Аттестация на основе TPM или режима TPM является более безопасной, но требует больше конфигурации и конкретного оборудования.

При необходимости можно развернуть в режиме Key, используя существующие узлы Hyper-V, которые были обновлены до Windows Server 2019 Datacenter Edition, а затем преобразовать их в более безопасный режим TPM при наличии поддерживаемого серверного оборудования (включая TPM 2,0). 

Теперь, когда вы понимаете, что такое части, давайте рассмотрим пример модели развертывания.

## <a name="how-to-get-from-a-current-hyper-v-fabric-to-a-guarded-fabric"></a>Как получить из текущей структуры Hyper-V в защищенную структуру

Давайте Представьте себе этот сценарий — у вас есть существующая структура Hyper-V, например Contoso.com на следующем рисунке, и вы хотите создать защищенную структуру Windows Server 2016.

![Существующая структура Hyper-V](../media/Guarded-Fabric-Shielded-VM/guarded-fabric-existing-hyper-v.png)

## <a name="step-1-deploy-the-hyper-v-hosts-running-windows-server-2016"></a>Шаг 1. Развертывание узлов Hyper-V под управлением Windows Server 2016 

Узлы Hyper-V должны работать под управлением Windows Server 2016 Datacenter Edition или более поздней версии. При обновлении узлов можно [Перейти](https://technet.microsoft.com/windowsserver/dn527667.aspx) с выпуска Standard Edition на выпуск Datacenter.

![Обновление узлов Hyper-V](../../security/media/Guarded-Fabric-Shielded-VM/guarded-fabric-deployment-step-one-upgrade-hyper-v.png)

## <a name="step-2-deploy-the-host-guardian-service-hgs"></a>Шаг 2. Развертывание службы защиты узла (HGS)

Затем установите роль сервера HGS и разверните его как кластер с тремя узлами, как показано на следующем рисунке, например relecloud.com. Для этого требуются три командлета PowerShell:

- Чтобы добавить роль HGS, используйте`Install-WindowsFeature` 
- Чтобы установить HGS, используйте`Install-HgsServer` 
- Чтобы инициализировать HGS с выбранным режимом аттестации, используйте`Initialize-HgsServer` 

Если существующие серверы Hyper-V не соответствуют предварительным требованиям для режима TPM (например, у них нет доверенного платформенного модуля (TPM 2,0)), вы можете инициализировать HGS с помощью аттестации на основе администратора (режим AD), что требует Active Directory отношения доверия с доменом структуры. 

В нашем примере компания Contoso изначально развертывает в режиме AD для немедленного удовлетворения требований соответствия требованиям и планирует преобразовать их в более защищенную аттестацию на основе доверенного платформенного модуля после приобретения соответствующего оборудования сервера. 

![Установка HGS](../media/Guarded-Fabric-Shielded-VM/guarded-fabric-deployment-step-two-deploy-hgs.png)

## <a name="step-3-extract-identities-hardware-baselines-and-code-integrity-policies"></a>Шаг 3. Извлечение удостоверений, базовых показателей оборудования и политик целостности кода

Процесс извлечения удостоверений из узлов Hyper-V зависит от используемого режима аттестации.

Для режима AD ИДЕНТИФИКАТОРом узла является учетная запись компьютера, присоединенного к домену, которая должна быть членом назначенной группы безопасности в домене структуры.
Членство в назначенной группе является единственным определением того, является ли узел работоспособным. 

В этом режиме администратор структуры несет ответственность за обеспечение работоспособности узлов Hyper-V. Так как HGS не позволяет решить, что такое или не разрешено запускать, вредоносные программы и отладчики будут работать так, как задумано. 

Однако отладчики, пытающиеся выполнить прямое подключение к процессу (например, WinDbg. exe), блокируются для экранированных виртуальных машин, так как рабочий процесс виртуальной машины (ВМВП. exe) — это защищенный процесс (PPL).
Альтернативные методы отладки, такие как используемые программа LiveKD. exe, не блокируются. В отличие от экранированных виртуальных машин, Рабочий процесс для поддерживаемых шифрованием виртуальных машин не выполняется в виде PPL, поэтому традиционные отладчики, такие как WinDbg. exe, будут продолжать работать в обычном режиме.

Другими словами, строгие шаги проверки, используемые для режима TPM, не используются в режиме AD.

Для режима TPM требуются три вещи: 

1.  _Открытый ключ подтверждения_ (или _ЕКПУБ_) из доверенного платформенного модуля 2,0 на каждом узле Hyper-V. Чтобы записать Екпуб, используйте `Get-PlatformIdentifier`. 
2.  _Базовый уровень оборудования_. Если все узлы Hyper-V идентичны, то требуется всего один базовый план. Если это не так, потребуется по одному для каждого класса оборудования. Базовые показатели задается в виде файла журнала группы надежных вычислительных ресурсов или Ткглог. Ткглог содержит все, что было на узле, от встроенного по UEFI до ядра, до тех пор, пока узел полностью загружается. Чтобы записать базовые показатели оборудования, установите роль Hyper-V и функцию поддержки защиты узла Hyper-V и используйте `Get-HgsAttestationBaselinePolicy`. 
3.  _Политика целостности кода_. Если все узлы Hyper-V идентичны, то достаточно одной политики непрерывной интеграции. Если это не так, потребуется по одному для каждого класса оборудования. В Windows Server 2016 и Windows 10 имеется новая форма применения политик CI, называемая _целостностью кода, применяемой гипервизором (обязательная политика hvci)_ . ОБЯЗАТЕЛЬНАЯ политика HVCI обеспечивает строгую защиту и гарантирует, что узлу разрешено выполнять только двоичные файлы, разрешенные доверенным администратором. Эти инструкции упаковываются в политику CI, которая добавляется в HGS. HGS измеряет политику CI каждого узла, прежде чем им разрешается запускать экранированные виртуальные машины. Чтобы записать политику CI, используйте `New-CIPolicy`. После этого политика должна быть преобразована в двоичную форму `ConvertFrom-CIPolicy`с помощью.

![Извлечение удостоверений, базовых показателей и политик CI](../media/Guarded-Fabric-Shielded-VM/guarded-fabric-deployment-step-three-extract-identity-baseline-ci-policy.png)

Все это — защищенная структура построена с точки зрения инфраструктуры для ее запуска.  
Теперь вы можете создать диск шаблона экранированной виртуальной машины и файл данных экранирования, чтобы обеспечить простую и безопасную подготовку экранированных виртуальных машин. 

## <a name="step-4-create-a-template-for-shielded-vms"></a>Шаг 4. Создание шаблона для экранированных виртуальных машин

Шаблон экранированной виртуальной машины защищает диски шаблонов, создавая сигнатуру диска в известном месте на момент времени. 
Если впоследствии диск шаблона заражен вредоносными программами, его подпись будет отличаться от исходного шаблона, который будет обнаружен в процессе подготовки защищенной экранированной виртуальной машины. 
Диски экранированных шаблонов создаются путем запуска **мастера создания диска экранированного шаблона** или `Protect-TemplateDisk` с помощью обычного диска шаблона. 

Каждый из них включен в компонент " **средства экранированной виртуальной машины** " в [средства удаленного администрирования сервера для Windows 10](https://www.microsoft.com/download/details.aspx?id=45520).
После загрузки RSAT выполните следующую команду, чтобы установить компонент " **средства экранированной виртуальной машины** ":

```powershell
Install-WindowsFeature RSAT-Shielded-VM-Tools -Restart
```

Доверенному администратору, например администратору структуры или владельцу виртуальной машины, потребуется сертификат (часто предоставляемый поставщиком услуг размещения) для подписи диска шаблона VHDX. 

![Мастер создания диска экранированного шаблона](../media/Guarded-Fabric-Shielded-VM/guarded-fabric-shielded-template-wizard.png)

Подпись диска вычислена в разделе ОС виртуального диска.
Если что-либо изменилось в разделе ОС, подпись также изменится.
Это позволяет пользователям строго определять, какие диски они доверяют, указывая соответствующую подпись.

Прежде чем приступить к работе, ознакомьтесь с [требованиями к диску шаблона](guarded-fabric-create-a-shielded-vm-template.md) . 

## <a name="step-5-create-a-shielding-data-file"></a>Шаг 5. Создание файла данных экранирования 

Файл данных экранирования, также известный как PDK-файл, захватывает конфиденциальные сведения о виртуальной машине, например пароль администратора. 

![Данные экранирования](../media/Guarded-Fabric-Shielded-VM/guarded-fabric-deployment-step-five-create-shielding-data.png)

Файл данных экранирования также включает параметр политики безопасности для экранированной виртуальной машины. При создании файла данных экранирования необходимо выбрать одну из двух политик безопасности:

- Экранированных
   
    Наиболее безопасный вариант, который устраняет многие административные направления атак.

- Поддерживается шифрование

    Менее низкий уровень защиты, который по-прежнему обеспечивает возможность шифрования виртуальной машины, но позволяет администраторам Hyper-V выполнять такие действия, как использование подключения консоли виртуальной машины и PowerShell Direct. 

    ![Новая виртуальная машина, поддерживаемая шифрованием](../media/Guarded-Fabric-Shielded-VM/guarded-fabric-new-shielded-vm.png)

Можно добавить дополнительные элементы управления, такие как VMM или Windows Azure Pack. Если вы хотите создать виртуальную машину, не устанавливая эти компоненты, см. статью Пошаговое руководство. [Создание экранированных виртуальных машин без VMM](https://blogs.technet.microsoft.com/datacentersecurity/2016/06/06/step-by-step-creating-shielded-vms-without-vmm/).

## <a name="step-6-create-a-shielded-vm"></a>Шаг 6. Создание экранированной виртуальной машины

Создание экранированных виртуальных машин значительно отличается от обычных виртуальных машин. В Windows Azure Pack взаимодействие еще проще, чем создание обычной виртуальной машины, так как вам нужно указать только имя, файл данных экранирования (содержащий оставшуюся часть информации о специализации) и сеть виртуальной машины. 

![Новая экранированная виртуальная машина в Windows Azure Pack](../media/Guarded-Fabric-Shielded-VM/guarded-fabric-new-vm-config.png)

## <a name="next-step"></a>Дальнейшие действия

> [!div class="nextstepaction"]
> [Предварительные требования для HGS](guarded-fabric-prepare-for-hgs.md)
