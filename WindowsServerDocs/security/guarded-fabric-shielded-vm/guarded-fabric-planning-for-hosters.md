---
title: Рекомендации по планированию защищенной структуры и экранированной виртуальной машины для поставщиков услуг размещения
ms.custom: na
ms.prod: windows-server-threshold
ms.topic: article
ms.assetid: 854defc8-99f8-4573-82c0-f484e0785859
manager: dongill
author: nirb-ms
ms.technology: security-guarded-fabric
ms.date: 08/29/2018
ms.openlocfilehash: baa360ecb81c0e8bd54e66771d41c11968b57714
ms.sourcegitcommit: f6490192d686f0a1e0c2ebe471f98e30105c0844
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/10/2019
ms.locfileid: "70870451"
---
# <a name="guarded-fabric-and-shielded-vm-planning-guide-for-hosters"></a>Рекомендации по планированию защищенной структуры и экранированной виртуальной машины для поставщиков услуг размещения

>Относится к: Windows Server 2019, Windows Server (половина ежегодного канала), Windows Server 2016

В этом разделе рассматриваются решения по планированию, которые необходимо внести, чтобы разрешить запуск экранированных виртуальных машин в структуре. Независимо от того, обновляется ли существующая структура Hyper-V или создает новую структуру, работающие экранированные виртуальные машины состоят из двух основных компонентов:

- Служба защиты узла (HGS) обеспечивает аттестацию и защиту ключей, что позволяет гарантировать, что экранированные виртуальные машины будут работать только на утвержденных и исправных узлах Hyper-V. 
- Утвержденные и работоспособные узлы Hyper-V, на которых могут работать экранированные виртуальные машины (и обычные виртуальные машины) — они называются защищенными узлами.

![HGS и защищенный узел](../media/Guarded-Fabric-Shielded-VM/guarded-host-hgs-plus-host-diagram-basic.png)

## <a name="decision-1-trust-level-in-the-fabric"></a>#1 принятия решений: Уровень доверия в структуре

Реализация службы защиты узла и защищенных узлов Hyper-V будет зависеть главным образом от надежности, которую вы хотите достичь в вашей структуре. Сила доверия регулируется режимом аттестации. Существует два взаимоисключающих варианта:

1. Аттестация, доверенная доверенным платформенным модулем

    Если ваша цель заключается в защите виртуальных машин от вредоносных администраторов или от скомпрометированной структуры, вы будете использовать аттестацию, доверенную доверенным платформенным модулем. Этот вариант хорошо подходит для сценариев размещения с несколькими клиентами, а также для наиболее ценных активов в корпоративных средах, таких как контроллеры домена или серверы содержимого, такие как SQL или SharePoint.
    Политики целостности кода, защищенные гипервизором (обязательная политика HVCI), измеряются и их срок действия обеспечивает HGS, прежде чем узлу разрешается запускать экранированные виртуальные машины. 

2. Аттестация ключа узла

    Если требования в основном определяются соответствием требованиям, требующим, чтобы виртуальные машины были зашифрованы как при хранении, так и на лету, будет использоваться аттестация ключа узла. Этот вариант хорошо подходит для центров обработки данных общего назначения, где вы имеете опыт работы с администраторами узлов и структур Hyper-V, имеющими доступ к гостевым операционным системам виртуальных машин для повседневного обслуживания и эксплуатации. 

    В этом режиме администратор структуры несет ответственность за обеспечение работоспособности узлов Hyper-V. 
    Так как HGS не позволяет решить, что такое или не разрешено запускать, вредоносные программы и отладчики будут работать так, как задумано. 
    
    Однако отладчики, пытающиеся выполнить прямое подключение к процессу (например, WinDbg. exe), блокируются для экранированных виртуальных машин, так как рабочий процесс виртуальной машины (ВМВП. exe) — это защищенный процесс (PPL). 
    Альтернативные методы отладки, такие как используемые программа LiveKD. exe, не блокируются. 
    В отличие от экранированных виртуальных машин, Рабочий процесс для поддерживаемых шифрованием виртуальных машин не выполняется в виде PPL, поэтому традиционные отладчики, такие как WinDbg. exe, будут продолжать работать в обычном режиме.

    Аналогичный режим аттестации с именем "Доверенная аттестация (на основе Active Directory)" является устаревшим, начиная с Windows Server 2019. 

Выбранный уровень доверия определяет требования к оборудованию для узлов Hyper-V, а также политики, применяемые к структуре. При необходимости можно развернуть защищенную структуру, используя существующее оборудование и аттестацию, доверенную администратором, а затем преобразовать ее в аттестацию, доверенную для доверенного платформенного модуля, при обновлении оборудования и необходимости усилить безопасность структуры.

## <a name="decision-2-existing-hyper-v-fabric-versus-a-new-separate-hyper-v-fabric"></a>#2 принятия решений: Существующая структура Hyper-V в сравнении с новой отдельной структурой Hyper-V

Если у вас уже есть структура (Hyper-V или иным способом), скорее всего, ее можно использовать для запуска экранированных виртуальных машин вместе с обычными виртуальными машинами. Некоторые клиенты решили интегрировать экранированные виртуальные машины в существующие средства и структуры, в то время как другие отделяют структуру от бизнес-целей.

## <a name="hgs-admin-planning-for-the-host-guardian-service"></a>Планирование администратора HGS для службы защиты узла

Развертывание службы защитника узлов (HGS) в среде с высокой степенью безопасности, будь то выделенный физический сервер, экранированная виртуальная машина, виртуальная машина на изолированном узле Hyper-V (отделенная от структуры, которую он защищает) или логически разделенная с помощью другого Azure. подписчик.   

| Область | Подробности |
|------|---------|
| Требования к установке | <ul><li>Один сервер (для обеспечения высокой доступности рекомендуется использовать кластер из трех узлов)</li><li>Для отката требуются по крайней мере два сервера HGS.</li><li>Серверы могут быть виртуальными или физическими (рекомендуется использовать физический сервер с доверенным платформенным модулем 2,0). TPM 1,2 также поддерживается)</li><li>Установка основных серверных компонентов Windows Server 2016 или более поздней версии</li><li>Сетевая аналитика структуры, допускающей HTTP или [резервную конфигурацию](guarded-fabric-manage-branch-office.md#fallback-configuration)</li><li>Рекомендуемый сертификат HTTPS для проверки доступа</li></ul> |
| Изменения размера | Каждый средний узел сервера HGS (8-ядерный/4 ГБ) может обслуживать узлы Hyper-V 1 000. |
| Management | Назначьте конкретных пользователей, которые будут управлять HGS. Они должны быть отделены от администраторов структуры. Для сравнения кластеры HGS можно рассматривать так же, как центр сертификации (ЦС) с точки зрения административной изоляции, физического развертывания и общего уровня чувствительности безопасности. |
| Active Directory службы защиты узла | По умолчанию HGS устанавливает собственные внутренние Active Directory для управления. Это автономный, самостоятельно управляемый лес, который является рекомендуемой конфигурацией, помогающей изолировать HGS от вашей структуры.<br><br>Если у вас уже есть лес Active Directory с высоким уровнем привилегий, который используется для изоляции, можно использовать этот лес вместо леса HGS по умолчанию. Важно, чтобы служба HGS не присоединяется к домену в том же лесу, что и узлы Hyper-V или средства управления структурой. Это может позволить администратору структуры получить контроль над HGS. |
| Аварийное восстановление | Этот параметр может иметь три значения:<br><ol><li>Установите отдельный кластер HGS в каждом центре обработки данных и разрешите экранированным виртуальным машинам работать как в основном, так и в резервных центрах данных. Это позволяет избежать необходимости растянуть кластер по глобальной сети и изолировать виртуальные машины таким образом, чтобы они выполнялись только на назначенном им сайте.</li><li>Установите HGS в кластере с растяжением между двумя (или несколькими) центрами обработки данных. Это обеспечивает устойчивость при отключении глобальной сети, но передает ограничения отказоустойчивой кластеризации. Вы не можете изолировать рабочие нагрузки на одном сайте. Виртуальная машина, разрешенная для запуска на одном сайте, может работать на любом другом.</li><li>Зарегистрируйте узел Hyper-V в другой HGS как отработку отказа.</li></ol>Кроме того, необходимо создать резервную копию каждой HGS, экспортировав ее конфигурацию, чтобы всегда можно было выполнить восстановление локально. Дополнительные сведения см. в разделе [Export-хгссерверстате](https://docs.microsoft.com/powershell/module/hgsserver/export-hgsserverstate) и [Import-хгссерверстате](https://docs.microsoft.com/powershell/module/hgsserver/import-hgsserverstate). |
| Ключи службы защитника узлов | Служба защиты узла использует две пары асимметричных ключей — ключ шифрования и ключ подписывания — каждый из них представляется SSL-сертификатом. Существует два варианта создания этих ключей.<br><ol><li>Внутренний центр сертификации — вы можете создавать эти ключи с помощью внутренней инфраструктуры PKI. Это подходит для среды центра обработки данных.</li><li>Общедоступные доверенные центры сертификации — используйте набор ключей, полученных от общедоступного доверенного центра сертификации. Это параметр, который должен использовать поставщик услуг размещения.</li></ol>Обратите внимание, что хотя можно использовать самозаверяющие сертификаты, не рекомендуется для сценариев развертывания, отличных от экспериментов.<br><br>Помимо ключей HGS, поставщик услуг размещения может использовать "присвоить свой собственный ключ", где клиенты могут предоставлять собственные ключи, чтобы некоторые (или все) клиенты могли иметь свой собственный ключ HGS. Этот параметр подходит для поставщиков услуг размещения, которые могут предоставить клиентам нестандартный процесс отправки ключей. |
| Хранилище ключей службы защиты узла | Для обеспечения наибольшей безопасности рекомендуется создавать ключи HGS и хранить их исключительно в аппаратном модуле безопасности (HSM). Если вы не используете HSM, настоятельно рекомендуется применять BitLocker на серверах HGS. |

## <a name="fabric-admin-planning-for-guarded-hosts"></a>Планирование администрирования структуры для защищенных узлов

| Область | Подробности |
|------|---------|
| Оборудование | <ul><li>Аттестация ключа узла: Можно использовать любое существующее оборудование в качестве защищенного узла. Существует несколько исключений (чтобы узел мог использовать новые механизмы безопасности, начиная с Windows Server 2016. см. раздел [совместимое оборудование с защитой целостности кода на основе виртуализации в Windows server 2016](guarded-fabric-compatible-hardware-with-virtualization-based-protection-of-code-integrity.md).</li><li>Аттестация, доверенная доверенным платформенным модулем: Можно использовать любое оборудование с [дополнительным квалификатором Hardware Assurance](https://msdn.microsoft.com/windows/hardware/commercialize/design/compatibility/systems#system-server-assurance) , если оно настроено соответствующим образом (см. раздел [конфигурации серверов, совместимые с экранированными виртуальными машинами и защита целостности кода на основе виртуализации.) ](guarded-fabric-compatible-hardware-with-virtualization-based-protection-of-code-integrity.md)для конкретной конфигурации). Сюда входит TPM 2,0 и UEFI версии 2.3.1 c и более поздних версий.</li></ul> |
| OS | Для ОС узла Hyper-V рекомендуется использовать параметр Server Core. |
| Влияние на производительность | Основываясь на тестировании производительности, мы планируем приблизительно 5% разницы между работающими экранированными виртуальными машинами и неэкранированными виртуальными машинами. Это означает, что если на данном узле Hyper-V может работать 20 неэкранированных виртуальных машин, то предполагается, что он может запускать 19 экранированных виртуальных машин.<br><br>Обязательно проверьте размер с учетом типичных рабочих нагрузок. Например, могут возникнуть некоторые выбросы с интенсивными рабочими нагрузками ввода-вывода, которые будут дополнительно влиять на разницу в плотности. |
| Рекомендации для филиалов | Начиная с Windows Server версии 1709, можно указать резервный URL-адрес для виртуализированного сервера HGS, работающего локально в качестве экранированной виртуальной машины в филиале. Резервный URL-адрес можно использовать, когда филиал теряет подключение к серверам HGS в центре обработки данных. В предыдущих версиях Windows Server узел Hyper-V, работающий в филиале, должен иметь возможность подключения к службе защиты узла для включения или динамической миграции экранированных виртуальных машин. Дополнительные сведения см. в разделе [рекомендации филиала](guarded-fabric-manage-branch-office.md). |
