---
title: Управление службой защиты узла
ms.custom: na
ms.prod: windows-server
ms.topic: article
ms.assetid: eecb002e-6ae5-4075-9a83-2bbcee2a891c
manager: dongill
author: rpsqrd
ms.technology: security-guarded-fabric
ms.openlocfilehash: 41912c90beacbb0c0c285ea4da8305c1afdf2a51
ms.sourcegitcommit: 6aff3d88ff22ea141a6ea6572a5ad8dd6321f199
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/27/2019
ms.locfileid: "71386541"
---
# <a name="managing-the-host-guardian-service"></a>Управление службой защиты узла

> Область применения: Windows Server 2019, Windows Server (половина ежегодного канала), Windows Server 2016

Служба защиты узла (HGS) — это стать центральным элементом решения защищенной структуры.
Он отвечает за обеспечение того, что узлы Hyper-V в структуре известны поставщику услуг размещения или корпоративному и работающему доверенному программному обеспечению, а также управление ключами, используемыми для запуска экранированных виртуальных машин.
Когда клиент решает, что вы хотите разместить экранированные виртуальные машины, они помещают доверие в конфигурацию и управление службой защиты узла.
Поэтому очень важно следовать рекомендациям по управлению службой защиты узла, чтобы обеспечить безопасность, доступность и надежность защищенной структуры.
В следующих разделах приведены рекомендации по наиболее распространенным проблемам эксплуатации, направленным администраторам HGS.

## <a name="limiting-admin-access-to-hgs"></a>Ограничение административного доступа к HGS
Из-за особенностей безопасности HGS важно убедиться, что ее Администраторы являются надежными членами вашей организации и, в идеале, отделены от администраторов ресурсов структуры.
Кроме того, рекомендуется управлять HGS только с защищенных рабочих станций с помощью протоколов защищенного обмена данными, таких как WinRM через HTTPS.

### <a name="separation-of-duties"></a>Разделение обязанностей
При настройке HGS вы можете создать изолированный Active Directory лес только для HGS или присоединить HGS к существующему доверенному домену.
Это решение, а также роли, назначенные администраторам в Организации, определяют границы доверия для HGS.
Кто-то имеет доступ к HGS, будь то непосредственно администратор или косвенно, как администратор другого (например, Active Directory), который может повлиять на HGS, имеет контроль над защищенной структурой.
Администраторы HGS выбирают, какие узлы Hyper-V имеют право запускать экранированные виртуальные машины, и управлять сертификатами, необходимыми для запуска экранированных виртуальных машин.
Злоумышленник или злоумышленник, у которого есть доступ к службе HGS, может использовать эту возможность для авторизации скомпрометированных узлов для запуска экранированных виртуальных машин, инициации атаки типа "отказ в обслуживании" путем удаления материала ключа и многого другого.

Чтобы избежать этого риска, *настоятельно* рекомендуется ограничить перекрытие между администраторами HGS (включая домен, к которому присоединена служба HGS) и средами Hyper-V.
Убедившись, что ни один администратор не имеет доступа к обеим системам, злоумышленнику придется нарушить 2 разных учетных записей от 2 лиц, чтобы завершить свою деятельность по изменению политик HGS.
Это также означает, что администраторы домена и предприятия для двух Active Directoryных сред не должны быть одним человеком и не должны использовать тот же Active Directory лес, что и узлы Hyper-V.
Любой, кто может предоставить себе доступ к большему ресурсу, представляет угрозу безопасности.

### <a name="using-just-enough-administration"></a>Использование достаточного администрирования
HGS поставляется с [достаточной ролью администрирования](https://aka.ms/JEAdocs) (JEA), встроенной в, что позволяет более безопасно управлять ею.
JEA позволяет делегировать административные задачи пользователям, не являющимся администраторами, а значит, пользователи, управляющие политиками HGS, не должны быть администраторами всего компьютера или домена.
JEA работает, ограничивая, какие команды пользователь может запускать в сеансе PowerShell и использовать временную локальную учетную запись в фоновом режиме (уникально для каждого сеанса пользователя) для выполнения команд, которые обычно нуждаются в повышении прав.

Для HGS поставляется 2 роли JEA, предварительно настроенные:
- **Администраторы HGS** , которые позволяют пользователям управлять всеми политиками HGS, включая авторизацию новых узлов для запуска экранированных виртуальных машин.
- **Проверяющие HGS** , которые позволяют пользователям только проверять существующие политики. Они не могут вносить изменения в конфигурацию HGS.

Чтобы использовать JEA, необходимо сначала создать нового стандартного пользователя и сделать его членом группы "Администраторы HGS" или "Рецензенты HGS".
Если вы использовали `Install-HgsServer` для настройки нового леса для HGS, эти группы будут называться "Администраторы*ServiceName*" и "*имя_службы*проверяющими" соответственно, где *ServiceName* — это сетевое имя кластера HGS.
Если вы присоединились к существующему домену, вы должны ссылаться на имена групп, указанные в `Initialize-HgsServer`.

**Создание стандартных пользователей для ролей администратора и рецензента HGS**

```powershell
$hgsServiceName = (Get-ClusterResource HgsClusterResource | Get-ClusterParameter DnsName).Value
$adminGroup = $hgsServiceName + "Administrators"
$reviewerGroup = $hgsServiceName + "Reviewers"

New-ADUser -Name 'hgsadmin01' -AccountPassword (Read-Host -AsSecureString -Prompt 'HGS Admin Password') -ChangePasswordAtLogon $false -Enabled $true
Add-ADGroupMember -Identity $adminGroup -Members 'hgsadmin01'

New-ADUser -Name 'hgsreviewer01' -AccountPassword (Read-Host -AsSecureString -Prompt 'HGS Reviewer Password') -ChangePasswordAtLogon $false -Enabled $true
Add-ADGroupMember -Identity $reviewerGroup -Members 'hgsreviewer01'
```

**Политики аудита с ролью рецензента**

На удаленном компьютере с сетевым подключением к HGS выполните следующие команды в PowerShell, чтобы войти в сеанс JEA с учетными данными проверяющего.
Важно отметить, что так как учетная запись проверяющего является только обычным пользователем, ее нельзя использовать для обычного удаленного взаимодействия Windows PowerShell, удаленный рабочий стол доступ к HGS и т. д.

```powershell
Enter-PSSession -ComputerName <hgsnode> -Credential '<hgsdomain>\hgsreviewer01' -ConfigurationName 'microsoft.windows.hgs'
```

Затем можно проверить, какие команды разрешены в сеансе с `Get-Command` и выполнить все разрешенные команды для аудита конфигурации.
В приведенном ниже примере мы проверяя, какие политики включены в HGS.

```powershell
Get-Command

Get-HgsAttestationPolicy
```

Введите команду `Exit-PSSession` или ее псевдоним `exit`, когда вы завершите работу с сеансом JEA. 

**Добавление новой политики в HGS с помощью роли администратора**

Для фактического изменения политики необходимо подключиться к конечной точке JEA с удостоверением, принадлежащим группе "Хгсадминистраторс".
В приведенном ниже примере показано, как можно скопировать новую политику целостности кода в HGS и зарегистрировать ее с помощью JEA.
Синтаксис может отличаться от используемого для.
Это необходимо для реализации некоторых ограничений в JEA, таких как отсутствие доступа к полной файловой системе.

```powershell
$cipolicy = Get-Item "C:\temp\cipolicy.p7b"
$session = New-PSSession -ComputerName <hgsnode> -Credential '<hgsdomain>\hgsadmin01' -ConfigurationName 'microsoft.windows.hgs'
Copy-Item -Path $cipolicy -Destination 'User:' -ToSession $session

# Now that the file is copied, we enter the interactive session to register it with HGS
Enter-PSSession -Session $session
Add-HgsAttestationCiPolicy -Name 'New CI Policy via JEA' -Path 'User:\cipolicy.p7b'

# Confirm it was added successfully
Get-HgsAttestationPolicy -PolicyType CiPolicy

# Finally, remove the PSSession since it is no longer needed
Exit-PSSession
Remove-PSSession -Session $session
```

## <a name="monitoring-hgs"></a>Мониторинг HGS
### <a name="event-sources-and-forwarding"></a>Источники событий и пересылка
События из HGS будут отображаться в журнале событий Windows в 2 источниках:
- **HostGuardianService-аттестация**
- **HostGuardianService-Кэйпротектион**

Эти события можно просмотреть, открыв Просмотр событий и перейдя в Microsoft-Windows-HostGuardianService-аттестацию и Microsoft-Windows-HostGuardianService-Кэйпротектион.

В больших средах часто предпочтительнее перенаправлять события в Центральный сборщик событий Windows, чтобы упростить анализ событий.
Дополнительные сведения см. в [документации по пересылке событий Windows](https://msdn.microsoft.com/library/windows/desktop/bb427443.aspx).

### <a name="using-system-center-operations-manager"></a>Использование System Center Operations Manager
Вы также можете использовать System Center 2016-Operations Manager для мониторинга HGS и защищенных узлов.
Пакет управления защищенной структурой содержит мониторы событий для проверки распространенных ошибок конфигурации, которые могут привести к простою центра обработки данных, включая узлы, не передающие аттестацию и серверы HGS, сообщают об ошибках.

Чтобы приступить к работе, [установите и настройте SCOM 2016](https://technet.microsoft.com/system-center-docs/om/welcome-to-operations-manager) и [скачайте пакет управления защищенной структурой](https://www.microsoft.com/download/details.aspx?id=52764).
В прилагаемом разделе руководства по пакету управления объясняется, как настроить пакет управления и понять область его мониторов.

## <a name="backing-up-and-restoring-hgs"></a>Резервное копирование и восстановление HGS
### <a name="disaster-recovery-planning"></a>Планирование аварийного восстановления
При разработке планов аварийного восстановления важно учитывать уникальные требования службы защиты узла в защищенной структуре.
Если вы потеряли некоторые или все узлы HGS, вы можете столкнуться с проблемами немедленной доступности, которые не позволят пользователям запускать экранированные виртуальные машины.
В случае утери всего кластера HGS вам потребуется выполнить полное резервное копирование конфигурации HGS, чтобы восстановить кластер HGS и возобновить нормальные операции.
В этом разделе описаны шаги, необходимые для подготовки к такому сценарию.

Во-первых, важно понимать, что насчет HGS важно для резервного копирования.
HGS хранит несколько частей информации, которые помогают определить, какие узлы имеют право на выполнение экранированных виртуальных машин.
Сюда входят следующие возможности.
1. Active Directory идентификаторы безопасности для групп, содержащих доверенные узлы (при использовании Active Directory аттестации);
2. Уникальные идентификаторы доверенного платформенного модуля для каждого узла в вашей среде;
3. Политики TPM для каждой уникальной конфигурации узла; перетаскивани
4. Политики целостности кода, определяющие, какое программное обеспечение разрешено запускать на узлах.

Эти артефакты аттестации должны быть согласованы с администраторами вашей структуры размещения, что потенциально затрудняет получение этих сведений после аварии.

Кроме того, службе HGS требуется доступ к 2 или более сертификатам, используемым для шифрования и подписи сведений, необходимых для запуска экранированной виртуальной машины (предохранитель ключа).
Эти сертификаты хорошо известны (используются владельцами экранированных виртуальных машин для авторизации вашей структуры для выполнения виртуальных машин) и должны быть восстановлены после аварии для беспрепятственного процесса восстановления.
Если вы не восстанавливаете HGS с теми же сертификатами после аварии, потребуется обновить каждую виртуальную машину, чтобы авторизовать новые ключи для расшифровки своих данных.
По соображениям безопасности только владелец виртуальной машины может обновить конфигурацию виртуальной машины, чтобы авторизовать эти новые ключи. Это означает, что при восстановлении ключей после аварии каждый владелец виртуальной машины должен будет предпринять действия для повторного запуска виртуальных машин.

#### <a name="preparing-for-the-worst"></a>Подготовка к худшему
Чтобы подготовиться к полной утрате HGS, необходимо выполнить два шага:
1. Резервное копирование политик аттестации HGS
2. Резервное копирование ключей HGS

Инструкции по выполнению обоих действий приведены в разделе [резервное копирование HGS](#backing-up-hgs) .

Кроме того, рекомендуется, но не обязательно, создать резервную копию списка пользователей, которым разрешено управлять HGS в домене Active Directory или Active Directory.

Необходимо регулярно создавать резервные копии, чтобы убедиться, что информация актуальна и надежно сохранена во избежание несанкционированного изменения или кражи.

**Не рекомендуется** выполнять резервное копирование или восстановление всего образа системы узла HGS.
В случае утери всего кластера лучше всего настроить новый узел HGS и восстановить только состояние HGS, а не всю серверную ОС.

#### <a name="recovering-from-the-loss-of-one-node"></a>Восстановление после потери одного узла
Если вы потеряли один или несколько узлов (но не всех узлов) в кластере HGS, вы можете просто [Добавить узлы в кластер](guarded-fabric-configure-additional-hgs-nodes.md) , следуя указаниям в руководстве по развертыванию.
Политики аттестации будут синхронизироваться автоматически, как и все сертификаты, предоставленные для HGS в качестве PFX-файлов с соответствующими паролями.
Для сертификатов, добавляемых в HGS с помощью отпечатка (обычно неэкспортируемые и аппаратно не поддерживающие сертификаты), необходимо убедиться, что каждый новый узел имеет доступ к закрытому ключу каждого сертификата.

#### <a name="recovering-from-the-loss-of-the-entire-cluster"></a>Восстановление после потери всего кластера
Если весь кластер HGS выйдет из строя и вы не сможете перевести его обратно в режим «в сети», необходимо будет восстановить HGS из резервной копии.
Восстановление HGS из резервной копии включает в себя сначала настройку нового кластера HGS в соответствии с [инструкциями руководства по развертыванию](guarded-fabric-setting-up-the-host-guardian-service-hgs.md).
Настоятельно рекомендуется, но не требуется, использовать одно и то же имя кластера при настройке среды восстановления HGS для помощи с разрешением имен с узлов.
Использование одного и того же имени позволяет избежать необходимости перенастройки узлов с новыми URL-адресами аттестации и защиты ключей.
При восстановлении объектов в Active Directory резервной копии домена рекомендуется удалить объекты, представляющие кластер HGS, компьютеры, учетную запись службы и группы JEA, перед инициализацией сервера HGS.

После настройки первого узла HGS (например, его установки и инициализации) необходимо выполнить процедуры, описанные в разделе [Восстановление HGS из резервной копии](#restoring-hgs-from-a-backup) , чтобы восстановить политики аттестации и общедоступные половины сертификатов защиты ключей.
Вам потребуется восстановить закрытые ключи сертификатов вручную в соответствии с руководством поставщика сертификатов (например, импортировать сертификат в Windows или настроить доступ к сертификатам с поддержкой HSM).
После настройки первого узла можно продолжить [установку дополнительных узлов в кластер](guarded-fabric-configure-additional-hgs-nodes.md) до достижения требуемой емкости и устойчивости.

### <a name="backing-up-hgs"></a>Резервное копирование HGS
Администратор HGS должен регулярно отвечать за резервное копирование HGS.
Полная резервная копия будет содержать конфиденциальный материал ключа, который должен быть соответствующим образом защищен.
Если ненадежная сущность получает доступ к этим ключам, они могут использовать этот материал для настройки вредоносной среды HGS с целью компрометации экранированных виртуальных машин.

**Резервное копирование политик аттестации** Чтобы создать резервную копию политик аттестации HGS, выполните следующую команду на любом рабочем узле сервера HGS.
Вам будет предложено ввести пароль.
Этот пароль используется для шифрования всех сертификатов, добавленных в HGS с помощью PFX-файла (вместо отпечатка сертификата).

```powershell
Export-HgsServerState -Path C:\temp\HGSBackup.xml
```

> [!NOTE]
> При использовании аттестации, доверенной для администраторов, необходимо отдельно выполнить резервное копирование членства в группах безопасности, используемых службой HGS, для авторизации защищенных узлов.
> HGS будет архивировать только идентификатор безопасности групп безопасности, а не членство в них.
> В случае потери этих групп во время аварии необходимо повторно создать группы и снова добавить в них все защищенные узлы.

**Резервное копирование сертификатов**

Команда `Export-HgsServerState` выполняет резервное копирование сертификатов на основе PFX, добавленных в HGS во время выполнения команды.
Если вы добавили сертификаты в HGS с помощью отпечатка (обычно для неэкспортируемых и аппаратно-защищенных сертификатов), вам потребуется вручную создать резервную копию закрытых ключей для сертификатов.
Чтобы указать, какие сертификаты регистрируются в службе HGS и нужно создать резервную копию вручную, выполните следующую команду PowerShell на любом рабочем узле сервера HGS.

```powershell
Get-HgsKeyProtectionCertificate | Where-Object { $_.CertificateData.GetType().Name -eq 'CertificateReference' } | Format-Table Thumbprint, @{ Label = 'Subject'; Expression = { $_.CertificateData.Certificate.Subject } }
```

Для каждого из перечисленных сертификатов потребуется вручную создать резервную копию закрытого ключа.
Если вы используете программный сертификат, который не является экспортируемым, обратитесь в центр сертификации, чтобы убедиться, что у него есть резервная копия сертификата, и (или) повторите его по требованию.
Для сертификатов, созданных и хранящихся в аппаратных модулях безопасности, следует обратиться к документации по устройству, чтобы получить рекомендации по планированию аварийного восстановления.

Вы должны хранить резервные копии сертификатов вместе с резервными копиями политики аттестации в безопасном месте, чтобы обе части можно было восстановить вместе.

**Дополнительная настройка для резервного копирования**

Состояние резервного копирования сервера HGS не будет включать имя кластера HGS, любые сведения из Active Directory или SSL-сертификаты, используемые для защиты обмена данными с интерфейсами API HGS.
Эти параметры важны для согласованности, но не для критически важных, чтобы вернуть кластер HGS в оперативный режим после аварии.

Чтобы записать имя службы HGS, запустите `Get-HgsServer` и обратите внимание на неструктурированное имя в URL-адресах аттестации и защиты ключей.
Например, если URL-адрес аттестации — "<http://hgs.contoso.com/Attestation>", то HGS — это имя службы HGS.

Домен Active Directory, используемый службой HGS, должен управляться так же, как и любой другой домен Active Directory.
При восстановлении HGS после аварии вам не потребуется повторно создавать точные объекты, существующие в текущем домене.
Тем не менее, если вы создаете резервную копию Active Directory и сохраняете список пользователей JEA, авторизованных для управления системой, а также членство в группах безопасности, используемых доверенной аттестацией, для авторизации защищенных узлов.

Чтобы узнать отпечаток SSL-сертификатов, настроенных для HGS, выполните следующую команду в PowerShell.
Затем можно создать резервную копию этих SSL-сертификатов в соответствии с инструкциями поставщика сертификата.

```powershell
Get-WebBinding -Protocol https | Select-Object certificateHash
```

### <a name="restoring-hgs-from-a-backup"></a>Восстановление HGS из резервной копии
Ниже описаны действия по восстановлению параметров HGS из резервной копии.
Эти действия относятся к обеим ситуациям, в которых вы пытаетесь отменить изменения, внесенные в уже запущенные экземпляры HGS, а также при создании нового кластера HGS после полной потери предыдущего.

#### <a name="set-up-a-replacement-hgs-cluster"></a>Настройка замены кластера HGS
Перед восстановлением HGS необходимо иметь инициализированный кластер HGS, в котором можно восстановить конфигурацию.
Если вы просто импортируете параметры, которые были случайно удалены в существующем (запущенном) кластере, этот шаг можно пропустить.
При восстановлении после полной потери HGS необходимо установить и инициализировать по крайней мере один узел HGS, следуя [указаниям в руководстве по развертыванию](guarded-fabric-setting-up-the-host-guardian-service-hgs.md).

В частности, потребуется:
1. [Настройка домена HGS](guarded-fabric-choose-where-to-install-hgs.md) или присоединение HGS к существующему домену
2. [Инициализируйте сервер HGS](guarded-fabric-initialize-hgs.md) с помощью существующих ключей *или* набора временных ключей. [Временные ключи можно удалить](#renewing-or-replacing-keys) после импорта фактических ключей из файлов резервной копии HGS.
3. [Импорт параметров HGS](#import-settings-from-a-backup) из резервной копии для восстановления доверенных групп узлов, политик целостности кода, базовых показателей TPM и ИДЕНТИФИКАТОРов TPM

> [!TIP]
> Новому кластеру HGS не нужно использовать те же сертификаты, имя службы или домен, что и экземпляр HGS, из которого был экспортирован файл резервной копии.

#### <a name="import-settings-from-a-backup"></a>Импорт параметров из резервной копии

Чтобы восстановить политики аттестации, сертификаты на основе PFX и открытые ключи сертификатов, отличных от PFX, в узел HGS из файла резервной копии, выполните следующую команду на инициализированном узле сервера HGS.
Вам будет предложено ввести пароль, указанный при создании резервной копии.

```powershell
Import-HgsServerState -Path C:\Temp\HGSBackup.xml
```

Если вы хотите импортировать политики аттестации, доверенные для администраторов, или политики аттестации доверенного платформенного модуля, это можно сделать, указав `-ImportActiveDirectoryModeState` или `-ImportTpmModeState` флаги для [Import-хгссерверстате](https://technet.microsoft.com/library/mt652168.aspx).

Перед запуском `Import-HgsServerState`убедитесь, что установлено последнее накопительное обновление для Windows Server 2016.
Несоблюдение этого действия может привести к ошибке импорта.

> [!NOTE]
> При восстановлении политик на существующем узле HGS, на котором уже установлена одна или несколько политик, команда импорта отобразит ошибку для каждой повторяющейся политики.
> Это ожидаемое поведение, которое можно спокойно игнорировать в большинстве случаев.

#### <a name="reinstall-private-keys-for-certificates"></a>Переустановить закрытые ключи для сертификатов
Если какие бы то ни было сертификаты, используемые в HGS, из которой была создана резервная копия, были добавлены с помощью отпечатков, в файл резервной копии будут включены только открытые ключи этих сертификатов.
Это означает, что вам потребуется вручную установить и (или) предоставить доступ к закрытым ключам для каждого из этих сертификатов, прежде чем служба HGS сможет обслуживать запросы от узлов Hyper-V.
Действия, необходимые для выполнения этого шага, зависят от того, как был первоначально выдан сертификат.
Для сертификатов с программным обеспечением, выданных центром сертификации, необходимо обратиться к центру сертификации, чтобы получить закрытый ключ и установить его на **каждом** узле HGS в соответствии с инструкциями.
Аналогично, если ваши сертификаты являются аппаратно-защищенными, необходимо обратиться к документации поставщика аппаратного модуля безопасности, чтобы установить необходимые драйверы на каждом узле HGS для подключения к HSM-модулю и предоставить каждому компьютеру доступ к закрытому ключу.

В качестве напоминания сертификатам, добавленным в HGS с помощью отпечатков, требуется ручная репликация закрытых ключей на каждый узел.
Этот шаг потребуется повторить для каждого дополнительного узла, добавляемого в восстановленный кластер HGS.

#### <a name="review-imported-attestation-policies"></a>Проверка импортированных политик аттестации
После импорта параметров из резервной копии рекомендуется внимательно проверить все импортированные политики с помощью `Get-HgsAttestationPolicy`, чтобы убедиться, что только узлы, которым вы доверяете, для запуска экранированных виртуальных машин смогут успешно пройти аттестацию.
Если вы нашли политики, которые больше не соответствуют уровням безопасности, их можно [отключить или удалить](#review-attestation-policies).

#### <a name="run-diagnostics-to-check-system-state"></a>Запуск диагностики для проверки состояния системы
После завершения настройки и восстановления состояния узла HGS следует запустить средство диагностики HGS, чтобы проверить состояние системы.
Для этого выполните следующую команду в узле HGS, где была восстановлена конфигурация:

```powershell
Get-HgsTrace -RunDiagnostics
```

Если "общий результат" не равен "Pass", для завершения настройки системы требуются дополнительные действия.
Проверьте сообщения, о которых произошли ошибки во всех подтестах, для которых не удалось получить дополнительные сведения.

## <a name="patching-hgs"></a>Исправление HGS
Важно обновлять узлы службы защиты узлов, устанавливая Последнее накопительное обновление. При настройке нового узла HGS настоятельно рекомендуется установить все доступные обновления перед установкой роли HGS или ее настройкой.
Это гарантирует, что новые или измененные функции вступят в силу немедленно.

При установке исправлений для защищенной структуры настоятельно рекомендуется сначала обновить *все* узлы Hyper-V **перед обновлением HGS**.
Это необходимо для того, чтобы все изменения политик аттестации в HGS выполнялись *после* обновления узлов Hyper-V, чтобы предоставить необходимые для них сведения.
Если обновление изменяет поведение политик, они не будут автоматически включены во избежание нарушения работы структуры.
Для таких обновлений необходимо следовать инструкциям, приведенным в следующем разделе, чтобы активировать новые или измененные политики аттестации.
Мы рекомендуем ознакомиться с заметками о выпуске Windows Server и всеми установленными накопительными обновлениями, чтобы проверить, требуются ли обновления политики.

### <a name="updates-requiring-policy-activation"></a>Обновления, для которых необходима активация политики
Если обновление для HGS вводит или значительно изменяет поведение политики аттестации, для активации измененной политики требуется дополнительный шаг.
Изменения политики вносятся только после экспорта и импорта состояния HGS.
Новые или измененные политики следует активировать только после применения накопительного обновления ко всем узлам и всем узлам HGS в вашей среде.
После обновления каждого компьютера выполните следующие команды в любом узле HGS, чтобы активировать процесс обновления:

```powershell
$password = Read-Host -AsSecureString -Prompt "Enter a temporary password"
Export-HgsServerState -Path .\temporaryExport.xml -Password $password
Import-HgsServerState -Path .\temporaryExport.xml -Password $password
```

Если новая политика была введена, по умолчанию она будет отключена.
Чтобы включить новую политику, сначала найдите ее в списке политик Майкрософт (с префиксом "HGS_"), а затем включите ее, выполнив следующие команды:

```powershell
Get-HgsAttestationPolicy

Enable-HgsAttestationPolicy -Name <Hgs_NewPolicyName>
```

## <a name="managing-attestation-policies"></a>Управление политиками аттестации
В службе HGS поддерживается несколько политик аттестации, которые определяют минимальный набор требований, которым должен соответствовать узел, чтобы считаться "работоспособным" и разрешенным запускать экранированные виртуальные машины.
Некоторые из этих политик определяются корпорацией Майкрософт, а другие добавляются, чтобы определить допустимые политики целостности кода, базовые показатели TPM и узлы в вашей среде.
Регулярное обслуживание этих политик необходимо для обеспечения правильной аттестации узлов при их обновлении и замене, а также для обеспечения блокирования успешной аттестации любых ненадежных узлов или конфигураций.

Для аттестации, доверенной администратором, существует только одна политика, определяющая работоспособность узла: членство в известной доверенной группе безопасности.
Аттестация TPM более сложная и включает различные политики для измерения кода и конфигурации системы перед определением работоспособности.

Единую службу HGS можно настроить одновременно с политиками Active Directory и TPM, но служба будет проверять только политики для текущего режима, для которых она настроена, когда узел пытается выполнить аттестацию.
Чтобы проверить режим работы сервера HGS, запустите `Get-HgsServer`.

### <a name="default-policies"></a>Политики по умолчанию
Для аттестации, доверенной для доверенного платформенного модуля, в HGS настроено несколько встроенных политик.
Некоторые из этих политик заблокированы — это означает, что их нельзя отключить по соображениям безопасности.
В таблице ниже объясняется назначение каждой политики по умолчанию.

Имя политики                    | Описание
-------------------------------|-----------------------------------------------------
Hgs_SecureBootEnabled          | Требует включения безопасной загрузки для узлов. Это необходимо для измерения двоичных файлов запуска и других параметров, заблокированных UEFI.
Hgs_UefiDebugDisabled          | Проверяет, что на узлах не включен отладчик ядра. Отладчики пользовательского режима блокируются с помощью политик целостности кода.
Hgs_SecureBootSettings         | Отрицательная политика для обеспечения соответствия узлов по крайней мере одному (определяемому администратором) базовому модулю TPM.
Hgs_CiPolicy                   | Отрицательная политика для того, чтобы узлы использовали одну из политик CI, определенных администратором.
Hgs_HypervisorEnforcedCiPolicy | Требует, чтобы политика целостности кода была принудительно применена гипервизором. Отключение этой политики ослабляет защиту от атак с политикой целостности кода в режиме ядра.
Hgs_FullBoot                   | Гарантирует, что узел не возобновит работу из спящего режима или режима гибернации. Для передачи этой политики узлы должны быть правильно перезапущены или завершены.
Hgs_VsmIdkPresent              | Требуется, чтобы на узле была запущена система безопасности на основе виртуализации. ИДК представляет ключ, необходимый для шифрования данных, отправляемых обратно в область памяти узла.
Hgs_PageFileEncryptionEnabled  | Требует, чтобы файлов подкачки был зашифрован на узле. Отключение этой политики может привести к раскрытию информации, если для секретов клиента выполняется проверка незашифрованного файла подкачки.
Hgs_BitLockerEnabled           | Требуется включить BitLocker на узле Hyper-V. По соображениям производительности эта политика отключена по умолчанию, поэтому ее не рекомендуется включать. Эта политика не влияет на шифрование экранированных виртуальных машин.
Hgs_IommuEnabled               | Требует, чтобы на узле использовалось устройство IOMMU для предотвращения атак прямого доступа к памяти. Отключение этой политики и использование узлов без включенной функции IOMMU могут предоставлять секреты виртуальных машин клиента для прямого проникновения в память.
Hgs_NoHibernation              | Требуется отключить режим гибернации на узле Hyper-V. Отключение этой политики может позволить узлам сохранять экранированную память виртуальной машины в незашифрованный файл гибернации.
Hgs_NoDumps                    | Требуется отключить дампы памяти на узле Hyper-V. Если эта политика отключена, рекомендуется настроить шифрование дампа, чтобы предотвратить сохранение экранированной памяти виртуальной машины в незашифрованные файлы аварийного дампа.
Hgs_DumpEncryption             | Требуются дампы памяти, если они включены на узле Hyper-V, которые должны быть зашифрованы с помощью ключа шифрования, доверенного для HGS. Эта политика не применяется, если на узле не включены дампы. Если эта политика и *Hgs\_* недоступны, память ЭКРАНИРОВАННОЙ виртуальной машины может быть сохранена в незашифрованном файле дампа.
Hgs_DumpEncryptionKey          | Отрицательная политика, чтобы убедиться, что узлы, настроенные на разрешение дампов памяти, используют определенный администратором ключ шифрования файла дампа, известный для HGS. Эта политика не применяется, если *думпенкриптиона Hgs\_* отключена.

### <a name="authorizing-new-guarded-hosts"></a>Авторизация новых защищенных узлов
Чтобы авторизовать новый узел в качестве защищенного узла (например, аттестация успешно), HGS должен доверять узлу и (если настроено использовать аттестацию, доверенную доверенным платформенным модулем) программное обеспечение, запущенное на нем.
Действия по авторизации нового узла зависят от режима аттестации, для которого в настоящее время настроена HGS.
Чтобы проверить режим аттестации для защищенной структуры, запустите `Get-HgsServer` на любом узле HGS.

#### <a name="software-configuration"></a>Конфигурация программного обеспечения
На новом узле Hyper-V убедитесь, что установлен Windows Server 2016 Datacenter Edition.
Windows Server 2016 Standard не может запускать экранированные виртуальные машины в защищенной структуре.
Узел может быть установлен на рабочем столе или Server Core.

На сервере с возможностями рабочего стола и Server Core необходимо установить Hyper-V и службу защиты узла Hyper-V, поддерживающую роли сервера:

```powershell
Install-WindowsFeature Hyper-V, HostGuardian -IncludeManagementTools -Restart
```

#### <a name="admin-trusted-attestation"></a>Аттестация, доверенная администратором
Чтобы зарегистрировать новый узел в HGS при использовании аттестации, доверенной для администраторов, необходимо сначала добавить узел в группу безопасности в домене, к которому он присоединен.
Как правило, каждый домен будет иметь одну группу безопасности для защищенных узлов.
Если вы уже зарегистрировали эту группу с помощью HGS, единственное действие, которое необходимо выполнить, — перезапустить узел, чтобы обновить его членство в группе.

Вы можете проверить, какие группы безопасности являются доверенными для HGS, выполнив следующую команду:

```powershell
Get-HgsAttestationHostGroup
```

Чтобы зарегистрировать новую группу безопасности с помощью HGS, сначала необходимо записать идентификатор безопасности (SID) группы в домене узла и зарегистрировать идентификатор SID в HGS.

```powershell
Add-HgsAttestationHostGroup -Name "Contoso Guarded Hosts" -Identifier "S-1-5-21-3623811015-3361044348-30300820-1013"
```

Инструкции по настройке отношения доверия между доменом узла и HGS доступны в разделе Руководство по развертыванию.

#### <a name="tpm-trusted-attestation"></a>Аттестация, доверенная доверенным платформенным модулем
Если в режиме TPM настроена HGS, узлы должны передавать все политики блокировки и "включенные" политики с префиксом "Hgs_", а также по крайней мере один базовый модуль TPM, идентификатор TPM и политику целостности кода.
Каждый раз при добавлении нового узла необходимо зарегистрировать новый идентификатор TPM в HGS.
Пока на узле выполняется одно и то же программное обеспечение (и применяется та же политика целостности кода) и базовый модуль TPM, как и другой узел в вашей среде, вам не нужно добавлять новые политики CI или базовые шаблоны.

**Добавление идентификатора доверенного платформенного модуля для нового узла** На новом узле выполните следующую команду, чтобы записать идентификатор доверенного платформенного модуля.
Не забудьте указать уникальное имя узла, который поможет вам найти его в HGS.
Эти сведения понадобятся при списании узла или при необходимости предотвратить запуск экранированных виртуальных машин в HGS.

```powershell
(Get-PlatformIdentifier -Name "Host01").InnerXml | Out-File C:\temp\host01.xml -Encoding UTF8
```

Скопируйте этот файл на сервер HGS, а затем выполните следующую команду, чтобы зарегистрировать узел в HGS.

```powershell
Add-HgsAttestationTpmHost -Name 'Host01' -Path C:\temp\host01.xml
```

**Добавление нового базового модуля TPM** Если на новом узле выполняется новая конфигурация оборудования или микропрограммы для вашей среды, может потребоваться создать новый базовый уровень доверенного платформенного модуля.
Для этого выполните следующую команду на узле.

```powershell
Get-HgsAttestationBaselinePolicy -Path 'C:\temp\hardwareConfig01.tcglog'
```

> [!NOTE]
> Если появится сообщение об ошибке, сообщающее, что узел не прошел проверку и не будет успешно подтвержден, не беспокойтесь.
> Это проверка готовности к установке, чтобы убедиться, что узел может запускать экранированные виртуальные машины и, скорее всего, не применил политику целостности кода или другие необходимые параметры.
> Прочтите сообщение об ошибке, внесите предлагаемые изменения и повторите попытку.
> Кроме того, вы можете пропустить проверку в это время, добавив флаг `-SkipValidation` в команду.

Скопируйте базовый уровень доверенного платформенного модуля на сервер HGS, а затем зарегистрируйте его с помощью следующей команды.
Мы рекомендуем использовать соглашение об именовании, помогающее понять конфигурацию оборудования и встроенного по этого класса узла Hyper-V.

```powershell
Add-HgsAttestationTpmPolicy -Name 'HardwareConfig01' -Path 'C:\temp\hardwareConfig01.tcglog'
```

**Добавление новой политики целостности кода** Если вы изменили политику целостности кода, запущенную на узлах Hyper-V, необходимо зарегистрировать новую политику в HGS, прежде чем эти узлы смогут успешно пройти аттестацию.
На узле-образце, который служит в качестве главного образа для доверенных компьютеров Hyper-V в вашей среде, запишите новую политику CI с помощью команды `New-CIPolicy`.
Мы рекомендуем использовать уровень **филепублишер** и откат **ХЭША** для политик CI узла Hyper-V.
Сначала необходимо создать политику CI в режиме аудита, чтобы убедиться, что все работает правильно.
После проверки рабочей нагрузки в системе можно применить политику и скопировать принудительную версию в HGS.
Полный список параметров конфигурации политики целостности кода см. в [документации по Device Guard](https://technet.microsoft.com/itpro/windows/keep-secure/deploy-device-guard-deploy-code-integrity-policies).

```powershell
# Capture a new CI policy with the FilePublisher primary level and Hash fallback and enable user mode code integrity protections
New-CIPolicy -FilePath 'C:\temp\ws2016-hardware01-ci.xml' -Level FilePublisher -Fallback Hash -UserPEs

# Apply the CI policy to the system
ConvertFrom-CIPolicy -XmlFilePath 'C:\temp\ws2016-hardware01-ci.xml' -BinaryFilePath 'C:\temp\ws2016-hardware01-ci.p7b'
Copy-Item 'C:\temp\ws2016-hardware01-ci.p7b' 'C:\Windows\System32\CodeIntegrity\SIPolicy.p7b'
Restart-Computer

# Check the event log for any untrusted binaries and update the policy if necessary
# Consult the Device Guard documentation for more details

# Change the policy to be in enforced mode
Set-RuleOption -FilePath 'C:\temp\ws2016-hardare01-ci.xml' -Option 3 -Delete

# Apply the enforced CI policy on the system
ConvertFrom-CIPolicy -XmlFilePath 'C:\temp\ws2016-hardware01-ci.xml' -BinaryFilePath 'C:\temp\ws2016-hardware01-ci.p7b'
Copy-Item 'C:\temp\ws2016-hardware01-ci.p7b' 'C:\Windows\System32\CodeIntegrity\SIPolicy.p7b'
Restart-Computer
```

После создания, тестирования и применения политики скопируйте двоичный файл (. p7b) на сервер HGS и зарегистрируйте политику.

```powershell
Add-HgsAttestationCiPolicy -Name 'WS2016-Hardware01' -Path 'C:\temp\ws2016-hardware01-ci.p7b'
```

**Добавление ключа шифрования дампа памяти**

Если политика *hgs\_-дампов* отключена и в службе *HGS\_* включена политика думпенкриптион, защищенные узлы могут иметь дампы памяти (включая аварийные дампы), чтобы их можно было включить при условии, что эти дампы зашифрованы. Защищенные узлы будут передавать аттестацию только в том случае, если они либо отключают дампы памяти, либо шифруют их с помощью ключа, известного под названием HGS. По умолчанию в HGS не настраиваются ключи шифрования дампа.

Чтобы добавить ключ шифрования дампа в HGS, используйте командлет `Add-HgsAttestationDumpPolicy`, чтобы предоставить HGS с хэшем ключа шифрования дампа.
Если вы записываете базовый модуль TPM на узле Hyper-V, на котором настроено шифрование дампа, хэш включается в ткглог и может быть предоставлен командлету `Add-HgsAttestationDumpPolicy`.

```powershell
Add-HgsAttestationDumpPolicy -Name 'DumpEncryptionKey01' -Path 'C:\temp\TpmBaselineWithDumpEncryptionKey.tcglog'
```

Кроме того, можно напрямую предоставить строковое представление хэша для командлета.

```powershell
Add-HgsAttestationDumpPolicy -Name 'DumpEncryptionKey02' -PublicKeyHash '<paste your hash here>'
```

Не забудьте добавить каждый уникальный ключ шифрования дампа в HGS, если вы решили использовать разные ключи в защищенной структуре.
Узлы, которые шифруют дампы памяти с ключом, который не известен службе HGS, не проходят аттестацию.

Дополнительные сведения о [настройке шифрования дампа на узлах](https://technet.microsoft.com/windows-server-docs/virtualization/hyper-v/manage/about-dump-encryption)см. в документации по Hyper-V.

#### <a name="check-if-the-system-passed-attestation"></a>Проверьте, прошел ли система аттестацию
После регистрации необходимой информации в HGS следует проверить, прошел ли узел аттестацию.
На вновь добавленном узле Hyper-V выполните `Set-HgsClientConfiguration` и укажите правильные URL-адреса для кластера HGS.
Эти URL-адреса можно получить, запустив `Get-HgsServer` на любом узле HGS.

```powershell
Set-HgsClientConfiguration -KeyProtectionServerUrl 'http://hgs.bastion.local/KeyProtection' -AttestationServerUrl 'http://hgs.bastion.local/Attestation'
```

Если полученное состояние не указывает "Ишостгуардед: true", потребуется устранить неполадки в конфигурации.
На узле, который не прошел аттестацию, выполните следующую команду, чтобы получить подробный отчет о проблемах, которые могут помочь устранить сбой аттестации.

```powershell
Get-HgsTrace -RunDiagnostics -Detailed
```

> [!IMPORTANT]
> Если вы используете Windows Server 2019 или Windows 10 версии 1809 и используете политики целостности кода, `Get-HgsTrace` может возвращать ошибку для **активной диагностики политики целостности кода** .
> Вы можете спокойно проигнорировать этот результат, если это единственный сбой диагностики.

### <a name="review-attestation-policies"></a>Проверка политик аттестации
Чтобы проверить текущее состояние политик, настроенных в HGS, выполните следующие команды в любом узле HGS:

```powershell
# List all trusted security groups for admin-trusted attestation
Get-HgsAttestationHostGroup

# List all policies configured for TPM-trusted attestation
Get-HgsAttestationPolicy
```

Если политика, которая больше не соответствует требованиям безопасности (например, устаревшая политика целостности кода, которая теперь считается ненадежной), можно отключить, заменив имя политики в следующей команде:

```powershell
Disable-HgsAttestationPolicy -Name 'PolicyName'
```

Аналогичным образом можно использовать `Enable-HgsAttestationPolicy` для повторного включения политики.

Если политика больше не нужна и вы хотите удалить ее со всех узлов HGS, запустите `Remove-HgsAttestationPolicy -Name 'PolicyName'`, чтобы окончательно удалить политику.

## <a name="changing-attestation-modes"></a>Изменение режимов аттестации
Если защищенная структура была запущена с помощью аттестации, доверенной администратором, то, скорее всего, потребуется выполнить обновление до более надежного режима аттестации TPM, как только у вас будет достаточного количества узлов, совместимых с TPM 2,0, в вашей среде.
Когда вы будете готовы к переключению, вы можете предварительно загрузить все артефакты аттестации (политики CI, базовые показатели TPM и идентификаторы доверенного платформенного модуля) в HGS, продолжая выполнять HGS с аттестацией, доверенной администратором.
Для этого просто следуйте инструкциям в разделе [авторизация нового защищенного узла](#authorizing-new-guarded-hosts) .

После добавления всех политик в HGS следует выполнить операцию искусственной аттестации на узлах, чтобы узнать, будет ли они передавать аттестацию в режиме TPM.
Это не влияет на текущее рабочее состояние HGS.
Приведенные ниже команды должны выполняться на компьютере, который имеет доступ ко всем узлам в окружении и по крайней мере одному узлу HGS.
Если брандмауэр или другие политики безопасности не позволяют это сделать, этот шаг можно пропустить.
По возможности рекомендуется запустить искусственную аттестацию, чтобы дать хорошее представление о том, будет ли переключение в режим TPM приведет к простою виртуальных машин. 

```powershell
# Get information for each host in your environment
$hostNames = 'host01.contoso.com', 'host02.contoso.com', 'host03.contoso.com'
$credential = Get-Credential -Message 'Enter a credential with admin privileges on each host'
$targets = @()
$hostNames | ForEach-Object { $targets += New-HgsTraceTarget -Credential $credential -Role GuardedHost -HostName $_ }

$hgsCredential = Get-Credential -Message 'Enter an admin credential for HGS'
$targets += New-HgsTraceTarget -Credential $hgsCredential -Role HostGuardianService -HostName 'HGS01.bastion.local'

# Initiate the synthetic attestation attempt
Get-HgsTrace -RunDiagnostics -Target $targets -Diagnostic GuardedFabricTpmMode 
```

После завершения диагностики изучите выведенные сведения, чтобы определить, не была ли на узлах выполнена аттестация в режиме TPM.
Повторно запустите диагностику, пока вы не получите "Pass" с каждого узла, а затем переходите к изменению режима HGS на режим TPM.

**Переход на режим TPM** требует всего лишь секунды.
Выполните следующую команду в любом узле HGS, чтобы обновить режим аттестации.

```powershell
Set-HgsServer -TrustTpm
```

Если возникли проблемы и необходимо переключиться обратно в режим Active Directory, можно запустить `Set-HgsServer -TrustActiveDirectory`.

Убедившись, что все работает правильно, следует удалить все доверенные группы узлов Active Directory из HGS и удалить доверие между доменами HGS и Fabric.
Если оставить Active Directory доверие на месте, то вы рискуете повторно включить доверие и переключить HGS в режим Active Directory, что может позволить ненадежному коду выполняться без проверки на защищенных узлах.

## <a name="key-management"></a>Управление ключами
Решение защищенной структуры использует несколько пар открытого и закрытого ключей для проверки целостности различных компонентов в решении и шифрования секретов клиента.
Служба защиты узла настроена по крайней мере с двумя сертификатами (с открытыми и закрытыми ключами), которые используются для подписывания и шифрования ключей, используемых для запуска экранированных виртуальных машин.
Эти ключи должны быть тщательно управляемыми.
Если закрытый ключ получен злоумышленником, он сможет расположить все виртуальные машины, работающие в вашей структуре, или настроить кластер фальшивый HGS, который использует политики более слабой аттестации, чтобы обойти установленные вами защиты.
Если вы потеряли закрытые ключи во время аварии и не нашли их в резервной копии, вам потребуется настроить новую пару ключей и повторно создать ключ для каждой виртуальной машины, чтобы авторизовать новые сертификаты.

В этом разделе рассматриваются общие темы управления ключами, которые помогут вам настроить ключи, чтобы они были работоспособными и безопасными.

### <a name="adding-new-keys"></a>Добавление новых ключей
Хотя HGS необходимо инициализировать с помощью одного набора ключей, можно добавить несколько ключей шифрования и подписывания в HGS.
Ниже приведены две наиболее распространенные причины добавления новых ключей в HGS.
1. Для поддержки сценариев "создать собственный ключ", когда клиенты копируют свои закрытые ключи в модуль безопасности оборудования и разрешают только ключи для запуска экранированных виртуальных машин.
2. Чтобы заменить существующие ключи для HGS, сначала добавьте новые ключи и сохранив оба набора ключей до тех пор, пока каждая конфигурация виртуальной машины не будет обновлена для использования новых ключей.

Процесс добавления новых ключей зависит от типа используемого сертификата.

**Вариант 1. Добавление сертификата, хранящегося в HSM**

Рекомендуемый подход к защите ключей HGS — использование сертификатов, созданных в аппаратном модуле безопасности (HSM).
HSM убедитесь, что ключи привязаны к физическому доступу к защищенному с помощью безопасности устройству в вашем центре обработки данных.
Каждый HSM-модуль отличается и имеет уникальный процесс создания сертификатов и их регистрации в HGS.
Приведенные ниже действия предназначены для предоставления грубых рекомендаций по использованию сертификатов HSM.
Точные сведения о действиях и возможностях см. в документации поставщика HSM.

1. Установите программное обеспечение HSM на каждом узле HGS в кластере. В зависимости от того, есть ли у вас сетевое или локальное устройство HSM, может потребоваться настроить HSM, чтобы предоставить компьютеру доступ к своему хранилищу ключей.
2. Создание 2 сертификатов в HSM с **2048 битных ключей RSA** для шифрования и подписывания
    1. Создайте сертификат шифрования со свойством использования ключа " **Шифрование данных** " в HSM.
    2. Создайте сертификат подписи со свойством использования ключа **цифровой подписи** в HSM.
3. Установите сертификаты в локальном хранилище сертификатов каждого узла HGS в соответствии с руководством поставщика HSM.
4. Если модуль HSM использует детализированные разрешения для предоставления конкретным приложениям или пользователям разрешения на использование закрытого ключа, необходимо предоставить группе HGS управляемая учетная запись службы доступ к сертификату. Имя учетной записи HGS gMSA можно найти, выполнив `(Get-IISAppPool -Name KeyProtection).ProcessModel.UserName`
5. Добавьте сертификаты подписи и шифрования в HGS, заменив отпечатки соответствующими сертификатами в следующих командах:

    ```powershell
    Add-HgsKeyProtectionCertificate -CertificateType Encryption -Thumbprint "AABBCCDDEEFF00112233445566778899"
    Add-HgsKeyProtectionCertificate -CertificateType Signing -Thumbprint "99887766554433221100FFEEDDCCBBAA"
    ```

**Вариант 2. Добавление неэкспортируемых сертификатов программного обеспечения**

Если у вас есть сертификат с программной защитой, выпущенный в организации или в общедоступном центре сертификации с закрытым ключом, который не является экспортируемым, необходимо добавить сертификат в HGS с помощью отпечатка.
1. Установите сертификат на компьютере в соответствии с инструкциями центра сертификации.
2. Предоставьте учетной записи управляемой службы группы HGS доступ на чтение к закрытому ключу сертификата. Имя учетной записи HGS gMSA можно найти, выполнив `(Get-IISAppPool -Name KeyProtection).ProcessModel.UserName`
3. Зарегистрируйте сертификат в HGS с помощью следующей команды и подставьте его на отпечаток сертификата (измените *Шифрование* для *подписи* сертификатов подписи):

    ```powershell
    Add-HgsKeyProtectionCertificate -CertificateType Encryption -Thumbprint "AABBCCDDEEFF00112233445566778899"
    ```

> [!IMPORTANT]
> Вам потребуется вручную установить закрытый ключ и предоставить доступ на чтение учетной записи gMSA на каждом узле HGS.
> Службе HGS не удается автоматически реплицировать закрытые ключи для *любого* сертификата, зарегистрированного его отпечатком.

**Вариант 3. Добавление сертификатов, хранимых в PFX-файлах**

Если у вас есть программно защищенный сертификат с экспортируемым закрытым ключом, который можно сохранить в формате PFX-файла и защитить паролем, HGS может автоматически управлять сертификатами.
Сертификаты, добавленные с помощью PFX-файлов, автоматически реплицируются на каждый узел кластера HGS, и HGS защищает доступ к закрытым ключам.
Чтобы добавить новый сертификат с помощью PFX-файла, выполните следующие команды в любом узле HGS (измените *Шифрование* для *подписи* сертификатов подписи):

```powershell
$certPassword = Read-Host -AsSecureString -Prompt "Provide the PFX file password"
Add-HgsKeyProtectionCertificate -CertificateType Encryption -CertificatePath "C:\temp\encryptionCert.pfx" -CertificatePassword $certPassword
```

**Определение и изменение основных сертификатов** Хотя HGS может поддерживать несколько сертификатов подписи и шифрования, в качестве первичных сертификатов используется одна пара.
Это сертификаты, которые будут использоваться, если кто-то загрузит метаданные защиты для этого кластера HGS.
Чтобы проверить, какие сертификаты в данный момент помечены как основные сертификаты, выполните следующую команду:

```powershell
Get-HgsKeyProtectionCertificate -IsPrimary $true
```

Чтобы задать новое основное шифрование или сертификат для подписи, найдите отпечаток нужного сертификата и пометьте его как основной с помощью следующих команд:

```powershell
Get-HgsKeyProtectionCertificate
Set-HgsKeyProtectionCertificate -CertificateType Encryption -Thumbprint "AABBCCDDEEFF00112233445566778899" -IsPrimary
Set-HgsKeyProtectionCertificate -CertificateType Signing -Thumbprint "99887766554433221100FFEEDDCCBBAA" -IsPrimary
```

### <a name="renewing-or-replacing-keys"></a>Продление или замена ключей
При создании сертификатов, используемых службой HGS, сертификатам будет назначена дата окончания срока действия согласно политике центра сертификации и сведениям о запросе.
Как правило, в сценариях, где важна достоверность сертификата, например защита обмена данными по протоколу HTTP, необходимо обновить сертификаты до истечения срока действия, чтобы избежать нарушения работы службы или тревожно сообщения об ошибке.
HGS не использует сертификаты в этом смысле.
HGS просто использует сертификаты как удобный способ создания и хранения пары асимметричных ключей.
Сертификат шифрования или подписи с истекшим сроком действия в HGS не означает слабости или потери защиты для экранированных виртуальных машин.
Кроме того, в HGS не выполняются проверки отзыва сертификатов.
Если сертификат HGS или сертификат центра сертификации отозван, он не повлияет на использование сертификата HGS.

Единственным временем, о котором следует беспокоиться о сертификате HGS, является то, что есть основания полагать, что закрытый ключ был украден.
В этом случае целостность экранированных виртуальных машин находится под угрозой, так как владение частной половиной шифрования и пары ключей подписывания достаточно для удаления защиты экранирования на виртуальной машине или для поддельного сервера HGS с более слабыми политиками аттестации.

Если вы можете найти себя в этой ситуации или в соответствии со стандартами соответствия требованиям для регулярного обновления ключей сертификатов, в следующих шагах описывается процесс изменения ключей на сервере HGS.
Обратите внимание, что следующее руководство представляет значительную часть, которая приводит к нарушению работы службы для каждой виртуальной машины, обслуживаемой кластером HGS.
Правильное планирование изменения ключей HGS необходимо для минимизации перерыва в обслуживании и обеспечения безопасности виртуальных машин клиента.

В узле HGS выполните следующие действия, чтобы зарегистрировать новую пару сертификатов шифрования и подписи.
См. раздел о [добавлении новых ключей](#adding-new-keys) для получения подробных сведений о различных способах добавления новых ключей в HGS.
1. Создайте новую пару сертификатов шифрования и подписи для сервера HGS. В идеале они будут созданы в аппаратном модуле безопасности.
2. Зарегистрируйте новые сертификаты шифрования и подписи с помощью командлета **Add-хгскэйпротектионцертификате** .

    ```powershell
    Add-HgsKeyProtectionCertificate -CertificateType Signing -Thumbprint <Thumbprint>
    Add-HgsKeyProtectionCertificate -CertificateType Encryption -Thumbprint <Thumbprint>
    ```
3. Если вы использовали отпечатки, необходимо перейти к каждому узлу в кластере, чтобы установить закрытый ключ и предоставить службе HGS gMSA доступ к ключу.
4. Сделать новые сертификаты сертификатами по умолчанию в HGS

    ```powershell
    Set-HgsKeyProtectionCertificate -CertificateType Signing -Thumbprint <Thumbprint> -IsPrimary
    Set-HgsKeyProtectionCertificate -CertificateType Encryption -Thumbprint <Thumbprint> -IsPrimary
    ```

На этом этапе данные экранирования, созданные с помощью метаданных, полученных из узла HGS, будут использовать новые сертификаты, но существующие виртуальные машины продолжат работать, так как старые сертификаты все еще существуют.
Чтобы убедиться, что все существующие виртуальные машины будут работать с новыми ключами, необходимо обновить предохранитель ключа на каждой виртуальной машине.
Это действие требует вовлечения владельца виртуальной машины (пользователя или сущности, которой принадлежит опекун "владелец").
Для каждой экранированной виртуальной машины выполните следующие действия.
5. Завершите работу виртуальной машины. Невозможно снова включить виртуальную машину, пока оставшиеся шаги не будут выполнены, иначе вам потребуется запустить процесс снова.
6. Сохранить текущий предохранитель ключа в файле: `Get-VMKeyProtector -VMName 'VM001' | Out-File '.\VM001.kp'`
7. Перемещение ключевого индикатора на владельца виртуальной машины
8. Загружайте владельца обновленных сведений о защитнике из HGS и импортируйте их в свою локальную систему
9. Прочтите текущий ключевой объект в память, предоставьте новому хранителю доступ к КЛЮЧЕВому элементу и сохраните его в новый файл, выполнив следующие команды:

    ```powershell
    $kpraw = Get-Content -Path .\VM001.kp
    $kp = ConvertTo-HgsKeyProtector -Bytes $kpraw
    $newGuardian = Get-HgsGuardian -Name 'UpdatedHgsGuardian'
    $updatedKP = Grant-HgsKeyProtectorAccess -KeyProtector $kp -Guardian $newGuardian
    $updatedKP.RawData | Out-File .\updatedVM001.kp
    ```
10. Копировать обновленный ключевой объект обратно в структуру размещения
11. Примените ключевой объект к исходной виртуальной машине:

   ```powershell
   $updatedKP = Get-Content -Path .\updatedVM001.kp
   Set-VMKeyProtector -VMName VM001 -KeyProtector $updatedKP
   ```
12. Наконец, запустите виртуальную машину и убедитесь, что она успешно запущена.

> [!NOTE]
> Если владелец виртуальной машины устанавливает неверный предохранитель ключа на виртуальной машине и не выполняет авторизацию вашей структуры для запуска ВИРТУАЛЬНОЙ машины, вы не сможете запустить экранированную виртуальную машину.
> Чтобы вернуться к последнему работоспособному предохранителю ключа, запустите `Set-VMKeyProtector -RestoreLastKnownGoodKeyProtector`

После обновления всех виртуальных машин для авторизации новых ключей защитника можно отключить и удалить старые ключи.

13. Получение отпечатков старых сертификатов из `Get-HgsKeyProtectionCertificate -IsPrimary $false`

14. Отключите каждый сертификат, выполнив следующие команды:  

   ```powershell
   Set-HgsKeyProtectionCertificate -CertificateType Signing -Thumbprint <Thumbprint> -IsEnabled $false
   Set-HgsKeyProtectionCertificate -CertificateType Encryption -Thumbprint <Thumbprint> -IsEnabled $false
   ```

15. Убедившись, что виртуальные машины по-прежнему могут начать работу с отключенными сертификатами, удалите сертификаты из HGS, выполнив следующие команды:

   ```powershell
   Remove-HgsKeyProtectionCertificate -CertificateType Signing -Thumbprint <Thumbprint>`
   Remove-HgsKeyProtectionCertificate -CertificateType Encryption -Thumbprint <Thumbprint>`
   ```

> [!IMPORTANT]
> Резервные копии виртуальных машин будут содержать старые сведения предохранителя ключа, позволяющие использовать старые сертификаты для запуска виртуальной машины.
> Если вы знаете, что закрытый ключ был скомпрометирован, следует предположить, что резервные копии виртуальной машины могут быть скомпрометированы, и предпринять соответствующие действия.
> Удаление конфигурации виртуальной машины из резервных копий (. vmcx) приведет к удалению предохранителей ключа за счет необходимости использовать пароль восстановления BitLocker для загрузки виртуальной машины в следующий раз.

### <a name="key-replication-between-nodes"></a>Репликация ключей между узлами
Каждый узел в кластере HGS должен быть настроен с одинаковым шифрованием, подписыванием и (при настройке) SSL-сертификатами.
Это необходимо, чтобы обеспечить успешное обслуживание узлов Hyper-V, достигнутых на любом узле в кластере.

**Если вы инициализируют сервер HGS с сертификатами на основе PFX** , то HGS автоматически реплицирует как открытый, так и закрытый ключ этих сертификатов на каждом узле в кластере.
Ключи необходимо добавлять только на одном узле.

**Если сервер HGS инициализирован с ссылками на сертификат** или отпечаток, то HGS будет реплицировать только *открытый* ключ в сертификате на каждый узел.
Кроме того, HGS не может предоставить самому себе доступ к закрытому ключу на любом узле в этом сценарии.
Поэтому вы отвечаете за следующее:
1. Установка закрытого ключа на каждом узле HGS
2. Предоставление группе HGS управляемой учетной записи службы (gMSA) доступа к закрытому ключу на каждом узле эти задачи добавляют дополнительные операционные нагрузки, однако они необходимы для ключей с защитой HSM и сертификатов с закрытыми ключами, которые не могут быть экспортированы.

**SSL-сертификаты** никогда не реплицируются в какой-либо форме.
Вы обязаны инициализировать каждый сервер HGS с одним и тем же SSL-сертификатом и обновлять каждый сервер всякий раз, когда вы решите продлить или заменить SSL-сертификат.
При замене SSL-сертификата рекомендуется использовать командлет [Set-HgsServer](https://technet.microsoft.com/library/mt652180.aspx) .

## <a name="unconfiguring-hgs"></a>Идет отменяющая Настройка HGS

Если необходимо списать или значительно перенастроить сервер HGS, это можно сделать с помощью командлетов [clear-HgsServer](https://technet.microsoft.com/library/mt652176.aspx) или [uninstall-hgsserver](https://technet.microsoft.com/library/mt652182.aspx) .

### <a name="clearing-the-hgs-configuration"></a>Очистка конфигурации HGS

Чтобы удалить узел из кластера HGS, используйте командлет [clear-HgsServer](https://technet.microsoft.com/library/mt652176.aspx) .
Этот командлет вносит следующие изменения на сервере, где он выполняется:

- Отмена регистрации служб аттестации и защиты ключей
- Удаляет конечную точку управления JEA "Microsoft. Windows. HGS"
- Удаляет локальный компьютер из отказоустойчивого кластера HGS.

Если сервер является последним узлом HGS в кластере, кластер и соответствующий ему ресурс имени распределенной сети также будут уничтожены.

```powershell
# Removes the local computer from the HGS cluster
Clear-HgsServer
```

После завершения операции очистки сервер HGS можно инициализировать повторно с помощью [Initialize-HgsServer](https://technet.microsoft.com/library/mt652185.aspx).
Если вы использовали [Install-HgsServer](https://technet.microsoft.com/library/mt652169.aspx) для настройки домена домен Active Directory Services, этот домен останется настроенным и работоспособным после операции очистки.

### <a name="uninstalling-hgs"></a>Удаление HGS

Если вы хотите удалить узел из кластера HGS **и** понизить контроллер домен Active Directory, который работает на нем, используйте командлет [uninstall-HgsServer](https://technet.microsoft.com/library/mt652182.aspx) .
Этот командлет вносит следующие изменения на сервере, где он выполняется:

- Отмена регистрации служб аттестации и защиты ключей
- Удаляет конечную точку управления JEA "Microsoft. Windows. HGS"
- Удаляет локальный компьютер из отказоустойчивого кластера HGS.
- Понижает домен Active Directory контроллер, если он настроен

Если сервер является последним узлом HGS в кластере, домен, отказоустойчивый кластер и ресурс имени распределенной сети кластера также будут уничтожены.

```powershell
# Removes the local computer from the HGS cluster and demotes the ADDC (restart required)
$newLocalAdminPassword = Read-Host -AsSecureString -Prompt "Enter a new password for the local administrator account"
Uninstall-HgsServer -LocalAdministratorPassword $newLocalAdminPassword -Restart
```

После завершения операции удаления и перезагрузки компьютера можно переустановить см и HGS с помощью команды [Install-HgsServer](https://technet.microsoft.com/library/mt652169.aspx) или присоединить компьютер к домену и инициализировать сервер HGS в этом домене с помощью команды [Initialize-HgsServer](https://technet.microsoft.com/library/mt652185.aspx).

Если вы больше не планируете использовать компьютер в качестве узла HGS, можно удалить роль из Windows.

```powershell
Uninstall-WindowsFeature HostGuardianServiceRole
```
