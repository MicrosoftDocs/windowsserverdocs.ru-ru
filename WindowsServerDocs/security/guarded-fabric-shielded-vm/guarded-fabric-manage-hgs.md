---
title: Управление службы защиты узла
ms.custom: na
ms.prod: windows-server-threshold
ms.topic: article
ms.assetid: eecb002e-6ae5-4075-9a83-2bbcee2a891c
manager: dongill
author: rpsqrd
ms.technology: security-guarded-fabric
ms.openlocfilehash: dab27e71e42970507f321271edda90f6d161c691
ms.sourcegitcommit: eaf071249b6eb6b1a758b38579a2d87710abfb54
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/31/2019
ms.locfileid: "66447390"
---
# <a name="managing-the-host-guardian-service"></a>Управление службы защиты узла

> Относится к: Windows Server 2019 г., Windows Server (полугодовой канал), Windows Server 2016

Службы Защитника узлов (HGS) является центральной частью защищенной структуры решения.
Он отвечает, гарантируя, что узлы Hyper-V в структуре известны предприятия или поставщика услуг размещения и выполнения надежное программное обеспечение, а также для управления ключами, используемыми для запуска экранированных виртуальных машин.
Когда клиент решает доверять размещения их экранированные виртуальные машины, они помещаются доверять в конфигурации и управление службы защиты узла.
Поэтому очень важно следовать рекомендациям при управлении службы защиты узла для обеспечения безопасности, доступности и надежности вашей защищенной структуры.
Рекомендации в следующих разделах рассматриваются наиболее распространенных операционных проблем, с которыми сталкиваются Администраторы HGS.

## <a name="limiting-admin-access-to-hgs"></a>Ограничение доступа администратора к HGS
Из-за особенностей системы безопасности конфиденциальных HGS важно гарантировать его Администраторы высоконадежным членов вашей организации и, в идеале отделить от администраторов структуры ресурсов.
Кроме того рекомендуется управлять HGS только из безопасного рабочих станций, используя протоколы безопасный обмен данными, такие как WinRM по протоколу HTTPS.

### <a name="separation-of-duties"></a>Разделение обязанностей
При настройке HGS, вам предоставляется возможность создания изолированного леса Active Directory только для HGS, или для присоединения к домену существующих, доверенный HGS.
Это решение, а также роли, назначать администраторов в вашей организации, определить границу доверия для HGS.
Кто имеет доступ к HGS, непосредственно в качестве администратора или косвенно, как администратор чего-то еще (например, Active Directory), который может влиять на HGS, имеет контроль над вашей защищенной структуры.
HGS "Администраторы" выберите, какие узлы Hyper-V авторизованы для запуска экранированных виртуальных машин и управление сертификатами, необходимые для запуска экранированных виртуальных машин.
Администратором злоумышленников или вредоносных администратором, у кого есть доступ к HGS можно использовать эти возможности для авторизации скомпрометированных узлов для запуска экранированных виртуальных машин, инициировать атаку типа "отказ в обслуживании" путем удаления материал ключа и многое другое.

Чтобы избежать этого, *строго* рекомендуется ограничить область перекрытия между администраторов HGS (включая домен, к которому присоединен HGS) и среды Hyper-V.
Убедитесь, что не один администратор имеет доступ к обеим системам, злоумышленнику необходимо злоумышленнику 2 разные учетные записи 2 отдельных пользователей, чтобы завершить его задача для изменения политик, HGS.
Это также означает, что "Администраторы домена и enterprise," для двух сред Active Directory не должен выполнять один человек, а также HGS в том же лесу Active Directory в качестве следует использовать узлы Hyper-V.
Любой пользователь, могут предоставлять доступ к ресурсам дополнительные угрозу безопасности.

### <a name="using-just-enough-administration"></a>С помощью JIT-Администрирование
HGS поставляется с [Just Enough Administration](https://aka.ms/JEAdocs) (JEA) ролей, встроенных, которые помогут более безопасно управлять им.
JEA помогает, позволяя делегировать задачи администрирования для пользователей без прав администратора, это означает, что людям, которые управляют HGS политики не обязательно должны быть фактически администраторов домена или весь компьютер.
JEA работает, ограничивая какие команды, пользователь может запустить в сеансе PowerShell и с помощью временной локальной учетной записи в фоновом (уникальный для каждого сеанса пользователя) для выполнения команд, которые обычно требуют повышения прав.

HGS поставляется с предварительно настроенного 2 ролей JEA:
- **Администраторы HGS** что дает возможность управления всеми политиками HGS, включая авторизацию новые узлы для запуска экранированных виртуальных машин.
- **Рецензенты HGS** только что позволяет пользователям право на существующие политики аудита. Они не могут вносить любые изменения конфигурации HGS.

Для использования JEA, необходимо сначала создать новый обычный пользователь и сделать их членом HGS "Администраторы" или группа "рецензенты" HGS.
Если вы использовали `Install-HgsServer` установить новый лес для HGS, эти группы получат имена "*servicename*Администраторы» и"*servicename*рецензенты», соответственно, где *servicename*  сетевое имя кластера HGS.
Если вы присоединились к HGS в существующий домен, обратитесь к имена групп, указанных в `Initialize-HgsServer`.

**Создание стандартных пользователей для ролей администратора и редактор HGS**

```powershell
$hgsServiceName = (Get-ClusterResource HgsClusterResource | Get-ClusterParameter DnsName).Value
$adminGroup = $hgsServiceName + "Administrators"
$reviewerGroup = $hgsServiceName + "Reviewers"

New-ADUser -Name 'hgsadmin01' -AccountPassword (Read-Host -AsSecureString -Prompt 'HGS Admin Password') -ChangePasswordAtLogon $false -Enabled $true
Add-ADGroupMember -Identity $adminGroup -Members 'hgsadmin01'

New-ADUser -Name 'hgsreviewer01' -AccountPassword (Read-Host -AsSecureString -Prompt 'HGS Reviewer Password') -ChangePasswordAtLogon $false -Enabled $true
Add-ADGroupMember -Identity $reviewerGroup -Members 'hgsreviewer01'
```

**Политики аудита с ролью рецензента**

На удаленном компьютере, который подключен к сети HGS выполните следующие команды в PowerShell для входа в сеанс JEA с учетными данными рецензента.
Важно отметить, что поскольку редактор учетной записи обычного пользователя, он не может использоваться для регулярного удаленного взаимодействия Windows PowerShell, удаленный рабочий стол доступ к HGS и т. д.

```powershell
Enter-PSSession -ComputerName <hgsnode> -Credential '<hgsdomain>\hgsreviewer01' -ConfigurationName 'microsoft.windows.hgs'
```

Затем можно проверить, разрешенные команды в сеансе с `Get-Command` и запуска любых команд, разрешенных для аудита параметров.
В следующем примере выполняется проверка политики, которые включены в HGS.

```powershell
Get-Command

Get-HgsAttestationPolicy
```

Введите команду `Exit-PSSession` или его псевдоним `exit`, когда вы закончите работа с сеансом JEA. 

**Добавить новую политику с помощью роли администратора HGS**

Чтобы действительно изменить политику, вам потребуется подключиться к конечной точке JEA идентификатор, который принадлежит к группе «hgsAdministrators».
В следующем примере мы покажем, как можно копировать политику целостности кода в HGS и зарегистрировать его с помощью JEA.
Синтаксис может отличаться от что вы привыкли.
Это позволяет разместить некоторые ограничения в JEA как отсутствие доступа к всей файловой системе.

```powershell
$cipolicy = Get-Item "C:\temp\cipolicy.p7b"
$session = New-PSSession -ComputerName <hgsnode> -Credential '<hgsdomain>\hgsadmin01' -ConfigurationName 'microsoft.windows.hgs'
Copy-Item -Path $cipolicy -Destination 'User:' -ToSession $session

# Now that the file is copied, we enter the interactive session to register it with HGS
Enter-PSSession -Session $session
Add-HgsAttestationCiPolicy -Name 'New CI Policy via JEA' -Path 'User:\cipolicy.p7b'

# Confirm it was added successfully
Get-HgsAttestationPolicy -PolicyType CiPolicy

# Finally, remove the PSSession since it is no longer needed
Exit-PSSession
Remove-PSSession -Session $session
```

## <a name="monitoring-hgs"></a>Мониторинг HGS
### <a name="event-sources-and-forwarding"></a>Источники событий и перенаправления
События из HGS будут отображаться в журнале событий Windows в разделе 2 источников:
- **HostGuardianService-Attestation**
- **HostGuardianService KeyProtection**

Эти события можно просмотреть, открыв средство просмотра событий, а затем перейдя Microsoft-Windows-HostGuardianService-аттестации и Microsoft-Windows-HostGuardianService-KeyProtection.

В больших часто бывает предпочтительнее для передачи событий центра сборщика событий Windows для упрощения анализа событий.
Дополнительные сведения, ознакомьтесь с [пересылки событий Windows документации](https://msdn.microsoft.com/library/windows/desktop/bb427443.aspx).

### <a name="using-system-center-operations-manager"></a>С помощью System Center Operations Manager
Можно также использовать System Center 2016 — Operations Manager для наблюдения за HGS и защищенных узлов.
Пакет управления защищенной структуры включает мониторы событий на наличие типичных неверных настроек, которые могут привести к простою центра обработки данных, включая узлы, не передавая аттестации и серверами HGS, отчетов об ошибках.

Чтобы начать работу, [установки и настройки SCOM 2016](https://technet.microsoft.com/system-center-docs/om/welcome-to-operations-manager) и [загрузить пакет управления защищенной структуры](https://www.microsoft.com/download/details.aspx?id=52764).
В руководстве по пакету управления включены объясняется, как настроить пакет управления и представление об объеме его мониторов.

## <a name="backing-up-and-restoring-hgs"></a>Резервное копирование и восстановление HGS
### <a name="disaster-recovery-planning"></a>Планирование аварийного восстановления
При разработке проекта планы аварийного восстановления, важно учесть уникальные требования к службе защиты узла в защищенной структуре.
Если вы потеряете некоторые или все узлы HGS, вы можете столкнуться срочного проблем, которые могут помешать пользователям запуска их экранированные виртуальные машины.
В случае потери подключения весь кластер HGS необходимо иметь полные резервные копии HGS конфигурации стороны для восстановления кластера HGS и возобновить нормальную работу.
В этом разделе рассматриваются действия, необходимые для подготовки для такого сценария.

Во-первых важно понять, как насчет HGS важен для резервного копирования.
HGS сохраняет некоторые части информации, помочь определить, какие узлы могут запускаться экранированные виртуальные машины.
Сюда входят следующие возможности.
1. Active Directory идентификаторы безопасности, для группы, содержащие доверенные узлы, (при использовании аттестации Active Directory);
2. Уникальные идентификаторы доверенного платформенного МОДУЛЯ для каждого узла в вашей среде;
3. Доверенный платформенный модуль политики для каждого уникального конфигурации узла; и
4. Политики целостности кода, которые определяют, какие программы разрешено запускать на узлах.

Эти артефакты аттестации требуют координации с администраторов размещения матрицы для получения, потенциально затрудняя получить эту информацию еще раз после аварии.

Кроме того HGS требуется доступ к 2 или более сертификаты, используемые для шифрования и подписи сведения, необходимые для запуска экранированной виртуальной Машины (предохранитель ключа).
Эти сертификаты хорошо известны (используемое владельцами экранированных виртуальных машин для авторизации матрицы для выполнения своих виртуальных машин) и должны восстанавливаться после аварии, восстановление работать.
Вам не следует восстанавливать HGS с те же сертификаты после аварии, каждой виртуальной Машины необходимо обновить, чтобы авторизовать новые ключи для расшифровки свои данные.
По соображениям безопасности только владелец виртуальной Машины можно обновить конфигурацию виртуальной Машины для авторизации эти новые ключи, "Ошибка" значение для восстановления ключей, после каждого владелец виртуальной Машины нужно предпринимать действия для получения своих виртуальных машин под управлением снова приведет к аварии.

#### <a name="preparing-for-the-worst"></a>Подготовка к худшему
Чтобы подготовиться к полной потере HGS, существует два шага, которые необходимо выполнить.
1. Резервное копирование политики аттестации HGS
2. Резервное копирование ключей HGS

О том, как выполнить оба этапа описаны в [резервного копирования HGS](#backing-up-hgs) раздел.

Он рекомендуется, кроме того, но не является обязательным, резервную копию списка пользователей с правом на управление HGS в своем домене Active Directory или Active Directory.

Резервные копии следует принимать регулярно, чтобы убедиться, что данные в актуальном состоянии и храниться безопасно, чтобы избежать подмены или кражи.

Это **не рекомендуется** для резервного копирования или попробуйте восстановить всю систему изображения узла HGS.
В случае потери всего кластера, рекомендуется установить новый узел HGS и восстановления только состояния HGS, но не для всей серверной ОС.

#### <a name="recovering-from-the-loss-of-one-node"></a>Восстановление после потеря одного узла
Если вы потеряете одного или нескольких узлов (но не для всех узлов) в кластере HGS, вы можете просто [добавления узлов к кластеру](guarded-fabric-configure-additional-hgs-nodes.md) следовать инструкциям в руководстве по развертыванию.
Политики аттестации будут синхронизироваться автоматически, как и любые сертификаты, которые были предоставлены HGS как PFX-файлы с сопутствующими пароли.
Для сертификатов, добавленных к HGS, с помощью отпечатка (недоступен для экспорта и сертификаты, часто включаются в оборудования), необходимо обеспечить каждого нового узла имеет доступ к закрытому ключу каждого сертификата.

#### <a name="recovering-from-the-loss-of-the-entire-cluster"></a>Восстановление после потери всего кластера
Если весь кластер HGS выходит из строя, и вы не сможете снова подключить его, необходимо будет восстановить из резервной HGS.
Восстановление из резервной HGS включает в себя первый параметр нового кластера HGS на [рекомендации в руководстве по развертыванию](guarded-fabric-setting-up-the-host-guardian-service-hgs.md).
Он является настоятельно рекомендуется, но не обязательно, использовать одно имя кластера при настройке среды HGS восстановления для помощи с разрешением имен из узлов.
Тем же именем, позволяет избежать повторной настройки узлов с новой аттестации и защиты ключей URL-адреса.
Если объекты были восстановлены в домен Active Directory резервного HGS, рекомендуется удалить объекты, представляющие кластер HGS, компьютеров, учетной записи службы и JEA групп перед инициализацией сервер HGS.

После настройки первого узла HGS (например его установки и инициализации), следует выполнить процедуры, описанные в разделе [HGS восстановление из резервной копии](#restoring-hgs-from-a-backup) Восстановление политики аттестации и открытый половины защиты ключей сертификаты.
Вам потребуется восстановить закрытых ключей для сертификатов вручную в соответствии с указаниями поставщика сертификата (импортировать сертификат в Windows или настройте доступ к резервным HSM сертификаты).
После настройки первого узла можно продолжать [установить дополнительные узлы к кластеру](guarded-fabric-configure-additional-hgs-nodes.md) пока не достигните емкости и устойчивости, необходимы.

### <a name="backing-up-hgs"></a>Резервное копирование HGS
Администратор службы защиты узла должен нести ответственность за резервное копирование HGS на регулярной основе.
Полное резервное копирование будет содержать конфиденциальные материал ключа, который должен быть соответствующим образом защищены.
Должен недоверенных сущности получить доступ к этим ключам, они могут использовать что материал для настройки вредоносных среды HGS для ущерба экранированных виртуальных машин.

**Резервное копирование политики аттестации** для обратно политиках аттестации HGS, выполните следующую команду на любом узле сервера рабочий HGS.
Вам будет предложено ввести пароль.
Этот пароль используется для шифрования всех сертификатов, добавляемый HGS, с помощью PFX-файл (вместо отпечаток сертификата).

```powershell
Export-HgsServerState -Path C:\temp\HGSBackup.xml
```

> [!NOTE]
> Если вы используете аттестацию с доверием администратора, необходимо отдельно создавать резервные копии членства в группах безопасности, используемые приложением HGS для авторизации защищенных узлов.
> HGS будут заархивированы только идентификатор безопасности группы безопасности, не членство в них.
> В случае эти группы будут потеряны при аварии, необходимо будет повторно создать в группах и снова добавьте каждого защищенного узла, к ним.

**Резервное копирование сертификатов**

`Export-HgsServerState` Команда выполнит резервное копирование любого PFX сертификаты на основе добавлен HGS во время выполнения команды.
Если вы добавили сертификаты HGS с помощью отпечатка (обычно недоступен для экспорта и аппаратной сертификатов), необходимо будет вручную резервное копирование закрытых ключей для сертификатов.
Чтобы определить, какие сертификаты регистрируются в службе HGS и нужно создавать резервные копии вручную, выполните следующую команду PowerShell на любом узле сервера рабочий HGS.

```powershell
Get-HgsKeyProtectionCertificate | Where-Object { $_.CertificateData.GetType().Name -eq 'CertificateReference' } | Format-Table Thumbprint, @{ Label = 'Subject'; Expression = { $_.CertificateData.Certificate.Subject } }
```

Для каждой из перечисленных сертификаты необходимо будет вручную создать резервную копию закрытого ключа.
Если вы используете сертификат на основе программного обеспечения, который недоступен для экспорта, следует обратиться к центра сертификации, чтобы обеспечить их резервная копия сертификата и (или) можно снова выполнить его по запросу.
Для сертификатов создаются и хранятся в аппаратных модулях безопасности следует обратиться к документации для вашего устройства, руководство по планированию аварийного восстановления.

Таким образом, чтобы оба фрагмента может быть восстановлена вместе, следует хранить резервные копии сертификата вместе с политики аттестации резервных копий в безопасном месте.

**Дополнительная настройка для резервного копирования**

Резервные копии HGS состояния сервера не будет включать имя кластера HGS, любой информации из Active Directory или SSL-сертификаты, используемые для защиты связи с API-интерфейсы HGS.
Эти параметры используются, важные для обеспечения согласованности, но не критично, чтобы получить HGS кластера обратно в оперативный режим после аварии.

Чтобы записать имя службы HGS, выполните `Get-HgsServer` и запомните имя неструктурированный в аттестации и URL-адреса для защиты ключа.
Например, если используется URL-адрес для аттестации "<http://hgs.contoso.com/Attestation>«, «hgs» — имя службы HGS.

Домен Active Directory, используемый HGS должен работать как и других доменов Active Directory.
При восстановлении HGS после аварии, вам не обязательно для повторного создания точный список объектов, которые есть в текущем домене.
Тем не менее это сделает восстановления проще, если резервное копирование Active Directory и сохранения списка пользователей JEA, правом на управление системы, а также членство в одну из групп безопасности, используемые приложением аттестацию с доверием администратора для авторизации защищенных узлов.

Чтобы определить отпечаток SSL-сертификатов, настроенные для HGS, выполните следующую команду в PowerShell.
Затем можно выполнять архивацию этих сертификатов SSL в соответствии с инструкциями поставщика сертификата.

```powershell
Get-WebBinding -Protocol https | Select-Object certificateHash
```

### <a name="restoring-hgs-from-a-backup"></a>Восстановление из резервной HGS
Следующие шаги описывают, как восстановить параметры HGS из резервной копии.
Шаги применимы для обеих ситуациях, где вы пытаетесь отменить изменения, сделанные к уже выполняемым экземплярам HGS и когда ответить нового кластера HGS после полной потери предыдущей.

#### <a name="set-up-a-replacement-hgs-cluster"></a>Настройка кластера HGS замены
Перед восстановлением HGS, необходимо иметь кластер инициализированный HGS, к которому можно восстановить конфигурацию.
Просто при импорте параметров, которые были случайно удалены в существующий кластер (запущено), этот шаг можно пропустить.
При восстановлении из полной потере HGS, необходимо установить и инициализировать следующий узел по крайней мере один HGS [рекомендации в руководстве по развертыванию](guarded-fabric-setting-up-the-host-guardian-service-hgs.md).

В частности вам потребуется:
1. [Настройка домена HGS](guarded-fabric-choose-where-to-install-hgs.md) или присоединить к существующему домену HGS
2. [Инициализировать сервер HGS](guarded-fabric-initialize-hgs.md) с помощью существующие ключи *или* набор временные ключи. Вы можете [удалить временные ключи](#renewing-or-replacing-keys) после импорта фактическое ключи из HGS создать резервную копию файлов.
3. [Импорт параметров HGS](#import-settings-from-a-backup) из резервной копии для восстановления группы доверенных узлов, политики целостности кода, базовые показатели доверенного платформенного МОДУЛЯ и идентификаторы доверенного платформенного МОДУЛЯ

> [!TIP]
> Новый кластер HGS не нужно использовать сертификаты, имя службы или домена в качестве экземпляра HGS, из которого был экспортирован в файл резервной копии.

#### <a name="import-settings-from-a-backup"></a>Импорт параметров из резервной копии

Чтобы восстановить аттестации политики, сертификаты на основе PFX и открытые ключи не PFX-сертификаты к узлу HGS из файла резервной копии, выполните следующую команду на узле инициализированный сервер HGS.
Вам будет предложено ввести пароль, указанный при создании резервной копии.

```powershell
Import-HgsServerState -Path C:\Temp\HGSBackup.xml
```

Если вы только хотите импортировать политики аттестацию с доверием администратора или аттестацию доверенного платформенного МОДУЛЯ политики, это можно сделать, указав `-ImportActiveDirectoryModeState` или `-ImportTpmModeState` флаги для [HgsServerState импорта](https://technet.microsoft.com/library/mt652168.aspx).

Обеспечить последний накопительный пакет обновления для Windows Server 2016 должен быть установлен перед запуском `Import-HgsServerState`.
Невыполнение этого требования может привести к ошибке импорта.

> [!NOTE]
> Если восстановить политики на существующий узел HGS, уже имеется один или несколько из этих политик, которые установлены, команда импорта выводится сообщение об ошибке для каждой политики повторяющиеся.
> Это ожидаемое поведение и в большинстве случаев можно спокойно проигнорировать.

#### <a name="reinstall-private-keys-for-certificates"></a>Переустановите закрытых ключей сертификатов
Если любой из сертификатов, которые используются на HGS, из которого была создана резервная копия были добавлены с помощью отпечатков, будут включены только открытый ключ сертификатов из файла резервной копии.
Это означает, что необходимо будет вручную установить и/или предоставить доступ к закрытым ключам для каждого из этих сертификатов, прежде чем HGS может обслуживать запросы с узлов Hyper-V.
Действия, необходимые для выполнения этого шага зависит от того, как изначально был выдан сертификат.
Для программного обеспечения резервного сертификаты, выданные центром сертификации, вам потребуется обратиться к центра сертификации, чтобы получить закрытый ключ и установите его на **каждого** узел HGS на их инструкции.
Аналогично Если сертификаты не аппаратной, необходимо будет обратитесь к документации производителя оборудования безопасности модуля, чтобы установить необходимые драйверы на каждом узле HGS для подключения в аппаратный модуль безопасности и предоставить каждой машины доступ к закрытому ключу.

Напоминаем добавляемый HGS, используя отпечатки сертификатов необходимо выполнить вручную репликацию закрытых ключей к каждому узлу.
Будет необходимо повторить это действие для каждого дополнительного узла, добавляемые в восстановленной кластер HGS.

#### <a name="review-imported-attestation-policies"></a>Просмотрите политики импортированных аттестации
После импорта параметров из резервной копии, рекомендуется внимательно проверьте все импортированные политики с помощью `Get-HgsAttestationPolicy` чтобы убедиться, что только узлы, вы доверяете для запуска экранированных виртуальных машин будут иметь возможность удостовериться, успешно.
Если вы найдете все политики, которые больше не соответствуют обеспечения безопасности, вы можете [отключить или удалить их](#review-attestation-policies).

#### <a name="run-diagnostics-to-check-system-state"></a>Выполните диагностику для проверки состояния системы
После завершения установки и восстановления состояния узла HGS, следует запустить средство диагностики HGS, чтобы проверить состояние системы.
Чтобы сделать это, выполните следующую команду на узле HGS где восстановлена конфигурации:

```powershell
Get-HgsTrace -RunDiagnostics
```

Если «Общий результат» не «Pass», чтобы завершить настройку системы необходимы дополнительные действия.
Проверьте сообщения, переданные в subtest(s) со сбоем Дополнительные сведения.

## <a name="patching-hgs"></a>Установка исправлений HGS
Важно поддерживать актуальность узлов службы защиты узла, установив последний накопительный пакет обновления, когда дело доходит. Если вы настраиваете совершенно новый узел HGS, настоятельно рекомендуется установить все доступные обновления, перед установкой роли HGS или его настройки.
Таким образом все новые или измененные функции вступят в силу немедленно.

При применении исправлений в защищенной структуре, настоятельно рекомендуется сначала обновить *все* узлов Hyper-V **перед обновлением HGS**.
Это гарантирует, что любые изменения политик аттестации HGS выполняются *после* узлов Hyper-V были обновлены для предоставления сведения, необходимые для них.
Если обновление будет изменять поведение политики, они не автоматически будет включен во избежание нарушения работы матрицы.
Такие обновления требуется следовать инструкциям в следующем разделе для активации политики новые или измененные аттестации.
Мы рекомендуем прочитать заметки о выпуске Windows Server и накопительные пакеты обновления, устанавливаемый для проверки, если требуются обновления политики.

### <a name="updates-requiring-policy-activation"></a>Обновления, требующие активации политики
Если обновление для HGS представляет или значительно меняет поведение политики аттестации, дополнительный шаг необходим для активации измененную политику.
Изменения политики вводятся только после экспорта и импорта состояния HGS.
Новые или измененные политики следует активировать только в том случае, после применения накопительного обновления для всех узлов и все узлы HGS в вашей среде.
После обновления каждого компьютера, выполните следующие команды на любом узле HGS, чтобы запустить процесс обновления:

```powershell
$password = Read-Host -AsSecureString -Prompt "Enter a temporary password"
Export-HgsServerState -Path .\temporaryExport.xml -Password $password
Import-HgsServerState -Path .\temporaryExport.xml -Password $password
```

Если появилась новая политика, он будет отключен по умолчанию.
Чтобы включить новую политику, найдите его в списке политик Microsoft (с префиксом «HGS_»), а затем включите ее с помощью следующих команд:

```powershell
Get-HgsAttestationPolicy

Enable-HgsAttestationPolicy -Name <Hgs_NewPolicyName>
```

## <a name="managing-attestation-policies"></a>Управление политиками аттестации
HGS поддерживает несколько политик аттестации, которые определяют минимальный набор требований, узел должен удовлетворять, чтобы быть расцениваются как «Исправен» и могут запускаться экранированные виртуальные машины.
Некоторые из этих политик определенных корпорацией Майкрософт, другие добавленные вы можете определить политики целостности кода допустимый, базовые показатели доверенного платформенного МОДУЛЯ и узлов в вашей среде.
Регулярное обслуживание этих политик необходимо убедиться, что узлы можно продолжить заверяющую должным образом, как обновить и заменить их и для обеспечения заблокирован успешно заверяющую недоверенные узлы или конфигурации.

Для аттестацию с доверием администратора, есть только одна политика, которая определяет, является ли узел работоспособным: членство в группе безопасности известных, доверенных.
Аттестация доверенного платформенного МОДУЛЯ более сложен и включает в себя различные политики для измерения кода и конфигурации системы, прежде чем определить, если он находится в работоспособном состоянии.

Единый HGS можно настроить с помощью Active Directory и доверенного платформенного МОДУЛЯ политик за один раз, но службы проверяют только политики, для которой она настроена для, когда узел пытается заверяющую текущий режим.
Чтобы проверить режим сервера HGS, запустите `Get-HgsServer`.

### <a name="default-policies"></a>Политики по умолчанию
Для аттестации доверенного платформенного МОДУЛЯ существует несколько встроенных политик, настроенных на HGS.
Некоторые из этих политик «заблокировано» — это означает, что они не может быть отключен по соображениям безопасности.
В следующей таблице описывается назначение каждой политики по умолчанию.

Имя политики                    | Цель
-------------------------------|-----------------------------------------------------
Hgs_SecureBootEnabled          | Требуется узлам включена безопасная загрузка. Это необходимо для измерения запуска двоичные файлы и другие параметры блокировки UEFI.
Hgs_UefiDebugDisabled          | Гарантирует, что узлы не имеют включен отладчик ядра. Отладчики пользовательского режима, блокируются с помощью политик целостности кода.
Hgs_SecureBootSettings         | Отрицательное политику, чтобы убедиться, что узлы соответствует хотя бы один базовый доверенного платформенного МОДУЛЯ (определенной администратором).
Hgs_CiPolicy                   | Отрицательное политику, чтобы убедиться, что узлы при использовании одного из определенной администратором политики целостности кода.
Hgs_HypervisorEnforcedCiPolicy | Требуется политика целостности кода, чтобы принудительно низкоуровневой оболочкой. Отключение этой политики ослабляет ваши средства защиты от атак политики целостности кода режима ядра.
Hgs_FullBoot                   | Гарантирует, что узел был выходит из спящего режима. Узлы должны быть правильно перезагрузке или завершении работы для реализации этой политики.
Hgs_VsmIdkPresent              | Требует обеспечения безопасности на основе виртуализации запущен на узле. IDK представляет ключ, необходимый для шифрования данных, отправляемых безопасного памяти узла.
Hgs_PageFileEncryptionEnabled  | Требуется файлов подкачки, должны шифроваться на узле. Отключение этой политики может привести доступность сведений, если незашифрованные файла подкачки проверяется наличие секреты клиента.
Hgs_BitLockerEnabled           | Требуется BitLocker для включения на узле Hyper-V. Эта политика отключена по умолчанию для повышения производительности и не рекомендуется включить. Эта политика не влияет на шифрование экранированные виртуальные машины.
Hgs_IommuEnabled               | Требует, что устройство IOMMU с узла используется для предотвращения атак доступа к памяти. Отключение этой политики и использование узлов без IOMMU включена может предоставлять секреты виртуальной Машины клиента для направления атак памяти.
Hgs_NoHibernation              | Требуется спящего режима, чтобы отключить на узле Hyper-V. Отключение этой политики делает возможным узлы для сохранения памяти экранированной виртуальной Машины в файле незашифрованные спящего режима.
Hgs_NoDumps                    | Требуется дампы памяти, чтобы отключить на узле Hyper-V. Если этот параметр отключен, рекомендуется настроить шифрование дампов для предотвращения сохраняются в файлы незашифрованные аварийных дампов памяти экранированной виртуальной Машины.
Hgs_DumpEncryption             | Дампы памяти, требуется, если включена на узле Hyper-V, должны шифроваться с помощью ключа шифрования, доверенным для HGS. Эта политика не применяется, если дампы памяти не включены на узле. Если эта политика и *Hgs\_NoDumps* являются оба отключены памяти экранированной виртуальной Машины может быть сохранен в файл дампа незашифрованным.
Hgs_DumpEncryptionKey          | Отрицательное политики узлов, которые разрешены дампы используется ключ шифрования файла дампа, определенной администратором известно HGS объем памяти. Эта политика не применяется при *Hgs\_DumpEncryption* отключена.

### <a name="authorizing-new-guarded-hosts"></a>Авторизация новых защищенных узлов
Для авторизации на новый узел в качестве защищенного узла (например подтверждающим успешно), HGS должны доверять узла и (если настроено использование аттестации доверенного платформенного МОДУЛЯ) программное обеспечение, запустить его.
Инструкции по авторизации на новый узел отличаются в зависимости от режима аттестации, для которого в настоящее время настроен HGS.
Чтобы проверить режим аттестации для защищенной структуры, выполните `Get-HgsServer` на любом узле HGS.

#### <a name="software-configuration"></a>Настройки программного обеспечения
На новом узле Hyper-V убедитесь, что установлен, Windows Server 2016 Datacenter edition.
Windows Server 2016 Standard не может запускать экранированные виртуальные машины, в защищенной структуре.
Узел может быть установлен возможности рабочего стола или основных серверных компонентов.

На сервере с возможностями рабочего стола и основных серверных компонентов вам потребуется установить роли сервера Hyper-V и поддержку защиты узла Hyper-V.

```powershell
Install-WindowsFeature Hyper-V, HostGuardian -IncludeManagementTools -Restart
```

#### <a name="admin-trusted-attestation"></a>Аттестация по группе доверенного администратора
Чтобы зарегистрировать новый узел в HGS, при использовании аттестацию с доверием администратора, необходимо сначала добавить узел в группу безопасности в домене, к которому он присоединен.
Как правило каждый домен будут иметь одну группу безопасности для защищенных узлов.
Если вы уже зарегистрировали этой группы в службе HGS, единственное действие, которое необходимо выполнить — перезапустить узел, чтобы обновить членство в группе.

Вы можете проверить, какие группы безопасности, доверия со стороны HGS, выполнив следующую команду:

```powershell
Get-HgsAttestationHostGroup
```

Чтобы зарегистрировать новую группу безопасности в службе HGS, получить идентификатор безопасности (SID) группы в домен ведущего приложения и зарегистрировать идентификатор безопасности в службе HGS.

```powershell
Add-HgsAttestationHostGroup -Name "Contoso Guarded Hosts" -Identifier "S-1-5-21-3623811015-3361044348-30300820-1013"
```

Инструкции о том, как настроить отношение доверия между домена и HGS можно найти в руководстве по развертыванию.

#### <a name="tpm-trusted-attestation"></a>Аттестация доверенного платформенного МОДУЛЯ
Если HGS настроена в режиме TPM, узлы необходимо передать все заблокированные политик и «enabled» префикс «Hgs_», а также по крайней мере один базовый план доверенного платформенного МОДУЛЯ, доверенного платформенного МОДУЛЯ идентификатор и политику целостности кода.
Каждый раз при добавлении нового узла, необходимо будет зарегистрировать новый идентификатор TPM в службе HGS.
Пока узел работает то же программное обеспечение (и применил ту же политику целостности кода) и базовых показателей доверенного платформенного МОДУЛЯ как другой узел в вашей среде, не потребуется для добавления новых политик непрерывной Интеграции или базовые показатели.

**Добавление доверенного платформенного МОДУЛЯ идентификатор для нового узла** на новый узел, выполните следующую команду, чтобы записать идентификатор доверенного платформенного МОДУЛЯ.
Не забудьте указать уникальное имя для узла, который поможет вам найти его на HGS.
Если списать узла или чтобы запретить выполнение экранированных виртуальных машин в HGS, вам потребуется эта информация.

```powershell
(Get-PlatformIdentifier -Name "Host01").InnerXml | Out-File C:\temp\host01.xml -Encoding UTF8
```

Скопируйте этот файл на сервер HGS, затем выполните следующую команду, чтобы зарегистрировать узел с HGS.

```powershell
Add-HgsAttestationTpmHost -Name 'Host01' -Path C:\temp\host01.xml
```

**Добавление нового шаблона доверенного платформенного МОДУЛЯ** Если новый узел работает под управлением нового оборудования или конфигурацию встроенного по для вашей среды, может потребоваться воспользоваться новым базовым показателям доверенного платформенного МОДУЛЯ.
Чтобы сделать это, выполните следующую команду на узле.

```powershell
Get-HgsAttestationBaselinePolicy -Path 'C:\temp\hardwareConfig01.tcglog'
```

> [!NOTE]
> Если появится сообщение об ошибке ссылкой узла не прошел проверку и не будет успешно подтверждающим, не волнуйтесь.
> Это — проверка готовности к установке, чтобы убедиться в том, что ваш ведущее приложение может выполняться экранированных виртуальных машин и скорее всего, означает, что вы еще не применены политики целостности кода или другой требовал настройки.
> Прочитать сообщение об ошибке, внести любые изменения, предложенные службами его, а затем повторите попытку.
> Кроме того, можно пропустить проверку в данный момент, добавив `-SkipValidation` команду флаг.

Копирование базового доверенного платформенного МОДУЛЯ на сервер HGS, а затем зарегистрировать его с помощью следующей команды.
Мы рекомендуем использовать соглашение об именовании, которое поможет вам понять, конфигурации оборудования и встроенного по этого класса узла Hyper-V.

```powershell
Add-HgsAttestationTpmPolicy -Name 'HardwareConfig01' -Path 'C:\temp\hardwareConfig01.tcglog'
```

**Добавление новой политики целостности кода** при изменении политики целостности кода, выполнение на узлах Hyper-V, необходимо зарегистрировать для новой политики в службе HGS, перед этими узлами подтвердят успешно.
На узле ссылки, который служит в качестве главного образа для доверенных компьютеров Hyper-V в вашей среде, записи новой политики непрерывной Интеграции с помощью `New-CIPolicy` команды.
Мы рекомендуем использовать **FilePublisher** уровень и **хэш** резервирование для политик CI узла Hyper-V.
Необходимо сначала создать политики целостности кода в режиме аудита, чтобы гарантировать, что все работает должным образом.
После проверки на примере рабочей нагрузки в системе, можно применить политику и копирования принудительно версии HGS.
Полный список параметров конфигурации политики целостности кода, обратитесь к [Device Guard документации](https://technet.microsoft.com/itpro/windows/keep-secure/deploy-device-guard-deploy-code-integrity-policies).

```powershell
# Capture a new CI policy with the FilePublisher primary level and Hash fallback and enable user mode code integrity protections
New-CIPolicy -FilePath 'C:\temp\ws2016-hardware01-ci.xml' -Level FilePublisher -Fallback Hash -UserPEs

# Apply the CI policy to the system
ConvertFrom-CIPolicy -XmlFilePath 'C:\temp\ws2016-hardware01-ci.xml' -BinaryFilePath 'C:\temp\ws2016-hardware01-ci.p7b'
Copy-Item 'C:\temp\ws2016-hardware01-ci.p7b' 'C:\Windows\System32\CodeIntegrity\SIPolicy.p7b'
Restart-Computer

# Check the event log for any untrusted binaries and update the policy if necessary
# Consult the Device Guard documentation for more details

# Change the policy to be in enforced mode
Set-RuleOption -FilePath 'C:\temp\ws2016-hardare01-ci.xml' -Option 3 -Delete

# Apply the enforced CI policy on the system
ConvertFrom-CIPolicy -XmlFilePath 'C:\temp\ws2016-hardware01-ci.xml' -BinaryFilePath 'C:\temp\ws2016-hardware01-ci.p7b'
Copy-Item 'C:\temp\ws2016-hardware01-ci.p7b' 'C:\Windows\System32\CodeIntegrity\SIPolicy.p7b'
Restart-Computer
```

После создания политики, протестированы и принудительно, скопируйте двоичный файл (.p7b) к серверу HGS и зарегистрируйте политику.

```powershell
Add-HgsAttestationCiPolicy -Name 'WS2016-Hardware01' -Path 'C:\temp\ws2016-hardware01-ci.p7b'
```

**Добавление ключа шифрования дампов памяти**

Когда *Hgs\_NoDumps* политика отключена и *Hgs\_DumpEncryption* политика включена, защищенных узлов разрешено обязательно дампы памяти (включая аварийные дампы) Включить до тех пор, пока эти дампы шифруются. Защищенные узлы будет передать аттестации только в том случае, если они отключены дампы памяти или их для шифрования с помощью ключа, известного HGS. По умолчанию ключи шифрования не дампа настроены на HGS.

Чтобы добавить ключ шифрования дампа HGS, используйте `Add-HgsAttestationDumpPolicy` командлет, чтобы предоставить HGS с хэшем ключа шифрования дампов.
Если план доверенного платформенного МОДУЛЯ на узле Hyper-V настроена без шифрования дампов, хэш-код включается в tcglog и могут предоставляться `Add-HgsAttestationDumpPolicy` командлета.

```powershell
Add-HgsAttestationDumpPolicy -Name 'DumpEncryptionKey01' -Path 'C:\temp\TpmBaselineWithDumpEncryptionKey.tcglog'
```

Кроме того можно напрямую предоставить строковым представлением хэш в командлет.

```powershell
Add-HgsAttestationDumpPolicy -Name 'DumpEncryptionKey02' -PublicKeyHash '<paste your hash here>'
```

Не забудьте добавить каждый ключ шифрования уникальный дампа HGS, если вы решили использовать различные ключи между вашей защищенной структуры.
Узлы, которые шифрования дампов памяти с ключом, не известен HGS не будет пройти аттестацию.

См. в документации Hyper-V, Дополнительные сведения о [настройке дампа шифрования на узлах](https://technet.microsoft.com/windows-server-docs/virtualization/hyper-v/manage/about-dump-encryption).

#### <a name="check-if-the-system-passed-attestation"></a>Проверить, если система аттестации
После регистрации необходимую информацию в службе HGS, следует проверить, если узел передает аттестацию.
На узле Hyper-V добавленные, выполните `Set-HgsClientConfiguration` и укажите правильный URL-адреса для кластера HGS.
Эти URL-адреса можно получить, выполнив `Get-HgsServer` на любом узле HGS.

```powershell
Set-HgsClientConfiguration -KeyProtectionServerUrl 'http://hgs.bastion.local/KeyProtection' -AttestationServerUrl 'http://hgs.bastion.local/Attestation'
```

Если не указано состояние «IsHostGuarded: Значение true,» требуется устранение неполадок с конфигурацией.
На узле, вызвавшего сбой аттестации выполните следующую команду, чтобы получить подробный отчет о проблемах, которые могут помочь устранить сбой аттестации.

```powershell
Get-HgsTrace -RunDiagnostics -Detailed
```

> [!IMPORTANT]
> Если вы используете Windows Server 2019 или Windows 10, версия 1809 и при использовании политики целостности кода, `Get-HgsTrace` может возвращать сбой **Active политики целостности кода** диагностики.
> Этот результат можно игнорировать при только сбои диагностики.

### <a name="review-attestation-policies"></a>Просмотрите политики аттестации
Чтобы просмотреть текущее состояние политики, настроенные на HGS, выполните следующие команды на любом узле HGS:

```powershell
# List all trusted security groups for admin-trusted attestation
Get-HgsAttestationHostGroup

# List all policies configured for TPM-trusted attestation
Get-HgsAttestationPolicy
```

Если включена политика, не отвечающего вашим требованиям безопасности (например старый политику целостности кода которого теперь расцениваются как небезопасные), его можно отключить, заменив имя политики в следующей команде:

```powershell
Disable-HgsAttestationPolicy -Name 'PolicyName'
```

Аналогично, можно использовать `Enable-HgsAttestationPolicy` включить политику.

Если вы больше не нужен, политики и хотите удалить его из всех узлов с HGS, запустите `Remove-HgsAttestationPolicy -Name 'PolicyName'` окончательно удалить политику.

## <a name="changing-attestation-modes"></a>Изменение режимов аттестации
Если вы начали вашей защищенной структуры с помощью аттестацию с доверием администратора, скорее всего требуется обновление до значительно сильнее режим аттестации TPM, как только у вас есть достаточное количество узлов 2.0-совместимых TPM в вашей среде.
Когда вы будете готовы для переключения, можно предварительно загрузить все артефакты аттестации (политики целостности кода, базовые показатели доверенного платформенного МОДУЛЯ и идентификаторы доверенного платформенного МОДУЛЯ) в HGS продолжая работу HGS аттестацию с доверием администратора.
Для этого следуйте инструкциям из [авторизации нового защищенного узла](#authorizing-new-guarded-hosts) раздел.

Вы добавили все политики для HGS, следующим шагом после выполнения попытки искусственных аттестации на узлах для просмотра, если они будет передан аттестации в режиме доверенного платформенного МОДУЛЯ.
Это не влияет на текущее состояние работоспособности HGS.
Приведенные ниже команды необходимо запустить на компьютере, который имеет доступ ко всем узлов в среде и по крайней мере один узел HGS.
Если брандмауэр или других политик безопасности избежать этого, этот шаг можно пропустить.
По возможности рекомендуется выполнять искусственные аттестации дают хороший показатель того, является ли «зеркальное отображение» в режим доверенного платформенного МОДУЛЯ приведет к простою для виртуальных машин. 

```powershell
# Get information for each host in your environment
$hostNames = 'host01.contoso.com', 'host02.contoso.com', 'host03.contoso.com'
$credential = Get-Credential -Message 'Enter a credential with admin privileges on each host'
$targets = @()
$hostNames | ForEach-Object { $targets += New-HgsTraceTarget -Credential $credential -Role GuardedHost -HostName $_ }

$hgsCredential = Get-Credential -Message 'Enter an admin credential for HGS'
$targets += New-HgsTraceTarget -Credential $hgsCredential -Role HostGuardianService -HostName 'HGS01.bastion.local'

# Initiate the synthetic attestation attempt
Get-HgsTrace -RunDiagnostics -Target $targets -Diagnostic GuardedFabricTpmMode 
```

После завершения диагностики просмотрите outputted данные для выяснения, если любые узлы, которые бы сбой аттестации в режиме доверенного платформенного МОДУЛЯ.
Повторно запустите диагностику, пока вы получите «pass» из каждого узла, а затем продолжить изменение HGS в режим доверенного платформенного МОДУЛЯ.

**Изменение в режиме TPM** принимает пару секунд для завершения.
На любом узле HGS, чтобы обновить режим аттестации, выполните следующую команду.

```powershell
Set-HgsServer -TrustTpm
```

Если возникли проблемы и необходимо вернуться в режим Active Directory, это можно сделать, выполнив `Set-HgsServer -TrustActiveDirectory`.

Когда вы убедитесь, что все работает должным образом, необходимо удалить все группы доверенных узлов Active Directory из HGS и удалить отношение доверия между доменами HGS и структуры.
Если оставить доверия Active Directory на месте, то существует риск повторное включение доверия и переключение HGS режим Active Directory, который делает возможным выполнение снят на защищенных узлов ненадежного кода.

## <a name="key-management"></a>Управление ключами
В решении защищенной структуры используются несколько пары открытого и закрытого ключей для проверки целостности различных компонентов в решении и шифровать секреты клиента.
Служба защиты узла настроено по крайней мере два сертификата (с помощью открытого и закрытого ключей), которые используются для подписывания и шифрования ключей, используемых для запуска экранированных виртуальных машин.
Эти ключи необходимо тщательное управление.
Если закрытый ключ получена злоумышленниками, они смогут unshield все виртуальные машины, работающим в вашей структуре или настраивать кластер фальшивый HGS, который использует слабый аттестации политики для обхода защиты, которые внедряемых.
Следует ли потерять закрытых ключей во время аварии и не может их найти в резервной копии, необходимо будет каждую виртуальную Машину, повторно с ключом для авторизации новых сертификатов и настройте новую пару ключей.

В этом разделе рассматриваются общие управления ключами для настройки ключей так, чтобы они функциональных и безопасной.

### <a name="adding-new-keys"></a>Добавление новых ключей
Хотя HGS должны инициализироваться с одним набором ключей, можно добавить более одного шифрования и подписывания ключа HGS.
Ниже приведены два наиболее распространенных причин, почему необходимо добавить новых ключей HGS.
1. Для поддержки «принеси свой собственный ключ» сценариев, где копирование закрытых ключей для аппаратного модуля безопасности клиентов и только разрешают их ключи запуска их экранированные виртуальные машины.
2. Чтобы заменить существующие ключи для HGS, сначала добавьте новые ключи и сохранение оба набора ключей до каждой виртуальной Машины конфигурация была обновлена для использования новых ключей.

Процесс добавления новых ключей отличается в зависимости от типа сертификата, который вы используете.

**Вариант 1. Добавление сертификата, хранящегося в аппаратный модуль безопасности**

Наши для защиты ключей HGS рекомендуется использовать сертификаты, созданные в аппаратный модуль безопасности (HSM).
Аппаратные модули безопасности убедитесь, что ключей привязан к физическому доступу к устройству важные для обеспечения безопасности в центре обработки данных.
Каждый аппаратный модуль безопасности отличается и имеет уникальный процесс для создания сертификатов и их регистрации в службе HGS.
Указанные ниже действия предназначены для сложных руководство по использованию аппаратного модуля безопасности резервные сертификаты.
В документации поставщика HSM конкретные шаги и возможности.

1. Установите программное обеспечение HSM на каждом узле HGS в кластере. В зависимости от наличия сети или локальном устройстве HSM может потребоваться настроить аппаратный модуль безопасности, предоставьте доступ к хранилищу ключей компьютера.
2. Создание сертификатов 2 в аппаратном модуле безопасности с **2048-битные ключи RSA** шифрования и цифровой подписи
    1. Создать сертификат шифрования с **шифрование данных** ключевое свойство использования в HSM
    2. Создайте сертификат для подписи с **цифровой подписи** ключевое свойство использования в HSM
3. Установите сертификаты в каждом узле HGS локального хранилища сертификатов согласно рекомендациям поставщика HSM.
4. Если HSM использует детализированные разрешения, чтобы предоставить конкретным приложениям или пользователям разрешение на использование закрытого ключа, необходимо будет предоставить доступ HGS службы групповую управляемую учетную запись к сертификату. Имя учетной записи gMSA HGS можно найти, выполнив `(Get-IISAppPool -Name KeyProtection).ProcessModel.UserName`
5. Добавьте сертификаты подписывания и шифрования в HGS, заменив отпечатки тех сертификатов в следующих командах:

    ```powershell
    Add-HgsKeyProtectionCertificate -CertificateType Encryption -Thumbprint "AABBCCDDEEFF00112233445566778899"
    Add-HgsKeyProtectionCertificate -CertificateType Signing -Thumbprint "99887766554433221100FFEEDDCCBBAA"
    ```

**Вариант 2. Добавление сертификатов неэкспортируемый программного обеспечения**

Если у вас есть программное обеспечение резервного сертификатом, выданным вашей компании или общедоступным центром сертификации недоступен для экспорта закрытого ключа, необходимо добавить сертификат на HGS, с помощью его отпечаток.
1. Установите сертификат на компьютере в соответствии с инструкциями центра сертификации.
2. Предоставьте HGS групповые управляемые службы учетной записи чтения доступ к закрытому ключу сертификата. Имя учетной записи gMSA HGS можно найти, выполнив `(Get-IISAppPool -Name KeyProtection).ProcessModel.UserName`
3. Регистрация сертификата с HGS, используя следующую команду и подстановки в отпечаток вашего сертификата (изменить *шифрования* для *подписывание* для сертификатов подписи):

    ```powershell
    Add-HgsKeyProtectionCertificate -CertificateType Encryption -Thumbprint "AABBCCDDEEFF00112233445566778899"
    ```

> [!IMPORTANT]
> Необходимо будет вручную установить закрытый ключ и предоставление доступа к управляемой учетной записи на каждом узле HGS.
> HGS нельзя автоматически реплицировать закрытые ключи для *любой* сертификат, зарегистрированный по его отпечатку.

**Вариант 3. Добавление сертификатов, хранящихся в PFX-файлы**

Если у вас есть сертификат на основе программного обеспечения с экспортируемым закрытым ключом, который можно хранить в PFX-файл и защищен паролем, HGS можно автоматически Управление сертификатами для вас.
Сертификаты, добавленные с помощью PFX-файлы, автоматически реплицируются на каждый узел кластера HGS и HGS обеспечивает безопасный доступ к закрытым ключам.
Чтобы добавить новый сертификат с помощью PFX-файл, выполните следующие команды на любом узле HGS (изменить *шифрования* для *подписывание* для сертификатов подписи):

```powershell
$certPassword = Read-Host -AsSecureString -Prompt "Provide the PFX file password"
Add-HgsKeyProtectionCertificate -CertificateType Encryption -CertificatePath "C:\temp\encryptionCert.pfx" -CertificatePassword $certPassword
```

**Определение и изменение первичные сертификаты** хотя HGS может поддерживать несколько сертификатов подписи и шифрования, он использует одну пару как его «primary» сертификаты.
Это сертификаты, которые будут использоваться, если кто-то загружает метаданные для этого кластера HGS.
Чтобы проверить, какие сертификаты в настоящее время помечены как основной сертификатов, выполните следующую команду:

```powershell
Get-HgsKeyProtectionCertificate -IsPrimary $true
```

Чтобы задать новый основной шифрования или подписи сертификата, найти отпечаток необходимый сертификат и пометить его как основной, используя следующие команды:

```powershell
Get-HgsKeyProtectionCertificate
Set-HgsKeyProtectionCertificate -CertificateType Encryption -Thumbprint "AABBCCDDEEFF00112233445566778899" -IsPrimary
Set-HgsKeyProtectionCertificate -CertificateType Signing -Thumbprint "99887766554433221100FFEEDDCCBBAA" -IsPrimary
```

### <a name="renewing-or-replacing-keys"></a>Продления или замены ключей
При создании сертификатов, используемых HGS, сертификаты будут назначаться дату окончания срока действия в соответствии с политикой центра сертификации и данные запроса.
Как правило в сценариях, где действительность этого сертификата важно, таких как защита взаимодействие по протоколу HTTP, необходимо обновить сертификаты до истечения срока действия, чтобы избежать перебоев в работе службы или вызывает тревогу сообщение.
В этом смысле HGS использует сертификаты.
HGS просто использует сертификаты для удобного создания и сохранения парой асимметричных ключей.
Шифрование с истекшим сроком действия или сертификат для подписи на HGS не указывают на слабое место или потери защиты для экранированных виртуальных машин.
Кроме того проверки отзыва сертификатов не выполняются с HGS.
Если HGS сертификат или сертификат центр выдачи отменяется, она никак не повлияет HGS использование сертификата.

Единственный случай, когда необходимо позаботиться о сертификате HGS Если у вас есть основания предполагать, что имеет свой закрытый ключ был украден.
В этом случае целостность ваши экранированные виртуальные машины подвергается риску, поскольку владение закрытый половине HGS шифрования и подписывания пары ключей достаточно, чтобы удалить экранирования средства защиты на виртуальной Машине или настроить фиктивный сервер HGS, слабый политиками аттестации.

Если вы окажетесь в такой ситуации, или необходимы стандартов соответствия приходится регулярно обновлять ключи сертификата, ниже описан процесс изменения ключей на сервер HGS.
Обратите внимание на то, что следующее руководство представляет значительным предприятием, приведет к нарушению работы службы на каждую виртуальную Машину, обслуживаемых кластера HGS.
Свести к минимуму прерывания в работе служб и обеспечить безопасность виртуальных машин клиентов требуется Продуманное планирование для изменения разделов HGS.

На узле HGS выполните следующие действия, чтобы зарегистрировать новую пару сертификаты для подписи и шифрования.
См. в разделе [Добавление новых ключей](#adding-new-keys) подробную информацию различные способы добавления новых ключей HGS.
1. Создайте новую пару шифрования и сертификат для подписи для сервер HGS. В идеальном случае они будут создаваться в аппаратный модуль безопасности.
2. Регистрация нового шифрования и подписывания сертификатов с помощью **HgsKeyProtectionCertificate добавить**

    ```powershell
    Add-HgsKeyProtectionCertificate -CertificateType Signing -Thumbprint <Thumbprint>
    Add-HgsKeyProtectionCertificate -CertificateType Encryption -Thumbprint <Thumbprint>
    ```
3. Если вы использовали отпечатки, нужно будет перейти к каждому узлу в кластере, чтобы установить закрытого ключа и предоставьте HGS групповой управляемой учетной записи доступ к ключу.
4. Сделать новые сертификаты, сертификаты по умолчанию в HGS

    ```powershell
    Set-HgsKeyProtectionCertificate -CertificateType Signing -Thumbprint <Thumbprint> -IsPrimary
    Set-HgsKeyProtectionCertificate -CertificateType Encryption -Thumbprint <Thumbprint> -IsPrimary
    ```

На этом этапе данные, созданные с помощью метаданные, полученные из узла HGS экранирования будет использовать новые сертификаты, но существующие виртуальные машины будут продолжать работать, так как более старые сертификаты будут по-прежнему существуют.
Чтобы убедиться, что все существующие виртуальные машины будут работать с новыми ключами, необходимо будет обновить предохранитель ключа на каждой виртуальной Машине.
Это действие, требующее участвует владелец виртуальной Машины (лица или сущности, владеющий защиты «владелец»).
Для каждой экранированной виртуальной Машины выполните следующие действия:
5. Завершите работу виртуальной Машины. Виртуальная машина не может быть включена пока не выполнены остальные шаги в противном случае вам потребуется начать процесс заново.
6. Сохраните текущий предохранитель ключа в файле: `Get-VMKeyProtector -VMName 'VM001' | Out-File '.\VM001.kp'`
7. Передача KP владельцу виртуальной Машины
8. Владелец Загрузка обновленной guardian информацией, полученной от HGS и импортировать его в своей локальной системы
9. Чтение текущего КЛЮЧЕВОГО в памяти, предоставлять новый доступ guardian KP и сохраните его в новый файл, выполнив следующие команды:

    ```powershell
    $kpraw = Get-Content -Path .\VM001.kp
    $kp = ConvertTo-HgsKeyProtector -Bytes $kpraw
    $newGuardian = Get-HgsGuardian -Name 'UpdatedHgsGuardian'
    $updatedKP = Grant-HgsKeyProtectorAccess -KeyProtector $kp -Guardian $newGuardian
    $updatedKP.RawData | Out-File .\updatedVM001.kp
    ```
10. Копирование обновленных KP в структуре размещения
11. Применить KP на исходной виртуальной машине:

   ```powershell
   $updatedKP = Get-Content -Path .\updatedVM001.kp
   Set-VMKeyProtector -VMName VM001 -KeyProtector $updatedKP
   ```
12. Наконец запустите виртуальную Машину и убедитесь, что он выполняется успешно.

> [!NOTE]
> Если владелец виртуальной Машины задает неверные предохранитель на виртуальной Машине и не дает матрицы для запуска виртуальной Машины, можно не удалось запустить архивацию экранированной виртуальной Машины.
> Чтобы вернуться к последней известной хорошей предохранителя ключа, выполните `Set-VMKeyProtector -RestoreLastKnownGoodKeyProtector`

После обновления всех виртуальных машин для авторизации новые ключи защиты можно отключить и удалить старые ключи.

13. Получить отпечатки старые сертификаты из `Get-HgsKeyProtectionCertificate -IsPrimary $false`

14. Отключите каждый сертификат, выполнив следующие команды:  

   ```powershell
   Set-HgsKeyProtectionCertificate -CertificateType Signing -Thumbprint <Thumbprint> -IsEnabled $false
   Set-HgsKeyProtectionCertificate -CertificateType Encryption -Thumbprint <Thumbprint> -IsEnabled $false
   ```

15. Убедившись, что виртуальные машины по-прежнему можете начать с сертификаты отключена, удалите сертификаты с HGS, выполнив следующие команды:

   ```powershell
   Remove-HgsKeyProtectionCertificate -CertificateType Signing -Thumbprint <Thumbprint>`
   Remove-HgsKeyProtectionCertificate -CertificateType Encryption -Thumbprint <Thumbprint>`
   ```

> [!IMPORTANT]
> Резервные копии виртуальных Машин будет содержать старые сведения о предохранитель ключа, который допускает старые сертификаты, которые должны использоваться для запуска виртуальной Машины.
> Если вам известно, что ваш закрытый ключ был скомпрометирован, следует предполагать, что может быть нарушена, кроме того, резервные копии виртуальных Машин и предпринять соответствующие действия.
> Уничтожение конфигурацию виртуальной Машины из резервных копий (.vmcx) приведет к удалению предохранители ключа, за счет необходимости использовать пароль восстановления BitLocker для загрузки виртуальной Машины в следующий раз.

### <a name="key-replication-between-nodes"></a>Репликации между узлами
Каждый узел в кластере HGS должен быть настроен с тем же шифрование, подписи и (при настройке) SSL-сертификаты.
Это необходимо, чтобы убедиться, что присоединились к одному из узлов в кластере узлов Hyper-V может иметь свои запросы, обслуживаемые успешно.

**Если вы инициализировать сервер HGS с сертификаты на основе PFX** то HGS автоматически реплицирует открытого и закрытого ключей этих сертификатов на каждом узле в кластере.
Необходимо только добавить ключи на одном узле.

**Если инициализировать сервер HGS с помощью ссылки на сертификат** или отпечатки, а затем HGS позволит выполнить репликацию только *открытый* ключа в сертификате для каждого узла.
Кроме того, сам не может предоставить HGS доступ к закрытому ключу на любом узле в этом сценарии.
Таким образом это необходимо:
1. Установить закрытый ключ на каждом узле HGS
2. Предоставьте HGS групповые управляемые службы групповой управляемой учетной записи доступ к закрытый ключ на каждом узле этих задач добавьте дополнительные рабочие нагрузки, однако они необходимы для ключей из аппаратного модуля безопасности и сертификаты с закрытыми ключами, не экспортируются.

**SSL-сертификаты** никогда не реплицируются в любой форме.
Это необходимо инициализировать каждый сервер HGS тем же сертификатом SSL и обновить каждый сервер, каждый раз, когда вы решили продлить или заменить сертификат SSL.
При замене SSL-сертификат, рекомендуется сделать с помощью [HgsServer набора](https://technet.microsoft.com/library/mt652180.aspx) командлета.

## <a name="unconfiguring-hgs"></a>Отмены настройки HGS

Если требуется вывод из эксплуатации или значительно перенастроить сервер HGS, можно сделать с помощью [Clear-HgsServer](https://technet.microsoft.com/library/mt652176.aspx) или [HgsServer удаления](https://technet.microsoft.com/library/mt652182.aspx) командлетов.

### <a name="clearing-the-hgs-configuration"></a>Очистка конфигурации HGS

Чтобы удалить узел из кластера HGS, используйте [Clear HgsServer](https://technet.microsoft.com/library/mt652176.aspx) командлета.
Этот командлет будет внести следующие изменения на сервере, где он выполняется:

- Отменяет регистрацию служб защиты аттестации и ключ
- Удаляет конечную точку управления JEA «microsoft.windows.hgs»
- Удаляет локальный компьютер из отказоустойчивого кластера HGS

Если сервер является последним HGS узлом кластера, кластер и его соответствующего ресурса имени распределенной сети также будут уничтожены.

```powershell
# Removes the local computer from the HGS cluster
Clear-HgsServer
```

После завершения операции очистки, сервер HGS, может быть повторной инициализации с [Initialize HgsServer](https://technet.microsoft.com/library/mt652185.aspx).
Если вы использовали [установки HgsServer](https://technet.microsoft.com/library/mt652169.aspx) Чтобы настроить домен доменных служб Active Directory, этот домен будет оставаться настройки и работоспособности после операции очистки.

### <a name="uninstalling-hgs"></a>При удалении HGS

Если вы хотите удалить узел из кластера HGS **и** понизить роль контроллера домена Active Directory в ней выполняются, используйте [HgsServer удаления](https://technet.microsoft.com/library/mt652182.aspx) командлета.
Этот командлет будет внести следующие изменения на сервере, где он выполняется:

- Отменяет регистрацию служб защиты аттестации и ключ
- Удаляет конечную точку управления JEA «microsoft.windows.hgs»
- Удаляет локальный компьютер из отказоустойчивого кластера HGS
- Если настроен, можно понизить уровень контроллера домена Active Directory

Если сервер является последний узел HGS в кластере, домен, отказоустойчивого кластера и ресурса имени распределенной сети кластера также будут уничтожены.

```powershell
# Removes the local computer from the HGS cluster and demotes the ADDC (restart required)
$newLocalAdminPassword = Read-Host -AsSecureString -Prompt "Enter a new password for the local administrator account"
Uninstall-HgsServer -LocalAdministratorPassword $newLocalAdminPassword -Restart
```

После завершения операции удаления, и компьютер был перезагружен, можно переустановить Контроллеру и HGS с помощью [установки HgsServer](https://technet.microsoft.com/library/mt652169.aspx) или присоединить компьютер к домену и инициализировать сервер HGS в этом домене с [ Initialize-HgsServer](https://technet.microsoft.com/library/mt652185.aspx).

Если вы больше не планируете использовать компьютер в качестве узла HGS, можно удалить роль из Windows.

```powershell
Uninstall-WindowsFeature HostGuardianServiceRole
```
