---
title: Запись сведений о режиме TPM, необходимых для HGS
ms.prod: windows-server
ms.topic: article
ms.assetid: 915b1338-5085-481b-8904-75d29e609e93
manager: dongill
author: rpsqrd
ms.author: ryanpu
ms.technology: security-guarded-fabric
ms.date: 04/01/2019
ms.openlocfilehash: 480901321b53adb03cc44f7e8b7c597c77404c90
ms.sourcegitcommit: b00d7c8968c4adc8f699dbee694afe6ed36bc9de
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/08/2020
ms.locfileid: "80856427"
---
# <a name="authorize-guarded-hosts-using-tpm-based-attestation"></a>Авторизация защищенных узлов с помощью аттестации на основе TPM

>Область применения: Windows Server 2019, Windows Server (половина ежегодного канала), Windows Server 2016

В режиме TPM используется идентификатор TPM (также называемый идентификатором платформы или ключом подтверждения \[Екпуб\]), чтобы определить, является ли конкретный узел полномочным "защищенным". В этом режиме аттестации используется безопасная загрузка и целостность кода, чтобы гарантировать, что данный узел Hyper-V находится в работоспособном состоянии и выполнял только доверенный код. Чтобы аттестация понимала, что и является неработоспособным, необходимо записать следующие артефакты:

1.  Идентификатор доверенного платформенного модуля (Екпуб)

    -  Эти сведения уникальны для каждого узла Hyper-V.

2.  Базовый модуль TPM (измерения загрузки)

    -  Это относится ко всем узлам Hyper-V, которые работают на одном и том же классе оборудования.

3.  Политика целостности кода (список разрешений разрешенных двоичных файлов)

    -  Это применимо ко всем узлам Hyper-V с общим оборудованием и программным обеспечением

Рекомендуется записать базовые политики и политику CI с узла "эталонный узел", который представляет собой каждый уникальный класс конфигурации оборудования Hyper-V в центре обработки данных. Начиная с Windows Server версии 1709, примеры политик CI включены в К:\виндовс\счемас\кодеинтегрити\ексамплеполиЦиес. 

## <a name="versioned-attestation-policies"></a>Политики аттестации с управлением версиями

В Windows Server 2019 появился новый метод аттестации, именуемый *аттестацией v2*, где должен присутствовать сертификат TPM, чтобы добавить ЕКПУБ в HGS. Метод аттестации v1, используемый в Windows Server 2016, позволял вам переопределить эту проверку безопасности, указав флаг-force при выполнении командлетов Add-Хгсаттестатионтпмхост или другого модуля аттестации TPM для записи артефактов. Начиная с Windows Server 2019, аттестация v2 используется по умолчанию. при выполнении командлета Add-Хгсаттестатионтпмхост необходимо указать флаг-PolicyVersion v1, если необходимо зарегистрировать доверенный платформенный модуль без сертификата. Флаг-force не работает при аттестации v2. 

Узел может подтвердить, что все артефакты (Екпуб + базовый модуль TPM + политика CI) используют одну и ту же версию аттестации. Сначала выполняется попытка аттестации v2. Если это не удается, используется аттестация v1. Это означает, что если вам нужно зарегистрировать идентификатор доверенного платформенного модуля с помощью аттестации v1, необходимо также указать флаг-PolicyVersion v1, чтобы использовать аттестацию v1 при записи базового модуля TPM и создании политики CI. Если базовые показатели TPM и политика CI были созданы с помощью аттестации v2, а затем необходимо добавить защищенный узел без сертификата доверенного платформенного модуля, необходимо повторно создать каждый артефакт с флагом-PolicyVersion v1. 

## <a name="capture-the-tpm-identifier-platform-identifier-or-ekpub-for-each-host"></a>Запишите идентификатор доверенного платформенного модуля (идентификатор платформы или Екпуб) для каждого узла.

1.  В домене структуры убедитесь, что доверенный платформенный модуль на каждом узле готов к использованию, то есть инициализируется и получает владение TPM. Чтобы проверить состояние доверенного платформенного модуля, откройте консоль управления TPM (TPM. msc) или запустите **Get-TPM** в окне Windows PowerShell с повышенными привилегиями. Если доверенный платформенный модуль не находится в состоянии **готовности** , его необходимо инициализировать и установить его владение. Это можно сделать в консоли управления TPM или с помощью команды **Initialize-TPM**.

2.  На каждом защищенном узле выполните следующую команду в консоли Windows PowerShell с повышенными привилегиями, чтобы получить его Екпуб. Для `<HostName>`замените уникальное имя узла на другое, которое подходит для этого узла. это может быть имя узла или название, используемое службой "Инвентаризация структуры" (если доступно). Для удобства назовите выходной файл, используя имя узла.

    ```powershell
    (Get-PlatformIdentifier -Name '<HostName>').InnerXml | Out-file <Path><HostName>.xml -Encoding UTF8
    ```
3.  Повторите предыдущие шаги для каждого узла, который станет защищенным узлом, и убедитесь, что каждому XML-файлу присвоено уникальное имя.

4.  Предоставьте результирующие XML-файлы администратору HGS.

5.  В домене HGS откройте консоль Windows PowerShell с повышенными привилегиями на сервере HGS и выполните следующую команду. Повторите команду для каждого из XML-файлов.

    ```powershell
    Add-HgsAttestationTpmHost -Path <Path><Filename>.xml -Name <HostName>
    ```

    > [!NOTE]
    > Если при добавлении идентификатора TPM к сертификату ненадежного ключа подтверждения (Екцерт) возникает ошибка, убедитесь, что [корневые сертификаты доверенного платформенного модуля были добавлены](guarded-fabric-install-trusted-tpm-root-certificates.md) в узел HGS.
    > Кроме того, некоторые поставщики TPM не используют Екцертс.
    > Чтобы проверить, отсутствует ли Екцерт, Откройте XML-файл в редакторе, таком как Блокнот, и проверьте сообщение об ошибке, указывающее, что Екцерт не найден.
    > Если это так и вы доверяете доверенному платформенному модулю на компьютере, можно использовать параметр `-Force`, чтобы добавить идентификатор узла в HGS. В Windows Server 2019 при использовании `-Force`также необходимо использовать параметр `-PolicyVersion v1`. При этом создается политика, которая согласуется с поведением Windows Server 2016, и потребуется использовать `-PolicyVersion v1` при регистрации политики CI и базового модуля TPM.

## <a name="create-and-apply-a-code-integrity-policy"></a>Создание и применение политики целостности кода

Политика целостности кода гарантирует, что только исполняемые файлы, которым вы доверяете, могут выполняться на узле. Запуск вредоносных программ и других исполняемых файлов за пределами доверенных исполняемых файлов не выполняется.

Для запуска экранированных виртуальных машин в режиме TPM для каждого защищенного узла должна быть применена политика целостности кода. Вы указываете точные доверенные политики целостности кода, добавив их в HGS. Политики целостности кода могут быть настроены для принудительного применения политики, блокирования любого программного обеспечения, которое не соответствует политике, или просто аудита (регистрация события при выполнении программ, не определенных в политике). 

Начиная с Windows Server версии 1709, примеры политик целостности кода включены в Windows по адресу К:\виндовс\счемас\кодеинтегрити\ексамплеполиЦиес. Для Windows Server рекомендуется использовать две политики:

- **Алловмикрософт**: разрешает все файлы, подписанные корпорацией Майкрософт. Эта политика рекомендуется для серверных приложений, таких как SQL или Exchange, или если сервер отслеживается агентами, опубликованными корпорацией Майкрософт.
- **DefaultWindows_Enforced**: разрешает только файлы, поставляемые в Windows, и не разрешает другие приложения, выпускаемые корпорацией Майкрософт, например Office. Эта политика рекомендуется для серверов, на которых выполняются только встроенные серверные роли и функции, такие как Hyper-V. 

Рекомендуется сначала создать политику CI в режиме аудита (ведения журнала), чтобы узнать, не пропущен ли какой-либо объект, а затем применить политику для рабочих нагрузок узла. 

При использовании командлета [New-Циполици](https://docs.microsoft.com/powershell/module/configci/new-cipolicy?view=win10-ps) для создания собственной политики целостности кода необходимо выбрать уровни правил, которые будут использоваться. Рекомендуется использовать основной уровень **издателя** с возвратом к **хэшу**, что позволяет обновлять большинство программ с цифровой подписью без изменения политики непрерывной интеграции.
Новое программное обеспечение, написанное на том же издателе, также может быть установлено на сервере без изменения политики CI.
Хэш-файлы, не имеющие цифровой подписи, будут хэшированы. для обновления этих файлов потребуется создать новую политику CI.
Дополнительные сведения о доступных уровнях правил политики CI см. в разделе [развертывание политик целостности кода: правила политики и правила для файлов](https://docs.microsoft.com/windows/security/threat-protection/windows-defender-application-control/select-types-of-rules-to-create#windows-defender-application-control-policy-rules) и Справка по командлетам.

1.  На узле-образце создайте новую политику целостности кода. Следующие команды создают политику на уровне **издателя** с применением отката к **хэшу**. Затем XML-файл преобразуется в формат двоичного файла Windows, а для HGS необходимо применить и измерить политику CI соответственно.

    ```powershell
    New-CIPolicy -Level Publisher -Fallback Hash -FilePath 'C:\temp\HW1CodeIntegrity.xml' -UserPEs

    ConvertFrom-CIPolicy -XmlFilePath 'C:\temp\HW1CodeIntegrity.xml' -BinaryFilePath 'C:\temp\HW1CodeIntegrity.p7b'
    ```

    >[!NOTE]
    >Приведенная выше команда создает политику CI только в режиме аудита. Он не блокирует запуск несанкционированных двоичных файлов на узле. В рабочей среде должны использоваться только принудительные политики.

2.  Сохраните файл политики целостности кода (XML-файл), где его можно легко найти. Этот файл потребуется изменить позже, чтобы применить политику CI или объединить изменения, внесенные в будущие обновления системы.

3.  Примените политику CI к эталонному узлу:

    1.  Выполните следующую команду, чтобы настроить компьютер для использования политики CI. Можно также развернуть политику CI с помощью [Групповая политика](https://docs.microsoft.com/windows/security/threat-protection/windows-defender-application-control/deploy-windows-defender-application-control-policies-using-group-policy) или [System Center Virtual Machine Manager](https://docs.microsoft.com/system-center/vmm/guarded-deploy-host?view=sc-vmm-2019#manage-and-deploy-code-integrity-policies-with-vmm).

        ```powershell
        Invoke-CimMethod -Namespace root/Microsoft/Windows/CI -ClassName PS_UpdateAndCompareCIPolicy -MethodName Update -Arguments @{ FilePath = "C:\temp\HW1CodeIntegrity.p7b" }
        ```

    2.  Перезапустите узел, чтобы применить политику.

3.  Протестируйте политику целостности кода, выполнив типичную рабочую нагрузку. Это могут быть выполняющиеся виртуальные машины, агенты управления Fabric, агенты резервного копирования или средства устранения неполадок на компьютере. Проверьте наличие нарушений целостности кода и при необходимости обновите политику CI.

4.  Измените политику CI на принудительный режим, выполнив следующие команды в обновленном XML-файле политики CI.

    ```powershell
    Set-RuleOption -FilePath 'C:\temp\HW1CodeIntegrity.xml' -Option 3 -Delete

    ConvertFrom-CIPolicy -XmlFilePath 'C:\temp\HW1CodeIntegrity.xml' -BinaryFilePath 'C:\temp\HW1CodeIntegrity_enforced.p7b'
    ```

5.  Примените политику CI ко всем узлам (с одинаковой конфигурацией оборудования и программного обеспечения) с помощью следующих команд:

    ```powershell
    Invoke-CimMethod -Namespace root/Microsoft/Windows/CI -ClassName PS_UpdateAndCompareCIPolicy -MethodName Update -Arguments @{ FilePath = "C:\temp\HW1CodeIntegrity.p7b" }
    
    Restart-Computer
    ```

    >[!NOTE]
    >Будьте внимательны при применении политик CI к узлам и при обновлении любого программного обеспечения на этих компьютерах. Любые драйверы режима ядра, которые не соответствуют политике CI, могут препятствовать запуску компьютера. 

6.  Укажите двоичный файл (в этом примере HW1CodeIntegrity\_принудительно. p7b) для администратора HGS.

7.  В домене HGS Скопируйте политику целостности кода на сервер HGS и выполните следующую команду.

    Для `<PolicyName>`укажите имя для политики CI, описывающее тип узла, к которому она применяется. Рекомендуется присвоить ей имя после создания или модели компьютера, а также выполнить на нем специальную конфигурацию программного обеспечения.<br>Для `<Path>`укажите путь и имя файла политики целостности кода.

    ```powershell
    Add-HgsAttestationCIPolicy -Path <Path> -Name '<PolicyName>'
    ```

## <a name="capture-the-tpm-baseline-for-each-unique-class-of-hardware"></a>Запишите базовые показатели TPM для каждого уникального класса оборудования.

Базовый модуль TPM необходим для каждого уникального класса оборудования в структуре центра обработки данных. Снова используйте "эталонный узел". 

1. На узле-образце убедитесь, что установлена роль Hyper-V и компонент поддержки Hyper-V для защиты узла.

    >[!WARNING]
    >Функция поддержки защиты узла Hyper-V обеспечивает защиту целостности кода на основе виртуализации, которая может быть несовместима с некоторыми устройствами. Настоятельно рекомендуется проверить эту конфигурацию в лаборатории, прежде чем включать эту функцию. В противном случае могут возникать непредвиденные ошибки, в том числе потеря данных или системная ошибки (STOP-ошибка).

    ```powershell
    Install-WindowsFeature Hyper-V, HostGuardian -IncludeManagementTools -Restart
    ```
        
2. Чтобы записать базовую политику, выполните следующую команду в консоли Windows PowerShell с повышенными привилегиями.
        
    ```powershell
    Get-HgsAttestationBaselinePolicy -Path 'HWConfig1.tcglog'
    ```

    >[!NOTE]
    >Необходимо использовать флаг **-скипвалидатион** , если на эталонном узле не включена безопасная загрузка, существует IOMMU, включена и запущена безопасность на основе виртуализации или применена политика целостности кода. Эти проверки предназначены для того, чтобы знать о минимальных требованиях к запуску экранированной виртуальной машины на узле. Использование флага-Скипвалидатион не приводит к изменению выходных данных командлета. Это просто отменяет ошибки.

3.  Укажите Базовый доверенный платформенный модуль (файл Ткглог) для администратора HGS.

4.  В домене HGS скопируйте файл Ткглог на сервер HGS и выполните следующую команду. Как правило, политика будет названа после класса оборудования, который она представляет (например, «редакция модели изготовителя»).

    ```powershell
    Add-HgsAttestationTpmPolicy -Path <Filename>.tcglog -Name '<PolicyName>'
    ```

## <a name="next-step"></a>Дальнейшие действия

> [!div class="nextstepaction"]
> [Подтверждение аттестации](guarded-fabric-confirm-hosts-can-attest-successfully.md)
