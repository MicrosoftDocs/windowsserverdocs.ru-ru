---
title: Записать сведения о режиме доверенного платформенного МОДУЛЯ, требующегося HGS
ms.custom: na
ms.prod: windows-server-threshold
ms.topic: article
ms.assetid: 915b1338-5085-481b-8904-75d29e609e93
manager: dongill
author: rpsqrd
ms.technology: security-guarded-fabric
ms.date: 12/12/2018
ms.openlocfilehash: 82171eee10a06cad6bb3ac30e8f771086975c242
ms.sourcegitcommit: 0d0b32c8986ba7db9536e0b8648d4ddf9b03e452
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2019
ms.locfileid: "59841665"
---
# <a name="authorize-guarded-hosts-using-tpm-based-attestation"></a>Авторизовать защищенных узлов, с помощью аттестации на основе доверенного платформенного МОДУЛЯ

>Относится к: Windows Server 2019 г., Windows Server (полугодовой канал), Windows Server 2016

Режим доверенный платформенный модуль использует идентификатор доверенного платформенного МОДУЛЯ (также называется ключом идентификатор или подтверждения платформы \[EKpub\]) начинается определению, авторизован ли определенного узла, как «защищенный». Этот режим аттестации использует целостность измерения безопасной загрузки и кода для данного узла Hyper-V в работоспособном состоянии и выполняется только полностью доверенный код. Чтобы аттестации понять, что и находится в нерабочем состоянии должно записать следующие артефакты:

1.  Идентификатор доверенного платформенного МОДУЛЯ (EKpub)

    -  Эта информация является уникальным для каждого узла Hyper-V

2.  Базовые доверенного платформенного МОДУЛЯ (измерения загрузки)

    -  Это распространяется на все узлы Hyper-V, работающих на том же классе оборудования

3.  Политика целостности кода (белый список разрешенных двоичных файлов)

    -  Это распространяется на все узлы Hyper-V, которые совместно используют общие оборудования и программного обеспечения

Рекомендуется перехватывать базовые показатели и политика целостности кода из «узел ссылки» то есть представитель каждого класса уникальные конфигурации оборудования Hyper-V в вашем центре обработки данных. Начиная с Windows Server версии 1709, политики целостности кода примера взимается C:\Windows\schemas\CodeIntegrity\ExamplePolicies. 

## <a name="versioned-attestation-policies"></a>Политики с версиями аттестации

Windows Server 2019 появился новый метод для аттестации, вызывается *аттестации v2*, где сертификат доверенного платформенного МОДУЛЯ необходим для добавления EKPub HGS. Метод аттестации v1, используемый в Windows Server 2016 позволяет переопределить такую проверку, указав - флаг Force при выполнении добавить HgsAttestationTpmHost или других командлетов аттестации доверенного платформенного МОДУЛЯ для записи артефакты. Начиная с Windows Server 2019, по умолчанию используется v2 аттестации и необходимо указать флаг v1 - PolicyVersion при запуске HgsAttestationTpmHost добавить, если вам необходимо зарегистрировать доверенного платформенного МОДУЛЯ без сертификата. Force, флаг не работает с аттестации v2. 

Узел подтвердят только в том случае, если все артефакты (EKPub + доверенного платформенного МОДУЛЯ baseline + политика целостности кода) используют ту же версию аттестации. Используется первым аттестации v2, и используется в случае неудачи аттестации v1. Это означает, что если необходимо зарегистрировать идентификатор доверенного платформенного МОДУЛЯ с помощью аттестации v1, необходимо также указать флаг v1 - PolicyVersion для аттестации v1 при сборе базового доверенного платформенного МОДУЛЯ и создать политики целостности кода. Если базовые доверенного платформенного МОДУЛЯ и политика целостности кода были созданы с помощью аттестации версии 2 и более поздней версии необходимо добавить защищенный узел без сертификата доверенного платформенного МОДУЛЯ, необходимо для повторного создания артефакта с флагом - PolicyVersion v1. 

## <a name="capture-the-tpm-identifier-platform-identifier-or-ekpub-for-each-host"></a>Записать идентификатор доверенного платформенного МОДУЛЯ (идентификатор платформы или EKpub) для каждого узла

1.  В домене fabric убедитесь, что доверенный платформенный модуль на каждом узле будет готов к использованию — то есть инициализации доверенного платформенного МОДУЛЯ и получить права владения. Состояние доверенного платформенного модуля можно проверить, открыв консоль управления TPM (tpm.msc) или запустив **Get-Tpm** в окне Windows PowerShell с повышенными привилегиями. Если доверенный платформенный модуль не находится в **готовы** state, необходимо инициализировать его и установить его владельца. Это можно сделать в консоли управления доверенным платформенным Модулем или запустив **инициализации Tpm**.

2.  На каждого защищенного узла выполните следующую команду в консоль Windows PowerShell с повышенными правами для получения его EKpub. Для `<HostName>`, замените уникальное имя узла с чем-то подходящее для определения этого узла — это может быть имя его узла или имя, используемое службой инвентаризации fabric (если доступно). Для удобства имя выходного файла, используя имя узла.

    ```powershell
    (Get-PlatformIdentifier -Name '<HostName>').InnerXml | Out-file <Path><HostName>.xml -Encoding UTF8
    ```
3.  Повторите предыдущие шаги для каждого узла, который должен стать защищенного узла, убедитесь, что для предоставления уникального имени каждого XML-файл.

4.  Итоговые файлы XML должен предоставьте администратор службы защиты узла.

5.  В домене HGS откройте консоль Windows PowerShell с повышенными привилегиями на сервере HGS и выполните следующую команду. Выполните команду для каждого из файлов XML.

    ```powershell
    Add-HgsAttestationTpmHost -Path <Path><Filename>.xml -Name <HostName>
    ```

    > [!NOTE]
    > Если возникает ошибка при добавлении идентификатора доверенного платформенного МОДУЛЯ в отношении недоверенного сертификата ключа подтверждения (EKCert), убедитесь, что [доверенные корневые сертификаты доверенного платформенного МОДУЛЯ были добавлены](guarded-fabric-install-trusted-tpm-root-certificates.md) к узлу HGS.
    > Кроме того некоторые поставщики доверенного платформенного МОДУЛЯ не используйте EKCerts.
    > Вы можете проверить, если EKCert отсутствует, откройте XML-файл в редакторе, например Блокноте, и проверка наличия сообщение об ошибке, указывающее, не EKCert был найден.
    > Если это так, и подлинность доверенного платформенного МОДУЛЯ на компьютере, можно использовать `-Force` параметр для добавления идентификатора узла HGS. В Windows Server 2019, необходимо также использовать `-PolicyVersion v1` при использовании командлета `-Force`. Это создает политику в соответствии с поведением Windows Server 2016 и потребуется использовать `-PolicyVersion v1` при регистрации оценка базовых показателей доверенного платформенного МОДУЛЯ и политика целостности кода.

## <a name="create-and-apply-a-code-integrity-policy"></a>Создание и применение политики целостности кода

Политика целостности кода гарантирует, что разрешено выполнение только исполняемые файлы, которым вы доверяете для запуска на узле. Запуск запрещен вредоносного программного обеспечения и другие исполняемые объекты за пределами доверенных исполняемых файлов.

Каждый защищенный узел должен иметь политику целостности кода, который применяется для запуска экранированных виртуальных машин в режиме доверенного платформенного МОДУЛЯ. Можно указать политики целостности кода на точное, которым вы доверяете, добавив их HGS. Политики целостности кода можно настроить для применения политики, блокирует любое программное обеспечение, не соответствующих политике, или просто аудита (журнал событие при выполнении программного обеспечения, не определенные в политике). 

Начиная с Windows Server версии 1709, политики целостности кода образца входят в состав Windows в C:\Windows\schemas\CodeIntegrity\ExamplePolicies. Для Windows Server рекомендуется использовать две политики:

- **AllowMicrosoft**: Разрешает все файлы, подписанные Майкрософт. Рекомендуется использовать эту политику для серверных приложений, таких как SQL или Exchange, или если сервер отслеживается агентов, опубликованные корпорацией Майкрософт.
- **DefaultWindows_Enforced**: Разрешает только те файлы, которые поставляются в Windows и не разрешает использование других приложений, выпускаемых корпорацией Майкрософт, таких как Office. Эта политика рекомендуется для серверов, работающих только встроенных ролей и компонентов, таких как Hyper-V. 

Рекомендуется, что вы сначала создать политики целостности кода в режиме аудита (Ведение журнала), чтобы увидеть, если он отсутствует, ничего, а затем применить политику для производственных рабочих нагрузок узла. 

Если вы используете [New CIPolicy](https://docs.microsoft.com/powershell/module/configci/new-cipolicy?view=win10-ps) командлет для создания собственных политика целостности кода, вам будет нужно решить уровней правила для использования. Мы рекомендуем основной уровень **издателя** с резервным подключением **хэш**, что позволяет наиболее цифровой подписи программного обеспечения обновления без изменения политики целостности кода.
Новый программное обеспечение, издателем, можно также установить на сервере без изменения политики целостности кода.
Исполняемые файлы, которые не имеют цифровой подписи, будет хэшироваться--обновления для этих файлов нужно будет создать новую политику непрерывной Интеграции.
Дополнительные сведения о доступных уровней правила политики непрерывной Интеграции, см. в разделе [развертывание политики целостности кода: правила политики и правил файлов](https://docs.microsoft.com/windows/security/threat-protection/windows-defender-application-control/select-types-of-rules-to-create#windows-defender-application-control-policy-rules) и справку по командлетам.

1.  На узле ссылки создайте политику целостности кода. Следующие команды создают политику на **издателя** уровня с резервным подключением **хэш**. Затем XML-файла преобразуется двоичный формат, который Windows и HGS должны применять и измерить политики CI, соответственно.

    ```powershell
    New-CIPolicy -Level Publisher -Fallback Hash -FilePath 'C:\temp\HW1CodeIntegrity.xml' -UserPEs

    ConvertFrom-CIPolicy -XmlFilePath 'C:\temp\HW1CodeIntegrity.xml' -BinaryFilePath 'C:\temp\HW1CodeIntegrity.p7b'
    ```

    >[!NOTE]
    >Приведенная выше команда создает политику непрерывной Интеграции в только в режиме аудита. Он не будет блокировать несанкционированного двоичные файлы из работающих на узле. Принятыми политиками следует использовать только в рабочей среде.

2.  Сохраните файл политики целостности кода (XML-файл), где вы можете легко найти. Необходимо изменить этот файл, более позднюю версию для применения политики целостности кода или слиянием изменения, внесенные будущие обновления, внесенные в систему.

3.  Применяются политики целостности кода узел ссылки.

    1.  Скопируйте двоичный файл политики CI (HW1CodeIntegrity.p7b) в следующее расположение на узле ссылки (имя файла должно совпадать):<br>
        **C:\\Windows\\System32\\CodeIntegrity\\SIPolicy.p7b**

    2.  Перезапустите узел, чтобы применить политику.

3.  Проверьте политику целостности кода, запустив типичную рабочую нагрузку. Сюда могут входить работающих виртуальных машин, любой структуры управления агенты, агенты резервного копирования, или средства на компьютере для устранения неполадок. Проверьте наличие любых нарушений целостности кода и обновлять ваши политики целостности кода, при необходимости.

4.  Измените политику CI принудительно режим, выполнив следующие команды для обновленной политики XML-файл непрерывной Интеграции.

    ```powershell
    Set-RuleOption -FilePath 'C:\temp\HW1CodeIntegrity.xml' -Option 3 -Delete

    ConvertFrom-CIPolicy -XmlFilePath 'C:\temp\HW1CodeIntegrity.xml' -BinaryFilePath 'C:\temp\HW1CodeIntegrity_enforced.p7b'
    ```

5.  Применить политику непрерывной Интеграции на всех узлах (с одинаковой конфигурацией оборудования и программного обеспечения), используя следующие команды:

    ```powershell
    Copy-Item -Path '<Path to HW1CodeIntegrity\_enforced.p7b>' -Destination 'C:\Windows\System32\CodeIntegrity\SIPolicy.p7b'

    Restart-Computer
    ```

    >[!NOTE]
    >Будьте внимательны при применении политики целостности кода на узлах и при обновлении любого программного обеспечения на этих машинах. Все драйверы режима ядра, которые не соответствуют политике CI может запретить запуск машины. 

6.  Укажите двоичный файл (в этом примере HW1CodeIntegrity\_enforced.p7b) для администратора HGS.

7.  В домене HGS скопируйте политику целостности кода на сервер HGS и выполните следующую команду.

    Для `<PolicyName>`, укажите имя для политики CI, описывающее тип узла, он применяется к. Рекомендуется присвоить ей имя изготовитель и модель компьютера и конфигурации любое специальное программное обеспечение, запустить его.<br>Для `<Path>`, укажите путь и имя политики целостности кода.

    ```powershell
    Add-HgsAttestationCIPolicy -Path <Path> -Name '<PolicyName>'
    ```

## <a name="capture-the-tpm-baseline-for-each-unique-class-of-hardware"></a>Записать базовые доверенного платформенного МОДУЛЯ для каждого уникального класса оборудования

Базовые показатели доверенного платформенного МОДУЛЯ является обязательным для каждого уникального класса оборудования в структуре центра обработки данных. Используйте «узел ссылки» еще раз. 

1. На узле ссылки убедитесь, что установлена роль Hyper-V и компонент поддержку защиты узла Hyper-V.

    >[!WARNING]
    >Поддержку защиты узла Hyper-V позволяет на базе технологии виртуализации защиты целостности кода, который может быть несовместим с некоторыми устройствами. Мы настоятельно рекомендуем, протестировать эту конфигурацию в лабораторных условиях перед включением этой функции. В противном случае могут возникать непредвиденные ошибки, в том числе потеря данных или системная ошибки (STOP-ошибка).

    ```powershell
    Install-WindowsFeature Hyper-V, HostGuardian -IncludeManagementTools -Restart
    ```
        
2. Чтобы записать базовая политика, выполните следующую команду в консоль Windows PowerShell с повышенными привилегиями.
        
    ```powershell
    Get-HgsAttestationBaselinePolicy -Path 'HWConfig1.tcglog'
    ```

    >[!NOTE]
    >Необходимо будет использовать **- SkipValidation** флаг, если узел ссылки не является безопасная загрузка включена, IOMMU присутствует, безопасностью на основе виртуализации и выполнение и применения политики целостности кода. Эти проверки предназначены для уведомить о минимальным требованиям работающих экранированной виртуальной Машины на узле. С помощью флага - SkipValidation не приводит к изменению выходные данные командлета; он просто останавливает ошибки.

3.  Предоставьте администратору HGS базового доверенного платформенного МОДУЛЯ (TCGlog файл).

4.  В домене HGS скопируйте файл TCGlog развернутый сервер HGS и выполните следующую команду. Как правило будет имя политики после класса оборудования, которое она представляет (например, «Изготовитель модели редакция»).

    ```powershell
    Add-HgsAttestationTpmPolicy -Path <Filename>.tcglog -Name '<PolicyName>'
    ```

## <a name="next-step"></a>Дальнейшие действия

>[!div class="nextstepaction"]
[Подтвердите аттестации](guarded-fabric-confirm-hosts-can-attest-successfully.md)
