---
title: Создание экранированных Linux диск шаблона виртуальной Машины
ms.custom: na
ms.prod: windows-server-threshold
ms.topic: article
ms.assetid: d0e1d4fb-97fc-4389-9421-c869ba532944
manager: dongill
author: rpsqrd
ms.technology: security-guarded-fabric
ms.date: 08/29/2018
ms.openlocfilehash: e791d18e027e5e3e1c5b9c52659641ff588a96a2
ms.sourcegitcommit: 0d0b32c8986ba7db9536e0b8648d4ddf9b03e452
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2019
ms.locfileid: "59858675"
---
# <a name="create-a-linux-shielded-vm-template-disk"></a>Создание экранированных Linux диск шаблона виртуальной Машины

> Область применения. Windows Server 2019, Windows Server (Semi-Annual Channel) 

В этом разделе объясняется, как подготовить диск шаблона для экранированные виртуальные машины, которые могут использоваться для создания экземпляра клиента один или несколько виртуальных машин Linux.

## <a name="prerequisites"></a>предварительные требования

Для подготовки и тестирования Linux экранированной виртуальной Машины, вам понадобится следующие ресурсы:

- На сервере с capababilities виртуализации под управлением Windows Server версии 1709 или более поздней версии
- Второй компьютер (Windows 10 или Windows Server 2016) могут работать с диспетчера Hyper-V для подключения к консоли работающей виртуальной Машине
- ISO-образ для одного из поддерживаемых Linux экранированных виртуальных Машин операционных систем:
    - Ubuntu 16.04 LTS с ядром 4.4
    - Red Hat Enterprise Linux 7.3
    - SUSE Linux Enterprise Server 12 Service Pack 2
- Доступ к Интернету для скачивания средства lsvmtools пакета и обновление операционной системы

> [!IMPORTANT]
> Более новых версиях предыдущих операционных систем Linux могут включать известная ошибка драйвера доверенного платформенного МОДУЛЯ, который сделает их успешного провизионирования как экранированных виртуальных машин.
> Не рекомендуется обновить шаблоны или экранированных виртуальных машин до новой версии, пока не будет доступно исправление.
> Список поддерживаемых операционных системах выше будет обновляться после обновления открыты для общего пользования.

## <a name="prepare-a-linux-vm"></a>Подготовка виртуальной Машины Linux

Экранированные виртуальные машины создаются на основе безопасных шаблонных дисков.
Диски шаблона содержит операционную систему для виртуальной Машины и метаданных, включая цифровой подписи разделов/Boot и/root, чтобы убедиться, что ключевые компоненты ОС не изменяются до развертывания.

Для создания диска шаблона, необходимо сначала создать регулярных (неэкранированной) виртуальной Машине, которая будет подготовить как базовый образ для будущих экранированных виртуальных машин.
Программное обеспечение установки и изменения конфигурации, внесенные в эту виртуальную Машину будет применяться для всех экранированных виртуальных машин, созданных на основе этого шаблона диска.
Эти инструкции помогут вам через минимальным требованиям к подготовке виртуальной Машины Linux к templatization.

> [!NOTE]
> Шифрования диска в Linux настраивается при секционировании диска.
> Это означает, что необходимо создать новую виртуальную Машину, предварительно зашифрованные с помощью dm-crypt для Linux для создания экранированной виртуальной Машины диск шаблона.


1.  На сервере виртуализации убедитесь, что Hyper-V и средства поддержку защиты узла Hyper-V установлены, выполнив следующие команды в консоль PowerShell с повышенными привилегиями:

    ```powershell
    Install-WindowsFeature Hyper-V, HostGuardian -IncludeManagementTools -Restart
    ```

2.  Скачайте ISO-образ из надежного источника и сохранить его на сервере виртуализации, или в общей папке, доступ к серверу виртуализации.

3.  На компьютере управления под управлением Windows Server версии 1709 установите экранированной виртуальной Машины средства удаленного администрирования сервера, выполнив следующую команду:

    ```powershell
    Install-WindowsFeature RSAT-Shielded-VM-Tools
    ```

4.  Откройте **диспетчера Hyper-V** на ваш компьютер управления и подключиться к серверу виртуализации.
    Это можно сделать, нажав кнопку «Подключиться к Server …» в области действия или правой кнопкой мыши щелкнув в диспетчере Hyper-V и выбрав команду «соединиться с сервером...» Укажите имя DNS для сервера Hyper-V, и при необходимости учетные данные, необходимые для подключения к нему.

5.  С помощью диспетчера Hyper-V, [настройки во внешний коммутатор](https://docs.microsoft.com/windows-server/virtualization/hyper-v/get-started/create-a-virtual-switch-for-hyper-v-virtual-machines) на сервере виртуализации, поэтому виртуальной Машины Linux можно получить доступ к Интернету для получения обновлений.

6.  Создайте виртуальную машину для установки на ОС Linux.
    В области действий щелкните **New** > **виртуальной машины** чтобы открыть мастер.
    Укажите понятное имя для вашей виртуальной Машине, например «Pre-templatized Linux» и нажмите кнопку **Далее**.

7.  На второй странице мастера выберите **поколения 2** чтобы обеспечить подготовку виртуальной Машины с профилем встроенного по на основе UEFI.

8.  Выполните остальные инструкции мастера согласно вашим предпочтениям.
    Не используйте разностный диск для этой виртуальной Машины; диски шаблона экранированной виртуальной Машины нельзя использовать разностные диски.
    Наконец подключите ISO-образ, который вы загрузили ранее на виртуальном диске DVD для этой виртуальной Машины, на котором можно установить ОС.

9.  В диспетчере Hyper-V, выберите виртуальную Машину, созданную и нажмите кнопку **Connect...**  в области действия для подключения к виртуальной консоли виртуальной машины.
    В открывшемся окне щелкните **запустить** включить на виртуальной машине.

10. Пройдите процесс установки для выбранного дистрибутива Linux.
    Хотя каждый дистрибутив Linux использует разные установки, для дисков виртуальной Машины шаблон экранированных виртуальных машин, которые станут Linux должны выполняться следующие требования.

    - Диска должны быть секционированы с использованием макета таблицы секционирования GUID (GPT)
    - Корневой раздел должен быть зашифрован с помощью dm-crypt. Задается парольная фраза **парольную фразу** (прописными буквами). Парольная фраза будет произвольно и секции расшифровывается при подготовке экранированной виртуальной Машины.
    - Необходимо использовать загрузочный раздел **файловую систему ext2** файловая система

11. После полной загрузки вашей ОС Linux и входа, рекомендуется установить linux виртуального ядра, а также связанные пакеты служб интеграции Hyper-V.
    Кроме того требуется установить SSH-сервер или другое средство удаленного управления для доступа к виртуальной Машине, как только она экранирована.

    В Ubuntu выполните следующую команду, чтобы установить эти компоненты:

    ```bash
    sudo apt-get install linux-virtual linux-tools-virtual linux-cloud-tools-virtual linux-image-extra-virtual openssh-server
    ```

    В RHEL выполните следующую команду вместо предыдущих:

    ```bash
    sudo yum install hyperv-daemons openssh-server
    sudo service sshd start
    ```

    И в SLES, выполните следующую команду:

    ```bash
    sudo zypper install hyper-v
    sudo chkconfig hv_kvp_daemon on
    sudo systemctl enable sshd
    ```

12. Настройте ОС Linux по своему усмотрению.
    Любое программное обеспечение устанавливается, учетные записи пользователей, которые можно добавить, и изменения конфигурации, внесенные будут применяться для всех будущих виртуальных машин, созданных на основе этого шаблона диска.
    Не сохраняйте секреты или ненужные пакеты на диск.

13. Если вы планируете использовать System Center Virtual Machine Manager для развертывания виртуальных машин, установите гостевой агент VMM, чтобы VMM мог specialize вашей операционной системе во время подготовки виртуальной Машины.
    Специализация позволяет настроить безопасно с помощью различных пользователей и ключи SSH, сетевые конфигурации и действия пользовательской установки каждой виртуальной Машины.
    Узнайте, как [получить и установить гостевой агент VMM](https://docs.microsoft.com/system-center/vmm/vm-linux#install-the-vmm-guest-agent) в документации VMM.

14. Далее, [добавьте репозиторий программного обеспечения Microsoft Linux диспетчер пакетов](../../administration/linux-package-repository-for-microsoft-software.md).

15. С помощью диспетчера пакетов, установка средства lsvmtools пакет, который содержит Linux экранированных загрузчика оболочки совместимости виртуальной Машины, подготовки, компоненты и средства подготовки диска.

    ```bash
    # Ubuntu 16.04
    sudo apt-get install lsvmtools

    # SLES 12 SP2
    sudo zypper install lsvmtools

    # RHEL 7.3
    sudo yum install lsvmtools
    ```

14. После завершения настройки ОС Linux, найдите lsvmprep программу установки на компьютере и запустите его.
    
    ```bash
    # The path below may change based on the version of lsvmprep installed
    # Run "find /opt -name lsvmprep" to locate the lsvmprep executable
    sudo /opt/lsvmtools-1.0.0-x86-64/lsvmprep
    ```

15. Завершение работы виртуальной Машины.

16. Если вы выполнили все контрольные точки виртуальной машины (в том числе автоматические контрольные точки, созданные в Hyper-V с Windows 10 Fall Creators Update), не забудьте удалить их перед продолжением.
    Контрольные точки создают разностных дисков (.avhdx), которые не поддерживаются с помощью мастера шаблонов диска.
    
    Чтобы удалить контрольные точки, откройте **диспетчера Hyper-V**, выберите свою виртуальную Машину, щелкните правой кнопкой мыши верхний контрольную точку в области контрольные точки, а затем нажмите кнопку **удалить поддерево контрольных точек**.

    ![Удалите все контрольные точки для шаблона виртуальной Машины в диспетчере Hyper-V](../media/Guarded-Fabric-Shielded-VM/delete-checkpoints-lsvm-template.png)

## <a name="protect-the-template-disk"></a>Защита диска шаблона

Виртуальную Машину, подготовленный в предыдущем разделе почти готов, который будет служить экранированные диск шаблона виртуальной Машины Linux.
Последним шагом является запускать мастер шаблонов диска, который будет хэширования и подписывания текущее состояние разделов корневой и загрузочный диск.
Проверки хэша и цифровой подписи при подготовке экранированной виртуальной Машины, чтобы убедиться, что несанкционированного изменения не внесены две секции между шаблон создания и развертывания.

### <a name="obtain-a-certificate-to-sign-the-disk"></a>Получение сертификата для подписи диска

Чтобы использовать цифровую подпись показатели диска, необходимо получить сертификат на компьютере, где будет выполняться мастер шаблонов диска.
Сертификат должен отвечать следующим требованиям:

Свойства сертификата | Обязательное значение
---------------------|---------------
Алгоритм ключа | RSA
Минимальный размер ключа | 2048 бит
Алгоритм подписи | SHA256 (рекомендуется)
Использование ключа | Цифровая подпись

Сведения об этом сертификате видят клиенты при создании их файлов данных экранирования и разрешаете диски, которым они доверяют.
Таким образом очень важно получить этот сертификат в центре сертификации взаимно доверенным и его клиентам.
В корпоративных сценариях местонахождения клиента и поставщика услуг размещения рассмотрите возможность выдачи этот сертификат от центра сертификации предприятия.
Тщательно защитить этот сертификат, как любой пользователь, владеющий этот сертификат можно создать новый шаблон дисков, которые доверенный так же, как подлинность диска.

В тестовой среде можно создать самозаверяющий сертификат с помощью следующей команды PowerShell:

```powershell
New-SelfSignedCertificate -Subject "CN=Linux Shielded VM Template Disk Signing Certificate"
```

### <a name="process-the-disk-with-the-template-disk-wizard-cmdlet"></a>Процесс на диске с помощью командлета мастер шаблонов диска

Скопируйте диск шаблона и сертификат на компьютере под управлением Windows Server версии 1709, а затем выполните следующие команды, чтобы инициировать процесс подписи.
VHDX, вы предоставляете `-Path` параметр будет быть перезаписан с диском, обновленный шаблон, поэтому не забудьте создать копию перед выполнением команды.

> [!IMPORTANT]
> Средства удаленного администрирования сервера на Windows Server 2016 или Windows 10 не может использоваться для подготовки экранированных Linux диск шаблона виртуальной Машины.
> Использовать только [TemplateDisk защитить](https://docs.microsoft.com/powershell/module/shieldedvmtemplate/protect-templatedisk?view=win10-ps) командлетов, доступных в Windows Server, версии 1709 или средства удаленного администрирования сервера на Windows Server 2019 для подготовки Linux экранированных диск шаблона виртуальной Машины.

```powershell
# Replace "THUMBPRINT" with the thumbprint of your template disk signing certificate in the line below
$certificate = Get-Item Cert:\LocalMachine\My\THUMBPRINT

Protect-TemplateDisk -Path 'C:\temp\MyLinuxTemplate.vhdx' -TemplateName 'Ubuntu 16.04' -Version 1.0.0.0 -Certificate $certificate -ProtectedTemplateTargetDiskType PreprocessedLinux
```

На диске шаблона теперь готов для использования для подготовки экранированные виртуальные машины Linux.
Если вы используете System Center Virtual Machine Manager для развертывания виртуальной Машины, можно скопировать VHDX в библиотеку VMM.

Можно также извлечь каталог подписи тома из формата VHDX.
Этот файл используется для предоставления информации о сертификат для подписи, имя диска и версии Владельцы виртуальных Машин, которые хотят воспользоваться шаблоном.
Их необходимо импортировать этот файл в мастере файл данных экранирования, авторизовать вас, автор шаблона посчитать сертификат для подписи, чтобы создать эту и будущих шаблона диски для них.

Чтобы извлечь каталог подписи тома, выполните следующую команду в PowerShell:

```powershell
Save-VolumeSignatureCatalog -TemplateDiskPath 'C:\temp\MyLinuxTemplate.vhdx' -VolumeSignatureCatalogPath 'C:\temp\MyLinuxTemplate.vsc'
```
