---
title: Создание диска шаблона экранированной виртуальной машины Linux
ms.prod: windows-server
ms.topic: article
ms.assetid: d0e1d4fb-97fc-4389-9421-c869ba532944
manager: dongill
author: rpsqrd
ms.author: ryanpu
ms.technology: security-guarded-fabric
ms.date: 08/29/2018
ms.openlocfilehash: 1a6325a5d8e931f1e62c83ba4013d94760e39f86
ms.sourcegitcommit: b00d7c8968c4adc8f699dbee694afe6ed36bc9de
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/08/2020
ms.locfileid: "80856797"
---
# <a name="create-a-linux-shielded-vm-template-disk"></a>Создание диска шаблона экранированной виртуальной машины Linux

> Область применения: Windows Server 2019, Windows Server (половина ежегодного канала), 

В этом разделе объясняется, как подготовить диск шаблона для экранированных виртуальных машин Linux, которые можно использовать для создания экземпляра одной или нескольких виртуальных машин клиента.

## <a name="prerequisites"></a>Предварительные требования

Чтобы подготовить и проверить экранированную виртуальную машину Linux, вам понадобятся следующие ресурсы:

- Сервер с капабабилитиес виртуализации под управлением Windows Server версии 1709 или более поздней.
- Второй компьютер (Windows 10 или Windows Server 2016), способный запустить диспетчер Hyper-V для подключения к консоли работающей виртуальной машины.
- ISO-образ для одной из поддерживаемых ОС экранированной виртуальной машины Linux:
    - Ubuntu 16,04 LTS с ядром 4,4
    - Red Hat Enterprise Linux 7,3
    - SUSE Linux Enterprise Server 12 с пакетом обновления 2
- Доступ к Интернету для скачивания пакета лсвмтулс и обновлений ОС

> [!IMPORTANT]
> Более новые версии предыдущих ОС Linux могут включать в себя известную ошибку драйвера TPM, которая предотвратит их успешную подготовку в качестве экранированных виртуальных машин.
> Не рекомендуется обновлять шаблоны или экранированные виртуальные машины до более новой версии, пока не будет доступно исправление.
> Приведенный выше список поддерживаемых операционных систем будет обновлен, когда обновления станут общедоступными.

## <a name="prepare-a-linux-vm"></a>Подготовка виртуальной машины Linux

Экранированные виртуальные машины создаются на основе защищенных дисков шаблонов.
Диски шаблонов содержат операционную систему для виртуальной машины и метаданных, включая цифровую подпись разделов/boot и/root, чтобы гарантировать, что основные компоненты ОС не изменяются перед развертыванием.

Чтобы создать диск шаблона, необходимо сначала создать обычную (неэкранированную) виртуальную машину, которая будет подготовлена в качестве базового образа для будущих экранированных виртуальных машин.
Устанавливаемое программное обеспечение и изменения конфигурации, вносимые в эту виртуальную машину, применяются ко всем экранированным виртуальным машинам, созданным на основе этого диска шаблона.
Эти действия помогут вам выполнить минимальные требования для получения виртуальной машины Linux, готовой для темплатизатион.

> [!NOTE]
> Шифрование дисков Linux настраивается при секционировании диска.
> Это означает, что для создания диска шаблона экранированной виртуальной машины Linux необходимо создать новую виртуальную машину с предварительным шифрованием с помощью DM-Encrypting.


1.  На сервере виртуализации убедитесь, что компоненты поддержки Hyper-v и защитника узла установлены, выполнив следующие команды в консоли PowerShell с повышенными правами:

    ```powershell
    Install-WindowsFeature Hyper-V, HostGuardian -IncludeManagementTools -Restart
    ```

2.  Скачайте ISO-образ из надежного источника и сохраните его на сервере виртуализации или в общей папке, доступной для сервера виртуализации.

3.  На компьютере управления под управлением Windows Server версии 1709 установите экранированную виртуальную машину средства удаленного администрирования сервера, выполнив следующую команду:

    ```powershell
    Install-WindowsFeature RSAT-Shielded-VM-Tools
    ```

4.  Откройте **Диспетчер Hyper-V** на компьютере управления и подключитесь к серверу виртуализации.
    Это можно сделать, щелкнув "подключиться к серверу...". на панели действия или щелкнув правой кнопкой мыши Диспетчер Hyper-V и выбрав команду "подключиться к серверу...". Укажите имя DNS для сервера Hyper-V и при необходимости учетные данные, необходимые для подключения к нему.

5.  С помощью диспетчера Hyper-V [Настройте внешний коммутатор](https://docs.microsoft.com/windows-server/virtualization/hyper-v/get-started/create-a-virtual-switch-for-hyper-v-virtual-machines) на сервере виртуализации, чтобы виртуальная машина Linux могла получить доступ к Интернету для получения обновлений.

6.  Затем создайте новую виртуальную машину для установки ОС Linux на.
    В области действия щелкните **создать** > **виртуальную машину** , чтобы открыть мастер.
    Укажите понятное имя виртуальной машины, например "pre-преобразованный Linux", и нажмите кнопку **Далее**.

7.  На второй странице мастера выберите **поколение 2** , чтобы убедиться, что виртуальная машина подготовлена с помощью профиля встроенного по UEFI.

8.  Заполните остальные параметры мастера в соответствии с вашими предпочтениями.
    Не используйте разностный диск для этой виртуальной машины. диски шаблона экранированной виртуальной машины не могут использовать разностные диски.
    Наконец, подключите ранее скачанный образ ISO к виртуальному DVD-дисководу для этой виртуальной машины, чтобы можно было установить ОС.

9.  В диспетчере Hyper-V выберите созданную виртуальную машину и нажмите кнопку **Подключить...** в области действия, чтобы присоединиться к виртуальной консоли виртуальной машины.
    В появившемся окне щелкните **Пуск** , чтобы включить виртуальную машину.

10. Выполните процедуру установки для выбранного дистрибутива Linux.
    Хотя в каждом дистрибутиве Linux используется другой мастер установки, для виртуальных машин, которые станут дисками шаблонов экранированных виртуальных машин Linux, должны выполняться следующие требования:

    - Диск необходимо секционировать с помощью макета GUID секционирования Table (GPT).
    - Корневой раздел должен быть зашифрован с помощью DM-шифрования. Парольная фраза должна быть установлена в **парольную фразу** (все строчные буквы). Эта парольная фраза будет случайной и повторно зашифрована при подготовке экранированной виртуальной машины.
    - Загрузочный раздел должен использовать файловую систему **ext2**

11. После полной загрузки ОС Linux и входа в систему рекомендуется установить виртуальный ядро Linux и связанные пакеты служб интеграции Hyper-V.
    Кроме того, необходимо установить SSH-сервер или другое средство удаленного управления для доступа к виртуальной машине после ее экранирования.

    В Ubuntu выполните следующую команду, чтобы установить следующие компоненты:

    ```bash
    sudo apt-get install linux-virtual linux-tools-virtual linux-cloud-tools-virtual linux-image-extra-virtual openssh-server
    ```

    В RHEL выполните следующую команду:

    ```bash
    sudo yum install hyperv-daemons openssh-server
    sudo service sshd start
    ```

    В SLES выполните следующую команду:

    ```bash
    sudo zypper install hyper-v
    sudo chkconfig hv_kvp_daemon on
    sudo systemctl enable sshd
    ```

12. При необходимости настройте ОС Linux.
    Любое устанавливаемое программное обеспечение, добавленные учетные записи пользователей и изменения конфигурации на уровне системы будут применены ко всем будущим виртуальным машинам, созданным на основе этого диска шаблона.
    Следует избегать сохранения секретов или ненужных пакетов на диске.

13. Если вы планируете использовать System Center Virtual Machine Manager для развертывания виртуальных машин, установите Гостевой агент VMM, чтобы разрешить VMM специализацию операционной системы во время подготовки виртуальной машины.
    Специализация позволяет безопасно настроить каждую виртуальную машину с разными пользователями и ключами SSH, сетевые конфигурации и шаги выборочной установки.
    Узнайте, как [получить и установить Гостевой агент VMM](https://docs.microsoft.com/system-center/vmm/vm-linux#install-the-vmm-guest-agent) в документации по VMM.

14. Затем [добавьте в Диспетчер пакетов репозиторий программного обеспечения Microsoft Linux](../../administration/linux-package-repository-for-microsoft-software.md).

15. С помощью диспетчера пакетов установите пакет лсвмтулс, содержащий оболочку загрузчика экранированной виртуальной машины Linux, компоненты подготовки и средство подготовки диска.

    ```bash
    # Ubuntu 16.04
    sudo apt-get install lsvmtools

    # SLES 12 SP2
    sudo zypper install lsvmtools

    # RHEL 7.3
    sudo yum install lsvmtools
    ```

14. Завершив настройку ОС Linux, в системе выберите программу установки лсвмпреп и запустите ее.
    
    ```bash
    # The path below may change based on the version of lsvmprep installed
    # Run "find /opt -name lsvmprep" to locate the lsvmprep executable
    sudo /opt/lsvmtools-1.0.0-x86-64/lsvmprep
    ```

15. Завершите работу виртуальной машины.

16. Если вы сделали какие-либо контрольные точки виртуальной машины (включая автоматические контрольные точки, созданные Hyper-V с обновлением Windows 10 Creators Update), обязательно удалите их перед продолжением.
    Контрольные точки создают разностные диски (. avhdx), которые не поддерживаются мастером создания шаблона диска.
    
    Чтобы удалить контрольные точки, откройте **Диспетчер Hyper-V**, выберите виртуальную машину, щелкните правой кнопкой мыши самую верхнюю контрольную точку в области контрольные точки, а затем выберите пункт **Удалить поддерево контрольной точки**.

    ![Удаление всех контрольных точек для шаблона виртуальной машины в диспетчере Hyper-V](../media/Guarded-Fabric-Shielded-VM/delete-checkpoints-lsvm-template.png)

## <a name="protect-the-template-disk"></a>Защита диска шаблона

Виртуальная машина, подготовленная в предыдущем разделе, почти готова к использованию в качестве диска шаблона экранированной виртуальной машины Linux.
Последний шаг — запуск диска с помощью мастера создания шаблона диска, который выполнит хэширование и цифровую подпись текущего состояния корневого и загрузочного разделов.
Хэш и цифровая подпись проверяются при подготовке экранированной виртуальной машины, чтобы предотвратить несанкционированные изменения в двух секциях между созданием и развертыванием шаблона.

### <a name="obtain-a-certificate-to-sign-the-disk"></a>Получение сертификата для подписывания диска

Для цифровой подписи единиц измерения диска необходимо получить сертификат на компьютере, на котором будет запущен мастер создания шаблона диска.
Сертификат должен соответствовать следующим требованиям.

Свойство Certificate | Обязательное значение
---------------------|---------------
Алгоритм ключа | RSA
Минимальный размер ключа | 2048 бит
Алгоритм подписи | SHA256 (рекомендуется)
Использование ключа | Цифровая подпись

Сведения об этом сертификате будут отображаться для клиентов при создании файлов данных экранирования и авторизации дисков, которым они доверяют.
Поэтому важно получить этот сертификат из центра сертификации, который будет взаимно доверенным для вас и ваших клиентов.
В корпоративных сценариях, где вы используете и поставщик услуг размещения, и клиент, вы можете использовать этот сертификат из центра сертификации предприятия.
Внимательно Защитите этот сертификат, так как любой пользователь, имеющий этот сертификат, может создавать новые диски шаблонов, которые являются доверенными, так же как и на подлинном диске.

В лабораторной тестовой среде можно создать самозаверяющий сертификат с помощью следующей команды PowerShell:

```powershell
New-SelfSignedCertificate -Subject "CN=Linux Shielded VM Template Disk Signing Certificate"
```

### <a name="process-the-disk-with-the-template-disk-wizard-cmdlet"></a>Обработка диска с помощью командлета мастера создания диска шаблона

Скопируйте диск шаблона и сертификат на компьютер под управлением Windows Server версии 1709, а затем выполните следующие команды, чтобы начать процесс подписи.
VHDX-файл, предоставленный для параметра `-Path`, будет перезаписан с обновленным диском шаблона, поэтому перед выполнением команды обязательно создайте копию.

> [!IMPORTANT]
> Средства удаленного администрирования сервера, доступные в Windows Server 2016 или Windows 10, нельзя использовать для подготовки диска шаблона экранированной виртуальной машины Linux.
> Для подготовки диска шаблона экранированной виртуальной машины Linux используйте командлет [Protect-темплатедиск](https://docs.microsoft.com/powershell/module/shieldedvmtemplate/protect-templatedisk?view=win10-ps) , доступный в windows Server 2019 версии 1709 или средства удаленного администрирования сервера

```powershell
# Replace "THUMBPRINT" with the thumbprint of your template disk signing certificate in the line below
$certificate = Get-Item Cert:\LocalMachine\My\THUMBPRINT

Protect-TemplateDisk -Path 'C:\temp\MyLinuxTemplate.vhdx' -TemplateName 'Ubuntu 16.04' -Version 1.0.0.0 -Certificate $certificate -ProtectedTemplateTargetDiskType PreprocessedLinux
```

Теперь ваш диск шаблона готов к использованию для подготовки экранированных виртуальных машин Linux.
Если вы используете System Center Virtual Machine Manager для развертывания виртуальной машины, теперь можно скопировать VHDX-файл в библиотеку VMM.

Также может потребоваться извлечь каталог подписей тома из VHDX-файлов.
Этот файл используется для предоставления сведений о сертификате подписи, имени диска и версии для владельцев виртуальных машин, которые хотят использовать шаблон.
Необходимо импортировать этот файл в мастер файлов данных экранирования, чтобы авторизовать вас, автор шаблона при наличии сертификата для подписи, чтобы создать этот и будущие диски шаблонов для них.

Чтобы извлечь каталог подписей тома, выполните следующую команду в PowerShell:

```powershell
Save-VolumeSignatureCatalog -TemplateDiskPath 'C:\temp\MyLinuxTemplate.vhdx' -VolumeSignatureCatalogPath 'C:\temp\MyLinuxTemplate.vsc'
```
