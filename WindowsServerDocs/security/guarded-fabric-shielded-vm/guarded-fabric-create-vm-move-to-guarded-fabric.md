---
redirect_url: guarded-fabric-configuration-scenarios-for-shielded-vms-overview.md
title: Экранированные виртуальные машины для клиентов — создание экранированной виртуальной машины в локальной среде и перемещение ее в защищенную структуру.
ms.prod: windows-server
ms.topic: article
ms.assetid: 0ca1efa0-01f9-4b6f-87d4-c66db00d7d70
manager: dongill
author: rpsqrd
ms.author: ryanpu
ms.technology: security-guarded-fabric
ms.date: 08/29/2018
ms.openlocfilehash: c6753ae5d767f0c71b86fc47c1d8bf9971a2a5cc
ms.sourcegitcommit: 771db070a3a924c8265944e21bf9bd85350dd93c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/27/2020
ms.locfileid: "85475531"
---
# <a name="shielded-vms-for-tenants---creating-a-new-shielded-vm-on-premises-and-moving-it-to-a-guarded-fabric"></a>Экранированные виртуальные машины для клиентов — создание экранированной виртуальной машины в локальной среде и перемещение ее в защищенную структуру.

>Область применения: Windows Server 2019, Windows Server (половина ежегодного канала), Windows Server 2016

В этом разделе описаны шаги по созданию экранированной виртуальной машины с использованием только Hyper-V; то есть без Virtual Machine Manager, дисков шаблонов или файла данных экранирования. Это редкий сценарий для большинства общедоступных облачных сред размещения, но может быть полезен при тестировании защищенной структуры или в корпоративных сценариях, где виртуальная машина перемещается из структуры отделов в общую ИТ-инфраструктуру и должна быть зашифрована перед миграцией.

Чтобы понять, как этот раздел соответствует общему процессу развертывания экранированных виртуальных машин, см. раздел [этапы настройки поставщика услуг размещения для защищенных узлов и экранированных виртуальных машин](guarded-fabric-configuration-scenarios-for-shielded-vms-overview.md).

## <a name="import-the-guardian-configuration-on-the-tenant-hyper-v-server"></a>Импорт конфигурации защиты на клиенте Hyper-V Server

1.  Перед началом процедуры убедитесь, что на узле Hyper-V под управлением Windows Server 2016 установлены следующие роли и компоненты:

    - Роль

        - Hyper-V

    - Компоненты

        - Средства удаленного администрирования сервера средства \\ администрирования компонентов \\ ЭКРАНИРОВАННЫХ виртуальных машин

    > [!NOTE]
    > Используемый здесь узел *не* должен быть узлом в защищенной структуре. Это отдельный узел, на котором подготавливаются виртуальные машины перед их перемещением в защищенную структуру.

2.  Прежде чем можно будет запустить экранированную виртуальную машину на этом компьютере, необходимо включить и запустить систему безопасности на основе виртуализации. Выполните следующую команду в окне Windows PowerShell с повышенными привилегиями, чтобы установить функцию поддержки защиты узла Hyper-V. При этом все необходимые параметры на компьютере будут настроены для запуска экранированных виртуальных машин.

        Install-WindowsFeature HostGuardian

3.  Необходимо будет получить метаданные защиты для защищенной структуры, в которой будет выполняться виртуальная машина. Эти метаданные используются для авторизации этой структуры для запуска экранированной виртуальной машины. Получение этих сведений будет отличаться для каждого поставщика услуг размещения или для предприятия. Поставщик услуг размещения (или, если у вас есть доступ к защищенной сети структуры) может получить эти сведения, выполнив следующую команду Windows PowerShell:

        Invoke-WebRequest 'http://hgs.bastion.local/KeyProtection/service/metadata/2014-07/metadata.xml' -OutFile .\RelecloudGuardian.xml

    В приведенном выше примере "HGS" — это имя распределенной сети кластера HGS, а "бастиона. local" — имя домена HGS.

4.  Чтобы импортировать ключ защиты, который потребуется в последующих процедурах, выполните следующую команду.

    &lt;В поле &gt; &lt; имя файла пути &gt; Замените путь и имя XML-файла, сохраненного на предыдущем шаге, например: **C: \\ temp \\GuardianKey.xml**

    Для &lt; гуардианнаме &gt; Укажите имя поставщика услуг размещения или центра обработки данных предприятия, например **HostingProvider1**. Запишите имя для следующей процедуры.

    Include **-алловунтрустедрут** , только если на сервере HGS настроены самозаверяющие сертификаты. (Эти сертификаты являются частью службы защиты ключей в HGS.)

        Import-HgsGuardian -Path '<Path><Filename>' -Name '<GuardianName>' -AllowUntrustedRoot

## <a name="create-a-new-shielded-virtual-machine-on-the-host"></a>Создание экранированной виртуальной машины на узле

В этой процедуре вы создадите виртуальную машину на узле Hyper-V и подготовите ее для экспорта в поставщик услуг размещения или в администратор центра обработки данных, который сможет запустить его на защищенном узле.

В рамках процедуры вы создадите предохранитель ключа, который содержит два важных элемента:

-   **Owner**: в предохранителе ключа, скорее всего, это группа, в которой вы работаете, которая использует такие элементы безопасности, как "владелец" виртуальной машины. Удостоверение в качестве владельца представляется сертификатом, который при выполнении приведенных команд создается как самозаверяющий сертификат. Кроме того, можно использовать сертификат, поддерживающий инфраструктуру PKI, и опустить параметр **-алловунтрустедрут** в командах.

-   **Опекуны**. Кроме того, в предохранителе ключа поставщик услуг размещения или центр обработки данных предприятия (который запускает HGS и защищенные узлы) идентифицируется как "опекун". Защитник представляется ключом опекуна, который вы импортировали в предыдущей процедуре, [импортируйте конфигурацию защиты на клиенте Hyper-V Server](#import-the-guardian-configuration-on-the-tenant-hyper-v-server).

Иллюстрация, показывающая предохранитель ключа, которая является элементом в файле данных экранирования, представлена в разделе [что такое данные экранирования и зачем это необходимо?](guarded-fabric-and-shielded-vms.md#what-is-shielding-data-and-why-is-it-necessary)

1. На узле Hyper-V клиента создайте новую виртуальную машину поколения 2, выполнив следующую команду.

   В &lt; &gt; поле шиелдедвмнаме укажите имя виртуальной машины, например **ShieldVM1** .

   Для &lt; VHDPath &gt; укажите расположение для хранения VHDX-файлов виртуальной машины, например: **C: \\ VMS \\ ShieldVM1 \\ ShieldVM1. VHDX.**

   Для &lt; ннгб &gt; Укажите размер VHDX, например: **60 ГБ** .

       New-VM -Generation 2 -Name "<ShieldedVMname>" -NewVHDPath <VHDPath>.vhdx -NewVHDSizeBytes <nnGB>

2. Установите поддерживаемую операционную систему (Windows Server 2012 или более поздней версии, клиента Windows 8 или более поздней версии) на виртуальной машине и включите подключение к удаленному рабочему столу и соответствующее правило брандмауэра. Запишите IP-адрес и (или) DNS-имя виртуальной машины; он понадобится для удаленного подключения к нему.

3. Используйте RDP для удаленного подключения к виртуальной машине и убедитесь, что протокол RDP и брандмауэр настроены правильно. В рамках процесса экранирования доступ консоли к виртуальной машине через Hyper-V будет отключен, поэтому важно обеспечить возможность удаленного управления системой по сети.

4. Чтобы создать новый предохранитель ключа (описанный в начале этого раздела), выполните следующую команду.

   Для &lt; гуардианнаме &gt; Используйте имя, указанное в предыдущей процедуре, например: **HostingProvider1** .

   Include **-алловунтрустедрут** , чтобы разрешить самозаверяющие сертификаты.

       $Guardian = Get-HgsGuardian -Name '<GuardianName>'

       $Owner = New-HgsGuardian -Name 'Owner' -GenerateCertificates

       $KP = New-HgsKeyProtector -Owner $Owner -Guardian $Guardian -AllowUntrustedRoot

   Если вы хотите, чтобы несколько центров обработки данных могли запускать экранированную виртуальную машину (например, сайт аварийного восстановления и поставщика общедоступного облака), вы можете предоставить список хранителей для параметра **-опекуна** . Дополнительные сведения см. в разделе [New-Хгскэйпротектор] ( https://docs.microsoft.com/powershell/module/hgsclient/new-hgskeyprotector?view=win10-ps .

5. Чтобы включить vTPM с помощью предохранителя ключа, выполните следующую команду. Для &lt; шиелдедвмнаме &gt; Используйте то же имя виртуальной машины, которое использовалось на предыдущих шагах.

       $VMName="<ShieldedVMname>"

       Stop-VM -Name $VMName -Force

       Set-VMKeyProtector -VMName $VMName -KeyProtector $KP.RawData

       Set-VMSecurityPolicy -VMName $VMName -Shielded $true

       Enable-VMTPM -VMName $VMName

6. Чтобы запустить виртуальную машину, чтобы убедиться, что предохранитель ключа работает с сертификатами локального владельца, выполните следующую команду.

       Start-VM -Name $VMName

7. Убедитесь, что виртуальная машина запущена в консоли Hyper-V.

8. Используйте RDP для удаленного подключения к виртуальной машине и включения BitLocker для всех разделов на всех VHDX-дисках, подключенных к экранированной виртуальной машине.

   > [!IMPORTANT]
   > Прежде чем перейти к следующему шагу, дождитесь завершения шифрования BitLocker во всех секциях, где вы его включили.

9. Завершите работу виртуальной машины, когда будете готовы переместить ее в защищенную структуру.

10. На сервере Hyper-V клиента экспортируйте виртуальную машину с помощью выбранного инструмента (Windows PowerShell или диспетчера Hyper-V). Затем расположите файлы для копирования на защищенный узел, поддерживаемый поставщиком услуг размещения или центром обработки данных предприятия.

11. **Для поставщика услуг размещения или центра обработки данных предприятия**:

    Импортируйте экранированную виртуальную машину с помощью диспетчера Hyper-V или Windows PowerShell. Чтобы запустить ВИРТУАЛЬную машину, необходимо импортировать файл конфигурации ВИРТУАЛЬНОЙ машины из владельца виртуальной машины. Это связано с тем, что предохранитель ключа и виртуальный доверенный платформенный модуль виртуальной машины хранятся в файле конфигурации. Если виртуальная машина настроена для работы в защищенной структуре, ее можно запустить успешно.

## <a name="additional-references"></a>Дополнительные ссылки

- [Пошаговая настройка поставщика служб размещения для защищенных узлов и экранированных виртуальных машин](guarded-fabric-configuration-scenarios-for-shielded-vms-overview.md)
- [Защищенная структура и экранированные виртуальные машины](guarded-fabric-and-shielded-vms-top-node.md)
