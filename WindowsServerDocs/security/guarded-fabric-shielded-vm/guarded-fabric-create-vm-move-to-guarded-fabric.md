---
redirect_url: guarded-fabric-configuration-scenarios-for-shielded-vms-overview.md
title: Экранированные виртуальные машины для клиентов - создания нового экранированных виртуальных Машин в локальной и переместить его на защищенной структуры
ms.custom: na
ms.prod: windows-server-threshold
ms.topic: article
ms.assetid: 0ca1efa0-01f9-4b6f-87d4-c66db00d7d70
manager: dongill
author: rpsqrd
ms.technology: security-guarded-fabric
ms.date: 08/29/2018
ms.openlocfilehash: 9601145048b8798cfb102757384da49bed16a538
ms.sourcegitcommit: 63926404009f9e1330a4a0aa8cb9821a2dd7187e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/29/2019
ms.locfileid: "67469629"
---
# <a name="shielded-vms-for-tenants---creating-a-new-shielded-vm-on-premises-and-moving-it-to-a-guarded-fabric"></a>Экранированные виртуальные машины для клиентов - создания нового экранированных виртуальных Машин в локальной и переместить его на защищенной структуры

>Относится к: Windows Server 2019 г., Windows Server (полугодовой канал), Windows Server 2016

В этом разделе описываются шаги для создания экранированной виртуальной Машины с помощью только Hyper-V; то есть без Virtual Machine Manager, диски шаблона и файл данных экранирования. Это происходит редко для большинства общедоступных облачных средах размещения, но могут быть полезны при тестировании защищенной структуре или предприятии сценариях, где виртуальной Машины перемещается из отделов структуры для общих ИТ-инфраструктуры и должны быть зашифрованы перед миграцией.

Чтобы понять, как в этом разделе встраивается в общем процессе развертывания экранированных виртуальных машин, см. в разделе [размещения службы поставщика Пошаговое руководство по настройке защищенных узлов и экранированных виртуальных машин](guarded-fabric-configuration-scenarios-for-shielded-vms-overview.md).

## <a name="import-the-guardian-configuration-on-the-tenant-hyper-v-server"></a>Импорт конфигурации защиты на сервере клиента Hyper-V

1.  Перед началом процедуры, убедитесь, что на узле Hyper-V под управлением Windows Server 2016 с следующие роли и компоненты, устанавливаемые:

    - Role

        - Hyper-V

    - Компоненты

        - Средства удаленного администрирования сервера\\средства администрирования компонентов\\экранированных средства для виртуальной Машины

    > [!NOTE]
    > Узел, используемый здесь следует *не* должна быть размещена в защищенной структуры. Это представляет собой отдельный узел, где виртуальные машины подготовлены перед перемещением в защищенной структуры.

2.  Перед запуском экранированной виртуальной Машины на этом компьютере, необходимо убедиться, что безопасность на основе виртуализации включена и запущена. Выполните следующую команду в окне Windows PowerShell с повышенными правами для установки компонента поддержку защиты узла Hyper-V. Это настроит все необходимые параметры на компьютере, чтобы иметь возможность запуска экранированных виртуальных машин.

        Install-WindowsFeature HostGuardian

3.  Необходимо будет получить метаданные для защищенной структуры, где будет работать ваша виртуальная машина. Эти метаданные используются для авторизации для выполнения экранированные ВМ в этой структуре. Как получить эти сведения будут отличаться для каждого поставщика услуг размещения или enterprise. Поставщик услуг размещения (или вы, если у вас есть доступ к сети, защищенной структуры) можно получить эту информацию, выполнив следующую команду Windows PowerShell:

        Invoke-WebRequest 'http://hgs.bastion.local/KeyProtection/service/metadata/2014-07/metadata.xml' -OutFile .\RelecloudGuardian.xml

    В приведенном выше примере «hgs» — имя распределенной сети кластера HGS и «bastion.local» — это имя домена HGS.

4.  Для импорта ключа защиты, которые потребуются в последующей процедуре, выполните следующую команду.

    Для &lt;путь&gt;&lt;Filename&gt;, изменить путь и имя файла XML-файл был сохранен на предыдущем шаге, например: **C:\\temp\\GuardianKey.xml**

    Для &lt;GuardianName&gt;, например, укажите имя для вашего центра обработки данных предприятия или поставщика услуг размещения **HostingProvider1**. Запишите имя для выполнения следующей процедуры.

    Включить **- AllowUntrustedRoot** только в том случае, если сервер HGS была настроена с помощью самозаверяющих сертификатов. (Эти сертификаты являются частью службой защиты ключей в HGS).

        Import-HgsGuardian -Path '<Path><Filename>' -Name '<GuardianName>' -AllowUntrustedRoot

## <a name="create-a-new-shielded-virtual-machine-on-the-host"></a>Создание новой экранированной виртуальной машины на узле

В этой процедуре будет создать виртуальную машину на узле Hyper-V и подготовить их к экспорту поставщика услуг размещения или администратору центра обработки данных, который можно запустить на защищенном узле.

В рамках процедуры вы создадите предохранитель ключа, который содержит две важные элементы:

-   **Владелец**: Предохранитель ключа, вы - или более вероятно, группы, которым вы работаете, совместно использует элементы безопасности, такие как сертификаты - обозначаются как «владелец» виртуальной машины. Свое удостоверение в качестве владельца представляется с помощью сертификата, создаваемое, если вы выполните команды, как показано, как самозаверяющий сертификат. При необходимости можно вместо этого использовать сертификат, поддерживаемый инфраструктура PKI и опустить **- AllowUntrustedRoot** параметр в командах.

-   **Guardians**: Также предохранитель ключа, ваш поставщик услуг размещения или центра обработки данных предприятия (которая запускает HGS и защищенных узлов) определяется как «защиты». Средство защиты представляется с помощью ключа защиты, импортированный в предыдущей процедуре, [импорта конфигурации защиты на сервере клиента Hyper-V](#import-the-guardian-configuration-on-the-tenant-hyper-v-server).

Иллюстрация, показывающая предохранитель ключа, который является элементом в файл данных экранирования, см. в разделе [что данных экранирования и зачем это необходимые?](guarded-fabric-and-shielded-vms.md#what-is-shielding-data-and-why-is-it-necessary).

1. На узле Hyper-V, клиент для создания нового поколения 2 виртуальной машины, выполните команду ниже.

   Для &lt;ShieldedVMname&gt;, укажите имя для виртуальной Машины, например: **ShieldVM1**
    
   Для &lt;VHDPath&gt;, укажите расположение для хранения vhdx-диска виртуальной машины, например: **C:\\VMs\\ShieldVM1\\ShieldVM1.vhdx**
    
   Для &lt;nnGB&gt;, укажите размер для vhdx-файлов, например: **60 ГБ**

       New-VM -Generation 2 -Name "<ShieldedVMname>" -NewVHDPath <VHDPath>.vhdx -NewVHDSizeBytes <nnGB>

2. Установить поддерживаемую операционную систему (клиент Windows Server 2012 или более поздней версии, Windows 8 или более поздней версии) на виртуальной Машине и включить удаленный рабочий стол и соответствующие правила брандмауэра. Запишите IP-адрес или DNS-именам; виртуальной Машины он понадобится для удаленного подключения к нему.

3. Используйте RDP для удаленного подключения к виртуальной Машине и проверить правильность настройки удаленного рабочего СТОЛА и брандмауэр. В рамках процесса экранирования консольный доступ к виртуальной машине с помощью Hyper-V будет отключена, поэтому очень важно, чтобы убедиться, что вы можете удаленно управлять системы по сети.

4. Чтобы создать новые предохранители ключа (см. в начале этого раздела), выполните следующую команду.

   Для &lt;GuardianName&gt;, используйте имя, указанное в предыдущей процедуре, например: **HostingProvider1**

   Включить **- AllowUntrustedRoot** для самозаверяющих сертификатов.

       $Guardian = Get-HgsGuardian -Name '<GuardianName>'

       $Owner = New-HgsGuardian -Name 'Owner' -GenerateCertificates

       $KP = New-HgsKeyProtector -Owner $Owner -Guardian $Guardian -AllowUntrustedRoot

   Если требуется для более чем одном центре обработки данных запускаться экранированная виртуальная машина (например, на сайт аварийного восстановления и поставщик общедоступных облачных), можно указать список guardians для **-защиты** параметра. Дополнительные сведения см. в разделе [New-HgsKeyProtector] (https://docs.microsoft.com/powershell/module/hgsclient/new-hgskeyprotector?view=win10-ps.

5. Чтобы включить виртуального доверенного платформенного модуля, с помощью предохранителя ключа, выполните следующую команду. Для &lt;ShieldedVMname&gt;, используйте то же имя виртуальной Машины, которые использовались на предыдущих шагах.

       $VMName="<ShieldedVMname>"

       Stop-VM -Name $VMName -Force

       Set-VMKeyProtector -VMName $VMName -KeyProtector $KP.RawData

       Set-VMSecurityPolicy -VMName $VMName -Shielded $true

       Enable-VMTPM -VMName $VMName

6. Запуск виртуальной Машины для проверки корректности предохранитель ключа с помощью локального владельца сертификатов, выполните следующую команду.

       Start-VM -Name $VMName

7. Убедитесь, что виртуальная машина запущена в консоли Hyper-V.

8. Используйте RDP для удаленного подключения к виртуальной Машине и включить BitLocker на всех разделах всех vhdx-файлы, подключенные к экранированной виртуальной Машины.

   > [!IMPORTANT]
   > Прежде чем переходить к следующему шагу, дождитесь шифрование BitLocker на все разделы, где вы включили.

9. Завершите работу виртуальной Машины, когда будете готовы переместить его на защищенной структуры.

10. На сервере, клиента Hyper-V экспортируйте виртуальную Машину с помощью средства по своему усмотрению (Windows PowerShell или диспетчера Hyper-V). Затем расположите для файлов, копируемых на защищенный компьютер, обслуживаемый вашего центра обработки данных предприятия или поставщика услуг размещения.

11. **Для размещения центра данных предприятия или поставщика**:

    Импортируйте экранированной виртуальной Машины, с помощью диспетчера Hyper-V или Windows PowerShell. Чтобы запустить виртуальную Машину необходимо импортировать файл конфигурации виртуальной Машины от владельца виртуальной Машины. Это обусловлено предохранители ключа и виртуальный TPM виртуальной Машины хранятся в файле конфигурации. Если виртуальная машина настроена для запуска на защищенной структуры, он должен иметь возможность успешно запуститься.

## <a name="see-also"></a>См. также

- [Размещение службы поставщика Пошаговое руководство по настройке защищенных узлов и экранированных виртуальных машин](guarded-fabric-configuration-scenarios-for-shielded-vms-overview.md)
- [Защищенная структура и экранированные виртуальные машины](guarded-fabric-and-shielded-vms-top-node.md)
