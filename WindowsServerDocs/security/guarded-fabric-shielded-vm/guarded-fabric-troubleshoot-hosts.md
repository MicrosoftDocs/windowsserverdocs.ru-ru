---
title: Устранение неполадок службы защиты узла
ms.prod: windows-server
ms.topic: article
ms.assetid: 80ea38f4-4de6-4f85-8188-33a63bb1cf81
manager: dongill
author: rpsqrd
ms.author: ryanpu
ms.technology: security-guarded-fabric
ms.date: 09/25/2019
ms.openlocfilehash: 86627f6013592c95f517d77fed6ac5f57eb139b6
ms.sourcegitcommit: b00d7c8968c4adc8f699dbee694afe6ed36bc9de
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/08/2020
ms.locfileid: "80856397"
---
# <a name="troubleshooting-guarded-hosts"></a>Устранение неполадок защищенных узлов

> Область применения: Windows Server 2019, Windows Server (половина ежегодного канала), Windows Server 2016

В этом разделе описаны способы решения распространенных проблем, возникающих при развертывании или эксплуатации защищенного узла Hyper-V в защищенной структуре.
Если вы не уверены в характере проблемы, сначала попробуйте выполнить [защищенную диагностику структуры](guarded-fabric-troubleshoot-diagnostics.md) на узлах Hyper-V, чтобы сократить возможные причины.

## <a name="guarded-host-feature"></a>Функция защищенного узла

Если у вас возникли проблемы с узлом Hyper-V, сначала убедитесь, что установлен компонент **поддержки защиты узла Hyper-v** .
Без этой функции на узле Hyper-V будут отсутствовать некоторые важные параметры конфигурации и программное обеспечение, позволяющее передавать аттестацию и подготавливать экранированные виртуальные машины.

Чтобы проверить, установлена ли эта функция, используйте диспетчер сервера или выполните следующую команду в окне PowerShell с повышенными привилегиями:

```powershell
Get-WindowsFeature HostGuardian
```

Если компонент не установлен, установите его с помощью следующей команды PowerShell:

```powershell
Install-WindowsFeature HostGuardian -Restart
```

## <a name="attestation-failures"></a>Сбои аттестации

Если узел не передает аттестацию с помощью службы защиты узла, он не сможет запускать экранированные виртуальные машины.
Выходные данные [Get-HgsClientConfiguration](https://technet.microsoft.com/library/dn914500.aspx) на этом узле будут показывать сведения о причинах сбоя узла в ходе аттестации.

В таблице ниже объясняются значения, которые могут появиться в поле **аттестатионстатус** , а также возможные дальнейшие действия (если это необходимо).

аттестатионстатус         | Пояснение
--------------------------|------------
Срок действия истек                   | Узел прошел аттестацию ранее, но истек срок действия сертификата работоспособности, который был выдан. Убедитесь, что узел и время HGS синхронизированы.
инсекурехостконфигуратион | Узел не прошел аттестацию, так как он не соответствует политикам аттестации, настроенным в HGS. Дополнительные сведения см. в таблице Аттестатионсубстатус.
NotConfigured             | Узел не настроен на использование HGS для аттестации и защиты ключей. Вместо этого он настраивается для локального режима. Если этот узел находится в защищенной структуре, используйте [Set-HgsClientConfiguration](https://technet.microsoft.com/library/dn914494.aspx) , чтобы указать URL-адреса для сервера HGS.
Выполнено                    | Узел передал аттестацию.
трансиентеррор            | Последняя попытка аттестации завершилась сбоем из-за неисправности сети, службы или другой временной ошибки. Повторите последнюю операцию.
тпмеррор                  | Узлу не удалось завершить последнюю попытку аттестации из-за ошибки в доверенном платформенном модуле. Дополнительные сведения см. в журналах TPM.
унаусоризедхост          | Узел не прошел аттестацию, так как ему не было предоставлено разрешение на запуск экранированных виртуальных машин. Убедитесь, что узел принадлежит группе безопасности, которой доверяете HGS для запуска экранированных виртуальных машин.
Неизвестно                   | Узел еще не пытался выполнить аттестацию с помощью HGS.

Когда **аттестатионстатус** сообщается как **инсекурехостконфигуратион**, по одной или нескольким причинам они будут заполнены в поле **аттестатионсубстатус** .
В таблице ниже приведены возможные значения для Аттестатионсубстатус и советы по устранению проблемы.

аттестатионсубстатус       | Что это означает и что делать
---------------------------|-------------------------------
BitLocker                  | Том ОС узла не шифруется BitLocker. Чтобы устранить эту проблему, [включите BitLocker](https://technet.microsoft.com/itpro/windows/keep-secure/bitlocker-basic-deployment) на томе операционной системы или [Отключите политику BitLocker в HGS](guarded-fabric-manage-hgs.md#review-attestation-policies).
кодеинтегритиполици        | Узел не настроен для использования политики целостности кода или не использует политику, доверенную для сервера HGS. Убедитесь, что политика целостности кода настроена, что узел был перезапущен и политика зарегистрирована на сервере HGS. Дополнительные сведения см. [в разделе Создание и применение политики целостности кода](guarded-fabric-tpm-trusted-attestation-capturing-hardware.md#create-and-apply-a-code-integrity-policy).
думпсенаблед               | Узел настроен для разрешения аварийных дампов или динамических дампов памяти, которые не допускаются политиками HGS. Чтобы устранить эту проблему, отключите дампы на узле.
думпенкриптион             | Узел настроен для разрешения аварийных дампов или динамических дампов памяти, но не шифрует эти дампы. Отключите дампы на узле или [Настройте шифрование дампа](https://technet.microsoft.com/windows-server-docs/virtualization/hyper-v/manage/about-dump-encryption).
думпенкриптионкэй          | Узел настроен для разрешения и шифрования дампов, но не использует сертификат, известный для его шифрования в службе HGS. Чтобы устранить эту проблему, [Обновите ключ шифрования дампа](https://technet.microsoft.com/windows-server-docs/virtualization/hyper-v/manage/about-dump-encryption) на узле или [зарегистрируйте ключ в HGS](guarded-fabric-manage-hgs.md#authorizing-new-guarded-hosts).
фуллбут                   | Узел возобновлен из состояния сна или спящего режима. Перезапустите узел, чтобы обеспечить чистую и полную загрузку.
хибернатионенаблед         | Узел настроен на разрешение гибернации без шифрования файла гибернации, что запрещено политиками HGS. Отключите режим гибернации и перезапустите узел или [Настройте шифрование дампа](https://technet.microsoft.com/windows-server-docs/virtualization/hyper-v/manage/about-dump-encryption).
хипервисоренфорцедкодеинтегритиполици | Узел не настроен для использования политики целостности кода, принудительно применяемой гипервизором. Убедитесь, что целостность кода включена, настроена и принудительно применена гипервизором. Дополнительные сведения см. в разделе " [рекомендации по развертыванию Device Guard](https://technet.microsoft.com/itpro/windows/keep-secure/deploy-device-guard-deploy-code-integrity-policies) ".
IOMMU                      | Функции безопасности на основе виртуализации узла не настроены на требование наличия устройства IOMMU для защиты от атак прямого доступа к памяти в соответствии с требованиями политик HGS. Убедитесь, что на узле есть IOMMU, что он включен и что Device Guard [настроен для использования защиты DMA](https://technet.microsoft.com/itpro/windows/keep-secure/deploy-device-guard-enable-virtualization-based-security#enable-virtualization-based-security-vbs-and-device-guard) при запуске vbs.
пажефилинкриптион         | Шифрование файла подкачки не включено на узле. Чтобы устранить эту проблему, запустите `fsutil behavior set encryptpagingfile 1`, чтобы включить шифрование файла подкачки. Дополнительные сведения см. в разделе [fsutil behavior](https://technet.microsoft.com/library/cc785435.aspx).
Безопасной загрузки                 | Безопасная загрузка либо не включена на этом узле, либо не использует шаблон безопасной загрузки Майкрософт. Чтобы устранить эту проблему, [включите безопасную загрузку](https://msdn.microsoft.com/windows/hardware/commercialize/manufacture/desktop/disabling-secure-boot#enable_secure_boot) с помощью шаблона безопасной загрузки Майкрософт.
секуребутсеттингс         | Базовый уровень доверенного платформенного модуля на этом узле не соответствует ни одному из доверенных в HGS. Это может произойти, если для запуска UEFI, переменная DBX, флаг отладки или пользовательские политики безопасной загрузки были изменены путем установки нового оборудования или программного обеспечения. Если вы доверяете текущему оборудованию, встроенному по и конфигурации программного обеспечения этого компьютера, вы можете [записать новый базовый модуль TPM](guarded-fabric-tpm-trusted-attestation-capturing-hardware.md#capture-the-tpm-baseline-for-each-unique-class-of-hardware) и [зарегистрировать его в HGS](guarded-fabric-manage-hgs.md#authorizing-new-guarded-hosts).
ткглогверификатион         | Не удается получить или проверить журнал TCG (базовый уровень TPM). Это может указывать на проблему с встроенным по, TPM или другим аппаратным компонентом узла. Если узел настроен на попытку загрузки PXE перед загрузкой Windows, эта ошибка также может быть вызвана устаревшей программой сетевой загрузки (NBP). Убедитесь, что все состав в актуальном состоянии при включенной загрузке PXE.
виртуалсекуремоде          | На узле не выполняются функции безопасности на основе виртуализации. Убедитесь, что VBS включен и что система соответствует настроенным [функциям безопасности платформы](https://technet.microsoft.com/itpro/windows/keep-secure/deploy-device-guard-enable-virtualization-based-security#validate-enabled-device-guard-hardware-based-security-features). Дополнительные сведения о требованиях к VBS см. в [документации по Device Guard](https://technet.microsoft.com/itpro/windows/keep-secure/device-guard-deployment-guide) .

## <a name="modern-tls"></a>Современный протокол TLS

Если вы развернули групповую политику или настроили узел Hyper-V таким образом, чтобы предотвратить использование TLS 1,0, может возникнуть ошибка "клиенту службы защиты узла не удалось расписать предохранитель ключа от имени вызывающего процесса" при попытке запуска экранированной виртуальной машины.
Это связано с поведением по умолчанию в .NET 4,6, где системная версия TLS по умолчанию не учитывается при согласовании поддерживаемых версий TLS с сервером HGS.

Чтобы обойти это поведение, выполните следующие две команды, чтобы настроить .NET для использования системных версий TLS по умолчанию для всех приложений .NET.

```cmd
reg add HKLM\SOFTWARE\Microsoft\.NETFramework\v4.0.30319 /v SystemDefaultTlsVersions /t REG_DWORD /d 1 /f /reg:64
reg add HKLM\SOFTWARE\Microsoft\.NETFramework\v4.0.30319 /v SystemDefaultTlsVersions /t REG_DWORD /d 1 /f /reg:32
```

> [!WARNING]
> Параметр системы версии TLS по умолчанию будет влиять на все приложения .NET на компьютере. Обязательно протестируйте разделы реестра в изолированной среде, прежде чем развертывать их на рабочих компьютерах.

Дополнительные сведения о .NET 4,6 и TLS 1,0 см. [в разделе решение проблемы tls 1,0, 2-го выпуска](https://docs.microsoft.com/security/solving-tls1-problem).
