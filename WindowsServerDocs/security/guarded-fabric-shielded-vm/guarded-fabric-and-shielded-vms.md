---
title: Обзор защищенной структуры и экранированных виртуальных машин
ms.topic: article
manager: dongill
author: rpsqrd
ms.author: ryanpu
ms.date: 08/29/2018
ms.openlocfilehash: 62098234f75a35d5c7ab4d386e5d2ce41aaa3641
ms.sourcegitcommit: b115e5edc545571b6ff4f42082cc3ed965815ea4
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/30/2020
ms.locfileid: "93071146"
---
# <a name="guarded-fabric-and-shielded-vms-overview"></a>Обзор защищенной структуры и экранированных виртуальных машин

>Область применения: Windows Server 2019, Windows Server (половина ежегодного канала), Windows Server 2016

## <a name="overview-of-the-guarded-fabric"></a>Обзор защищенной структуры

Безопасность виртуализации — это основная вложенная область в Hyper-V. Помимо защиты узлов или других виртуальных машин от ВМ с вредоносными программами необходимо также защитить их от скомпрометированного узла. Это фундаментальная опасность для каждой платформы виртуализации сегодня, будь то Hyper-V, VMware или любой другой. Простыми словами, если файл виртуальной машины извлекается из системы организации (злонамеренно или случайно), его можно запустить в любой другой системе. Защита ценных ресурсов, таких как контроллеры домена, конфиденциальные файловые серверы и системы отдела кадров, — самая приоритетная задача в организации.

Чтобы помочь защититься от скомпрометированной структуры виртуализации, в Windows Server 2016 Hyper-V появились экранированные виртуальные машины. Экранированная виртуальная машина — это виртуальная машина поколения 2 (поддерживается в Windows Server 2012 и более поздних версиях) с виртуальным доверенным платформенным модулем, шифруется с помощью BitLocker и может выполняться только на работоспособных и утвержденных узлах в структуре. Благодаря экранированным виртуальным машинам и защищенной структуре поставщики облачных служб или администраторы корпоративного частного облака предоставляют более безопасную среду для клиентских виртуальных машин.

Защищенная структура состоит из:

- одной службы защиты узла (HGS) (как правило, кластера из 3-х узлов);
- одного или нескольких защищенных узлов;
- набора экранированных виртуальных машин. На схеме ниже показано, как служба защиты узла использует аттестации, чтобы обеспечить запуск экранированных виртуальных машин только на известных допустимых узлах, и безопасное освобождение ключей для этих виртуальных машин.

Когда клиент создает экранированные виртуальные машины, запущенные в защищенной структуре, узлы Hyper-V и эти виртуальные машины защищаются с помощью службы HGS. HGS предоставляет две различные службы: аттестации и защиты ключей. Служба аттестации гарантирует, что экранированные виртуальные машины могут запускаться только на доверенных узлах Hyper-V, тогда как служба защиты ключей предоставляет ключи, с помощью которых можно включить виртуальные машины и выполнить их динамическую миграцию на другие защищенные узлы.

![Структура защищенного узла](../media/Guarded-Fabric-Shielded-VM/Guarded-Host-Overview-Diagram.png)

## <a name="video-introduction-to-shielded-virtual-machines"></a>Видео: введение в экранированные виртуальные машины

> [!VIDEO https://channel9.msdn.com/Shows/Mechanics/Introduction-to-Shielded-Virtual-Machines-in-Windows-Server-2016/player]

## <a name="attestation-modes-in-the-guarded-fabric-solution"></a>Режимы аттестации в решении защищенной структуры

HGS поддерживает различные режимы аттестации для защищенной структуры:

- Аттестация, доверенная доверенным платформенным модулем (на основе оборудования)
- Аттестация ключа узла (на основе пар асимметричных ключей)

Рекомендуется использовать аттестацию по ключу доверенного платформенного модуля, так как она предоставляет более надежные гарантии, что описано в приведенной ниже таблице. Но в этом случае требуется, чтобы у узлов Hyper-V был доверенный платформенный модуль версии 2.0. Если в настоящее время нет доверенного платформенного модуля (TPM) 2,0 или TPM, можно использовать аттестацию ключа узла. Если вы приобретете новое оборудование и захотите перейти на аттестацию по ключу доверенного платформенного модуля, смените режим аттестации в службе защиты узла без прерывания или с минимальным прерыванием работы структуры.

| **Режим аттестации, выбираемый для узлов** | **Гарантии узла** |
|--|--|
| **Аттестация по ключу доверенного платформенного модуля:** предоставляет самую надежную защиту, но требует дополнительной настройки. Оборудование и встроенное по узла должны включать в себя TPM 2,0 и UEFI 2.3.1 с включенной безопасной загрузкой. | Защищенные узлы утверждаются на основе удостоверения доверенного платформенного модуля, измеряемой последовательности загрузки и политик целостности кода, чтобы гарантировать выполнение только утвержденного кода. |
| **Аттестация ключа узла:** Предназначен для поддержки существующего оборудования узла, когда доверенный платформенный модуль 2,0 недоступен. Такая аттестация требует меньше этапов настройки и совместима со стандартным серверным оборудованием. | Защищенные узлы утверждаются в зависимости от принадлежности ключа. |

Другой режим с именем **"Доверенная аттестация с правами администратора"** устарел, начиная с Windows Server 2019. Этот режим основан на защищенном членстве узла в назначенной группе безопасности домен Active Directory Services (AD DS). Аттестация ключа узла обеспечивает аналогичную идентификацию узла и проще в настройке.

## <a name="assurances-provided-by-the-host-guardian-service"></a>Гарантии, предоставляемые службой защиты узла

HGS, а также методы создания экранированных виртуальных машин обеспечивают следующие гарантии.

| **Тип гарантии для виртуальных машин**                         | **Гарантии экранированной виртуальной машины, предоставленные службой защиты ключей и методами создания экранированных виртуальных машин** |
|----------------------------|--------------------------------------------------|
| **Шифрование дисков с помощью BitLocker (диски ОС и диски данных)**   | Экранированные виртуальные машины используют BitLocker для защиты своих дисков. Ключи BitLocker, необходимые для загрузки виртуальной машины и расшифровки дисков, защищаются виртуальным доверенным платформенным модулем экранированной виртуальной машины с помощью проверенных отраслевых технологий, таких как безопасная измеряемая загрузка. Хотя экранированные виртуальные машины автоматически шифруют и защищают только диск операционной системы, можно также [шифровать диски с данными](/windows/security/information-protection/bitlocker/bitlocker-overview), подключенные к этим машинам. |
| **Развертывание новых экранированных виртуальных машин из "доверенных" шаблонов дисков и образов** | При развертывании новых экранированных виртуальных машин клиенты могут указать, каким шаблонам дисков они доверяют. В экранированных шаблонах дисков есть подписи, которые определяются в тот момент, когда их содержимое распознается как надежное. Подписи дисков затем сохраняются в каталоге подписей, который безопасно передается клиентами структуре при создании экранированных виртуальных машин. Во время подготовки экранированных виртуальных машин подпись диска определяется снова и сравнивается с доверенными подписями в каталоге. Если подписи совпадают, машина развертывается. В противном случае шаблон диска такой машины считается ненадежным и происходит сбой развертывания. |
| **Защита паролей и других секретов при создании экранированной виртуальной машины** | При создании виртуальных машин необходимо убедиться, что секреты виртуальной машины, такие как подписи доверенных дисков, сертификаты RDP и пароль учетной записи локального администратора виртуальной машины, не будут представлены в структуре. Эти секреты хранятся в файле данных экранирования (PDK-файле) — зашифрованном файле, который защищен ключами клиента и отправлен клиентом в структуру. При создании экранированной виртуальной машины клиент выбирает, какие данные экранирования использовать. При этом секреты безопасно передаются доверенным компонентам внутри защищенной структуры. |
| **Контроль на уровне клиента в отношении структуры для запуска виртуальной машины** | Данные экранирования также содержат список защищенных структур, в которых разрешен запуск определенной экранированной виртуальной машины. Это полезно в случаях, когда экранированная виртуальная машина обычно находится в локальном частном облаке, но для аварийного восстановления ее нужно перенести в другое облако (частное или общедоступное). Целевое облако или структура должны поддерживать экранированные виртуальные машины, и эти машины должны разрешать запуск в этой структуре. |

## <a name="what-is-shielding-data-and-why-is-it-necessary"></a>Что такое данные экранирования и зачем они нужны

Файл данных экранирования (также называемый файлом данных подготовки, или PDK-файлом) — это зашифрованный файл, который создает клиент или владелец виртуальной машины, чтобы защитить важную информацию о конфигурации виртуальной машины (пароль администратора, протокол удаленного рабочего стола и другие сертификаты с информацией об удостоверениях, учетные данные для присоединения домена и т. д.). Администратор структуры использует файл данных экранирования при создании экранированной виртуальной машины, но не может просматривать и использовать содержащиеся в нем сведения.

Кроме того, файлы данных экранирования содержат следующие секреты:

- Учетные данные администратора.
- Файл ответов (unattend.xml).
- Политика безопасности, определяющая, будут ли виртуальные машины, созданные с помощью этих данных экранирования, настроены как экранированные или поддерживают шифрование.
    - Обратите внимание, что виртуальные машины, настроенные как экранированные, защищены от администраторов структуры, а виртуальные машины с поддержкой шифрования — нет.
- Сертификат протокола удаленного рабочего стола для безопасного взаимодействия с виртуальной машиной.
- Каталог подписей томов со списком доверенных подписанных шаблонов дисков, которые можно использовать для создания виртуальной машины.
- Предохранитель ключа, определяющий, в каких защищенных структурах может запускаться экранированная виртуальная машина.

Файл данных экранирования (PDK-файл) гарантирует, что виртуальная машина будет создана так, как предполагал клиент. Например, когда клиент размещает файл ответов (unattend.xml) в файле данных экранирования и передает его поставщику услуг размещения, последний не может просматривать файл ответов или вносить в него изменения. Поставщик услуг размещения также не может указать другой VHDX при создании экранированной виртуальной машины, так как файл данных экранирования содержит подписи доверенных дисков, на основе которых можно создать экранированные виртуальные машины.

На рисунке ниже показан файл данных экранирования и связанные с ним элементы конфигурации.

![Файл данных экранирования](../media/Guarded-Fabric-Shielded-VM/shielded-vms-shielding-data-file.png)

## <a name="what-are-the-types-of-virtual-machines-that-a-guarded-fabric-can-run"></a>Типы виртуальных машин, которые могут выполняться в защищенной структуре

В защищенной структуре могут запускаться виртуальные машины одного из следующих типов:

1. Обычная виртуальная машина, которая не обеспечивает защиту, представленную только в предыдущих версиях Hyper-V.
2. Виртуальная машина с поддержкой шифрования, защиту которой может настроить администратор структуры.
3. Экранированная виртуальная машина, все средства защиты которой постоянно включены и не могут быть отключены администратором структуры.

Виртуальные машины с поддержкой шифрования предназначены для случаев, когда есть полное доверие к администратору структуры.  Например, предприятие может развернуть защищенную структуру, чтобы выполнять для дисков виртуальной машины шифрование неактивных данных с целью соответствия требованиям. Администраторы структуры по-прежнему могут использовать удобные средства управления, например подключения к консоли виртуальной машины, PowerShell Direct и другие повседневные средства управления и устранения неполадок.

Экранированные виртуальные машины предназначены для структур, где данные и состояние виртуальной машины должны быть защищены как от администраторов структуры, так и от ненадежного программного обеспечения, которое может выполняться на узлах Hyper-V. К примеру, экранированные виртуальные машины никогда не разрешат подключение к консоли виртуальной машины, тогда как для виртуальных машин с поддержкой шифрования администратор структуры может включить или отключить эту защиту.

В следующей таблице перечислены различия между поддерживаемыми шифрованием и экранированными виртуальными машинами.

| Функция        | Второе поколение. Поддержка шифрования     | Второе поколение. Экранирование         |
|----------|--------------------|----------------|
|Безопасная загрузка        | Да, необходимо, но есть возможность настройки        | Да, необходимо, применяется принудительно    |
|Виртуальный доверенный платформенный модуль               | Да, необходимо, но есть возможность настройки        | Да, необходимо, применяется принудительно    |
|Шифрование состояния виртуальной машины и трафика динамической миграции | Да, необходимо, но есть возможность настройки |  Да, необходимо, применяется принудительно  |
|Компоненты интеграции | Настраивается администратором структуры      | Некоторые компоненты интеграции заблокированы (например, обмен данными, PowerShell Direct) |
|Подключение к виртуальной машине (консоль), HID-устройства (например, клавиатура, мышь) | Включено, не может быть отключено | Включено на узлах, начинающихся с Windows Server версии 1803; Отключено на более ранних узлах |
|Последовательные или COM-порты   | Поддерживается                             | Отключено (не может быть включено) |
|Подключение отладчика (к процессу виртуальной машины)<sup>1</sup>| Поддерживается          | Отключено (не может быть включено) |

<sup>1</sup> Традиционные отладчики, которые присоединяются непосредственно к процессу, например WinDbg.exe, заблокированы для экранированных виртуальных машин, так как рабочий процесс виртуальной машины (VMWP.exe) является защищенным процессом (PPL).
Альтернативные методы отладки, такие как используемые LiveKd.exe, не блокируются.
В отличие от экранированных виртуальных машин, Рабочий процесс для поддерживаемых шифрованием виртуальных машин не выполняется в виде PPL, поэтому традиционные отладчики, такие как WinDbg.exe, будут продолжать работать в обычном режиме.

Как экранированные виртуальные машины, так и виртуальные машины с поддержкой шифрования продолжают поддерживать стандартные возможности управления структуры, в том числе динамическую миграцию, реплику Hyper-V, контрольные точки виртуальной машины и т. д.

## <a name="the-host-guardian-service-in-action-how-a-shielded-vm-is-powered-on"></a>Служба защиты узла в действии. Включение экранированной виртуальной машины

![Файл данных экранирования](../media/Guarded-Fabric-Shielded-VM/shielded-vms-how-a-shielded-vm-is-powered-on.png)

1. **Включается виртуальная машина VM01.** Прежде чем защищенный узел сможет включить экранированную виртуальную машину, нужно подтвердить его работоспособность. Чтобы доказать, что он работоспособен, он должен предоставить сертификат работоспособности службе защиты ключей. Он передается в ходе аттестации.

2. **Узел запрашивает аттестацию.** Защищенный узел запрашивает аттестацию. Режим аттестации устанавливается службой защиты узла.

    - **Аттестация, доверенная доверенным платформенным модулем** . узел Hyper-V отправляет сведения, содержащие:
      - сведения, определяющие доверенный платформенный модуль (ключ подтверждения);
      - сведения о процессах, запущенных в течение последней последовательности загрузки (журнал TCG);
      - Сведения о политике целостности кода (CI), примененной на узле.

        Аттестация происходит при запуске узла, а затем каждые 8 часов. Если по какой-либо причине у узла нет сертификата аттестации при попытке запуска виртуальной машины, это также активирует аттестацию.

    - **Аттестация ключа узла** . узел Hyper-V отправляет открытую половину пары ключей. HGS проверяет, что ключ узла зарегистрирован.

    - **Аттестация по группе доверенного администратора.** Узел Hyper-V отправляет билет Kerberos, который определяет группы безопасности, в которые входит узел. HGS проверяет, принадлежит ли узел к группе безопасности, которую ранее настроил доверенный администратор HGS.

3. **Аттестация завершается успешно (или с ошибкой).** Режим аттестации определяет, какие проверки необходимы для успешной аттестации работоспособности узла. При использовании аттестации, доверенной для доверенного платформенного модуля, проверяется удостоверение TPM узла, измерения загрузки и политика целостности кода. При использовании аттестации ключа узла проверяется только регистрация ключа узла.

4. **Сертификат аттестации отправляется на узел.** Предполагая, что аттестация прошла успешно, сертификат работоспособности отправляется на узел, а узел считается защищенным (разрешено запускать экранированные виртуальные машины). Узел использует сертификат работоспособности для авторизации службы защиты ключей, чтобы безопасно освободить ключи, необходимые для работы экранированных виртуальных машин.

5. **Узел запрашивает ключ виртуальной машины.** У защищенного узла отсутствуют ключи, необходимые для включения экранированной виртуальной машины (в этом случае VM01). Чтобы получить необходимые ключи, защищенный узел должен предоставить службе защиты ключей следующее:

   - текущий сертификат работоспособности;
   - зашифрованный секрет (предохранитель ключа), содержащий необходимые для включения VM01 ключи. Секрет зашифрован с использованием других ключей, известных только службе защиты ключей.

6. **Ключ освобождается.** Служба защиты ключей проверяет сертификат работоспособности на допустимость. Сертификат не должен быть просрочен, и служба защиты ключей должна доверять службе аттестации, выдавшей его.

7. **Ключ возвращается на узел.** Если сертификат работоспособности допустим, служба защиты ключей пытается расшифровать секрет и безопасно вернуть ключи, необходимые для включения виртуальной машины. Обратите внимание, что ключи шифруются в VBS защищенного узла.

8. **Узел запускает VM01.**

## <a name="guarded-fabric-and-shielded-vm-glossary"></a>Словарь терминов, касающихся защищенной структуры и экранированной виртуальной машины

| Термин              | Определение           |
|----------|------------|
| Служба защиты узла | Роль сервера Windows, который установлен на защищенном кластере серверов без операционной системы. Он может оценить работоспособность узла Hyper-V и освободить ключи для работоспособных узлов во время включения или динамической миграции экранированных виртуальных машин. Эти две возможности играют главную роль в решении экранированной виртуальной машины и называются **службой аттестации** и **службой защиты ключей** соответственно. |
| Защищенный узел | Узел Hyper-V, на котором могут запускаться экранированные виртуальные машины. Узел может считаться _защищенным_ только в том случае, если он был признан работоспособным службой аттестации HGS. Экранированные виртуальные машины невозможно включить на узле Hyper-V или динамически мигрировать на него, если он еще не прошел аттестацию или она завершилась неудачно. |
| Защищенная структура    | Это обобщающий термин для описания структуры узлов Hyper-V и их службы защиты. Структура может запускать экранированные виртуальные машины и управлять ими. |
| Экранированная виртуальная машина | Виртуальная машина, которая может запускаться только на защищенных узлах и защищена от просмотра, несанкционированного изменения и кражи данных администраторами вредоносных систем и вредоносными программами. |
| Администратор структуры | Администратор общедоступного или частного облака, который может управлять виртуальными машинами. В контексте защищенной структуры у администратора структуры нет доступа к экранированным виртуальным машинам или к политикам, определяющим узлы, на которых могут запускаться экранированные виртуальные машины. |
| Администратор службы защиты узла | Доверенный администратор общедоступного или частного облака, который может управлять политикой и материалами шифрования для защищенных узлов, то есть таких, на которых может запускаться экранированная виртуальная машина.|
| Файл данных подготовки или файл данных экранирования (PDK-файл) | Зашифрованный файл, который создается клиентом или пользователем для хранения важной информации о конфигурации виртуальной машины и защиты этой информации от несанкционированного доступа. Например, файл данных экранирования может содержать пароль, который будет назначен учетной записи локального администратора при создании виртуальной машины. |
| Безопасность на основе виртуализации | Среда обработки и хранения на основе Hyper-V, защищенная от администраторов. Администратор операционной системы не может получить доступ к ключам операционной системы, которые сохранены в виртуальном безопасном режиме.|
| Виртуальный доверенный платформенный модуль | Виртуализированная версия доверенного платформенного модуля (TPM). Начиная с Hyper-V в Windows Server 2016, вы можете предоставить виртуальному модулю TPM 2,0, чтобы можно было шифровать виртуальные машины, точно так же, как физический доверенный платформенный модуль позволяет шифровать физический компьютер.|

## <a name="additional-references"></a>Дополнительные ссылки

- [Защищенная структура и экранированные виртуальные машины](guarded-fabric-and-shielded-vms-top-node.md)
- Блог: [блог по безопасности центра обработки данных и частного облака](/archive/blogs/datacentersecurity/)
- Видео: [Введение в экранированные виртуальные машины](https://channel9.msdn.com/Shows/Mechanics/Introduction-to-Shielded-Virtual-Machines-in-Windows-Server-2016)
- Видео. перейдем [к экранированным виртуальным машинам с помощью Windows Server 2016 Hyper-V](https://channel9.msdn.com/events/Ignite/2016/BRK3124)