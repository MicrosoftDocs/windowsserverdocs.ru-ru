---
title: Создание политик безопасности с использованием расширенных списков управления доступом для портов
description: В этом разделе сведения о расширенных портов, списки управления доступом (ACL) в Windows Server 2016.
manager: brianlic
ms.custom: na
ms.prod: windows-server-threshold
ms.reviewer: na
ms.suite: na
ms.technology: networking-hv-switch
ms.tgt_pltfrm: na
ms.topic: article
ms.assetid: a92e61c3-f7d4-4e42-8575-79d75d05a218
ms.author: pashort
author: shortpatti
ms.openlocfilehash: d847213f0332b57ae38ada444d7a6cd98ab325ca
ms.sourcegitcommit: 0d0b32c8986ba7db9536e0b8648d4ddf9b03e452
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2019
ms.locfileid: "59848985"
---
# <a name="create-security-policies-with-extended-port-access-control-lists"></a>Создание политик безопасности с использованием расширенных списков управления доступом для портов

>Область применения. Windows Server (полугодовой канал), Windows Server 2016

В этом разделе сведения о расширенных портов, списки управления доступом (ACL) в Windows Server 2016. Можно настроить расширенные списки ACL на виртуальном коммутаторе Hyper-V для разрешения и блокировки сетевого трафика, передающегося между виртуальными машинами, подключенными к коммутатору через виртуальные сетевые адаптеры.  
  
Эта статья содержит следующие разделы.  
  
-   [Подробные правила списков ACL](#bkmk_detailed)  
  
-   [Правила ACL с отслеживанием состояния](#bkmk_stateful)  
  
## <a name="bkmk_detailed"></a>Подробные правила списков ACL  
Расширенные списки ACL виртуального коммутатора Hyper-V позволяют создать Подробные правила, которые можно применять к отдельным сетевым адаптерам виртуальной Машины, подключенные к виртуальному коммутатору Hyper-V. Возможность создания подробных правил позволяет предприятий и поставщиков облачных служб (CSP) на угрозы безопасности, сетевой адрес в мультитенантной общей серверной среде.  
  
Используя расширенные списки ACL, вместо того чтобы создавать общие правила, блокирующие или разрешающие весь трафик, передающийся между виртуальными машинами по всем протоколам, вы можете блокировать или разрешать сетевой трафик отдельных протоколов, работающих на виртуальных машинах. Можно создать правила расширенных списков ACL в Windows Server 2016, включающие следующий пятикортежный набор параметров: исходный адрес IP-адрес, IP-адрес назначения, протокол, порт источника и порт назначения. Кроме того, каждое правило может определять направление сетевого трафика (входящий или исходящий) и поддерживаемое действие (блокировать или разрешать трафик).  
  
Например, можно настроить для виртуальной машины списки ACL для портов так, чтобы разрешать весь входящий и исходящий трафик HTTP и HTTPS на порте 80 и блокировать сетевой трафик всех прочих протоколов на всех портах.  
  
Эта возможность задать трафик протокола, который разрешено или запрещено получать клиентским виртуальным машинам, обеспечивает гибкость при настройке политик безопасности.  
  
### <a name="configuring-acl-rules-with-windows-powershell"></a>Настройка правил списков ACL с помощью Windows PowerShell  
Для настройки расширенного списка ACL необходимо использовать команду Windows PowerShell **Add-VMNetworkAdapterExtendedAcl**. У этой команды четыре разных типа синтаксиса со своими отдельными функциями:  
  
1.  Добавление расширенного списка ACL для всех сетевых адаптеров виртуальной машины именованный - указывается первым параметром, - VMName. Синтаксис:  
  
    > [!NOTE]  
    > Если вы хотите добавить расширенного списка ACL для одного сетевого адаптера, а не все, можно указать сетевой адаптер с параметром - VMNetworkAdapterName.  
  
    ```  
    Add-VMNetworkAdapterExtendedAcl [-VMName] <string[]> [-Action] <VMNetworkAdapterExtendedAclAction> {Allow | Deny}  
        [-Direction] <VMNetworkAdapterExtendedAclDirection> {Inbound | Outbound} [[-LocalIPAddress] <string>]  
        [[-RemoteIPAddress] <string>] [[-LocalPort] <string>] [[-RemotePort] <string>] [[-Protocol] <string>] [-Weight]  
        <int> [-Stateful <bool>] [-IdleSessionTimeout <int>] [-IsolationID <int>] [-Passthru] [-VMNetworkAdapterName  
        <string>] [-ComputerName <string[]>] [-WhatIf] [-Confirm]  [<CommonParameters>]  
    ```  
  
2.  Добавление расширенного списка ACL для конкретного виртуального сетевого адаптера на определенной виртуальной машине. Синтаксис:  
  
    ```  
    Add-VMNetworkAdapterExtendedAcl [-VMNetworkAdapter] <VMNetworkAdapterBase[]> [-Action]  
        <VMNetworkAdapterExtendedAclAction> {Allow | Deny} [-Direction] <VMNetworkAdapterExtendedAclDirection> {Inbound |  
        Outbound} [[-LocalIPAddress] <string>] [[-RemoteIPAddress] <string>] [[-LocalPort] <string>] [[-RemotePort]  
        <string>] [[-Protocol] <string>] [-Weight] <int> [-Stateful <bool>] [-IdleSessionTimeout <int>] [-IsolationID  
        <int>] [-Passthru] [-WhatIf] [-Confirm]  [<CommonParameters>]  
    ```  
  
3.  Добавление расширенного списка ACL для всех виртуальных сетевых адаптеров, зарезервированных для использования операционной системой управления узлами Hyper-V.  
  
    > [!NOTE]  
    > Если вы хотите добавить расширенного списка ACL для одного сетевого адаптера, а не все, можно указать сетевой адаптер с параметром - VMNetworkAdapterName.  
  
    ```  
    Add-VMNetworkAdapterExtendedAcl [-Action] <VMNetworkAdapterExtendedAclAction> {Allow | Deny} [-Direction]  
        <VMNetworkAdapterExtendedAclDirection> {Inbound | Outbound} [[-LocalIPAddress] <string>] [[-RemoteIPAddress]  
        <string>] [[-LocalPort] <string>] [[-RemotePort] <string>] [[-Protocol] <string>] [-Weight] <int> -ManagementOS  
        [-Stateful <bool>] [-IdleSessionTimeout <int>] [-IsolationID <int>] [-Passthru] [-VMNetworkAdapterName <string>]  
        [-ComputerName <string[]>] [-WhatIf] [-Confirm]  [<CommonParameters>]  
    ```  
  
4.  Добавление расширенного списка ACL для объекта виртуальной Машины, созданной в Windows PowerShell, таких как **$vm = get-vm «my_vm»**. В следующей строке кода можно выполнить эту команду для создания расширенного списка ACL со следующим синтаксисом:  
  
    ```  
    Add-VMNetworkAdapterExtendedAcl [-VM] <VirtualMachine[]> [-Action] <VMNetworkAdapterExtendedAclAction> {Allow |  
        Deny} [-Direction] <VMNetworkAdapterExtendedAclDirection> {Inbound | Outbound} [[-LocalIPAddress] <string>]  
        [[-RemoteIPAddress] <string>] [[-LocalPort] <string>] [[-RemotePort] <string>] [[-Protocol] <string>] [-Weight]  
        <int> [-Stateful <bool>] [-IdleSessionTimeout <int>] [-IsolationID <int>] [-Passthru] [-VMNetworkAdapterName  
        <string>] [-WhatIf] [-Confirm]  [<CommonParameters>]  
    ```  
  
### <a name="detailed-acl-rule-examples"></a>Примеры подробных правил списков ACL  
Далее приведены несколько примеров возможного использования команды **Add-VMNetworkAdapterExtendedAcl** для настройки расширенных списков ACL для портов и для создания политик безопасности виртуальных машин.  
  
-   [Применение политик безопасности на уровне приложения](#bkmk_enforce)  
  
-   [Применение политик безопасности на уровне пользователя и уровня приложения](#bkmk_both)  
  
-   [Обеспечение поддержки безопасности для приложения не TCP/UDP](#bkmk_tcp)  
  
> [!NOTE]  
> Значения параметра правила **Направление** в таблице ниже определяются направлением потока трафика (входящий или исходящий) виртуальной машины, для которой создается правило. Если виртуальная машина принимает трафик, он является входящим, если отправляет — исходящим. Например, если к виртуальной машине применяется правило, блокирующее входящий трафик, направление входящего трафика будет от внешних ресурсов к виртуальной машине. Если применяется правило, блокирующее исходящий трафик, направление исходящего трафика будет от локальной виртуальной машины к внешним ресурсам.  
  
### <a name="bkmk_enforce"></a>Применение политик безопасности на уровне приложения  
Поскольку многие серверы приложений используют стандартизированные порты TCP/UDP для взаимодействия с клиентскими компьютерами, можно легко создать правила, блокирующие или разрешающие доступ к серверу приложений, путем фильтрации трафика, поступающего на порт, назначенный приложению, и отправляемого с этого порта.  
  
Например, можно разрешить пользователю вход на сервер приложений в центре обработки данных при помощи подключения к удаленному рабочему столу (RDP). Так как RDP использует порт TCP 3389, можно настроить следующее правило:  
  
|Исходный IP-адрес|IP-адрес назначения|Используемый протокол|Порт источника|Порт назначения|Direction|Действие|  
|-------------|------------------|------------|---------------|--------------------|-------------|----------|  
|*|*|TCP|*|3389|In|Разрешить|  
  
Далее приведены два примера создания правил с помощью команд Windows PowerShell. Правило в первом примере блокирует весь трафик к виртуальной Машине с именем «ApplicationServer.» Правило во втором примере, которая применяется к сетевому адаптеру виртуальной машины с именем «ApplicationServer», разрешает только входящий трафик протокола удаленного рабочего СТОЛА виртуальной Машины.  
  
> [!NOTE]  
> При создании правила можно использовать **-вес** параметра для определения порядка, в котором виртуальный коммутатор Hyper-V обработки правил. Значения для **-вес** выражаются в виде целых чисел; правила с более высокими обрабатываются раньше правил с более низкими значениями. Например, если к сетевому адаптеру виртуальной машины применяется два правила, одно с весовым коэффициентом 1, другое с весовым коэффициентом 10, то второе правило будет обработано раньше.  
  
```  
Add-VMNetworkAdapterExtendedAcl -VMName "ApplicationServer" -Action "Deny" -Direction "Inbound" -Weight 1  
Add-VMNetworkAdapterExtendedAcl -VMName "ApplicationServer" -Action "Allow" -Direction "Inbound" -LocalPort 3389 -Protocol "TCP" -Weight 10  
```  
  
### <a name="bkmk_both"></a>Применение политик безопасности на уровне пользователя и уровня приложения  
Поскольку правило может сопоставляться с пятикортежным IP-пакетом (исходный IP-адрес, конечный IP-адрес, протокол, порт источника и порт назначения), правило может применять более подробную политику безопасности по сравнению со списком ACL для порта.  
  
Например если вы хотите предоставить службе DHCP ограниченному числу клиентских компьютеров, используя определенный набор DHCP-серверы, на компьютере Windows Server 2016, на котором выполняется Hyper-V, где размещены пользовательские виртуальные машины можно настроить следующие правила:  
  
|Исходный IP-адрес|IP-адрес назначения|Используемый протокол|Порт источника|Порт назначения|Direction|Действие|  
|-------------|------------------|------------|---------------|--------------------|-------------|----------|  
|*|255.255.255.255|UDP|*|67|Из|Разрешить|  
|*|10.175.124.0/25|UDP|*|67|Из|Разрешить|  
|10.175.124.0/25|*|UDP|*|68|In|Разрешить|  
  
Далее приведены примеры создания этих правил с помощью команд Windows PowerShell.  
  
```  
Add-VMNetworkAdapterExtendedAcl -VMName "ServerName" -Action "Deny" -Direction "Outbound" -Weight 1  
Add-VMNetworkAdapterExtendedAcl -VMName "ServerName" -Action "Allow" -Direction "Outbound" -RemoteIPAddress 255.255.255.255 -RemotePort 67 -Protocol "UDP"-Weight 10  
Add-VMNetworkAdapterExtendedAcl -VMName "ServerName" -Action "Allow" -Direction "Outbound" -RemoteIPAddress 10.175.124.0/25 -RemotePort 67 -Protocol "UDP"-Weight 20  
Add-VMNetworkAdapterExtendedAcl -VMName "ServerName" -Action "Allow" -Direction "Inbound" -RemoteIPAddress 10.175.124.0/25 -RemotePort 68 -Protocol "UDP"-Weight 20  
```  
  
### <a name="bkmk_tcp"></a>Обеспечение поддержки безопасности для приложения не TCP/UDP  
Хотя большая часть трафика в центре обработки данных — это трафик TCP и UDP, часть трафика использует другие протоколы. Например, чтобы разрешить группе серверов запускать приложение многоадресной IP-рассылки, использующее протокол IGMP, можно создать следующее правило.  
  
> [!NOTE]  
> Назначенный номер IP-протокола для IGMP — 0x02.  
  
|Исходный IP-адрес|IP-адрес назначения|Используемый протокол|Порт источника|Порт назначения|Direction|Действие|  
|-------------|------------------|------------|---------------|--------------------|-------------|----------|  
|*|*|0x02|*|*|In|Разрешить|  
|*|*|0x02|*|*|Из|Разрешить|  
  
Далее приведен пример создания этих правил с помощью команд Windows PowerShell.  
  
```  
Add-VMNetworkAdapterExtendedAcl -VMName "ServerName" -Action "Allow" -Direction "Inbound" -Protocol 2 -Weight 20  
Add-VMNetworkAdapterExtendedAcl -VMName "ServerName" -Action "Allow" -Direction "Outbound" -Protocol 2 -Weight 20  
```  
  
## <a name="bkmk_stateful"></a>Правила ACL с отслеживанием состояния  
Еще одна новая возможность расширенных списков ACL — настройка правил с отслеживанием состояния. Правило с отслеживанием состояния фильтрует пакеты по пяти атрибутам - исходный IP-адрес, IP-адрес назначения, протокол, порт источника и порт назначения.  
  
Правила с отслеживанием состояния имеют следующие возможности:  
  
-   Они всегда разрешают трафик и не используются для его блокировки.  
  
-   Если значение параметра **Направление** — "Входящий" и трафик соответствует правилу, то виртуальный коммутатор Hyper-V динамически создает соответствующее правило, разрешающее виртуальной машине отправлять исходящий трафик внешнему ресурсу.  
  
-   Если значение параметра **Направление** — "Исходящий" и трафик соответствует правилу, то виртуальный коммутатор Hyper-V динамически создает соответствующее правило, разрешающее виртуальной машине принимать входящий трафик от внешнего ресурса.  
  
-   Они включают атрибут времени ожидания, выражаемый в секундах. Когда на коммутатор поступает сетевой пакет, соответствующий правилу с отслеживанием состояния, виртуальный коммутатор Hyper-V создает состояние таким образом, чтобы разрешить все последующие пакеты, передаваемые в обоих направлениях того же потока. Срок действия состояния истекает, когда отсутствует трафик в каком-либо направлении в течение периода, заданного значением времени ожидания.  
  
Далее приведен пример возможного использования правил с отслеживанием состояния.  
  
### <a name="allow-inbound-remote-server-traffic-only-after-it-is-contacted-by-the-local-server"></a>Разрешать входящий трафик удаленного сервера только после обращения к нему локального сервера  
В некоторых случаях правило с отслеживанием состояния необходимо использовать потому, что только оно позволяет отслеживать известное установленное соединение и отличать его от прочих подключений.  
  
Например, чтобы разрешить серверу приложений виртуальной машины инициировать подключения на порте 80 к веб-службам в Интернете и дать удаленным веб-серверам возможность отвечать на трафик виртуальной машины, можно настроить правило с отслеживанием состояния, разрешающее первоначальный исходящий трафик, передающийся с виртуальной машины веб-службам. Поскольку это правило с отслеживанием состояния, обратный трафик, поступающий с веб-серверов на виртуальную машину, также разрешен. Из соображений безопасности можно блокировать весь прочий входящий сетевой трафик, поступающий на виртуальную машину.  
  
Чтобы настроить такое правило, можно использовать параметры, указанные в таблице ниже.  
  
> [!NOTE]  
> В связи с ограничениями форматирования и объемом данных в этой таблице информация в ней отображается не так, как в предыдущих таблицах этого документа.  
  
|Параметр|Правило 1|Правило 2|Правило 3|  
|-------------|----------|----------|----------|  
|Исходный IP-адрес|*|*|*|  
|IP-адрес назначения|*|*|*|  
|Используемый протокол|*|*|TCP|  
|Порт источника|*|*|*|  
|Порт назначения|*|*|80|  
|Direction|In|Из|Из|  
|Действие|Запретить|Запретить|Разрешить|  
|С учетом состояния|Нет|Нет|Да|  
|Время ожидания (сек)|Н/Д|Н/Д|3600|  
  
Правило с отслеживанием состояния разрешает серверу приложений виртуальной машины подключаться к удаленному веб-серверу. При отправке первого пакета виртуальный коммутатор Hyper-V динамически создает два состояния потока, чтобы разрешить все пакеты, отправляемые на удаленный веб-сервер, и все пакеты, возвращающиеся с него. Когда поток пакетов между серверами прекращается, срок действия состояний потока истекает через назначенное время ожидания — 3600 секунд (один час).  
  
Далее приведен пример создания этих правил с помощью команд Windows PowerShell.  
  
```  
Add-VMNetworkAdapterExtendedAcl -VMName "ApplicationServer" -Action "Deny" -Direction "Inbound" -Weight 1   
Add-VMNetworkAdapterExtendedAcl -VMName "ApplicationServer" -Action "Deny" -Direction "Outbound" -Weight 1  
Add-VMNetworkAdapterExtendedAcl -VMName "ApplicationServer" -Action "Allow" -Direction "Outbound" 80 "TCP" -Weight 100 -Stateful -Timeout 3600  
```  
  


