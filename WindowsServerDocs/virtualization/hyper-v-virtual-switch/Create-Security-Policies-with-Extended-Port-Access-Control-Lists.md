---
title: Создание политик безопасности с использованием расширенных списков управления доступом для портов
description: В этом разделе содержатся сведения о расширенных списках управления доступом к портам (ACL) в Windows Server 2016.
manager: brianlic
ms.prod: windows-server
ms.technology: networking-hv-switch
ms.topic: article
ms.assetid: a92e61c3-f7d4-4e42-8575-79d75d05a218
ms.author: lizross
author: eross-msft
ms.openlocfilehash: e4ea3d118a00a4862ce9eb3f93b079f05cc1cd1b
ms.sourcegitcommit: b00d7c8968c4adc8f699dbee694afe6ed36bc9de
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/08/2020
ms.locfileid: "80853317"
---
# <a name="create-security-policies-with-extended-port-access-control-lists"></a>Создание политик безопасности с использованием расширенных списков управления доступом для портов

>Область применения: Windows Server (Semi-Annual Channel), Windows Server 2016

В этом разделе содержатся сведения о расширенных списках управления доступом к портам (ACL) в Windows Server 2016. Можно настроить расширенные списки ACL на виртуальном коммутаторе Hyper-V для разрешения и блокировки сетевого трафика, передающегося между виртуальными машинами, подключенными к коммутатору через виртуальные сетевые адаптеры.  
  
В этом разделе содержатся следующие подразделы:  
  
-   [Подробные правила ACL](#bkmk_detailed)  
  
-   [Правила списков управления доступом с отслеживанием состояния](#bkmk_stateful)  
  
## <a name="detailed-acl-rules"></a><a name="bkmk_detailed"></a>Подробные правила ACL  
Расширенные списки управления доступом виртуального коммутатора Hyper-V позволяют создавать подробные правила, которые можно применять к отдельным сетевым адаптерам виртуальных машин, подключенным к виртуальному коммутатору Hyper-V. Возможность создания подробных правил позволяет предприятиям и поставщикам облачных служб (CSP) устранять угрозы сетевой безопасности в многоклиентской среде общего сервера.  
  
Используя расширенные списки ACL, вместо того чтобы создавать общие правила, блокирующие или разрешающие весь трафик, передающийся между виртуальными машинами по всем протоколам, вы можете блокировать или разрешать сетевой трафик отдельных протоколов, работающих на виртуальных машинах. Вы можете создать расширенные правила ACL в Windows Server 2016, которые включают в себя следующий набор параметров из пяти кортежей: исходный IP-адрес, IP-адрес назначения, протокол, исходный порт и порт назначения. Кроме того, каждое правило может определять направление сетевого трафика (входящий или исходящий) и поддерживаемое действие (блокировать или разрешать трафик).  
  
Например, можно настроить для виртуальной машины списки ACL для портов так, чтобы разрешать весь входящий и исходящий трафик HTTP и HTTPS на порте 80 и блокировать сетевой трафик всех прочих протоколов на всех портах.  
  
Эта возможность задать трафик протокола, который разрешено или запрещено получать клиентским виртуальным машинам, обеспечивает гибкость при настройке политик безопасности.  
  
### <a name="configuring-acl-rules-with-windows-powershell"></a>Настройка правил списков ACL с помощью Windows PowerShell  
Для настройки расширенного списка ACL необходимо использовать команду Windows PowerShell **Add-VMNetworkAdapterExtendedAcl**. У этой команды четыре разных типа синтаксиса со своими отдельными функциями:  
  
1.  Добавьте расширенный список ACL для всех сетевых адаптеров именованной виртуальной машины, который указывается первым параметром-VMName. Синтаксис:  
  
    > [!NOTE]  
    > Если требуется добавить расширенный список ACL к одному сетевому адаптеру, а не ко всем, можно указать сетевой адаптер с параметром-Вмнетворкадаптернаме.  
  
    ```  
    Add-VMNetworkAdapterExtendedAcl [-VMName] <string[]> [-Action] <VMNetworkAdapterExtendedAclAction> {Allow | Deny}  
        [-Direction] <VMNetworkAdapterExtendedAclDirection> {Inbound | Outbound} [[-LocalIPAddress] <string>]  
        [[-RemoteIPAddress] <string>] [[-LocalPort] <string>] [[-RemotePort] <string>] [[-Protocol] <string>] [-Weight]  
        <int> [-Stateful <bool>] [-IdleSessionTimeout <int>] [-IsolationID <int>] [-Passthru] [-VMNetworkAdapterName  
        <string>] [-ComputerName <string[]>] [-WhatIf] [-Confirm]  [<CommonParameters>]  
    ```  
  
2.  Добавление расширенного списка ACL для конкретного виртуального сетевого адаптера на определенной виртуальной машине. Синтаксис:  
  
    ```  
    Add-VMNetworkAdapterExtendedAcl [-VMNetworkAdapter] <VMNetworkAdapterBase[]> [-Action]  
        <VMNetworkAdapterExtendedAclAction> {Allow | Deny} [-Direction] <VMNetworkAdapterExtendedAclDirection> {Inbound |  
        Outbound} [[-LocalIPAddress] <string>] [[-RemoteIPAddress] <string>] [[-LocalPort] <string>] [[-RemotePort]  
        <string>] [[-Protocol] <string>] [-Weight] <int> [-Stateful <bool>] [-IdleSessionTimeout <int>] [-IsolationID  
        <int>] [-Passthru] [-WhatIf] [-Confirm]  [<CommonParameters>]  
    ```  
  
3.  Добавление расширенного списка ACL для всех виртуальных сетевых адаптеров, зарезервированных для использования операционной системой управления узлами Hyper-V.  
  
    > [!NOTE]  
    > Если требуется добавить расширенный список ACL к одному сетевому адаптеру, а не ко всем, можно указать сетевой адаптер с параметром-Вмнетворкадаптернаме.  
  
    ```  
    Add-VMNetworkAdapterExtendedAcl [-Action] <VMNetworkAdapterExtendedAclAction> {Allow | Deny} [-Direction]  
        <VMNetworkAdapterExtendedAclDirection> {Inbound | Outbound} [[-LocalIPAddress] <string>] [[-RemoteIPAddress]  
        <string>] [[-LocalPort] <string>] [[-RemotePort] <string>] [[-Protocol] <string>] [-Weight] <int> -ManagementOS  
        [-Stateful <bool>] [-IdleSessionTimeout <int>] [-IsolationID <int>] [-Passthru] [-VMNetworkAdapterName <string>]  
        [-ComputerName <string[]>] [-WhatIf] [-Confirm]  [<CommonParameters>]  
    ```  
  
4.  Добавьте расширенный список ACL для объекта виртуальной машины, созданного в Windows PowerShell, например **$VM = Get-VM "my_vm"** . В следующей строке кода можно выполнить эту команду для создания расширенного списка ACL со следующим синтаксисом:  
  
    ```  
    Add-VMNetworkAdapterExtendedAcl [-VM] <VirtualMachine[]> [-Action] <VMNetworkAdapterExtendedAclAction> {Allow |  
        Deny} [-Direction] <VMNetworkAdapterExtendedAclDirection> {Inbound | Outbound} [[-LocalIPAddress] <string>]  
        [[-RemoteIPAddress] <string>] [[-LocalPort] <string>] [[-RemotePort] <string>] [[-Protocol] <string>] [-Weight]  
        <int> [-Stateful <bool>] [-IdleSessionTimeout <int>] [-IsolationID <int>] [-Passthru] [-VMNetworkAdapterName  
        <string>] [-WhatIf] [-Confirm]  [<CommonParameters>]  
    ```  
  
### <a name="detailed-acl-rule-examples"></a>Примеры подробных правил списков ACL  
Далее приведены несколько примеров возможного использования команды **Add-VMNetworkAdapterExtendedAcl** для настройки расширенных списков ACL для портов и для создания политик безопасности виртуальных машин.  
  
-   [Обеспечение безопасности на уровне приложения](#bkmk_enforce)  
  
-   [Обеспечение безопасности на уровне пользователей и приложений](#bkmk_both)  
  
-   [Обеспечение поддержки безопасности для приложения, не поддерживающего TCP/UDP](#bkmk_tcp)  
  
> [!NOTE]  
> Значения параметра правила **Направление** в таблице ниже определяются направлением потока трафика (входящий или исходящий) виртуальной машины, для которой создается правило. Если виртуальная машина принимает трафик, он является входящим, если отправляет — исходящим. Например, если к виртуальной машине применяется правило, блокирующее входящий трафик, направление входящего трафика будет от внешних ресурсов к виртуальной машине. Если применяется правило, блокирующее исходящий трафик, направление исходящего трафика будет от локальной виртуальной машины к внешним ресурсам.  
  
### <a name="enforce-application-level-security"></a><a name="bkmk_enforce"></a>Обеспечение безопасности на уровне приложения  
Поскольку многие серверы приложений используют стандартизированные порты TCP/UDP для взаимодействия с клиентскими компьютерами, можно легко создать правила, блокирующие или разрешающие доступ к серверу приложений, путем фильтрации трафика, поступающего на порт, назначенный приложению, и отправляемого с этого порта.  
  
Например, можно разрешить пользователю вход на сервер приложений в центре обработки данных при помощи подключения к удаленному рабочему столу (RDP). Так как RDP использует порт TCP 3389, можно настроить следующее правило:  
  
|Исходный IP-адрес|IP-адрес назначения|Протокол|Порт источника|Порт назначения|Направление|Действие|  
|-------------|------------------|------------|---------------|--------------------|-------------|----------|  
|*|*|TCP|*|3389|В|Разрешение|  
  
Далее приведены два примера создания правил с помощью команд Windows PowerShell. В первом примере правило блокирует весь трафик к виртуальной машине с именем "ApplicationServer". Во втором примере правила, которое применяется к сетевому адаптеру виртуальной машины с именем "ApplicationServer", разрешается только входящий трафик RDP для виртуальной машины.  
  
> [!NOTE]  
> При создании правил можно использовать параметр **-Weight** для определения порядка, в котором виртуальный коммутатор Hyper-V обрабатывает правила. Значения для параметров **-Weight** выражаются как целые числа. правила с более высоким целым числом обрабатываются раньше правил с более низкими целыми числами. Например, если к сетевому адаптеру виртуальной машины применяется два правила, одно с весовым коэффициентом 1, другое с весовым коэффициентом 10, то второе правило будет обработано раньше.  
  
```  
Add-VMNetworkAdapterExtendedAcl -VMName "ApplicationServer" -Action "Deny" -Direction "Inbound" -Weight 1  
Add-VMNetworkAdapterExtendedAcl -VMName "ApplicationServer" -Action "Allow" -Direction "Inbound" -LocalPort 3389 -Protocol "TCP" -Weight 10  
```  
  
### <a name="enforce-both-user-level-and-application-level-security"></a><a name="bkmk_both"></a>Обеспечение безопасности на уровне пользователей и приложений  
Поскольку правило может сопоставляться с пятикортежным IP-пакетом (исходный IP-адрес, конечный IP-адрес, протокол, порт источника и порт назначения), правило может применять более подробную политику безопасности по сравнению со списком ACL для порта.  
  
Например, если вы хотите предоставить службе DHCP ограниченное число клиентских компьютеров, использующих конкретный набор DHCP-серверов, можно настроить следующие правила на компьютере Windows Server 2016 с Hyper-V, где размещены пользовательские виртуальные машины:  
  
|Исходный IP-адрес|IP-адрес назначения|Протокол|Порт источника|Порт назначения|Направление|Действие|  
|-------------|------------------|------------|---------------|--------------------|-------------|----------|  
|*|255.255.255.255|UDP|*|67|Из|Разрешение|  
|*|10.175.124.0/25|UDP|*|67|Из|Разрешение|  
|10.175.124.0/25|*|UDP|*|68|В|Разрешение|  
  
Далее приведены примеры создания этих правил с помощью команд Windows PowerShell.  
  
```  
Add-VMNetworkAdapterExtendedAcl -VMName "ServerName" -Action "Deny" -Direction "Outbound" -Weight 1  
Add-VMNetworkAdapterExtendedAcl -VMName "ServerName" -Action "Allow" -Direction "Outbound" -RemoteIPAddress 255.255.255.255 -RemotePort 67 -Protocol "UDP"-Weight 10  
Add-VMNetworkAdapterExtendedAcl -VMName "ServerName" -Action "Allow" -Direction "Outbound" -RemoteIPAddress 10.175.124.0/25 -RemotePort 67 -Protocol "UDP"-Weight 20  
Add-VMNetworkAdapterExtendedAcl -VMName "ServerName" -Action "Allow" -Direction "Inbound" -RemoteIPAddress 10.175.124.0/25 -RemotePort 68 -Protocol "UDP"-Weight 20  
```  
  
### <a name="provide-security-support-to-a-non-tcpudp-application"></a><a name="bkmk_tcp"></a>Обеспечение поддержки безопасности для приложения, не поддерживающего TCP/UDP  
Хотя большая часть трафика в центре обработки данных — это трафик TCP и UDP, часть трафика использует другие протоколы. Например, чтобы разрешить группе серверов запускать приложение многоадресной IP-рассылки, использующее протокол IGMP, можно создать следующее правило.  
  
> [!NOTE]  
> Назначенный номер IP-протокола для IGMP — 0x02.  
  
|Исходный IP-адрес|IP-адрес назначения|Протокол|Порт источника|Порт назначения|Направление|Действие|  
|-------------|------------------|------------|---------------|--------------------|-------------|----------|  
|*|*|0x02|*|*|В|Разрешение|  
|*|*|0x02|*|*|Из|Разрешение|  
  
Далее приведен пример создания этих правил с помощью команд Windows PowerShell.  
  
```  
Add-VMNetworkAdapterExtendedAcl -VMName "ServerName" -Action "Allow" -Direction "Inbound" -Protocol 2 -Weight 20  
Add-VMNetworkAdapterExtendedAcl -VMName "ServerName" -Action "Allow" -Direction "Outbound" -Protocol 2 -Weight 20  
```  
  
## <a name="stateful-acl-rules"></a><a name="bkmk_stateful"></a>Правила списков управления доступом с отслеживанием состояния  
Еще одна новая возможность расширенных списков ACL — настройка правил с отслеживанием состояния. Правило с отслеживанием состояния фильтрует пакеты на основе пяти атрибутов в IP-адресе источника пакета, IP-адресе назначения, протоколе, исходном порте и целевом порте.  
  
Правила с отслеживанием состояния имеют следующие возможности:  
  
-   Они всегда разрешают трафик и не используются для его блокировки.  
  
-   Если значение параметра **Направление** — "Входящий" и трафик соответствует правилу, то виртуальный коммутатор Hyper-V динамически создает соответствующее правило, разрешающее виртуальной машине отправлять исходящий трафик внешнему ресурсу.  
  
-   Если значение параметра **Направление** — "Исходящий" и трафик соответствует правилу, то виртуальный коммутатор Hyper-V динамически создает соответствующее правило, разрешающее виртуальной машине принимать входящий трафик от внешнего ресурса.  
  
-   Они включают атрибут времени ожидания, выражаемый в секундах. Когда на коммутатор поступает сетевой пакет, соответствующий правилу с отслеживанием состояния, виртуальный коммутатор Hyper-V создает состояние таким образом, чтобы разрешить все последующие пакеты, передаваемые в обоих направлениях того же потока. Срок действия состояния истекает, когда отсутствует трафик в каком-либо направлении в течение периода, заданного значением времени ожидания.  
  
Далее приведен пример возможного использования правил с отслеживанием состояния.  
  
### <a name="allow-inbound-remote-server-traffic-only-after-it-is-contacted-by-the-local-server"></a>Разрешать входящий трафик удаленного сервера только после обращения к нему локального сервера  
В некоторых случаях правило с отслеживанием состояния необходимо использовать потому, что только оно позволяет отслеживать известное установленное соединение и отличать его от прочих подключений.  
  
Например, чтобы разрешить серверу приложений виртуальной машины инициировать подключения на порте 80 к веб-службам в Интернете и дать удаленным веб-серверам возможность отвечать на трафик виртуальной машины, можно настроить правило с отслеживанием состояния, разрешающее первоначальный исходящий трафик, передающийся с виртуальной машины веб-службам. Поскольку это правило с отслеживанием состояния, обратный трафик, поступающий с веб-серверов на виртуальную машину, также разрешен. Из соображений безопасности можно блокировать весь прочий входящий сетевой трафик, поступающий на виртуальную машину.  
  
Чтобы настроить такое правило, можно использовать параметры, указанные в таблице ниже.  
  
> [!NOTE]  
> В связи с ограничениями форматирования и объемом данных в этой таблице информация в ней отображается не так, как в предыдущих таблицах этого документа.  
  
|Параметр|Правило 1|Правило 2|Правило 3|  
|-------------|----------|----------|----------|  
|Исходный IP-адрес|*|*|*|  
|IP-адрес назначения|*|*|*|  
|Протокол|*|*|TCP|  
|Порт источника|*|*|*|  
|Порт назначения|*|*|80|  
|Направление|В|Из|Из|  
|Действие|Запрещено|Запрещено|Разрешение|  
|С учетом состояния|Нет|Нет|Да|  
|Время ожидания (сек)|Н/Д|Н/Д|3600|  
  
Правило с отслеживанием состояния разрешает серверу приложений виртуальной машины подключаться к удаленному веб-серверу. При отправке первого пакета виртуальный коммутатор Hyper-V динамически создает два состояния потока, чтобы разрешить все пакеты, отправляемые на удаленный веб-сервер, и все пакеты, возвращающиеся с него. Когда поток пакетов между серверами прекращается, срок действия состояний потока истекает через назначенное время ожидания — 3600 секунд (один час).  
  
Далее приведен пример создания этих правил с помощью команд Windows PowerShell.  
  
```  
Add-VMNetworkAdapterExtendedAcl -VMName "ApplicationServer" -Action "Deny" -Direction "Inbound" -Weight 1   
Add-VMNetworkAdapterExtendedAcl -VMName "ApplicationServer" -Action "Deny" -Direction "Outbound" -Weight 1  
Add-VMNetworkAdapterExtendedAcl -VMName "ApplicationServer" -Action "Allow" -Direction "Outbound" 80 "TCP" -Weight 100 -Stateful -Timeout 3600  
```  
  


