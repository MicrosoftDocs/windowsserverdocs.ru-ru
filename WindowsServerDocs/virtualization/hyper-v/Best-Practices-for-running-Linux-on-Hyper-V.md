---
title: Рекомендации по запуску Linux в Hyper-V
description: Содержит рекомендации по запуску Linux на виртуальной машине.
ms.prod: windows-server
ms.service: na
manager: dongill
ms.technology: compute-hyper-v
ms.tgt_pltfrm: na
ms.topic: article
ms.assetid: a08648eb-eea0-4e2b-87fb-52bfe8953491
author: shirgall
ms.author: kathydav
ms.date: 3/1/2019
ms.openlocfilehash: 3488bbc1e295a68befc7044b83379bd65a5f28df
ms.sourcegitcommit: 6aff3d88ff22ea141a6ea6572a5ad8dd6321f199
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/27/2019
ms.locfileid: "71365569"
---
# <a name="best-practices-for-running-linux-on-hyper-v"></a>Рекомендации по запуску Linux в Hyper-V

>Область применения. Windows Server 2019, Windows Server 2016, Hyper-V Server 2016, Windows Server 2012 R2, Hyper-V Server 2012 R2, Windows Server 2012, Hyper-V Server 2012, Windows Server 2008 R2, Windows 10, Windows 8.1, Windows 8, Windows 7,1, Windows 7

Этот раздел содержит список рекомендаций по запуску виртуальной машины Linux в Hyper-V.

## <a name="tuning-linux-file-systems-on-dynamic-vhdx-files"></a>Настройка файловых систем Linux в динамических VHDX-файлах

Некоторые файловые системы Linux могут потреблять значительный объем свободного места на диске, даже если файловая система в основном пуста. Чтобы уменьшить объем используемого дискового пространства в динамических VHDX-файлах, учитывайте следующие рекомендации.

* При создании VHDX используйте 1 МБ Блокксизебитес (из 32 МБ по умолчанию) в PowerShell, например:

```Powershell
PS > New-VHD -Path C:\MyVHDs\test.vhdx -SizeBytes 127GB -Dynamic -BlockSizeBytes 1MB
```

* Формат ext4 является предпочтительным для ext3, так как ext4 больше пространства, чем ext3 при использовании с динамическими VHDX-файлами.

* При создании файловой системы укажите число групп 4096, например:

```bash
# mkfs.ext4 -G 4096 /dev/sdX1

```

## <a name="grub-menu-timeout-on-generation-2-virtual-machines"></a>Время ожидания меню GRUB на виртуальных машинах поколения 2

Из-за того, что устаревшее оборудование удаляется из эмуляции на виртуальных машинах поколения 2, для отображения меню GRUB слишком быстро вычисляется таймер обратного отсчета, и сразу же загружается запись по умолчанию. Пока GRUB не будет использоваться для использования таймера, поддерживаемого EFI, измените **/Бут/груб/груб.конф**,/**т.п./default/grub**или эквивалентным параметром "Timeout = 100000" вместо значения по умолчанию "timeout = 5".

## <a name="pxe-boot-on-generation-2-virtual-machines"></a>Загрузка PxE на виртуальных машинах поколения 2

Так как в виртуальных машинах поколения 2 отсутствует таймер «СМОЛой», сетевые подключения к PxE-серверу TFTP можно преждевременно завершить и предотвратить считывание конфигурации GRUB и загрузку ядра с сервера.

В RHEL 6. x прежний загрузчик EFI для GRUB v 0.97 можно использовать вместо grub2, как описано здесь: [https://access.redhat.com/documentation/Red_Hat_Enterprise_Linux/6/html/Installation_Guide/s1-netboot-pxe-config-efi.html](https://access.redhat.com/documentation/Red_Hat_Enterprise_Linux/6/html/Installation_Guide/s1-netboot-pxe-config-efi.html)

В дистрибутивах Linux, отличных от RHEL 6. x, можно выполнить аналогичные действия, чтобы настроить GRUB v 0.97 для загрузки ядер Linux с PxE-сервера.

Кроме того, при вводе с помощью клавиатуры и мыши RHEL/CentOS 6,6 не будет работать с предварительно установленным ядром, что не позволит указать параметры установки в меню. Чтобы разрешить выбор параметров установки, должна быть настроена последовательная консоль.

* В файле **ефидефаулт** на PxE-сервере добавьте следующий параметр ядра **"console = ttyS1"** .

* На виртуальной машине в Hyper-V настройте COM-порт с помощью этого командлета PowerShell:

```Powershell
Set-VMComPort -VMName <Name> -Number 2 -Path \\.\pipe\dbg1

```

Указание файла Kickstart для предварительно установленного ядра также позволит избежать необходимости ввода с клавиатуры и мыши во время установки.

## <a name="use-static-mac-addresses-with-failover-clustering"></a>Использование статических MAC-адресов с отказоустойчивой кластеризацией

Виртуальные машины Linux, которые будут развернуты с помощью отказоустойчивой кластеризации, должны быть настроены со статическим MAC-адресом для каждого виртуального сетевого адаптера. В некоторых версиях Linux сетевая конфигурация может быть потеряна после отработки отказа, поскольку виртуальному сетевому адаптеру назначается новый MAC-адрес. Чтобы избежать потери конфигурации сети, убедитесь, что у каждого виртуального сетевого адаптера есть статический MAC-адрес. Вы можете настроить MAC-адрес, изменив параметры виртуальной машины в диспетчере Hyper-V или диспетчер отказоустойчивости кластеров.

## <a name="use-hyper-v-specific-network-adapters-not-the-legacy-network-adapter"></a>Использование сетевых адаптеров, относящихся к Hyper-V, а не устаревших сетевых адаптеров

Настройте и используйте виртуальный адаптер Ethernet, который является сетевой картой Hyper-V с повышенной производительностью. Если к виртуальной машине подключены как устаревшие, так и сетевые адаптеры, относящиеся к Hyper-V, сетевые имена в выходных данных команды **ifconfig-a** могут показывать случайные значения, такие как **_tmp12000801310**. Чтобы избежать этой проблемы, удалите все устаревшие сетевые адаптеры при использовании сетевых адаптеров, связанных с Hyper-V, в виртуальной машине Linux.

## <a name="use-io-scheduler-noop-for-better-disk-io-performance"></a>Используйте Планировщик заданий ввода-вывода для повышения производительности дисковых операций ввода-вывода

Ядро Linux имеет четыре различных планировщика операций ввода-вывода для изменения порядка запросов с различными алгоритмами. NOOP — это очередь первого возврата, которая передает запланированное решение гипервизору. При запуске виртуальной машины Linux в Hyper-V рекомендуется использовать NOOP в качестве планировщика. Чтобы изменить планировщик для конкретного устройства, в конфигурации загрузчика (например,/ЕТК/груб.конф) добавьте **Лифт = NOOP** в параметры ядра, а затем перезапустите.

## <a name="numa"></a>NUMA

Версии ядра Linux, предшествующие 2.6.37, не поддерживают NUMA в Hyper-V с более крупными размерами виртуальных машин. Эта проблема в основном влияет на старые дистрибутивы с использованием вышестоящего ядра Red Hat 2.6.32 и была исправлена в Red Hat Enterprise Linux (RHEL) 6,6 (kernel-2.6.32-504). В системах, где выполняются пользовательские ядра, отличные от 2.6.37, или ядра на основе RHEL, более ранние, чем 2.6.32-504, должен задать параметр Boot `numa=off` в командной строке ядра в GRUB. conf. Дополнительные сведения см. в статье [Red Hat KB 436883](https://access.redhat.com/solutions/436883).

## <a name="reserve-more-memory-for-kdump"></a>Зарезервируйте больше памяти для кдумп

Если ядро записи дампа завершается с тревогой при загрузке, зарезервируйте больше памяти для ядра. Например, измените параметр **crashkernel = 384M-: 128M** на **crashkernel = 384M-: 256M** в файле конфигурации Ubuntu GRUB.

## <a name="shrinking-vhdx-or-expanding-vhd-and-vhdx-files-can-result-in-erroneous-gpt-partition-tables"></a>Сжатие VHDX-файлов или расширения VHD и VHDX может привести к ошибочным таблицам разделов GPT

Hyper-V позволяет сжимать файлы виртуального диска (VHDX) без учета разделов, томов или структур данных файловой системы, которые могут существовать на диске. Если VHDX-файл сжимается до конца раздела, то данные могут быть потеряны, при этом Секция может быть повреждена, а при чтении секции могут возвращаться недопустимые данные.

После изменения размера VHD или VHDX администраторы должны использовать служебную программу, например fdisk, или частично обновить структуру разделов, томов и файловой системы, чтобы отразить изменение размера диска. Сжатие или увеличение размера VHD или VHDX с таблицей разделов GUID (GPT) вызовет предупреждение, если для проверки макета раздела используется средство управления секциями, и администратору будет выведено предупреждение об исправлении первого и дополнительного заголовков GPT. Этот ручной этап можно выполнить без потери данных.

## <a name="see-also"></a>См. также

* [Поддерживаемые виртуальные машины Linux и FreeBSD для Hyper-V в Windows](Supported-Linux-and-FreeBSD-virtual-machines-for-Hyper-V-on-Windows.md)

* [Рекомендации по запуску FreeBSD в Hyper-V](Best-practices-for-running-FreeBSD-on-Hyper-V.md)

* [Развертывание кластера Hyper-V](https://technet.microsoft.com/library/jj863389.aspx)

* [Создание образов Linux для Azure](https://docs.microsoft.com/azure/virtual-machines/linux/create-upload-generic)

* [Оптимизация виртуальной машины Linux в Azure](https://docs.microsoft.com/azure/virtual-machines/linux/optimization)
