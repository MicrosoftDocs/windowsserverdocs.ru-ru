---
title: О выборе типа планировщика низкоуровневой оболочки Hyper-V
description: Предоставляет сведения для администраторов узла Hyper-V на использование Hyper-V планировщика режимы
author: allenma
ms.author: allenma
ms.date: 08/14/2018
ms.topic: article
ms.prod: windows-server-hyper-v
ms.technology: virtualization
ms.localizationpriority: low
ms.assetid: 5fe163d4-2595-43b0-ba2f-7fad6e4ae069
ms.openlocfilehash: c5360d8e2fdc23f8b05c6be0f665407eebedeba2
ms.sourcegitcommit: 0d0b32c8986ba7db9536e0b8648d4ddf9b03e452
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2019
ms.locfileid: "59823885"
---
# <a name="about-hyper-v-hypervisor-scheduler-type-selection"></a>О выборе типа планировщика низкоуровневой оболочки Hyper-V

Область применения.

* Windows Server 2016
* Windows Server версии 1709
* Windows Server версии 1803
* Windows Server 2019

В этом документе описываются важные изменения по умолчанию Hyper-V и рекомендуемое использование низкоуровневой оболочки типы планировщика. Эти изменения влияют на производительность обе системы безопасности и виртуализации. Администраторов узла виртуализации следует просмотреть понять изменения и ограничения, описанные в этом документе и тщательно оцените последствия, предлагаемые руководство и факторов риска, чтобы лучше понять, как развертывать и управлять ими Узлы Hyper-V при возникновении быстро меняющихся угроз.

>[!IMPORTANT]
>Известные уязвимости, работать в слепой в различные архитектуры процессоров может быть использована вредоносным гостевой виртуальной Машине через планирования поведение типа классической планировщика устаревших низкоуровневой оболочки, когда выполняются на компьютерах с одновременные безопасности на стороне канала Многопоточность (SMT) включен.  Если удалось воспользоваться вредоносных рабочей нагрузки может наблюдаться данных за пределами его границу секции. Атаки этого класса можно избежать, настроив низкоуровневой оболочки Hyper-V использовать тип планировщика core низкоуровневой оболочки и перенастройке гостевых виртуальных машин. С помощью планировщика core низкоуровневая оболочка ограничивает вице-президенты гостевой виртуальной Машины под управлением того же ядра физического процессора, поэтому строго изоляция виртуальной Машины возможность доступа к данным по границам физическое ядро, на котором он выполняется.  Это очень эффективен для устранения рисков от таких атак на стороне канала, который запрещает ли наблюдение за все артефакты из других разделов, виртуальная машина корневой или другой раздел гостя.  Таким образом корпорация Майкрософт изменение значения по умолчанию и рекомендуемые параметры конфигурации для узлов виртуализации и гостевых виртуальных машин.

## <a name="background"></a>Фон

Начиная с Windows Server 2016, Hyper-V поддерживает несколько методов планирования и управления виртуальными процессорами, называют типами планировщика низкоуровневой оболочки.  Подробное описание всех типов планировщика низкоуровневой оболочки можно найти в [общее представление об использовании типов планировщика низкоуровневой оболочки Hyper-V](https://docs.microsoft.com/windows-server/virtualization/hyper-v/manage/manage-hyper-v-scheduler-types).

>[!NOTE]
>Новые типы планировщика низкоуровневой оболочки впервые появились в Windows Server 2016 и не доступны в предыдущих выпусках. Все версии Hyper-v до Windows Server 2016 поддерживает только классические планировщика. Поддержка для core scheduler только недавно была опубликована.

## <a name="about-hypervisor-scheduler-types"></a>О типах планировщика низкоуровневой оболочки

В этой статье рассматриваются специально на использование нового типа низкоуровневой оболочки core планировщика и прежних версий «классическими» планировщик, а также как эти типы планировщика пересекаются с использованием многопоточности симметричные или SMT.  Важно понимать различия между планировщиками core и классическая модель и как каждого помещает работы из гостевых виртуальных машин от базовой системы процессоров.

### <a name="the-classic-scheduler"></a>Классический планировщика

Классический планировщик ссылается на метод циклического нашей законной системы совместного использования, планирования работы на виртуальных процессоров (VPs) в системе — включая корневой вице-президенты, а также вице-президенты, принадлежащих гостевых виртуальных машин. Классический планировщика был тип планировщика по умолчанию, используемый во всех версиях Hyper-V (до Windows Server 2019 г., как описано в данном документе).  Характеристики производительности классического планировщика хорошо понятны, и демонстрируется классической планировщика для ably поддержки превышение подписки рабочих нагрузок — то есть превышение подписки коэффициент VP:LP хоста по разумным поля (в зависимости от типы рабочих нагрузок виртуализируются, общее использование ресурсов и т. д.).

При запуске на узле виртуализации с поддержкой SMT, классической планировщик запланирует вице-президенты гостевой любой виртуальной машины в каждом потоке SMT, принадлежащих базовая независимо друг от друга. Таким образом другие виртуальные машины могут работать в одном ядре в то же время (под управлением в одном потоке ядра, пока другой виртуальной Машине выполняется в потоке одна виртуальная машина).

### <a name="the-core-scheduler"></a>Планировщик core

Планировщик core использует свойства SMT для обеспечения изоляции гостевых рабочих нагрузок, что влияет на безопасность и производительность системы. Планировщик core гарантирует, что вице-президенты из виртуальной Машины запланирован в потоках SMT того же уровня. Это делается симметрично таким образом, если LPs находятся в группы из двух, вице-президенты запланированы в группах из двух и core system ЦП никогда не передается между виртуальными машинами.

Запланировав вице-президенты гостя для базовой пар SMT, планировщик core предлагает надежную защиту границы изоляции рабочей нагрузки и также можно использовать для уменьшения характеристикам производительности для задержки конфиденциальных рабочих нагрузок.

Обратите внимание, что когда вице-Президент по плану для виртуальной машины без SMT включен, вице-Президент будет потребляемых всей основной момент, когда он работает, и того же уровня core SMT поток остается простоя.  Это необходимо для обеспечения изоляции подходящую рабочую нагрузку, но влияет на общую производительность системы, особенно по мере LPs системы избыточной подписки — то есть превышение VP:LP общее соотношение 1:1. Таким образом под управлением гостевых виртуальных машин настроена без нескольких потоков на каждое ядро представляет собой неоптимальной конфигурацию.

### <a name="benefits-of-the-using-the-core-scheduler"></a>Преимущества использования планировщика core

Планировщик core предоставляет следующие преимущества:

* Границы надежную защиту для изоляции рабочей нагрузки гостевого - вице-президенты гостевой ограничены для запуска на базовой пары физическое ядро, уменьшить уязвимость для атак по сторонним каналам.

* Вариативность ограниченной рабочей нагрузки - вариативности пропускную способность рабочей нагрузки гостевого существенно уменьшается, предлагая повышение уровня согласованности рабочей нагрузки.

* Использование SMT в гостевых виртуальных машин - операционной системы и приложений, работающих в гостевой виртуальной машины могут использовать поведение SMT и программные интерфейсы (API) для контроля и распределения работы между SMT-потока, так же, как и когда без виртуализации.

В настоящее время планировщик core используется на узлах виртуализации Azure, специально для того, чтобы воспользоваться преимуществами прочную безопасность границ и variabilty низкой рабочей нагрузки. Корпорация Майкрософт считает, что тип планировщика core должен быть и будут продолжать низкоуровневой оболочки по умолчанию, тип, для большинства сценариев виртуализации планирования.  Таким образом, чтобы убедиться, что наши клиенты являются безопасными по умолчанию, корпорация Майкрософт делает это изменение для Windows Server 2019 теперь.

### <a name="core-scheduler-performance-impacts-on-guest-workloads"></a>Влияние на производительность Core планировщика на рабочие нагрузки

Хотя требуется для эффективного устранения определенных классах уязвимостей, планировщик core также потенциально может снизить производительность. Клиенты могут заметить разницу в характеристики производительности с виртуальных машин и последствий для общей производительности рабочей нагрузки узлов виртуализации, их. В случаях, где core планировщик необходимо запустить не ВИЦЕ - SMT только один из потоков инструкций в базовой логическое ядро выполняется, пока другой должны быть оставлены в состояние бездействия. Это ограничит общее узла емкость для гостевых рабочих нагрузок.

Эти влияние на производительность можно свести к минимуму, следуя инструкциям развертывания в этом документе. Администраторов узла необходимо тщательно рассмотреть их виртуализации сценарии развертывания и балансировку их допустимости рисков безопасности с необходимостью плотность максимальной рабочей нагрузки, избыточной Консолидация узлов виртуализации и т. д.

## <a name="changes-to-the-default-and-recommended-configurations-for-windows-server-2016-and-windows-server-2019"></a>Изменения по умолчанию и рекомендуемые конфигурации для Windows Server 2016 и Windows Server 2019

Развертывание узлов Hyper-V с помощью с максимальной безопасностью необходимо использовать тип планировщика core низкоуровневой оболочки. Чтобы убедиться, что наши клиенты являются безопасными по умолчанию, корпорация Майкрософт изменяет следующие значение по умолчанию и рекомендуемые параметры.

>[!NOTE]
>Хотя гипервизора внутреннюю поддержку для типов планировщика был включен в первоначальном выпуске Windows Server 2016, Windows Server 1709 и Windows Server 1803, обновления являются необходимыми, чтобы получить доступ к конфигурации управления, который позволяет выбрать Тип планировщика низкоуровневой оболочки.  Обратитесь к [общее представление об использовании типов планировщика низкоуровневой оболочки Hyper-V](https://docs.microsoft.com/windows-server/virtualization/hyper-v/manage/manage-hyper-v-scheduler-types) Дополнительные сведения об этих обновлениях.

### <a name="virtualization-host-changes"></a>Изменения узлов виртуализации

* Низкоуровневая оболочка будет использовать планировщик core по умолчанию, начиная с Windows Server 2019.

* Настройка планировщика core в Windows Server 2016 reccommends Microsoft. Тип планировщика низкоуровневой оболочки core поддерживается в Windows Server 2016, но по умолчанию используется классический планировщика. Планировщик core является необязательным и должен явно включить администратор узла Hyper-V.

### <a name="virtual-machine-configuration-changes"></a>Изменения конфигурации виртуальной машины

* В Windows Server 2019, новых виртуальных машин, созданных с помощью версии виртуальной Машины по умолчанию 9.0 автоматически будет наследовать свойства SMT (включена или отключена) узла виртуализации. Т. е SMT с включенной технологией физический узел, вновь созданные виртуальные машины также будет иметь SMT включен и будет наследовать SMT топологии узла по умолчанию с виртуальной Машиной с таким же числом аппаратных потоков на каждое ядро, как базовая система. Это будет отражаться в конфигурации виртуальной Машины с HwThreadCountPerCore = 0, где 0 означает, что виртуальная машина должны наследовать параметры SMT главного приложения.

* Существующие виртуальные машины с помощью виртуальной Машины версии 8.2 или более ранней версии будет хранить их исходный параметр процессора виртуальной Машины для HwThreadCountPerCore, значение по умолчанию 8.2 гостевых виртуальных Машин версии — HwThreadCountPerCore = 1. При запуске этих гостевых систем на узле Windows Server 2019 они будут интерпретироваться следующим образом:

    1. Если к виртуальной Машине вице-Президент счетчика, которое меньше или равно количеству ядер LP, виртуальная машина будет рассматриваться как не - SMT виртуальной Машины планировщиком ядра. При выполнении в одном потоке SMT вице-Президент гостевой core того же уровня потока SMT будут приостановлены. Это не является оптимальным и приведет к потере общей производительности.

    2. Если к виртуальной Машине дополнительные вице-президенты, чем LP ядрами, виртуальная машина будет рассматриваться как виртуальная машина SMT планировщиком ядра. Тем не менее виртуальная машина не будет наблюдать другие указания, что это Машине SMT. Например использование инструкции CPUID или API-интерфейсы Windows для запроса топологии ЦП операционная система и приложения не отразит включения SMT.

* Если существующей виртуальной Машины явным образом обновляется до версии 9.0 с помощью операции Update-VM из более ранней версии виртуальной Машины, виртуальная машина будет хранить свое текущее значение HwThreadCountPerCore.  Виртуальная машина не будет принудительно с поддержкой SMT.

* В Windows Server 2016 Корпорация Майкрософт рекомендует включать SMT для гостевых виртуальных машин.  По умолчанию виртуальные машины, созданные в Windows Server 2016 будет SMT отключен, то есть HwThreadCountPerCore имеет значение 1, если только не изменяются явным образом.

>[!NOTE]
>Windows Server 2016 не поддерживает параметр HwThreadCountPerCore 0.

#### <a name="managing-virtual-machine-smt-configuration"></a>Управление конфигурацией виртуальной машины SMT

Конфигурация SMT гостевой виртуальной машины устанавливается отдельно для каждой виртуальной Машины. Администратор узла можно проверить и настроить SMT конфигурацию виртуальной Машины выберите один из следующих вариантов:

    1. Настройка виртуальных машин для выполнения как SMT-включен, при необходимости автоматически наследование узла топологии SMT

    2. Настройка виртуальных машин для запуска в качестве не SMT

Конфигурации SMT для виртуальной Машины отображается в области "Сводка" в консоли диспетчера Hyper-V.  Настройка параметров виртуальной Машины SMT может осуществляться с помощью параметров виртуальной Машины или PowerShell.

#### <a name="configuring-vm-smt-settings-using-powershell"></a>Настройка параметров SMT на виртуальной Машине, с помощью PowerShell

Чтобы настроить параметры SMT для гостевой виртуальной машине, откройте окно PowerShell с достаточные разрешения и введите:

``` powershell
Set-VMProcessor -VMName <VMName> -HwThreadCountPerCore <0, 1, 2>
```

Где

    0 = Inherit SMT topology from the host (this setting of HwThreadCountPerCore=0 is not supported on Windows Server 2016)

    1 = Non-SMT

    Values > 1 = the desired number of SMT threads per core. May not exceed the number of physical SMT threads per core.

Чтобы прочитать параметры SMT для гостевой виртуальной машине, откройте окно PowerShell с достаточные разрешения и введите:

``` powershell
(Get-VMProcessor -VMName <VMName>).HwThreadCountPerCore
```

Обратите внимание, что гостевых виртуальных машинах с HwThreadCountPerCore = 0 означает, что SMT будут включены для гостевой ОС и будет предоставлять же число потоков SMT для гостевой ОС, как на основной узел виртуализации, как правило 2.

### <a name="guest-vms-may-observe-changes-to-cpu-topology-across-vm-mobility-scenarios"></a>Гостевые виртуальные машины могут наблюдать изменения топологии ЦП между сценариями мобильности виртуальных Машин

ОС и приложений на виртуальной Машине можете заметить некоторые изменения для узла и параметры виртуальной Машины перед и после события жизненного цикла виртуальной Машины такие как Динамическая миграция или сохранить и восстановить операции. Во время операции, в каких виртуальных Машинах сохранение и восстановление состояния переносятся параметр HwThreadCountPerCore виртуальной Машины и реализованного значения (то есть вычисляемый сочетание параметра виртуальной Машины и конфигурации исходного узла). Виртуальная машина будет продолжать работать с этими параметрами на целевом узле. В точке виртуальной Машины была завершена и заново запустить, существует вероятность, реализованного значения наблюдаемая в виртуальной машине изменится. Это должен быть безопасными, как ОС и приложение программное обеспечение слоев следует искать сведения о топологии ЦП как часть своих стандартных последовательностях код запуска и инициализации. Тем не менее так как эти инициализации во время загрузки, последовательностей пропускаются во время динамической миграции или сохранить или восстановить операций, виртуальные машины, которые подвергаются переходах между состояниями может наблюдаться изначально вычисляемый фактическое значение, пока не завершат работу и заново запустить.  

### <a name="alerts-regarding-non-optimal-vm-configurations"></a>Предупреждения, касающиеся конфигурации не являются оптимальными виртуальной Машины

Виртуальные машины настроены дополнительные вице-президенты, чем количество физических ядер на узле результат в конфигурации не является оптимальным. Планировщик низкоуровневая оболочка будет рассматривать эти виртуальные машины, как если бы они поддержкой SMT. Тем не менее ОС и прикладное программное обеспечение на виртуальной машине будут представлены топологии ЦП, показывающий SMT отключен. При обнаружении этого условия, рабочий процесс Hyper-V будет запись в журнале на узле виртуализации, предупреждение администратору узла конфигурации виртуальной Машины не является оптимальным, что рекомендация SMT быть включена для виртуальной Машины.

#### <a name="how-to-identify-non-optimally-configured-vms"></a>Как определить не оптимально настроить виртуальные машины

Вы можете определить SMT виртуальных машин с другими путем проверки в системном журнале в средстве просмотра событий для события рабочий процесс Hyper-V 3498 идентификатор, который будет применяться для виртуальной Машины, каждый раз, когда число вице-президенты на виртуальной Машине, больше, чем число физических ядер. События рабочих процессов можно получить из средства просмотра событий или с помощью PowerShell.

#### <a name="querying-the-hyper-v-worker-process-vm-event-using-powershell"></a>Запрос события виртуальной Машины Hyper-V рабочего процесса с помощью PowerShell

Запрос события процесса рабочей роли Hyper-V 3498 идентификатор с помощью PowerShell, введите следующие команды в командной строке PowerShell.

``` powershell
Get-WinEvent -FilterHashTable @{ProviderName="Microsoft-Windows-Hyper-V-Worker"; ID=3498}
```

### <a name="impacts-of-guest-smt-configuaration-on-the-use-of-hypervisor-enlightenments-for-guest-operating-systems"></a>Влияние конфигурации гостевой SMT на использование просветления низкоуровневой оболочки для гостевых операционных систем

Низкоуровневая оболочка Microsoft предлагает несколько просветления или подсказки, которые можно запрашивать и использовать для активации оптимизации, например те, которые могут повысить производительность или в противном случае улучшения обработки различных условий, при запуске ОС, работающей в гостевой виртуальной Машине виртуализировать. Один недавно введенные просвещения отвечает за обработку виртуального процессора и использование ОС способы устранения рисков для атак на стороне канала, использующих SMT.

>[!NOTE]
>Корпорация Майкрософт рекомендует включить что администраторов узла SMT для гостевых виртуальных машин для оптимизации производительности рабочей нагрузки.

Сведения об этом озарения гостевой приведены ниже, тем не менее мысль для администраторов узла виртуализации заключается в том, что виртуальные машины должны иметь HwThreadCountPerCore, настроенную в соответствии с конфигурацией физического SMT главного приложения. Это позволяет низкоуровневой оболочке средство сообщает о наличии не-архитектуры core совместного использования. Таким образом могут быть включены все вспомогательные оптимизации гостевой операционной системы, требующие просвещения. На 2019 Windows Server создание новых виртуальных машин и оставьте значение по умолчанию HwThreadCountPerCore (0). Более старые виртуальные машины, перенесенные из Windows Server 2016 узлы могут обновляться до версии Windows Server 2019 конфигурации. После этого, корпорация Microsoft рекомендует параметр HwThreadCountPerCore = 0.  В Windows Server 2016 Корпорация Майкрософт рекомендует параметр HwThreadCountPerCore в соответствии с конфигурацией узла (обычно 2).

### <a name="nononarchitecturalcoresharing-enlightenment-details"></a>Сведения о Просвещение NoNonArchitecturalCoreSharing

Начиная с Windows Server 2016, низкоуровневая оболочка определяет новый просвещения для описания его обработка планирования вице-Президент и размещения на гостевой ОС. Этот просвещения определяется в [v5.0c функциональная спецификация гипервизора верхнего уровня](https://docs.microsoft.com/virtualization/hyper-v-on-windows/reference/tlfs).

Низкоуровневая оболочка искусственных CPUID конечного CPUID.0x40000004.EAX:18[NoNonArchitecturalCoreSharing = 1] Указывает, что виртуальный процессор, никогда не используют физическое ядро с другим виртуальным процессором, за исключением виртуальных процессоров, которые выводятся как одноуровневый SMT потоки. Например вице-Президентом гостевой никогда не выполняется в потоке SMT вместе с вице-Президентом корневой одновременной работе на поток SMT на одном ядре процессора того же уровня. Это условие, возможна только при выполнении, виртуализированной и поэтому представляет-архитектуры поведение SMT, который также имеет серьезные последствия для безопасности. Гостевая ОС можно использовать NoNonArchitecturalCoreSharing = 1 для указания, что он безопасен для включения оптимизации, которые могут помочь его избежать производительности дополнительных издержек, связанных STIBP.

В некоторых конфигурациях низкоуровневая оболочка не укажет, что NoNonArchitecturalCoreSharing = 1. Например если узел имеет SMT включен и настроен для использования планировщика классический низкоуровневой оболочки, NoNonArchitecturalCoreSharing будет равно 0. Это может препятствовать доступу с включенной поддержкой гостей Включение определенные оптимизации. Таким образом Майкрософт рекомендует администраторов узла, с помощью SMT полагаться на планировщик core низкоуровневой оболочки и убедитесь, что виртуальные машины настроены для наследования их конфигурации SMT с узла для обеспечения оптимальной производительности.

## <a name="summary"></a>Сводка

Характер угроз безопасности постоянно развивается. Чтобы убедиться, что наши клиенты являются безопасными по умолчанию, корпорация Майкрософт меняет конфигурацию по умолчанию для низкоуровневой оболочки и виртуальных машин, начиная с Windows Server 2019 Hyper-V и предоставляя обновления, советы и рекомендации для клиентов под управлением Windows Server 2016 Hyper-V. Администраторов виртуализации узла должен выполнить следующее.

* Чтения и понимания указаний, приведенных в этом документе

* Тщательно оценить и настроить их развертывания виртуализации, чтобы убедиться, что они отвечают, безопасности, производительности, плотность виртуализации и оперативности рабочей нагрузки для их уникальные требования

* Попробуйте повторно настроить существующие узлы Windows Server 2016 Hyper-V для использования преимуществ прочную безопасность планировщика core низкоуровневой оболочки

* Обновить существующие SMT виртуальных машин с другими чтобы уменьшить влияние на производительность в Планирование ограничений, налагаемых изоляции вице-Президент, устраняющего уязвимости системы безопасности оборудования
