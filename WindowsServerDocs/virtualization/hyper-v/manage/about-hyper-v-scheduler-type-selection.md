---
title: О выборе типа планировщика низкоуровневой оболочки Hyper-V
description: Предоставляет администраторам узлов Hyper-V сведения об использовании режимов планировщика Hyper-V
ms.author: benarm
author: BenjaminArmstrong
ms.date: 08/14/2018
ms.topic: article
ms.localizationpriority: low
ms.assetid: 5fe163d4-2595-43b0-ba2f-7fad6e4ae069
ms.openlocfilehash: 9c41dfb5bad28122f8c2a6b06ff6574acd89a9ec
ms.sourcegitcommit: dd1fbb5d7e71ba8cd1b5bfaf38e3123bca115572
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/17/2020
ms.locfileid: "90746629"
---
# <a name="about-hyper-v-hypervisor-scheduler-type-selection"></a>О выборе типа планировщика низкоуровневой оболочки Hyper-V

Область применения:

* Windows Server 2016
* Windows Server, версия 1709
* Windows Server, версия 1803
* Windows Server 2019

В этом документе описываются важные изменения по умолчанию и Рекомендуемые использование типов планировщиков гипервизоров Hyper-V. Эти изменения влияют на производительность системы безопасности и виртуализации. Администраторы узла виртуализации должны ознакомиться с изменениями и последствиями, описанными в этом документе, и тщательно оценить влияние, предлагаемые рекомендации по развертыванию и факторы риска, связанные с наилучшим пониманием того, как развертывать узлы Hyper-V и управлять ими с помощью быстро меняющейся ландшафта безопасности.

>[!IMPORTANT]
>В настоящее время известные уязвимости системы безопасности канала, доступные в нескольких архитектурах процессора, могут использовать вредоносную гостевую виртуальную машину с помощью поведения планирования для устаревшего типа планировщика низкоуровневой оболочки при запуске на узлах с включенной одновременной многопоточностью (SMT).  В случае успешного использования вредоносная Рабочая нагрузка может наблюдать за данными за пределами границ секций. Этот класс атак можно устранить, настроив гипервизор Hyper-V для использования типа планировщика Core гипервизора и перенастройки гостевых виртуальных машин. С помощью базового планировщика гипервизор позволяет ВПС гостевой виртуальной машины работать на одном физическом ядре процессора, поэтому он сильно изолирует способность виртуальной машины обращаться к данным с границами физического ядра, на котором она выполняется.  Это очень эффективная защита от атак на эти каналы, что не дает виртуальной машине наблюдать за какими-либо артефактами из других разделов, будь то корневой или другой гостевой раздел.  Поэтому корпорация Майкрософт изменяет параметры конфигурации по умолчанию и рекомендуемые для узлов виртуализации и гостевых виртуальных машин.

## <a name="background"></a>Фон

Начиная с Windows Server 2016, Hyper-V поддерживает несколько методов планирования и управления виртуальными процессорами, которые называются типами планировщика гипервизора.  Подробное описание всех типов планировщика гипервизора можно найти в статьях [понимание и использование типов планировщиков низкоуровневой оболочки Hyper-V](./manage-hyper-v-scheduler-types.md).

>[!NOTE]
>Новые типы планировщика гипервизора впервые появились в Windows Server 2016 и недоступны в предыдущих выпусках. Все версии Hyper-V до Windows Server 2016 поддерживают только классический планировщик. Поддержка основного планировщика была недавно опубликована.

## <a name="about-hypervisor-scheduler-types"></a>Сведения о типах планировщика низкоуровневой оболочки

В этой статье основное внимание уделяется использованию нового типа планировщика низкоуровневой оболочки в сравнении с традиционным "классическим" планировщиком и способом пересечения этих типов планировщика с использованием симметричной многопоточности или SMT.  Важно понимать различия между основными и классическими планировщиками, а также то, как каждое из них работает с гостевых виртуальных машин на базовых системных процессорах.

### <a name="the-classic-scheduler"></a>Классический планировщик

Классический планировщик относится к методу высокодоступного и циклического перебора при планировании работы на виртуальных процессорах (ВПС) по всей системе, включая корневые ВПС, а также ВПС, принадлежащие гостевым виртуальным машинам. Классический планировщик является типом планировщика по умолчанию, используемым во всех версиях Hyper-V (до Windows Server 2019, как описано здесь).  Характеристики производительности классического планировщика хорошо понятны, и классическое планировщик демонстрирует Абли поддержку по подписке для рабочих нагрузок, т. е. подписку на вице-президент узла по разумному полю (в зависимости от типов виртуализованных рабочих нагрузок, общего использования ресурсов и т. д.).

При запуске на узле виртуализации с включенным SMT классическое планировщик запланирует гостевую ВПС от любой виртуальной машины в каждом отдельном потоке SMT, входящем в ядро. Таким образом, разные виртуальные машины могут выполняться в одном ядре одновременно (одна виртуальная машина, работающая в одном потоке ядра, в то время как другая виртуальная машина работает в другом потоке).

### <a name="the-core-scheduler"></a>Основной планировщик

Основной планировщик использует свойства SMT для обеспечения изоляции гостевых рабочих нагрузок, что влияет на безопасность и производительность системы. Основной планировщик гарантирует, что ВПС из виртуальной машины планируется в одноранговых SMTных потоках. Это делается симметрично, так что если LPs находятся в группах из двух, ВПС планируется в группах двух, а ядро ЦП системы никогда не будет совместно использоваться виртуальными машинами.

Планируя гостевую ВПС на базовых парах SMT, основной планировщик предлагает строгую границу безопасности для изоляции рабочей нагрузки и может также использоваться для снижения вариативности производительности для рабочих нагрузок с учетом задержек.

Обратите внимание, что если для виртуальной машины запланирована работа без SMT, то этот вице-президент будет потреблять все ядро при его запуске, а одноуровневый SMT-поток будет оставаться бездействующим.  Это необходимо для обеспечения правильной изоляции рабочей нагрузки, но влияет на общую производительность системы, особенно по мере того, как система LPs переносится на подписывание, то есть, когда отношение "общий вице-президент" превышает 1:1. Таким образом, запуск гостевых виртуальных машин, настроенных без нескольких потоков на ядро, является неоптимальной конфигурацией.

### <a name="benefits-of-the-using-the-core-scheduler"></a>Преимущества использования базового планировщика

Базовый планировщик предоставляет следующие преимущества:

* Строгая граница безопасности для изоляции гостевой рабочей нагрузки. Гостевая ВПС ограничена в базовых физических базовых парах, что снижает уязвимость для атак с отслеживанием побочных каналов.

* Уменьшенная вариативность рабочей нагрузки — значительно сокращается вариативность пропускной способности гостевых рабочих нагрузок.

* Использование SMT на гостевых виртуальных машинах. ОС и приложения, работающие на гостевой виртуальной машине, могут использовать поведение SMT и программные интерфейсы (API) для управления и распределения работы между потоками SMT, так же как и при невиртуализированном запуске.

В настоящее время основной планировщик используется на узлах виртуализации Azure, в частности, для использования преимуществ строгой границы безопасности и низкой рабочей нагрузки вариабилти. Корпорация Майкрософт считает, что основной тип планировщика должен быть и по умолчанию иметь тип планирования гипервизора для большинства сценариев виртуализации.  Таким образом, чтобы обеспечить безопасность наших клиентов по умолчанию, корпорация Майкрософт вносит эти изменения в Windows Server 2019 сейчас.

### <a name="core-scheduler-performance-impacts-on-guest-workloads"></a>Влияние на производительность основного планировщика на гостевых рабочих нагрузках

В то время как это необходимо для эффективного устранения определенных классов уязвимостей, основной планировщик может также привести к снижению производительности. Клиенты могут заметить разницу в характеристиках производительности с их виртуальными машинами и влияют на общую емкость рабочей нагрузки узлов виртуализации. В случаях, когда основной планировщик должен запустить SMTный вице-президент, только один из потоков инструкций в базовом логическом ядре будет выполняться, пока другой должен оставаться неактивным. Это ограничит общую емкость узла для гостевых рабочих нагрузок.

Эти последствия производительности можно снизить, следуя указаниям по развертыванию в этом документе. Администраторам узла следует тщательно проанализировать конкретные сценарии развертывания виртуализации и сбалансировать их устойчивость к угрозам безопасности в соответствии с потребностью в максимальной плотности рабочей нагрузки, объединении узлов виртуализации и т. д.

## <a name="changes-to-the-default-and-recommended-configurations-for-windows-server-2016-and-windows-server-2019"></a>Изменения по умолчанию и рекомендуемые конфигурации для Windows Server 2016 и Windows Server 2019

Для развертывания узлов Hyper-V с максимальной защитой необходимо использовать тип планировщика Core гипервизора. Чтобы обеспечить безопасность наших клиентов по умолчанию, корпорация Майкрософт изменяет следующие параметры по умолчанию и Рекомендуемые.

>[!NOTE]
>Хотя внутренняя поддержка типов планировщика гипервизора включена в первоначальный выпуск Windows Server 2016, Windows Server 1709 и Windows Server 1803, для доступа к элементу управления конфигурацией, который позволяет выбрать тип планировщика гипервизора, требуются обновления.  Дополнительные сведения об этих обновлениях см. в статье [Основные сведения и использование типов планировщика низкоуровневой оболочки Hyper-V](./manage-hyper-v-scheduler-types.md) .

### <a name="virtualization-host-changes"></a>Изменения узла виртуализации

* Гипервизор по умолчанию будет использовать основной планировщик, начиная с Windows Server 2019.

* Microsoft реккоммендс настраивает основной планировщик в Windows Server 2016. Тип планировщика ядра низкоуровневой оболочки поддерживается в Windows Server 2016, однако по умолчанию используется классический планировщик. Основной планировщик является необязательным и должен быть явно включен администратором узла Hyper-V.

### <a name="virtual-machine-configuration-changes"></a>Изменения конфигурации виртуальной машины

* В Windows Server 2019 новые виртуальные машины, созданные с помощью виртуальной машины по умолчанию версии 9,0, автоматически наследуют свойства SMT (включенные или отключенные) узла виртуализации. Это значит, что если SMT включен на физическом узле, то на вновь созданных виртуальных машинах также будет включен SMT, и по умолчанию будет унаследована топология SMT узла, в которой виртуальная машина имеет то же количество аппаратных потоков на ядро, что и базовая система. Это будет отражено в конфигурации виртуальной машины с Хвсреадкаунтперкоре = 0, где 0 означает, что виртуальная машина должна наследовать параметры SMT узла.

* Существующие виртуальные машины с версией 8,2 или более ранней версии будут хранить свои исходные параметры процессора виртуальной машины для Хвсреадкаунтперкоре, а по умолчанию для виртуальных машин версии 8,2 виртуальной машины — Хвсреадкаунтперкоре = 1. Когда эти гости выполняются на узле Windows Server 2019, они будут рассматриваться следующим образом:

    1. Если у виртуальной машины число вице-президента меньше или равно числу ядер LP, ВИРТУАЛЬная машина будет рассматриваться как SMT виртуальная машина, которая не является виртуальной машиной ядра. Когда гостевой вице-президент работает в одном потоке SMT, его одноуровневый SMT поток будет бездействовать. Это не является оптимальным и приведет к общему снижению производительности.

    2. Если виртуальная машина имеет больше ВПС, чем ядер LP, виртуальная машина будет рассматриваться как виртуальная машина SMT основным планировщиком. Однако виртуальная машина не будет видеть другие признаки того, что это виртуальная машина SMT. Например, использование инструкции CPUID или интерфейсов API Windows для запроса топологии ЦП операционной системой или приложениями не означает, что SMT включен.

* Если существующая виртуальная машина явным образом обновляется с версии еарилер VM до версии 9,0 с помощью операции обновления виртуальной машины, ВИРТУАЛЬная машина будет хранить текущее значение для Хвсреадкаунтперкоре.  На виртуальной машине не будет включен SMT Force.

* В Windows Server 2016 Корпорация Майкрософт рекомендует включить SMT для гостевых виртуальных машин.  По умолчанию виртуальные машины, созданные в Windows Server 2016, SMT отключены, то есть Хвсреадкаунтперкоре имеет значение 1, если только они не были изменены явным образом.

>[!NOTE]
>Windows Server 2016 не поддерживает задание значения 0 для параметра Хвсреадкаунтперкоре.

#### <a name="managing-virtual-machine-smt-configuration"></a>Управление конфигурацией SMT виртуальной машины

Конфигурация SMT для гостевой виртуальной машины задается отдельно для каждой виртуальной машины. Администратор узла может проверить и настроить конфигурацию SMT виртуальной машины, выбрав один из следующих параметров:

1. Настройка виртуальных машин для запуска от имени SMT с возможностью автоматического наследования топологии SMT узла

2. Настройка виртуальных машин для запуска от имени, отличного от SMT

SMT Недопустимый раздел конфигурации для виртуальной машины отображается в панелях сводки консоли диспетчера Hyper-V.  Настройка параметров SMT виртуальной машины может выполняться с помощью параметров виртуальной машины или PowerShell.

#### <a name="configuring-vm-smt-settings-using-powershell"></a>Настройка параметров SMT виртуальной машины с помощью PowerShell

Чтобы настроить параметры SMT для гостевой виртуальной машины, откройте окно PowerShell с достаточными разрешениями и введите:

``` powershell
Set-VMProcessor -VMName <VMName> -HwThreadCountPerCore <0, 1, 2>
```

Где:

- 0 = наследовать топологию SMT от узла (этот параметр Хвсреадкаунтперкоре = 0 не поддерживается в Windows Server 2016)

- 1 = не SMT

- Значения > 1 = необходимое количество потоков SMT на ядро. Не может превышать число физических потоков SMT на ядро.

Чтобы прочитать параметры SMT для гостевой виртуальной машины, откройте окно PowerShell с достаточными разрешениями и введите:

``` powershell
(Get-VMProcessor -VMName <VMName>).HwThreadCountPerCore
```

Обратите внимание, что Гостевые виртуальные машины, настроенные с Хвсреадкаунтперкоре = 0, указывают на то, что для гостевой системы SMT будет включен, и будет предоставлять гостевое количество SMT потоков, так как они находятся на базовом узле виртуализации, обычно 2.

### <a name="guest-vms-may-observe-changes-to-cpu-topology-across-vm-mobility-scenarios"></a>Гостевые виртуальные машины могут наблюдать изменения топологии ЦП в сценариях мобильности виртуальных машин.

ОС и приложения на виртуальной машине могут видеть изменения параметров узла и виртуальной машины до и после событий жизненного цикла виртуальной машины, таких как динамическая миграция, операции сохранения и восстановления. Во время операции, в которой состояние виртуальной машины сохраняется и восстанавливается, переносятся как параметр Хвсреадкаунтперкоре ВИРТУАЛЬНОЙ машины, так и реализованное значение (то есть вычисленное сочетание параметров виртуальной машины и конфигурации исходного узла). Виртуальная машина продолжит работу с этими параметрами на целевом узле. После завершения работы и повторного запуска виртуальной машины может измениться фактическое значение, наблюдаемое в виртуальной машине. Это должно быть небезопасным, так как программное обеспечение на уровне ОС и приложений должно искать сведения о топологии ЦП в рамках обычных потоков кода запуска и инициализации. Однако поскольку эти последовательности инициализации во время загрузки пропускаются во время операций динамической миграции или сохранения и восстановления, виртуальные машины, пропускаемые этими переходами состояния, могут наблюдать за исходным вычисленным значением до тех пор, пока они не будут выключены и не запущены повторно.

### <a name="alerts-regarding-non-optimal-vm-configurations"></a>Оповещения о неоптимальных конфигурациях виртуальных машин

Виртуальные машины, настроенные с большим количеством ВПС, чем физические ядра на узле, имеют неоптимальную конфигурацию. Планировщик гипервизора будет обрабатывать эти виртуальные машины так, как если бы они SMT. Однако программное обеспечение операционной системы и приложения на виртуальной машине будет представлять топологию ЦП, показывающую, что SMT отключена. При обнаружении этого состояния рабочий процесс Hyper-V зарегистрирует событие на узле виртуализации, предупреждая администратора узла о том, что конфигурация виртуальной машины не является оптимальной, и рекомендуем включить SMT для виртуальной машины.

#### <a name="how-to-identify-non-optimally-configured-vms"></a>Определение неоптимально настроенных виртуальных машин

Вы можете вычислить SMT виртуальные машины, изучив системный журнал в Просмотр событий для события рабочего процесса Hyper-V с ИДЕНТИФИКАТОРом 3498, которое будет активировано для виртуальной машины, если число ВПС на виртуальной машине превышает физическое число ядер. События рабочего процесса можно получить из Просмотр событий или с помощью PowerShell.

#### <a name="querying-the-hyper-v-worker-process-vm-event-using-powershell"></a>Запрос события виртуальной машины рабочего процесса Hyper-V с помощью PowerShell

Чтобы запросить событие с ИД рабочего процесса Hyper-V 3498 с помощью PowerShell, введите следующие команды в командной строке PowerShell.

``` powershell
Get-WinEvent -FilterHashTable @{ProviderName="Microsoft-Windows-Hyper-V-Worker"; ID=3498}
```

### <a name="impacts-of-guest-smt-configuaration-on-the-use-of-hypervisor-enlightenments-for-guest-operating-systems"></a>Влияние гостевого SMT Недопустимый раздел конфигурации на использование просветлений гипервизора для гостевых операционных систем

Гипервизор Майкрософт предлагает несколько просветлений или подсказок, которые операционная система, запущенная на гостевой виртуальной машине, может запрашивать и использовать для запуска оптимизации, например для тех, которые могут повысить производительность или иным образом улучшить обработку различных условий при выполнении виртуализации. Одна недавно введенная просвещениеа связана с обработкой планирования виртуальных процессоров и использованием защиты ОС для атак на стороне канала, которые используют SMT.

>[!NOTE]
>Корпорация Майкрософт рекомендует администраторам узлов включить SMT для гостевых виртуальных машин, чтобы оптимизировать производительность рабочей нагрузки.

Ниже приведены сведения об этих гостевых просвещение, но ключ мысль для администраторов узла виртуализации заключается в том, что виртуальные машины должны иметь Хвсреадкаунтперкоре, настроенные в соответствии с конфигурацией физического SMT узла. Это позволяет гипервизору сообщать о том, что не существует неархитектурного общего доступа. Таким образом, все гостевые ОС, поддерживающие оптимизацию, требующие просвещение, могут быть включены. В Windows Server 2019 создайте новые виртуальные машины и оставьте значение по умолчанию Хвсреадкаунтперкоре (0). Старые виртуальные машины, перенесенные с узлов Windows Server 2016, можно обновить до версии конфигурации Windows Server 2019. После этого корпорация Майкрософт рекомендует установить Хвсреадкаунтперкоре = 0.  В Windows Server 2016 Корпорация Майкрософт рекомендует установить Хвсреадкаунтперкоре в соответствии с конфигурацией узла (обычно 2).

### <a name="nononarchitecturalcoresharing-enlightenment-details"></a>Сведения о просвещение Нононарчитектуралкорешаринг

Начиная с Windows Server 2016, гипервизор определяет новый просвещение для описания его обработки и размещения в гостевой ОС. Этот просвещение определен в [функциональной спецификации низкоуровневой оболочки на уровне 5.0 c](/virtualization/hyper-v-on-windows/reference/tlfs).

Искусственный CPUID маркера гипервизора конечный CPUID. 0x40000004. EAX: 18 [Нононарчитектуралкорешаринг = 1] указывает, что виртуальный процессор никогда не будет совместно использовать физическое ядро с другим виртуальным процессором, за исключением виртуальных процессоров, которые передаются как одноуровневые потоки SMT. Например, вице-президент гостя никогда не будет работать в потоке SMT вместе с привилегированным вице-президентом, работающим одновременно в одноранговых потоках SMT на том же ядре процессора. Это условие возможно только в том случае, если выполняется виртуализация, и поэтому представляет неархитектурное поведение SMT, которое также имеет серьезные последствия для безопасности. Гостевая ОС может использовать Нононарчитектуралкорешаринг = 1 в качестве свидетельства о том, что можно включить оптимизацию, что может помочь избежать издержек на производительность при настройке СТИБП.

В некоторых конфигурациях гипервизор не будет указывать, что Нононарчитектуралкорешаринг = 1. Например, если на узле включен SMT и для него настроено использование классического планировщика гипервизора, Нононарчитектуралкорешаринг будет иметь значение 0. Это может препятствовать включению определенных оптимизаций поддержкой гостями. Поэтому корпорация Майкрософт рекомендует администраторам узлов, использующим SMT, использовать планировщик ядра низкоуровневой оболочки и убедиться, что виртуальные машины настроены на наследование их конфигурации SMT от узла, чтобы обеспечить оптимальную производительность рабочей нагрузки.

## <a name="summary"></a>Итоги

Ландшафт угроз безопасности продолжит развиваться. Чтобы обеспечить безопасность наших клиентов по умолчанию, корпорация Майкрософт изменяет конфигурацию гипервизора и виртуальных машин, начиная с Windows Server 2019 Hyper-V, по умолчанию, а также предоставляет обновленные рекомендации и рекомендации для клиентов, использующих Windows Server 2016 Hyper-V. Администраторы узла виртуализации должны:

* Ознакомьтесь с рекомендациями, приведенными в этом документе

* Тщательно оцените и скорректируйте свои развертывания виртуализации, чтобы обеспечить соответствие целям безопасности, производительности, плотности виртуализации и скорости реагирования рабочей нагрузки для своих уникальных требований.

* Рассмотрите возможность повторной настройки существующих узлов Windows Server 2016 Hyper-V, чтобы использовать надежные преимущества безопасности, предоставляемые планировщиком Core гипервизора.

* Обновление существующих SMT виртуальных машин для снижения производительности, влияющей на производительность, от ограничений на планирование, накладываемых на изоляцию президента, которая устраняет уязвимости оборудования.