---
title: О том, Выбор типа планировщика низкоуровневая оболочка Hyper-V
description: Предоставляет сведения для администраторов узла Hyper-V на использование Диспетчер Hyper-V режимы
author: allenma
ms.author: allenma
ms.date: 08/14/2018
ms.topic: article
ms.prod: windows-server-hyper-v
ms.technology: virtualization
ms.localizationpriority: low
ms.assetid: 5fe163d4-2595-43b0-ba2f-7fad6e4ae069
ms.openlocfilehash: c5360d8e2fdc23f8b05c6be0f665407eebedeba2
ms.sourcegitcommit: 546229d6b5fa7e16f725c6c35f4dcc272711b811
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/18/2018
ms.locfileid: "4905131"
---
# О том, Выбор типа планировщика низкоуровневая оболочка Hyper-V

Область применения:

* Windows Server 2016
* Windows Server версии 1709
* Windows Server версии 1803
* Windows Server 2019 г.

В этом документе описываются важные изменения по умолчанию Hyper-V и рекомендуется использования гипервизора планировщика типов. Эти изменения повлияют на обоих производительность системы безопасности и виртуализацию. Администраторов узла виртуализации следует просмотреть понять изменения и условия, описанные в этом документе и тщательно оценить влияние, руководство по развертыванию рекомендуемых и факторы риска, которые лучше понять, как развертывать и управлять ими Узлы Hyper-V при возникновении быстро изменяющихся рисков.

>[!IMPORTANT]
>В настоящее время известные уязвимости слабовидящим в несколько архитектур процессора может воспользоваться вредоносные гостевой виртуальной Машины через планирования поведение типа классический планировщика устаревшие низкоуровневой оболочки, при выполнении на узлах с Simultaneous безопасности канала Многопоточность (SMT) включена.  Если воспользуется, вредоносный рабочей нагрузки может отслеживать данные за его пределами граница раздела. Этот класс атак можно устранить, настроив гипервизор Hyper-V для использования тип планировщика core низкоуровневой оболочки и перенастройки гостевых виртуальных машин. С помощью планировщика core гипервизор ограничивает вице-президенты гостевой Виртуальной машины для запуска на одном ядре физического процессора, поэтому настоятельно изоляции Виртуальной машины возможность доступа к данным на границы физическое ядро, на котором оно запускается.  Это очень эффективно защиты от этих атак канала предотвратить наблюдение все артефакты с другими разделами ли виртуальная машина корень или другой гостевого раздела.  Таким образом корпорация Майкрософт изменение значения по умолчанию и рекомендуемые параметры конфигурации для виртуализации узлов и гостевых виртуальных машин.

## Фон

Начиная с Windows Server 2016, Hyper-V поддерживает несколько методов планирования и управления виртуальных процессоров, называется типы заданий низкоуровневой оболочки.  Подробное описание всех типов заданий низкоуровневой оболочки можно найти в [Общие сведения о и использовании типов заданий низкоуровневая оболочка Hyper-V](https://docs.microsoft.com/windows-server/virtualization/hyper-v/manage/manage-hyper-v-scheduler-types).

>[!NOTE]
>Новые типы заданий гипервизора впервые появились в Windows Server 2016 и не доступны в предыдущих выпусках. Все версии Hyper-V, до выхода Windows Server 2016 поддерживает только классический планировщик. Поддержка планировщик core только недавно опубликовано.

## О типах планировщика низкоуровневой оболочки

В этой статье основное внимание уделяется специально использовать новый тип планировщика гипервизора core или устаревший «классический» планировщик и как эти типы заданий могут пересекаться с помощью симметричного многопоточностью или SMT.  Очень важно понимать различия между планировщиками core и классический и как каждый помещает работу с гостевые виртуальные машины на базовых процессоров системы.

### Классический планировщик заданий

Классический планировщик ссылается на метод циклического перебора справедливом распределении планирования работы над виртуальных процессоров, в системе - включая корневой вице-президенты, а также вице-президенты, принадлежащих гостевые виртуальные машины. Классический планировщик был тип планировщика по умолчанию, используемые во всех версиях Hyper-V (до Windows Server 2019 г., как описано в данном документе).  Характеристики производительности классический планировщика хорошо вам понятны и классический планировщик показан ably поддержку чрезмерных подписки рабочих нагрузок — то есть чрезмерных подписки коэффициент VP:LP узла по рациональные поля (в зависимости от типы виртуализированных рабочих нагрузок, общее использование ресурсов и т. д.).

При выполнении на узле виртуализации включен SMT, классический планировщик запланирует вице-президенты гостя на любую виртуальную Машину для каждого потока SMT, принадлежащих ядро независимо друг от друга. Таким образом разные виртуальные машины могут работать под управлением на одном ядре за один раз (один виртуальный компьютер, работающий в одном потоке ядра во время выполнения другой виртуальной Машины в потоке).

### Планировщик core

Планировщик core использует свойства SMT для обеспечения изоляции рабочих нагрузок гостя, который влияет на безопасность и производительность системы. Планировщик core гарантирует, что запланировано на согласование потока SMT вице-президенты из виртуальной Машины. Это делается симметрично, если логические процессоры группы из двух, вице-президенты приходят в группах двух ядро системы ЦП никогда не распределяется между виртуальными машинами.

При планировании вице-президенты гостя на базовых пар SMT, планировщик core предлагает границу строгой безопасности для изоляции рабочей нагрузки и могут использоваться для уменьшения разницу производительности для рабочих нагрузок конфиденциальные задержку.

Обратите внимание, что при планировании ВИЦЕ для виртуальной машины без SMT включена, что ВИЦЕ используют всего основного, когда оно запускается, а основной согласование потока SMT остается простоя.  Это необходимо для обеспечения изоляции правильный рабочей нагрузки, но влияние на общую производительность системы, особенно по мере логические процессоры системы избыточного подписанный — то есть при превышении общее VP:LP соотношение 1:1. Таким образом запуск виртуальных машин настроена без нескольких потоков на ядро, неоптимальной конфигурации.

### Преимущества использования планировщика core

Планировщик core предоставляет следующие преимущества:

* Граница надежной системы безопасности для изоляции рабочей нагрузки гостевой - вице-президенты гостевой ограничиваются для запуска на базовых пары физическое ядро, сокращает уязвимость к атакам отслеживание канала.

* Снижение нагрузки особенностей - особенностей пропускную способность гостя рабочей нагрузки значительно снижена, предлагая надежнее рабочей нагрузки.

* Использование SMT в гостевых виртуальных машин — ОС и приложений, работающих в гостевой виртуальной машины могут использовать поведение SMT и интерфейсам (API) для управления и распределения рабочего потока SMT, так же, как они бы при выполнении без виртуализации.

Планировщик core в настоящее время используется на узлах Azure виртуализации, в частности, чтобы воспользоваться преимуществами границы надежной системы безопасности и variabilty низкой рабочей нагрузки. Корпорация Майкрософт считает, что тип планировщика core должны быть и останется низкоуровневой оболочки по умолчанию, тип для большинства сценариев виртуализации планирования.  Таким образом, чтобы убедиться, что наших клиентов по умолчанию являются надежными, корпорация Майкрософт делает это изменение для Windows Server 2019 теперь.

### Воздействие на производительность Core планировщик заданий на рабочих нагрузок гостя

Во время требуется эффективно снизить определенных классов уязвимостей, планировщик core также потенциально может снизить производительность. Пользователи могут заметить разницу в показатели производительности с помощью виртуальных машин и последствиями общий объем рабочей нагрузки их узлы виртуализации. В случаях, где планировщик core должны выполняться без SMT ВИЦЕ - только один из потоков инструкций в базовой логическом ядре выполняемого во время других должно остаться простоя. Это ограничит емкость общее узла для гостевой рабочих нагрузок.

Эти воздействие на производительность можно свернуть, выполнив руководство по развертыванию в этом документе. Администраторов узла необходимо тщательно изучить их определенных виртуализацию сценарии развертывания и сбалансировать их погрешность опасность от необходимости плотность максимальной рабочей нагрузки, чрезмерных консолидации узлы виртуализации и т. д.

## Изменения в по умолчанию и рекомендуемые конфигурации для Windows Server 2016 и Windows Server 2019

Развертывание узлы Hyper-V с помощью уровня максимальное безопасности требует использование типа планировщика core низкоуровневой оболочки. Чтобы убедиться, что наших клиентов по умолчанию являются надежными, корпорация Майкрософт — это изменение следующие значения по умолчанию и рекомендуемые параметры.

>[!NOTE]
>Хотя внутренней поддержки гипервизора для типов заданий был включен в начальном выпуске Windows Server 2016, Windows Server 1709 и Windows Server 1803, обновления являются обязательными для доступа к элементу управления конфигурации, что позволяет выбрать Тип планировщика низкоуровневой оболочки.  Дополнительные сведения об этих обновлениях обратитесь к [понимание и использование типов заданий низкоуровневая оболочка Hyper-V](https://docs.microsoft.com/windows-server/virtualization/hyper-v/manage/manage-hyper-v-scheduler-types) .

### Изменения узел виртуализации

* Гипервизор будет использовать планировщик ядра по умолчанию, начиная с Windows Server 2019.

* Корпорация Майкрософт reccommends настройки core заданий в Windows Server 2016. Тип планировщика core низкоуровневой оболочки поддерживается в Windows Server 2016, не по умолчанию является классический планировщик. Планировщик core не является обязательным и необходимо явным образом включить администратор узла Hyper-V.

### Изменения конфигурации виртуальной машины

* В Windows Server 2019 новых виртуальных машин, созданных с помощью версии виртуальной Машины по умолчанию 9.0 автоматически будет наследовать свойства SMT (включен или выключен) узла виртуализации. Это значит Если SMT был включен на физическом узле, новые созданные виртуальные машины также будут иметь SMT включен и унаследуют топологии SMT узла по умолчанию с помощью виртуальной Машины с таким же числом аппаратных потоков на ядро, как базовая система. Это будет отражаться в конфигурации Виртуальной машины с помощью HwThreadCountPerCore = 0, где 0 означает, что виртуальная машина должна наследуют параметры SMT основного приложения.

* Существующие виртуальные машины с версией виртуальной Машины 8.2 или более ранних версий, будет сохранить свой исходный параметр процессора виртуальной Машины для HwThreadCountPerCore и значение по умолчанию для 8.2 гостевых виртуальных Машин версии — HwThreadCountPerCore = 1. Применяя эти гостевые системы на узле Windows Server 2019, они будут рассматриваться следующим образом:

    1. Если виртуальная машина ВИЦЕ счетчик, который меньше или равно число ядер LP, виртуальная машина будет рассматриваться как не - SMT виртуальной Машины диспетчером core. Если ВИЦЕ гостевой выполняется в одном потоке SMT, core согласование потока SMT будет idled. Это не самая оптимальная и приведет к потере общей производительности.

    2. Если виртуальная машина дополнительные вице-президенты чем LP ядер, виртуальная машина будут считаться Машине SMT диспетчером core. Тем не менее виртуальная машина не будет наблюдать других указывают на то, что это SMT виртуальной Машины. Например используйте инструкции CPUID или API-интерфейсы Windows для запроса, что автоматическая ЦП операционная система и приложения не будет указано, что SMT включена.

* Когда Машине существующего явным образом обновляется с версиями VM eariler до версии 9.0 через операции Update-VM, виртуальная машина будет сохранять его текущее значение для HwThreadCountPerCore.  Виртуальная машина не будет иметь SMT принудительно с поддержкой.

* В Windows Server 2016 Корпорация Майкрософт рекомендует включать SMT для виртуальных машин.  По умолчанию виртуальные машины, созданные в Windows Server 2016 будет SMT отключена, т. е HwThreadCountPerCore задано значение 1, если явно изменен.

>[!NOTE]
>Windows Server 2016 не поддерживает настройку HwThreadCountPerCore значение 0.

#### Управление конфигурацией SMT виртуальной машины

Конфигурация гостевой виртуальной машины SMT задается на основе-VM. Администратору узла можно проверить и настроить виртуальную Машину SMT конфигурации для выбора из следующих вариантов:

    1. Настройка виртуальных машин для запуска как SMT с поддержкой, при необходимости автоматически наследование топологии SMT узла

    2. Настройка виртуальных машин для запуска в качестве без SMT

Конфигурации SMT виртуальной машины, отображается в области сводки в консоли диспетчера Hyper-V.  Настройка параметров виртуальной Машины SMT может быть выполнено с помощью параметров виртуальной Машины или PowerShell.

#### Настройка параметров SMT виртуальной Машины с помощью PowerShell

Для настройки параметров SMT для гостевой виртуальной машины, откройте окно PowerShell с помощью необходимых разрешений и введите:

``` powershell
Set-VMProcessor -VMName <VMName> -HwThreadCountPerCore <0, 1, 2>
```

Где:

    0 = Inherit SMT topology from the host (this setting of HwThreadCountPerCore=0 is not supported on Windows Server 2016)

    1 = Non-SMT

    Values > 1 = the desired number of SMT threads per core. May not exceed the number of physical SMT threads per core.

Для чтения параметрах SMT для гостевой виртуальной машины, откройте окно PowerShell с помощью необходимых разрешений и введите:

``` powershell
(Get-VMProcessor -VMName <VMName>).HwThreadCountPerCore
```

Обратите внимание, что гостевых виртуальных машин, настроенные с помощью HwThreadCountPerCore = 0 означает, что SMT будет включена для гостевой ОС и будет предоставлять одинаковое число потока SMT гостевого, так как они находятся в базовой узле виртуализации, обычно 2.

### Гостевые виртуальные машины могут он регистрировал изменения к топологии ЦП на разных сценариев мобильности виртуальной Машины

ОС и приложений на виртуальной машине, может отобразиться изменения для узла и параметров виртуальной Машины до и после события жизненного цикла виртуальной Машины такие как динамическую миграцию или сохранения и восстановления операции. Во время операции, в какой виртуальной Машине сохранения и восстановления состояния переносятся параметр HwThreadCountPerCore Виртуальной машины и реализованные значение (то есть вычисленная сочетание параметр Виртуальной машины и конфигурация источника узла). Виртуальная машина будет продолжать работать с этими параметрами на узле назначения. В точке виртуальной Машины — завершение работы и повторного запуска его возможно, что обнаружен реализованные значение, виртуальная машина изменится. Это должен быть можно проигнорировать, как операционная система и приложения слой программного обеспечения нужно обращать внимание на сведения о топологии ЦП как часть своих обычных потоков кода запуска и инициализации. Тем не менее так как эти инициализации во время загрузки, последовательности пропускаются во время динамической миграции или сохранения и восстановления операции виртуальные машины, которые вносятся эти переходы состояния можно отслеживать изначально вычисленная фактическое значение, пока не будут закрыты и повторно работы.  

### Предупреждения, касающиеся без оптимальной конфигурации виртуальной Машины

Виртуальные машины, настроенные с помощью дополнительные вице-президенты, чем на результат узла физических ядер в без оптимальной конфигурации. Планировщик низкоуровневой оболочки будет считать этих виртуальных машин, как если бы они были учитывающим SMT. Тем не менее операционной системы и приложения в виртуальной Машине отобразятся топологии ЦП, отображение SMT отключена. При обнаружении это условие, рабочий процесс Hyper-V в журнал событие на узле виртуализации, предупреждение администратору узла, что конфигурации Виртуальной машины не оптимальный, и предоставления рекомендуемых SMT будет включена для виртуальной Машины.

#### Как определить не требуется настроить виртуальные машины

Можно определить, не - SMT виртуальных машин, анализируя системный журнал в средстве просмотра событий для события Hyper-V рабочий процесс 3498 идентификатор, которой будет применяться для виртуальной Машины, всякий раз, когда количество вице-президенты в виртуальной Машине больше, чем количество физическом ядре. События рабочих процессов можно получить с помощью средства просмотра событий или с помощью PowerShell.

#### Запрос события виртуальных Машин Hyper-V рабочего процесса с помощью PowerShell

Для запроса для Hyper-V рабочий процесс события 3498 идентификатор с помощью PowerShell, введите этих следующие команды из командной строки PowerShell.

``` powershell
Get-WinEvent -FilterHashTable @{ProviderName="Microsoft-Windows-Hyper-V-Worker"; ID=3498}
```

### Последствия конфигурации SMT гостя на использование низкоуровневой оболочки просветления гостевых операционных систем

Гипервизор Корпорация Майкрософт предлагает несколько просветления или подсказки, которые ОС, работающие в гостевой виртуальной Машины может запросить и запустите оптимизацию, например те, которые могут воспользоваться производительности или в противном случае улучшения обработки различных условий, при выполнении виртуализированные. Расширение возможностей один недавно появившееся касается обработки планирования виртуального процессора и использование средства устранения рисков в ОС для канала атак, использующих SMT.

>[!NOTE]
>Корпорация Майкрософт рекомендует, что администраторы узла включить SMT для виртуальных машин оптимизировать производительность рабочей нагрузки.

Подробные сведения о это расширение возможностей гостевой приведены ниже, однако ключевая для администраторов узла виртуализации является то, что виртуальные машины должны HwThreadCountPerCore настроен в соответствии с физической SMT конфигурации основного приложения. Это позволяет гипервизор сообщить, что нет ядро отсутствует без архитектурные общего доступа. Следовательно любой гостевой ОС вспомогательные оптимизации, которые требуется расширение возможностей может быть включена. В Windows Server 2019 создать новые виртуальные машины и оставьте значение по умолчанию HwThreadCountPerCore (0). Перенести старые виртуальные машины с Windows Server 2016 узлов можно обновить до версии конфигурации Windows Server 2019. После этого корпорация Microsoft рекомендует параметр HwThreadCountPerCore = 0.  В Windows Server 2016 Корпорация Майкрософт рекомендует параметр HwThreadCountPerCore в соответствии с конфигурация узла (как правило, 2).

### Сведения о NoNonArchitecturalCoreSharing расширение возможностей

Начиная с Windows Server 2016, гипервизор определяет новый расширение возможностей для описания его обработку ВИЦЕ планирования и размещения гостевой ОС. Это расширение возможностей определяется в [v5.0c функциональная спецификация гипервизора верхнего уровня](https://docs.microsoft.com/virtualization/hyper-v-on-windows/reference/tlfs).

Гипервизор синтетических CPUID конечного CPUID.0x40000004.EAX:18[NoNonArchitecturalCoreSharing = 1] Указывает, что виртуального процессора, никогда не используют физическое ядро с другого виртуального процессора, за исключением виртуальных процессоров, которые были зарегистрированы как дочерний элемент SMT потоки. Например ВИЦЕ гостевой никогда не выполняется в потоке SMT вместе с ВИЦЕ корневой одновременно запущено согласование потока SMT на одном ядре процессора. Это условие можно использовать только при выполнении виртуализированных и таким образом представляет без архитектурные SMT поведение, которое также имеет серьезные последствия для безопасности. Гостевая операционная система может использовать NoNonArchitecturalCoreSharing = 1, что указывает на то, что это безопасно для включения оптимизации, которые могут помочь его во избежание потери производительности в параметр STIBP.

В некоторых конфигурациях низкоуровневая оболочка не будет указано, NoNonArchitecturalCoreSharing = 1. Например если основное приложение имеет SMT включен и настроен на использование планировщика классический низкоуровневой оболочки, NoNonArchitecturalCoreSharing будет 0. Это может помешать поддерживаемые гостевые ОС некоторые виды оптимизации. Таким образом Майкрософт рекомендует администраторов узла, с помощью SMT полагаться на планировщик core низкоуровневой оболочки и проверить, виртуальные машины настроены для наследования SMT конфигурации на узле, для обеспечения оптимальной производительности.

## Краткий обзор

Обзор угроз безопасности постоянно развивается. Чтобы обеспечить наших клиентов по умолчанию являются надежными, корпорация Майкрософт изменения конфигурации по умолчанию для гипервизора и виртуальных машин, начиная с Windows Server 2019 Hyper-V и предоставление обновлены инструкции и рекомендации для клиентов, использующих Windows Server 2016 Hyper-V. Следует администраторов узла виртуализации:

* Чтение и понимание указаниям, предоставленным в этом документе

* Тщательно оценивать и настроить их развертываниях виртуализации, чтобы убедиться, что они отвечают безопасности, производительности, плотность виртуализации и цели отклик рабочей нагрузки, свои особые требования

* Попробуйте повторно настройки существующих узлов Windows Server 2016 Hyper-V могут использовать преимущества надежную защиту, обеспечиваемую планировщик core низкоуровневой оболочки

* Обновление существующих без - SMT виртуальные машины, чтобы уменьшить воздействие на производительность от планирования ограничения, накладываемые ВИЦЕ изоляции, учитывающую уязвимости системы безопасности оборудования
