---
title: Элементы управления ресурсами виртуальной машины
description: Использование групп ЦП виртуальных машин
author: allenma
ms.date: 06/18/2018
ms.topic: article
ms.prod: windows-server
ms.service: windows-10-hyperv
ms.assetid: cc7bb88e-ae75-4a54-9fb4-fc7c14964d67
ms.openlocfilehash: fcf61c22a24abb6b16baf75b4846cc188dcecd49
ms.sourcegitcommit: b00d7c8968c4adc8f699dbee694afe6ed36bc9de
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/08/2020
ms.locfileid: "80860797"
---
>Область применения: Windows Server 2016, Microsoft Hyper-V Server 2016, Windows Server 2019, Microsoft Hyper-V Server 2019

# <a name="virtual-machine-resource-controls"></a>Элементы управления ресурсами виртуальной машины

В этой статье описываются ресурсы и элементы управления изоляцией Hyper-V для виртуальных машин.  Эти возможности, которые мы будем называть группами ЦП виртуальных машин или просто "группами ЦП", появились в Windows Server 2016.  Группы ЦП позволяют администраторам Hyper-V лучше управлять ресурсами ЦП узла и распределять их между гостевыми виртуальными машинами.  С помощью групп ЦП администраторы Hyper-V могут:

* Создавайте группы виртуальных машин, каждая из которых имеет различные выделения ресурсов ЦП узла виртуализации, общие для всей группы. Это позволяет администратору узла реализовать классы служб для различных типов виртуальных машин.

* Установите ограничения ресурсов ЦП для конкретных групп. Это «групповая политика» задает верхнюю границу для ресурсов ЦП узла, которую может использовать вся группа, фактически обеспечивая требуемый класс службы для этой группы.

* Ограничьте запуск группы ЦП только в определенном наборе процессоров основной системы. Это можно использовать для изоляции виртуальных машин, принадлежащих разным группам ЦП, друг от друга.

## <a name="managing-cpu-groups"></a>Управление группами ЦП

Управление группами ЦП осуществляется с помощью службы вычислений узлов Hyper-V или HCS. Подробное описание HCS, его женесис, ссылки на API HCS и многое другое можно найти в блоге группы виртуализации Майкрософт, посвященном публикации [службы вычислений узла (HCS)](https://blogs.technet.microsoft.com/virtualization/2017/01/27/introducing-the-host-compute-service-hcs/).

>[!NOTE] 
>Для создания групп ЦП и управления ими можно использовать только HCS. интерфейсы управления WMI и PowerShell для диспетчера Hyper-V не поддерживают группы ЦП.

Корпорация Майкрософт предоставляет программу командной строки кпуграупс. exe в [центре загрузки Майкрософт](https://go.microsoft.com/fwlink/?linkid=865968) , которая использует интерфейс HCS для управления группами ЦП.  Эта служебная программа также может отображать топологию ЦП узла.

## <a name="how-cpu-groups-work"></a>Как работают группы ЦП

Распределение вычислительных ресурсов узлов между группами ЦП обеспечивается гипервизором Hyper-V с помощью вычисленного ограничения группы ЦП. Ограничение группы ЦП — это часть общей мощности ЦП для группы ЦП. Значение ограничения группы зависит от класса группы или назначенного уровня приоритета. Вычисленное ограничение группы можно рассматривать как "количество времени ЦП в LP". Этот бюджет группы является общим, поэтому если активна только одна виртуальная машина, она может использовать выделение ресурсов всей группы.

Ограничение группы ЦП вычисляется как G = *n* x *C*, где:

    *G* is the amount of host LP we'd like to assign to the group
    *n* is the total number of logical processors (LPs) in the group
    *C* is the maximum CPU allocation — that is, the class of service desired for the group, expressed as a percentage of the system's total compute capacity

Например, рассмотрим группу ЦП, настроенную с 4 логическими процессорами (LPs), и ограничение 50%.

    G = n * C
    G = 4 * 50%
    G = 2 LP's worth of CPU time for the entire group

В этом примере для группы ЦП «G» выделяется 2-е время ЦП.  

Обратите внимание, что ограничение группы применяется независимо от числа виртуальных машин или виртуальных процессоров, привязанных к группе, и вне зависимости от состояния (например, завершения работы или запуска) виртуальных машин, назначенных группе ЦП. Таким образом, каждая виртуальная машина, привязанная к одной и той же группе ЦП, будет принимать долю общего количества ресурсов ЦП группы, и это изменится на число виртуальных машин, привязанных к группе ЦП. Таким образом, так как виртуальные машины привязаны к виртуальным машинам или не привязаны к ним из группы ЦП, необходимо перенастроить общее ограничение группы ЦП и настроить его для поддержки требуемого ограничения на виртуальную машину. Администратор узла виртуальной машины или программный уровень управления виртуализацией отвечает за управление групповыми политиками по мере необходимости для достижения требуемого распределения ресурсов ЦП для каждой виртуальной машины.

## <a name="example-classes-of-service"></a>Примеры классов служб

Рассмотрим несколько простых примеров. Чтобы начать с, предположим, что администратор узла Hyper-V хочет поддерживать два уровня обслуживания для гостевых виртуальных машин:

1. Низкий уровень "C". Мы предоставляем этот уровень 10% от ресурсов для всего узла.

1. Уровень "B" среднего диапазона. Этот уровень выделяется 50% от ресурсов для всего узла.

На этом этапе мы будем утверждать, что никакие другие элементы управления ресурсами ЦП не используются, например отдельные ограничения виртуальной машины, веса и резервы.
Однако отдельные ограничения виртуальной машины важны, так как мы увидим чуть позже.

Для простоты предположим, что каждая виртуальная машина имеет один вице — 1, а наш узел имеет 8 LPs. Начнем с пустого узла.

Чтобы создать уровень "B", узел админстартор устанавливает ограничение для группы на 50%:

    G = n * C
    G = 8 * 50%
    G = 4 LP's worth of CPU time for the entire group

Администратор узла добавляет одну виртуальную машину "B" уровня.
На этом этапе Наша виртуальная машина уровня "B" может использовать не более 50% ресурсов центрального процессора узла или эквивалент 4 LPs в нашем примере системы.

Теперь администратор добавляет вторую виртуальную машину "уровень B". Распределение группы ЦП — равномерно распределяется между всеми виртуальными машинами. В группе б имеется 2 виртуальных ВМ, поэтому каждая виртуальная машина теперь получает половину группы б всего 50%, 25% каждого или эквивалента 2 LPs времени вычислений.

## <a name="setting-cpu-caps-on-individual-vms"></a>Настройка ограничений ЦП на отдельных виртуальных машинах

В дополнение к концу группы, каждая виртуальная машина может также иметь отдельную "заглушку" виртуальной машины. Элементы управления ресурсами ЦП для каждой виртуальной машины, включая ограничение использования ЦП, вес и резервирование, были частью Hyper-V с момента его введения.
В сочетании с ограничением группы, ограничение виртуальной машины определяет максимальный объем ЦП, который может получить каждый вице-президент, даже если в группе есть доступные ресурсы ЦП.

Например, администратору узла может потребоваться разместить 10% Cap на виртуальных машинах C.
Таким образом, даже если большинство "C" ВПС бездействующие, каждый вице — не более 10%.
Без ограничения виртуальной машины "C" виртуальные машины могут рационально производительность по сравнению с уровнями, разрешенными их уровнями.

## <a name="isolating-vm-groups-to-specific-host-processors"></a>Изоляция групп виртуальных машин для конкретных процессоров узла

Администраторам узлов Hyper-V также может потребоваться возможность выделения ресурсов вычислений виртуальной машине.
Например, предположим, что администратор хочет предложить привилегированную виртуальную машину "A" с ограничением класса 100%.
Эти виртуальные машины уровня "Премиум" также нуждаются в минимальных задержках и невозможности планирования. Это значит, что они не могут быть отпланированы другой виртуальной машиной.
Чтобы добиться этого разделения, можно настроить для группы ЦП определенное сопоставление сопоставления LP.

Например, чтобы разместить виртуальную машину "A" на узле в нашем примере, администратор создаст новую группу ЦП и настроит соответствие процессора группы подмножеству LPs узла.
Группы B и C будут привязаныы к оставшимся LPs.
Администратор может создать одну виртуальную машину в группе A, которая будет иметь эксклюзивный доступ ко всем LPs в группе A, а предположительно более низкие группы B и C будут совместно использовать оставшиеся LPs.

## <a name="segregating-root-vps-from-guest-vps"></a>Отделение корневого ВПС от гостя ВПС

По умолчанию Hyper-V создаст привилегированный вице-президент на каждом базовом физическом процессоре LP.
Эти корневые ВПС строго 1:1 сопоставляются с системой LPs системы и не переносятся, т. е. Каждый привилегированный вице-президент всегда будет выполняться на одном физическом LP.
Гостевая ВПС может выполняться в любом доступном LP, а также предоставлять выполнение с правами root ВПС.

Тем не менее, может быть желательно полностью отделить действия привилегированных гостей от гостевых ВПС.
Рассмотрим наш пример выше, где мы реализуем виртуальную машину уровня "A" Premium.
Чтобы обеспечить ВПС виртуальной машины "A" с наименьшей возможной задержкой и "нарушением" или вариантом планирования, мы хотим запустить их на выделенном наборе LPs и убедиться, что корень не работает на этих LPs.

Это можно сделать с помощью комбинации конфигурации "минрут", которая ограничивает выполнение раздела ОС узла на подмножестве всех системных логических процессоров, а также с одной или несколькими группами ЦП привязаны.

Узел виртуализации можно настроить так, чтобы раздел узла был ограничен определенным LPs, при этом одна или несколько групп ЦП привязаны в остальные LPs.
Таким образом, корневые и гостевые разделы могут работать на выделенных ресурсах ЦП и полностью изолированы без использования ЦП.

Дополнительные сведения о конфигурации "минрут" см. в разделе [Управление ресурсами ЦП узла Hyper-V](https://docs.microsoft.com/windows-server/virtualization/hyper-v/manage/manage-hyper-v-minroot-2016).

## <a name="using-the-cpugroups-tool"></a>Использование средства Кпуграупс

Рассмотрим несколько примеров использования средства Кпуграупс.

>[!NOTE] 
>Параметры командной строки для средства Кпуграупс передаются с использованием только пробелов в качестве разделителей. Символы "/" и "-" не должны воздействовать на нужный параметр командной строки.

### <a name="discovering-the-cpu-topology"></a>Обнаружение топологии ЦП

При запуске Кпуграупс с помощью Жеткпутопологи возвращаются сведения о текущей системе, как показано ниже, включая индекс LP, узел NUMA, к которому принадлежит LP, идентификатор пакета и ядра, а также индекс КОРНЕВого президента.

В следующем примере показана система с двумя сокетами ЦП и узлами NUMA, всего 32 LPs и включенной многопоточностью и настроенной для включения Минрут с 8 корневым ВПС, 4 из каждого узла NUMA.
LPs с корневым ВПС имеет Рутвпиндекс > = 0; LPs с Рутвпиндекс из-1 недоступен для корневого раздела, но по-прежнему управляется гипервизором и запускает гостевой ВПС в соответствии с другими параметрами конфигурации.

```console
C:\vm\tools>CpuGroups.exe GetCpuTopology

LpIndex NodeNumber PackageId CoreId RootVpIndex
------- ---------- --------- ------ -----------
      0          0         0      0           0
      1          0         0      0           1
      2          0         0      1           2
      3          0         0      1           3
      4          0         0      2          -1
      5          0         0      2          -1
      6          0         0      3          -1
      7          0         0      3          -1
      8          0         0      4          -1
      9          0         0      4          -1
     10          0         0      5          -1
     11          0         0      5          -1
     12          0         0      6          -1
     13          0         0      6          -1
     14          0         0      7          -1
     15          0         0      7          -1
     16          1         1     16           4
     17          1         1     16           5
     18          1         1     17           6
     19          1         1     17           7
     20          1         1     18          -1
     21          1         1     18          -1
     22          1         1     19          -1
     23          1         1     19          -1
     24          1         1     20          -1
     25          1         1     20          -1
     26          1         1     21          -1
     27          1         1     21          -1
     28          1         1     22          -1
     29          1         1     22          -1
     30          1         1     23          -1
     31          1         1     23          -1
```

### <a name="example-2--print-all-cpu-groups-on-the-host"></a>Пример 2. Печать всех групп ЦП на узле

Здесь мы выведем список всех групп ЦП на текущем узле, их идентификатор группы, ограничение на использование ЦП группой и индиЦиес LPs, назначенных этой группе.

Обратите внимание, что допустимые значения закрепления ЦП находятся в диапазоне [0, 65536], и эти значения выражают ограничение группы в процентах (например, 32768 = 50%).

```console
C:\vm\tools>CpuGroups.exe GetGroups

CpuGroupId                          CpuCap  LpIndexes
------------------------------------ ------ --------
36AB08CB-3A76-4B38-992E-000000000002 32768  4,5,6,7,8,9,10,11,20,21,22,23
36AB08CB-3A76-4B38-992E-000000000003 65536  12,13,14,15
36AB08CB-3A76-4B38-992E-000000000004 65536  24,25,26,27,28,29,30,31
```

### <a name="example-3--print-a-single-cpu-group"></a>Пример 3. Печать одной группы ЦП

В этом примере мы будем запрашивать одну группу ЦП, используя GroupId в качестве фильтра.

```console
C:\vm\tools>CpuGroups.exe GetGroups /GroupId:36AB08CB-3A76-4B38-992E-000000000003
CpuGroupId                          CpuCap   LpIndexes
------------------------------------ ------ ----------
36AB08CB-3A76-4B38-992E-000000000003 65536  12,13,14,15
```

### <a name="example-4--create-a-new-cpu-group"></a>Пример 4. Создание новой группы ЦП

Здесь мы создадим новую группу ЦП, указав идентификатор группы и набор LPs для назначения группе.

```console
C:\vm\tools>CpuGroups.exe CreateGroup /GroupId:36AB08CB-3A76-4B38-992E-000000000001 /GroupAffinity:0,1,16,17
```

Теперь отобразите добавленную группу.

```console
C:\vm\tools>CpuGroups.exe GetGroups
CpuGroupId                          CpuCap LpIndexes
------------------------------------ ------ ---------
36AB08CB-3A76-4B38-992E-000000000001 65536 0,1,16,17
36AB08CB-3A76-4B38-992E-000000000002 32768 4,5,6,7,8,9,10,11,20,21,22,23
36AB08CB-3A76-4B38-992E-000000000003 65536 12,13,14,15
36AB08CB-3A76-4B38-992E-000000000004 65536 24,25,26,27,28,29,30,31
```

### <a name="example-5--set-the-cpu-group-cap-to-50"></a>Пример 5. Установка ограничения для группы ЦП на 50%

Здесь мы установим ограничение для группы ЦП на 50%.

```console
C:\vm\tools>CpuGroups.exe SetGroupProperty /GroupId:36AB08CB-3A76-4B38-992E-000000000001 /CpuCap:32768
```

Теперь давайте подтверждаем настройку, отображая только что обновленную группу.

```console
C:\vm\tools>CpuGroups.exe GetGroups /GroupId:36AB08CB-3A76-4B38-992E-000000000001

CpuGroupId                          CpuCap LpIndexes
------------------------------------ ------ ---------
36AB08CB-3A76-4B38-992E-000000000001 32768 0,1,16,17
```

### <a name="example-6--print-cpu-group-ids-for-all-vms-on-the-host"></a>Пример 6. Печать идентификаторов групп ЦП для всех виртуальных машин на узле

```console
C:\vm\tools>CpuGroups.exe GetVmGroup

VmName                                 VmId                           CpuGroupId
------ ------------------------------------ ------------------------------------
    G2 4ABCFC2F-6C22-498C-BB38-7151CE678758 36ab08cb-3a76-4b38-992e-000000000002
    P1 973B9426-0711-4742-AD3B-D8C39D6A0DEC 36ab08cb-3a76-4b38-992e-000000000003
    P2 A593D93A-3A5F-48AB-8862-A4350E3459E8 36ab08cb-3a76-4b38-992e-000000000004
    G3 B0F3FCD5-FECF-4A21-A4A2-DE4102787200 36ab08cb-3a76-4b38-992e-000000000002
    G1 F699B50F-86F2-4E48-8BA5-EB06883C1FDC 36ab08cb-3a76-4b38-992e-000000000002
```

### <a name="example-7--unbind-a-vm-from-the-cpu-group"></a>Пример 7. Отмена привязки виртуальной машины к группе ЦП

Чтобы удалить виртуальную машину из группы ЦП, присвойте параметру Кпуграупид виртуальной машины значение GUID. Это отменяет привязку виртуальной машины к группе ЦП.

```console
C:\vm\tools>CpuGroups.exe SetVmGroup /VmName:g1 /GroupId:00000000-0000-0000-0000-000000000000

C:\vm\tools>CpuGroups.exe GetVmGroup
VmName                                 VmId                           CpuGroupId
------ ------------------------------------ ------------------------------------
    G2 4ABCFC2F-6C22-498C-BB38-7151CE678758 36ab08cb-3a76-4b38-992e-000000000002
    P1 973B9426-0711-4742-AD3B-D8C39D6A0DEC 36ab08cb-3a76-4b38-992e-000000000003
    P2 A593D93A-3A5F-48AB-8862-A4350E3459E8 36ab08cb-3a76-4b38-992e-000000000004
    G3 B0F3FCD5-FECF-4A21-A4A2-DE4102787200 36ab08cb-3a76-4b38-992e-000000000002
    G1 F699B50F-86F2-4E48-8BA5-EB06883C1FDC 00000000-0000-0000-0000-000000000000
```

### <a name="example-8--bind-a-vm-to-an-existing-cpu-group"></a>Пример 8. Привязка виртуальной машины к существующей группе ЦП

Здесь мы добавим виртуальную машину в существующую группу ЦП.
Обратите внимание, что виртуальная машина не должна быть привязана к существующей группе ЦП, или задание идентификатора группы ЦП завершится ошибкой.

```console
C:\vm\tools>CpuGroups.exe SetVmGroup /VmName:g1 /GroupId:36AB08CB-3A76-4B38-992E-000000000001
```

Теперь убедитесь, что виртуальная машина G1 находится в нужной группе ЦП.

```console
C:\vm\tools>CpuGroups.exe GetVmGroup
VmName                                 VmId                           CpuGroupId
------ ------------------------------------ ------------------------------------
    G2 4ABCFC2F-6C22-498C-BB38-7151CE678758 36ab08cb-3a76-4b38-992e-000000000002
    P1 973B9426-0711-4742-AD3B-D8C39D6A0DEC 36ab08cb-3a76-4b38-992e-000000000003
    P2 A593D93A-3A5F-48AB-8862-A4350E3459E8 36ab08cb-3a76-4b38-992e-000000000004
    G3 B0F3FCD5-FECF-4A21-A4A2-DE4102787200 36ab08cb-3a76-4b38-992e-000000000002
    G1 F699B50F-86F2-4E48-8BA5-EB06883C1FDC 36AB08CB-3A76-4B38-992E-000000000001
```

### <a name="example-9--print-all-vms-grouped-by-cpu-group-id"></a>Пример 9. Печать всех виртуальных машин, сгруппированных по идентификатору группы ЦП

```console
C:\vm\tools>CpuGroups.exe GetGroupVms
CpuGroupId                           VmName                                 VmId
------------------------------------ ------ ------------------------------------
36AB08CB-3A76-4B38-992E-000000000001     G1 F699B50F-86F2-4E48-8BA5-EB06883C1FDC
36ab08cb-3a76-4b38-992e-000000000002     G2 4ABCFC2F-6C22-498C-BB38-7151CE678758
36ab08cb-3a76-4b38-992e-000000000002     G3 B0F3FCD5-FECF-4A21-A4A2-DE4102787200
36ab08cb-3a76-4b38-992e-000000000003     P1 973B9426-0711-4742-AD3B-D8C39D6A0DEC
36ab08cb-3a76-4b38-992e-000000000004     P2 A593D93A-3A5F-48AB-8862-A4350E3459E8
```

### <a name="example-10--print-all-vms-for-a-single-cpu-group"></a>Пример 10. Печать всех виртуальных машин для одной группы ЦП

```console
C:\vm\tools>CpuGroups.exe GetGroupVms /GroupId:36ab08cb-3a76-4b38-992e-000000000002

CpuGroupId                           VmName                                VmId
------------------------------------ ------ ------------------------------------
36ab08cb-3a76-4b38-992e-000000000002     G2 4ABCFC2F-6C22-498C-BB38-7151CE678758
36ab08cb-3a76-4b38-992e-000000000002     G3 B0F3FCD5-FECF-4A21-A4A2-DE4102787200
```

### <a name="example-11--attempting-to-delete-a-non-empty-cpu-group"></a>Пример 11. попытка удаления непустой группы ЦП

Можно удалить только пустые группы ЦП, т. е. группы ЦП без привязанных виртуальных машин.
Попытка удалить непустую группу ЦП завершится ошибкой.

```console
C:\vm\tools>CpuGroups.exe DeleteGroup /GroupId:36ab08cb-3a76-4b38-992e-000000000001
(null)
Failed with error 0xc0350070
```

### <a name="example-12--unbind-the-only-vm-from-a-cpu-group-and-delete-the-group"></a>Пример 12. Отмена привязки единственной виртуальной машины к группе ЦП и удаление группы

В этом примере мы будем использовать несколько команд для проверки группы ЦП, удаления отдельной виртуальной машины, принадлежащей этой группе, и удаления группы.

Сначала выполним перечисление виртуальных машин в нашей группе.

```console
C:\vm\tools>CpuGroups.exe GetGroupVms /GroupId:36AB08CB-3A76-4B38-992E-000000000001
CpuGroupId                           VmName                                VmId
------------------------------------ ------ ------------------------------------
36AB08CB-3A76-4B38-992E-000000000001     G1 F699B50F-86F2-4E48-8BA5-EB06883C1FDC
```

Мы видим, что этой группе принадлежит только одна виртуальная машина с именем G1.
Давайте удалим виртуальную машину G1 из нашей группы, установив для идентификатора группы виртуальной машины значение NULL.

```console
C:\vm\tools>CpuGroups.exe SetVmGroup /VmName:g1 /GroupId:00000000-0000-0000-0000-000000000000
```

И проверьте наше изменение...

```console
C:\vm\tools>CpuGroups.exe GetVmGroup /VmName:g1
VmName                                 VmId                           CpuGroupId
------ ------------------------------------ ------------------------------------
    G1 F699B50F-86F2-4E48-8BA5-EB06883C1FDC 00000000-0000-0000-0000-000000000000
```

Теперь, когда группа пуста, ее можно безопасно удалить.

```console
C:\vm\tools>CpuGroups.exe DeleteGroup /GroupId:36ab08cb-3a76-4b38-992e-000000000001
```

И подтвердите, что наша группа исчезла.

```console
C:\vm\tools>CpuGroups.exe GetGroups
CpuGroupId                          CpuCap                     LpIndexes
------------------------------------ ------ -----------------------------
36AB08CB-3A76-4B38-992E-000000000002 32768  4,5,6,7,8,9,10,11,20,21,22,23
36AB08CB-3A76-4B38-992E-000000000003 65536  12,13,14,15
36AB08CB-3A76-4B38-992E-000000000004 65536 24,25,26,27,28,29,30,31
```

### <a name="example-13--bind-a-vm-back-to-its-original-cpu-group"></a>Пример 13. Привязка виртуальной машины к исходной группе ЦП

```console
C:\vm\tools>CpuGroups.exe SetVmGroup /VmName:g1 /GroupId:36AB08CB-3A76-4B38-992E-000000000002

C:\vm\tools>CpuGroups.exe GetGroupVms
CpuGroupId VmName VmId
------------------------------------ -------------------------------- ------------------------------------
36ab08cb-3a76-4b38-992e-000000000002 G2 4ABCFC2F-6C22-498C-BB38-7151CE678758
36ab08cb-3a76-4b38-992e-000000000002 G3 B0F3FCD5-FECF-4A21-A4A2-DE4102787200
36AB08CB-3A76-4B38-992E-000000000002 G1 F699B50F-86F2-4E48-8BA5-EB06883C1FDC
36ab08cb-3a76-4b38-992e-000000000003 P1 973B9426-0711-4742-AD3B-D8C39D6A0DEC
36ab08cb-3a76-4b38-992e-000000000004 P2 A593D93A-3A5F-48AB-8862-A4350E3459E8
```
