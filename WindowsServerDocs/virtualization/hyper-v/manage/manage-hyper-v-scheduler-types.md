---
title: Основные сведения и использование типов планировщиков низкоуровневой оболочки Hyper-V
description: Предоставляет администраторам узлов Hyper-V сведения об использовании режимов планировщика Hyper-V
author: allenma
ms.author: allenma
ms.date: 08/14/2018
ms.topic: article
ms.prod: windows-server-hyper-v
ms.technology: virtualization
ms.localizationpriority: low
ms.assetid: 6cb13f84-cb50-4e60-a685-54f67c9146be
ms.openlocfilehash: 8ba413b831c7b11780113ee2ffd3cce598781a44
ms.sourcegitcommit: 2a15de216edde8b8e240a4aa679dc6d470e4159e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/19/2020
ms.locfileid: "77465578"
---
# <a name="managing-hyper-v-hypervisor-scheduler-types"></a>Управление типами планировщика низкоуровневой оболочки Hyper-V

>Область применения: Windows 10, Windows Server 2016, Windows Server, версия 1709, Windows Server, версия 1803, Windows Server 2019

В этой статье описываются новые режимы логики планирования виртуальных процессоров, впервые представленные в Windows Server 2016. Эти режимы или типы планировщика определяют, как гипервизор Hyper-V выделяет и управляет работой в гостевых виртуальных процессорах. Администратор узла Hyper-V может выбрать типы планировщика гипервизора, которые лучше всего подходят для гостевых виртуальных машин, и настроить виртуальные машины таким образом, чтобы они могли использовать преимущества логики планирования.

>[!NOTE]
>Обновления необходимы для использования функций планировщика гипервизора, описанных в этом документе. Дополнительные сведения см. в разделе [необходимые обновления](#required-updates).

## <a name="background"></a>Фон

Прежде чем обсуждать логику и элементы управления при планировании виртуальных процессоров Hyper-V, полезно ознакомиться с основными понятиями, изложенными в этой статье.

### <a name="understanding-smt"></a>Основные сведения о SMT

Одновременная многопоточность или SMT — это методика, используемая в современных процессорных разработках, которая позволяет совместно использовать ресурсы процессора отдельными, независимо выполняемыми потоками выполнения. SMT обычно обеспечивает небольшое повышение производительности для большинства рабочих нагрузок, параллельно вычисляя вычисления, когда это возможно, увеличивая пропускную способность, несмотря на снижение производительности или даже незначительную потери производительности, если состязание между потоками для происходят общие ресурсы процессора.
Процессоры, поддерживающие SMT, доступны как в Intel, так и в AMD. Intel относится к предложениям SMT в виде технологии Intel Hyper Threading или Intel HT.

В рамках этой статьи описания SMT и способы их использования Hyper-V применяются и к системам Intel и AMD.

* Дополнительные сведения о технологии Intel HT см. на сайте [технология Hyper-Threading](https://www.intel.com/content/www/us/en/architecture-and-technology/hyper-threading/hyper-threading-technology.html)

* Дополнительные сведения о AMD SMT см. в разделе ["Базовая архитектура" Zen "](https://www.amd.com/en/technologies/zen-core) .

## <a name="understanding-how-hyper-v-virtualizes-processors"></a>Основные сведения о виртуализации процессоров Hyper-V

Перед рассмотрением типов планировщиков гипервизора также полезно понимать архитектуру Hyper-V. Общую сводку можно найти в [обзоре технологии Hyper-V](https://docs.microsoft.com/windows-server/virtualization/hyper-v/hyper-v-technology-overview). Ниже приведены важные понятия, связанные с этой статьей.

* Hyper-V создает и управляет секциями виртуальных машин, в рамках которых ресурсы вычислений распределяются и совместно используются, под контролем гипервизора. Секции обеспечивают строгие границы изоляции между всеми гостевыми виртуальными машинами, а также между гостевыми и корневыми машинами.

* Корневой раздел сам является разделом виртуальной машины, хотя у него есть уникальные свойства и более широкие привилегии, чем Гостевые виртуальные машины. Корневой раздел предоставляет службы управления, управляющие всеми гостевыми виртуальными машинами, обеспечивает поддержку виртуальных устройств для гостей и управляет всеми операциями ввода-вывода для гостевых виртуальных машин. Корпорация Майкрософт настоятельно рекомендует не выполнять никакие рабочие нагрузки приложений в корневом разделе.

* Каждый виртуальный процессор (вице-президент) корневого раздела сопоставляется с 1:1 базовым логическим процессором (LP). Вице-президент узла всегда будет выполняться на том же самом базовом LP — миграция ВПС корневого раздела отсутствует.

* По умолчанию LPs, на котором размещен ВПС, может также запускать гостевой ВПС.

* Низкоуровневая виртуальная машина может быть запланирована для запуска на любом доступном логическом процессоре. В то время как планировщик низкоуровневой оболочки следит за локализацией временного кэша, топологией NUMA и многими другими факторами при планировании гостевого вице-президента, в конечном счете, его можно запланировать на любом сервере LP.

## <a name="hypervisor-scheduler-types"></a>Типы планировщика гипервизора

Начиная с Windows Server 2016 гипервизор Hyper-V поддерживает несколько режимов логики планировщика, которые определяют, как гипервизор планирует виртуальные процессоры на базовых логических процессорах. Эти типы планировщиков:

- [Классический планировщик с долево распределением](#the-classic-scheduler)
- [Основной планировщик](#the-core-scheduler)
- [Корневой планировщик](#the-root-scheduler)

### <a name="the-classic-scheduler"></a>Классический планировщик

Классическое планировщик по умолчанию использовался для всех версий гипервизора Windows Hyper-V с момента его появления, включая Windows Server 2016 Hyper-V. Классический планировщик предоставляет высокодоступную модель планирования циклического перебора с вытеснением для гостевых виртуальных процессоров.

Классический тип планировщика является наиболее подходящим для большинства традиционных применений Hyper-V — для частных облаков, поставщиков услуг размещения и т. д. Характеристики производительности хорошо понятны и оптимально оптимизированы для поддержки широкого спектра сценариев виртуализации, таких как чрезмерная подписка ВПС на LPs, одновременное выполнение нескольких разнородных виртуальных машин и рабочих нагрузок, выполнение большого объема данных большого масштаба. Виртуальные машины с производительностью, поддерживающие полный набор функций Hyper-V без ограничений и многое другое.

### <a name="the-core-scheduler"></a>Основной планировщик

Планировщик Core гипервизора — это новая альтернатива классической логике планировщика, представленная в Windows Server 2016 и Windows 10 версии 1607. Основной планировщик предлагает надежную границу безопасности для изоляции гостевой рабочей нагрузки и снижает изменчивость производительности для рабочих нагрузок в виртуальных машинах, работающих на узле виртуализации с поддержкой SMT. Основной планировщик позволяет одновременно запускать SMT и не SMT виртуальные машины на одном узле виртуализации с поддержкой SMT.

Основной планировщик использует топологию SMT узла виртуализации и при необходимости предоставляет пары SMT для гостевых виртуальных машин и планирует группы гостевых виртуальных процессоров из одной и той же виртуальной машины на группы логических процессоров SMT. Это делается симметрично, так что если LPs находятся в группах из двух, ВПС планируется в группах из двух, а ядро никогда не будет совместно использоваться виртуальными машинами.
Если для виртуальной машины запланирована работа без SMT, то этот вице-президент будет потреблять все ядро при запуске.

Общий результат основного планировщика состоит в том, что:

* Гостевая ВПС ограничена выполнением на базовых физических ядерных парах, изолируя виртуальную машину с границами ядра процессора, тем самым уменьшая уязвимости от атак с отслеживанием побочных каналов от вредоносных виртуальных машин.

* Вариативность пропускной способности значительно сокращается.

* Производительность может снизиться, так как если только одна из групп ВПС может выполняться, только один из потоков инструкций в ядре будет выполняться, пока другой не простаивает.

* Операционная система и приложения, работающие на гостевой виртуальной машине, могут использовать SMTное поведение и программные интерфейсы (API) для управления и распространения работы в потоках SMT, как и при выполнении невиртуализованных.

* Строгая граница безопасности для изоляции гостевой рабочей нагрузки. Гостевая ВПС ограничена в базовых физических базовых парах, что снижает уязвимость для атак с отслеживанием побочных каналов.

Основной планировщик будет использоваться по умолчанию, начиная с Windows Server 2019. В Windows Server 2016 основной планировщик является необязательным и должен быть явно включен администратором узла Hyper-V, а классический планировщик — по умолчанию.

#### <a name="core-scheduler-behavior-with-host-smt-disabled"></a>Поведение основного планировщика с отключенным узлом SMT

Если гипервизор настроен для использования основного типа планировщика, но функция SMT отключена или отсутствует на узле виртуализации, гипервизор будет использовать классическое поведение планировщика независимо от параметра типа планировщика низкоуровневой оболочки.

### <a name="the-root-scheduler"></a>Корневой планировщик

Корневой планировщик появился в Windows 10 версии 1803. Если включен тип "корневой планировщик", гипервизор замещает управление планированием работы в корневую секцию. Планировщик NT в экземпляре ОС корневого раздела управляет всеми аспектами планирования работы для System LPs.

Корневой планировщик соответствует уникальным требованиям, присущим поддержке раздела служебной программы для обеспечения строгой изоляции рабочей нагрузки, используемой с Application Guard в Защитнике Windows (ВДАГ). В этом случае обязанности по планированию для корневой ОС предоставляют несколько преимуществ. Например, элементы управления ресурсами ЦП, применимые к сценариям контейнеров, можно использовать с служебным разделом, что упрощает управление и развертывание. Кроме того, планировщик корневой ОС может быстро собирать метрики загрузки ЦП рабочей нагрузки в контейнере и использовать эти данные в качестве входных данных для одной и той же политики планирования, применимой ко всем остальным рабочим нагрузкам в системе. Эти же метрики также помогают четко определить работу, выполненную в контейнере приложения, в системе размещения. Отслеживание этих метрик усложняется с традиционными рабочими нагрузками виртуальных машин, в которых некоторые действия для всех работающих виртуальных машин выполняются в корневом разделе.

#### <a name="root-scheduler-use-on-client-systems"></a>Использование корневого планировщика в клиентских системах

Начиная с Windows 10 версии 1803, корневой планировщик используется по умолчанию только на клиентских системах, где гипервизор может быть включен в поддержку безопасности на основе виртуализации и изоляции рабочей нагрузки ВДАГ, а также для правильной работы будущих систем с разнородные базовые архитектуры. Это единственная поддерживаемая конфигурация планировщика гипервизора для клиентских систем. Администраторы не должны пытаться переопределить тип планировщика гипервизора по умолчанию в клиентских системах Windows 10.

#### <a name="virtual-machine-cpu-resource-controls-and-the-root-scheduler"></a>Элементы управления ресурсами ЦП виртуальной машины и корневой планировщик

Элементы управления ресурсами процессора виртуальной машины, предоставляемые Hyper-V, не поддерживаются, если включен корневой планировщик низкоуровневой оболочки, так как логика планировщика корневой операционной системы управляет ресурсами узла на глобальном уровне и не имеет сведений о виртуальных машинах конкретные параметры конфигурации. Элементы управления ресурсами процессора Hyper-V на виртуальную машину, такие как ограничения, веса и резервы, применимы только в тех случаях, когда гипервизор непосредственно контролирует планирование виртуальных машин, например с помощью классических и основных типов планировщиков.

#### <a name="root-scheduler-use-on-server-systems"></a>Использование корневого планировщика в серверных системах

В настоящее время корневой планировщик не рекомендуется использовать с Hyper-V на серверах, так как его характеристики производительности еще не полностью характеризуются и настроены для поддержки широкого спектра рабочих нагрузок, типичных для многих развертываний серверной виртуализации.

## <a name="enabling-smt-in-guest-virtual-machines"></a>Включение SMT на гостевых виртуальных машинах

Когда гипервизор узла виртуализации настроен для использования основного типа планировщика, Гостевые виртуальные машины могут быть настроены на использование SMT при необходимости. Предоставление доступа к тому факту, что ВПС-потоков на гостевую виртуальную машину, позволяет планировщику в гостевой операционной системе и рабочим нагрузкам, выполняемым на ВИРТУАЛЬНОЙ машине, обнаруживать и использовать топологию SMT в собственном планировании работы. В Windows Server 2016 Гостевая SMT не настроена по умолчанию и должна быть явно включена администратором узла Hyper-V. Начиная с Windows Server 2019, новые виртуальные машины, созданные на узле, будут наследовать топологию SMT узла по умолчанию.  Таким образом, виртуальная машина версии 9,0, созданная на узле с 2 SMT потоками на ядро, также увидит 2 SMT потока на ядро.

Для включения SMT в гостевой виртуальной машине необходимо использовать PowerShell. в диспетчере Hyper-V не предоставлен пользовательский интерфейс.
Чтобы включить SMT на гостевой виртуальной машине, откройте окно PowerShell с достаточными разрешениями и введите:

``` powershell
Set-VMProcessor -VMName <VMName> -HwThreadCountPerCore <n>
```

Где <n> — число потоков SMT на ядро, которое будет видеть Гостевая виртуальная машина.  
Обратите внимание, что <n> = 0 установит значение Хвсреадкаунтперкоре в соответствии с количеством потоков SMT узла на значение ядра.

>[!NOTE] 
>Параметр Хвсреадкаунтперкоре = 0 поддерживается начиная с Windows Server 2019.

Ниже приведен пример системной информации, полученной из гостевой операционной системы, работающей на виртуальной машине с 2 виртуальными процессорами и SMT. Операционная система на виртуальной машине обнаруживает 2 логических процессора, принадлежащих одному и тому же ядру.

![Снимок экрана, на котором показана msinfo32 на гостевой виртуальной машине с включенным SMT](media/Hyper-V-CoreScheduler-VM-Msinfo32.png)

## <a name="configuring-the-hypervisor-scheduler-type-on-windows-server-2016-hyper-v"></a>Настройка типа планировщика низкоуровневой оболочки в Windows Server 2016 Hyper-V

Windows Server 2016 Hyper-V по умолчанию использует классическую модель планировщика низкоуровневой оболочки. Гипервизор можно дополнительно настроить для использования базового планировщика, чтобы повысить уровень безопасности, запретив гостевому ВПС работать на соответствующих физических SMT парах и поддерживать использование виртуальных машин с планированием SMT для своих гостевых ВПС.

>[!NOTE]
>Корпорация Майкрософт рекомендует всем клиентам, работающим под управлением Windows Server 2016 Hyper-V, выбрать основной планировщик, чтобы обеспечить оптимальную защиту узлов виртуализации от потенциально вредоносных гостевых виртуальных машин.

## <a name="windows-server-2019-hyper-v-defaults-to-using-the-core-scheduler"></a>Windows Server 2019 Hyper-V по умолчанию использует основной планировщик

Чтобы обеспечить развертывание узлов Hyper-V в оптимальной конфигурации безопасности, Windows Server 2019 Hyper-V теперь будет по умолчанию использовать основную модель планировщика гипервизора. Администратор узла может при необходимости настроить узел для использования устаревшего классического планировщика. Администраторы должны внимательно прочесть, понять и рассмотреть влияние влияния каждого типа планировщика на безопасность и производительность узлов виртуализации перед переопределением параметров типа по умолчанию планировщика.  Дополнительные сведения см. в статье [сведения о выборе типа планировщика Hyper-V](https://docs.microsoft.com/windows-server/virtualization/hyper-v/manage/understanding-hyper-v-scheduler-type-selection) .

### <a name="required-updates"></a>Необходимые обновления

>[!NOTE]
>Для использования функций планировщика низкоуровневой оболочки, описанных в этом документе, необходимы следующие обновления. Эти обновления включают изменения для поддержки нового параметра BCD "хипервисорсчедулертипе", который необходим для настройки узла.

| Версия | Release  | Требуется обновление | Статья базы знаний |
|--------------------|------|---------|-------------:|
|Windows Server 2016 | 1607 | 2018,07 C | [KB4338822](https://support.microsoft.com/help/4338822/windows-10-update-kb4338822) |
|Windows Server 2016 | 1703 | 2018,07 C | [KB4338827](https://support.microsoft.com/help/4338827/windows-10-update-kb4338827) |
|Windows Server 2016 | 1709 | 2018,07 C | [KB4338817](https://support.microsoft.com/help/4338817/windows-10-update-kb4338817) |
|Windows Server 2019 | 1804 | Нет | Нет |

## <a name="selecting-the-hypervisor-scheduler-type-on-windows-server"></a>Выбор типа планировщика низкоуровневой оболочки в Windows Server

Управление конфигурацией планировщика гипервизора осуществляется с помощью записи BCD хипервисорсчедулертипе.

Чтобы выбрать тип планировщика, откройте командную строку с правами администратора:

``` command
     bcdedit /set hypervisorschedulertype type
```

Где `type` является одним из следующих:

* Classic
* Базовая
* Root

Чтобы изменения типа планировщика гипервизора вступили в силу, необходимо перезагрузить систему.

>[!NOTE]
>В настоящее время корневой планировщик низкоуровневой оболочки не поддерживается в Windows Server Hyper-V. Администраторам Hyper-V не следует пытаться настроить корневой планировщик для использования с сценариями виртуализации сервера.

## <a name="determining-the-current-scheduler-type"></a>Определение текущего типа планировщика

Вы можете определить текущий тип планировщика гипервизора, используя журнал системы в Просмотр событий для последнего события с ИДЕНТИФИКАТОРом 2 для запуска гипервизора, который сообщает о типе планировщика низкоуровневой оболочки, настроенном при запуске гипервизора. События запуска гипервизора можно получить из Просмотр событий Windows или с помощью PowerShell.

Код события запуска гипервизора 2 обозначает тип планировщика низкоуровневой оболочки, где:

    1 = Classic scheduler, SMT disabled

    2 = Classic scheduler

    3 = Core scheduler

    4 = Root scheduler

![Снимок экрана с ИДЕНТИФИКАТОРом события запуска гипервизора 2](media/Hyper-V-CoreScheduler-EventID2-Details.png)

![Снимок экрана, показывающий Просмотр событий отображения события запуска гипервизора с ИДЕНТИФИКАТОРом 2](media/Hyper-V-CoreScheduler-EventViewer.png)

### <a name="querying-the-hyper-v-hypervisor-scheduler-type-launch-event-using-powershell"></a>Запрос события запуска типа планировщика низкоуровневой оболочки Hyper-V с помощью PowerShell

Чтобы запросить событие низкоуровневой оболочки с ИДЕНТИФИКАТОРом 2 с помощью PowerShell, введите следующие команды в командной строке PowerShell.

``` powershell
Get-WinEvent -FilterHashTable @{ProviderName="Microsoft-Windows-Hyper-V-Hypervisor"; ID=2} -MaxEvents 1
```

![Снимок экрана с запросом PowerShell и результатами события запуска низкоуровневой оболочки с ИДЕНТИФИКАТОРом 2](media/Hyper-V-CoreScheduler-PowerShell.png)
