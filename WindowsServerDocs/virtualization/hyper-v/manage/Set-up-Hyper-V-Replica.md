---
title: Настройка реплики Hyper-V
ms.technology: compute-hyper-v
description: Содержит инструкции по настройке реплики, тестированию отработки отказа и выполнению первой репликации.
ms.prod: windows-server
ms.service: na
manager: dongill
ms.topic: article
ms.assetid: eea9e996-bfec-4065-b70b-d8f66e7134ac
author: KBDAzure
ms.author: kathydav
ms.date: 10/10/2016
ms.openlocfilehash: 9ba2fcbbf727b1116cc89d928218ef642d74fc0a
ms.sourcegitcommit: 6aff3d88ff22ea141a6ea6572a5ad8dd6321f199
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/27/2019
ms.locfileid: "71392567"
---
# <a name="set-up-hyper-v-replica"></a>Настройка реплики Hyper-V

>Область применения. Windows Server 2016

Реплика Hyper-V является неотъемлемой частью роли Hyper-V. Она влияет на стратегию аварийного восстановления путем репликации виртуальных машин с одного сервера узла Hyper-V на другой для поддержания доступности рабочих нагрузок.  Реплика Hyper-V создает копию активной виртуальной машины в автономной виртуальной машине реплики. Обратите внимание на следующее условия:  

-   **Узлы Hyper-V**: Серверы первичного и вторичного узлов могут быть физически размещены или расположены в разных географических расположениях с репликацией по каналу глобальной сети. Узлы Hyper-V могут быть автономными, кластеризованными или смешанными. Между серверами нет зависимости Active Directory и они не должны быть членами домена.  

-   **Репликация и отслеживание изменений**: При включении реплики Hyper-V для конкретной виртуальной машины при начальной репликации создается идентичная виртуальная машина реплики на сервере вторичного узла. После этого система отслеживания изменений реплики Hyper-V создает и поддерживает файл журнала, который фиксирует изменения на виртуальном жестком диске виртуальной машины. Файл журнала воспроизводится в обратный порядок с VHD реплики на основе параметров частоты репликации. Это означает, что последние изменения хранятся и реплицируются асинхронно. Репликация может выполняться по протоколу HTTP или HTTPS.  

-   **Расширенная (цепочка) репликация**: Это позволяет реплицировать виртуальную машину с основного узла на дополнительный, а затем реплицировать дополнительный узел на третий узел. Обратите внимание, что невозможно выполнить репликацию с основного узла непосредственно на второй и третий.  

    Эта функция делает реплику Hyper-V более надежной для аварийного восстановления, поскольку при возникновении сбоя можно выполнить восстановление из основной и расширенной реплики.  Вы можете выполнить отработку отказа в расширенную реплику, если основное и вторичное расположения выходят из строя. Обратите внимание, что расширенная реплика не поддерживает репликацию с поддержкой приложений и должна использовать те же виртуальные жесткие диски, что и вторичная реплика.  

-   Отработка отказа: При возникновении сбоя в первичном (или дополнительном) расположении можно вручную инициировать тестовую, плановую или внеплановую отработку отказа.  

    ||Тестирование|Запланировано|Незапланированные ситуации|  
    |-|--------|-----------|-------------|  
    |Когда следует запускать?|Проверка возможности отработки отказа и запуска виртуальной машины на вторичном сайте<br /><br />Полезно для тестирования и обучения|Во время запланированного простоя и сбоев|Во время непредвиденных событий|  
    |Создана ли копия виртуальной машины?|Да|Нет|Нет|  
    |Где она инициируется?|На виртуальной машине реплики|Инициируется на основной и завершается на дополнительной|На виртуальной машине реплики|  
    |Как часто следует запускать?|Мы рекомендуем раз в месяц для тестирования|Каждые шесть месяцев или в соответствии с требованиями соответствия|Только в случае аварии, если основная виртуальная машина недоступна|  
    |Продолжает ли реплицироваться основная виртуальная машина?|Да|Да. Когда сбой разрешается, обратная Репликация реплицирует изменения обратно на первичный сайт, чтобы обеспечить синхронизацию первичной и вторичной реплики.|Нет|  
    |Есть ли потери данных?|Нет|Нет. После того как отказоустойчивая реплика Hyper-V реплицирует последний набор отслеживаний изменений обратно в сервер-источник для обеспечения нулевой потери данных.|Зависит от точек восстановления и событий|  
    |Возникает ли простой?|Нет. Это не влияет на рабочую среду. Во время отработки отказа создается повторяющаяся тестовая виртуальная машина. После завершения отработки отказа выберите **отработка отказа** на реплике виртуальной машины, которая автоматически очищается и удаляется.|Продолжительность запланированного сбоя|Продолжительность незапланированного сбоя|  

-   **Точки восстановления**: При настройке параметров репликации для виртуальной машины указываются точки восстановления, которые необходимо сохранить из нее. Точки восстановления представляют моментальный снимок времени, из которого можно восстановить виртуальную машину. Очевидно, что при восстановлении после недавней точки восстановления данные теряются. Доступ к точкам восстановления можно получить до 24 часов назад.  

## <a name="deployment-prerequisites"></a>Необходимые условия для развертывания  
Перед началом работы необходимо проверить следующее:  

-   **Выясните, какие виртуальные жесткие диски необходимо реплицировать**. В частности, виртуальные жесткие диски, содержащие данные, которые быстро изменяются и не используются сервером реплики после отработки отказа, такие как диски страничных файлов, следует исключить из репликации для экономии пропускной способности сети. Запишите, какие виртуальные жесткие диски можно исключить.  

-   **Решите, как часто требуется синхронизировать данные**:  Данные на сервере реплики синхронизируются в соответствии с настроенной периодичностью репликации (30 секунд, 5 минут или 15 минут). Выбранная периодичность должна учитывать следующее. Виртуальные машины запускают критически важные данные с низкой RPO? Каковы требования к пропускной способности?  Для высококритичных виртуальных машин, очевидно, потребуется более частая репликация.  

-   **Выбор способа восстановления данных**:  По умолчанию в реплике Hyper-V хранится только одна точка восстановления, которая будет последней репликацией, отправленной с сервера-источника на сервер-получатель. Однако если вы хотите восстановить данные до более ранней точки во времени, можно указать, что необходимо хранить дополнительные точки восстановления (не более 24 часов). Если вам нужны дополнительные точки восстановления, следует отметить, что это требует дополнительных затрат на обработку и ресурсы хранилища.  

-   Определите **, какие рабочие нагрузки будут реплицироваться**: Стандартная репликация реплики Hyper-V обеспечивает согласованность в состоянии операционной системы виртуальной машины после отработки отказа, но не в состоянии приложений, выполняющихся на виртуальной машине. Если требуется возможность восстановления состояния рабочей нагрузки, можно создать точки восстановления, совместимые с приложениями. Обратите внимание, что восстановление с поддержкой приложений недоступно на сайте расширенной реплики, если вы используете расширенную (объединенную) репликацию.  

-   **Выбор способа выполнения начальной репликации данных виртуальной машины**. Репликация начинается с передачи необходимых данных для передачи текущего состояния виртуальных машин. Это можно сделать сразу же или через указанное вами время посредством существующей сети. Вы также можете использовать уже существующую восстановленную виртуальную машину (например, если вы восстановили предыдущую резервную копию виртуальной машины на сервере реплики) в качестве начальной копии. Чтобы сэкономить пропускную способность сети, можно записать первоначальную копию на внешний носитель, а потом физически перенести его на объект с репликой.  Если вы хотите использовать уже существующую виртуальную машину, удалите все предыдущие моментальные снимки, связанные с ним.  

## <a name="deployment-steps"></a>Шаги развертывания  

### <a name="step-1-set-up-the-hyper-v-hosts"></a>Шаг 1. Настройка узлов Hyper-V  
На каждом сервере потребуется по крайней мере два узла Hyper-V с одной или несколькими виртуальными машинами. [Начало работы с Hyper-V](../get-started/Get-started-with-Hyper-V-on-Windows.md). Сервер узла, на котором будут реплицироваться виртуальные машины, должен быть настроен в качестве сервера реплики.  

1.  В параметрах Hyper-V для сервера, на котором будут реплицироваться виртуальные машины, в **конфигурации репликации**выберите **включить этот компьютер в качестве сервера реплики**.  

2.  Репликацию можно выполнять по протоколу HTTP или зашифрованному протоколу HTTPS. Выберите **использовать Kerberos (http)** или **использовать проверку подлинности на основе сертификатов (HTTPS**). По умолчанию HTTP 80 и HTTPS 443 включены как исключения брандмауэра на сервере реплики Hyper-V. При изменении параметров порта по умолчанию необходимо также изменить исключение брандмауэра. Если выполняется репликация по протоколу HTTPS, необходимо выбрать сертификат и настроить проверку подлинности на основе сертификата.  

3.  Для авторизации установите флажок **Разрешить репликацию с любого сервера, прошедшего проверку подлинности** , чтобы разрешить серверу реплики принимать трафик репликации виртуальных машин с любого сервера, который успешно проходит проверку подлинности. Установите флажок **Разрешить репликацию с указанных серверов** , чтобы принимать трафик только от основных серверов, которые были выбраны специально.  

    Для обоих параметров можно указать, где должны храниться реплицированные виртуальные жесткие диски на реплике сервера Hyper-V.  

4.  Нажмите кнопку **OK** или **Применить**.  

### <a name="step-2-set-up-the-firewall"></a>Шаг 2. Настройка брандмауэра  
Чтобы разрешить репликацию между основным и дополнительным серверами, трафик должен пройти через брандмауэр Windows (или брандмауэры сторонних производителей). При установке роли Hyper-V на серверах по умолчанию создаются исключения для HTTP (80) и HTTPS (443). Если вы используете эти стандартные порты, необходимо просто включить правила.  

-  Чтобы включить правила на изолированном сервере узла, выполните следующие действия.  

    1. Откройте брандмауэр Windows в предварительной безопасности и щелкните **правила для входящих подключений**.  

    2. Чтобы включить проверку подлинности по протоколу HTTP (Kerberos), щелкните правой кнопкой мыши компонент **прослушиватель HTTP реплики Hyper-V (TCP-in)**  >**включить правило.** Чтобы включить проверку подлинности на основе сертификата HTTPS, щелкните правой кнопкой мыши узел **прослушиватель HTTPS реплики Hyper-V (входящий трафик TCP)** >**правило ключить**E.  

-  Чтобы включить правила в кластере Hyper-V, откройте сеанс Windows PowerShell с помощью команды **Запуск от имени администратора**, а затем выполните одну из следующих команд:  

    -   Для HTTP: `get-clusternode | ForEach-Object  {Invoke-command -computername $_.name -scriptblock {Enable-Netfirewallrule -displayname "Hyper-V Replica HTTP Listener (TCP-In)"}}`  

    -   Для HTTPS: `get-clusternode | ForEach-Object  {Invoke-command -computername $_.name -scriptblock {Enable-Netfirewallrule -displayname "Hyper-V Replica HTTPS Listener (TCP-In)"}}`  

### <a name="enable-virtual-machine-replication"></a>Включение репликации виртуальных машин  
Выполните следующие действия на каждой виртуальной машине, которую необходимо реплицировать.  

1.  В области **сведений** диспетчера Hyper-V выберите виртуальную машину, щелкнув ее.  
    Щелкните правой кнопкой мыши выбранную виртуальную машину и выберите **включить репликацию** , чтобы открыть мастер включения репликации.  

2.  На странице **Прежде чем приступить к работе** нажмите кнопку **Далее**.  

3.  На странице **Указание сервера реплики** в поле сервер реплики Введите NetBIOS-или полное доменное имя сервера реплики. Если сервер реплики входит в состав отказоустойчивого кластера, введите имя брокера реплики Hyper-V. Нажмите кнопку **Далее**.  

4.  На странице **Указание параметров подключения** реплика Hyper-V автоматически получает параметры проверки подлинности и порта, настроенные для сервера реплики. Если значения не извлекаются, убедитесь, что сервер настроен в качестве сервера реплики и зарегистрирован в DNS. Если требуется, введите вручную в параметре.  

5.  На странице **Выбор виртуальных жестких дисков репликации** убедитесь, что выбраны виртуальные жесткие диски, которые нужно реплицировать, и снимите флажки для всех виртуальных жестких дисков, которые необходимо исключить из репликации. Затем нажмите кнопку **Далее**.  

6.  На странице **Настройка частоты репликации** укажите, как часто следует синхронизировать изменения из базы данных-источника с базой данных-получателем. Затем нажмите кнопку **Далее**.  

7.  На странице **Настройка дополнительных точек восстановления** укажите, следует ли поддерживать только последнюю точку восстановления или создать дополнительные точки.    Если вы хотите постоянно восстанавливать приложения и рабочие нагрузки с собственными модулями записи VSS, рекомендуем выбрать параметр **Служба теневого копирования томов (VSS) частота**y и указать периодичность создания моментальных снимков с согласованием приложений. Обратите внимание, что служба запрашивающей стороны VMM Hyper-V должна работать на основном и дополнительном серверах Hyper-V. Затем нажмите кнопку **Далее**.  

8.  На странице **Выбор начальной репликации** выберите используемый метод начальной репликации.  При настройке по умолчанию для отправки начальной копии по сети будет скопирован основной файл конфигурации виртуальной машины (VMCX) и файлы виртуального жесткого диска (VHDX и VHD), выбранные вами через сетевое подключение. Проверьте доступность пропускной способности сети, если вы собираетесь использовать этот параметр. Если основная виртуальная машина уже настроена на вторичном сайте как реплицированная виртуальная машина, может быть полезно выбрать вариант **использовать существующую виртуальную машину на сервере репликации в качестве начальной копии**. Вы можете использовать экспорт Hyper-V, чтобы экспортировать основную виртуальную машину и импортировать ее в качестве виртуальной машины реплики на сервере-получателе. Для крупных виртуальных машин или ограниченной пропускной способности можно выбрать, чтобы начальная репликация по сети происходила позже, а затем настроить часы наименьшей нагрузки или отправить сведения о начальной репликации в качестве автономного носителя.  

    При выполнении автономной репликации будет выполнена передача начальной копии на сервер-получатель с помощью внешнего носителя, такого как жесткий диск или USB-накопитель. Для этого необходимо подключить внешнее хранилище к основному серверу (или узлу-владельцу в кластере), а затем при выборе отправить начальное копирование с помощью внешнего носителя можно указать расположение локально или на внешнем носителе, где может храниться первоначальная копия.  На сайте реплики создается заполнитель виртуальной машины. После завершения начальной репликации внешнее хранилище может быть отправлено на сайт реплики. Вы подключите внешний носитель к серверу-получателю или к узлу-владельцу в дополнительном кластере. Затем вы импортируете исходную реплику в указанное расположение и объединяете ее в заполнитель виртуальной машины.  

9. На странице **Завершение репликации** проверьте сведения в сводке и нажмите кнопку **Готово.** Данные виртуальной машины будут передаваться в соответствии с выбранными параметрами. появится диалоговое окно, указывающее, что репликация была успешно включена.  

10. Если вы хотите настроить расширенную (объединенную) репликацию, откройте сервер реплики и щелкните правой кнопкой мыши виртуальную машину, которую необходимо реплицировать. Щелкните **репликация** > **расширить репликацию** и укажите параметры репликации.  

## <a name="run-a-failover"></a>Запуск отработки отказа  
После выполнения этих действий по развертыванию реплицированная среда работает. Теперь можно выполнять отработку отказа по мере необходимости.  

**Тестовая отработка отказа**:  Если вы хотите выполнить тестовую отработку отказа, щелкните правой кнопкой мыши основную виртуальную машину и выберите **репликация** > **Тестовая отработка отказа**. Выберите последнюю или другую точку восстановления, если она настроена. На вторичном сайте будет создана и запущена новая тестовая виртуальная машина. После завершения тестирования выберите пункт " **закончить тестовую отработку отказа** " на виртуальной машине реплики, чтобы очистить ее. Обратите внимание, что для виртуальной машины можно выполнять только одну тестовую отработку отказа за раз. [Дополнительные сведения](https://blogs.technet.com/b/virtualization/archive/2012/07/26/types-of-failover-operations-in-hyper-v-replica.aspx).  

**Плановая отработка отказа**: Чтобы запустить плановую отработку отказа, щелкните основную виртуальную машину правой кнопкой мыши и выберите **репликация**@no__t 1**плановая отработка отказа**. Плановая отработка отказа выполняет проверку предварительных требований для обеспечения нулевой потери данных. Прежде чем начать отработку отказа, проверяется завершение работы основной виртуальной машины. После отработки отказа виртуальной машины она начинает реплицировать изменения обратно на первичный сайт, когда он доступен. Обратите внимание, что для этого необходимо настроить сервер-источник для полученное репликации с сервера-получателя или брокера реплики Hyper-V в случае основного кластера. Плановая отработка отказа отправляет последний набор отслеживаний изменений. [Дополнительные сведения](https://blogs.technet.com/b/virtualization/archive/2012/07/31/types-of-failover-operations-in-hyper-v-replica-part-ii-planned-failover.aspx).  

**Внеплановая отработка отказа**: Чтобы запустить внеплановую отработку отказа, щелкните правой кнопкой мыши виртуальную машину реплики и выберите **репликация** > **внеплановая отработка отказа** из диспетчера Hyper-V или диспетчера отказоустойчивого кластера. Если этот параметр включен, можно выполнить восстановление из последней точки восстановления или из предыдущих точек восстановления. После отработки отказа убедитесь, что все работает правильно на виртуальной машине, для которой выполнен переход, а затем нажмите кнопку **завершить** на виртуальной машине реплики. [Дополнительные сведения](https://blogs.technet.com/b/virtualization/archive/2012/08/08/types-of-failover-operations-in-hyper-v-replica-part-iii-unplanned-failover.aspx).  
