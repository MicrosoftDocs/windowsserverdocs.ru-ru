---
title: Настройка реплики Hyper-V
ms.technology: compute-hyper-v
description: Инструкции для настройки реплики, тестирование отработки отказа и выполнив первой репликации.
ms.prod: windows-server-threshold
ms.service: na
manager: dongill
ms.topic: article
ms.assetid: eea9e996-bfec-4065-b70b-d8f66e7134ac
author: KBDAzure
ms.author: kathydav
ms.date: 10/10/2016
ms.openlocfilehash: 04066c5b645c0be641c2ba76fadac032d5a91420
ms.sourcegitcommit: 0d0b32c8986ba7db9536e0b8648d4ddf9b03e452
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2019
ms.locfileid: "59843215"
---
# <a name="set-up-hyper-v-replica"></a>Настройка реплики Hyper-V

>Область применения. Windows Server 2016

Реплика Hyper-V является неотъемлемой частью роли Hyper-V. Эта служба помогает реализовать стратегии аварийного восстановления путем репликации виртуальных машин с одного сервера узла Hyper-V в другой, чтобы поддерживать доступность рабочих нагрузок.  Реплика Hyper-V создает копию динамической виртуальной машины для автономной виртуальной машины реплики. Обратите внимание на следующее условия:  

-   **Узлы Hyper-V**: Первичный и вторичный серверы могут физически располагаться как рядом или в разных географических расположениях с помощью репликации через глобальную сеть ссылку. Узлы Hyper-V может быть автономным, кластеризованным, или сочетание обоих. Нет никакой зависимости Active Directory между серверами и им не нужно входить в домен.  

-   **Репликация и отслеживание изменений**: При включении реплики Hyper-V для конкретной виртуальной машины начальной репликации создается виртуальная машина идентичны реплики на сервере вторичного узла. После это произойдет, отслеживание изменений для реплики Hyper-V создает и обслуживает файл журнала, которая записывает изменения на виртуальной машине виртуального жесткого диска. Файл журнала воспроизводится в обратном порядке в реплике, виртуальный жесткий ДИСК на основании параметров частоты репликации. Это означает, что последние изменения сохраняются и реплицируются асинхронно. Репликация может быть через HTTP или HTTPS.  

-   **Расширенной репликации (цепочке)**: Это позволяет производить репликацию виртуальной машины из основного узла на вторичный узел, и затем повторить репликацию вторичного узла для размещения в третьем. Обратите внимание на то, что нельзя реплицировать из основного узла непосредственно на второй и третий.  

    Этот компонент реплики Hyper-V делает более надежным, для аварийного восстановления, так как в случае сбоя службы можно восстановить из основной и расширенной реплики.  Можно выполнить отработку отказа на реплику расширенной репликации Если вашего основного и дополнительного расположений вышли из строя. Обратите внимание, что реплику расширенной репликации не поддерживает согласованное репликации необходимо использовать же виртуальные жесткие диски, которые использует вторичную реплику.  

-   **Отработка отказа**: При возникновении сбоя в основном (или базу данных-получателя в случае расширенных) расположение, можно вручную запустить тестирование, запланированную или незапланированную отработку отказа.  

    ||Тестирование|Запланировано|Незапланированные ситуации|  
    |-|--------|-----------|-------------|  
    |Когда следует запускать?|Убедитесь, что виртуальную машину можно выполнить отработку отказа и запустить на вторичном сайте<br /><br />Полезно для тестирования и обучения|Во время планового отключения и простоям|Во время непредвиденных событий|  
    |Создается ли дубликат виртуальной машины?|Да|Нет|Нет|  
    |Где он инициируется?|На виртуальной машине реплики|Инициируется на основной и завершается на дополнительной|На виртуальной машине реплики|  
    |Как часто следует запускать?|Мы рекомендуем использовать один раз в месяц для тестирования|Один раз каждые шесть месяцев или в соответствии с требованиями соответствия|Только в случае аварии, когда основная виртуальная машина недоступна|  
    |Продолжать репликации основной виртуальной машины?|Да|Да. После сбоя разрешить обратную репликацию реплицирует изменения обратно на основной сайт, чтобы синхронизировать первичный и вторичный.|Нет|  
    |Есть ли потери данных?|Нет|Нет. После отработки отказа реплики Hyper-V реплицирует последний набор отслеживаемых изменений обратно к первичной реплике, что полностью предотвращает потерю данных.|Зависит от событий и точек восстановления|  
    |Возникает ли простой?|Нет. Она не влияет на рабочую среду. Во время отработки отказа создается тестовый дубликат виртуальной машины. После завершения отработки отказа выбран **отработки отказа** на реплике виртуальной машины и он автоматически очищена и удалены.|Продолжительность Плановый простой|Продолжительность сбоя|  

-   **Точки восстановления**: При настройке параметров репликации для виртуальной машины, указываются точек восстановления, которое вы хотите сохранить от него. Точки восстановления представляют моментального снимка во времени, из которого можно восстановить виртуальную машину. Очевидно, что меньше данные будут потеряны при восстановлении из самую последнюю точку восстановления. Вы можете получить доступ к точки восстановления до 24 часов назад.  

## <a name="deployment-prerequisites"></a>Необходимые условия для развертывания  
Вот что следует проверить перед началом работы:  

-   **Выяснить, какие виртуальные жесткие диски нужно реплицировать**. В частности виртуальные жесткие диски, содержащие данные, которые быстро изменяется и не используется сервером-репликой после перехода на другой ресурс, например диски с файлами подкачки, следует исключить из репликации для экономии пропускной способности сети. Следует обратить внимание, из которых можно исключить виртуальные жесткие диски.  

-   **Решите, как часто необходимо провести синхронизацию данных**:  Данные на сервере-реплике синхронизированы обновленные в соответствии с частотой репликации по настройке (30 секунд, 5 минут или 15 минут). Выбранной частоты необходимо учитывать следующее: Виртуальные машины управлением критически важные данные с Коротким? Что такое вам рекомендации относительно пропускной способности  Весьма критически виртуальных машин, очевидно, что потребуется чаще репликации.  

-   **Решить, как восстановить данные**:  По умолчанию реплики Hyper-V хранит только одно восстановление точки, на которое будет последней репликации, отправленных с сервера-источника на сервер-получатель. Однако если требуется возможность восстановления данных до предшествующей точки во времени можно указать хранение дополнительных точек восстановления (для максимум 24 почасовых точек). Если требуется дополнительных точек восстановления следует отметить, что это требует больше издержек на ресурсов обработки и хранения.  

-   **Выяснить, какие рабочие нагрузки, репликация будет выполняться**: Стандартная репликация реплики Hyper-V обеспечивает целостность состояния операционной системы виртуальной машины после отработки отказа, но не состояние приложений, что выполнение на виртуальной машине. Если вы хотите иметь возможность восстановления, который указывает состояние рабочей нагрузки, можно создать восстановления с согласованием приложений. Обратите внимание, что восстановления с согласованием приложений недоступен на сайте реплики расширенной репликации при использовании расширенной репликации (цепочке).  

-   **Выбор способа выполнить начальную репликацию данных виртуальных машин**: Репликация начинается путем переноса необходимо передать текущее состояние виртуальных машин. Это можно сделать сразу же или через указанное вами время посредством существующей сети. Можно также использовать существующие восстановленной виртуальной машины (например, если была восстановлена более ранняя резервная копия виртуальной машины на сервере-реплике) качестве начальной копии. Чтобы сэкономить пропускную способность сети, можно записать первоначальную копию на внешний носитель, а потом физически перенести его на объект с репликой.  Если вы хотите использовать существующую виртуальную машину удалите все старые снимки состояния, связанные с ней.  

## <a name="deployment-steps"></a>Шаги развертывания  

### <a name="step-1-set-up-the-hyper-v-hosts"></a>Шаг 1. Настройка узлов Hyper-V  
Вам потребуется по крайней мере двух узлов Hyper-V с одного или нескольких виртуальных машин на каждом сервере. [Начало работы с Hyper-V](../get-started/Get-started-with-Hyper-V-on-Windows.md). Сервера узла, который будет происходить репликация виртуальных машин необходимо настроить как сервер-реплику.  

1.  В параметрах Hyper-V на сервере будет реплицировать виртуальные машины в, в **конфигурация репликации**выберите **использовать этот компьютер как сервер-реплику**.  

2.  Вы можете реплицировать по протоколу HTTP или HTTPS, зашифрованные. Выберите **использовать Kerberos (HTTP)** или **использовать проверку подлинности на основе сертификатов (HTTPS**). По умолчанию 80 для HTTP и HTTPS-порт 443 включены как исключения брандмауэра на сервере-реплике Hyper-V. Если вы измените параметры порта по умолчанию, вам потребуется также изменить исключение брандмауэра. При репликации по протоколу HTTPS, вам нужно будет выбрать сертификат, и необходимо настроить проверку подлинности сертификата.  

3.  Для авторизации, выберите **разрешить репликацию из любого прошедшего проверку подлинности сервера** позволяет серверу реплики для приема трафика репликации виртуальной машины из любого сервера-источника, успешно проходит проверку подлинности. Выберите **разрешается репликация с указанным серверам** принимать трафик только от серверов-источников можно отдельно выбрать.  

    Для обоих вариантов можно указать, где должно храниться реплицированные виртуальные жесткие диски на сервере-реплике Hyper-V.  

4.  Нажмите кнопку **OK** или **Применить**.  

### <a name="step-2-set-up-the-firewall"></a>Шаг 2. Настройка брандмауэра  
Чтобы разрешить репликацию между основным и дополнительным серверами, трафика необходимо получить через брандмауэр Windows (или других межсетевых экранов сторонних). Если вы установили роль Hyper-V на серверах с исключений по умолчанию для HTTP (80) и создаются HTTPS (443). Если вы используете эти стандартные порты, необходимо просто включить правила:  

-  Чтобы включить правила на отдельном сервере узла:  

    1. Откройте брандмауэр Windows в режиме повышенной безопасности и нажмите кнопку **правила для входящих подключений**.  

    2. Чтобы включить проверку подлинности HTTP (Kerberos), щелкните правой кнопкой мыши **прослушиватель HTTP реплики Hyper-V (TCP-In)** >**включить правило.** Чтобы включить проверку подлинности на основе сертификата для HTTPS, щелкните правой кнопкой мыши **прослушиватель HTTPS реплики Hyper-V (TCP-In)** > E**ключить правило**.  

-  Чтобы включить правила в кластере Hyper-V, откройте сеанс Windows PowerShell с помощью **Запуск от имени администратора**, выполните одну из следующих команд:  

    -   Для HTTP:  `get-clusternode | ForEach-Object  {Invoke-command -computername $_.name -scriptblock {Enable-Netfirewallrule -displayname "Hyper-V Replica HTTP Listener (TCP-In)"}}`  

    -   Для использования протокола HTTPS: `get-clusternode | ForEach-Object  {Invoke-command -computername $_.name -scriptblock {Enable-Netfirewallrule -displayname "Hyper-V Replica HTTPS Listener (TCP-In)"}}`  

### <a name="enable-virtual-machine-replication"></a>Включение репликации виртуальных машин  
Выполните следующие действия на каждой виртуальной машине, которую требуется реплицировать.  

1.  В **сведения** панели диспетчера Hyper-V выберите виртуальную машину, щелкнув его.  
    Щелкните правой кнопкой мыши выбранную виртуальную машину и нажмите кнопку **включения репликации** чтобы открыть мастер включения репликации.  

2.  На странице **Прежде чем приступить к работе** нажмите кнопку **Далее**.  

3.  На **укажите сервер-реплику** странице в поле сервера-реплики введите NetBIOS или полное ДОМЕННОЕ имя сервера-реплики. Если сервер-реплика входит в отказоустойчивый кластер, введите имя брокера реплики Hyper-V. Нажмите кнопку **Далее**.  

4.  На **Настройка параметров подключения** страницу, реплика Hyper-V автоматически извлекает параметры проверки подлинности и порт, настроенный для сервера-реплики. Если значения не получены, проверьте, что сервер настроен как сервер-реплику, и что он зарегистрирован в DNS. Если требуемый тип в параметре вручную.  

5.  На **выбор виртуальных жестких дисков репликации** странице, убедитесь, что выбраны виртуальные жесткие диски, которые требуется реплицировать и снимите флажки для всех виртуальных жестких дисков, которые требуется исключить из репликации. Затем нажмите кнопку **Далее**.  

6.  На **Настройка частоты репликации** , определите, как часто изменения должны быть синхронизированы с основного на дополнительный. Затем нажмите кнопку **Далее**.  

7.  На **Настройка дополнительных точек восстановления** странице, выберите, чтобы поддерживать только последняя точка восстановления или создать дополнительные точки.    Если необходимо последовательно восстановить приложений и рабочих нагрузок, которые имеют свои собственные модули записи VSS, мы рекомендуем выбрать **frequenc службы теневого копирования томов (VSS)** y и укажите частоту создания моментальных снимков с согласованием приложений. Обратите внимание, что на основной и дополнительный серверы Hyper-V должна запущена служба запрашивающей стороне VMM Hyper-V. Затем нажмите кнопку **Далее**.  

8.  На **Выбор начальной репликации** выберите способ начальной репликации для использования.  По умолчанию для отправки начальной копии по сети будет копировать файл конфигурации основной виртуальной машины (VMCX) и файлы виртуального жесткого диска (vhdx-файлы и виртуальный жесткий ДИСК), вы выбрали через сетевое подключение. Проверьте доступность пропускной способности сети, если вы собираетесь использовать этот параметр. Если основной виртуальной машины уже настроена на вторичном сайте, как реплицировать виртуальные машины его можно использовать для выбора **использовать существующую виртуальную машину на сервере репликации в качестве начальной копии**. Можно использовать Hyper-V экспорта для экспорта на основную виртуальную машину и импортировать его в качестве виртуальной машины реплики на сервере-получателе. Для крупных виртуальных машин или ограниченной пропускной способностью его вы можете выбрать для начальной репликации по сети происходят на более позднее время, а затем настройте часы наименьшей нагрузки или отправить данные начальной репликации в качестве автономного носителя.  

    При выполнении репликации в автономном режиме будет транспорта начальной копии на сервере-получателе, используя внешний носитель например жесткого диска или USB-накопитель. Для этого вам потребуется подключение внешнего хранилища сервера-источника (или узел-владелец в кластере), а затем выбрав отправить исходную копию с помощью внешних носителей, можно указать расположение, локально или на на внешнем носителе, где могут храниться начальной копии.  Заполнитель виртуальной машины создается на сайте реплики. После завершения начальной репликации внешнего хранилища могут быть отправлены на узел реплики. Существует внешних носителей необходимо подключить к серверу-получателю или узел-владелец вторичного кластера. Его можно импортировать исходной реплики в указанном расположении и объединить его в виртуальную машину заполнителя.  

9. На **завершение включения репликации** странице, просмотрите сведения в сводку и нажмите кнопку **Готово.**. Данные виртуальной машины будут передаваться в соответствии с выбранными настройками. Отобразится диалоговое окно, показывающее, что репликация успешно включена.  

10. Если вы хотите настроить расширенной репликации (цепочке), откройте сервера-реплики и щелкните правой кнопкой мыши виртуальную машину, которую требуется реплицировать. Нажмите кнопку **репликации** > **расширить репликацию** и укажите параметры репликации.  

## <a name="run-a-failover"></a>Запуск отработки отказа  
После выполнения этих действий развертывания в реплицируемой среде — приступить к работе. Теперь позволяет выполнять отработку отказа, при необходимости.  

**Тестовая отработка отказа**:  Если вы хотите выполнить щелчок правой кнопкой мыши тест отработки отказа основной виртуальной машины и выберите **репликации** > **тестовая отработка отказа**. Выбора точки восстановления последней или другие, если настроен. Новый тестовую виртуальную машину будет создана и запущена на вторичном сайте. После завершения тестирования, выберите **остановить тестовую отработку отказа** на реплике виртуальной машины, чтобы очистить ее. Обратите внимание на то, что для виртуальной машины, которые можно выполнять только один тестовая отработка отказа одновременно. [Дополнительные сведения](https://blogs.technet.com/b/virtualization/archive/2012/07/26/types-of-failover-operations-in-hyper-v-replica.aspx).  

**Плановая отработка отказа**: Чтобы выполнить плановую отработку отказа, щелкните правой кнопкой мыши основной виртуальной машины и **репликации** > **Плановая отработка отказа**. Плановая отработка отказа выполняет проверок необходимых компонентов, что полностью предотвращает потерю данных. Он проверяет, что основной виртуальной машины была завершена перед началом отработки отказа. После отработки отказа виртуальной машины, он запускает репликации изменений обратно к первичному сайту, когда она станет доступна. Обратите внимание на то, что для правильной работы основной сервер должен быть настроен получаемых репликации с сервера-получателя или из брокера реплики Hyper-V в случае основного кластера. Плановая отработка отказа отправляет последний набор исправлений. [Дополнительные сведения](https://blogs.technet.com/b/virtualization/archive/2012/07/31/types-of-failover-operations-in-hyper-v-replica-part-ii-planned-failover.aspx).  

**Внеплановая отработка отказа**: Чтобы запустить незапланированную отработку отказа, щелкните правой кнопкой мыши на реплике виртуальной машины и выберите **репликации** > **внеплановой отработки отказа** из диспетчера Hyper-V или диспетчер кластеров отработки отказа. Если этот параметр включен, можно восстановить из последней точки восстановления или из предыдущей точки восстановления. После отработки отказа, проверьте, что все работает правильно, на которой выполнена через виртуальную машину, затем нажмите кнопку **завершить** на виртуальной машине реплики. [Дополнительные сведения](https://blogs.technet.com/b/virtualization/archive/2012/08/08/types-of-failover-operations-in-hyper-v-replica-part-iii-unplanned-failover.aspx).  
