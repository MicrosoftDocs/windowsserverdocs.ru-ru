---
title: Настройка узлов для динамической миграции без отказоустойчивой кластеризации
description: Содержит инструкции по настройке динамической миграции в некластеризованной среде.
manager: dongill
ms.topic: article
ms.assetid: b5e3c405-cb76-4ff2-8042-c2284448c435
author: kbdazure
ms.author: kathydav
ms.date: 9/30/2016
ms.openlocfilehash: e07910b6f822ca29769fb398434f83272867dbe7
ms.sourcegitcommit: 68444968565667f86ee0586ed4c43da4ab24aaed
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/07/2020
ms.locfileid: "87992707"
---
# <a name="set-up-hosts-for-live-migration-without-failover-clustering"></a>Настройка узлов для динамической миграции без отказоустойчивой кластеризации

>Область применения. Windows Server 2016, Microsoft Hyper-V Server 2016, Windows Server 2019, Microsoft Hyper-V Server 2019.

В этой статье показано, как настроить узлы, которые не являются кластеризованными, чтобы можно было выполнять динамическую миграцию между ними. Используйте эти инструкции, если вы не настроили динамическую миграцию при установке Hyper-V или хотите изменить параметры. Для настройки кластерных узлов используйте средства для отказоустойчивой кластеризации.

## <a name="requirements-for-setting-up-live-migration"></a>Требования к настройке динамической миграции

Чтобы настроить некластеризованные узлы для динамической миграции, вам потребуется:

-  Учетная запись пользователя с разрешением на выполнение различных действий. Членство в локальной группе администраторов Hyper-V или группе Администраторы на исходном и конечном компьютерах соответствует этому требованию, если не настроено ограниченное делегирование. Для настройки ограниченного делегирования требуется членство в группе "Администраторы домена".

- Роль Hyper-V в Windows Server 2016 или Windows Server 2012 R2, установленная на исходном и целевом серверах. Вы можете выполнить динамическую миграцию между узлами под управлением Windows Server 2016 и Windows Server 2012 R2, если виртуальная машина имеет версию не ниже 5. <br>Инструкции по обновлению версий см. [в статье обновление версии виртуальной машины в Hyper-V в Windows 10 или Windows Server 2016](Upgrade-virtual-machine-version-in-Hyper-V-on-Windows-or-Windows-Server.md). Инструкции по установке см. в статье [Установка роли Hyper-V в Windows Server](../get-started/Install-the-Hyper-V-role-on-Windows-Server.md).

- Исходный и конечный компьютеры, которые принадлежат к одному домену Active Directory или принадлежат к доменам, которые доверяют друг другу.
- Средства управления Hyper-V, установленные на компьютере под управлением Windows Server 2016 или Windows 10, если эти средства не установлены на исходном или целевом сервере, а средства запускаются с сервера.

## <a name="consider-options-for-authentication-and-networking"></a>Рассмотрите варианты проверки подлинности и сети

Рассмотрим, как вы хотите настроить следующие настройки:

-  **Проверка подлинности**: какой протокол будет использоваться для проверки подлинности трафика динамической миграции между исходным и целевым серверами? Выбор определяет, потребуется ли вход на исходный сервер перед началом динамической миграции:
   - Kerberos позволяет избежать входа на сервер, но требует настройки ограниченного делегирования. Инструкции см. ниже.
   - CredSSP позволяет избежать настройки ограниченного делегирования, но требует входа на исходный сервер. Это можно сделать с помощью сеанса локальной консоли, удаленный рабочий стол сеанса или удаленного сеанса Windows PowerShell.

      Кредспп требует входа в систему для ситуаций, которые могут быть не очевидны. Например, если вы входите в TestServer01 для перемещения виртуальной машины в TestServer02, а затем хотите переместить виртуальную машину обратно в TestServer01, вам потребуется войти в TestServer02, прежде чем пытаться переместить виртуальную машину обратно в TestServer01. Если этого не сделать, попытка проверки подлинности завершится неудачей, произойдет ошибка и отобразится следующее сообщение:

      "Сбой операции миграции виртуальной машины в источнике миграции.
      Не удалось установить соединение с именем главного *компьютера*: нет доступных учетных данных в пакете безопасности 0x8009030E.

-   **Производительность**: имеет ли смысл настроить параметры производительности? Эти параметры могут сократить нагрузку на сеть и ЦП, а также ускорить выполнение динамической миграции. Рассмотрите требования и инфраструктуру и протестируйте различные конфигурации, которые помогут вам принять решение. Параметры описаны в конце шага 2.

-  **Настройка сети**: разрешить передачу трафика динамической миграции через любую доступную сеть или изолировать трафик к определенным сетям? В качестве рекомендации по безопасности мы советуем вам ограничить прохождение трафика доверенными частными сетями, потому что трафик динамической миграции не шифруется при отправке по сети. Для обеспечения сетевой изоляции можно воспользоваться физически изолированной сетью или другой доверенной сетевой технологией, например VLAN.

## <a name="step-1-configure-constrained-delegation-optional"></a><a name="BKMK_Step1"></a>Шаг 1. Настройка ограниченного делегирования (необязательно)
Если вы решили использовать Kerberos для проверки подлинности динамического переноса трафика, Настройте ограниченное делегирование, используя учетную запись, которая является членом группы "Администраторы домена".

### <a name="use-the-users-and-computers-snap-in-to-configure-constrained-delegation"></a>Использование оснастки "пользователи и компьютеры" для настройки ограниченного делегирования

1.  Откройте оснастку "Active Directory - пользователи и компьютеры". (Из диспетчер сервера выберите сервер, если он не выбран, щелкните Сервис. **Tools**  >>  **Active Directory пользователей и компьютеров**).

2.  В области навигации в **Active Directory пользователи и компьютеры**выберите домен и дважды щелкните папку **Компьютеры** .

3.  В папке **Computers** щелкните правой кнопкой мыши учетную запись компьютера исходного сервера и выберите пункт **свойства**.

4.  В окне **Свойства**перейдите на вкладку **Делегирование** .

5.  На вкладке Делегирование выберите параметр **доверять компьютеру делегирование указанных служб** , а затем выберите **использовать любой протокол проверки подлинности**.

6.  Нажмите кнопку **Добавить**.

7.  В меню **Добавление служб**выберите пункт **Пользователи или компьютеры**.

8.  В окне **Выбор пользователей или компьютеров**введите имя целевого сервера. Щелкните **Проверить имена** , чтобы проверить их, а затем нажмите кнопку **ОК**.

9. В окне **Добавление служб**в списке доступных служб выполните следующие действия и нажмите кнопку **ОК**.

    -   Для перемещения хранилищ виртуальной машины выберите **cifs**. Это необходимо, если требуется переместить хранилище вместе с виртуальной машиной, а также, если требуется переместить только хранилище виртуальной машины. Если сервер настроен для использования хранилища SMB для Hyper-V, этот параметр уже должен быть выбран.

    -   Для перемещения виртуальных машин выберите **Службу миграции виртуальной системы Майкрософт**.

10. На вкладке **Делегирование** диалогового окна "Свойства" убедитесь, что службы, выбранные на предыдущем шаге, указаны как службы, которым конечный компьютер может представлять делегированные учетные данные. Нажмите кнопку **ОК**.

11. В папке **Компьютеры** выберите учетную запись компьютера конечного сервера и повторите процесс. Убедитесь, что в диалоговом окне **Выбор пользователей или компьютеров** указано имя исходного сервера.

Изменения конфигурации вступят в силу после выполнения обоих следующих действий.

  -  Изменения реплицируются на контроллеры домена, в которые вошли серверы, на которых выполняется Hyper-V.
  -  Контроллер домена выдает новый билет Kerberos.

## <a name="step-2-set-up-the-source-and-destination-computers-for-live-migration"></a><a name="BKMK_Step2"></a>Шаг 2. Настройка исходного и конечного компьютеров для динамической миграции
Этот шаг включает в себя выбор параметров проверки подлинности и сети. По соображениям безопасности рекомендуется выбирать конкретные сети для трафика динамической миграции, как описано выше. На этом шаге также показано, как выбрать параметр производительность.

### <a name="use-hyper-v-manager-to-set-up-the-source-and-destination-computers-for-live-migration"></a>Использование диспетчера Hyper-V для настройки исходного и конечного компьютеров для динамической миграции

1.  Откройте диспетчер Hyper-V. (В диспетчер сервера щелкните **инструменты**  >> . **Диспетчер Hyper-V**.)

2.  В области навигации выберите один из серверов. (Если он отсутствует в списке, щелкните правой кнопкой мыши **Диспетчер Hyper-V**, выберите пункт **Подключение к серверу**, введите имя сервера и нажмите кнопку **ОК**. Повторите, чтобы добавить другие серверы.)

3.  В области **действие** щелкните **Параметры Hyper-V**  >> **Динамическая миграция**.

4.  На панели **Динамические миграции** проверьте, включен ли параметр **Разрешить входящие и исходящие динамические миграции**.

5.  В разделе **одновременная динамическая миграция**укажите другое значение, если вы не хотите использовать значение по умолчанию 2.

6.  Для параметра **Входящие динамические миграции**, если вы хотите использовать определенные сетевые соединения для принятия трафика динамической миграции, выберите **Добавить**, чтобы ввести информацию об IP-адресе. В обратном случае щелкните **Использовать любую доступную сеть для динамической миграции**. Нажмите кнопку **ОК**.

7.  Чтобы выбрать параметры Kerberos и производительности, разверните **динамический перенос** и выберите **Дополнительные функции**.

    - Если вы настроили ограниченное делегирование, в разделе **протокол проверки подлинности**выберите **Kerberos**.
    - В разделе **Параметры производительности**проверьте сведения и выберите другой вариант, если он подходит для вашей среды.

8. Нажмите кнопку **ОК**.

9. Выберите другой сервер в диспетчере Hyper-V и повторите эти действия.

### <a name="use-windows-powershell-to-set-up-the-source-and-destination-computers-for-live-migration"></a>Настройка исходного и конечного компьютеров для динамической миграции с помощью Windows PowerShell

Для настройки динамической миграции на некластеризованные узлы доступны три командлета: [Enable-вммигратион](/powershell/module/hyper-v/enable-vmmigration?view=win10-ps), [Set-вммигратионнетворк](/powershell/module/hyper-v/set-vmmigrationnetwork?view=win10-ps)и [Set-vmhost](/powershell/module/hyper-v/set-vmhost?view=win10-ps). В этом примере используются все три и выполняется следующее:
  - Настройка динамической миграции на локальном узле
  - Разрешает входящий трафик миграции только в определенной сети
  - Выбирает Kerberos в качестве протокола проверки подлинности

Каждая строка представляет собой отдельную команду.

```PowerShell
PS C:\> Enable-VMMigration

PS C:\> Set-VMMigrationNetwork 192.168.10.1

PS C:\> Set-VMHost -VirtualMachineMigrationAuthenticationType Kerberos
```

Set-VMHost также позволяет выбрать параметр производительности (и многие другие параметры узла). Например, чтобы выбрать SMB, но оставить для протокола проверки подлинности значение по умолчанию CredSSP, введите:

```PowerShell
PS C:\> Set-VMHost -VirtualMachineMigrationPerformanceOption SMB
```

В этой таблице описано, как работают параметры производительности.

|Параметр|Описание|
|----------|---------------|
    |TCP/IP|Копирует память виртуальной машины на целевой сервер через подключение TCP/IP.|
    |Сжатие|Сжимает содержимое памяти виртуальной машины перед копированием его на целевой сервер через подключение TCP/IP. **Примечание.** Это значение **по умолчанию** .|
    |SMB|Копирует память виртуальной машины на целевой сервер через подключение SMB 3,0.<p>— SMB Direct используется, когда сетевые адаптеры на исходном и целевом серверах имеют включенные возможности удаленного доступа к памяти (RDMA).<br />— Многоканальный SMB автоматически обнаруживает и использует несколько подключений, если определена правильная конфигурация многоканального SMB.<p>Дополнительные сведения см. в статье [Увеличение производительности файлового сервера с помощью SMB Direct](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/jj134210(v=ws.11)).|

 ## <a name="next-steps"></a>Дальнейшие действия

 После настройки узлов вы можете выполнить динамическую миграцию. Инструкции см. [в статье Использование динамической миграции без отказоустойчивой кластеризации для перемещения виртуальной машины](../manage/Use-live-migration-without-Failover-Clustering-to-move-a-virtual-machine.md).