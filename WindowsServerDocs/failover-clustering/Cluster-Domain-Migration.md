---
title: Миграция междоменного кластера в Windows Server 2016/2019
description: В этой статье описывается перемещение кластера Windows Server 2019 из одного домена в другой.
ms.prod: windows-server
manager: eldenc
ms.technology: failover-clustering
ms.topic: article
author: johnmarlin-msft
ms.author: johnmar
ms.date: 01/18/2019
ms.localizationpriority: medium
ms.openlocfilehash: ba556b5a00f3932e2049135b177a7ad8bbceec9c
ms.sourcegitcommit: b00d7c8968c4adc8f699dbee694afe6ed36bc9de
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/08/2020
ms.locfileid: "80828297"
---
# <a name="failover-cluster-domain-migration"></a>Миграция домена отказоустойчивого кластера

> Область применения: Windows Server 2019, Windows Server 2016

В этом разделе приводятся общие сведения о перемещении отказоустойчивых кластеров Windows Server из одного домена в другой.

## <a name="why-migrate-between-domains"></a>Зачем выполнять миграцию между доменами

Существует несколько сценариев, в которых требуется перенести кластер с одного доамин на другой.

- Компания a объединяется с компаниб и должна перемещать все кластеры в домен Company.
- Кластеры создаются в основном центре обработки данных и отправляются в удаленные расположения.
- Кластер был создан как кластер Рабочей группы и теперь должен быть частью домена
- Кластер был создан как кластер домена и теперь должен входить в рабочую группу
- Кластер перемещается в одну область компании в другую и является другим поддоменом

Корпорация Майкрософт не предоставляет поддержку администраторам, пытающимся переместить ресурсы из одного домена в другой, если базовая операция приложения не поддерживается. Например, корпорация Майкрософт не предоставляет поддержку администраторам, пытающимся переместить сервер Microsoft Exchange Server из одного домена в другой.

   > [!WARNING]
   > Перед перемещением кластера рекомендуется выполнить полное резервное копирование всего общего хранилища в кластере.

## <a name="windows-server-2016-and-earlier"></a>Windows Server 2016 и более ранние версии

В Windows Server 2016 и более ранних версиях служба кластеров не было возможности переходить от одного домена к другому.  Это было вызвано повышенной зависимостью от домен Active Directory служб и созданных виртуальных имен.   

## <a name="options"></a>Параметры

Для такого перемещения существует два варианта.

Первый вариант включает уничтожение кластера и его перестроение в новом домене.

![Уничтожить и перестроить](media/Cross-Domain-Cluster-Migration/Cross-Cluster-Domain-Migration-1.gif)

Как видно в анимации, этот параметр разрушается с помощью следующих шагов:

1. Уничтожение кластера.
2. Измените членство узлов в домене на новый домен.
3. Создайте кластер заново как новый в обновленном домене.  Это влечет за собой необходимость повторного создания всех ресурсов.

Второй вариант является менее разрушительным, но требует, чтобы в новом домене было создано дополнительное оборудование, как новый кластер.  Когда кластер будет находиться в новом домене, запустите мастер миграции кластера, чтобы перенести ресурсы. Обратите внимание, что это не приводит к переносу данных. для переноса данных необходимо использовать другое средство, например [службу миграции хранилища](../storage/storage-migration-service/overview.md)(после добавления поддержки кластера).

![Сборка и миграция](media/Cross-Domain-Cluster-Migration/Cross-Cluster-Domain-Migration-2.gif)

Как видно в анимации, этот параметр не разрушается, но требует либо другого оборудования, либо узла из существующего кластера, чем он был удален.

1. Создайте новый кластер в новом домене, сохраняя доступ к старому кластеру.
2. Используйте [Мастер миграции кластера](https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/cc754481(v=ws.10)) для переноса всех ресурсов в новый кластер. Напоминание, это не приводит к копированию данных, поэтому необходимо выполнить отдельно.
3. Списание или уничтожение старого кластера.

В обоих вариантах в новом кластере должны быть установлены все [приложения, поддерживающие кластер](https://technet.microsoft.com/aa369082(v=vs.90)) , все драйверы и, возможно, тестирование, чтобы убедиться, что все будет работать правильно.  Этот процесс занимает много времени, если необходимо также переместить данные.

## <a name="windows-server-2019"></a>Windows Server 2019

В Windows Server 2019 мы предоставили возможности межкластерного переноса доменов.  Итак, приведенные выше сценарии можно легко выполнить, и необходимость в перестроении больше не требуется.  

Перемещение кластера из одного домена выполняется прямо вперед. Для этого существует два новых командлетыов PowerShell.

**New-клустернамеаккаунт** — создает учетную запись имени кластера в Active Directory **Remove-Клустернамеаккаунт** — удаляет учетные записи имени кластера из Active Directory

Этот процесс заключается в том, чтобы изменить кластер из одного домена на рабочую группу и обратно в новый домен.  Необходимость уничтожения кластера, перестроения кластера, установки приложений и т. д. не обязательно. Например, он будет выглядеть следующим образом:

![Перенос](media/Cross-Domain-Cluster-Migration/Cross-Cluster-Domain-Migration-3.gif)

## <a name="migrating-a-cluster-to-a-new-domain"></a>Миграция кластера в новый домен

На следующих шагах выполняется перемещение кластера из домена Contoso.com в новый домен Fabrikam.com.  Имя кластера — *клусклус* и роль файлового сервера под названием *FS-клусклус*.

1. Создайте учетную запись локального администратора с тем же именем и паролем на всех серверах в кластере.  Это может потребоваться для входа в систему, пока серверы перемещаются между доменами.
2. Войдите на первый сервер с учетной записью пользователя домена или администратора, имеющего Active Directory разрешений на объект имени кластера (CNO), объекты виртуальных компьютеров (VCO), имеет доступ к кластеру и откройте PowerShell.
3. Убедитесь, что все ресурсы сетевых имен кластера находятся в автономном состоянии, и выполните приведенную ниже команду.  Эта команда удаляет Active Directory объекты, которые могут быть у кластера.

   ```PowerShell
   Remove-ClusterNameAccount -Cluster CLUSCLUS -DeleteComputerObjects
   ```
4. Используйте Active Directory пользователи и компьютеры, чтобы убедиться, что объекты компьютеров CNO и VCO, связанные со всеми кластеризованными именами, удалены.

   > [!NOTE]
   > Рекомендуется отключить служба кластеров на всех серверах в кластере и задать для параметра Тип запуска службы значение вручную, чтобы служба кластеров не запускался при перезапуске серверов во время смены доменов.

   ```PowerShell
   Stop-Service -Name ClusSvc

   Set-Service -Name ClusSvc -StartupType Manual
   ```

5. Измените принадлежность домена серверов к Рабочей группе, перезапустите серверы, присоедините серверы к новому домену и перезапустите.
6. Когда серверы будут находиться в новом домене, войдите на сервер с учетной записью пользователя домена или администратора, имеющего Active Directory разрешения на создание объектов, доступ к кластеру и откройте PowerShell. Запустите службу кластеров и снова установите для нее значение автоматически.

   ```PowerShell
   Start-Service -Name ClusSvc

   Set-Service -Name ClusSvc -StartupType Automatic
   ```
7. Подключите имя кластера и все остальные ресурсы сетевого имени кластера к подключенному состоянию.

   ```PowerShell
   Start-ClusterResource -Name "Cluster Name"

   Start-ClusterResource -Name FS-CLUSCLUS
   ```

8. Измените кластер, чтобы он был частью нового домена со связанными объектами Active Directory. Для этого выполните команду ниже, и ресурсы сетевого имени должны находиться в оперативном состоянии.  Эта команда будет воссоздавать объекты Name в Active Directory.

   ```PowerShell
   New-ClusterNameAccount -Name CLUSTERNAME -Domain NEWDOMAINNAME.com -UpgradeVCOs
   ```

    Примечание. Если у вас нет дополнительных групп с сетевыми именами (т. е. кластера Hyper-V с виртуальными машинами), параметр-Упградевкос не требуется.

9. Используйте Active Directory пользователи и компьютеры, чтобы проверить новый домен и убедиться, что связанные объекты компьютера созданы. Если они есть, перенесите остальные ресурсы в группы в оперативном режиме.

   ```PowerShell
   Start-ClusterGroup -Name "Cluster Group"

   Start-ClusterGroup -Name FS-CLUSCLUS
   ```

## <a name="known-issues"></a>Известные проблемы

Если вы используете новый компонент-свидетель USB, вы не сможете добавить кластер в новый домен.  Причина заключается в том, что тип следящего сервера файлового ресурса должен использовать Kerberos для проверки подлинности.  Перед добавлением кластера в домен измените следящий сервер на None.  По завершении повторно создайте сервер-свидетель USB.  Отобразится следующее сообщение об ошибке:

```
New-ClusternameAccount : Cluster name account cannot be created.  This cluster contains a file share witness with invalid permissions for a cluster of type AdministrativeAccesssPoint ActiveDirectoryAndDns. To proceed, delete the file share witness.  After this you can create the cluster name account and recreate the file share witness.  The new file share witness will be automatically created with valid permissions.
```

