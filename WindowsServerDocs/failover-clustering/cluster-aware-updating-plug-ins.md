---
ms.assetid: d44d4430-41e2-483a-9685-92610cdef32a
title: Как работают подключаемые модули обновления с поддержкой кластера
description: Как использовать подключаемые модули для координации обновлений при использовании кластерного обновления в Windows Server для установки обновлений в кластере.
ms.topic: article
ms.prod: windows-server
manager: lizross
ms.author: jgerend
author: JasonGerend
ms.date: 04/28/2017
ms.technology: storage-failover-clustering
ms.openlocfilehash: 21585ab376830f37ca6432849dd8e9b3773af9ab
ms.sourcegitcommit: 771db070a3a924c8265944e21bf9bd85350dd93c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/27/2020
ms.locfileid: "85473301"
---
# <a name="how-cluster-aware-updating-plug-ins-work"></a>Как работают подключаемые модули обновления с поддержкой кластера

> Применяется к: Windows Server 2019, Windows Server 2016, Windows Server 2012 R2, Windows Server 2012

[Кластерное обновление](cluster-aware-updating.md) (Cau) использует подключаемые модули для координации установки обновлений между узлами в отказоустойчивом кластере. В этом разделе содержатся сведения об использовании встроенных \- подключаемых модулей Cau \- или других подключаемых модулей \- , устанавливаемых для Cau.

## <a name="install-a-plug-in"></a><a name="BKMK_INSTALL"></a>Установка \- подключаемого модуля
Подключаемый модуль \- , отличный от подключаемых модулей по умолчанию \- , установленных вместе с Cau \( **Microsoft. Виндовсупдатеплугин** и **Microsoft. хотфиксплугин** , \) должен устанавливаться отдельно. Если CAU используется в режиме автоматического \- обновления, подключаемый модуль \- должен быть установлен на всех узлах кластера. Если в режиме удаленного обновления используется CAU \- , подключаемый модуль \- должен быть установлен на компьютере координатора удаленного обновления. Устанавливаемый подключаемый модуль \- может иметь дополнительные требования к установке на каждом узле.

Чтобы установить подключаемый модуль \- , следуйте инструкциям в \- подразделе издатель подключаемого модуля. Чтобы вручную зарегистрировать подключаемый модуль \- с помощью Cau, выполните командлет [Register-кауплугин](https://technet.microsoft.com/itpro/powershell/windows/cluster-aware-updating/register-cauplugin) на каждом компьютере, где установлен подключаемый модуль \- .

## <a name="specify-a-plug-in-and-plug-in-arguments"></a>Укажите аргументы подключаемого модуля \- и подключаемого модуля \-

### <a name="specify-a-cau-plug-in"></a>Укажите подключаемый модуль CAU \-

В пользовательском интерфейсе CAU Выберите подключаемый модуль \- из раскрывающегося \- списка доступных подключаемых модулей \- при использовании Cau для выполнения следующих действий.

-   применение обновлений к кластеру;

-   просмотр обновлений для кластера;

-   Настройка параметров автоматического \- обновления кластера

По умолчанию CAU выбирает подключаемый \- модуль **Microsoft. виндовсупдатеплугин**. Однако можно указать любой подключаемый модуль \- , установленный и зарегистрированный с помощью Cau.

> [!TIP]
> В пользовательском интерфейсе CAU можно указать только один подключаемый модуль \- для использования для предварительного просмотра или применения обновлений во время прогона обновления. С помощью командлетов CAU PowerShell можно указать один или несколько подключаемых модулей \- . Если необходимо установить несколько типов обновлений в кластере, то, как правило, более эффективно указывать несколько подключаемых модулей \- в одном прогоне обновления, а не использовать отдельный прогон обновления для каждого подключаемого модуля \- . Это позволяет, к примеру, уменьшить число перезагрузок узлов.

С помощью командлетов PowerShell для CAU, перечисленных в следующей таблице, можно указать один или несколько подключаемых модулей \- для прогона обновления или выполнить сканирование, передав параметр **– кауплугиннаме** . Можно указать несколько имен подключаемых модулей \- , разделяя их запятыми. При указании нескольких подключаемых модулей \- можно также контролировать, как подключаемые модули \- влияют друг на друга во время прогона обновления, указав параметры ** \- рунплугинссериалли**, ** \- стопонплугинфаилуре**и **– сепаратеребутс** . Для получения дополнительных сведений об использовании нескольких подключаемых модулей \- используйте ссылки, приведенные в документации по командлету, в следующей таблице.

|Командлет|Описание|
|----------|---------------|
|[Add-CauClusterRole](https://docs.microsoft.com/powershell/module/clusterawareupdating/add-cauclusterrole)|Добавляет кластерную роль CAU, которая предоставляет функции самостоятельного \- обновления в указанный кластер.|
|[Invoke-CauRun](https://docs.microsoft.com/powershell/module/clusterawareupdating/invoke-caurun)|Проверяет наличие обновлений для узлов кластера и устанавливает их посредством прогона обновления в указанном кластере.|
|[Invoke-CauScan](https://docs.microsoft.com/powershell/module/clusterawareupdating/invoke-causcan)|Проверяет наличие обновлений для узлов кластера и возвращает список начального набора обновлений, которые будут применены к каждому узлу указанного кластера.|
|[Set-CauClusterRole](https://docs.microsoft.com/powershell/module/clusterawareupdating/set-cauclusterrole)|Задает свойства конфигурации для кластерной роли CAU в указанном кластере.|

Если параметр подключаемого модуля CAU не указан с \- помощью этих командлетов, по умолчанию используется подключаемый \- модуль **Microsoft. виндовсупдатеплугин**.

### <a name="specify-cau-plug-in-arguments"></a>Укажите аргументы подключаемого модуля CAU \-
При настройке параметров прогона обновления можно указать одно или несколько аргументов пар " *имя \= значение* " \( \) для выбранного подключаемого модуля \- . Например, в пользовательском интерфейсе CAU можно указать несколько аргументов следующим образом.

**Name1 \= Значение1; Имя2 \= Значение2; Имя3 \= значение3**

Эти пары " *имя \= значение* " должны быть осмысленными для указанного подключаемого модуля \- . Для некоторых подключаемых модулей \- аргументы являются необязательными.

Синтаксис аргументов подключаемого модуля CAU \- соответствует следующим общим правилам.

-   Несколько пар " *имя \= значение* " разделяются точками с запятой.

-   Значение, содержащее пробелы, заключено в кавычки, например: **name1 \= "значение с пробелами"**.

-   Точный синтаксис *значения* зависит от подключаемого модуля \- .

Чтобы указать аргументы подключаемого модуля с \- помощью командлетов PowerShell для Cau, поддерживающих параметр **– кауплугинпараметерс** , передайте параметр формы:

**\-Кауплугинаргументс @ {name1 \= Значение1; Имя2 \= Значение2; Имя3 \= значение3}**

Можно также использовать предопределенную хэш-таблицу PowerShell. Чтобы указать аргументы подключаемого модуля \- для нескольких подключаемых модулей \- , передайте несколько хэш-таблиц аргументов, разделенных запятыми. Передайте аргументы подключаемого модуля \- в \- порядке подключения, указанном в **кауплугиннаме**.

### <a name="specify-optional-plug-in-arguments"></a>Укажите необязательные аргументы подключаемого модуля \-
Подключаемые модули \- , которые Cau устанавливает \( **Microsoft. виндовсупдатеплугин** и **Microsoft. хотфиксплугин** \) , предоставляют дополнительные параметры, которые можно выбрать. В пользовательском интерфейсе CAU они отображаются на странице **Дополнительные параметры** после настройки обновления параметров выполнения для подключаемого модуля \- . При использовании командлетов CAU PowerShell эти параметры настраиваются как необязательные аргументы подключаемого модуля \- . Подробнее см. в подразделах [Использование подключаемого модуля Microsoft.WindowsUpdatePlugin](#BKMK_WUP) и [Использование подключаемого модуля Microsoft.HotfixPlugin](#BKMK_HFP) далее в этом разделе.

## <a name="manage-plug-ins-using-windows-powershell-cmdlets"></a>Управление подключаемыми модулями \- с помощью командлетов Windows PowerShell

|Командлет|Описание|
|----------|---------------|
|[Get-CauPlugin](https://docs.microsoft.com/powershell/module/clusterawareupdating/get-cauplugin)|Извлекает сведения об одном или нескольких подключаемых модулях обновления программного обеспечения \- , зарегистрированных на локальном компьютере.|
|[Register-CauPlugin]((https://docs.microsoft.com/powershell/module/clusterawareupdating/register-cauplugin))|Регистрирует подключаемый модуль обновления программного обеспечения CAU \- на локальном компьютере.|
|[Unregister-CauPlugin](https://docs.microsoft.com/powershell/module/clusterawareupdating/unregister-cauplugin)|Удаляет подключаемый модуль обновления программного обеспечения \- из списка подключаемых модулей \- , которые могут использоваться в Cau. **Примечание.** \-Не удается отменить регистрацию подключаемых модулей, установленных с помощью Cau \( **Microsoft. виндовсупдатеплугин** и **Microsoft. хотфиксплугин** \) .|

## <a name="using-the-microsoftwindowsupdateplugin"></a><a name="BKMK_WUP"></a>Использование Microsoft. Виндовсупдатеплугин

Подключаемый модуль по умолчанию \- для Cau, **Microsoft. виндовсупдатеплугин**выполняет следующие действия:
- Связывается с агентом обновления Windows в каждом узле отказоустойчивого кластера, чтобы применить обновления, необходимые для продуктов Майкрософт, которые выполняются в каждом узле.
- Устанавливает обновления кластера непосредственно из Центр обновления Windows или Центр обновления Майкрософт или с \- локального \( сервера Windows Server Update Services WSUS \) .
- Устанавливает только выбранные, обновления GDR для выпуска общего распространения \( \) . По умолчанию подключаемый модуль \- применяет только важные обновления программного обеспечения. Настройка не требуется. Конфигурация по умолчанию загружает и устанавливает важные обновления GDR в каждом узле.

> [!NOTE]
> Для применения обновлений, отличных от важных обновлений программного обеспечения, выбранных по умолчанию \( , например обновлений драйверов \) , можно настроить дополнительный параметр подключаемого модуля \- . Подробнее см. в подразделе [Настройка строки запроса агента обновления Windows](#BKMK_QUERY).

### <a name="requirements"></a>Требования

- Компьютер с отказоустойчивым кластером и координатором удаленного обновления \( , если он используется, \) должен соответствовать требованиям для Cau и конфигурации, необходимой для удаленного управления, перечисленных в статье [требования и рекомендации для Cau](cluster-aware-updating-requirements.md).
- Изучите [рекомендации по применению обновлений Майкрософт](cluster-aware-updating-requirements.md#BKMK_BP_WUA), а затем внесите все необходимые изменения в конфигурацию Центра обновления Майкрософт для узлов отказоустойчивого кластера.
- Для получения наилучших результатов рекомендуется запустить CAU анализатор соответствия рекомендациям \( BPA, \) чтобы убедиться, что кластер и среда обновления настроены должным образом для применения обновлений с помощью Cau. Подробнее см. в подразделе [Проверка готовности к кластерному обновлению](cluster-aware-updating-requirements.md#BKMK_BPA).

> [!NOTE]
> Обновления, требующие принятия условий лицензии Майкрософт или иных действий со стороны пользователя, исключаются. Их необходимо установить вручную.

### <a name="additional-options"></a>Дополнительные параметры

При необходимости можно указать следующие аргументы подключаемого модуля, \- чтобы расширить или ограничить набор обновлений, применяемых подключаемым модулем \- .
- Чтобы настроить подключаемый модуль \- для применения рекомендуемых обновлений в дополнение к важным обновлениям на каждом узле, в пользовательском интерфейсе Cau на странице " **Дополнительные параметры** " установите флажок **предоставить Рекомендуемые обновления так же, как я получаю важные обновления** .
<br>Кроме того, можно настроить аргумент подключаемого модуля **"инклудерекоммендедупдатес" " \= true"** \- .
- Чтобы настроить подключаемый модуль \- для фильтрации типов обновлений GDR, применяемых к каждому узлу кластера, укажите строку запроса агента Центр обновления Windows с помощью аргумента подключения **QueryString** \- . Подробнее см. в подразделе [Настройка строки запроса агента обновления Windows](#BKMK_QUERY).

### <a name="configure-the-windows-update-agent-query-string"></a><a name="BKMK_QUERY"></a>Настройка строки запроса агента обновления Windows
Можно настроить аргумент подключаемого модуля \- для подключаемого модуля по умолчанию \- ( **Microsoft. виндовсупдатеплугин**), состоящего из \( строки запроса WUA агента Центр обновления Windows \) . В этой инструкции используется API WUA для определения одной или нескольких групп обновлений Майкрософт, которые должны быть применены к каждому узлу, на основе критериев выбора. Вы можете объединить несколько критериев с помощью логического И или логического ИЛИ. Строка запроса WUA задается в аргументе подключаемого модуля \- следующим образом:

**QueryString \= "Criterion1 \= value1 и \/ Criterion2 \= value2 и \/ или..."**

Например, подключаемый модуль **Microsoft.WindowsUpdatePlugin** автоматически выбирает важные обновления с помощью аргумента **QueryString** по умолчанию, который составляется с помощью критериев **IsInstalled**, **Type**, **IsHidden** и **IsAssigned**.

**Строка запроса \= "устанавливаются \= 0 и \= " программное обеспечение ", а затем значения" по "и" a Hidden \= 0 \= "**

Если указать аргумент **QueryString** , он будет использоваться вместо **строки запроса** по умолчанию, настроенной для подключаемого модуля \- .

#### <a name="example-1"></a>Пример 1

Настройка аргумента **QueryString** , устанавливающего определенное обновление, ОПРЕДЕЛЯЕМое идентификатором *f6ce46c1 \- 971c \- 43f9 \- a2aa \- 783df125f003*:

**QueryString \= "UpdateID \= " f6ce46c1 \- 971c \- 43f9 \- A2aa \- 783df125f003 "и" установлено \= 0 "**

> [!NOTE]
> Предыдущий пример является допустимым для применения обновлений с помощью \- мастера обновления с поддержкой кластера. Если вы хотите установить конкретное обновление, настроив параметры самостоятельного \- обновления с помощью пользовательского интерфейса Cau или командлета **Add \- кауклустерроле** или **Set \- кауклустерроле**PowerShell, необходимо отформатировать значение UpdateID с помощью двух \- символов одинарной кавычки:
>
> **QueryString \= "UpdateID \= " "f6ce46c1 \- 971c \- 43f9 \- A2aa \- 783df125f003" "и установлен \= 0"**

#### <a name="example-2"></a>Пример 2

Чтобы настроить аргумент **QueryString**, устанавливающий только драйверы, укажите следующую строку.

**Строка запроса \= "устанавливаются \= 0 и Type \= " Driver "и" Hidden \= 0 "**

Дополнительные сведения о строках запросов для подключаемого модуля по умолчанию \- , **Microsoft. виндовсупдатеплугин**, условий поиска, \( таких как Default **IsInstalled** \) , и синтаксиса, который можно включить в строки запроса, см. в разделе, посвященном условиям поиска в [справочнике по API агента Центр обновления Windows (WUA)](https://go.microsoft.com/fwlink/p/?LinkId=223304).

## <a name="use-the-microsofthotfixplugin"></a><a name="BKMK_HFP"></a>Использование подключаемого модуля Microsoft.HotfixPlugin
Подключаемый \- модуль **Microsoft. хотфиксплугин** можно использовать для установки обновлений Microsoft с ограниченным дистрибутивом \( LDR, \) \( которые также называются исправлениями, и ранее именуемыми QFE \) , которые можно скачать независимо, чтобы устранить определенные проблемы с программным обеспечением Майкрософт. Подключаемый модуль устанавливает обновления из корневой папки на общем файловом ресурсе SMB, а также может быть настроена для установки драйверов, не являющихся \- драйверами Майкрософт, встроенного по и обновлений BIOS.

> [!NOTE]
> Исправления иногда доступны для загрузки из корпорации Майкрософт в статьях базы знаний, но они также предоставляются клиентам по мере \- необходимости.

### <a name="requirements"></a>Требования

- Компьютер с отказоустойчивым кластером и координатором удаленного обновления \( , если он используется, \) должен соответствовать требованиям для Cau и конфигурации, необходимой для удаленного управления, перечисленных в статье [требования и рекомендации для Cau](cluster-aware-updating-requirements.md).
- Изучите [рекомендации по использованию подключаемого модуля Microsoft.HotfixPlugin](cluster-aware-updating-requirements.md#BKMK_BP_HF).
- Для получения наилучших результатов рекомендуется запустить модель CAU анализатор соответствия рекомендациям BPA, \( \) чтобы убедиться, что кластер и среда обновления настроены правильно для применения обновлений с помощью Cau. Подробнее см. в подразделе [Проверка готовности к кластерному обновлению](cluster-aware-updating-requirements.md#BKMK_BPA).
- Получите обновления от издателя и скопируйте их или извлеките в \( \) корневую папку исправления общего файлового ресурса SMB \( \) , которая поддерживает по меньшей мере SMB 2,0 и доступна для всех узлов кластера и компьютера координатора удаленного обновления, \( Если Cau используется в \- режиме удаленного обновления \) . Подробнее см. в подразделе [Настройка структуры корневой папки с исправлениями](#BKMK_HF_ROOT) далее в этом разделе.

    > [!NOTE]
    > По умолчанию этот подключаемый модуль \- устанавливает только исправления со следующими расширениями имен файлов: MSU, MSI и MSP.

- Скопируйте файл DefaultHotfixConfig.xml \( , который находится в папке **% systemroot% \\ system32 \\ WindowsPowerShell \\ v 1.0 \\ modules \\ КЛУСТЕРАВАРЕУПДАТИНГ** на компьютере, где установлены средства Cau, \) в созданную корневую папку исправлений, в которой были извлечены исправления. Например, скопируйте файл конфигурации в * \\ \\ \\ \\ корень \\ исправлений мифилесервер*.

    > [!NOTE]
    > Для установки большинства исправлений от корпорации Майкрософт и других обновлений файл конфигурации исправлений по умолчанию можно использовать без изменений. Если этого требует сценарий, вы можете дополнительно настроить файл конфигурации. Файл конфигурации может включать настраиваемые правила, например, для обработки файлов исправлений с конкретными расширениями или для определения поведения конкретных условий выхода. Подробнее см. в подразделе [Настройка файла конфигурации исправлений](#BKMK_CONFIG_FILE) далее в этом разделе.

### <a name="configuration"></a>Параметр Configuration

Настройте указанные ниже параметры. Чтобы получить дополнительную информацию, воспользуйтесь ссылками на дальнейшие подразделы этого раздела.
- Путь к общей корневой папке с исправлениями, которая содержит применяемые обновления и файл конфигурации исправлений. Этот путь можно ввести в пользовательском интерфейсе Cau или настроить аргумент подключаемого модуля PowerShell **хотфиксрутфолдерпас \= \<Path> ** \- .

   > [!NOTE]
   > Корневую папку исправлений можно указать как путь к локальной папке или UNC-путь к форме * \\ \\ ServerName \\ Share \\ рутфолдернаме*. \-Можно использовать путь к пространству имен DFS на основе домена или изолированной файловой системы. Однако функции подключаемого модуля \- , которые проверяют разрешения на доступ в файле конфигурации исправления, несовместимы с путем к пространству имен DFS, поэтому при ее настройке необходимо отключить проверку разрешений на доступ с помощью пользовательского интерфейса Cau или указать аргумент **дисаблеаклчеккс \= "true"** в качестве подключаемого модуля \- .
- Параметры на сервере, на котором размещена корневая папка исправления, чтобы проверить наличие соответствующих разрешений на доступ к папке и обеспечить целостность данных, доступ к которым осуществляется с помощью \( подписывания SMB общей папки SMB или шифрования SMB \) . Подробнее см. в подразделе [Ограничение доступа к корневой папке с исправлениями](#BKMK_ACL).

### <a name="additional-options"></a>Дополнительные параметры

- При необходимости настройте подключаемый модуль \- для принудительного применения шифрования SMB при доступе к данным из файлового ресурса исправления. В пользовательском интерфейсе CAU на странице **Дополнительные параметры** выберите параметр **требовать шифрование SMB при доступе к корневой папке исправления** или настройте аргумент **рекуиресмбенкриптион \= "true"** PowerShell Plug \- in.
  > [!IMPORTANT]
  > Чтобы включить проверку целостности данных SMB с использованием подписания или шифрования SMB, необходимо выполнить дополнительные действия по настройке на SMB-сервере. Подробнее см. в шаге 4 в подразделе [Ограничение доступа к корневой папке с исправлениями](#BKMK_ACL). Если выбран вариант принудительного использования шифрования SMB, а корневая папка исправлений не настроена для доступа с применением шифрования SMB, обновление не будет выполнено.
- Вы можете отключить выполняющиеся по умолчанию проверки достаточности разрешений на доступ к корневой папке исправлений и файлу конфигурации исправлений. В пользовательском интерфейсе CAU выберите **отключить проверку доступа администратора к корневой папке исправления и файлу конфигурации**или настройте аргумент **дисаблеаклчеккс \= "true"** в качестве подключаемого модуля \- .
- При необходимости настройте аргумент **хотфиксинсталлертимеаутминутес \= <Integer> ** , чтобы указать, как долго подключаемый модуль исправления \- должен вернуть процесс установки исправления. \(Значение по умолчанию — 30 минут. \) Например, чтобы задать период ожидания в два часа, установите **хотфиксинсталлертимеаутминутес \= 120**.
- При необходимости настройте аргумент подключаемого модуля **хотфиксконфигфиленаме \= <name> ** , \- указав имя файла конфигурации исправления, расположенного в корневой папке исправлений. Если он не указан, используется имя по умолчанию DefaultHotfixConfig.xml.

### <a name="configure-a-hotfix-root-folder-structure"></a><a name="BKMK_HF_ROOT"></a>Настройка структуры корневой папки с исправлениями

Чтобы подключаемый модуль исправления \- работал, исправления должны храниться в строго \- определенной структуре в корневой папке исправления общего файлового ресурса SMB \( \) , а для подключения \- к корневой папке исправления с помощью пользовательского интерфейса CAU или командлетов PowerShell Cau необходимо настроить подключаемый модуль исправления. Этот путь передается в подключаемый модуль \- в качестве аргумента **хотфиксрутфолдерпас** . Для корневой папки исправлений можно выбрать одну из нескольких структур в соответствии с потребностями в обновлении, как показано в примерах ниже. Файлы и папки, которые не соответствуют структуре, игнорируются.

#### <a name="example-1---folder-structure-used-to-apply-hotfixes-to-all-cluster-nodes"></a>Пример 1. Структура папок, используемая для применения исправлений ко всем узлам кластера

Чтобы указать, что исправления применяются ко всем узлам кластера, скопируйте их в папку с именем **каухотфикс \_ ALL** в корневой папке исправлений. В этом примере аргументу подключаемого модуля **хотфиксрутфолдерпас** \- присвоено значение * \\ \\ мифилесервер \\ hotfixs \\ root \\ *. Папка **каухотфикс \_ ALL** содержит три обновления с расширениями MSU, MSI и MSP, которые будут применяться ко всем узлам кластера. Имена файлов обновлений приведены только для иллюстрации.

> [!NOTE]
> В этом и последующих примерах файл конфигурации исправлений с именем по умолчанию DefaultHotfixConfig.xml находится в требуемом месте в корневой папке исправлений.

```
\\MyFileServer\Hotfixes\Root\
   DefaultHotfixConfig.xml
   CAUHotfix_All\
      Update1.msu
      Update2.msi
      Update3.msp
      ...
```

#### <a name="example-2---folder-structure-used-to-apply-certain-updates-only-to-a-specific-node"></a>Пример 2. Структура папок, используемая для применения определенных обновлений только к определенному узлу

Чтобы применить обновления только к определенному узлу, используйте вложенную папку с именем узла в корневой папке исправлений. Используйте NetBIOS-имя узла кластера, например *ContosoNode1*. Затем переместите в эту вложенную папку обновления, которые необходимо применить только к этому узлу. В следующем примере аргументу подключаемого модуля **хотфиксрутфолдерпас** \- присвоено значение * \\ \\ мифилесервер \\ hotfixs \\ root \\ *. Обновления в папке **каухотфикс \_ ALL** будут применены ко всем узлам кластера, и *NODE1 \_ конкретное \_ обновление. msu* будет применено только к *ContosoNode1*.

```
\\MyFileServer\Hotfixes\Root\
   DefaultHotfixConfig.xml
   CAUHotfix_All\
      Update1.msu
      Update2.msi
      Update3.msp
      ...
   ContosoNode1\
      Node1_Specific_Update.msu
      ...
```

#### <a name="example-3---folder-structure-used-to-apply-updates-other-than-msu-msi-and-msp-files"></a>Пример 3. Структура папок, используемая для применения обновлений, отличных от файлов MSU, MSI и MSP

По умолчанию подключаемый модуль **Microsoft.HotfixPlugin** применяет обновления только с расширениями MSU, MSI и MSP. Однако некоторые обновления могут иметь другие расширения и требовать других команд для установки. Например, может потребоваться применить обновление встроенного ПО с расширением EXE к узлу кластера. Корневую папку исправлений можно настроить с помощью вложенной папки, указывающей на \- необходимость установки определенного типа обновления, не используемого по умолчанию. Также необходимо настроить соответствующее правило установки для папки, которое определяет команду установки в элементе `<FolderRules>` XML-файла конфигурации исправлений.

В следующем примере аргументу подключаемого модуля **хотфиксрутфолдерпас** \- присвоено значение * \\ \\ мифилесервер \\ hotfixs \\ root \\ *. Несколько обновлений будут применены ко всем узлам кластера, а обновление встроенного ПО *SpecialHotfix1.exe* будет применено к узлу *ContosoNode1* с помощью правила *FolderRule1*. Подробнее о настройке правила *FolderRule1* в файле конфигурации исправлений см. в подразделе [Настройка файла конфигурации исправлений](#BKMK_CONFIG_FILE) далее в этом разделе.

```
\\MyFileServer\Hotfixes\Root\
   DefaultHotfixConfig.xml
   CAUHotfix_All\
      Update1.msu
      Update2.msi
      Update3.msp
      ...

   ContosoNode1\
      FolderRule1\
          SpecialHotfix1.exe
      ...
```

### <a name="customize-the-hotfix-configuration-file"></a><a name="BKMK_CONFIG_FILE"></a>Настройка файла конфигурации исправлений
Файл конфигурации исправлений управляет тем, как подключаемый модуль **Microsoft.HotfixPlugin** устанавливает определенные типы исправлений в отказоустойчивом кластере. Схема XML файла конфигурации определяется в файле HotfixConfigSchema.xsd, который находится на компьютере с установленными средствами CAU в следующей папке:

**папка% SystemRoot% \\ system32 \\ WindowsPowerShell \\ v 1.0 \\ modules \\ клустеравареупдатинг**

Чтобы настроить файл конфигурации исправлений, скопируйте образец файла конфигурации DefaultHotfixConfig.xml из этого расположения в корневую папку исправлений и внесите в него изменения в соответствии со своим сценарием.

> [!IMPORTANT]
> Для применения большинства исправлений от корпорации Майкрософт и других обновлений файл конфигурации исправлений по умолчанию можно использовать без изменений. Настраивать файл конфигурации исправлений требуется только в особых сценариях использования.

По умолчанию XML-файл конфигурации исправлений определяет правила установки и условия выхода для двух категорий исправлений.

-   Файлы исправлений с расширениями, которые подключаемый модуль \- может установить по умолчанию \( — файлы MSU, MSI и MSP \) .

    Они определяются как элементы `<ExtensionRules>` в элементе `<DefaultRules>` . Для каждого поддерживаемого по умолчанию типа файлов имеется один элемент `<Extension>` . Общая структура XML имеет следующий вид.

    ```xml
    <DefaultRules>
        <ExtensionRules>
          <Extension name="MSI">
            <!-- Template and ExitConditions elements for installation of .msi files follow -->
             ...
          </Extension>
          <Extension name="MSU">
            <!-- Template and ExitConditions elements for installation of .msu files follow -->
             ...
          </Extension>
          <Extension name="MSP">
            <!-- Template and ExitConditions elements for installation of .msp files follow -->
             ...
          </Extension>
             ...
       </ExtensionRules>
    </DefaultRules>
    ```

    Если необходимо применять обновления определенных типов ко всем узлам кластера в среде, можно определить дополнительные элементы `<Extension>` .

-   Исправления или другие файлы обновлений, не являющиеся файлами MSI, msu или MSP, например \- драйверы, встроенное по и обновления BIOS, не относящиеся к Майкрософт.

    Каждый \- тип файлов, не являющихся файлами по умолчанию, настраивается как `<Folder>` элемент в `<FolderRules>` элементе. Атрибут имени элемента `<Folder>` должен совпадать с именем вложенной папки в корневой папке исправлений, в которой будут содержаться обновления соответствующего типа. Папка может находиться в папке **каухотфикс \_ ALL** или в \- отдельной папке узла. Например, если в корневой папке исправлений настроено правило *FolderRule1*, то, чтобы определить шаблон установки и условия выхода для обновлений в этой папке, настройте следующий элемент в XML-файле:

    ```xml
    <FolderRules>
          <Folder name="FolderRule1">
            <!-- Template and ExitConditions elements for installation of updates in FolderRule1 follow -->
             ...
          </Folder>
          ...
    </FolderRules>
    ```

В таблице ниже описываются атрибуты `<Template>` и возможные дочерние элементы `<ExitConditions>` .

|Атрибут `<Template>`|Описание:|
|--------------------------|---------------|
|`path`|Полный путь к программе установки для типа файлов, определенного в атрибуте `<Extension name>` .<p>Чтобы указать путь к файлу обновления в структуре корневой папки исправлений, используйте элемент `$update$`.|
|`parameters`|Строка с обязательными и необязательными параметрами для программы, указанной в атрибуте `path`.<p>Чтобы задать параметр, который содержит путь к файлу обновления в структуре корневой папки исправлений, используйте элемент `$update$`.|

|Дочерний элемент `<ExitConditions>`|Описание:|
|---------------------------------|---------------|
|`<Success>`|Определяет один или несколько кодов выхода, указывающих на успешное применение обновления. Это обязательный дочерний элемент.|
|`<Success_RebootRequired>`|Определяет один или несколько кодов выхода, указывающих на успешное применение обновления и необходимость перезапуска узла (необязательный дочерний элемент). <br>**Примечание.** При необходимости `<Folder>` элемент может содержать `alwaysReboot` атрибут. Если этот атрибут задан, он указывает на то, что при возвращении исправлением, устанавливаемым этим правилом, одного из кодов выхода, которые определены в дочернем элементе `<Success>`, он интерпретируется как условие выхода `<Success_RebootRequired>` .|
|`<Fail_RebootRequired>`|Определяет один или несколько кодов выхода, указывающих на сбой при применении обновления и необходимость перезапуска узла (необязательный дочерний элемент).|
|`<AlreadyInstalled>`|Определяет один или несколько кодов выхода, указывающих на то, что обновление не было применено, так как оно уже установлено (необязательный дочерний элемент).|
|`<NotApplicable>`|Определяет один или несколько кодов выхода, указывающих на то, что обновление не было применено, так как оно не требуется для этого узла кластера (необязательный дочерний элемент).|

> [!IMPORTANT]
> Все коды выхода, которые не определены явным образом в элементе `<ExitConditions>` , интерпретируются как коды сбоя обновления, и узел не перезапускается.

### <a name="restrict-access-to-the-hotfix-root-folder"></a><a name="BKMK_ACL"></a>Ограничение доступа к корневой папке с исправлениями
Чтобы ограничить доступ к файлам в корневой папке исправлений и файлу конфигурации исправлений только в контексте подключаемого модуля **Microsoft.HotfixPlugin**, необходимо выполнить ряд действий по настройке файлового сервера и общей папки SMB. При этом будет включен ряд функций, позволяющих защитить файлы исправлений от несанкционированного доступа, который может поставить отказоустойчивый кластер под угрозу.

Общая процедура следующая.

1.  Укажите учетную запись пользователя, используемую для обновления запусков с помощью \- подключаемого модуля

2.  Настройка учетной записи пользователя в необходимых группах на файловом сервере SMB

3.  Настройка разрешений на доступ к корневой папке исправлений

4.  Настройка параметров для обеспечения целостности данных SMB

5.  Включение правила брандмауэра Windows на сервере SMB

#### <a name="step-1-identify-the-user-account-that-is-used-for-updating-runs-by-using-the-hotfix-plug-in"></a>Шаг 1. Укажите учетную запись пользователя, используемую для обновления запусков с помощью подключаемого модуля исправления \-

Учетная запись, используемая в CAU для проверки параметров безопасности во время выполнения прогона обновления с помощью **Microsoft. хотфиксплугин** , зависит от того, используется ли Cau в \- режиме удаленного обновления или в \- режиме самообновления, как показано ниже.

-   ** \- Режим удаленного обновления** . учетная запись с правами администратора в кластере для предварительного просмотра и применения обновлений.

-   **Режим самостоятельного \- обновления** имя объекта виртуального компьютера, настроенного в Active Directory для кластерной роли Cau. Это либо имя виртуального объекта-компьютера, предварительно подготовленного в Active Directory для кластерной роли CAU, либо имя, созданное компонентом CAU для кластерной роли. Чтобы получить имя, если оно создано с помощью CAU, выполните командлет **Get \- Кауклустерроле** Cau PowerShell. В выходных данных **ResourceGroupName** — это имя созданной учетной записи виртуального объекта-компьютера.

#### <a name="step-2-configure-this-user-account-in-the-necessary-groups-on-an-smb-file-server"></a>Шаг 2. Настройка учетной записи пользователя в необходимых группах на файловом сервере SMB

> [!IMPORTANT]
> Необходимо добавить учетную запись, используемую для выполнения прогонов обновления, в группу локальных администраторов SMB-сервера. Если это запрещено политиками безопасности организации, настройте для этой учетной записи необходимые разрешения на SMB-сервере с помощью описанной ниже процедуры.

##### <a name="to-configure-a-user-account-on-the-smb-server"></a>Настройка учетной записи пользователя на SMB-сервере

1.  Добавьте учетную запись, которая используется для выполнения прогонов обновления, в группу "Пользователи DCOM" и одну из следующих групп: "Опытные пользователи", "Операторы сервера" или "Операторы печати".

2.  Чтобы предоставить учетной записи необходимые разрешения WMI, запустите на SMB-сервере консоль управления WMI. Запустите PowerShell и введите следующую команду:

    ```
    wmimgmt.msc
    ```

3.  В дереве консоли щелкните правой кнопкой \- мыши **элемент Управление \( WMI \) локальный**и выберите пункт **Свойства**.

4.  Щелкните **Безопасность** и разверните элемент **Корень**.

5.  Щелкните **CIMV2**, а затем выберите **Безопасность**.

6.  Добавьте учетную запись, используемую для выполнения прогонов обновления, в список **Группы или пользователи**.

7.  Предоставьте учетной записи, используемой для выполнения прогонов обновления, разрешения **Выполнение методов** и **Включить удаленно**.

#### <a name="step-3-configure-permissions-to-access-the-hotfix-root-folder"></a>Шаг 3. Настройка разрешений на доступ к корневой папке исправлений

По умолчанию при попытке применить обновления подключаемый модуль исправления \- проверяет конфигурацию разрешений файловой системы NTFS для доступа к корневой папке исправления. Если разрешения на доступ к папке настроены неправильно, выполнение обновления с помощью подключаемого модуля исправления \- может завершиться ошибкой.

При использовании конфигурации по умолчанию подключаемого модуля исправления \- Убедитесь, что разрешения на доступ к папке соответствуют следующим требованиям.

-   Группа "Пользователи" имеет разрешение на чтение.

-   Если подключаемый модуль \- будет применять обновления с расширением exe, группа пользователей имеет разрешение выполнение.

-   Только определенные субъекты безопасности разрешены, \( но не обязательно должны \) иметь разрешение на запись или изменение. К таким субъектам относятся группа локальных администраторов, СИСТЕМА, СОЗДАТЕЛЬ-ВЛАДЕЛЕЦ и TrustedInstaller. Остальные учетные записи и группы не могут иметь разрешения на запись и изменение для корневой папки исправлений.

При необходимости можно отключить предыдущие проверки, выполняемые подключаемым модулем \- по умолчанию. Это можно сделать одним из двух способов.

-   Если вы используете командлеты PowerShell для CAU, настройте аргумент **дисаблеаклчеккс \= "true"** в параметре **кауплугинаргументс** для подключаемого модуля исправления \- .

-   Если используется пользовательский интерфейс CAU, выберите параметр **Отключить проверку административного доступа к корневой папке и файлу конфигурации исправлений** на странице **Дополнительные параметры обновления** мастера, служащего для настройки параметров прогона обновления.

Однако в большинстве сред мы рекомендуем использовать конфигурацию по умолчанию для принудительного выполнения этих проверок.

#### <a name="step-4-configure-settings-for-smb-data-integrity"></a>Шаг 4. Настройка параметров для обеспечения целостности данных SMB

Чтобы проверить целостность данных в подключениях между узлами кластера и общей папкой SMB, подключаемый модуль исправления \- требует включения параметров в общей папке SMB для подписывания SMB или шифрования SMB. Шифрование SMB, обеспечивающее повышенную безопасность и лучшую производительность во многих средах, поддерживается начиная с Windows Server 2012. Вы можете включить один или оба этих параметра, как указано ниже.

-   Сведения о включении подписания SMB см. в процедуре, описанной в [статье 887429](https://support.microsoft.com/kb/887429) базы знаний Майкрософт.

-   Чтобы включить шифрование SMB для общей папки SMB, выполните следующий командлет PowerShell на сервере SMB:

    ```PowerShell
    Set-SmbShare <ShareName> -EncryptData $true
    ```

    Где <*ShareName*> — это имя общей папки SMB.

Кроме того, чтобы принудительно использовать шифрование SMB в подключениях к серверу SMB, выберите параметр **требовать шифрование SMB при доступе к корневой папке исправления** в пользовательском интерфейсе Cau или настройте аргумент подключаемого модуля **рекуиресмбенкриптион \= "true"** с \- помощью командлетов PowerShell для Cau.

> [!IMPORTANT]
> Если выбран вариант принудительного использования шифрования SMB, а корневая папка исправлений не настроена для доступа с применением шифрования SMB, обновление не будет выполнено.

#### <a name="step-5-enable-a-windows-firewall-rule-on-the-smb-server"></a>Шаг 5. Включение правила брандмауэра Windows на сервере SMB

Необходимо включить правило **удаленного управления файлового сервера \( SMB \- в \) ** правиле брандмауэра Windows на файловом сервере SMB. Эта возможность включена по умолчанию в Windows Server 2016, Windows Server 2012 R2 и Windows Server 2012.

## <a name="additional-references"></a>Дополнительные ссылки

-   [Обзор обновления с поддержкой кластера](cluster-aware-updating.md)

-   [Командлеты Windows PowerShell для обновления с поддержкой кластера](https://docs.microsoft.com/powershell/module/clusterawareupdating)

-   [Справочник по подключаемым модулям для кластерного обновления](https://msdn.microsoft.com/library/hh418084.aspx)

