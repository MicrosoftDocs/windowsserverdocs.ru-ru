---
ms.assetid: 0cd1ac70-532c-416d-9de6-6f920a300a45
title: Развертывание облачного следящего сервера для отказоустойчивого кластера
ms.prod: windows-server
manager: lizross
ms.author: jgerend
ms.technology: storage-failover-clustering
ms.topic: article
author: JasonGerend
ms.date: 01/18/2019
description: Сведения об использовании Microsoft Azure для размещения следящего сервера для отказоустойчивого кластера Windows Server в облаке — как развернуть облачный следящий сервер.
ms.openlocfilehash: 0b4ba643dca81d2d19b94b1d27485149f938e1c4
ms.sourcegitcommit: b00d7c8968c4adc8f699dbee694afe6ed36bc9de
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/08/2020
ms.locfileid: "80827917"
---
# <a name="deploy-a-cloud-witness-for-a-failover-cluster"></a>Развертывание облака-свидетеля для отказоустойчивого кластера

> Область применения: Windows Server 2019, Windows Server 2016

Облако-свидетель — это тип следящего сервера кворума отказоустойчивого кластера, который использует Microsoft Azure для передачи голоса по кворуму кластера. В этом разделе приводятся общие сведения о функции облака-свидетеля, поддерживаемых сценариях и инструкции по настройке облачного следящего сервера для отказоустойчивого кластера.

## <a name="cloud-witness-overview"></a><a name="CloudWitnessOverview"></a>Обзор облака-свидетеля

На рис. 1 показана конфигурация кворума отказоустойчивого кластера с несколькими сайтами в Windows Server 2016. В этом примере конфигурации (рис. 1) имеется 2 узла в двух центрах обработки данных (называемых сайтами). Обратите внимание, что кластер может охватывать более двух центров обработки данных. Кроме того, каждый центр обработки данных может иметь более двух узлов. Типичная конфигурация кворума кластера в этой установке (соглашение об уровне обслуживания для автоматического перехода на другой ресурс) дает каждому узлу голосование. Один дополнительный голос предоставляется свидетелю кворума, чтобы позволить кластеру работать, даже если в одном из центров обработки данных возникает сбой питания. Математические вычисления очень просты — имеется 5 общих голосов, и для кластера требуется 3 голоса, чтобы он продолжал работать.  

![Файловый ресурс-свидетель на третьем отдельном сайте с 2 узлами на 2 других сайтах](media/Deploy-a-Cloud-Witness-for-a-Failover-Cluster/CloudWitness_1.png "Следящий сервер файлового ресурса общего доступа")  
**Рис. 1. использование файлового ресурса-свидетеля в качестве следящего сервера кворума**  

В случае отключения питания в одном центре обработки данных, чтобы сделать так, чтобы кластер в другом центре обработки данных был в состоянии работать, рекомендуется разместить следящий сервер кворума в расположении, отличном от двух центров обработки данных. Обычно это означает, что для размещения файлового сервера, который используется в качестве следящего сервера кворума (файловый ресурс-свидетель), требуется наличие в третьем отдельном центре обработки данных (сайта).  

В большинстве организаций нет третьего центра обработки данных, который будет размещать файловый сервер в файловый ресурс-свидетель. Это означает, что Организации в основном размещают файловый сервер в одном из двух центров обработки данных, который по расширению делает центр обработки данных основным центром данных. В случае сбоя питания в основном центре обработки данных кластер будет работать, так как в другом центре обработки данных будет сосуществовать только два голоса, которые ниже, чем требуется 3 голоса. Для клиентов с третьим центром обработки данных для размещения файлового сервера накладные расходы на обслуживание файлового сервера с высокой доступностью поддерживают резервное копирование файлового ресурса-свидетеля. Размещение виртуальных машин в общедоступном облаке с файловым сервером для файлового ресурса-свидетеля, работающего в гостевой ОС, является значительной нагрузкой с точки зрения настройки & обслуживания.  

Облако-свидетель — это новый тип следящего сервера кворума отказоустойчивого кластера, который использует Microsoft Azure в качестве точки арбитража (рис. 2). Он использует хранилище BLOB-объектов Azure для чтения и записи файла большого двоичного объекта, который затем используется в качестве точки арбитража в случае разрешения Split-мозг.  

У этого подхода есть значительные преимущества:
1. Использует Microsoft Azure (нет необходимости в третьем отдельном центре обработки данных).  
2. Использует стандартное Доступное хранилище BLOB-объектов Azure (без дополнительных затрат на обслуживание виртуальных машин, размещенных в общедоступном облаке).  
3. Одну и ту же учетную запись хранения Azure можно использовать для нескольких кластеров (один файл большого двоичного объекта на кластер; уникальный идентификатор кластера используется как имя файла большого двоичного объекта).  
4. Очень низкий уровень $cost учетной записи хранения (очень малые данные, записываемые на файл большого двоичного объекта, файл большого двоичного объекта обновляется только один раз при изменении состояния узлов кластера).  
5. Встроенный тип ресурса-свидетеля облака.  

на схеме ![показано многосайтовое растянутое кластер с помощью облака WITNESS в качестве следящего сервера кворума](media/Deploy-a-Cloud-Witness-for-a-Failover-Cluster/CloudWitness_2.png)  
**Рис. 2. растянутые кластеры с несколькими сайтами с облаком-свидетелем в качестве следящего сервера кворума**  

Как показано на рис. 2, не требуется третий отдельный сайт. Облачный следящий сервер, как и любой другой следящий сервер кворума, получает голос и может участвовать в вычислениях кворума.  

## <a name="cloud-witness-supported-scenarios-for-single-witness-type"></a><a name="CloudWitnessSupportedScenarios"></a>Облако-свидетель. Поддерживаемые сценарии для одного типа следящего сервера
При наличии развертывания отказоустойчивого кластера, в котором все узлы могут подключиться к Интернету (по расширению Azure), рекомендуется настроить в качестве ресурса следящего сервера облачный следящий сервер.  

Ниже перечислены некоторые сценарии, которые поддерживают использование облака-свидетеля в качестве следящего сервера кворума.  
- Аварийное восстановление растянутых кластеров с несколькими сайтами (см. рис. 2).  
- Отказоустойчивые кластеры без общего хранилища (SQL Always On и т. д.).  
- Отказоустойчивые кластеры, работающие в гостевой ОС, размещенной в Microsoft Azure роли виртуальной машины (или в любом другом общедоступном облаке).  
- Отказоустойчивые кластеры, работающие в гостевой ОС виртуальных машин, размещенных в частных облаках.
- Кластеры хранилища с общим хранилищем или без него, например кластеры масштабируемых файловых серверов.  
- Малый филиал — кластеры Office (даже кластеры из двух узлов)  

Начиная с Windows Server 2012 R2 рекомендуется всегда настраивать следящий сервер, так как кластер автоматически управляет голосованием следящего сервера и узлы проголосуют с помощью динамического кворума.  

## <a name="set-up-a-cloud-witness-for-a-cluster"></a><a name="CloudWitnessSetUp"></a>Настройка облачного следящего сервера для кластера
Чтобы настроить облачный следящий сервер в качестве следящего сервера кворума для кластера, выполните следующие действия.
1. Создание учетной записи хранения Azure для использования в качестве облачного следящего сервера
2. Настройте облако-свидетель в качестве следящего сервера кворума для кластера.

## <a name="create-an-azure-storage-account-to-use-as-a-cloud-witness"></a>Создание учетной записи хранения Azure для использования в качестве облачного следящего сервера

В этом разделе описывается создание учетной записи хранения и просмотр и копирование URL-адресов конечных точек и ключей доступа для этой учетной записи.

Для настройки облака-свидетеля необходимо иметь действительную учетную запись хранения Azure, которую можно использовать для хранения файла большого двоичного объекта (используется для арбитража). Cloud следящий сервер создает хорошо известный контейнер **MSFT-Cloud-следящий** в учетной записи хранения Майкрософт. Облачный следящий сервер записывает один файл большого двоичного объекта с уникальным ИДЕНТИФИКАТОРом соответствующего кластера, используемый в качестве имени файла большого двоичного объекта в этом контейнере **MSFT-Cloud-witness** . Это означает, что вы можете использовать ту же учетную запись служба хранилища Microsoft Azure для настройки облака-свидетеля для нескольких разных кластеров.

При использовании одной и той же учетной записи хранения Azure для настройки облака-свидетеля для нескольких разных кластеров автоматически создается один контейнер **MSFT — Cloud-свидетеля** . Этот контейнер будет содержать один большой двоичный файл на кластер.

### <a name="to-create-an-azure-storage-account"></a>Создание учетной записи хранения Azure

1. Войдите на [портал Azure](https://portal.azure.com).
2. В меню «Концентратор» выберите Создать -> Данные + хранилище -> Учетная запись хранения.
3. На странице Создание учетной записи хранения выполните следующие действия.
    1. Введите имя учетной записи хранения.
    <br>Длина имени учетной записи хранения должна составлять от 3 до 24 символов и может содержать только цифры и строчные буквы. Имя учетной записи хранения также должно быть уникальным в пределах Azure.
        
    2. В качестве **типа учетной записи**выберите **Общее назначение**.
    <br>Для облака-свидетеля нельзя использовать учетную запись хранения BLOB-объектов.
    3. Для **повышения производительности**выберите **стандартный**.
    <br>Хранилище Azure класса Premium нельзя использовать для облачных серверов-свидетелей.
    2. Для **репликации**выберите **локально избыточное хранилище (LRS)** .
    <br>Отказоустойчивая кластеризация использует файл большого двоичного объекта в качестве точки арбитража, что требует некоторых гарантий согласованности при чтении данных. Поэтому для типа **репликации** необходимо выбрать **локально избыточное хранилище** .

### <a name="view-and-copy-storage-access-keys-for-your-azure-storage-account"></a>Просмотр и копирование ключей доступа к хранилищу для учетной записи хранения Azure

При создании учетной записи служба хранилища Microsoft Azure она связывается с двумя автоматически создаваемыми ключами доступа — первичным ключом доступа и вторичным ключом доступа. Для первого создания облака-свидетеля используйте **первичный ключ доступа**. Не существует ограничений, касающихся того, какой ключ следует использовать для облака-свидетеля.  

#### <a name="to-view-and-copy-storage-access-keys"></a>Просмотр и копирование ключей доступа к хранилищу

На портале Azure перейдите к своей учетной записи хранения, щелкните **все параметры** , а затем щелкните **ключи доступа** , чтобы просмотреть, скопировать и повторно создать ключи доступа к учетной записи. Колонка ключи доступа также содержит предварительно настроенные строки подключения с помощью первичных и вторичных ключей, которые можно скопировать для использования в приложениях (см. рис. 4).

![снимок диалогового окна "Управление ключами доступа" в Microsoft Azure](media/Deploy-a-Cloud-Witness-for-a-Failover-Cluster/CloudWitness_4.png)  
**Рис. 4. ключи доступа к хранилищу**

### <a name="view-and-copy-endpoint-url-links"></a>Просмотр и копирование ссылок URL-адресов конечных точек  
При создании учетной записи хранения следующие URL-адреса создаются с использованием следующего формата: `https://<Storage Account Name>.<Storage Type>.<Endpoint>`  

Облако-свидетель всегда использует **большой двоичный объект** в качестве типа хранилища. В качестве конечной точки Azure использует **. Core.Windows.NET** . При настройке облака-свидетеля можно настроить для него другую конечную точку в соответствии со сценарием (например, Microsoft Azure центр обработки данных в Китае имеет другую конечную точку).  

> [!NOTE]  
> URL-адрес конечной точки автоматически создается ресурсом облака-свидетеля, и для него не требуется дополнительного шага настройки.  

#### <a name="to-view-and-copy-endpoint-url-links"></a>Просмотр и копирование ссылок URL-адресов конечных точек
На портале Azure перейдите к своей учетной записи хранения, щелкните **все параметры** , а затем щелкните **свойства** , чтобы просмотреть и скопировать URL-адреса конечной точки (см. рис. 5).  

![моментальный снимок ссылок на конечную точку облака-свидетеля](media/Deploy-a-Cloud-Witness-for-a-Failover-Cluster/CloudWitness_5.png)  
**Рис. 5. ссылки URL-адресов конечной точки облачного свидетеля**

Дополнительные сведения о создании учетных записей хранения Azure и управлении ими см. в статье [об учетных записях хранения Azure](https://azure.microsoft.com/documentation/articles/storage-create-storage-account/) .

## <a name="configure-cloud-witness-as-a-quorum-witness-for-your-cluster"></a>Настройка облака-свидетеля в качестве следящего сервера кворума для кластера
Конфигурация облака-свидетеля хорошо интегрирована в существующий мастер настройки кворума, встроенный в диспетчер отказоустойчивости кластеров.  

### <a name="to-configure-cloud-witness-as-a-quorum-witness"></a>Настройка облака-свидетеля в качестве следящего сервера кворума
1. Запустите диспетчер отказоустойчивости кластеров.
2. Щелкните правой кнопкой мыши кластер — > **Дополнительные действия** -> **настроить параметры кворума кластера** (см. рис. 6). Запустится мастер настройки кворума кластера.  
    ![моментальный снимок пути меню к параметрам кворума кластера настроить в пользовательском интерфейсе диспетчер отказоустойчивости кластеров](media/Deploy-a-Cloud-Witness-for-a-Failover-Cluster/CloudWitness_7.png) **рис. 6. Параметры кворума кластера**

3. На странице **Выбор конфигураций кворума** выберите **пункт выбрать следящий сервер кворума** (см. рис. 7).  

    ![ный моментальный снимок переключателя "выбрать следящий сервер куотрум" в мастере кворума кластера](media/Deploy-a-Cloud-Witness-for-a-Failover-Cluster/CloudWitness_8.png)  
    **Рис. 7. Выбор конфигурации кворума**

4. На странице **Выбор следящего сервера кворума** выберите **Настройка облачного следящего сервера** (см. рис. 8).  

    ![моментальный снимок соответствующего переключателя для выбора облака-свидетеля](media/Deploy-a-Cloud-Witness-for-a-Failover-Cluster/CloudWitness_9.png)  
    **Рис. 8. Выбор следящего сервера кворума**  

5. На странице **Настройка облачного следящего сервера** введите следующие сведения.  
   1. (Обязательный параметр) Имя учетной записи хранения Azure.  
   2. (Обязательный параметр) Ключ доступа, соответствующий учетной записи хранения.  
       1. При создании в первый раз используйте первичный ключ доступа (см. рис. 5)  
       2. При смене первичного ключа доступа Используйте вторичный ключ доступа (см. рис. 5).  
   3. (Необязательный параметр) Если вы планируете использовать другую конечную точку службы Azure (например, службу Microsoft Azure в Китае), обновите имя сервера конечной точки.  

      ![снимок панели конфигурация Cloud следящий в мастере кворума кластера](media/Deploy-a-Cloud-Witness-for-a-Failover-Cluster/CloudWitness_10.png)  
      **Рис. 9. Настройка облачного следящего сервера**

6. После успешной настройки облачного следящего сервера можно просмотреть созданный ресурс-свидетель в оснастка диспетчера отказоустойчивости кластеров (см. рис. 10).

    ![успешной настройки](media/Deploy-a-Cloud-Witness-for-a-Failover-Cluster/CloudWitness_11.png) облака-свидетеля  
    **Рис. 10. Успешная Настройка облака-свидетеля**

### <a name="configuring-cloud-witness-using-powershell"></a>Настройка облака-свидетеля с помощью PowerShell  
Существующая команда PowerShell Set-Клустеркуорум имеет новые дополнительные параметры, соответствующие облаку следящего сервера.  

Вы можете настроить облако-свидетель с помощью [`Set-ClusterQuorum`](https://technet.microsoft.com/library/ee461013.aspx) следующей команды PowerShell:  

```PowerShell
Set-ClusterQuorum -CloudWitness -AccountName <StorageAccountName> -AccessKey <StorageAccountAccessKey>
```

Если вам нужно использовать другую конечную точку (редко), сделайте следующее:  

```PowerShell
Set-ClusterQuorum -CloudWitness -AccountName <StorageAccountName> -AccessKey <StorageAccountAccessKey> -Endpoint <servername>  
```

### <a name="azure-storage-account-considerations-with-cloud-witness"></a>Рекомендации по учетным записям хранения Azure с облачным свидетелем  
При настройке облака-свидетеля в качестве следящего сервера кворума для отказоустойчивого кластера учитывайте следующее.
* Вместо того чтобы хранить ключ доступа, отказоустойчивый кластер создаст и безопасно сохранит маркер безопасности общего доступа (SAS).  
* Созданный маркер SAS действителен, пока ключ доступа остается действительным. При смене первичного ключа доступа важно сначала обновить облачный следящий сервер (на всех кластерах, использующих эту учетную запись хранения) с помощью вторичного ключа доступа, прежде чем повторно создать первичный ключ доступа.  
* Cloud следящий сервер использует интерфейс HTTPS для службы учетной записи хранения Azure. Это означает, что порт HTTPS должен быть открыт на всех узлах кластера.

### <a name="proxy-considerations-with-cloud-witness"></a>Вопросы прокси-сервера в облаке  
Для установления связи со службой BLOB-объектов Azure облачный следящий сервер использует протокол HTTPS (порт по умолчанию 443). Убедитесь, что HTTPS-порт доступен через сетевой прокси.

## <a name="see-also"></a>См. также
- [Новые возможности отказоустойчивой кластеризации в Windows Server](whats-new-in-failover-clustering.md)
