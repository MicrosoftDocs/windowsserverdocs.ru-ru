---
title: Последовательное обновление ОС кластера
ms.prod: windows-server
ms.technology: storage-failover-clustering
ms.topic: get-started-article
ms.assetid: 6e102c1f-df26-4eaa-bc7a-d0d55d3b82d5
author: jasongerend
ms.author: jgerend
ms.date: 03/27/2018
ms.openlocfilehash: fc1799db76f528a599ef70eec5093da0a76206a2
ms.sourcegitcommit: 083ff9bed4867604dfe1cb42914550da05093d25
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/14/2020
ms.locfileid: "75948530"
---
# <a name="cluster-operating-system-rolling-upgrade"></a>Последовательное обновление операционной системы кластера

> Область применения: Windows Server 2019, Windows Server 2016

Последовательное обновление ОС кластера позволяет администратору обновить операционную систему узлов кластера без остановки Hyper-V или масштабируемый файловый сервер рабочих нагрузок. Благодаря этой функции можно избежать штрафов за простои, которые полагаются согласно соглашениям об уровне обслуживания.

Последовательное обновление ОС кластера предоставляет следующие преимущества.

- Отказоустойчивые кластеры, работающие под управлением виртуальных машин Hyper-V и масштабируемых файловых серверов (SOFS), могут быть обновлены с Windows Server 2012 R2 (на всех узлах кластера) на Windows Server 2016 (выполняется на всех узлах кластера кластера) без простоев. Другие рабочие нагрузки кластера, такие как SQL Server, будут недоступны в течение времени (обычно менее пяти минут), которые переводят на резервный ресурс в Windows Server 2016.  
- Для этого не требуется дополнительное оборудование. Несмотря на это, можно временно добавить дополнительные узлы кластера к небольшим кластерам, чтобы повысить доступность кластера во время последовательного обновления ОС кластера.  
- Кластер не нужно останавливать или перезапускать.  
- Новый кластер не требуется. Существующий кластер обновлен. Кроме того, используются существующие объекты кластера, хранящиеся в Active Directory.  
- Процесс обновления обратим до тех пор, пока клиент не выберет "точка-не возврат", когда все узлы кластера работают под управлением Windows Server 2016 и выполняется командлет PowerShell Update-Клустерфунктионаллевел.  
- Кластер может поддерживать операции исправления и обслуживания при работе в смешанном режиме ОС.  
- Она поддерживает автоматизацию с помощью PowerShell и WMI.  
- Свойство общедоступного свойства **клустерфунктионаллевел** кластера указывает состояние кластера на узлах кластера Windows Server 2016. Это свойство можно запросить с помощью командлета PowerShell из узла кластера Windows Server 2016, который принадлежит к отказоустойчивому кластеру:  
    ```PowerShell
    Get-Cluster | Select ClusterFunctionalLevel  
    ```  

    Значение **8** указывает, что кластер работает на функциональном уровне Windows Server 2012 R2. Значение **9** указывает, что кластер работает на функциональном уровне Windows Server 2016.  

В этом руководстве описываются различные этапы процесса последовательного обновления ОС кластера, шаги установки, ограничения функций и часто задаваемые вопросы, которые применимы к следующим сценариям последовательного обновления ОС кластера в Windows Server 2016:  
- Кластеры Hyper-V  
- Кластеры масштабируемый файловый сервер  

Следующий сценарий не поддерживается в Windows Server 2016:  
-  Последовательное обновление ОС кластера для гостевых кластеров с помощью виртуального жесткого диска (VHDX-файл) в качестве общего хранилища  

Последовательное обновление ОС кластера полностью поддерживается System Center Virtual Machine Manager (SCVMM) 2016. Если вы используете SCVMM 2016, см. статью [выполнение последовательного обновления кластера узлов Hyper-V до Windows Server 2016 в VMM](https://docs.microsoft.com/system-center/vmm/hyper-v-rolling-upgrade?view=sc-vmm-1807) для получения инструкций по обновлению кластеров и автоматизации действий, описанных в этом документе.  

## <a name="requirements"></a>Требования  
Перед началом чередующегося процесса обновления ОС кластера выполните следующие требования.

- Начните с отказоустойчивого кластера под управлением Windows Server (полугодовой канал), Windows Server 2016 или Windows Server 2012 R2.
- Обновление кластера Локальные дисковые пространства до Windows Server версии 1709 не поддерживается.
- Если в качестве рабочей нагрузки кластера используются виртуальные машины Hyper-V или масштабируемый файловый сервер, обновление без простоя может быть отключено.
- Убедитесь, что узлы Hyper-V имеют процессоры, поддерживающие таблицу адресации второго уровня (SLAT), используя один из следующих методов.  
        -Проверьте, [совместимы ли вы с SLAT? Совет по WP8 SDK](https://blogs.msdn.com/b/devfish/archive/2012/11/06/are-you-slat-compatible-wp8-sdk-tip-01.aspx) , посвященный двум методам проверки того, поддерживает ли ЦП SLAT  
        — Скачайте средство [Coreinfo v 3.31](https://technet.microsoft.com/sysinternals/cc835722) , чтобы определить, поддерживает ли ЦП SLAT.

## <a name="cluster-transition-states-during-cluster-os-rolling-upgrade"></a>Состояния переходов кластера во время последовательного обновления ОС кластера

В этом разделе описаны различные состояния перехода для кластера Windows Server 2012 R2, который обновляется до Windows Server 2016 с помощью последовательного обновления ОС кластера.  

Чтобы обеспечить выполнение рабочих нагрузок кластера во время последовательного обновления ОС кластера, перемещение рабочей нагрузки кластера с узла Windows Server 2012 R2 на узел Windows Server 2016 работает так, как если бы оба узла работали под управлением операционной системы Windows Server 2012 R2. Когда узлы Windows Server 2016 добавляются в кластер, они работают в режиме совместимости с Windows Server 2012 R2. Новый режим концептуального кластера с именем "смешанный режим ОС" позволяет создавать узлы различных версий в одном кластере (см. рис. 1).  

![иллюстрация, показывающая три этапа последовательного обновления ОС кластера: все узлы Windows Server 2012 R2, смешанный режим ОС и все узлы Windows Server 2016](media/Cluster-Operating-System-Rolling-Upgrade/Clustering_RollingUpgrade_Overview.png)  
**Рис. 1. переходы состояния операционной системы кластера**  

Кластер Windows Server 2012 R2 переходит в режим смешанной операционной системы при добавлении узла Windows Server 2016 в кластер. Процесс полностью обратим — узлы Windows Server 2016 могут быть удалены из кластера и узлы Windows Server 2012 R2 могут быть добавлены в кластер в этом режиме. Точка без возвращаемых данных возникает при выполнении командлета PowerShell Update-Клустерфунктионаллевел в кластере. Чтобы этот командлет был выполнен, все узлы должны быть Windows Server 2016, и все узлы должны находиться в режиме «в сети».  

## <a name="transition-states-of-a-four-node-cluster-while-performing-rolling-os-upgrade"></a>Переход состояний кластера из четырех узлов при выполнении последовательного обновления ОС

В этом разделе показаны и описаны четыре разных этапа кластера с общим хранилищем, узлы которых обновлены с Windows Server 2012 R2 до Windows Server 2016.  

Этап 1 — начальное состояние — мы начнем с кластера Windows Server 2012 R2.  

![иллюстрация, показывающая начальное состояние: все узлы Windows Server 2012 R2](media/Cluster-Operating-System-Rolling-Upgrade/Cluster_RollingUpgrade_Stage1.png)  
**Рис. 2. начальное состояние: отказоустойчивый кластер Windows Server 2012 R2 (этап 1)**  

В шаге 2 два узла были приостановлены, остановлены, вытеснены, переформатированы и установлены вместе с Windows Server 2016.  

![иллюстрация, показывающая кластер в смешанном режиме: из примера кластера из 4 узлов, два узла работают под управлением Windows Server 2016, а два узла работают под управлением Windows Server 2012 R2](media/Cluster-Operating-System-Rolling-Upgrade/Cluster_RollingUpgrade_Stage2.png)  
**Рис. 3. промежуточное состояние: режим смешанной ОС: Windows Server 2012 R2 и отказоустойчивый кластер Windows Server 2016 (этап 2)**  

На этапе 3 все узлы в кластере обновлены до Windows Server 2016, и кластер готов к обновлению с помощью командлета PowerShell Update-Клустерфунктионаллевел.  

> [!NOTE]  
> На этом этапе процесс может быть полностью реверсирован, и узлы Windows Server 2012 R2 могут быть добавлены в этот кластер.  

![иллюстрация, показывающая, что кластер был полностью обновлен до Windows Server 2016 и готов к использованию командлета Update-Клустерфунктионаллевел, чтобы обеспечить функциональный уровень кластера до Windows Server 2016](media/Cluster-Operating-System-Rolling-Upgrade/Cluster_RollingUpgrade_Stage3.png)  
**Рис. 4. промежуточное состояние: все узлы обновлены до Windows Server 2016, готовые для Update-Клустерфунктионаллевел (этап 3)**  

После запуска Update-Клустерфунктионаллевелкмдлет кластер переходит в этап 4, где можно использовать новые функции кластера Windows Server 2016.  

![иллюстрация, показывающая, что обновление чередующегося обновления ОС выполнено успешно. все узлы обновлены до Windows Server 2016, а кластер работает на функциональном уровне кластера Windows Server 2016](media/Cluster-Operating-System-Rolling-Upgrade/Cluster_RollingUpgrade_Stage4.png)  
**Рис. 5. конечное состояние: отказоустойчивый кластер Windows Server 2016 (этап 4)**  

## <a name="cluster-os-rolling-upgrade-process"></a>Процесс последовательного обновления ОС кластера

В этом разделе описывается рабочий процесс для выполнения последовательного обновления ОС кластера.  

Иллюстрация ![, показывающая рабочий процесс обновления кластера](media/Cluster-Operating-System-Rolling-Upgrade/Clustering_RollingUpgrade_Workflow.png)  
**Рис. 6. Рабочий процесс последовательного обновления ОС кластера**  

Последовательное обновление ОС кластера включает следующие шаги.  

1. Подготовьте кластер для обновления операционной системы следующим образом.  
    1. Последовательное обновление ОС кластера требует удаления одного узла за раз из кластера. Проверьте, достаточно ли места в кластере для поддержки соглашений об уровне обслуживания с высоким уровнем доступности, когда один из узлов кластера удаляется из кластера для обновления операционной системы. Другими словами, требуется ли возможность отработки отказа рабочих нагрузок на другом узле, когда один из узлов удаляется из кластера во время последовательного обновления ОС кластера? Имеет ли кластер возможность запуска требуемых рабочих нагрузок, когда один из узлов удаляется из кластера для последовательного обновления ОС кластера?  
    2. Для рабочих нагрузок Hyper-V убедитесь, что все узлы Windows Server 2016 Hyper-V имеют поддержку ЦП во втором уровне таблицы адресов (SLAT). Только компьютеры с поддержкой SLAT могут использовать роль Hyper-V в Windows Server 2016.  
    3. Убедитесь, что все резервные копии рабочей нагрузки завершены, и попробуйте создать резервную копию кластера. Прерывать операции резервного копирования при добавлении узлов в кластер.  
    4. Убедитесь, что все узлы кластера находятся в сети/руннинг/УП с помощью командлета [`Get-ClusterNode`](https://docs.microsoft.com/powershell/module/failoverclusters/Get-ClusterNode?view=win10-ps) (см. рис. 7).  

        ![снимке экрана, отображающий результаты выполнения командлета Get-ClusterNode](media/Cluster-Operating-System-Rolling-Upgrade/Cluster_RollingUpgrade_GetClusterNode.png)  
        **Рис. 7. Определение состояния узла с помощью командлета Get-ClusterNode**  

    5. Если выполняется обновление с поддержкой кластера (CAU), проверьте, выполняется ли в данный момент CAU с помощью пользовательского интерфейса **обновления с поддержкой кластера** или командлета [`Get-CauRun`](https://docs.microsoft.com/powershell/module/clusterawareupdating/Get-CauRun?view=win10-ps) (см. рис. 8). Остановите CAU с помощью командлета [`Disable-CauClusterRole`](https://docs.microsoft.com/powershell/module/clusterawareupdating/Disable-CauClusterRole?view=win10-ps) (см. рис. 9), чтобы предотвратить приостановку и прекращение работы всех узлов при последовательном обновлении операционной системы кластера.  

        ![снимке экрана, отображающая выходные данные командлета Get-Каурун](media/Cluster-Operating-System-Rolling-Upgrade/Cluster_RollingUpgrade_GetCAU.png)  
        **Рис. 8. Использование командлета [`Get-CauRun`](https://docs.microsoft.com/powershell/module/clusterawareupdating/Get-CauRun?view=win10-ps) для определения того, выполняются ли на кластере обновления, поддерживающие кластер.**  

        ![снимке экрана, отображающая выходные данные командлета Disable-Кауклустерроле](media/Cluster-Operating-System-Rolling-Upgrade/Cluster_RollingUpgrade_DisableCAU.png)  
        **Рис. 9. Отключение роли "обновление с учетом кластеров" с помощью командлета [`Disable-CauClusterRole`](https://docs.microsoft.com/powershell/module/clusterawareupdating/Disable-CauClusterRole?view=win10-ps)**  

2. Для каждого узла в кластере выполните следующие действия.  
    1. С помощью пользовательского интерфейса диспетчера кластеров выберите узел и используйте **паузу |** Пункт меню "Сток" для очистки узла (см. рис. 10) или используйте командлет [`Suspend-ClusterNode`](https://docs.microsoft.com/powershell/module/failoverclusters/Suspend-ClusterNode?view=win10-ps) (см. рис. 11).  

        ![снимке экрана, показывающий, как выполнять сток ролей с помощью пользовательского интерфейса диспетчера кластеров](media/Cluster-Operating-System-Rolling-Upgrade/Cluster_RollingUpgrade_FCM_DrainRoles.png)  
        **Рис. 10. сток ролей из узла с помощью диспетчер отказоустойчивости кластеров**  

        ![снимке экрана, отображающая выходные данные командлета Suspend-ClusterNode](media/Cluster-Operating-System-Rolling-Upgrade/Cluster_RollingUpgrade_SuspendNode.png)  
        **Рис. 11. сток ролей из узла с помощью командлета [`Suspend-ClusterNode`](https://docs.microsoft.com/powershell/module/failoverclusters/Suspend-ClusterNode?view=win10-ps)**  

    2.  С помощью пользовательского интерфейса диспетчера кластеров, **исключите** Приостановленный узел из кластера или используйте командлет [`Remove-ClusterNode`](https://docs.microsoft.com/powershell/module/failoverclusters/Remove-ClusterNode?view=win10-ps) .  

        ![снимке экрана, отображающая выходные данные командлета Remove-ClusterNode](media/Cluster-Operating-System-Rolling-Upgrade/Cluster_RollingUpgrade_RemoveNode.png)  
        **Рис. 12. Удаление узла из кластера с помощью командлета [`Remove-ClusterNode`](https://docs.microsoft.com/powershell/module/failoverclusters/Remove-ClusterNode?view=win10-ps)**  

    3.  Переформатируйте системный диск и выполните чистую установку операционной системы Windows Server 2016 на узле, используя **настраиваемую установку: Установка только Windows (дополнительно)** (см. рис. 13) в Setup. exe. Не устанавливайте флажок **обновление: установить Windows и не использовать файлы, параметры и приложения** , так как последовательное обновление ОС кластера не способствует обновлению на месте.  

        ![снимке экрана мастера установки Windows Server 2016 с выбранным вариантом выборочной установки](media/Cluster-Operating-System-Rolling-Upgrade/Cluster_RollingUpgrade_InstallOption.png)  
        **Рис. 13. доступные варианты установки для Windows Server 2016**  

    4.  Добавьте узел в соответствующий домен Active Directory.  
    5.  Добавьте соответствующих пользователей в группу администраторов.  
    6.  С помощью пользовательского интерфейса диспетчер сервера или командлета PowerShell Install-WindowsFeature установите все необходимые роли сервера, например Hyper-V.  

        ```PowerShell
        Install-WindowsFeature -Name Hyper-V  
        ```  

    7.  С помощью пользовательского интерфейса диспетчер сервера или командлета PowerShell Install-WindowsFeature установите компонент отказоустойчивой кластеризации.  

        ```PowerShell
        Install-WindowsFeature -Name Failover-Clustering  
        ```  

    8.  Установите дополнительные компоненты, необходимые для рабочих нагрузок кластера.  
    9. Проверьте параметры подключения к сети и хранилищу с помощью пользовательского интерфейса диспетчер отказоустойчивости кластеров.  
    10. Если используется брандмауэр Windows, проверьте правильность параметров брандмауэра для кластера. Например, для кластеров с поддержкой кластерного обновления (CAU) может потребоваться настройка брандмауэра.  
    11. Для рабочих нагрузок Hyper-V используйте пользовательский интерфейс диспетчера Hyper-V, чтобы открыть диалоговое окно диспетчера виртуальных коммутаторов (см. рис. 14).  

        Убедитесь, что имена используемых виртуальных коммутаторов идентичны для всех узлов узлов Hyper-V в кластере.  

        ![снимке экрана, показывающее расположение диалогового окна диспетчера виртуальных коммутаторов Hyper-V](media/Cluster-Operating-System-Rolling-Upgrade/Cluster_RollingUpgrade_VMSwitch.png)  
        **Рис. 14. Диспетчер виртуальных коммутаторов**  

    12. На узле Windows Server 2016 (не используйте узел Windows Server 2012 R2) используйте диспетчер отказоустойчивости кластеров (см. рис. 15) для подключения к кластеру.  

        ![снимке экрана, отображающая диалоговое окно выбора кластера](media/Cluster-Operating-System-Rolling-Upgrade/Cluster_RollingUpgrade_AddNode.png)  
        **Рис. 15. Добавление узла в кластер с помощью диспетчер отказоустойчивости кластеров**  

    13. Для добавления узла в кластер можно использовать пользовательский интерфейс диспетчер отказоустойчивости кластеров или командлет [`Add-ClusterNode`](https://docs.microsoft.com/powershell/module/failoverclusters/Add-ClusterNode?view=win10-ps) (см. рис. 16).  

        ![снимке экрана, отображающая выходные данные командлета Add-ClusterNode](media/Cluster-Operating-System-Rolling-Upgrade/Cluster_RollingUpgrade_AddNode3.png)  
        **Рис. 16. Добавление узла в кластер с помощью командлета [`Add-ClusterNode`](https://docs.microsoft.com/powershell/module/failoverclusters/Add-ClusterNode?view=win10-ps)**  

        > [!NOTE]  
        > Когда первый узел Windows Server 2016 присоединяется к кластеру, кластер переходит в режим "смешанной ОС", а ресурсы ядра кластера перемещаются на узел Windows Server 2016. Кластер в режиме "смешанная ОС" — это полностью функциональный кластер, в котором новые узлы работают в режиме совместимости со старыми узлами. Режим "смешанная ОС" является транзитным режимом для кластера. Он не должен быть постоянным, и клиенты должны обновлять все узлы своего кластера в течение четырех недель.  

    14. После успешного добавления узла Windows Server 2016 в кластер можно (необязательно) переместить часть рабочей нагрузки кластера на вновь добавленный узел, чтобы перераспределить рабочую нагрузку в кластере следующим образом:

        ![снимке экрана, отображающая выходные данные командлета Move-Клустервиртуалмачинероле](media/Cluster-Operating-System-Rolling-Upgrade/Cluster_RollingUpgrade_MoveVMRole.png)  
        **Рис. 17. перемещение рабочей нагрузки кластера (роль виртуальной машины кластера) с помощью командлета [`Move-ClusterVirtualMachineRole`](https://docs.microsoft.com/powershell/module/failoverclusters/Move-ClusterVirtualMachineRole?view=win10-ps)**  

        1. Используйте **Динамическая миграция** из Диспетчер отказоустойчивости кластеров для виртуальных машин или командлета [`Move-ClusterVirtualMachineRole`](https://docs.microsoft.com/powershell/module/failoverclusters/Move-ClusterVirtualMachineRole?view=win10-ps) (см. рис. 17), чтобы выполнить динамическую миграцию виртуальных машин.  

            ```PowerShell
            Move-ClusterVirtualMachineRole -Name VM1 -Node robhind-host3  
            ```  

        2. Используйте **Move** из Диспетчер отказоустойчивости кластеров или командлета [`Move-ClusterGroup`](https://docs.microsoft.com/powershell/module/failoverclusters/Move-ClusterGroup?view=win10-ps) для других рабочих нагрузок кластера.  

3. После обновления каждого узла до Windows Server 2016 и добавления обратно в кластер или при удалении оставшихся узлов Windows Server 2012 R2 выполните следующие действия.  

    > [!IMPORTANT]  
    > -   После обновления функционального уровня кластера вы не сможете вернуться на функциональный уровень Windows Server 2012 R2 и узлы Windows Server 2012 R2 нельзя добавить в кластер.
    > -   До запуска командлета [`Update-ClusterFunctionalLevel`](https://docs.microsoft.com/powershell/module/failoverclusters/Update-ClusterFunctionalLevel?view=win10-ps) процесс будет полностью отменен, а узлы windows Server 2012 R2 можно будет добавить в этот кластер, и узлы windows Server 2016 можно будет удалить.  
    > -   После запуска командлета [`Update-ClusterFunctionalLevel`](https://docs.microsoft.com/powershell/module/failoverclusters/Update-ClusterFunctionalLevel?view=win10-ps) будут доступны новые функции.  

    1.  С помощью пользовательского интерфейса диспетчер отказоустойчивости кластеров или командлета [`Get-ClusterGroup`](https://docs.microsoft.com/powershell/module/failoverclusters/Get-ClusterGroup?view=win10-ps) убедитесь, что все роли кластера работают в кластере, как и ожидалось. В следующем примере Доступное хранилище не используется, вместо этого используется CSV, поэтому Доступное хранилище отображает **автономное** состояние (см. рис. 18).  

        ![снимке экрана, отображающая выходные данные командлета Get-ClusterGroup](media/Cluster-Operating-System-Rolling-Upgrade/Cluster_RollingUpgrade_GetClusterGroup.png)  
        **Рис. 18. Проверка того, что все кластерные группы (роли кластера) выполняются с помощью командлета [`Get-ClusterGroup`](https://docs.microsoft.com/powershell/module/failoverclusters/Get-ClusterGroup?view=win10-ps)**  

    2.  Убедитесь, что все узлы кластера находятся в сети и работают с помощью командлета [`Get-ClusterNode`](https://docs.microsoft.com/powershell/module/failoverclusters/Get-ClusterNode?view=win10-ps) .  
    3.  Запустите командлет [`Update-ClusterFunctionalLevel`](https://technet.microsoft.com/library/mt589702.aspx) — ошибки не должны возвращаться (см. рис. 19).  

        ![снимке экрана, отображающая выходные данные командлета Update-Клустерфунктионаллевел](media/Cluster-Operating-System-Rolling-Upgrade/Cluster_RollingUpgrade_SelectFunctionalLevel.png)  
        **Рис. 19. обновление функционального уровня кластера с помощью PowerShell**  

    4.  После запуска командлета [`Update-ClusterFunctionalLevel`](https://docs.microsoft.com/powershell/module/failoverclusters/Update-ClusterFunctionalLevel?view=win10-ps) становятся доступны новые функции.  

4. Windows Server 2016 — возобновление обычных обновлений кластера и резервных копий:  

    1. Если вы ранее выполняли CAU, перезапустите ее с помощью пользовательского интерфейса CAU или используйте командлет [`Enable-CauClusterRole`](https://docs.microsoft.com/powershell/module/clusterawareupdating/Enable-CauClusterRole?view=win10-ps) (см. рис. 20).  

        ![снимке экрана, отображающая выходные данные](media/Cluster-Operating-System-Rolling-Upgrade/Cluster_RollingUpgrade_EnableCAUClusterRole.png) Enable-Кауклустерроле  
        **Рис. 20. Включение роли "обновление с учетом кластеров" с помощью командлета [`Enable-CauClusterRole`](https://docs.microsoft.com/powershell/module/clusterawareupdating/Enable-CauClusterRole?view=win10-ps)**  

    2. Возобновление операций резервного копирования.  

5. Включение и использование функций Windows Server 2016 на виртуальных машинах Hyper-V.  

    1. После обновления кластера до режима работы Windows Server 2016 многие рабочие нагрузки, такие как виртуальные машины Hyper-V, будут иметь новые возможности. Список новых возможностей Hyper-V. см. статью [Миграция и обновление виртуальных машин](https://msdn.microsoft.com/virtualization/hyperv_on_windows/user_guide/migrating_vms) .  

    2. На каждом узле узла Hyper-V в кластере используйте командлет [`Get-VMHostSupportedVersion`](https://docs.microsoft.com/powershell/module/hyper-v/Get-VMHostSupportedVersion?view=win10-ps) , чтобы просмотреть версии конфигурации виртуальных машин Hyper-v, поддерживаемые узлом.  

        ![снимке экрана, отображающая выходные данные командлета Get-Вмхостсуппортедверсион](media/Cluster-Operating-System-Rolling-Upgrade/Clustering_GetVMHostSupportVersion.png)  
        **Рис. 21. Просмотр версий конфигурации виртуальных машин Hyper-V, поддерживаемых узлом**  

   3. На каждом узле узла Hyper-V в кластере версии конфигурации виртуальных машин Hyper-V можно обновить, запланируя короткий период обслуживания с помощью пользователей, резервное копирование, отключение виртуальных машин и запуск командлета [`Update-VMVersion`](https://docs.microsoft.com/powershell/module/hyper-v/Update-VMVersion?view=win10-ps) (см. рис. 22). Это приведет к обновлению версии виртуальной машины и включению новых функций Hyper-V, устраняя необходимость в будущих обновлениях компонентов интеграции Hyper-V (IC). Этот командлет можно запустить из узла Hyper-V, на котором размещена виртуальная машина, или использовать параметр `-ComputerName` для удаленного обновления версии виртуальной машины. В этом примере мы обновляем версию конфигурации VM1 с 5,0 до 7,0, чтобы воспользоваться преимуществами многих новых функций Hyper-V, связанных с этой версией конфигурации виртуальной машины, такими как рабочие контрольные точки (резервные копии приложений) и двоичная виртуальная машина. файл конфигурации.  

       в ![снимке экрана показан командлет Update-VMVersion в действии](media/Cluster-Operating-System-Rolling-Upgrade/Cluster_RollingUpgrade_StopVM.png)  
       **Рис. 22. Обновление версии виртуальной машины с помощью командлета PowerShell Update-VMVersion**  

6. Пулы носителей можно обновить с помощью командлета PowerShell [Update-StoragePool](https://docs.microsoft.com/powershell/module/storage/Update-StoragePool?view=win10-ps) . это операция в сети.  

Хотя мы нацелены на сценарии частного облака, в частности кластеры Hyper-V и масштабируемых файловых серверов, которые могут быть обновлены без простоя, процесс последовательного обновления ОС кластера можно использовать для любой роли кластера.  

## <a name="restrictions--limitations"></a>Ограничения  
- Эта функция работает только для версий Windows Server 2012 R2 только для Windows Server 2016. Эта функция не может обновить более ранние версии Windows Server, такие как Windows Server 2008, Windows Server 2008 R2 или Windows Server 2012, до Windows Server 2016.  
- Каждый узел Windows Server 2016 следует переформатировать или только новую установку. Тип установки "на месте" или "обновление" не рекомендуется.  
- Для добавления узлов Windows Server 2016 в кластер необходимо использовать узел Windows Server 2016.  
- При управлении кластером в режиме смешанной ОС всегда выполняйте задачи управления из узла верхнего уровня, работающего под управлением Windows Server 2016. Узлы нижнего уровня Windows Server 2012 R2 не могут использовать пользовательский интерфейс или средства управления для Windows Server 2016.  
- Мы советуем клиентам быстро перемещаться по процессу обновления кластера, так как некоторые функции кластера не оптимизированы для смешанного режима ОС.  
- Избегайте создания или изменения размера хранилища на узлах Windows Server 2016, пока кластер работает в смешанном режиме ОС из-за возможных несовместимости при отработке отказа с узла Windows Server 2016 на узлы Windows Server 2012 R2 нижнего уровня.  

## <a name="frequently-asked-questions"></a>Вопросы и ответы  
**Сколько времени может работать отказоустойчивый кластер в смешанном режиме?**  
    Мы советуем клиентам выполнить обновление в течение четырех недель. В Windows Server 2016 существует множество оптимизаций. Мы успешно обновили кластеры масштабируемых файловых серверов Hyper-V и масштабирования с нулевым временем простоя в течение менее четырех часов.  

**Будет ли этот компонент переноситься обратно в Windows Server 2012, Windows Server 2008 R2 или Windows Server 2008?**  
    У нас нет планов по переносу этой функции обратно в предыдущие версии. Последовательное обновление ОС кластера является нашим представлением для обновления кластеров Windows Server 2012 R2 до Windows Server 2016 и более поздних версий.  

**Должны ли в кластере Windows Server 2012 R2 быть установлены все обновления программного обеспечения до начала процесса последовательного обновления ОС кластера?**  
    Да, перед запуском последовательного обновления ОС кластера убедитесь, что все узлы кластера обновлены с использованием последних обновлений программного обеспечения.  

**Можно ли запустить командлет [`Update-ClusterFunctionalLevel`](https://docs.microsoft.com/powershell/module/failoverclusters/Update-ClusterFunctionalLevel?view=win10-ps) , когда узлы отключены или приостановлены?**  
    Нет. Для работы командлета [`Update-ClusterFunctionalLevel`](https://docs.microsoft.com/powershell/module/failoverclusters/Update-ClusterFunctionalLevel?view=win10-ps) все узлы кластера должны быть включены в активное членство.  

**Работает ли последовательное обновление ОС кластера для любой рабочей нагрузки кластера? Работает ли она для SQL Server?**  
    Да, последовательное обновление ОС кластера работает для любой рабочей нагрузки кластера. Однако время простоя для кластеров Hyper-V и масштабируемых файловых серверов — только ноль. При отработке отказа большинство других рабочих нагрузок вызывают некоторое время простоя (обычно несколько минут), а отработка отказа необходима по крайней мере один раз во время последовательного обновления ОС кластера.  

**Можно ли автоматизировать этот процесс с помощью PowerShell?**  
    Да, мы разработали последовательное обновление ОС кластера для автоматической установки с помощью PowerShell.  

**Можно ли одновременно обновить несколько узлов для большого кластера с дополнительной рабочей нагрузкой и емкостью отработки отказа?**  
    Да. При удалении одного узла из кластера для обновления ОС кластер будет иметь один узел для отработки отказа, поэтому будет снижена емкость отработки отказа. Для больших кластеров с достаточным объемом рабочей нагрузки и отказоустойчивости можно одновременно обновить несколько узлов. Вы можете временно добавить узлы кластера в кластер, чтобы обеспечить повышенную рабочую нагрузку и отказоустойчивость в процессе последовательного обновления ОС кластера.  

**Что делать, если после успешного выполнения [`Update-ClusterFunctionalLevel`](https://docs.microsoft.com/powershell/module/failoverclusters/Update-ClusterFunctionalLevel?view=win10-ps) в кластере обнаружена неполадка?**  
    Если вы выполнили резервное копирование базы данных кластера с резервной копией состояния системы перед запуском [`Update-ClusterFunctionalLevel`](https://docs.microsoft.com/powershell/module/failoverclusters/Update-ClusterFunctionalLevel?view=win10-ps), вы сможете выполнить полномочное восстановление на узле кластера Windows Server 2012 R2 и восстановить исходную базу данных кластера и конфигурацию.  

**Можно ли использовать обновление на месте для каждого узла вместо использования чистой установки ОС путем переформатирования системного диска?**  
    Мы не рекомендуем использовать обновление на месте Windows Server, но мы осведомлены о том, что в некоторых случаях используются драйверы по умолчанию. Внимательно прочитайте все предупреждающие сообщения, отображаемые во время обновления узла кластера на месте.  

**Если я использую репликацию Hyper-v для виртуальной машины Hyper-v в кластере Hyper-V, будет ли репликация оставаться неизменной во время и после последовательного обновления ОС кластера?**  
    Да, реплика Hyper-V остается неизменной во время и после процесса последовательного обновления ОС кластера.  

**Можно ли использовать System Center 2016 Virtual Machine Manager (SCVMM) для автоматизации процесса последовательного обновления ОС кластера?**  
    Да, можно автоматизировать процесс последовательного обновления ОС кластера с помощью VMM в System Center 2016.  

## <a name="see-also"></a>См. также статью  
-   [Заметки о выпуске: важные проблемы в Windows Server 2016](../get-started/Release-Notes--Important-Issues-in-Windows-Server-2016-Technical-Preview.md)  
-   [Что нового в Windows Server 2016?](../get-started/What-s-New-in-windows-server-2016.md)  
-   [Новые возможности отказоустойчивой кластеризации в Windows Server](whats-new-in-failover-clustering.md)  
